!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NGL={})}(this,(function(e){"use strict";const t=0,i=1,n=2,r=1,s=2,o=3,a=0,c=1,l=2,h=0,u=1,d=2,f=3,m=4,p=5,g=100,v=101,y=102,x=103,b=104,_=200,w=201,S=202,A=203,M=204,C=205,P=206,T=207,I=208,E=209,D=210,L=0,R=1,k=2,O=3,B=4,N=5,F=6,z=7,U=0,$=1,G=2,V=0,H=1,j=2,W=3,q=4,X=5,Y=301,Z=302,K=303,Q=304,J=306,ee=307,te=1e3,ie=1001,ne=1002,re=1003,se=1004,oe=1005,ae=1006,ce=1007,le=1008,he=1009,ue=1010,de=1011,fe=1012,me=1013,pe=1014,ge=1015,ve=1016,ye=1017,xe=1018,be=1019,_e=1020,we=1021,Se=1022,Ae=1023,Me=1024,Ce=1025,Pe=1026,Te=1027,Ie=1028,Ee=1029,De=1030,Le=1031,Re=1032,ke=1033,Oe=33776,Be=33777,Ne=33778,Fe=33779,ze=35840,Ue=35841,$e=35842,Ge=35843,Ve=36196,He=37492,je=37496,We=37808,qe=37809,Xe=37810,Ye=37811,Ze=37812,Ke=37813,Qe=37814,Je=37815,et=37816,tt=37817,it=37818,nt=37819,rt=37820,st=37821,ot=36492,at=37840,ct=37841,lt=37842,ht=37843,ut=37844,dt=37845,ft=37846,mt=37847,pt=37848,gt=37849,vt=37850,yt=37851,xt=37852,bt=37853,_t=3e3,wt=3001,St=3007,At=3002,Mt=3003,Ct=3004,Pt=3005,Tt=3006,It=3200,Et=3201,Dt=0,Lt=1,Rt=7680,kt=519,Ot=35044;function Bt(){}Object.assign(Bt.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},removeEventListener:function(e,t){if(void 0===this._listeners)return;const i=this._listeners[e];if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}},dispatchEvent:function(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const i=t.slice(0);for(let t=0,n=i.length;t<n;t++)i[t].call(this,e)}}});const Nt=[];for(let e=0;e<256;e++)Nt[e]=(e<16?"0":"")+e.toString(16);const Ft={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(Nt[255&e]+Nt[e>>8&255]+Nt[e>>16&255]+Nt[e>>24&255]+"-"+Nt[255&t]+Nt[t>>8&255]+"-"+Nt[t>>16&15|64]+Nt[t>>24&255]+"-"+Nt[63&i|128]+Nt[i>>8&255]+"-"+Nt[i>>16&255]+Nt[i>>24&255]+Nt[255&n]+Nt[n>>8&255]+Nt[n>>16&255]+Nt[n>>24&255]).toUpperCase()},clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,i,n,r){return n+(e-t)*(r-n)/(i-t)},lerp:function(e,t,i){return(1-i)*e+i*t},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*Ft.DEG2RAD},radToDeg:function(e){return e*Ft.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,i,n,r){const s=Math.cos,o=Math.sin,a=s(i/2),c=o(i/2),l=s((t+n)/2),h=o((t+n)/2),u=s((t-n)/2),d=o((t-n)/2),f=s((n-t)/2),m=o((n-t)/2);switch(r){case"XYX":e.set(a*h,c*u,c*d,a*l);break;case"YZY":e.set(c*d,a*h,c*u,a*l);break;case"ZXZ":e.set(c*u,c*d,a*h,a*l);break;case"XZX":e.set(a*h,c*m,c*f,a*l);break;case"YXY":e.set(c*f,a*h,c*m,a*l);break;case"ZYZ":e.set(c*m,c*f,a*h,a*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}};function zt(e=0,t=0){this.x=e,this.y=t}function Ut(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}let $t;Object.defineProperties(zt.prototype,{width:{get:function(){return this.x},set:function(e){this.x=e}},height:{get:function(){return this.y},set:function(e){this.y=e}}}),Object.assign(zt.prototype,{isVector2:!0,set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},applyMatrix3:function(e){const t=this.x,i=this.y,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6],this.y=n[1]*t+n[4]*i+n[7],this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:function(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this},clampLength:function(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},cross:function(e){return this.x*e.y-this.y*e.x},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){return Math.atan2(-this.y,-this.x)+Math.PI},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i},manhattanDistanceTo:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this},rotateAround:function(e,t){const i=Math.cos(t),n=Math.sin(t),r=this.x-e.x,s=this.y-e.y;return this.x=r*i-s*n+e.x,this.y=r*n+s*i+e.y,this},random:function(){return this.x=Math.random(),this.y=Math.random(),this}}),Object.assign(Ut.prototype,{isMatrix3:!0,set:function(e,t,i,n,r,s,o,a,c){const l=this.elements;return l[0]=e,l[1]=n,l[2]=o,l[3]=t,l[4]=r,l[5]=a,l[6]=i,l[7]=s,l[8]=c,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this},extractBasis:function(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this},setFromMatrix4:function(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){const i=e.elements,n=t.elements,r=this.elements,s=i[0],o=i[3],a=i[6],c=i[1],l=i[4],h=i[7],u=i[2],d=i[5],f=i[8],m=n[0],p=n[3],g=n[6],v=n[1],y=n[4],x=n[7],b=n[2],_=n[5],w=n[8];return r[0]=s*m+o*v+a*b,r[3]=s*p+o*y+a*_,r[6]=s*g+o*x+a*w,r[1]=c*m+l*v+h*b,r[4]=c*p+l*y+h*_,r[7]=c*g+l*x+h*w,r[2]=u*m+d*v+f*b,r[5]=u*p+d*y+f*_,r[8]=u*g+d*x+f*w,this},multiplyScalar:function(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){const e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],o=e[5],a=e[6],c=e[7],l=e[8];return t*s*l-t*o*c-i*r*l+i*o*a+n*r*c-n*s*a},getInverse:function(e,t){void 0!==t&&console.warn("THREE.Matrix3: .getInverse() can no longer be configured to throw on degenerate.");const i=e.elements,n=this.elements,r=i[0],s=i[1],o=i[2],a=i[3],c=i[4],l=i[5],h=i[6],u=i[7],d=i[8],f=d*c-l*u,m=l*h-d*a,p=u*a-c*h,g=r*f+s*m+o*p;if(0===g)return this.set(0,0,0,0,0,0,0,0,0);const v=1/g;return n[0]=f*v,n[1]=(o*u-d*s)*v,n[2]=(l*s-o*c)*v,n[3]=m*v,n[4]=(d*r-o*h)*v,n[5]=(o*a-l*r)*v,n[6]=p*v,n[7]=(s*h-u*r)*v,n[8]=(c*r-s*a)*v,this},transpose:function(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},setUvTransform:function(e,t,i,n,r,s,o){const a=Math.cos(r),c=Math.sin(r);this.set(i*a,i*c,-i*(a*s+c*o)+s+e,-n*c,n*a,-n*(-c*s+a*o)+o+t,0,0,1)},scale:function(e,t){const i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=t,i[4]*=t,i[7]*=t,this},rotate:function(e){const t=Math.cos(e),i=Math.sin(e),n=this.elements,r=n[0],s=n[3],o=n[6],a=n[1],c=n[4],l=n[7];return n[0]=t*r+i*a,n[3]=t*s+i*c,n[6]=t*o+i*l,n[1]=-i*r+t*a,n[4]=-i*s+t*c,n[7]=-i*o+t*l,this},translate:function(e,t){const i=this.elements;return i[0]+=e*i[2],i[3]+=e*i[5],i[6]+=e*i[8],i[1]+=t*i[2],i[4]+=t*i[5],i[7]+=t*i[8],this},equals:function(e){const t=this.elements,i=e.elements;for(let e=0;e<9;e++)if(t[e]!==i[e])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}});const Gt=function(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===$t&&($t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),$t.width=e.width,$t.height=e.height;const i=$t.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),t=$t}return t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")};let Vt=0;function Ht(e,t,i,n,r,s,o,a,c,l){Object.defineProperty(this,"id",{value:Vt++}),this.uuid=Ft.generateUUID(),this.name="",this.image=void 0!==e?e:Ht.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:Ht.DEFAULT_MAPPING,this.wrapS=void 0!==i?i:ie,this.wrapT=void 0!==n?n:ie,this.magFilter=void 0!==r?r:ae,this.minFilter=void 0!==s?s:le,this.anisotropy=void 0!==c?c:1,this.format=void 0!==o?o:Ae,this.internalFormat=null,this.type=void 0!==a?a:he,this.offset=new zt(0,0),this.repeat=new zt(1,1),this.center=new zt(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Ut,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==l?l:_t,this.version=0,this.onUpdate=null}function jt(e=0,t=0,i=0,n=1){this.x=e,this.y=t,this.z=i,this.w=n}function Wt(e,t,i){this.width=e,this.height=t,this.scissor=new jt(0,0,e,t),this.scissorTest=!1,this.viewport=new jt(0,0,e,t),i=i||{},this.texture=new Ht(void 0,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.image={},this.texture.image.width=e,this.texture.image.height=t,this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:ae,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0===i.stencilBuffer||i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}function qt(e=0,t=0,i=0,n=1){this._x=e,this._y=t,this._z=i,this._w=n}Ht.DEFAULT_IMAGE=void 0,Ht.DEFAULT_MAPPING=300,Ht.prototype=Object.assign(Object.create(Bt.prototype),{constructor:Ht,isTexture:!0,updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this},toJSON:function(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){const n=this.image;if(void 0===n.uuid&&(n.uuid=Ft.generateUUID()),!t&&void 0===e.images[n.uuid]){let t;if(Array.isArray(n)){t=[];for(let e=0,i=n.length;e<i;e++)t.push(Gt(n[e]))}else t=Gt(n);e.images[n.uuid]={uuid:n.uuid,url:t}}i.image=n.uuid}return t||(e.textures[this.uuid]=i),i},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case te:e.x=e.x-Math.floor(e.x);break;case ie:e.x=e.x<0?0:1;break;case ne:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case te:e.y=e.y-Math.floor(e.y);break;case ie:e.y=e.y<0?0:1;break;case ne:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}}),Object.defineProperty(Ht.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.defineProperties(jt.prototype,{width:{get:function(){return this.z},set:function(e){this.z=e}},height:{get:function(){return this.w},set:function(e){this.w=e}}}),Object.assign(jt.prototype,{isVector4:!0,set:function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){const t=this.x,i=this.y,n=this.z,r=this.w,s=e.elements;return this.x=s[0]*t+s[4]*i+s[8]*n+s[12]*r,this.y=s[1]*t+s[5]*i+s[9]*n+s[13]*r,this.z=s[2]*t+s[6]*i+s[10]*n+s[14]*r,this.w=s[3]*t+s[7]*i+s[11]*n+s[15]*r,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){let t,i,n,r;const s=.01,o=.1,a=e.elements,c=a[0],l=a[4],h=a[8],u=a[1],d=a[5],f=a[9],m=a[2],p=a[6],g=a[10];if(Math.abs(l-u)<s&&Math.abs(h-m)<s&&Math.abs(f-p)<s){if(Math.abs(l+u)<o&&Math.abs(h+m)<o&&Math.abs(f+p)<o&&Math.abs(c+d+g-3)<o)return this.set(1,0,0,0),this;t=Math.PI;const e=(c+1)/2,a=(d+1)/2,v=(g+1)/2,y=(l+u)/4,x=(h+m)/4,b=(f+p)/4;return e>a&&e>v?e<s?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(e),n=y/i,r=x/i):a>v?a<s?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(a),i=y/n,r=b/n):v<s?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(v),i=x/r,n=b/r),this.set(i,n,r,t),this}let v=Math.sqrt((p-f)*(p-f)+(h-m)*(h-m)+(u-l)*(u-l));return Math.abs(v)<.001&&(v=1),this.x=(p-f)/v,this.y=(h-m)/v,this.z=(u-l)/v,this.w=Math.acos((c+d+g-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this},clampLength:function(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this},random:function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}),Wt.prototype=Object.assign(Object.create(Bt.prototype),{constructor:Wt,isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.texture.image.width=e,this.texture.image.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.assign(qt,{slerp:function(e,t,i,n){return i.copy(e).slerp(t,n)},slerpFlat:function(e,t,i,n,r,s,o){let a=i[n+0],c=i[n+1],l=i[n+2],h=i[n+3];const u=r[s+0],d=r[s+1],f=r[s+2],m=r[s+3];if(h!==m||a!==u||c!==d||l!==f){let e=1-o,t=a*u+c*d+l*f+h*m,i=t>=0?1:-1,n=1-t*t;if(n>Number.EPSILON){const r=Math.sqrt(n),s=Math.atan2(r,t*i);e=Math.sin(e*s)/r,o=Math.sin(o*s)/r}const r=o*i;if(a=a*e+u*r,c=c*e+d*r,l=l*e+f*r,h=h*e+m*r,e===1-o){const e=1/Math.sqrt(a*a+c*c+l*l+h*h);a*=e,c*=e,l*=e,h*=e}}e[t]=a,e[t+1]=c,e[t+2]=l,e[t+3]=h},multiplyQuaternionsFlat:function(e,t,i,n,r,s){const o=i[n],a=i[n+1],c=i[n+2],l=i[n+3],h=r[s],u=r[s+1],d=r[s+2],f=r[s+3];return e[t]=o*f+l*h+a*d-c*u,e[t+1]=a*f+l*u+c*h-o*d,e[t+2]=c*f+l*d+o*u-a*h,e[t+3]=l*f-o*h-a*u-c*d,e}}),Object.defineProperties(qt.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this._onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this._onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this._onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this._onChangeCallback()}}}),Object.assign(qt.prototype,{isQuaternion:!0,set:function(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this._onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this},setFromEuler:function(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=e._x,n=e._y,r=e._z,s=e.order,o=Math.cos,a=Math.sin,c=o(i/2),l=o(n/2),h=o(r/2),u=a(i/2),d=a(n/2),f=a(r/2);switch(s){case"XYZ":this._x=u*l*h+c*d*f,this._y=c*d*h-u*l*f,this._z=c*l*f+u*d*h,this._w=c*l*h-u*d*f;break;case"YXZ":this._x=u*l*h+c*d*f,this._y=c*d*h-u*l*f,this._z=c*l*f-u*d*h,this._w=c*l*h+u*d*f;break;case"ZXY":this._x=u*l*h-c*d*f,this._y=c*d*h+u*l*f,this._z=c*l*f+u*d*h,this._w=c*l*h-u*d*f;break;case"ZYX":this._x=u*l*h-c*d*f,this._y=c*d*h+u*l*f,this._z=c*l*f-u*d*h,this._w=c*l*h+u*d*f;break;case"YZX":this._x=u*l*h+c*d*f,this._y=c*d*h+u*l*f,this._z=c*l*f-u*d*h,this._w=c*l*h-u*d*f;break;case"XZY":this._x=u*l*h-c*d*f,this._y=c*d*h-u*l*f,this._z=c*l*f+u*d*h,this._w=c*l*h+u*d*f;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!1!==t&&this._onChangeCallback(),this},setFromAxisAngle:function(e,t){const i=t/2,n=Math.sin(i);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(i),this._onChangeCallback(),this},setFromRotationMatrix:function(e){const t=e.elements,i=t[0],n=t[4],r=t[8],s=t[1],o=t[5],a=t[9],c=t[2],l=t[6],h=t[10],u=i+o+h;if(u>0){const e=.5/Math.sqrt(u+1);this._w=.25/e,this._x=(l-a)*e,this._y=(r-c)*e,this._z=(s-n)*e}else if(i>o&&i>h){const e=2*Math.sqrt(1+i-o-h);this._w=(l-a)/e,this._x=.25*e,this._y=(n+s)/e,this._z=(r+c)/e}else if(o>h){const e=2*Math.sqrt(1+o-i-h);this._w=(r-c)/e,this._x=(n+s)/e,this._y=.25*e,this._z=(a+l)/e}else{const e=2*Math.sqrt(1+h-i-o);this._w=(s-n)/e,this._x=(r+c)/e,this._y=(a+l)/e,this._z=.25*e}return this._onChangeCallback(),this},setFromUnitVectors:function(e,t){let i=e.dot(t)+1;return i<1e-6?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()},angleTo:function(e){return 2*Math.acos(Math.abs(Ft.clamp(this.dot(e),-1,1)))},rotateTowards:function(e,t){const i=this.angleTo(e);if(0===i)return this;const n=Math.min(1,t/i);return this.slerp(e,n),this},inverse:function(){return this.conjugate()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){const i=e._x,n=e._y,r=e._z,s=e._w,o=t._x,a=t._y,c=t._z,l=t._w;return this._x=i*l+s*o+n*c-r*a,this._y=n*l+s*a+r*o-i*c,this._z=r*l+s*c+i*a-n*o,this._w=s*l-i*o-n*a-r*c,this._onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this._x,n=this._y,r=this._z,s=this._w;let o=s*e._w+i*e._x+n*e._y+r*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),o>=1)return this._w=s,this._x=i,this._y=n,this._z=r,this;const a=1-o*o;if(a<=Number.EPSILON){const e=1-t;return this._w=e*s+t*this._w,this._x=e*i+t*this._x,this._y=e*n+t*this._y,this._z=e*r+t*this._z,this.normalize(),this._onChangeCallback(),this}const c=Math.sqrt(a),l=Math.atan2(c,o),h=Math.sin((1-t)*l)/c,u=Math.sin(t*l)/c;return this._w=s*h+this._w*u,this._x=i*h+this._x*u,this._y=n*h+this._y*u,this._z=r*h+this._z*u,this._onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},fromBufferAttribute:function(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this},_onChange:function(e){return this._onChangeCallback=e,this},_onChangeCallback:function(){}});const Xt=new Zt,Yt=new qt;function Zt(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}Object.assign(Zt.prototype,{isVector3:!0,set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:function(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Yt.setFromEuler(e))},applyAxisAngle:function(e,t){return this.applyQuaternion(Yt.setFromAxisAngle(e,t))},applyMatrix3:function(e){const t=this.x,i=this.y,n=this.z,r=e.elements;return this.x=r[0]*t+r[3]*i+r[6]*n,this.y=r[1]*t+r[4]*i+r[7]*n,this.z=r[2]*t+r[5]*i+r[8]*n,this},applyNormalMatrix:function(e){return this.applyMatrix3(e).normalize()},applyMatrix4:function(e){const t=this.x,i=this.y,n=this.z,r=e.elements,s=1/(r[3]*t+r[7]*i+r[11]*n+r[15]);return this.x=(r[0]*t+r[4]*i+r[8]*n+r[12])*s,this.y=(r[1]*t+r[5]*i+r[9]*n+r[13])*s,this.z=(r[2]*t+r[6]*i+r[10]*n+r[14])*s,this},applyQuaternion:function(e){const t=this.x,i=this.y,n=this.z,r=e.x,s=e.y,o=e.z,a=e.w,c=a*t+s*n-o*i,l=a*i+o*t-r*n,h=a*n+r*i-s*t,u=-r*t-s*i-o*n;return this.x=c*a+u*-r+l*-o-h*-s,this.y=l*a+u*-s+h*-r-c*-o,this.z=h*a+u*-o+c*-s-l*-r,this},project:function(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)},unproject:function(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)},transformDirection:function(e){const t=this.x,i=this.y,n=this.z,r=e.elements;return this.x=r[0]*t+r[4]*i+r[8]*n,this.y=r[1]*t+r[5]*i+r[9]*n,this.z=r[2]*t+r[6]*i+r[10]*n,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:function(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this},clampLength:function(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this},cross:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)},crossVectors:function(e,t){const i=e.x,n=e.y,r=e.z,s=t.x,o=t.y,a=t.z;return this.x=n*a-r*o,this.y=r*s-i*a,this.z=i*o-n*s,this},projectOnVector:function(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)},projectOnPlane:function(e){return Xt.copy(this).projectOnVector(e),this.sub(Xt)},reflect:function(e){return this.sub(Xt.copy(e).multiplyScalar(2*this.dot(e)))},angleTo:function(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(Ft.clamp(i,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){const t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n},manhattanDistanceTo:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)},setFromSphericalCoords:function(e,t,i){const n=Math.sin(t)*e;return this.x=n*Math.sin(i),this.y=Math.cos(t)*e,this.z=n*Math.cos(i),this},setFromCylindrical:function(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)},setFromCylindricalCoords:function(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this},setFromMatrixPosition:function(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this},setFromMatrixScale:function(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=n,this},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},setFromMatrix3Column:function(e,t){return this.fromArray(e.elements,3*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this},random:function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}});const Kt=new Zt,Qt=new ri,Jt=new Zt(0,0,0),ei=new Zt(1,1,1),ti=new Zt,ii=new Zt,ni=new Zt;function ri(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}Object.assign(ri.prototype,{isMatrix4:!0,set:function(e,t,i,n,r,s,o,a,c,l,h,u,d,f,m,p){const g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=n,g[1]=r,g[5]=s,g[9]=o,g[13]=a,g[2]=c,g[6]=l,g[10]=h,g[14]=u,g[3]=d,g[7]=f,g[11]=m,g[15]=p,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new ri).fromArray(this.elements)},copy:function(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this},copyPosition:function(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this},extractBasis:function(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this},extractRotation:function(e){const t=this.elements,i=e.elements,n=1/Kt.setFromMatrixColumn(e,0).length(),r=1/Kt.setFromMatrixColumn(e,1).length(),s=1/Kt.setFromMatrixColumn(e,2).length();return t[0]=i[0]*n,t[1]=i[1]*n,t[2]=i[2]*n,t[3]=0,t[4]=i[4]*r,t[5]=i[5]*r,t[6]=i[6]*r,t[7]=0,t[8]=i[8]*s,t[9]=i[9]*s,t[10]=i[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromEuler:function(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const t=this.elements,i=e.x,n=e.y,r=e.z,s=Math.cos(i),o=Math.sin(i),a=Math.cos(n),c=Math.sin(n),l=Math.cos(r),h=Math.sin(r);if("XYZ"===e.order){const e=s*l,i=s*h,n=o*l,r=o*h;t[0]=a*l,t[4]=-a*h,t[8]=c,t[1]=i+n*c,t[5]=e-r*c,t[9]=-o*a,t[2]=r-e*c,t[6]=n+i*c,t[10]=s*a}else if("YXZ"===e.order){const e=a*l,i=a*h,n=c*l,r=c*h;t[0]=e+r*o,t[4]=n*o-i,t[8]=s*c,t[1]=s*h,t[5]=s*l,t[9]=-o,t[2]=i*o-n,t[6]=r+e*o,t[10]=s*a}else if("ZXY"===e.order){const e=a*l,i=a*h,n=c*l,r=c*h;t[0]=e-r*o,t[4]=-s*h,t[8]=n+i*o,t[1]=i+n*o,t[5]=s*l,t[9]=r-e*o,t[2]=-s*c,t[6]=o,t[10]=s*a}else if("ZYX"===e.order){const e=s*l,i=s*h,n=o*l,r=o*h;t[0]=a*l,t[4]=n*c-i,t[8]=e*c+r,t[1]=a*h,t[5]=r*c+e,t[9]=i*c-n,t[2]=-c,t[6]=o*a,t[10]=s*a}else if("YZX"===e.order){const e=s*a,i=s*c,n=o*a,r=o*c;t[0]=a*l,t[4]=r-e*h,t[8]=n*h+i,t[1]=h,t[5]=s*l,t[9]=-o*l,t[2]=-c*l,t[6]=i*h+n,t[10]=e-r*h}else if("XZY"===e.order){const e=s*a,i=s*c,n=o*a,r=o*c;t[0]=a*l,t[4]=-h,t[8]=c*l,t[1]=e*h+r,t[5]=s*l,t[9]=i*h-n,t[2]=n*h-i,t[6]=o*l,t[10]=r*h+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:function(e){return this.compose(Jt,e,ei)},lookAt:function(e,t,i){const n=this.elements;return ni.subVectors(e,t),0===ni.lengthSq()&&(ni.z=1),ni.normalize(),ti.crossVectors(i,ni),0===ti.lengthSq()&&(1===Math.abs(i.z)?ni.x+=1e-4:ni.z+=1e-4,ni.normalize(),ti.crossVectors(i,ni)),ti.normalize(),ii.crossVectors(ni,ti),n[0]=ti.x,n[4]=ii.x,n[8]=ni.x,n[1]=ti.y,n[5]=ii.y,n[9]=ni.y,n[2]=ti.z,n[6]=ii.z,n[10]=ni.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){const i=e.elements,n=t.elements,r=this.elements,s=i[0],o=i[4],a=i[8],c=i[12],l=i[1],h=i[5],u=i[9],d=i[13],f=i[2],m=i[6],p=i[10],g=i[14],v=i[3],y=i[7],x=i[11],b=i[15],_=n[0],w=n[4],S=n[8],A=n[12],M=n[1],C=n[5],P=n[9],T=n[13],I=n[2],E=n[6],D=n[10],L=n[14],R=n[3],k=n[7],O=n[11],B=n[15];return r[0]=s*_+o*M+a*I+c*R,r[4]=s*w+o*C+a*E+c*k,r[8]=s*S+o*P+a*D+c*O,r[12]=s*A+o*T+a*L+c*B,r[1]=l*_+h*M+u*I+d*R,r[5]=l*w+h*C+u*E+d*k,r[9]=l*S+h*P+u*D+d*O,r[13]=l*A+h*T+u*L+d*B,r[2]=f*_+m*M+p*I+g*R,r[6]=f*w+m*C+p*E+g*k,r[10]=f*S+m*P+p*D+g*O,r[14]=f*A+m*T+p*L+g*B,r[3]=v*_+y*M+x*I+b*R,r[7]=v*w+y*C+x*E+b*k,r[11]=v*S+y*P+x*D+b*O,r[15]=v*A+y*T+x*L+b*B,this},multiplyScalar:function(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},determinant:function(){const e=this.elements,t=e[0],i=e[4],n=e[8],r=e[12],s=e[1],o=e[5],a=e[9],c=e[13],l=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+r*a*h-n*c*h-r*o*u+i*c*u+n*o*d-i*a*d)+e[7]*(+t*a*d-t*c*u+r*s*u-n*s*d+n*c*l-r*a*l)+e[11]*(+t*c*h-t*o*d-r*s*h+i*s*d+r*o*l-i*c*l)+e[15]*(-n*o*l-t*a*h+t*o*u+n*s*h-i*s*u+i*a*l)},transpose:function(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},setPosition:function(e,t,i){const n=this.elements;return e.isVector3?(n[12]=e.x,n[13]=e.y,n[14]=e.z):(n[12]=e,n[13]=t,n[14]=i),this},getInverse:function(e,t){void 0!==t&&console.warn("THREE.Matrix4: .getInverse() can no longer be configured to throw on degenerate.");const i=this.elements,n=e.elements,r=n[0],s=n[1],o=n[2],a=n[3],c=n[4],l=n[5],h=n[6],u=n[7],d=n[8],f=n[9],m=n[10],p=n[11],g=n[12],v=n[13],y=n[14],x=n[15],b=f*y*u-v*m*u+v*h*p-l*y*p-f*h*x+l*m*x,_=g*m*u-d*y*u-g*h*p+c*y*p+d*h*x-c*m*x,w=d*v*u-g*f*u+g*l*p-c*v*p-d*l*x+c*f*x,S=g*f*h-d*v*h-g*l*m+c*v*m+d*l*y-c*f*y,A=r*b+s*_+o*w+a*S;if(0===A)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const M=1/A;return i[0]=b*M,i[1]=(v*m*a-f*y*a-v*o*p+s*y*p+f*o*x-s*m*x)*M,i[2]=(l*y*a-v*h*a+v*o*u-s*y*u-l*o*x+s*h*x)*M,i[3]=(f*h*a-l*m*a-f*o*u+s*m*u+l*o*p-s*h*p)*M,i[4]=_*M,i[5]=(d*y*a-g*m*a+g*o*p-r*y*p-d*o*x+r*m*x)*M,i[6]=(g*h*a-c*y*a-g*o*u+r*y*u+c*o*x-r*h*x)*M,i[7]=(c*m*a-d*h*a+d*o*u-r*m*u-c*o*p+r*h*p)*M,i[8]=w*M,i[9]=(g*f*a-d*v*a-g*s*p+r*v*p+d*s*x-r*f*x)*M,i[10]=(c*v*a-g*l*a+g*s*u-r*v*u-c*s*x+r*l*x)*M,i[11]=(d*l*a-c*f*a-d*s*u+r*f*u+c*s*p-r*l*p)*M,i[12]=S*M,i[13]=(d*v*o-g*f*o+g*s*m-r*v*m-d*s*y+r*f*y)*M,i[14]=(g*l*o-c*v*o-g*s*h+r*v*h+c*s*y-r*l*y)*M,i[15]=(c*f*o-d*l*o+d*s*h-r*f*h-c*s*m+r*l*m)*M,this},scale:function(e){const t=this.elements,i=e.x,n=e.y,r=e.z;return t[0]*=i,t[4]*=n,t[8]*=r,t[1]*=i,t[5]*=n,t[9]*=r,t[2]*=i,t[6]*=n,t[10]*=r,t[3]*=i,t[7]*=n,t[11]*=r,this},getMaxScaleOnAxis:function(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,n))},makeTranslation:function(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this},makeRotationX:function(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this},makeRotationY:function(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this},makeRotationZ:function(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){const i=Math.cos(t),n=Math.sin(t),r=1-i,s=e.x,o=e.y,a=e.z,c=r*s,l=r*o;return this.set(c*s+i,c*o-n*a,c*a+n*o,0,c*o+n*a,l*o+i,l*a-n*s,0,c*a-n*o,l*a+n*s,r*a*a+i,0,0,0,0,1),this},makeScale:function(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this},makeShear:function(e,t,i){return this.set(1,t,i,0,e,1,i,0,e,t,1,0,0,0,0,1),this},compose:function(e,t,i){const n=this.elements,r=t._x,s=t._y,o=t._z,a=t._w,c=r+r,l=s+s,h=o+o,u=r*c,d=r*l,f=r*h,m=s*l,p=s*h,g=o*h,v=a*c,y=a*l,x=a*h,b=i.x,_=i.y,w=i.z;return n[0]=(1-(m+g))*b,n[1]=(d+x)*b,n[2]=(f-y)*b,n[3]=0,n[4]=(d-x)*_,n[5]=(1-(u+g))*_,n[6]=(p+v)*_,n[7]=0,n[8]=(f+y)*w,n[9]=(p-v)*w,n[10]=(1-(u+m))*w,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this},decompose:function(e,t,i){const n=this.elements;let r=Kt.set(n[0],n[1],n[2]).length(),s=Kt.set(n[4],n[5],n[6]).length(),o=Kt.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),e.x=n[12],e.y=n[13],e.z=n[14],Qt.copy(this);const a=1/r,c=1/s,l=1/o;return Qt.elements[0]*=a,Qt.elements[1]*=a,Qt.elements[2]*=a,Qt.elements[4]*=c,Qt.elements[5]*=c,Qt.elements[6]*=c,Qt.elements[8]*=l,Qt.elements[9]*=l,Qt.elements[10]*=l,t.setFromRotationMatrix(Qt),i.x=r,i.y=s,i.z=o,this},makePerspective:function(e,t,i,n,r,s){void 0===s&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const o=this.elements,a=2*r/(t-e),c=2*r/(i-n),l=(t+e)/(t-e),h=(i+n)/(i-n),u=-(s+r)/(s-r),d=-2*s*r/(s-r);return o[0]=a,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=c,o[9]=h,o[13]=0,o[2]=0,o[6]=0,o[10]=u,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makeOrthographic:function(e,t,i,n,r,s){const o=this.elements,a=1/(t-e),c=1/(i-n),l=1/(s-r),h=(t+e)*a,u=(i+n)*c,d=(s+r)*l;return o[0]=2*a,o[4]=0,o[8]=0,o[12]=-h,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-u,o[2]=0,o[6]=0,o[10]=-2*l,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},equals:function(e){const t=this.elements,i=e.elements;for(let e=0;e<16;e++)if(t[e]!==i[e])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}});const si=new ri,oi=new qt;function ai(e=0,t=0,i=0,n=ai.DefaultOrder){this._x=e,this._y=t,this._z=i,this._order=n}function ci(){this.mask=1}ai.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],ai.DefaultOrder="XYZ",Object.defineProperties(ai.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this._onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this._onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this._onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this._onChangeCallback()}}}),Object.assign(ai.prototype,{isEuler:!0,set:function(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._order=n||this._order,this._onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this},setFromRotationMatrix:function(e,t,i){const n=Ft.clamp,r=e.elements,s=r[0],o=r[4],a=r[8],c=r[1],l=r[5],h=r[9],u=r[2],d=r[6],f=r[10];switch(t=t||this._order){case"XYZ":this._y=Math.asin(n(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-h,f),this._z=Math.atan2(-o,s)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-n(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(a,f),this._z=Math.atan2(c,l)):(this._y=Math.atan2(-u,s),this._z=0);break;case"ZXY":this._x=Math.asin(n(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,f),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(c,s));break;case"ZYX":this._y=Math.asin(-n(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,f),this._z=Math.atan2(c,s)):(this._x=0,this._z=Math.atan2(-o,l));break;case"YZX":this._z=Math.asin(n(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-u,s)):(this._x=0,this._y=Math.atan2(a,f));break;case"XZY":this._z=Math.asin(-n(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(a,s)):(this._x=Math.atan2(-h,f),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!1!==i&&this._onChangeCallback(),this},setFromQuaternion:function(e,t,i){return si.makeRotationFromQuaternion(e),this.setFromRotationMatrix(si,t,i)},setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:function(e){return oi.setFromEuler(this),this.setFromQuaternion(oi,e)},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new Zt(this._x,this._y,this._z)},_onChange:function(e){return this._onChangeCallback=e,this},_onChangeCallback:function(){}}),Object.assign(ci.prototype,{set:function(e){this.mask=1<<e|0},enable:function(e){this.mask|=1<<e|0},enableAll:function(){this.mask=-1},toggle:function(e){this.mask^=1<<e|0},disable:function(e){this.mask&=~(1<<e|0)},disableAll:function(){this.mask=0},test:function(e){return 0!=(this.mask&e.mask)}});let li=0;const hi=new Zt,ui=new qt,di=new ri,fi=new Zt,mi=new Zt,pi=new Zt,gi=new qt,vi=new Zt(1,0,0),yi=new Zt(0,1,0),xi=new Zt(0,0,1),bi={type:"added"},_i={type:"removed"};function wi(){Object.defineProperty(this,"id",{value:li++}),this.uuid=Ft.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=wi.DefaultUp.clone();const e=new Zt,t=new ai,i=new qt,n=new Zt(1,1,1);t._onChange((function(){i.setFromEuler(t,!1)})),i._onChange((function(){t.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new ri},normalMatrix:{value:new Ut}}),this.matrix=new ri,this.matrixWorld=new ri,this.matrixAutoUpdate=wi.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new ci,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}function Si(){wi.call(this),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}wi.DefaultUp=new Zt(0,1,0),wi.DefaultMatrixAutoUpdate=!0,wi.prototype=Object.assign(Object.create(Bt.prototype),{constructor:wi,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(e){return this.quaternion.premultiply(e),this},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(e,t){return ui.setFromAxisAngle(e,t),this.quaternion.multiply(ui),this},rotateOnWorldAxis:function(e,t){return ui.setFromAxisAngle(e,t),this.quaternion.premultiply(ui),this},rotateX:function(e){return this.rotateOnAxis(vi,e)},rotateY:function(e){return this.rotateOnAxis(yi,e)},rotateZ:function(e){return this.rotateOnAxis(xi,e)},translateOnAxis:function(e,t){return hi.copy(e).applyQuaternion(this.quaternion),this.position.add(hi.multiplyScalar(t)),this},translateX:function(e){return this.translateOnAxis(vi,e)},translateY:function(e){return this.translateOnAxis(yi,e)},translateZ:function(e){return this.translateOnAxis(xi,e)},localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(e){return e.applyMatrix4(di.getInverse(this.matrixWorld))},lookAt:function(e,t,i){e.isVector3?fi.copy(e):fi.set(e,t,i);const n=this.parent;this.updateWorldMatrix(!0,!1),mi.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?di.lookAt(mi,fi,this.up):di.lookAt(fi,mi,this.up),this.quaternion.setFromRotationMatrix(di),n&&(di.extractRotation(n.matrixWorld),ui.setFromRotationMatrix(di),this.quaternion.premultiply(ui.inverse()))},add:function(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(bi)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(_i)),this},attach:function(e){return this.updateWorldMatrix(!0,!1),di.getInverse(this.matrixWorld),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),di.multiply(e.parent.matrixWorld)),e.applyMatrix4(di),e.updateWorldMatrix(!1,!1),this.add(e),this},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(e,t);if(void 0!==n)return n}},getWorldPosition:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),e=new Zt),this.updateMatrixWorld(!0),e.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),e=new qt),this.updateMatrixWorld(!0),this.matrixWorld.decompose(mi,e,pi),e},getWorldScale:function(e){return void 0===e&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),e=new Zt),this.updateMatrixWorld(!0),this.matrixWorld.decompose(mi,gi,e),e},getWorldDirection:function(e){void 0===e&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),e=new Zt),this.updateMatrixWorld(!0);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()},raycast:function(){},traverse:function(e){e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverse(e)},traverseVisible:function(e){if(!1===this.visible)return;e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverseVisible(e)},traverseAncestors:function(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].updateMatrixWorld(e)},updateWorldMatrix:function(e,t){const i=this.parent;if(!0===e&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateWorldMatrix(!1,!0)}},toJSON:function(e){const t=void 0===e||"string"==typeof e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const n={};function r(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){n.geometry=r(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const i=t.shapes;if(Array.isArray(i))for(let t=0,n=i.length;t<n;t++){const n=i[t];r(e.shapes,n)}else r(e.shapes,i)}}if(void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let i=0,n=this.material.length;i<n;i++)t.push(r(e.materials,this.material[i]));n.material=t}else n.material=r(e.materials,this.material);if(this.children.length>0){n.children=[];for(let t=0;t<this.children.length;t++)n.children.push(this.children[t].toJSON(e).object)}if(t){const t=s(e.geometries),n=s(e.materials),r=s(e.textures),o=s(e.images),a=s(e.shapes);t.length>0&&(i.geometries=t),n.length>0&&(i.materials=n),r.length>0&&(i.textures=r),o.length>0&&(i.images=o),a.length>0&&(i.shapes=a)}return i.object=n,i;function s(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const i=e.children[t];this.add(i.clone())}return this}}),Si.prototype=Object.assign(Object.create(wi.prototype),{constructor:Si,isScene:!0,copy:function(e,t){return wi.prototype.copy.call(this,e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},toJSON:function(e){const t=wi.prototype.toJSON.call(this,e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.environment&&(t.object.environment=this.environment.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t},dispose:function(){this.dispatchEvent({type:"dispose"})}});const Ai=[new Zt,new Zt,new Zt,new Zt,new Zt,new Zt,new Zt,new Zt],Mi=new Zt,Ci=new Ni,Pi=new Zt,Ti=new Zt,Ii=new Zt,Ei=new Zt,Di=new Zt,Li=new Zt,Ri=new Zt,ki=new Zt,Oi=new Zt,Bi=new Zt;function Ni(e,t){this.min=void 0!==e?e:new Zt(1/0,1/0,1/0),this.max=void 0!==t?t:new Zt(-1/0,-1/0,-1/0)}function Fi(e,t,i,n,r){for(let s=0,o=e.length-3;s<=o;s+=3){Bi.fromArray(e,s);const o=r.x*Math.abs(Bi.x)+r.y*Math.abs(Bi.y)+r.z*Math.abs(Bi.z),a=t.dot(Bi),c=i.dot(Bi),l=n.dot(Bi);if(Math.max(-Math.max(a,c,l),Math.min(a,c,l))>o)return!1}return!0}Object.assign(Ni.prototype,{isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){let t=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,o=-1/0;for(let a=0,c=e.length;a<c;a+=3){const c=e[a],l=e[a+1],h=e[a+2];c<t&&(t=c),l<i&&(i=l),h<n&&(n=h),c>r&&(r=c),l>s&&(s=l),h>o&&(o=h)}return this.min.set(t,i,n),this.max.set(r,s,o),this},setFromBufferAttribute:function(e){let t=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,o=-1/0;for(let a=0,c=e.count;a<c;a++){const c=e.getX(a),l=e.getY(a),h=e.getZ(a);c<t&&(t=c),l<i&&(i=l),h<n&&(n=h),c>r&&(r=c),l>s&&(s=l),h>o&&(o=h)}return this.min.set(t,i,n),this.max.set(r,s,o),this},setFromPoints:function(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(e,t){const i=Mi.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this},setFromObject:function(e){return this.makeEmpty(),this.expandByObject(e)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){return void 0===e&&(console.warn("THREE.Box3: .getCenter() target is now required"),e=new Zt),this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){return void 0===e&&(console.warn("THREE.Box3: .getSize() target is now required"),e=new Zt),this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByObject:function(e){e.updateWorldMatrix(!1,!1);const t=e.geometry;void 0!==t&&(null===t.boundingBox&&t.computeBoundingBox(),Ci.copy(t.boundingBox),Ci.applyMatrix4(e.matrixWorld),this.union(Ci));const i=e.children;for(let e=0,t=i.length;e<t;e++)this.expandByObject(i[e]);return this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return void 0===t&&(console.warn("THREE.Box3: .getParameter() target is now required"),t=new Zt),t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:function(e){return this.clampPoint(e.center,Mi),Mi.distanceToSquared(e.center)<=e.radius*e.radius},intersectsPlane:function(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant},intersectsTriangle:function(e){if(this.isEmpty())return!1;this.getCenter(Ri),ki.subVectors(this.max,Ri),Pi.subVectors(e.a,Ri),Ti.subVectors(e.b,Ri),Ii.subVectors(e.c,Ri),Ei.subVectors(Ti,Pi),Di.subVectors(Ii,Ti),Li.subVectors(Pi,Ii);let t=[0,-Ei.z,Ei.y,0,-Di.z,Di.y,0,-Li.z,Li.y,Ei.z,0,-Ei.x,Di.z,0,-Di.x,Li.z,0,-Li.x,-Ei.y,Ei.x,0,-Di.y,Di.x,0,-Li.y,Li.x,0];return!!Fi(t,Pi,Ti,Ii,ki)&&(t=[1,0,0,0,1,0,0,0,1],!!Fi(t,Pi,Ti,Ii,ki)&&(Oi.crossVectors(Ei,Di),t=[Oi.x,Oi.y,Oi.z],Fi(t,Pi,Ti,Ii,ki)))},clampPoint:function(e,t){return void 0===t&&(console.warn("THREE.Box3: .clampPoint() target is now required"),t=new Zt),t.copy(e).clamp(this.min,this.max)},distanceToPoint:function(e){return Mi.copy(e).clamp(this.min,this.max).sub(e).length()},getBoundingSphere:function(e){return void 0===e&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(e.center),e.radius=.5*this.getSize(Mi).length(),e},intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(e){return this.isEmpty()||(Ai[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Ai[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Ai[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Ai[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Ai[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Ai[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Ai[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Ai[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Ai)),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}});const zi=new Ni;function Ui(e,t){this.center=void 0!==e?e:new Zt,this.radius=void 0!==t?t:-1}Object.assign(Ui.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:function(e,t){const i=this.center;void 0!==t?i.copy(t):zi.setFromPoints(e).getCenter(i);let n=0;for(let t=0,r=e.length;t<r;t++)n=Math.max(n,i.distanceToSquared(e[t]));return this.radius=Math.sqrt(n),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},isEmpty:function(){return this.radius<0},makeEmpty:function(){return this.center.set(0,0,0),this.radius=-1,this},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius},clampPoint:function(e,t){const i=this.center.distanceToSquared(e);return void 0===t&&(console.warn("THREE.Sphere: .clampPoint() target is now required"),t=new Zt),t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t},getBoundingBox:function(e){return void 0===e&&(console.warn("THREE.Sphere: .getBoundingBox() target is now required"),e=new Ni),this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}});const $i=new Zt,Gi=new Zt,Vi=new Zt,Hi=new Zt,ji=new Zt,Wi=new Zt,qi=new Zt;function Xi(e,t){this.origin=void 0!==e?e:new Zt,this.direction=void 0!==t?t:new Zt(0,0,-1)}Object.assign(Xi.prototype,{set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){return void 0===t&&(console.warn("THREE.Ray: .at() target is now required"),t=new Zt),t.copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:function(e){return this.origin.copy(this.at(e,$i)),this},closestPointToPoint:function(e,t){void 0===t&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),t=new Zt),t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.direction).multiplyScalar(i).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(e){const t=$i.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):($i.copy(this.direction).multiplyScalar(t).add(this.origin),$i.distanceToSquared(e))},distanceSqToSegment:function(e,t,i,n){Gi.copy(e).add(t).multiplyScalar(.5),Vi.copy(t).sub(e).normalize(),Hi.copy(this.origin).sub(Gi);const r=.5*e.distanceTo(t),s=-this.direction.dot(Vi),o=Hi.dot(this.direction),a=-Hi.dot(Vi),c=Hi.lengthSq(),l=Math.abs(1-s*s);let h,u,d,f;if(l>0)if(h=s*a-o,u=s*o-a,f=r*l,h>=0)if(u>=-f)if(u<=f){const e=1/l;h*=e,u*=e,d=h*(h+s*u+2*o)+u*(s*h+u+2*a)+c}else u=r,h=Math.max(0,-(s*u+o)),d=-h*h+u*(u+2*a)+c;else u=-r,h=Math.max(0,-(s*u+o)),d=-h*h+u*(u+2*a)+c;else u<=-f?(h=Math.max(0,-(-s*r+o)),u=h>0?-r:Math.min(Math.max(-r,-a),r),d=-h*h+u*(u+2*a)+c):u<=f?(h=0,u=Math.min(Math.max(-r,-a),r),d=u*(u+2*a)+c):(h=Math.max(0,-(s*r+o)),u=h>0?r:Math.min(Math.max(-r,-a),r),d=-h*h+u*(u+2*a)+c);else u=s>0?-r:r,h=Math.max(0,-(s*u+o)),d=-h*h+u*(u+2*a)+c;return i&&i.copy(this.direction).multiplyScalar(h).add(this.origin),n&&n.copy(Vi).multiplyScalar(u).add(Gi),d},intersectSphere:function(e,t){$i.subVectors(e.center,this.origin);const i=$i.dot(this.direction),n=$i.dot($i)-i*i,r=e.radius*e.radius;if(n>r)return null;const s=Math.sqrt(r-n),o=i-s,a=i+s;return o<0&&a<0?null:o<0?this.at(a,t):this.at(o,t)},intersectsSphere:function(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius},distanceToPlane:function(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null},intersectPlane:function(e,t){const i=this.distanceToPlane(e);return null===i?null:this.at(i,t)},intersectsPlane:function(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0},intersectBox:function(e,t){let i,n,r,s,o,a;const c=1/this.direction.x,l=1/this.direction.y,h=1/this.direction.z,u=this.origin;return c>=0?(i=(e.min.x-u.x)*c,n=(e.max.x-u.x)*c):(i=(e.max.x-u.x)*c,n=(e.min.x-u.x)*c),l>=0?(r=(e.min.y-u.y)*l,s=(e.max.y-u.y)*l):(r=(e.max.y-u.y)*l,s=(e.min.y-u.y)*l),i>s||r>n?null:((r>i||i!=i)&&(i=r),(s<n||n!=n)&&(n=s),h>=0?(o=(e.min.z-u.z)*h,a=(e.max.z-u.z)*h):(o=(e.max.z-u.z)*h,a=(e.min.z-u.z)*h),i>a||o>n?null:((o>i||i!=i)&&(i=o),(a<n||n!=n)&&(n=a),n<0?null:this.at(i>=0?i:n,t)))},intersectsBox:function(e){return null!==this.intersectBox(e,$i)},intersectTriangle:function(e,t,i,n,r){ji.subVectors(t,e),Wi.subVectors(i,e),qi.crossVectors(ji,Wi);let s,o=this.direction.dot(qi);if(o>0){if(n)return null;s=1}else{if(!(o<0))return null;s=-1,o=-o}Hi.subVectors(this.origin,e);const a=s*this.direction.dot(Wi.crossVectors(Hi,Wi));if(a<0)return null;const c=s*this.direction.dot(ji.cross(Hi));if(c<0)return null;if(a+c>o)return null;const l=-s*Hi.dot(qi);return l<0?null:this.at(l/o,r)},applyMatrix4:function(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}});const Yi=new Zt,Zi=new Zt,Ki=new Ut;function Qi(e,t){this.normal=void 0!==e?e:new Zt(1,0,0),this.constant=void 0!==t?t:0}Object.assign(Qi.prototype,{isPlane:!0,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,i,n){return this.normal.set(e,t,i),this.constant=n,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(e,t,i){const n=Yi.subVectors(i,t).cross(Zi.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return void 0===t&&(console.warn("THREE.Plane: .projectPoint() target is now required"),t=new Zt),t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)},intersectLine:function(e,t){void 0===t&&(console.warn("THREE.Plane: .intersectLine() target is now required"),t=new Zt);const i=e.delta(Yi),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(e.start)?t.copy(e.start):void 0;const r=-(e.start.dot(this.normal)+this.constant)/n;return r<0||r>1?void 0:t.copy(i).multiplyScalar(r).add(e.start)},intersectsLine:function(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){return void 0===e&&(console.warn("THREE.Plane: .coplanarPoint() target is now required"),e=new Zt),e.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(e,t){const i=t||Ki.getNormalMatrix(e),n=this.coplanarPoint(Yi).applyMatrix4(e),r=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(r),this},translate:function(e){return this.constant-=e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}});const Ji=new Zt,en=new Zt,tn=new Zt,nn=new Zt,rn=new Zt,sn=new Zt,on=new Zt,an=new Zt,cn=new Zt,ln=new Zt;function hn(e,t,i){this.a=void 0!==e?e:new Zt,this.b=void 0!==t?t:new Zt,this.c=void 0!==i?i:new Zt}Object.assign(hn,{getNormal:function(e,t,i,n){void 0===n&&(console.warn("THREE.Triangle: .getNormal() target is now required"),n=new Zt),n.subVectors(i,t),Ji.subVectors(e,t),n.cross(Ji);const r=n.lengthSq();return r>0?n.multiplyScalar(1/Math.sqrt(r)):n.set(0,0,0)},getBarycoord:function(e,t,i,n,r){Ji.subVectors(n,t),en.subVectors(i,t),tn.subVectors(e,t);const s=Ji.dot(Ji),o=Ji.dot(en),a=Ji.dot(tn),c=en.dot(en),l=en.dot(tn),h=s*c-o*o;if(void 0===r&&(console.warn("THREE.Triangle: .getBarycoord() target is now required"),r=new Zt),0===h)return r.set(-2,-1,-1);const u=1/h,d=(c*a-o*l)*u,f=(s*l-o*a)*u;return r.set(1-d-f,f,d)},containsPoint:function(e,t,i,n){return hn.getBarycoord(e,t,i,n,nn),nn.x>=0&&nn.y>=0&&nn.x+nn.y<=1},getUV:function(e,t,i,n,r,s,o,a){return this.getBarycoord(e,t,i,n,nn),a.set(0,0),a.addScaledVector(r,nn.x),a.addScaledVector(s,nn.y),a.addScaledVector(o,nn.z),a},isFrontFacing:function(e,t,i,n){return Ji.subVectors(i,t),en.subVectors(e,t),Ji.cross(en).dot(n)<0}}),Object.assign(hn.prototype,{set:function(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this},setFromPointsAndIndices:function(e,t,i,n){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[n]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},getArea:function(){return Ji.subVectors(this.c,this.b),en.subVectors(this.a,this.b),.5*Ji.cross(en).length()},getMidpoint:function(e){return void 0===e&&(console.warn("THREE.Triangle: .getMidpoint() target is now required"),e=new Zt),e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},getNormal:function(e){return hn.getNormal(this.a,this.b,this.c,e)},getPlane:function(e){return void 0===e&&(console.warn("THREE.Triangle: .getPlane() target is now required"),e=new Qi),e.setFromCoplanarPoints(this.a,this.b,this.c)},getBarycoord:function(e,t){return hn.getBarycoord(e,this.a,this.b,this.c,t)},getUV:function(e,t,i,n,r){return hn.getUV(e,this.a,this.b,this.c,t,i,n,r)},containsPoint:function(e){return hn.containsPoint(e,this.a,this.b,this.c)},isFrontFacing:function(e){return hn.isFrontFacing(this.a,this.b,this.c,e)},intersectsBox:function(e){return e.intersectsTriangle(this)},closestPointToPoint:function(e,t){void 0===t&&(console.warn("THREE.Triangle: .closestPointToPoint() target is now required"),t=new Zt);const i=this.a,n=this.b,r=this.c;let s,o;rn.subVectors(n,i),sn.subVectors(r,i),an.subVectors(e,i);const a=rn.dot(an),c=sn.dot(an);if(a<=0&&c<=0)return t.copy(i);cn.subVectors(e,n);const l=rn.dot(cn),h=sn.dot(cn);if(l>=0&&h<=l)return t.copy(n);const u=a*h-l*c;if(u<=0&&a>=0&&l<=0)return s=a/(a-l),t.copy(i).addScaledVector(rn,s);ln.subVectors(e,r);const d=rn.dot(ln),f=sn.dot(ln);if(f>=0&&d<=f)return t.copy(r);const m=d*c-a*f;if(m<=0&&c>=0&&f<=0)return o=c/(c-f),t.copy(i).addScaledVector(sn,o);const p=l*f-d*h;if(p<=0&&h-l>=0&&d-f>=0)return on.subVectors(r,n),o=(h-l)/(h-l+(d-f)),t.copy(n).addScaledVector(on,o);const g=1/(p+m+u);return s=m*g,o=u*g,t.copy(i).addScaledVector(rn,s).addScaledVector(sn,o)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}});const un={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},dn={h:0,s:0,l:0},fn={h:0,s:0,l:0};function mn(e,t,i){return void 0===t&&void 0===i?this.set(e):this.setRGB(e,t,i)}function pn(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}function gn(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function vn(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}function yn(e,t,i,n,r,s){this.a=e,this.b=t,this.c=i,this.normal=n&&n.isVector3?n:new Zt,this.vertexNormals=Array.isArray(n)?n:[],this.color=r&&r.isColor?r:new mn,this.vertexColors=Array.isArray(r)?r:[],this.materialIndex=void 0!==s?s:0}Object.assign(mn.prototype,{isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,i){return this.r=e,this.g=t,this.b=i,this},setHSL:function(e,t,i){if(e=Ft.euclideanModulo(e,1),t=Ft.clamp(t,0,1),i=Ft.clamp(i,0,1),0===t)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+t):i+t-i*t,r=2*i-n;this.r=pn(r,n,e+1/3),this.g=pn(r,n,e),this.b=pn(r,n,e-1/3)}return this},setStyle:function(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(e)){let e;const n=i[1],r=i[2];switch(n){case"rgb":case"rgba":if(e=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(r))return this.r=Math.min(255,parseInt(e[1],10))/255,this.g=Math.min(255,parseInt(e[2],10))/255,this.b=Math.min(255,parseInt(e[3],10))/255,t(e[5]),this;if(e=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(r))return this.r=Math.min(100,parseInt(e[1],10))/100,this.g=Math.min(100,parseInt(e[2],10))/100,this.b=Math.min(100,parseInt(e[3],10))/100,t(e[5]),this;break;case"hsl":case"hsla":if(e=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(r)){const i=parseFloat(e[1])/360,n=parseInt(e[2],10)/100,r=parseInt(e[3],10)/100;return t(e[5]),this.setHSL(i,n,r)}}}else if(i=/^\#([A-Fa-f0-9]+)$/.exec(e)){const e=i[1],t=e.length;if(3===t)return this.r=parseInt(e.charAt(0)+e.charAt(0),16)/255,this.g=parseInt(e.charAt(1)+e.charAt(1),16)/255,this.b=parseInt(e.charAt(2)+e.charAt(2),16)/255,this;if(6===t)return this.r=parseInt(e.charAt(0)+e.charAt(1),16)/255,this.g=parseInt(e.charAt(2)+e.charAt(3),16)/255,this.b=parseInt(e.charAt(4)+e.charAt(5),16)/255,this}return e&&e.length>0?this.setColorName(e):this},setColorName:function(e){const t=un[e];return void 0!==t?this.setHex(t):console.warn("THREE.Color: Unknown color "+e),this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);const i=t>0?1/t:1;return this.r=Math.pow(e.r,i),this.g=Math.pow(e.g,i),this.b=Math.pow(e.b,i),this},convertGammaToLinear:function(e){return this.copyGammaToLinear(this,e),this},convertLinearToGamma:function(e){return this.copyLinearToGamma(this,e),this},copySRGBToLinear:function(e){return this.r=gn(e.r),this.g=gn(e.g),this.b=gn(e.b),this},copyLinearToSRGB:function(e){return this.r=vn(e.r),this.g=vn(e.g),this.b=vn(e.b),this},convertSRGBToLinear:function(){return this.copySRGBToLinear(this),this},convertLinearToSRGB:function(){return this.copyLinearToSRGB(this),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){void 0===e&&(console.warn("THREE.Color: .getHSL() target is now required"),e={h:0,s:0,l:0});const t=this.r,i=this.g,n=this.b,r=Math.max(t,i,n),s=Math.min(t,i,n);let o,a;const c=(s+r)/2;if(s===r)o=0,a=0;else{const e=r-s;switch(a=c<=.5?e/(r+s):e/(2-r-s),r){case t:o=(i-n)/e+(i<n?6:0);break;case i:o=(n-t)/e+2;break;case n:o=(t-i)/e+4}o/=6}return e.h=o,e.s=a,e.l=c,e},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,i){return this.getHSL(dn),dn.h+=e,dn.s+=t,dn.l+=i,this.setHSL(dn.h,dn.s,dn.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},lerpHSL:function(e,t){this.getHSL(dn),e.getHSL(fn);const i=Ft.lerp(dn.h,fn.h,t),n=Ft.lerp(dn.s,fn.s,t),r=Ft.lerp(dn.l,fn.l,t);return this.setHSL(i,n,r),this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},fromBufferAttribute:function(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),!0===e.normalized&&(this.r/=255,this.g/=255,this.b/=255),this},toJSON:function(){return this.getHex()}}),mn.NAMES=un,Object.assign(yn.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,i=e.vertexNormals.length;t<i;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,i=e.vertexColors.length;t<i;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}});let xn=0;function bn(){Object.defineProperty(this,"id",{value:xn++}),this.uuid=Ft.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.blending=u,this.side=a,this.flatShading=!1,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=M,this.blendDst=C,this.blendEquation=g,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=O,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=kt,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Rt,this.stencilZFail=Rt,this.stencilZPass=Rt,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}function _n(e){bn.call(this),this.type="MeshBasicMaterial",this.color=new mn(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=U,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.setValues(e)}bn.prototype=Object.assign(Object.create(Bt.prototype),{constructor:bn,isMaterial:!0,onBeforeCompile:function(){},customProgramCacheKey:function(){return this.onBeforeCompile.toString()},setValues:function(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}if("shading"===t){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===i;continue}const n=this[t];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[t]=i:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}},toJSON:function(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function n(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(i.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,i.reflectivity=this.reflectivity,i.refractionRatio=this.refractionRatio,void 0!==this.combine&&(i.combine=this.combine),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(i.size=this.size),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==u&&(i.blending=this.blending),!0===this.flatShading&&(i.flatShading=this.flatShading),this.side!==a&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(i.morphTargets=!0),!0===this.morphNormals&&(i.morphNormals=!0),!0===this.skinning&&(i.skinning=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),t){const t=n(e.textures),r=n(e.images);t.length>0&&(i.textures=t),r.length>0&&(i.images=r)}return i},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.blending=e.blending,this.side=e.side,this.flatShading=e.flatShading,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(null!==t){const e=t.length;i=new Array(e);for(let n=0;n!==e;++n)i[n]=t[n].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(bn.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),_n.prototype=Object.create(bn.prototype),_n.prototype.constructor=_n,_n.prototype.isMeshBasicMaterial=!0,_n.prototype.copy=function(e){return bn.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this};const wn=new Zt,Sn=new zt;function An(e,t,i){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===i,this.usage=Ot,this.updateRange={offset:0,count:-1},this.version=0}function Mn(e,t,i){An.call(this,new Int8Array(e),t,i)}function Cn(e,t,i){An.call(this,new Uint8Array(e),t,i)}function Pn(e,t,i){An.call(this,new Uint8ClampedArray(e),t,i)}function Tn(e,t,i){An.call(this,new Int16Array(e),t,i)}function In(e,t,i){An.call(this,new Uint16Array(e),t,i)}function En(e,t,i){An.call(this,new Int32Array(e),t,i)}function Dn(e,t,i){An.call(this,new Uint32Array(e),t,i)}function Ln(e,t,i){An.call(this,new Float32Array(e),t,i)}function Rn(e,t,i){An.call(this,new Float64Array(e),t,i)}function kn(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function On(e){if(0===e.length)return-1/0;let t=e[0];for(let i=1,n=e.length;i<n;++i)e[i]>t&&(t=e[i]);return t}Object.defineProperty(An.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(An.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setUsage:function(e){return this.usage=e,this},copy:function(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this},copyAt:function(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let n=0,r=this.itemSize;n<r;n++)this.array[e+n]=t.array[i+n];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){const t=this.array;let i=0;for(let n=0,r=e.length;n<r;n++){let r=e[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),r=new mn),t[i++]=r.r,t[i++]=r.g,t[i++]=r.b}return this},copyVector2sArray:function(e){const t=this.array;let i=0;for(let n=0,r=e.length;n<r;n++){let r=e[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",n),r=new zt),t[i++]=r.x,t[i++]=r.y}return this},copyVector3sArray:function(e){const t=this.array;let i=0;for(let n=0,r=e.length;n<r;n++){let r=e[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),r=new Zt),t[i++]=r.x,t[i++]=r.y,t[i++]=r.z}return this},copyVector4sArray:function(e){const t=this.array;let i=0;for(let n=0,r=e.length;n<r;n++){let r=e[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),r=new jt),t[i++]=r.x,t[i++]=r.y,t[i++]=r.z,t[i++]=r.w}return this},applyMatrix3:function(e){if(2===this.itemSize)for(let t=0,i=this.count;t<i;t++)Sn.fromBufferAttribute(this,t),Sn.applyMatrix3(e),this.setXY(t,Sn.x,Sn.y);else if(3===this.itemSize)for(let t=0,i=this.count;t<i;t++)wn.fromBufferAttribute(this,t),wn.applyMatrix3(e),this.setXYZ(t,wn.x,wn.y,wn.z);return this},applyMatrix4:function(e){for(let t=0,i=this.count;t<i;t++)wn.x=this.getX(t),wn.y=this.getY(t),wn.z=this.getZ(t),wn.applyMatrix4(e),this.setXYZ(t,wn.x,wn.y,wn.z);return this},applyNormalMatrix:function(e){for(let t=0,i=this.count;t<i;t++)wn.x=this.getX(t),wn.y=this.getY(t),wn.z=this.getZ(t),wn.applyNormalMatrix(e),this.setXYZ(t,wn.x,wn.y,wn.z);return this},transformDirection:function(e){for(let t=0,i=this.count;t<i;t++)wn.x=this.getX(t),wn.y=this.getY(t),wn.z=this.getZ(t),wn.transformDirection(e),this.setXYZ(t,wn.x,wn.y,wn.z);return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this},setXYZ:function(e,t,i,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this},setXYZW:function(e,t,i,n,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this.array[e+3]=r,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)},toJSON:function(){return{itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized}}}),Mn.prototype=Object.create(An.prototype),Mn.prototype.constructor=Mn,Cn.prototype=Object.create(An.prototype),Cn.prototype.constructor=Cn,Pn.prototype=Object.create(An.prototype),Pn.prototype.constructor=Pn,Tn.prototype=Object.create(An.prototype),Tn.prototype.constructor=Tn,In.prototype=Object.create(An.prototype),In.prototype.constructor=In,En.prototype=Object.create(An.prototype),En.prototype.constructor=En,Dn.prototype=Object.create(An.prototype),Dn.prototype.constructor=Dn,Ln.prototype=Object.create(An.prototype),Ln.prototype.constructor=Ln,Rn.prototype=Object.create(An.prototype),Rn.prototype.constructor=Rn,Object.assign(kn.prototype,{computeGroups:function(e){const t=[];let i,n,r;const s=e.faces;for(n=0;n<s.length;n++){const e=s[n];e.materialIndex!==r&&(r=e.materialIndex,void 0!==i&&(i.count=3*n-i.start,t.push(i)),i={start:3*n,materialIndex:r})}void 0!==i&&(i.count=3*n-i.start,t.push(i)),this.groups=t},fromGeometry:function(e){const t=e.faces,i=e.vertices,n=e.faceVertexUvs,r=n[0]&&n[0].length>0,s=n[1]&&n[1].length>0,o=e.morphTargets,a=o.length;let c;if(a>0){c=[];for(let e=0;e<a;e++)c[e]={name:o[e].name,data:[]};this.morphTargets.position=c}const l=e.morphNormals,h=l.length;let u;if(h>0){u=[];for(let e=0;e<h;e++)u[e]={name:l[e].name,data:[]};this.morphTargets.normal=u}const d=e.skinIndices,f=e.skinWeights,m=d.length===i.length,p=f.length===i.length;i.length>0&&0===t.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<t.length;e++){const g=t[e];this.vertices.push(i[g.a],i[g.b],i[g.c]);const v=g.vertexNormals;if(3===v.length)this.normals.push(v[0],v[1],v[2]);else{const e=g.normal;this.normals.push(e,e,e)}const y=g.vertexColors;if(3===y.length)this.colors.push(y[0],y[1],y[2]);else{const e=g.color;this.colors.push(e,e,e)}if(!0===r){const t=n[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new zt,new zt,new zt))}if(!0===s){const t=n[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new zt,new zt,new zt))}for(let e=0;e<a;e++){const t=o[e].vertices;c[e].data.push(t[g.a],t[g.b],t[g.c])}for(let t=0;t<h;t++){const i=l[t].vertexNormals[e];u[t].data.push(i.a,i.b,i.c)}m&&this.skinIndices.push(d[g.a],d[g.b],d[g.c]),p&&this.skinWeights.push(f[g.a],f[g.b],f[g.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}});let Bn=1;const Nn=new ri,Fn=new wi,zn=new Zt,Un=new Ni,$n=new Ni,Gn=new Zt;function Vn(){Object.defineProperty(this,"id",{value:Bn+=2}),this.uuid=Ft.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}Vn.prototype=Object.assign(Object.create(Bt.prototype),{constructor:Vn,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){Array.isArray(e)?this.index=new(On(e)>65535?Dn:In)(e,1):this.index=e},getAttribute:function(e){return this.attributes[e]},setAttribute:function(e,t){return this.attributes[e]=t,this},deleteAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,i){this.groups.push({start:e,count:t,materialIndex:void 0!==i?i:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix4:function(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const t=(new Ut).getNormalMatrix(e);i.applyNormalMatrix(t),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(e),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(e){return Nn.makeRotationX(e),this.applyMatrix4(Nn),this},rotateY:function(e){return Nn.makeRotationY(e),this.applyMatrix4(Nn),this},rotateZ:function(e){return Nn.makeRotationZ(e),this.applyMatrix4(Nn),this},translate:function(e,t,i){return Nn.makeTranslation(e,t,i),this.applyMatrix4(Nn),this},scale:function(e,t,i){return Nn.makeScale(e,t,i),this.applyMatrix4(Nn),this},lookAt:function(e){return Fn.lookAt(e),Fn.updateMatrix(),this.applyMatrix4(Fn.matrix),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(zn).negate(),this.translate(zn.x,zn.y,zn.z),this},setFromObject:function(e){const t=e.geometry;if(e.isPoints||e.isLine){const e=new Ln(3*t.vertices.length,3),i=new Ln(3*t.colors.length,3);if(this.setAttribute("position",e.copyVector3sArray(t.vertices)),this.setAttribute("color",i.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){const e=new Ln(t.lineDistances.length,1);this.setAttribute("lineDistance",e.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e.isMesh&&t&&t.isGeometry&&this.fromGeometry(t);return this},setFromPoints:function(e){const t=[];for(let i=0,n=e.length;i<n;i++){const n=e[i];t.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new Ln(t,3)),this},updateFromObject:function(e){let t=e.geometry;if(e.isMesh){let e=t.__directGeometry;if(!0===t.elementsNeedUpdate&&(e=void 0,t.elementsNeedUpdate=!1),void 0===e)return this.fromGeometry(t);e.verticesNeedUpdate=t.verticesNeedUpdate,e.normalsNeedUpdate=t.normalsNeedUpdate,e.colorsNeedUpdate=t.colorsNeedUpdate,e.uvsNeedUpdate=t.uvsNeedUpdate,e.groupsNeedUpdate=t.groupsNeedUpdate,t.verticesNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.groupsNeedUpdate=!1,t=e}if(!0===t.verticesNeedUpdate){const e=this.attributes.position;void 0!==e&&(e.copyVector3sArray(t.vertices),e.needsUpdate=!0),t.verticesNeedUpdate=!1}if(!0===t.normalsNeedUpdate){const e=this.attributes.normal;void 0!==e&&(e.copyVector3sArray(t.normals),e.needsUpdate=!0),t.normalsNeedUpdate=!1}if(!0===t.colorsNeedUpdate){const e=this.attributes.color;void 0!==e&&(e.copyColorsArray(t.colors),e.needsUpdate=!0),t.colorsNeedUpdate=!1}if(t.uvsNeedUpdate){const e=this.attributes.uv;void 0!==e&&(e.copyVector2sArray(t.uvs),e.needsUpdate=!0),t.uvsNeedUpdate=!1}if(t.lineDistancesNeedUpdate){const e=this.attributes.lineDistance;void 0!==e&&(e.copyArray(t.lineDistances),e.needsUpdate=!0),t.lineDistancesNeedUpdate=!1}return t.groupsNeedUpdate&&(t.computeGroups(e.geometry),this.groups=t.groups,t.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new kn).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){const t=new Float32Array(3*e.vertices.length);if(this.setAttribute("position",new An(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){const t=new Float32Array(3*e.normals.length);this.setAttribute("normal",new An(t,3).copyVector3sArray(e.normals))}if(e.colors.length>0){const t=new Float32Array(3*e.colors.length);this.setAttribute("color",new An(t,3).copyColorsArray(e.colors))}if(e.uvs.length>0){const t=new Float32Array(2*e.uvs.length);this.setAttribute("uv",new An(t,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){const t=new Float32Array(2*e.uvs2.length);this.setAttribute("uv2",new An(t,2).copyVector2sArray(e.uvs2))}this.groups=e.groups;for(const t in e.morphTargets){const i=[],n=e.morphTargets[t];for(let e=0,t=n.length;e<t;e++){const t=n[e],r=new Ln(3*t.data.length,3);r.name=t.name,i.push(r.copyVector3sArray(t.data))}this.morphAttributes[t]=i}if(e.skinIndices.length>0){const t=new Ln(4*e.skinIndices.length,4);this.setAttribute("skinIndex",t.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){const t=new Ln(4*e.skinWeights.length,4);this.setAttribute("skinWeight",t.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Ni);const e=this.attributes.position,t=this.morphAttributes.position;if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];Un.setFromBufferAttribute(i),this.morphTargetsRelative?(Gn.addVectors(this.boundingBox.min,Un.min),this.boundingBox.expandByPoint(Gn),Gn.addVectors(this.boundingBox.max,Un.max),this.boundingBox.expandByPoint(Gn)):(this.boundingBox.expandByPoint(Un.min),this.boundingBox.expandByPoint(Un.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Ui);const e=this.attributes.position,t=this.morphAttributes.position;if(e){const i=this.boundingSphere.center;if(Un.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];$n.setFromBufferAttribute(i),this.morphTargetsRelative?(Gn.addVectors(Un.min,$n.min),Un.expandByPoint(Gn),Gn.addVectors(Un.max,$n.max),Un.expandByPoint(Gn)):(Un.expandByPoint($n.min),Un.expandByPoint($n.max))}Un.getCenter(i);let n=0;for(let t=0,r=e.count;t<r;t++)Gn.fromBufferAttribute(e,t),n=Math.max(n,i.distanceToSquared(Gn));if(t)for(let r=0,s=t.length;r<s;r++){const s=t[r],o=this.morphTargetsRelative;for(let t=0,r=s.count;t<r;t++)Gn.fromBufferAttribute(s,t),o&&(zn.fromBufferAttribute(e,t),Gn.add(zn)),n=Math.max(n,i.distanceToSquared(Gn))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}},computeFaceNormals:function(){},computeVertexNormals:function(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let i=this.getAttribute("normal");if(void 0===i)i=new An(new Float32Array(3*t.count),3),this.setAttribute("normal",i);else for(let e=0,t=i.count;e<t;e++)i.setXYZ(e,0,0,0);const n=new Zt,r=new Zt,s=new Zt,o=new Zt,a=new Zt,c=new Zt,l=new Zt,h=new Zt;if(e)for(let u=0,d=e.count;u<d;u+=3){const d=e.getX(u+0),f=e.getX(u+1),m=e.getX(u+2);n.fromBufferAttribute(t,d),r.fromBufferAttribute(t,f),s.fromBufferAttribute(t,m),l.subVectors(s,r),h.subVectors(n,r),l.cross(h),o.fromBufferAttribute(i,d),a.fromBufferAttribute(i,f),c.fromBufferAttribute(i,m),o.add(l),a.add(l),c.add(l),i.setXYZ(d,o.x,o.y,o.z),i.setXYZ(f,a.x,a.y,a.z),i.setXYZ(m,c.x,c.y,c.z)}else for(let e=0,o=t.count;e<o;e+=3)n.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),s.fromBufferAttribute(t,e+2),l.subVectors(s,r),h.subVectors(n,r),l.cross(h),i.setXYZ(e+0,l.x,l.y,l.z),i.setXYZ(e+1,l.x,l.y,l.z),i.setXYZ(e+2,l.x,l.y,l.z);this.normalizeNormals(),i.needsUpdate=!0}},merge:function(e,t){if(!e||!e.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);void 0===t&&(t=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const i=this.attributes;for(const n in i){if(void 0===e.attributes[n])continue;const r=i[n].array,s=e.attributes[n],o=s.array,a=s.itemSize*t,c=Math.min(o.length,r.length-a);for(let e=0,t=a;e<c;e++,t++)r[t]=o[e]}return this},normalizeNormals:function(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)Gn.fromBufferAttribute(e,t),Gn.normalize(),e.setXYZ(t,Gn.x,Gn.y,Gn.z)},toNonIndexed:function(){function e(e,t){const i=e.array,n=e.itemSize,r=e.normalized,s=new i.constructor(t.length*n);let o=0,a=0;for(let e=0,r=t.length;e<r;e++){o=t[e]*n;for(let e=0;e<n;e++)s[a++]=i[o++]}return new An(s,n,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;const t=new Vn,i=this.index.array,n=this.attributes;for(const r in n){const s=e(n[r],i);t.setAttribute(r,s)}const r=this.morphAttributes;for(const n in r){const s=[],o=r[n];for(let t=0,n=o.length;t<n;t++){const n=e(o[t],i);s.push(n)}t.morphAttributes[n]=s}t.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let e=0,i=s.length;e<i;e++){const i=s[e];t.addGroup(i.start,i.count,i.materialIndex)}return t},toJSON:function(){const e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const t in i){const n=i[t],r=n.toJSON(e.data);""!==n.name&&(r.name=n.name),e.data.attributes[t]=r}const n={};let r=!1;for(const t in this.morphAttributes){const i=this.morphAttributes[t],s=[];for(let t=0,n=i.length;t<n;t++){const n=i[t],r=n.toJSON(e.data);""!==n.name&&(r.name=n.name),s.push(r)}s.length>0&&(n[t]=s,r=!0)}r&&(e.data.morphAttributes=n,e.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));const o=this.boundingSphere;return null!==o&&(e.data.boundingSphere={center:o.center.toArray(),radius:o.radius}),e},clone:function(){return(new Vn).copy(this)},copy:function(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;null!==i&&this.setIndex(i.clone(t));const n=e.attributes;for(const e in n){const i=n[e];this.setAttribute(e,i.clone(t))}const r=e.morphAttributes;for(const e in r){const i=[],n=r[e];for(let e=0,r=n.length;e<r;e++)i.push(n[e].clone(t));this.morphAttributes[e]=i}this.morphTargetsRelative=e.morphTargetsRelative;const s=e.groups;for(let e=0,t=s.length;e<t;e++){const t=s[e];this.addGroup(t.start,t.count,t.materialIndex)}const o=e.boundingBox;null!==o&&(this.boundingBox=o.clone());const a=e.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});const Hn=new ri,jn=new Xi,Wn=new Ui,qn=new Zt,Xn=new Zt,Yn=new Zt,Zn=new Zt,Kn=new Zt,Qn=new Zt,Jn=new Zt,er=new Zt,tr=new Zt,ir=new zt,nr=new zt,rr=new zt,sr=new Zt,or=new Zt;function ar(e,t){wi.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new Vn,this.material=void 0!==t?t:new _n,this.updateMorphTargets()}function cr(e,t,i,n,r,s,o,a){let h;if(h=t.side===c?n.intersectTriangle(o,s,r,!0,a):n.intersectTriangle(r,s,o,t.side!==l,a),null===h)return null;or.copy(a),or.applyMatrix4(e.matrixWorld);const u=i.ray.origin.distanceTo(or);return u<i.near||u>i.far?null:{distance:u,point:or.clone(),object:e}}function lr(e,t,i,n,r,s,o,a,c,l,h,u){qn.fromBufferAttribute(r,l),Xn.fromBufferAttribute(r,h),Yn.fromBufferAttribute(r,u);const d=e.morphTargetInfluences;if(t.morphTargets&&s&&d){Jn.set(0,0,0),er.set(0,0,0),tr.set(0,0,0);for(let e=0,t=s.length;e<t;e++){const t=d[e],i=s[e];0!==t&&(Zn.fromBufferAttribute(i,l),Kn.fromBufferAttribute(i,h),Qn.fromBufferAttribute(i,u),o?(Jn.addScaledVector(Zn,t),er.addScaledVector(Kn,t),tr.addScaledVector(Qn,t)):(Jn.addScaledVector(Zn.sub(qn),t),er.addScaledVector(Kn.sub(Xn),t),tr.addScaledVector(Qn.sub(Yn),t)))}qn.add(Jn),Xn.add(er),Yn.add(tr)}e.isSkinnedMesh&&(e.boneTransform(l,qn),e.boneTransform(h,Xn),e.boneTransform(u,Yn));const f=cr(e,t,i,n,qn,Xn,Yn,sr);if(f){a&&(ir.fromBufferAttribute(a,l),nr.fromBufferAttribute(a,h),rr.fromBufferAttribute(a,u),f.uv=hn.getUV(sr,qn,Xn,Yn,ir,nr,rr,new zt)),c&&(ir.fromBufferAttribute(c,l),nr.fromBufferAttribute(c,h),rr.fromBufferAttribute(c,u),f.uv2=hn.getUV(sr,qn,Xn,Yn,ir,nr,rr,new zt));const e=new yn(l,h,u);hn.getNormal(qn,Xn,Yn,e.normal),f.face=e}return f}ar.prototype=Object.assign(Object.create(wi.prototype),{constructor:ar,isMesh:!0,copy:function(e){return wi.prototype.copy.call(this,e),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=e.material,this.geometry=e.geometry,this},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}},raycast:function(e,t){const i=this.geometry,n=this.material,r=this.matrixWorld;if(void 0===n)return;if(null===i.boundingSphere&&i.computeBoundingSphere(),Wn.copy(i.boundingSphere),Wn.applyMatrix4(r),!1===e.ray.intersectsSphere(Wn))return;if(Hn.getInverse(r),jn.copy(e.ray).applyMatrix4(Hn),null!==i.boundingBox&&!1===jn.intersectsBox(i.boundingBox))return;let s;if(i.isBufferGeometry){const r=i.index,o=i.attributes.position,a=i.morphAttributes.position,c=i.morphTargetsRelative,l=i.attributes.uv,h=i.attributes.uv2,u=i.groups,d=i.drawRange;if(null!==r)if(Array.isArray(n))for(let i=0,f=u.length;i<f;i++){const f=u[i],m=n[f.materialIndex];for(let i=Math.max(f.start,d.start),n=Math.min(f.start+f.count,d.start+d.count);i<n;i+=3){const n=r.getX(i),u=r.getX(i+1),d=r.getX(i+2);s=lr(this,m,e,jn,o,a,c,l,h,n,u,d),s&&(s.faceIndex=Math.floor(i/3),s.face.materialIndex=f.materialIndex,t.push(s))}}else{for(let i=Math.max(0,d.start),u=Math.min(r.count,d.start+d.count);i<u;i+=3){const u=r.getX(i),d=r.getX(i+1),f=r.getX(i+2);s=lr(this,n,e,jn,o,a,c,l,h,u,d,f),s&&(s.faceIndex=Math.floor(i/3),t.push(s))}}else if(void 0!==o)if(Array.isArray(n))for(let i=0,r=u.length;i<r;i++){const r=u[i],f=n[r.materialIndex];for(let i=Math.max(r.start,d.start),n=Math.min(r.start+r.count,d.start+d.count);i<n;i+=3){s=lr(this,f,e,jn,o,a,c,l,h,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),s.face.materialIndex=r.materialIndex,t.push(s))}}else{for(let i=Math.max(0,d.start),r=Math.min(o.count,d.start+d.count);i<r;i+=3){s=lr(this,n,e,jn,o,a,c,l,h,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),t.push(s))}}}else if(i.isGeometry){const r=Array.isArray(n),o=i.vertices,a=i.faces;let c;const l=i.faceVertexUvs[0];l.length>0&&(c=l);for(let i=0,l=a.length;i<l;i++){const l=a[i],h=r?n[l.materialIndex]:n;if(void 0===h)continue;const u=o[l.a],d=o[l.b],f=o[l.c];if(s=cr(this,h,e,jn,u,d,f,sr),s){if(c&&c[i]){const e=c[i];ir.copy(e[0]),nr.copy(e[1]),rr.copy(e[2]),s.uv=hn.getUV(sr,u,d,f,ir,nr,rr,new zt)}s.face=l,s.faceIndex=i,t.push(s)}}}}});let hr=0;const ur=new ri,dr=new wi,fr=new Zt;function mr(){Object.defineProperty(this,"id",{value:hr+=2}),this.uuid=Ft.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}mr.prototype=Object.assign(Object.create(Bt.prototype),{constructor:mr,isGeometry:!0,applyMatrix4:function(e){const t=(new Ut).getNormalMatrix(e);for(let t=0,i=this.vertices.length;t<i;t++){this.vertices[t].applyMatrix4(e)}for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e];i.normal.applyMatrix3(t).normalize();for(let e=0,n=i.vertexNormals.length;e<n;e++)i.vertexNormals[e].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(e){return ur.makeRotationX(e),this.applyMatrix4(ur),this},rotateY:function(e){return ur.makeRotationY(e),this.applyMatrix4(ur),this},rotateZ:function(e){return ur.makeRotationZ(e),this.applyMatrix4(ur),this},translate:function(e,t,i){return ur.makeTranslation(e,t,i),this.applyMatrix4(ur),this},scale:function(e,t,i){return ur.makeScale(e,t,i),this.applyMatrix4(ur),this},lookAt:function(e){return dr.lookAt(e),dr.updateMatrix(),this.applyMatrix4(dr.matrix),this},fromBufferGeometry:function(e){const t=this,i=null!==e.index?e.index:void 0,n=e.attributes;if(void 0===n.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;const r=n.position,s=n.normal,o=n.color,a=n.uv,c=n.uv2;void 0!==c&&(this.faceVertexUvs[1]=[]);for(let e=0;e<r.count;e++)t.vertices.push((new Zt).fromBufferAttribute(r,e)),void 0!==o&&t.colors.push((new mn).fromBufferAttribute(o,e));function l(e,i,n,r){const l=void 0===o?[]:[t.colors[e].clone(),t.colors[i].clone(),t.colors[n].clone()],h=new yn(e,i,n,void 0===s?[]:[(new Zt).fromBufferAttribute(s,e),(new Zt).fromBufferAttribute(s,i),(new Zt).fromBufferAttribute(s,n)],l,r);t.faces.push(h),void 0!==a&&t.faceVertexUvs[0].push([(new zt).fromBufferAttribute(a,e),(new zt).fromBufferAttribute(a,i),(new zt).fromBufferAttribute(a,n)]),void 0!==c&&t.faceVertexUvs[1].push([(new zt).fromBufferAttribute(c,e),(new zt).fromBufferAttribute(c,i),(new zt).fromBufferAttribute(c,n)])}const h=e.groups;if(h.length>0)for(let e=0;e<h.length;e++){const t=h[e],n=t.start;for(let e=n,r=n+t.count;e<r;e+=3)void 0!==i?l(i.getX(e),i.getX(e+1),i.getX(e+2),t.materialIndex):l(e,e+1,e+2,t.materialIndex)}else if(void 0!==i)for(let e=0;e<i.count;e+=3)l(i.getX(e),i.getX(e+1),i.getX(e+2));else for(let e=0;e<r.count;e+=3)l(e,e+1,e+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(fr).negate(),this.translate(fr.x,fr.y,fr.z),this},normalize:function(){this.computeBoundingSphere();const e=this.boundingSphere.center,t=this.boundingSphere.radius,i=0===t?1:1/t,n=new ri;return n.set(i,0,0,-i*e.x,0,i,0,-i*e.y,0,0,i,-i*e.z,0,0,0,1),this.applyMatrix4(n),this},computeFaceNormals:function(){const e=new Zt,t=new Zt;for(let i=0,n=this.faces.length;i<n;i++){const n=this.faces[i],r=this.vertices[n.a],s=this.vertices[n.b],o=this.vertices[n.c];e.subVectors(o,s),t.subVectors(r,s),e.cross(t),e.normalize(),n.normal.copy(e)}},computeVertexNormals:function(e){void 0===e&&(e=!0);const t=new Array(this.vertices.length);for(let e=0,i=this.vertices.length;e<i;e++)t[e]=new Zt;if(e){const e=new Zt,i=new Zt;for(let n=0,r=this.faces.length;n<r;n++){const r=this.faces[n],s=this.vertices[r.a],o=this.vertices[r.b],a=this.vertices[r.c];e.subVectors(a,o),i.subVectors(s,o),e.cross(i),t[r.a].add(e),t[r.b].add(e),t[r.c].add(e)}}else{this.computeFaceNormals();for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e];t[i.a].add(i.normal),t[i.b].add(i.normal),t[i.c].add(i.normal)}}for(let e=0,i=this.vertices.length;e<i;e++)t[e].normalize();for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e],n=i.vertexNormals;3===n.length?(n[0].copy(t[i.a]),n[1].copy(t[i.b]),n[2].copy(t[i.c])):(n[0]=t[i.a].clone(),n[1]=t[i.b].clone(),n[2]=t[i.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){this.computeFaceNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],i=t.vertexNormals;3===i.length?(i[0].copy(t.normal),i[1].copy(t.normal),i[2].copy(t.normal)):(i[0]=t.normal.clone(),i[1]=t.normal.clone(),i[2]=t.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.__originalFaceNormal?t.__originalFaceNormal.copy(t.normal):t.__originalFaceNormal=t.normal.clone(),t.__originalVertexNormals||(t.__originalVertexNormals=[]);for(let e=0,i=t.vertexNormals.length;e<i;e++)t.__originalVertexNormals[e]?t.__originalVertexNormals[e].copy(t.vertexNormals[e]):t.__originalVertexNormals[e]=t.vertexNormals[e].clone()}const e=new mr;e.faces=this.faces;for(let t=0,i=this.morphTargets.length;t<i;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];const e=this.morphNormals[t].faceNormals,i=this.morphNormals[t].vertexNormals;for(let t=0,n=this.faces.length;t<n;t++){const t=new Zt,n={a:new Zt,b:new Zt,c:new Zt};e.push(t),i.push(n)}}const i=this.morphNormals[t];e.vertices=this.morphTargets[t].vertices,e.computeFaceNormals(),e.computeVertexNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],n=i.faceNormals[e],r=i.vertexNormals[e];n.copy(t.normal),r.a.copy(t.vertexNormals[0]),r.b.copy(t.vertexNormals[1]),r.c.copy(t.vertexNormals[2])}}for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.normal=t.__originalFaceNormal,t.vertexNormals=t.__originalVertexNormals}},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Ni),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Ui),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,i){if(!e||!e.isGeometry)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);let n,r=this.vertices.length,s=this.vertices,o=e.vertices,a=this.faces,c=e.faces,l=this.colors,h=e.colors;void 0===i&&(i=0),void 0!==t&&(n=(new Ut).getNormalMatrix(t));for(let e=0,i=o.length;e<i;e++){const i=o[e].clone();void 0!==t&&i.applyMatrix4(t),s.push(i)}for(let e=0,t=h.length;e<t;e++)l.push(h[e].clone());for(let e=0,t=c.length;e<t;e++){let t,s,o,l=c[e],h=l.vertexNormals,u=l.vertexColors;t=new yn(l.a+r,l.b+r,l.c+r),t.normal.copy(l.normal),void 0!==n&&t.normal.applyMatrix3(n).normalize();for(let e=0,i=h.length;e<i;e++)s=h[e].clone(),void 0!==n&&s.applyMatrix3(n).normalize(),t.vertexNormals.push(s);t.color.copy(l.color);for(let e=0,i=u.length;e<i;e++)o=u[e],t.vertexColors.push(o.clone());t.materialIndex=l.materialIndex+i,a.push(t)}for(let t=0,i=e.faceVertexUvs.length;t<i;t++){const i=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,n=i.length;e<n;e++){const n=i[e],r=[];for(let e=0,t=n.length;e<t;e++)r.push(n[e].clone());this.faceVertexUvs[t].push(r)}}},mergeMesh:function(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)},mergeVertices:function(){const e={},t=[],i=[],n=Math.pow(10,4);for(let r=0,s=this.vertices.length;r<s;r++){const s=this.vertices[r],o=Math.round(s.x*n)+"_"+Math.round(s.y*n)+"_"+Math.round(s.z*n);void 0===e[o]?(e[o]=r,t.push(this.vertices[r]),i[r]=t.length-1):i[r]=i[e[o]]}const r=[];for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.a=i[t.a],t.b=i[t.b],t.c=i[t.c];const n=[t.a,t.b,t.c];for(let t=0;t<3;t++)if(n[t]===n[(t+1)%3]){r.push(e);break}}for(let e=r.length-1;e>=0;e--){const t=r[e];this.faces.splice(t,1);for(let e=0,i=this.faceVertexUvs.length;e<i;e++)this.faceVertexUvs[e].splice(t,1)}const s=this.vertices.length-t.length;return this.vertices=t,s},setFromPoints:function(e){this.vertices=[];for(let t=0,i=e.length;t<i;t++){const i=e[t];this.vertices.push(new Zt(i.x,i.y,i.z||0))}return this},sortFacesByMaterialIndex:function(){const e=this.faces,t=e.length;for(let i=0;i<t;i++)e[i]._id=i;e.sort((function(e,t){return e.materialIndex-t.materialIndex}));const i=this.faceVertexUvs[0],n=this.faceVertexUvs[1];let r,s;i&&i.length===t&&(r=[]),n&&n.length===t&&(s=[]);for(let o=0;o<t;o++){const t=e[o]._id;r&&r.push(i[t]),s&&s.push(n[t])}r&&(this.faceVertexUvs[0]=r),s&&(this.faceVertexUvs[1]=s)},toJSON:function(){const e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}const t=[];for(let e=0;e<this.vertices.length;e++){const i=this.vertices[e];t.push(i.x,i.y,i.z)}const i=[],n=[],r={},s=[],o={},a=[],c={};for(let e=0;e<this.faces.length;e++){const t=this.faces[e],n=!0,r=!1,s=void 0!==this.faceVertexUvs[0][e],o=t.normal.length()>0,a=t.vertexNormals.length>0,c=1!==t.color.r||1!==t.color.g||1!==t.color.b,f=t.vertexColors.length>0;let m=0;if(m=l(m,0,0),m=l(m,1,n),m=l(m,2,r),m=l(m,3,s),m=l(m,4,o),m=l(m,5,a),m=l(m,6,c),m=l(m,7,f),i.push(m),i.push(t.a,t.b,t.c),i.push(t.materialIndex),s){const t=this.faceVertexUvs[0][e];i.push(d(t[0]),d(t[1]),d(t[2]))}if(o&&i.push(h(t.normal)),a){const e=t.vertexNormals;i.push(h(e[0]),h(e[1]),h(e[2]))}if(c&&i.push(u(t.color)),f){const e=t.vertexColors;i.push(u(e[0]),u(e[1]),u(e[2]))}}function l(e,t,i){return i?e|1<<t:e&~(1<<t)}function h(e){const t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==r[t]||(r[t]=n.length/3,n.push(e.x,e.y,e.z)),r[t]}function u(e){const t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==o[t]||(o[t]=s.length,s.push(e.getHex())),o[t]}function d(e){const t=e.x.toString()+e.y.toString();return void 0!==c[t]||(c[t]=a.length/2,a.push(e.x,e.y)),c[t]}return e.data={},e.data.vertices=t,e.data.normals=n,s.length>0&&(e.data.colors=s),a.length>0&&(e.data.uvs=[a]),e.data.faces=i,e},clone:function(){return(new mr).copy(this)},copy:function(e){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;const t=e.vertices;for(let e=0,i=t.length;e<i;e++)this.vertices.push(t[e].clone());const i=e.colors;for(let e=0,t=i.length;e<t;e++)this.colors.push(i[e].clone());const n=e.faces;for(let e=0,t=n.length;e<t;e++)this.faces.push(n[e].clone());for(let t=0,i=e.faceVertexUvs.length;t<i;t++){const i=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,n=i.length;e<n;e++){const n=i[e],r=[];for(let e=0,t=n.length;e<t;e++){const t=n[e];r.push(t.clone())}this.faceVertexUvs[t].push(r)}}const r=e.morphTargets;for(let e=0,t=r.length;e<t;e++){const t={};if(t.name=r[e].name,void 0!==r[e].vertices){t.vertices=[];for(let i=0,n=r[e].vertices.length;i<n;i++)t.vertices.push(r[e].vertices[i].clone())}if(void 0!==r[e].normals){t.normals=[];for(let i=0,n=r[e].normals.length;i<n;i++)t.normals.push(r[e].normals[i].clone())}this.morphTargets.push(t)}const s=e.morphNormals;for(let e=0,t=s.length;e<t;e++){const t={};if(void 0!==s[e].vertexNormals){t.vertexNormals=[];for(let i=0,n=s[e].vertexNormals.length;i<n;i++){const n=s[e].vertexNormals[i],r={};r.a=n.a.clone(),r.b=n.b.clone(),r.c=n.c.clone(),t.vertexNormals.push(r)}}if(void 0!==s[e].faceNormals){t.faceNormals=[];for(let i=0,n=s[e].faceNormals.length;i<n;i++)t.faceNormals.push(s[e].faceNormals[i].clone())}this.morphNormals.push(t)}const o=e.skinWeights;for(let e=0,t=o.length;e<t;e++)this.skinWeights.push(o[e].clone());const a=e.skinIndices;for(let e=0,t=a.length;e<t;e++)this.skinIndices.push(a[e].clone());const c=e.lineDistances;for(let e=0,t=c.length;e<t;e++)this.lineDistances.push(c[e]);const l=e.boundingBox;null!==l&&(this.boundingBox=l.clone());const h=e.boundingSphere;return null!==h&&(this.boundingSphere=h.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});class pr extends Vn{constructor(e,t,i,n,r,s){super(),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:n,heightSegments:r,depthSegments:s};const o=this;e=e||1,t=t||1,i=i||1,n=Math.floor(n)||1,r=Math.floor(r)||1,s=Math.floor(s)||1;const a=[],c=[],l=[],h=[];let u=0,d=0;function f(e,t,i,n,r,s,f,m,p,g,v){const y=s/p,x=f/g,b=s/2,_=f/2,w=m/2,S=p+1,A=g+1;let M=0,C=0;const P=new Zt;for(let s=0;s<A;s++){const o=s*x-_;for(let a=0;a<S;a++){const u=a*y-b;P[e]=u*n,P[t]=o*r,P[i]=w,c.push(P.x,P.y,P.z),P[e]=0,P[t]=0,P[i]=m>0?1:-1,l.push(P.x,P.y,P.z),h.push(a/p),h.push(1-s/g),M+=1}}for(let e=0;e<g;e++)for(let t=0;t<p;t++){const i=u+t+S*e,n=u+t+S*(e+1),r=u+(t+1)+S*(e+1),s=u+(t+1)+S*e;a.push(i,n,s),a.push(n,r,s),C+=6}o.addGroup(d,C,v),d+=C,u+=M}f("z","y","x",-1,-1,i,t,e,s,r,0),f("z","y","x",1,-1,i,t,-e,s,r,1),f("x","z","y",1,1,e,i,t,n,s,2),f("x","z","y",1,-1,e,i,-t,n,s,3),f("x","y","z",1,-1,e,t,i,n,r,4),f("x","y","z",-1,-1,e,t,-i,n,r,5),this.setIndex(a),this.setAttribute("position",new Ln(c,3)),this.setAttribute("normal",new Ln(l,3)),this.setAttribute("uv",new Ln(h,2))}}function gr(e){const t={};for(const i in e){t[i]={};for(const n in e[i]){const r=e[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture)?t[i][n]=r.clone():Array.isArray(r)?t[i][n]=r.slice():t[i][n]=r}}return t}function vr(e){const t={};for(let i=0;i<e.length;i++){const n=gr(e[i]);for(const e in n)t[e]=n[e]}return t}const yr={clone:gr,merge:vr};var xr="void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}",br="void main(){gl_FragColor=vec4(1.0,0.0,0.0,1.0);}";function _r(e){bn.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader=xr,this.fragmentShader=br,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function wr(){wi.call(this),this.type="Camera",this.matrixWorldInverse=new ri,this.projectionMatrix=new ri,this.projectionMatrixInverse=new ri}function Sr(e,t,i,n){wr.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==i?i:.1,this.far=void 0!==n?n:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function Ar(e,t,i,n,r,s,o,a,c,l,h,u){Ht.call(this,null,s,o,a,c,l,n,r,h,u),this.image={data:e||null,width:t||1,height:i||1},this.magFilter=void 0!==c?c:re,this.minFilter=void 0!==l?l:re,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}_r.prototype=Object.create(bn.prototype),_r.prototype.constructor=_r,_r.prototype.isShaderMaterial=!0,_r.prototype.copy=function(e){return bn.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=gr(e.uniforms),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=Object.assign({},e.extensions),this},_r.prototype.toJSON=function(e){const t=bn.prototype.toJSON.call(this,e);t.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?t.uniforms[i]={type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?t.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?t.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?t.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?t.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?t.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?t.uniforms[i]={type:"m4",value:n.toArray()}:t.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader;const i={};for(const e in this.extensions)!0===this.extensions[e]&&(i[e]=!0);return Object.keys(i).length>0&&(t.extensions=i),t},wr.prototype=Object.assign(Object.create(wi.prototype),{constructor:wr,isCamera:!0,copy:function(e,t){return wi.prototype.copy.call(this,e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this},getWorldDirection:function(e){void 0===e&&(console.warn("THREE.Camera: .getWorldDirection() target is now required"),e=new Zt),this.updateMatrixWorld(!0);const t=this.matrixWorld.elements;return e.set(-t[8],-t[9],-t[10]).normalize()},updateMatrixWorld:function(e){wi.prototype.updateMatrixWorld.call(this,e),this.matrixWorldInverse.getInverse(this.matrixWorld)},updateWorldMatrix:function(e,t){wi.prototype.updateWorldMatrix.call(this,e,t),this.matrixWorldInverse.getInverse(this.matrixWorld)},clone:function(){return(new this.constructor).copy(this)}}),Sr.prototype=Object.assign(Object.create(wr.prototype),{constructor:Sr,isPerspectiveCamera:!0,copy:function(e,t){return wr.prototype.copy.call(this,e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){const t=.5*this.getFilmHeight()/e;this.fov=2*Ft.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){const e=Math.tan(.5*Ft.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*Ft.RAD2DEG*Math.atan(Math.tan(.5*Ft.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,i,n,r,s){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){let e=this.near,t=e*Math.tan(.5*Ft.DEG2RAD*this.fov)/this.zoom,i=2*t,n=this.aspect*i,r=-.5*n,s=this.view;if(null!==this.view&&this.view.enabled){const e=s.fullWidth,o=s.fullHeight;r+=s.offsetX*n/e,t-=s.offsetY*i/o,n*=s.width/e,i*=s.height/o}const o=this.filmOffset;0!==o&&(r+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,t,t-i,e,this.far),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},toJSON:function(e){const t=wi.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),Ar.prototype=Object.create(Ht.prototype),Ar.prototype.constructor=Ar,Ar.prototype.isDataTexture=!0;const Mr=new Ui,Cr=new Zt;function Pr(e,t,i,n,r,s){this.planes=[void 0!==e?e:new Qi,void 0!==t?t:new Qi,void 0!==i?i:new Qi,void 0!==n?n:new Qi,void 0!==r?r:new Qi,void 0!==s?s:new Qi]}Object.assign(Pr.prototype,{set:function(e,t,i,n,r,s){const o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(i),o[3].copy(n),o[4].copy(r),o[5].copy(s),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this},setFromProjectionMatrix:function(e){const t=this.planes,i=e.elements,n=i[0],r=i[1],s=i[2],o=i[3],a=i[4],c=i[5],l=i[6],h=i[7],u=i[8],d=i[9],f=i[10],m=i[11],p=i[12],g=i[13],v=i[14],y=i[15];return t[0].setComponents(o-n,h-a,m-u,y-p).normalize(),t[1].setComponents(o+n,h+a,m+u,y+p).normalize(),t[2].setComponents(o+r,h+c,m+d,y+g).normalize(),t[3].setComponents(o-r,h-c,m-d,y-g).normalize(),t[4].setComponents(o-s,h-l,m-f,y-v).normalize(),t[5].setComponents(o+s,h+l,m+f,y+v).normalize(),this},intersectsObject:function(e){const t=e.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),Mr.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(Mr)},intersectsSprite:function(e){return Mr.center.set(0,0,0),Mr.radius=.7071067811865476,Mr.applyMatrix4(e.matrixWorld),this.intersectsSphere(Mr)},intersectsSphere:function(e){const t=this.planes,i=e.center,n=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(i)<n)return!1}return!0},intersectsBox:function(e){const t=this.planes;for(let i=0;i<6;i++){const n=t[i];if(Cr.x=n.normal.x>0?e.max.x:e.min.x,Cr.y=n.normal.y>0?e.max.y:e.min.y,Cr.z=n.normal.z>0?e.max.z:e.min.z,n.distanceToPoint(Cr)<0)return!1}return!0},containsPoint:function(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}});const Tr={common:{diffuse:{value:new mn(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new Ut},uv2Transform:{value:new Ut},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new zt(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new mn(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new mn(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new Ut}},sprite:{diffuse:{value:new mn(15658734)},opacity:{value:1},center:{value:new zt(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new Ut}}};function Ir(){let e=null,t=!1,i=null,n=null;function r(t,s){i(t,s),n=e.requestAnimationFrame(r)}return{start:function(){!0!==t&&null!==i&&(n=e.requestAnimationFrame(r),t=!0)},stop:function(){e.cancelAnimationFrame(n),t=!1},setAnimationLoop:function(e){i=e},setContext:function(t){e=t}}}function Er(e,t){const i=t.isWebGL2,n=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),n.get(e)},remove:function(t){t.isInterleavedBufferAttribute&&(t=t.data);const i=n.get(t);i&&(e.deleteBuffer(i.buffer),n.delete(t))},update:function(t,r){t.isInterleavedBufferAttribute&&(t=t.data);const s=n.get(t);void 0===s?n.set(t,function(t,i){const n=t.array,r=t.usage,s=e.createBuffer();e.bindBuffer(i,s),e.bufferData(i,n,r),t.onUploadCallback();let o=5126;return n instanceof Float32Array?o=5126:n instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):n instanceof Uint16Array?o=5123:n instanceof Int16Array?o=5122:n instanceof Uint32Array?o=5125:n instanceof Int32Array?o=5124:n instanceof Int8Array?o=5120:n instanceof Uint8Array&&(o=5121),{buffer:s,type:o,bytesPerElement:n.BYTES_PER_ELEMENT,version:t.version}}(t,r)):s.version<t.version&&(!function(t,n,r){const s=n.array,o=n.updateRange;e.bindBuffer(r,t),-1===o.count?e.bufferSubData(r,0,s):(i?e.bufferSubData(r,o.offset*s.BYTES_PER_ELEMENT,s,o.offset,o.count):e.bufferSubData(r,o.offset*s.BYTES_PER_ELEMENT,s.subarray(o.offset,o.offset+o.count)),o.count=-1)}(s.buffer,t,r),s.version=t.version)}}}function Dr(e,t,i,n){mr.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:n},this.fromBufferGeometry(new Lr(e,t,i,n)),this.mergeVertices()}function Lr(e,t,i,n){Vn.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:n};const r=(e=e||1)/2,s=(t=t||1)/2,o=Math.floor(i)||1,a=Math.floor(n)||1,c=o+1,l=a+1,h=e/o,u=t/a,d=[],f=[],m=[],p=[];for(let e=0;e<l;e++){const t=e*u-s;for(let i=0;i<c;i++){const n=i*h-r;f.push(n,-t,0),m.push(0,0,1),p.push(i/o),p.push(1-e/a)}}for(let e=0;e<a;e++)for(let t=0;t<o;t++){const i=t+c*e,n=t+c*(e+1),r=t+1+c*(e+1),s=t+1+c*e;d.push(i,n,s),d.push(n,r,s)}this.setIndex(d),this.setAttribute("position",new Ln(f,3)),this.setAttribute("normal",new Ln(m,3)),this.setAttribute("uv",new Ln(p,2))}Dr.prototype=Object.create(mr.prototype),Dr.prototype.constructor=Dr,Lr.prototype=Object.create(Vn.prototype),Lr.prototype.constructor=Lr;const Rr={alphamap_fragment:"#ifdef USE_ALPHAMAP\ndiffuseColor.a*=texture2D(alphaMap,vUv).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\nuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef ALPHATEST\nif(diffuseColor.a<ALPHATEST)discard;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\nfloat ambientOcclusion=(texture2D(aoMap,vUv2).r-1.0)*aoMapIntensity+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;\n#if defined(USE_ENVMAP)&&defined(STANDARD)\nfloat dotNV=saturate(dot(geometry.normal,geometry.viewDir));reflectedLight.indirectSpecular*=computeSpecularOcclusion(dotNV,ambientOcclusion,material.specularRoughness);\n#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\nuniform sampler2D aoMap;uniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed=vec3(position);",beginnormal_vertex:"vec3 objectNormal=vec3(normal);\n#ifdef USE_TANGENT\nvec3 objectTangent=vec3(tangent.xyz);\n#endif",bsdfs:"vec2 integrateSpecularBRDF(const in float dotNV,const in float roughness){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;return vec2(-1.04,1.04)*a004+r.zw;}float punctualLightIntensityToIrradianceFactor(const in float lightDistance,const in float cutoffDistance,const in float decayExponent){\n#if defined(PHYSICALLY_CORRECT_LIGHTS)\nfloat distanceFalloff=1.0/max(pow(lightDistance,decayExponent),0.01);if(cutoffDistance>0.0){distanceFalloff*=pow2(saturate(1.0-pow4(lightDistance/cutoffDistance)));}return distanceFalloff;\n#else\nif(cutoffDistance>0.0&&decayExponent>0.0){return pow(saturate(-lightDistance/cutoffDistance+1.0),decayExponent);}return 1.0;\n#endif\n}vec3 BRDF_Diffuse_Lambert(const in vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}vec3 F_Schlick(const in vec3 specularColor,const in float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}vec3 F_Schlick_RoughnessDependent(const in vec3 F0,const in float dotNV,const in float roughness){float fresnel=exp2((-5.55473*dotNV-6.98316)*dotNV);vec3 Fr=max(vec3(1.0-roughness),F0)-F0;return Fr*fresnel+F0;}float G_GGX_Smith(const in float alpha,const in float dotNL,const in float dotNV){float a2=pow2(alpha);float gl=dotNL+sqrt(a2+(1.0-a2)*pow2(dotNL));float gv=dotNV+sqrt(a2+(1.0-a2)*pow2(dotNV));return 1.0/(gl*gv);}float G_GGX_SmithCorrelated(const in float alpha,const in float dotNL,const in float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(const in float alpha,const in float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight,const in vec3 viewDir,const in vec3 normal,const in vec3 specularColor,const in float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentLight.direction+viewDir);float dotNL=saturate(dot(normal,incidentLight.direction));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotLH=saturate(dot(incidentLight.direction,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}vec2 LTC_Uv(const in vec3 N,const in vec3 V,const in float roughness){const float LUT_SIZE=64.0;const float LUT_SCALE=(LUT_SIZE-1.0)/LUT_SIZE;const float LUT_BIAS=0.5/LUT_SIZE;float dotNV=saturate(dot(N,V));vec2 uv=vec2(roughness,sqrt(1.0-dotNV));uv=uv*LUT_SCALE+LUT_BIAS;return uv;}float LTC_ClippedSphereFormFactor(const in vec3 f){float l=length(f);return max((l*l+f.z)/(l+1.0),0.0);}vec3 LTC_EdgeVectorFormFactor(const in vec3 v1,const in vec3 v2){float x=dot(v1,v2);float y=abs(x);float a=0.8543985+(0.4965155+0.0145206*y)*y;float b=3.4175940+(4.1616724+y)*y;float v=a/b;float theta_sintheta=(x>0.0)?v:0.5*inversesqrt(max(1.0-x*x,1e-7))-v;return cross(v1,v2)*theta_sintheta;}vec3 LTC_Evaluate(const in vec3 N,const in vec3 V,const in vec3 P,const in mat3 mInv,const in vec3 rectCoords[4]){vec3 v1=rectCoords[1]-rectCoords[0];vec3 v2=rectCoords[3]-rectCoords[0];vec3 lightNormal=cross(v1,v2);if(dot(lightNormal,P-rectCoords[0])<0.0)return vec3(0.0);vec3 T1,T2;T1=normalize(V-N*dot(V,N));T2=-cross(N,T1);mat3 mat=mInv*transposeMat3(mat3(T1,T2,N));vec3 coords[4];coords[0]=mat*(rectCoords[0]-P);coords[1]=mat*(rectCoords[1]-P);coords[2]=mat*(rectCoords[2]-P);coords[3]=mat*(rectCoords[3]-P);coords[0]=normalize(coords[0]);coords[1]=normalize(coords[1]);coords[2]=normalize(coords[2]);coords[3]=normalize(coords[3]);vec3 vectorFormFactor=vec3(0.0);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[0],coords[1]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[1],coords[2]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[2],coords[3]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[3],coords[0]);float result=LTC_ClippedSphereFormFactor(vectorFormFactor);return vec3(result);}vec3 BRDF_Specular_GGX_Environment(const in vec3 viewDir,const in vec3 normal,const in vec3 specularColor,const in float roughness){float dotNV=saturate(dot(normal,viewDir));vec2 brdf=integrateSpecularBRDF(dotNV,roughness);return specularColor*brdf.x+brdf.y;}void BRDF_Specular_Multiscattering_Environment(const in GeometricContext geometry,const in vec3 specularColor,const in float roughness,inout vec3 singleScatter,inout vec3 multiScatter){float dotNV=saturate(dot(geometry.normal,geometry.viewDir));vec3 F=F_Schlick_RoughnessDependent(specularColor,dotNV,roughness);vec2 brdf=integrateSpecularBRDF(dotNV,roughness);vec3 FssEss=F*brdf.x+brdf.y;float Ess=brdf.x+brdf.y;float Ems=1.0-Ess;vec3 Favg=specularColor+(1.0-specularColor)*0.047619;vec3 Fms=FssEss*Favg/(1.0-Ems*Favg);singleScatter+=FssEss;multiScatter+=Fms*Ems;}float G_BlinnPhong_Implicit(){return 0.25;}float D_BlinnPhong(const in float shininess,const in float dotNH){return RECIPROCAL_PI*(shininess*0.5+1.0)*pow(dotNH,shininess);}vec3 BRDF_Specular_BlinnPhong(const in IncidentLight incidentLight,const in GeometricContext geometry,const in vec3 specularColor,const in float shininess){vec3 halfDir=normalize(incidentLight.direction+geometry.viewDir);float dotNH=saturate(dot(geometry.normal,halfDir));float dotLH=saturate(dot(incidentLight.direction,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_BlinnPhong_Implicit();float D=D_BlinnPhong(shininess,dotNH);return F*(G*D);}float GGXRoughnessToBlinnExponent(const in float ggxRoughness){return(2.0/pow2(ggxRoughness+0.0001)-2.0);}float BlinnExponentToGGXRoughness(const in float blinnExponent){return sqrt(2.0/(blinnExponent+2.0));}\n#if defined(USE_SHEEN)\nfloat D_Charlie(float roughness,float NoH){float invAlpha=1.0/roughness;float cos2h=NoH*NoH;float sin2h=max(1.0-cos2h,0.0078125);return(2.0+invAlpha)*pow(sin2h,invAlpha*0.5)/(2.0*PI);}float V_Neubelt(float NoV,float NoL){return saturate(1.0/(4.0*(NoL+NoV-NoL*NoV)));}vec3 BRDF_Specular_Sheen(const in float roughness,const in vec3 L,const in GeometricContext geometry,vec3 specularColor){vec3 N=geometry.normal;vec3 V=geometry.viewDir;vec3 H=normalize(V+L);float dotNH=saturate(dot(N,H));return specularColor*D_Charlie(roughness,dotNH)*V_Neubelt(dot(N,V),dot(N,L));}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\nuniform sampler2D bumpMap;uniform float bumpScale;vec2 dHdxy_fwd(){vec2 dSTdx=dFdx(vUv);vec2 dSTdy=dFdy(vUv);float Hll=bumpScale*texture2D(bumpMap,vUv).x;float dBx=bumpScale*texture2D(bumpMap,vUv+dSTdx).x-Hll;float dBy=bumpScale*texture2D(bumpMap,vUv+dSTdy).x-Hll;return vec2(dBx,dBy);}vec3 perturbNormalArb(vec3 surf_pos,vec3 surf_norm,vec2 dHdxy){vec3 vSigmaX=vec3(dFdx(surf_pos.x),dFdx(surf_pos.y),dFdx(surf_pos.z));vec3 vSigmaY=vec3(dFdy(surf_pos.x),dFdy(surf_pos.y),dFdy(surf_pos.z));vec3 vN=surf_norm;vec3 R1=cross(vSigmaY,vN);vec3 R2=cross(vN,vSigmaX);float fDet=dot(vSigmaX,R1);fDet*=(float(gl_FrontFacing)*2.0-1.0);vec3 vGrad=sign(fDet)*(dHdxy.x*R1+dHdxy.y*R2);return normalize(abs(fDet)*surf_norm-vGrad);}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES>0\nvec4 plane;\n#pragma unroll_loop_start\nfor(int i=0;i<UNION_CLIPPING_PLANES;i++){plane=clippingPlanes[i];if(dot(vClipPosition,plane.xyz)>plane.w)discard;}\n#pragma unroll_loop_end\n#if UNION_CLIPPING_PLANES<NUM_CLIPPING_PLANES\nbool clipped=true;\n#pragma unroll_loop_start\nfor(int i=UNION_CLIPPING_PLANES;i<NUM_CLIPPING_PLANES;i++){plane=clippingPlanes[i];clipped=(dot(vClipPosition,plane.xyz)>plane.w)&&clipped;}\n#pragma unroll_loop_end\nif(clipped)discard;\n#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES>0\nvarying vec3 vClipPosition;uniform vec4 clippingPlanes[NUM_CLIPPING_PLANES];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES>0\nvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES>0\nvClipPosition=-mvPosition.xyz;\n#endif",color_fragment:"#ifdef USE_COLOR\ndiffuseColor.rgb*=vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_pars_vertex:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\nvColor.xyz=color.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a)clamp(a,0.0,1.0)\n#endif\n#define whiteComplement(a)(1.0-saturate(a))\nfloat pow2(const in float x){return x*x;}float pow3(const in float x){return x*x*x;}float pow4(const in float x){float x2=x*x;return x2*x2;}float average(const in vec3 color){return dot(color,vec3(0.3333));}highp float rand(const in vec2 uv){const highp float a=12.9898,b=78.233,c=43758.5453;highp float dt=dot(uv.xy,vec2(a,b)),sn=mod(dt,PI);return fract(sin(sn)*c);}\n#ifdef HIGH_PRECISION\nfloat precisionSafeLength(vec3 v){return length(v);}\n#else\nfloat max3(vec3 v){return max(max(v.x,v.y),v.z);}float precisionSafeLength(vec3 v){float maxComponent=max3(abs(v));return length(v/maxComponent)*maxComponent;}\n#endif\nstruct IncidentLight{vec3 color;vec3 direction;bool visible;};struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct GeometricContext{vec3 position;vec3 normal;vec3 viewDir;\n#ifdef CLEARCOAT\nvec3 clearcoatNormal;\n#endif\n};vec3 transformDirection(in vec3 dir,in mat4 matrix){return normalize((matrix*vec4(dir,0.0)).xyz);}vec3 inverseTransformDirection(in vec3 dir,in mat4 matrix){return normalize((vec4(dir,0.0)*matrix).xyz);}vec3 projectOnPlane(in vec3 point,in vec3 pointOnPlane,in vec3 planeNormal){float distance=dot(planeNormal,point-pointOnPlane);return-distance*planeNormal+point;}float sideOfPlane(in vec3 point,in vec3 pointOnPlane,in vec3 planeNormal){return sign(dot(point-pointOnPlane,planeNormal));}vec3 linePlaneIntersect(in vec3 pointOnLine,in vec3 lineDirection,in vec3 pointOnPlane,in vec3 planeNormal){return lineDirection*(dot(planeNormal,pointOnPlane-pointOnLine)/dot(planeNormal,lineDirection))+pointOnLine;}mat3 transposeMat3(const in mat3 m){mat3 tmp;tmp[0]=vec3(m[0].x,m[1].x,m[2].x);tmp[1]=vec3(m[0].y,m[1].y,m[2].y);tmp[2]=vec3(m[0].z,m[1].z,m[2].z);return tmp;}float linearToRelativeLuminance(const in vec3 color){vec3 weights=vec3(0.2126,0.7152,0.0722);return dot(weights,color.rgb);}bool isPerspectiveMatrix(mat4 m){return m[2][3]==-1.0;}vec2 equirectUv(in vec3 dir){float u=atan(dir.z,dir.x)*RECIPROCAL_PI2+0.5;float v=asin(clamp(dir.y,-1.0,1.0))*RECIPROCAL_PI+0.5;return vec2(u,v);}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_maxMipLevel 8.0\n#define cubeUV_minMipLevel 4.0\n#define cubeUV_maxTileSize 256.0\n#define cubeUV_minTileSize 16.0\nfloat getFace(vec3 direction){vec3 absDirection=abs(direction);float face=-1.0;if(absDirection.x>absDirection.z){if(absDirection.x>absDirection.y)face=direction.x>0.0?0.0:3.0;else face=direction.y>0.0?1.0:4.0;}else{if(absDirection.z>absDirection.y)face=direction.z>0.0?2.0:5.0;else face=direction.y>0.0?1.0:4.0;}return face;}vec2 getUV(vec3 direction,float face){vec2 uv;if(face==0.0){uv=vec2(direction.z,direction.y)/abs(direction.x);}else if(face==1.0){uv=vec2(-direction.x,-direction.z)/abs(direction.y);}else if(face==2.0){uv=vec2(-direction.x,direction.y)/abs(direction.z);}else if(face==3.0){uv=vec2(-direction.z,direction.y)/abs(direction.x);}else if(face==4.0){uv=vec2(-direction.x,direction.z)/abs(direction.y);}else{uv=vec2(direction.x,direction.y)/abs(direction.z);}return 0.5*(uv+1.0);}vec3 bilinearCubeUV(sampler2D envMap,vec3 direction,float mipInt){float face=getFace(direction);float filterInt=max(cubeUV_minMipLevel-mipInt,0.0);mipInt=max(mipInt,cubeUV_minMipLevel);float faceSize=exp2(mipInt);float texelSize=1.0/(3.0*cubeUV_maxTileSize);vec2 uv=getUV(direction,face)*(faceSize-1.0);vec2 f=fract(uv);uv+=0.5-f;if(face>2.0){uv.y+=faceSize;face-=3.0;}uv.x+=face*faceSize;if(mipInt<cubeUV_maxMipLevel){uv.y+=2.0*cubeUV_maxTileSize;}uv.y+=filterInt*2.0*cubeUV_minTileSize;uv.x+=3.0*max(0.0,cubeUV_maxTileSize-2.0*faceSize);uv*=texelSize;vec3 tl=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.x+=texelSize;vec3 tr=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.y+=texelSize;vec3 br=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.x-=texelSize;vec3 bl=envMapTexelToLinear(texture2D(envMap,uv)).rgb;vec3 tm=mix(tl,tr,f.x);vec3 bm=mix(bl,br,f.x);return mix(tm,bm,f.y);}\n#define r0 1.0\n#define v0 0.339\n#define m0-2.0\n#define r1 0.8\n#define v1 0.276\n#define m1-1.0\n#define r4 0.4\n#define v4 0.046\n#define m4 2.0\n#define r5 0.305\n#define v5 0.016\n#define m5 3.0\n#define r6 0.21\n#define v6 0.0038\n#define m6 4.0\nfloat roughnessToMip(float roughness){float mip=0.0;if(roughness>=r1){mip=(r0-roughness)*(m1-m0)/(r0-r1)+m0;}else if(roughness>=r4){mip=(r1-roughness)*(m4-m1)/(r1-r4)+m1;}else if(roughness>=r5){mip=(r4-roughness)*(m5-m4)/(r4-r5)+m4;}else if(roughness>=r6){mip=(r5-roughness)*(m6-m5)/(r5-r6)+m5;}else{mip=-2.0*log2(1.16*roughness);}return mip;}vec4 textureCubeUV(sampler2D envMap,vec3 sampleDir,float roughness){float mip=clamp(roughnessToMip(roughness),m0,cubeUV_maxMipLevel);float mipF=fract(mip);float mipInt=floor(mip);vec3 color0=bilinearCubeUV(envMap,sampleDir,mipInt);if(mipF==0.0){return vec4(color0,1.0);}else{vec3 color1=bilinearCubeUV(envMap,sampleDir,mipInt+1.0);return vec4(mix(color0,color1,mipF),1.0);}}\n#endif",defaultnormal_vertex:"vec3 transformedNormal=objectNormal;\n#ifdef USE_INSTANCING\nmat3 m=mat3(instanceMatrix);transformedNormal/=vec3(dot(m[0],m[0]),dot(m[1],m[1]),dot(m[2],m[2]));transformedNormal=m*transformedNormal;\n#endif\ntransformedNormal=normalMatrix*transformedNormal;\n#ifdef FLIP_SIDED\ntransformedNormal=-transformedNormal;\n#endif\n#ifdef USE_TANGENT\nvec3 transformedTangent=(modelViewMatrix*vec4(objectTangent,0.0)).xyz;\n#ifdef FLIP_SIDED\ntransformedTangent=-transformedTangent;\n#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\nuniform sampler2D displacementMap;uniform float displacementScale;uniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\ntransformed+=normalize(objectNormal)*(texture2D(displacementMap,vUv).x*displacementScale+displacementBias);\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\nvec4 emissiveColor=texture2D(emissiveMap,vUv);emissiveColor.rgb=emissiveMapTexelToLinear(emissiveColor).rgb;totalEmissiveRadiance*=emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\nuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor=linearToOutputTexel(gl_FragColor);",encodings_pars_fragment:"vec4 LinearToLinear(in vec4 value){return value;}vec4 GammaToLinear(in vec4 value,in float gammaFactor){return vec4(pow(value.rgb,vec3(gammaFactor)),value.a);}vec4 LinearToGamma(in vec4 value,in float gammaFactor){return vec4(pow(value.rgb,vec3(1.0/gammaFactor)),value.a);}vec4 sRGBToLinear(in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}vec4 LinearTosRGB(in vec4 value){return vec4(mix(pow(value.rgb,vec3(0.41666))*1.055-vec3(0.055),value.rgb*12.92,vec3(lessThanEqual(value.rgb,vec3(0.0031308)))),value.a);}vec4 RGBEToLinear(in vec4 value){return vec4(value.rgb*exp2(value.a*255.0-128.0),1.0);}vec4 LinearToRGBE(in vec4 value){float maxComponent=max(max(value.r,value.g),value.b);float fExp=clamp(ceil(log2(maxComponent)),-128.0,127.0);return vec4(value.rgb/exp2(fExp),(fExp+128.0)/255.0);}vec4 RGBMToLinear(in vec4 value,in float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 LinearToRGBM(in vec4 value,in float maxRange){float maxRGB=max(value.r,max(value.g,value.b));float M=clamp(maxRGB/maxRange,0.0,1.0);M=ceil(M*255.0)/255.0;return vec4(value.rgb/(M*maxRange),M);}vec4 RGBDToLinear(in vec4 value,in float maxRange){return vec4(value.rgb*((maxRange/255.0)/value.a),1.0);}vec4 LinearToRGBD(in vec4 value,in float maxRange){float maxRGB=max(value.r,max(value.g,value.b));float D=max(maxRange/maxRGB,1.0);D=clamp(floor(D)/255.0,0.0,1.0);return vec4(value.rgb*(D*(255.0/maxRange)),D);}const mat3 cLogLuvM=mat3(0.2209,0.3390,0.4184,0.1138,0.6780,0.7319,0.0102,0.1130,0.2969);vec4 LinearToLogLuv(in vec4 value){vec3 Xp_Y_XYZp=cLogLuvM*value.rgb;Xp_Y_XYZp=max(Xp_Y_XYZp,vec3(1e-6,1e-6,1e-6));vec4 vResult;vResult.xy=Xp_Y_XYZp.xy/Xp_Y_XYZp.z;float Le=2.0*log2(Xp_Y_XYZp.y)+127.0;vResult.w=fract(Le);vResult.z=(Le-(floor(vResult.w*255.0))/255.0)/255.0;return vResult;}const mat3 cLogLuvInverseM=mat3(6.0014,-2.7008,-1.7996,-1.3320,3.1029,-5.7721,0.3008,-1.0882,5.6268);vec4 LogLuvToLinear(in vec4 value){float Le=value.z*255.0+value.w;vec3 Xp_Y_XYZp;Xp_Y_XYZp.y=exp2((Le-127.0)/2.0);Xp_Y_XYZp.z=Xp_Y_XYZp.y/value.y;Xp_Y_XYZp.x=value.x*Xp_Y_XYZp.z;vec3 vRGB=cLogLuvInverseM*Xp_Y_XYZp.rgb;return vec4(max(vRGB,0.0),1.0);}",envmap_fragment:"#ifdef USE_ENVMAP\n#ifdef ENV_WORLDPOS\nvec3 cameraToFrag;if(isOrthographic){cameraToFrag=normalize(vec3(-viewMatrix[0][2],-viewMatrix[1][2],-viewMatrix[2][2]));}else{cameraToFrag=normalize(vWorldPosition-cameraPosition);}vec3 worldNormal=inverseTransformDirection(normal,viewMatrix);\n#ifdef ENVMAP_MODE_REFLECTION\nvec3 reflectVec=reflect(cameraToFrag,worldNormal);\n#else\nvec3 reflectVec=refract(cameraToFrag,worldNormal,refractionRatio);\n#endif\n#else\nvec3 reflectVec=vReflect;\n#endif\n#ifdef ENVMAP_TYPE_CUBE\nvec4 envColor=textureCube(envMap,vec3(flipEnvMap*reflectVec.x,reflectVec.yz));\n#elif defined(ENVMAP_TYPE_CUBE_UV)\nvec4 envColor=textureCubeUV(envMap,reflectVec,0.0);\n#elif defined(ENVMAP_TYPE_EQUIREC)\nreflectVec=normalize(reflectVec);vec2 sampleUV=equirectUv(reflectVec);vec4 envColor=texture2D(envMap,sampleUV);\n#else\nvec4 envColor=vec4(0.0);\n#endif\n#ifndef ENVMAP_TYPE_CUBE_UV\nenvColor=envMapTexelToLinear(envColor);\n#endif\n#ifdef ENVMAP_BLENDING_MULTIPLY\noutgoingLight=mix(outgoingLight,outgoingLight*envColor.xyz,specularStrength*reflectivity);\n#elif defined(ENVMAP_BLENDING_MIX)\noutgoingLight=mix(outgoingLight,envColor.xyz,specularStrength*reflectivity);\n#elif defined(ENVMAP_BLENDING_ADD)\noutgoingLight+=envColor.xyz*specularStrength*reflectivity;\n#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\nuniform float envMapIntensity;uniform float flipEnvMap;uniform int maxMipLevel;\n#ifdef ENVMAP_TYPE_CUBE\nuniform samplerCube envMap;\n#else\nuniform sampler2D envMap;\n#endif\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\nuniform float reflectivity;\n#if defined(USE_BUMPMAP)||defined(USE_NORMALMAP)||defined(PHONG)\n#define ENV_WORLDPOS\n#endif\n#ifdef ENV_WORLDPOS\nvarying vec3 vWorldPosition;uniform float refractionRatio;\n#else\nvarying vec3 vReflect;\n#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n#if defined(USE_BUMPMAP)||defined(USE_NORMALMAP)||defined(PHONG)\n#define ENV_WORLDPOS\n#endif\n#ifdef ENV_WORLDPOS\nvarying vec3 vWorldPosition;\n#else\nvarying vec3 vReflect;uniform float refractionRatio;\n#endif\n#endif",envmap_physical_pars_fragment:"#if defined(USE_ENVMAP)\n#ifdef ENVMAP_MODE_REFRACTION\nuniform float refractionRatio;\n#endif\nvec3 getLightProbeIndirectIrradiance(const in GeometricContext geometry,const in int maxMIPLevel){vec3 worldNormal=inverseTransformDirection(geometry.normal,viewMatrix);\n#ifdef ENVMAP_TYPE_CUBE\nvec3 queryVec=vec3(flipEnvMap*worldNormal.x,worldNormal.yz);\n#ifdef TEXTURE_LOD_EXT\nvec4 envMapColor=textureCubeLodEXT(envMap,queryVec,float(maxMIPLevel));\n#else\nvec4 envMapColor=textureCube(envMap,queryVec,float(maxMIPLevel));\n#endif\nenvMapColor.rgb=envMapTexelToLinear(envMapColor).rgb;\n#elif defined(ENVMAP_TYPE_CUBE_UV)\nvec4 envMapColor=textureCubeUV(envMap,worldNormal,1.0);\n#else\nvec4 envMapColor=vec4(0.0);\n#endif\nreturn PI*envMapColor.rgb*envMapIntensity;}float getSpecularMIPLevel(const in float roughness,const in int maxMIPLevel){float maxMIPLevelScalar=float(maxMIPLevel);float sigma=PI*roughness*roughness/(1.0+roughness);float desiredMIPLevel=maxMIPLevelScalar+log2(sigma);return clamp(desiredMIPLevel,0.0,maxMIPLevelScalar);}vec3 getLightProbeIndirectRadiance(const in vec3 viewDir,const in vec3 normal,const in float roughness,const in int maxMIPLevel){\n#ifdef ENVMAP_MODE_REFLECTION\nvec3 reflectVec=reflect(-viewDir,normal);reflectVec=normalize(mix(reflectVec,normal,roughness*roughness));\n#else\nvec3 reflectVec=refract(-viewDir,normal,refractionRatio);\n#endif\nreflectVec=inverseTransformDirection(reflectVec,viewMatrix);float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);\n#ifdef ENVMAP_TYPE_CUBE\nvec3 queryReflectVec=vec3(flipEnvMap*reflectVec.x,reflectVec.yz);\n#ifdef TEXTURE_LOD_EXT\nvec4 envMapColor=textureCubeLodEXT(envMap,queryReflectVec,specularMIPLevel);\n#else\nvec4 envMapColor=textureCube(envMap,queryReflectVec,specularMIPLevel);\n#endif\nenvMapColor.rgb=envMapTexelToLinear(envMapColor).rgb;\n#elif defined(ENVMAP_TYPE_CUBE_UV)\nvec4 envMapColor=textureCubeUV(envMap,reflectVec,roughness);\n#elif defined(ENVMAP_TYPE_EQUIREC)\nvec2 sampleUV=equirectUv(reflectVec);\n#ifdef TEXTURE_LOD_EXT\nvec4 envMapColor=texture2DLodEXT(envMap,sampleUV,specularMIPLevel);\n#else\nvec4 envMapColor=texture2D(envMap,sampleUV,specularMIPLevel);\n#endif\nenvMapColor.rgb=envMapTexelToLinear(envMapColor).rgb;\n#endif\nreturn envMapColor.rgb*envMapIntensity;}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n#ifdef ENV_WORLDPOS\nvWorldPosition=worldPosition.xyz;\n#else\nvec3 cameraToVertex;if(isOrthographic){cameraToVertex=normalize(vec3(-viewMatrix[0][2],-viewMatrix[1][2],-viewMatrix[2][2]));}else{cameraToVertex=normalize(worldPosition.xyz-cameraPosition);}vec3 worldNormal=inverseTransformDirection(transformedNormal,viewMatrix);\n#ifdef ENVMAP_MODE_REFLECTION\nvReflect=reflect(cameraToVertex,worldNormal);\n#else\nvReflect=refract(cameraToVertex,worldNormal,refractionRatio);\n#endif\n#endif\n#endif",fog_vertex:"#ifdef USE_FOG\nfogDepth=-mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\nvarying float fogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n#ifdef FOG_EXP2\nfloat fogFactor=1.0-exp(-fogDensity*fogDensity*fogDepth*fogDepth);\n#else\nfloat fogFactor=smoothstep(fogNear,fogFar,fogDepth);\n#endif\ngl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor,fogFactor);\n#endif",fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;varying float fogDepth;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;uniform float fogFar;\n#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\nuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance(vec3 normal,vec3 lightDirection){float dotNL=dot(normal,lightDirection);vec2 coord=vec2(dotNL*0.5+0.5,0.0);\n#ifdef USE_GRADIENTMAP\nreturn texture2D(gradientMap,coord).rgb;\n#else\nreturn(coord.x<0.7)?vec3(0.7):vec3(1.0);\n#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\nvec4 lightMapTexel=texture2D(lightMap,vUv2);reflectedLight.indirectDiffuse+=PI*lightMapTexelToLinear(lightMapTexel).rgb*lightMapIntensity;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nuniform sampler2D lightMap;uniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse=vec3(1.0);GeometricContext geometry;geometry.position=mvPosition.xyz;geometry.normal=normalize(transformedNormal);geometry.viewDir=(isOrthographic)?vec3(0,0,1):normalize(-mvPosition.xyz);GeometricContext backGeometry;backGeometry.position=geometry.position;backGeometry.normal=-geometry.normal;backGeometry.viewDir=geometry.viewDir;vLightFront=vec3(0.0);vIndirectFront=vec3(0.0);\n#ifdef DOUBLE_SIDED\nvLightBack=vec3(0.0);vIndirectBack=vec3(0.0);\n#endif\nIncidentLight directLight;float dotNL;vec3 directLightColor_Diffuse;vIndirectFront+=getAmbientLightIrradiance(ambientLightColor);vIndirectFront+=getLightProbeIrradiance(lightProbe,geometry);\n#ifdef DOUBLE_SIDED\nvIndirectBack+=getAmbientLightIrradiance(ambientLightColor);vIndirectBack+=getLightProbeIrradiance(lightProbe,backGeometry);\n#endif\n#if NUM_POINT_LIGHTS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHTS;i++){getPointDirectLightIrradiance(pointLights[i],geometry,directLight);dotNL=dot(geometry.normal,directLight.direction);directLightColor_Diffuse=PI*directLight.color;vLightFront+=saturate(dotNL)*directLightColor_Diffuse;\n#ifdef DOUBLE_SIDED\nvLightBack+=saturate(-dotNL)*directLightColor_Diffuse;\n#endif\n}\n#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHTS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHTS;i++){getSpotDirectLightIrradiance(spotLights[i],geometry,directLight);dotNL=dot(geometry.normal,directLight.direction);directLightColor_Diffuse=PI*directLight.color;vLightFront+=saturate(dotNL)*directLightColor_Diffuse;\n#ifdef DOUBLE_SIDED\nvLightBack+=saturate(-dotNL)*directLightColor_Diffuse;\n#endif\n}\n#pragma unroll_loop_end\n#endif\n#if NUM_DIR_LIGHTS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHTS;i++){getDirectionalDirectLightIrradiance(directionalLights[i],geometry,directLight);dotNL=dot(geometry.normal,directLight.direction);directLightColor_Diffuse=PI*directLight.color;vLightFront+=saturate(dotNL)*directLightColor_Diffuse;\n#ifdef DOUBLE_SIDED\nvLightBack+=saturate(-dotNL)*directLightColor_Diffuse;\n#endif\n}\n#pragma unroll_loop_end\n#endif\n#if NUM_HEMI_LIGHTS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_HEMI_LIGHTS;i++){vIndirectFront+=getHemisphereLightIrradiance(hemisphereLights[i],geometry);\n#ifdef DOUBLE_SIDED\nvIndirectBack+=getHemisphereLightIrradiance(hemisphereLights[i],backGeometry);\n#endif\n}\n#pragma unroll_loop_end\n#endif",lights_pars_begin:"uniform bool receiveShadow;uniform vec3 ambientLightColor;uniform vec3 lightProbe[9];vec3 shGetIrradianceAt(in vec3 normal,in vec3 shCoefficients[9]){float x=normal.x,y=normal.y,z=normal.z;vec3 result=shCoefficients[0]*0.886227;result+=shCoefficients[1]*2.0*0.511664*y;result+=shCoefficients[2]*2.0*0.511664*z;result+=shCoefficients[3]*2.0*0.511664*x;result+=shCoefficients[4]*2.0*0.429043*x*y;result+=shCoefficients[5]*2.0*0.429043*y*z;result+=shCoefficients[6]*(0.743125*z*z-0.247708);result+=shCoefficients[7]*2.0*0.429043*x*z;result+=shCoefficients[8]*0.429043*(x*x-y*y);return result;}vec3 getLightProbeIrradiance(const in vec3 lightProbe[9],const in GeometricContext geometry){vec3 worldNormal=inverseTransformDirection(geometry.normal,viewMatrix);vec3 irradiance=shGetIrradianceAt(worldNormal,lightProbe);return irradiance;}vec3 getAmbientLightIrradiance(const in vec3 ambientLightColor){vec3 irradiance=ambientLightColor;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\nreturn irradiance;}\n#if NUM_DIR_LIGHTS>0\nstruct DirectionalLight{vec3 direction;vec3 color;};uniform DirectionalLight directionalLights[NUM_DIR_LIGHTS];void getDirectionalDirectLightIrradiance(const in DirectionalLight directionalLight,const in GeometricContext geometry,out IncidentLight directLight){directLight.color=directionalLight.color;directLight.direction=directionalLight.direction;directLight.visible=true;}\n#endif\n#if NUM_POINT_LIGHTS>0\nstruct PointLight{vec3 position;vec3 color;float distance;float decay;};uniform PointLight pointLights[NUM_POINT_LIGHTS];void getPointDirectLightIrradiance(const in PointLight pointLight,const in GeometricContext geometry,out IncidentLight directLight){vec3 lVector=pointLight.position-geometry.position;directLight.direction=normalize(lVector);float lightDistance=length(lVector);directLight.color=pointLight.color;directLight.color*=punctualLightIntensityToIrradianceFactor(lightDistance,pointLight.distance,pointLight.decay);directLight.visible=(directLight.color!=vec3(0.0));}\n#endif\n#if NUM_SPOT_LIGHTS>0\nstruct SpotLight{vec3 position;vec3 direction;vec3 color;float distance;float decay;float coneCos;float penumbraCos;};uniform SpotLight spotLights[NUM_SPOT_LIGHTS];void getSpotDirectLightIrradiance(const in SpotLight spotLight,const in GeometricContext geometry,out IncidentLight directLight){vec3 lVector=spotLight.position-geometry.position;directLight.direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(directLight.direction,spotLight.direction);if(angleCos>spotLight.coneCos){float spotEffect=smoothstep(spotLight.coneCos,spotLight.penumbraCos,angleCos);directLight.color=spotLight.color;directLight.color*=spotEffect*punctualLightIntensityToIrradianceFactor(lightDistance,spotLight.distance,spotLight.decay);directLight.visible=true;}else{directLight.color=vec3(0.0);directLight.visible=false;}}\n#endif\n#if NUM_RECT_AREA_LIGHTS>0\nstruct RectAreaLight{vec3 color;vec3 position;vec3 halfWidth;vec3 halfHeight;};uniform sampler2D ltc_1;uniform sampler2D ltc_2;uniform RectAreaLight rectAreaLights[NUM_RECT_AREA_LIGHTS];\n#endif\n#if NUM_HEMI_LIGHTS>0\nstruct HemisphereLight{vec3 direction;vec3 skyColor;vec3 groundColor;};uniform HemisphereLight hemisphereLights[NUM_HEMI_LIGHTS];vec3 getHemisphereLightIrradiance(const in HemisphereLight hemiLight,const in GeometricContext geometry){float dotNL=dot(geometry.normal,hemiLight.direction);float hemiDiffuseWeight=0.5*dotNL+0.5;vec3 irradiance=mix(hemiLight.groundColor,hemiLight.skyColor,hemiDiffuseWeight);\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\nreturn irradiance;}\n#endif",lights_toon_fragment:"ToonMaterial material;material.diffuseColor=diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\nstruct ToonMaterial{vec3 diffuseColor;};void RE_Direct_Toon(const in IncidentLight directLight,const in GeometricContext geometry,const in ToonMaterial material,inout ReflectedLight reflectedLight){vec3 irradiance=getGradientIrradiance(geometry.normal,directLight.direction)*directLight.color;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\nreflectedLight.directDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}void RE_IndirectDiffuse_Toon(const in vec3 irradiance,const in GeometricContext geometry,const in ToonMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}\n#define RE_Direct RE_Direct_Toon\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Toon\n#define Material_LightProbeLOD(material)(0)",lights_phong_fragment:"BlinnPhongMaterial material;material.diffuseColor=diffuseColor.rgb;material.specularColor=specular;material.specularShininess=shininess;material.specularStrength=specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial{vec3 diffuseColor;vec3 specularColor;float specularShininess;float specularStrength;};void RE_Direct_BlinnPhong(const in IncidentLight directLight,const in GeometricContext geometry,const in BlinnPhongMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,directLight.direction));vec3 irradiance=dotNL*directLight.color;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\nreflectedLight.directDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);reflectedLight.directSpecular+=irradiance*BRDF_Specular_BlinnPhong(directLight,geometry,material.specularColor,material.specularShininess)*material.specularStrength;}void RE_IndirectDiffuse_BlinnPhong(const in vec3 irradiance,const in GeometricContext geometry,const in BlinnPhongMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}\n#define RE_Direct RE_Direct_BlinnPhong\n#define RE_IndirectDiffuse RE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD(material)(0)",lights_physical_fragment:"PhysicalMaterial material;material.diffuseColor=diffuseColor.rgb*(1.0-metalnessFactor);vec3 dxy=max(abs(dFdx(geometryNormal)),abs(dFdy(geometryNormal)));float geometryRoughness=max(max(dxy.x,dxy.y),dxy.z);material.specularRoughness=max(roughnessFactor,0.0525);material.specularRoughness+=geometryRoughness;material.specularRoughness=min(material.specularRoughness,1.0);\n#ifdef REFLECTIVITY\nmaterial.specularColor=mix(vec3(MAXIMUM_SPECULAR_COEFFICIENT*pow2(reflectivity)),diffuseColor.rgb,metalnessFactor);\n#else\nmaterial.specularColor=mix(vec3(DEFAULT_SPECULAR_COEFFICIENT),diffuseColor.rgb,metalnessFactor);\n#endif\n#ifdef CLEARCOAT\nmaterial.clearcoat=clearcoat;material.clearcoatRoughness=clearcoatRoughness;\n#ifdef USE_CLEARCOATMAP\nmaterial.clearcoat*=texture2D(clearcoatMap,vUv).x;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nmaterial.clearcoatRoughness*=texture2D(clearcoatRoughnessMap,vUv).y;\n#endif\nmaterial.clearcoat=saturate(material.clearcoat);material.clearcoatRoughness=max(material.clearcoatRoughness,0.0525);material.clearcoatRoughness+=geometryRoughness;material.clearcoatRoughness=min(material.clearcoatRoughness,1.0);\n#endif\n#ifdef USE_SHEEN\nmaterial.sheenColor=sheen;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial{vec3 diffuseColor;float specularRoughness;vec3 specularColor;\n#ifdef CLEARCOAT\nfloat clearcoat;float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\nvec3 sheenColor;\n#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearcoatDHRApprox(const in float roughness,const in float dotNL){return DEFAULT_SPECULAR_COEFFICIENT+(1.0-DEFAULT_SPECULAR_COEFFICIENT)*(pow(1.0-dotNL,5.0)*pow(1.0-roughness,2.0));}\n#if NUM_RECT_AREA_LIGHTS>0\nvoid RE_Direct_RectArea_Physical(const in RectAreaLight rectAreaLight,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 normal=geometry.normal;vec3 viewDir=geometry.viewDir;vec3 position=geometry.position;vec3 lightPos=rectAreaLight.position;vec3 halfWidth=rectAreaLight.halfWidth;vec3 halfHeight=rectAreaLight.halfHeight;vec3 lightColor=rectAreaLight.color;float roughness=material.specularRoughness;vec3 rectCoords[4];rectCoords[0]=lightPos+halfWidth-halfHeight;rectCoords[1]=lightPos-halfWidth-halfHeight;rectCoords[2]=lightPos-halfWidth+halfHeight;rectCoords[3]=lightPos+halfWidth+halfHeight;vec2 uv=LTC_Uv(normal,viewDir,roughness);vec4 t1=texture2D(ltc_1,uv);vec4 t2=texture2D(ltc_2,uv);mat3 mInv=mat3(vec3(t1.x,0,t1.y),vec3(0,1,0),vec3(t1.z,0,t1.w));vec3 fresnel=(material.specularColor*t2.x+(vec3(1.0)-material.specularColor)*t2.y);reflectedLight.directSpecular+=lightColor*fresnel*LTC_Evaluate(normal,viewDir,position,mInv,rectCoords);reflectedLight.directDiffuse+=lightColor*material.diffuseColor*LTC_Evaluate(normal,viewDir,position,mat3(1.0),rectCoords);}\n#endif\nvoid RE_Direct_Physical(const in IncidentLight directLight,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,directLight.direction));vec3 irradiance=dotNL*directLight.color;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\n#ifdef CLEARCOAT\nfloat ccDotNL=saturate(dot(geometry.clearcoatNormal,directLight.direction));vec3 ccIrradiance=ccDotNL*directLight.color;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nccIrradiance*=PI;\n#endif\nfloat clearcoatDHR=material.clearcoat*clearcoatDHRApprox(material.clearcoatRoughness,ccDotNL);reflectedLight.directSpecular+=ccIrradiance*material.clearcoat*BRDF_Specular_GGX(directLight,geometry.viewDir,geometry.clearcoatNormal,vec3(DEFAULT_SPECULAR_COEFFICIENT),material.clearcoatRoughness);\n#else\nfloat clearcoatDHR=0.0;\n#endif\n#ifdef USE_SHEEN\nreflectedLight.directSpecular+=(1.0-clearcoatDHR)*irradiance*BRDF_Specular_Sheen(material.specularRoughness,directLight.direction,geometry,material.sheenColor);\n#else\nreflectedLight.directSpecular+=(1.0-clearcoatDHR)*irradiance*BRDF_Specular_GGX(directLight,geometry.viewDir,geometry.normal,material.specularColor,material.specularRoughness);\n#endif\nreflectedLight.directDiffuse+=(1.0-clearcoatDHR)*irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}void RE_IndirectDiffuse_Physical(const in vec3 irradiance,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}void RE_IndirectSpecular_Physical(const in vec3 radiance,const in vec3 irradiance,const in vec3 clearcoatRadiance,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){\n#ifdef CLEARCOAT\nfloat ccDotNV=saturate(dot(geometry.clearcoatNormal,geometry.viewDir));reflectedLight.indirectSpecular+=clearcoatRadiance*material.clearcoat*BRDF_Specular_GGX_Environment(geometry.viewDir,geometry.clearcoatNormal,vec3(DEFAULT_SPECULAR_COEFFICIENT),material.clearcoatRoughness);float ccDotNL=ccDotNV;float clearcoatDHR=material.clearcoat*clearcoatDHRApprox(material.clearcoatRoughness,ccDotNL);\n#else\nfloat clearcoatDHR=0.0;\n#endif\nfloat clearcoatInv=1.0-clearcoatDHR;vec3 singleScattering=vec3(0.0);vec3 multiScattering=vec3(0.0);vec3 cosineWeightedIrradiance=irradiance*RECIPROCAL_PI;BRDF_Specular_Multiscattering_Environment(geometry,material.specularColor,material.specularRoughness,singleScattering,multiScattering);vec3 diffuse=material.diffuseColor*(1.0-(singleScattering+multiScattering));reflectedLight.indirectSpecular+=clearcoatInv*radiance*singleScattering;reflectedLight.indirectSpecular+=multiScattering*cosineWeightedIrradiance;reflectedLight.indirectDiffuse+=diffuse*cosineWeightedIrradiance;}\n#define RE_Direct RE_Direct_Physical\n#define RE_Direct_RectArea RE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular RE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion(const in float dotNV,const in float ambientOcclusion,const in float roughness){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}",lights_fragment_begin:"GeometricContext geometry;geometry.position=-vViewPosition;geometry.normal=normal;geometry.viewDir=(isOrthographic)?vec3(0,0,1):normalize(vViewPosition);\n#ifdef CLEARCOAT\ngeometry.clearcoatNormal=clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if (NUM_POINT_LIGHTS>0)&&defined(RE_Direct)\nPointLight pointLight;\n#if defined(USE_SHADOWMAP)&&NUM_POINT_LIGHT_SHADOWS>0\nPointLightShadow pointLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHTS;i++){pointLight=pointLights[i];getPointDirectLightIrradiance(pointLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_POINT_LIGHT_SHADOWS)\npointLightShadow=pointLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getPointShadow(pointShadowMap[i],pointLightShadow.shadowMapSize,pointLightShadow.shadowBias,pointLightShadow.shadowRadius,vPointShadowCoord[i],pointLightShadow.shadowCameraNear,pointLightShadow.shadowCameraFar):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_SPOT_LIGHTS>0)&&defined(RE_Direct)\nSpotLight spotLight;\n#if defined(USE_SHADOWMAP)&&NUM_SPOT_LIGHT_SHADOWS>0\nSpotLightShadow spotLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHTS;i++){spotLight=spotLights[i];getSpotDirectLightIrradiance(spotLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_SPOT_LIGHT_SHADOWS)\nspotLightShadow=spotLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getShadow(spotShadowMap[i],spotLightShadow.shadowMapSize,spotLightShadow.shadowBias,spotLightShadow.shadowRadius,vSpotShadowCoord[i]):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_DIR_LIGHTS>0)&&defined(RE_Direct)\nDirectionalLight directionalLight;\n#if defined(USE_SHADOWMAP)&&NUM_DIR_LIGHT_SHADOWS>0\nDirectionalLightShadow directionalLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHTS;i++){directionalLight=directionalLights[i];getDirectionalDirectLightIrradiance(directionalLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_DIR_LIGHT_SHADOWS)\ndirectionalLightShadow=directionalLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getShadow(directionalShadowMap[i],directionalLightShadow.shadowMapSize,directionalLightShadow.shadowBias,directionalLightShadow.shadowRadius,vDirectionalShadowCoord[i]):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_RECT_AREA_LIGHTS>0)&&defined(RE_Direct_RectArea)\nRectAreaLight rectAreaLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_RECT_AREA_LIGHTS;i++){rectAreaLight=rectAreaLights[i];RE_Direct_RectArea(rectAreaLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if defined(RE_IndirectDiffuse)\nvec3 iblIrradiance=vec3(0.0);vec3 irradiance=getAmbientLightIrradiance(ambientLightColor);irradiance+=getLightProbeIrradiance(lightProbe,geometry);\n#if (NUM_HEMI_LIGHTS>0)\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_HEMI_LIGHTS;i++){irradiance+=getHemisphereLightIrradiance(hemisphereLights[i],geometry);}\n#pragma unroll_loop_end\n#endif\n#endif\n#if defined(RE_IndirectSpecular)\nvec3 radiance=vec3(0.0);vec3 clearcoatRadiance=vec3(0.0);\n#endif",lights_fragment_maps:"#if defined(RE_IndirectDiffuse)\n#ifdef USE_LIGHTMAP\nvec4 lightMapTexel=texture2D(lightMap,vUv2);vec3 lightMapIrradiance=lightMapTexelToLinear(lightMapTexel).rgb*lightMapIntensity;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nlightMapIrradiance*=PI;\n#endif\nirradiance+=lightMapIrradiance;\n#endif\n#if defined(USE_ENVMAP)&&defined(STANDARD)&&defined(ENVMAP_TYPE_CUBE_UV)\niblIrradiance+=getLightProbeIndirectIrradiance(geometry,maxMipLevel);\n#endif\n#endif\n#if defined(USE_ENVMAP)&&defined(RE_IndirectSpecular)\nradiance+=getLightProbeIndirectRadiance(geometry.viewDir,geometry.normal,material.specularRoughness,maxMipLevel);\n#ifdef CLEARCOAT\nclearcoatRadiance+=getLightProbeIndirectRadiance(geometry.viewDir,geometry.clearcoatNormal,material.clearcoatRoughness,maxMipLevel);\n#endif\n#endif",lights_fragment_end:"#if defined(RE_IndirectDiffuse)\nRE_IndirectDiffuse(irradiance,geometry,material,reflectedLight);\n#endif\n#if defined(RE_IndirectSpecular)\nRE_IndirectSpecular(radiance,iblIrradiance,clearcoatRadiance,geometry,material,reflectedLight);\n#endif",logdepthbuf_fragment:"#if defined(USE_LOGDEPTHBUF)&&defined(USE_LOGDEPTHBUF_EXT)\ngl_FragDepthEXT=vIsPerspective==0.0?gl_FragCoord.z:log2(vFragDepth)*logDepthBufFC*0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined(USE_LOGDEPTHBUF)&&defined(USE_LOGDEPTHBUF_EXT)\nuniform float logDepthBufFC;varying float vFragDepth;varying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n#ifdef USE_LOGDEPTHBUF_EXT\nvarying float vFragDepth;varying float vIsPerspective;\n#else\nuniform float logDepthBufFC;\n#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n#ifdef USE_LOGDEPTHBUF_EXT\nvFragDepth=1.0+gl_Position.w;vIsPerspective=float(isPerspectiveMatrix(projectionMatrix));\n#else\nif(isPerspectiveMatrix(projectionMatrix)){gl_Position.z=log2(max(EPSILON,gl_Position.w+1.0))*logDepthBufFC-1.0;gl_Position.z*=gl_Position.w;}\n#endif\n#endif",map_fragment:"#ifdef USE_MAP\nvec4 texelColor=texture2D(map,vUv);texelColor=mapTexelToLinear(texelColor);diffuseColor*=texelColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined(USE_MAP)||defined(USE_ALPHAMAP)\nvec2 uv=(uvTransform*vec3(gl_PointCoord.x,1.0-gl_PointCoord.y,1)).xy;\n#endif\n#ifdef USE_MAP\nvec4 mapTexel=texture2D(map,uv);diffuseColor*=mapTexelToLinear(mapTexel);\n#endif\n#ifdef USE_ALPHAMAP\ndiffuseColor.a*=texture2D(alphaMap,uv).g;\n#endif",map_particle_pars_fragment:"#if defined(USE_MAP)||defined(USE_ALPHAMAP)\nuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\nuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor=metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness=texture2D(metalnessMap,vUv);metalnessFactor*=texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\nuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\nobjectNormal*=morphTargetBaseInfluence;objectNormal+=morphNormal0*morphTargetInfluences[0];objectNormal+=morphNormal1*morphTargetInfluences[1];objectNormal+=morphNormal2*morphTargetInfluences[2];objectNormal+=morphNormal3*morphTargetInfluences[3];\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\nuniform float morphTargetBaseInfluence;\n#ifndef USE_MORPHNORMALS\nuniform float morphTargetInfluences[8];\n#else\nuniform float morphTargetInfluences[4];\n#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\ntransformed*=morphTargetBaseInfluence;transformed+=morphTarget0*morphTargetInfluences[0];transformed+=morphTarget1*morphTargetInfluences[1];transformed+=morphTarget2*morphTargetInfluences[2];transformed+=morphTarget3*morphTargetInfluences[3];\n#ifndef USE_MORPHNORMALS\ntransformed+=morphTarget4*morphTargetInfluences[4];transformed+=morphTarget5*morphTargetInfluences[5];transformed+=morphTarget6*morphTargetInfluences[6];transformed+=morphTarget7*morphTargetInfluences[7];\n#endif\n#endif",normal_fragment_begin:"#ifdef FLAT_SHADED\nvec3 fdx=vec3(dFdx(vViewPosition.x),dFdx(vViewPosition.y),dFdx(vViewPosition.z));vec3 fdy=vec3(dFdy(vViewPosition.x),dFdy(vViewPosition.y),dFdy(vViewPosition.z));vec3 normal=normalize(cross(fdx,fdy));\n#else\nvec3 normal=normalize(vNormal);\n#ifdef DOUBLE_SIDED\nnormal=normal*(float(gl_FrontFacing)*2.0-1.0);\n#endif\n#ifdef USE_TANGENT\nvec3 tangent=normalize(vTangent);vec3 bitangent=normalize(vBitangent);\n#ifdef DOUBLE_SIDED\ntangent=tangent*(float(gl_FrontFacing)*2.0-1.0);bitangent=bitangent*(float(gl_FrontFacing)*2.0-1.0);\n#endif\n#if defined(TANGENTSPACE_NORMALMAP)||defined(USE_CLEARCOAT_NORMALMAP)\nmat3 vTBN=mat3(tangent,bitangent,normal);\n#endif\n#endif\n#endif\nvec3 geometryNormal=normal;",normal_fragment_maps:"#ifdef OBJECTSPACE_NORMALMAP\nnormal=texture2D(normalMap,vUv).xyz*2.0-1.0;\n#ifdef FLIP_SIDED\nnormal=-normal;\n#endif\n#ifdef DOUBLE_SIDED\nnormal=normal*(float(gl_FrontFacing)*2.0-1.0);\n#endif\nnormal=normalize(normalMatrix*normal);\n#elif defined(TANGENTSPACE_NORMALMAP)\nvec3 mapN=texture2D(normalMap,vUv).xyz*2.0-1.0;mapN.xy*=normalScale;\n#ifdef USE_TANGENT\nnormal=normalize(vTBN*mapN);\n#else\nnormal=perturbNormal2Arb(-vViewPosition,normal,mapN);\n#endif\n#elif defined(USE_BUMPMAP)\nnormal=perturbNormalArb(-vViewPosition,normal,dHdxy_fwd());\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\nuniform sampler2D normalMap;uniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat3 normalMatrix;\n#endif\n#if !defined(USE_TANGENT)&&(defined(TANGENTSPACE_NORMALMAP)||defined(USE_CLEARCOAT_NORMALMAP))\nvec3 perturbNormal2Arb(vec3 eye_pos,vec3 surf_norm,vec3 mapN){vec3 q0=vec3(dFdx(eye_pos.x),dFdx(eye_pos.y),dFdx(eye_pos.z));vec3 q1=vec3(dFdy(eye_pos.x),dFdy(eye_pos.y),dFdy(eye_pos.z));vec2 st0=dFdx(vUv.st);vec2 st1=dFdy(vUv.st);float scale=sign(st1.t*st0.s-st0.t*st1.s);vec3 S=normalize((q0*st1.t-q1*st0.t)*scale);vec3 T=normalize((-q0*st1.s+q1*st0.s)*scale);vec3 N=normalize(surf_norm);mat3 tsn=mat3(S,T,N);mapN.xy*=(float(gl_FrontFacing)*2.0-1.0);return normalize(tsn*mapN);}\n#endif",clearcoat_normal_fragment_begin:"#ifdef CLEARCOAT\nvec3 clearcoatNormal=geometryNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\nvec3 clearcoatMapN=texture2D(clearcoatNormalMap,vUv).xyz*2.0-1.0;clearcoatMapN.xy*=clearcoatNormalScale;\n#ifdef USE_TANGENT\nclearcoatNormal=normalize(vTBN*clearcoatMapN);\n#else\nclearcoatNormal=perturbNormal2Arb(-vViewPosition,clearcoatNormal,clearcoatMapN);\n#endif\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\nuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\nuniform sampler2D clearcoatNormalMap;uniform vec2 clearcoatNormalScale;\n#endif",packing:"vec3 packNormalToRGB(const in vec3 normal){return normalize(normal)*0.5+0.5;}vec3 unpackRGBToNormal(const in vec3 rgb){return 2.0*rgb.xyz-1.0;}const float PackUpscale=256./255.;const float UnpackDownscale=255./256.;const vec3 PackFactors=vec3(256.*256.*256.,256.*256.,256.);const vec4 UnpackFactors=UnpackDownscale/vec4(PackFactors,1.);const float ShiftRight8=1./256.;vec4 packDepthToRGBA(const in float v){vec4 r=vec4(fract(v*PackFactors),v);r.yzw-=r.xyz*ShiftRight8;return r*PackUpscale;}float unpackRGBAToDepth(const in vec4 v){return dot(v,UnpackFactors);}vec4 pack2HalfToRGBA(vec2 v){vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}vec2 unpackRGBATo2Half(vec4 v){return vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));}float viewZToOrthographicDepth(const in float viewZ,const in float near,const in float far){return(viewZ+near)/(near-far);}float orthographicDepthToViewZ(const in float linearClipZ,const in float near,const in float far){return linearClipZ*(near-far)-near;}float viewZToPerspectiveDepth(const in float viewZ,const in float near,const in float far){return((near+viewZ)*far)/((far-near)*viewZ);}float perspectiveDepthToViewZ(const in float invClipZ,const in float near,const in float far){return(near*far)/((far-near)*invClipZ-far);}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\ngl_FragColor.rgb*=gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition=vec4(transformed,1.0);\n#ifdef USE_INSTANCING\nmvPosition=instanceMatrix*mvPosition;\n#endif\nmvPosition=modelViewMatrix*mvPosition;gl_Position=projectionMatrix*mvPosition;",dithering_fragment:"#ifdef DITHERING\ngl_FragColor.rgb=dithering(gl_FragColor.rgb);\n#endif",dithering_pars_fragment:"#ifdef DITHERING\nvec3 dithering(vec3 color){float grid_position=rand(gl_FragCoord.xy);vec3 dither_shift_RGB=vec3(0.25/255.0,-0.25/255.0,0.25/255.0);dither_shift_RGB=mix(2.0*dither_shift_RGB,-2.0*dither_shift_RGB,grid_position);return color+dither_shift_RGB;}\n#endif",roughnessmap_fragment:"float roughnessFactor=roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness=texture2D(roughnessMap,vUv);roughnessFactor*=texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\nuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nuniform sampler2D directionalShadowMap[NUM_DIR_LIGHT_SHADOWS];varying vec4 vDirectionalShadowCoord[NUM_DIR_LIGHT_SHADOWS];struct DirectionalLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform DirectionalLightShadow directionalLightShadows[NUM_DIR_LIGHT_SHADOWS];\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nuniform sampler2D spotShadowMap[NUM_SPOT_LIGHT_SHADOWS];varying vec4 vSpotShadowCoord[NUM_SPOT_LIGHT_SHADOWS];struct SpotLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform SpotLightShadow spotLightShadows[NUM_SPOT_LIGHT_SHADOWS];\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nuniform sampler2D pointShadowMap[NUM_POINT_LIGHT_SHADOWS];varying vec4 vPointShadowCoord[NUM_POINT_LIGHT_SHADOWS];struct PointLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;float shadowCameraNear;float shadowCameraFar;};uniform PointLightShadow pointLightShadows[NUM_POINT_LIGHT_SHADOWS];\n#endif\nfloat texture2DCompare(sampler2D depths,vec2 uv,float compare){return step(compare,unpackRGBAToDepth(texture2D(depths,uv)));}vec2 texture2DDistribution(sampler2D shadow,vec2 uv){return unpackRGBATo2Half(texture2D(shadow,uv));}float VSMShadow(sampler2D shadow,vec2 uv,float compare){float occlusion=1.0;vec2 distribution=texture2DDistribution(shadow,uv);float hard_shadow=step(compare,distribution.x);if(hard_shadow!=1.0){float distance=compare-distribution.x;float variance=max(0.00000,distribution.y*distribution.y);float softness_probability=variance/(variance+distance*distance);softness_probability=clamp((softness_probability-0.3)/(0.95-0.3),0.0,1.0);occlusion=clamp(max(hard_shadow,softness_probability),0.0,1.0);}return occlusion;}float getShadow(sampler2D shadowMap,vec2 shadowMapSize,float shadowBias,float shadowRadius,vec4 shadowCoord){float shadow=1.0;shadowCoord.xyz/=shadowCoord.w;shadowCoord.z+=shadowBias;bvec4 inFrustumVec=bvec4(shadowCoord.x>=0.0,shadowCoord.x<=1.0,shadowCoord.y>=0.0,shadowCoord.y<=1.0);bool inFrustum=all(inFrustumVec);bvec2 frustumTestVec=bvec2(inFrustum,shadowCoord.z<=1.0);bool frustumTest=all(frustumTestVec);if(frustumTest){\n#if defined(SHADOWMAP_TYPE_PCF)\nvec2 texelSize=vec2(1.0)/shadowMapSize;float dx0=-texelSize.x*shadowRadius;float dy0=-texelSize.y*shadowRadius;float dx1=+texelSize.x*shadowRadius;float dy1=+texelSize.y*shadowRadius;float dx2=dx0/2.0;float dy2=dy0/2.0;float dx3=dx1/2.0;float dy3=dy1/2.0;shadow=(texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,dy1),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy1),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,dy1),shadowCoord.z))*(1.0/17.0);\n#elif defined(SHADOWMAP_TYPE_PCF_SOFT)\nvec2 texelSize=vec2(1.0)/shadowMapSize;float dx=texelSize.x;float dy=texelSize.y;vec2 uv=shadowCoord.xy;vec2 f=fract(uv*shadowMapSize+0.5);uv-=f*texelSize;shadow=(texture2DCompare(shadowMap,uv,shadowCoord.z)+texture2DCompare(shadowMap,uv+vec2(dx,0.0),shadowCoord.z)+texture2DCompare(shadowMap,uv+vec2(0.0,dy),shadowCoord.z)+texture2DCompare(shadowMap,uv+texelSize,shadowCoord.z)+mix(texture2DCompare(shadowMap,uv+vec2(-dx,0.0),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,0.0),shadowCoord.z),f.x)+mix(texture2DCompare(shadowMap,uv+vec2(-dx,dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,dy),shadowCoord.z),f.x)+mix(texture2DCompare(shadowMap,uv+vec2(0.0,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(0.0,2.0*dy),shadowCoord.z),f.y)+mix(texture2DCompare(shadowMap,uv+vec2(dx,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(dx,2.0*dy),shadowCoord.z),f.y)+mix(mix(texture2DCompare(shadowMap,uv+vec2(-dx,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,-dy),shadowCoord.z),f.x),mix(texture2DCompare(shadowMap,uv+vec2(-dx,2.0*dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,2.0*dy),shadowCoord.z),f.x),f.y))*(1.0/9.0);\n#elif defined(SHADOWMAP_TYPE_VSM)\nshadow=VSMShadow(shadowMap,shadowCoord.xy,shadowCoord.z);\n#else\nshadow=texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z);\n#endif\n}return shadow;}vec2 cubeToUV(vec3 v,float texelSizeY){vec3 absV=abs(v);float scaleToCube=1.0/max(absV.x,max(absV.y,absV.z));absV*=scaleToCube;v*=scaleToCube*(1.0-2.0*texelSizeY);vec2 planar=v.xy;float almostATexel=1.5*texelSizeY;float almostOne=1.0-almostATexel;if(absV.z>=almostOne){if(v.z>0.0)planar.x=4.0-v.x;}else if(absV.x>=almostOne){float signX=sign(v.x);planar.x=v.z*signX+2.0*signX;}else if(absV.y>=almostOne){float signY=sign(v.y);planar.x=v.x+2.0*signY+2.0;planar.y=v.z*signY-2.0;}return vec2(0.125,0.25)*planar+vec2(0.375,0.75);}float getPointShadow(sampler2D shadowMap,vec2 shadowMapSize,float shadowBias,float shadowRadius,vec4 shadowCoord,float shadowCameraNear,float shadowCameraFar){vec2 texelSize=vec2(1.0)/(shadowMapSize*vec2(4.0,2.0));vec3 lightToPosition=shadowCoord.xyz;float dp=(length(lightToPosition)-shadowCameraNear)/(shadowCameraFar-shadowCameraNear);dp+=shadowBias;vec3 bd3D=normalize(lightToPosition);\n#if defined(SHADOWMAP_TYPE_PCF)||defined(SHADOWMAP_TYPE_PCF_SOFT)||defined(SHADOWMAP_TYPE_VSM)\nvec2 offset=vec2(-1,1)*shadowRadius*texelSize.y;return(texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xyy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yyy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xyx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yyx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xxy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yxy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xxx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yxx,texelSize.y),dp))*(1.0/9.0);\n#else\nreturn texture2DCompare(shadowMap,cubeToUV(bd3D,texelSize.y),dp);\n#endif\n}\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nuniform mat4 directionalShadowMatrix[NUM_DIR_LIGHT_SHADOWS];varying vec4 vDirectionalShadowCoord[NUM_DIR_LIGHT_SHADOWS];struct DirectionalLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform DirectionalLightShadow directionalLightShadows[NUM_DIR_LIGHT_SHADOWS];\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nuniform mat4 spotShadowMatrix[NUM_SPOT_LIGHT_SHADOWS];varying vec4 vSpotShadowCoord[NUM_SPOT_LIGHT_SHADOWS];struct SpotLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform SpotLightShadow spotLightShadows[NUM_SPOT_LIGHT_SHADOWS];\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nuniform mat4 pointShadowMatrix[NUM_POINT_LIGHT_SHADOWS];varying vec4 vPointShadowCoord[NUM_POINT_LIGHT_SHADOWS];struct PointLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;float shadowCameraNear;float shadowCameraFar;};uniform PointLightShadow pointLightShadows[NUM_POINT_LIGHT_SHADOWS];\n#endif\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0||NUM_SPOT_LIGHT_SHADOWS>0||NUM_POINT_LIGHT_SHADOWS>0\nvec3 shadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 shadowWorldPosition;\n#endif\n#if NUM_DIR_LIGHT_SHADOWS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*directionalLightShadows[i].shadowNormalBias,0);vDirectionalShadowCoord[i]=directionalShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*spotLightShadows[i].shadowNormalBias,0);vSpotShadowCoord[i]=spotShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*pointLightShadows[i].shadowNormalBias,0);vPointShadowCoord[i]=pointShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#endif",shadowmask_pars_fragment:"float getShadowMask(){float shadow=1.0;\n#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nDirectionalLightShadow directionalLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHT_SHADOWS;i++){directionalLight=directionalLightShadows[i];shadow*=receiveShadow?getShadow(directionalShadowMap[i],directionalLight.shadowMapSize,directionalLight.shadowBias,directionalLight.shadowRadius,vDirectionalShadowCoord[i]):1.0;}\n#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nSpotLightShadow spotLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHT_SHADOWS;i++){spotLight=spotLightShadows[i];shadow*=receiveShadow?getShadow(spotShadowMap[i],spotLight.shadowMapSize,spotLight.shadowBias,spotLight.shadowRadius,vSpotShadowCoord[i]):1.0;}\n#pragma unroll_loop_end\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nPointLightShadow pointLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHT_SHADOWS;i++){pointLight=pointLightShadows[i];shadow*=receiveShadow?getPointShadow(pointShadowMap[i],pointLight.shadowMapSize,pointLight.shadowBias,pointLight.shadowRadius,vPointShadowCoord[i],pointLight.shadowCameraNear,pointLight.shadowCameraFar):1.0;}\n#pragma unroll_loop_end\n#endif\n#endif\nreturn shadow;}",skinbase_vertex:"#ifdef USE_SKINNING\nmat4 boneMatX=getBoneMatrix(skinIndex.x);mat4 boneMatY=getBoneMatrix(skinIndex.y);mat4 boneMatZ=getBoneMatrix(skinIndex.z);mat4 boneMatW=getBoneMatrix(skinIndex.w);\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\nuniform mat4 bindMatrix;uniform mat4 bindMatrixInverse;\n#ifdef BONE_TEXTURE\nuniform highp sampler2D boneTexture;uniform int boneTextureSize;mat4 getBoneMatrix(const in float i){float j=i*4.0;float x=mod(j,float(boneTextureSize));float y=floor(j/float(boneTextureSize));float dx=1.0/float(boneTextureSize);float dy=1.0/float(boneTextureSize);y=dy*(y+0.5);vec4 v1=texture2D(boneTexture,vec2(dx*(x+0.5),y));vec4 v2=texture2D(boneTexture,vec2(dx*(x+1.5),y));vec4 v3=texture2D(boneTexture,vec2(dx*(x+2.5),y));vec4 v4=texture2D(boneTexture,vec2(dx*(x+3.5),y));mat4 bone=mat4(v1,v2,v3,v4);return bone;}\n#else\nuniform mat4 boneMatrices[MAX_BONES];mat4 getBoneMatrix(const in float i){mat4 bone=boneMatrices[int(i)];return bone;}\n#endif\n#endif",skinning_vertex:"#ifdef USE_SKINNING\nvec4 skinVertex=bindMatrix*vec4(transformed,1.0);vec4 skinned=vec4(0.0);skinned+=boneMatX*skinVertex*skinWeight.x;skinned+=boneMatY*skinVertex*skinWeight.y;skinned+=boneMatZ*skinVertex*skinWeight.z;skinned+=boneMatW*skinVertex*skinWeight.w;transformed=(bindMatrixInverse*skinned).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\nmat4 skinMatrix=mat4(0.0);skinMatrix+=skinWeight.x*boneMatX;skinMatrix+=skinWeight.y*boneMatY;skinMatrix+=skinWeight.z*boneMatZ;skinMatrix+=skinWeight.w*boneMatW;skinMatrix=bindMatrixInverse*skinMatrix*bindMatrix;objectNormal=vec4(skinMatrix*vec4(objectNormal,0.0)).xyz;\n#ifdef USE_TANGENT\nobjectTangent=vec4(skinMatrix*vec4(objectTangent,0.0)).xyz;\n#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\nvec4 texelSpecular=texture2D(specularMap,vUv);specularStrength=texelSpecular.r;\n#else\nspecularStrength=1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\nuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined(TONE_MAPPING)\ngl_FragColor.rgb=toneMapping(gl_FragColor.rgb);\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate(a)clamp(a,0.0,1.0)\n#endif\nuniform float toneMappingExposure;vec3 LinearToneMapping(vec3 color){return toneMappingExposure*color;}vec3 ReinhardToneMapping(vec3 color){color*=toneMappingExposure;return saturate(color/(vec3(1.0)+color));}vec3 OptimizedCineonToneMapping(vec3 color){color*=toneMappingExposure;color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 RRTAndODTFit(vec3 v){vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}vec3 ACESFilmicToneMapping(vec3 color){const mat3 ACESInputMat=mat3(vec3(0.59719,0.07600,0.02840),vec3(0.35458,0.90834,0.13383),vec3(0.04823,0.01566,0.83777));const mat3 ACESOutputMat=mat3(vec3(1.60475,-0.10208,-0.00327),vec3(-0.53108,1.10813,-0.07276),vec3(-0.07367,-0.00605,1.07602));color*=toneMappingExposure/0.6;color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;return saturate(color);}vec3 CustomToneMapping(vec3 color){return color;}",uv_pars_fragment:"#if (defined(USE_UV)&&!defined(UVS_VERTEX_ONLY))\nvarying vec2 vUv;\n#endif",uv_pars_vertex:"#ifdef USE_UV\n#ifdef UVS_VERTEX_ONLY\nvec2 vUv;\n#else\nvarying vec2 vUv;\n#endif\nuniform mat3 uvTransform;\n#endif",uv_vertex:"#ifdef USE_UV\nvUv=(uvTransform*vec3(uv,1)).xy;\n#endif",uv2_pars_fragment:"#if defined(USE_LIGHTMAP)||defined(USE_AOMAP)\nvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined(USE_LIGHTMAP)||defined(USE_AOMAP)\nattribute vec2 uv2;varying vec2 vUv2;uniform mat3 uv2Transform;\n#endif",uv2_vertex:"#if defined(USE_LIGHTMAP)||defined(USE_AOMAP)\nvUv2=(uv2Transform*vec3(uv2,1)).xy;\n#endif",worldpos_vertex:"#if defined(USE_ENVMAP)||defined(DISTANCE)||defined(USE_SHADOWMAP)\nvec4 worldPosition=vec4(transformed,1.0);\n#ifdef USE_INSTANCING\nworldPosition=instanceMatrix*worldPosition;\n#endif\nworldPosition=modelMatrix*worldPosition;\n#endif",background_frag:"uniform sampler2D t2D;varying vec2 vUv;void main(){vec4 texColor=texture2D(t2D,vUv);gl_FragColor=mapTexelToLinear(texColor);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n}",background_vert:"varying vec2 vUv;uniform mat3 uvTransform;void main(){vUv=(uvTransform*vec3(uv,1)).xy;gl_Position=vec4(position.xy,1.0,1.0);}",cube_frag:"#include <envmap_common_pars_fragment>\nuniform float opacity;varying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main(){vec3 vReflect=vWorldDirection;\n#include <envmap_fragment>\ngl_FragColor=envColor;gl_FragColor.a*=opacity;\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\ngl_Position.z=gl_Position.w;}",depth_frag:"#if DEPTH_PACKING==3200\nuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;void main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(1.0);\n#if DEPTH_PACKING==3200\ndiffuseColor.a=opacity;\n#endif\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <logdepthbuf_fragment>\nfloat fragCoordZ=0.5*vHighPrecisionZW[0]/vHighPrecisionZW[1]+0.5;\n#if DEPTH_PACKING==3200\ngl_FragColor=vec4(vec3(1.0-fragCoordZ),opacity);\n#elif DEPTH_PACKING==3201\ngl_FragColor=packDepthToRGBA(fragCoordZ);\n#endif\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;void main(){\n#include <uv_vertex>\n#include <skinbase_vertex>\n#ifdef USE_DISPLACEMENTMAP\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvHighPrecisionZW=gl_Position.zw;}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;uniform float nearDistance;uniform float farDistance;varying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(1.0);\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\nfloat dist=length(vWorldPosition-referencePosition);dist=(dist-nearDistance)/(farDistance-nearDistance);dist=saturate(dist);gl_FragColor=packDepthToRGBA(dist);}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <skinbase_vertex>\n#ifdef USE_DISPLACEMENTMAP\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <worldpos_vertex>\n#include <clipping_planes_vertex>\nvWorldPosition=worldPosition.xyz;}",equirect_frag:"uniform sampler2D tEquirect;varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vec3 direction=normalize(vWorldDirection);vec2 sampleUV=equirectUv(direction);vec4 texColor=texture2D(tEquirect,sampleUV);gl_FragColor=mapTexelToLinear(texColor);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;uniform float opacity;uniform float dashSize;uniform float totalSize;varying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nif(mod(vLineDistance,totalSize)>dashSize){discard;}vec3 outgoingLight=vec3(0.0);vec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <color_fragment>\noutgoingLight=diffuseColor.rgb;gl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n}",linedashed_vert:"uniform float scale;attribute float lineDistance;varying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){vLineDistance=scale*lineDistance;\n#include <color_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;uniform float opacity;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <specularmap_fragment>\nReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));\n#ifdef USE_LIGHTMAP\nvec4 lightMapTexel=texture2D(lightMap,vUv2);reflectedLight.indirectDiffuse+=lightMapTexelToLinear(lightMapTexel).rgb*lightMapIntensity;\n#else\nreflectedLight.indirectDiffuse+=vec3(1.0);\n#endif\n#include <aomap_fragment>\nreflectedLight.indirectDiffuse*=diffuseColor.rgb;vec3 outgoingLight=reflectedLight.indirectDiffuse;\n#include <envmap_fragment>\ngl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <skinbase_vertex>\n#ifdef USE_ENVMAP\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <worldpos_vertex>\n#include <clipping_planes_vertex>\n#include <envmap_vertex>\n#include <fog_vertex>\n}",meshlambert_frag:"uniform vec3 diffuse;uniform vec3 emissive;uniform float opacity;varying vec3 vLightFront;varying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;varying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <specularmap_fragment>\n#include <emissivemap_fragment>\n#ifdef DOUBLE_SIDED\nreflectedLight.indirectDiffuse+=(gl_FrontFacing)?vIndirectFront:vIndirectBack;\n#else\nreflectedLight.indirectDiffuse+=vIndirectFront;\n#endif\n#include <lightmap_fragment>\nreflectedLight.indirectDiffuse*=BRDF_Diffuse_Lambert(diffuseColor.rgb);\n#ifdef DOUBLE_SIDED\nreflectedLight.directDiffuse=(gl_FrontFacing)?vLightFront:vLightBack;\n#else\nreflectedLight.directDiffuse=vLightFront;\n#endif\nreflectedLight.directDiffuse*=BRDF_Diffuse_Lambert(diffuseColor.rgb)*getShadowMask();\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+totalEmissiveRadiance;\n#include <envmap_fragment>\ngl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;varying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;varying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <lights_lambert_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;uniform float opacity;uniform sampler2D matcap;varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\nvec3 viewDir=normalize(vViewPosition);vec3 x=normalize(vec3(viewDir.z,0.0,-viewDir.x));vec3 y=cross(viewDir,x);vec2 uv=vec2(dot(x,normal),dot(y,normal))*0.495+0.5;\n#ifdef USE_MATCAP\nvec4 matcapColor=texture2D(matcap,uv);matcapColor=matcapTexelToLinear(matcapColor);\n#else\nvec4 matcapColor=vec4(1.0);\n#endif\nvec3 outgoingLight=diffuseColor.rgb*matcapColor.rgb;gl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\nvNormal=normalize(transformedNormal);\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\nvViewPosition=-mvPosition.xyz;}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;uniform vec3 emissive;uniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_toon_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+totalEmissiveRadiance;gl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\nvNormal=normalize(transformedNormal);\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;uniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <specularmap_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;\n#include <envmap_fragment>\ngl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\nvNormal=normalize(transformedNormal);\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n#define REFLECTIVITY\n#define CLEARCOAT\n#define TRANSPARENCY\n#endif\nuniform vec3 diffuse;uniform vec3 emissive;uniform float roughness;uniform float metalness;uniform float opacity;\n#ifdef TRANSPARENCY\nuniform float transparency;\n#endif\n#ifdef REFLECTIVITY\nuniform float reflectivity;\n#endif\n#ifdef CLEARCOAT\nuniform float clearcoat;uniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\nuniform vec3 sheen;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;varying vec3 vBitangent;\n#endif\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <roughnessmap_fragment>\n#include <metalnessmap_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <clearcoat_normal_fragment_begin>\n#include <clearcoat_normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_physical_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;\n#ifdef TRANSPARENCY\ndiffuseColor.a*=saturate(1.-transparency+linearToRelativeLuminance(reflectedLight.directSpecular+reflectedLight.indirectSpecular));\n#endif\ngl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;varying vec3 vBitangent;\n#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\nvNormal=normalize(transformedNormal);\n#ifdef USE_TANGENT\nvTangent=normalize(transformedTangent);vBitangent=normalize(cross(vNormal,vTangent)*tangent.w);\n#endif\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(TANGENTSPACE_NORMALMAP)\nvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;varying vec3 vBitangent;\n#endif\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\n#include <logdepthbuf_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\ngl_FragColor=vec4(packNormalToRGB(normal),opacity);}",normal_vert:"#define NORMAL\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(TANGENTSPACE_NORMALMAP)\nvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;varying vec3 vBitangent;\n#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\nvNormal=normalize(transformedNormal);\n#ifdef USE_TANGENT\nvTangent=normalize(transformedTangent);vBitangent=normalize(cross(vNormal,vTangent)*tangent.w);\n#endif\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(TANGENTSPACE_NORMALMAP)\nvViewPosition=-mvPosition.xyz;\n#endif\n}",points_frag:"uniform vec3 diffuse;uniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec3 outgoingLight=vec3(0.0);vec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <map_particle_fragment>\n#include <color_fragment>\n#include <alphatest_fragment>\noutgoingLight=diffuseColor.rgb;gl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n}",points_vert:"uniform float size;uniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <color_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <project_vertex>\ngl_PointSize=size;\n#ifdef USE_SIZEATTENUATION\nbool isPerspective=isPerspectiveMatrix(projectionMatrix);if(isPerspective)gl_PointSize*=(scale/-mvPosition.z);\n#endif\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <worldpos_vertex>\n#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;uniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main(){gl_FragColor=vec4(color,opacity*(1.0-getShadowMask()));\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main(){\n#include <begin_vertex>\n#include <project_vertex>\n#include <worldpos_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;uniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec3 outgoingLight=vec3(0.0);vec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\noutgoingLight=diffuseColor.rgb;gl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;uniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\nvec4 mvPosition=modelViewMatrix*vec4(0.0,0.0,0.0,1.0);vec2 scale;scale.x=length(vec3(modelMatrix[0].x,modelMatrix[0].y,modelMatrix[0].z));scale.y=length(vec3(modelMatrix[1].x,modelMatrix[1].y,modelMatrix[1].z));\n#ifndef USE_SIZEATTENUATION\nbool isPerspective=isPerspectiveMatrix(projectionMatrix);if(isPerspective)scale*=-mvPosition.z;\n#endif\nvec2 alignedPosition=(position.xy-(center-vec2(0.5)))*scale;vec2 rotatedPosition;rotatedPosition.x=cos(rotation)*alignedPosition.x-sin(rotation)*alignedPosition.y;rotatedPosition.y=sin(rotation)*alignedPosition.x+cos(rotation)*alignedPosition.y;mvPosition.xy+=rotatedPosition;gl_Position=projectionMatrix*mvPosition;\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\n}"},kr={basic:{uniforms:vr([Tr.common,Tr.specularmap,Tr.envmap,Tr.aomap,Tr.lightmap,Tr.fog]),vertexShader:Rr.meshbasic_vert,fragmentShader:Rr.meshbasic_frag},lambert:{uniforms:vr([Tr.common,Tr.specularmap,Tr.envmap,Tr.aomap,Tr.lightmap,Tr.emissivemap,Tr.fog,Tr.lights,{emissive:{value:new mn(0)}}]),vertexShader:Rr.meshlambert_vert,fragmentShader:Rr.meshlambert_frag},phong:{uniforms:vr([Tr.common,Tr.specularmap,Tr.envmap,Tr.aomap,Tr.lightmap,Tr.emissivemap,Tr.bumpmap,Tr.normalmap,Tr.displacementmap,Tr.fog,Tr.lights,{emissive:{value:new mn(0)},specular:{value:new mn(1118481)},shininess:{value:30}}]),vertexShader:Rr.meshphong_vert,fragmentShader:Rr.meshphong_frag},standard:{uniforms:vr([Tr.common,Tr.envmap,Tr.aomap,Tr.lightmap,Tr.emissivemap,Tr.bumpmap,Tr.normalmap,Tr.displacementmap,Tr.roughnessmap,Tr.metalnessmap,Tr.fog,Tr.lights,{emissive:{value:new mn(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Rr.meshphysical_vert,fragmentShader:Rr.meshphysical_frag},toon:{uniforms:vr([Tr.common,Tr.aomap,Tr.lightmap,Tr.emissivemap,Tr.bumpmap,Tr.normalmap,Tr.displacementmap,Tr.gradientmap,Tr.fog,Tr.lights,{emissive:{value:new mn(0)}}]),vertexShader:Rr.meshtoon_vert,fragmentShader:Rr.meshtoon_frag},matcap:{uniforms:vr([Tr.common,Tr.bumpmap,Tr.normalmap,Tr.displacementmap,Tr.fog,{matcap:{value:null}}]),vertexShader:Rr.meshmatcap_vert,fragmentShader:Rr.meshmatcap_frag},points:{uniforms:vr([Tr.points,Tr.fog]),vertexShader:Rr.points_vert,fragmentShader:Rr.points_frag},dashed:{uniforms:vr([Tr.common,Tr.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Rr.linedashed_vert,fragmentShader:Rr.linedashed_frag},depth:{uniforms:vr([Tr.common,Tr.displacementmap]),vertexShader:Rr.depth_vert,fragmentShader:Rr.depth_frag},normal:{uniforms:vr([Tr.common,Tr.bumpmap,Tr.normalmap,Tr.displacementmap,{opacity:{value:1}}]),vertexShader:Rr.normal_vert,fragmentShader:Rr.normal_frag},sprite:{uniforms:vr([Tr.sprite,Tr.fog]),vertexShader:Rr.sprite_vert,fragmentShader:Rr.sprite_frag},background:{uniforms:{uvTransform:{value:new Ut},t2D:{value:null}},vertexShader:Rr.background_vert,fragmentShader:Rr.background_frag},cube:{uniforms:vr([Tr.envmap,{opacity:{value:1}}]),vertexShader:Rr.cube_vert,fragmentShader:Rr.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Rr.equirect_vert,fragmentShader:Rr.equirect_frag},distanceRGBA:{uniforms:vr([Tr.common,Tr.displacementmap,{referencePosition:{value:new Zt},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Rr.distanceRGBA_vert,fragmentShader:Rr.distanceRGBA_frag},shadow:{uniforms:vr([Tr.lights,Tr.fog,{color:{value:new mn(0)},opacity:{value:1}}]),vertexShader:Rr.shadow_vert,fragmentShader:Rr.shadow_frag}};function Or(e,t,i,n){const r=new mn(0);let s,o,l=0,h=null,u=0,d=null;function f(e,i){t.buffers.color.setClear(e.r,e.g,e.b,i,n)}return{getClearColor:function(){return r},setClearColor:function(e,t){r.set(e),l=void 0!==t?t:1,f(r,l)},getClearAlpha:function(){return l},setClearAlpha:function(e){l=e,f(r,l)},render:function(t,n,m,p){let g=!0===n.isScene?n.background:null;const v=e.xr,y=v.getSession&&v.getSession();if(y&&"additive"===y.environmentBlendMode&&(g=null),null===g?f(r,l):g&&g.isColor&&(f(g,1),p=!0),(e.autoClear||p)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),g&&(g.isCubeTexture||g.isWebGLCubeRenderTarget||g.mapping===J)){void 0===o&&(o=new ar(new pr(1,1,1),new _r({name:"BackgroundCubeMaterial",uniforms:gr(kr.cube.uniforms),vertexShader:kr.cube.vertexShader,fragmentShader:kr.cube.fragmentShader,side:c,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),o.geometry.deleteAttribute("uv"),o.onBeforeRender=function(e,t,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(o.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),i.update(o));const n=g.isWebGLCubeRenderTarget?g.texture:g;o.material.uniforms.envMap.value=n,o.material.uniforms.flipEnvMap.value=n.isCubeTexture?-1:1,h===g&&u===n.version&&d===e.toneMapping||(o.material.needsUpdate=!0,h=g,u=n.version,d=e.toneMapping),t.unshift(o,o.geometry,o.material,0,0,null)}else g&&g.isTexture&&(void 0===s&&(s=new ar(new Lr(2,2),new _r({name:"BackgroundMaterial",uniforms:gr(kr.background.uniforms),vertexShader:kr.background.vertexShader,fragmentShader:kr.background.fragmentShader,side:a,depthTest:!1,depthWrite:!1,fog:!1})),s.geometry.deleteAttribute("normal"),Object.defineProperty(s.material,"map",{get:function(){return this.uniforms.t2D.value}}),i.update(s)),s.material.uniforms.t2D.value=g,!0===g.matrixAutoUpdate&&g.updateMatrix(),s.material.uniforms.uvTransform.value.copy(g.matrix),h===g&&u===g.version&&d===e.toneMapping||(s.material.needsUpdate=!0,h=g,u=g.version,d=e.toneMapping),t.unshift(s,s.geometry,s.material,0,0,null))}}}function Br(e,t,i,n){const r=e.getParameter(34921),s=n.isWebGL2?null:t.get("OES_vertex_array_object"),o=n.isWebGL2||null!==s,a={},c=d(null);let l=c;function h(t){return n.isWebGL2?e.bindVertexArray(t):s.bindVertexArrayOES(t)}function u(t){return n.isWebGL2?e.deleteVertexArray(t):s.deleteVertexArrayOES(t)}function d(e){const t=[],i=[],n=[];for(let e=0;e<r;e++)t[e]=0,i[e]=0,n[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:i,attributeDivisors:n,object:e,attributes:{}}}function f(){const e=l.newAttributes;for(let t=0,i=e.length;t<i;t++)e[t]=0}function m(e){p(e,0)}function p(i,r){const s=l.newAttributes,o=l.enabledAttributes,a=l.attributeDivisors;if(s[i]=1,0===o[i]&&(e.enableVertexAttribArray(i),o[i]=1),a[i]!==r){(n.isWebGL2?e:t.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,r),a[i]=r}}function g(){const t=l.newAttributes,i=l.enabledAttributes;for(let n=0,r=i.length;n<r;n++)i[n]!==t[n]&&(e.disableVertexAttribArray(n),i[n]=0)}function v(t,i,r,s,o,a){!0!==n.isWebGL2||5124!==r&&5125!==r?e.vertexAttribPointer(t,i,r,s,o,a):e.vertexAttribIPointer(t,i,r,s,o,a)}function y(){x(),l!==c&&(l=c,h(l.object))}function x(){c.geometry=null,c.program=null,c.wireframe=!1}return{setup:function(r,c,u,y,x){let b=!1;if(o){const t=function(t,i,r){const o=!0===r.wireframe;let c=a[t.id];void 0===c&&(c={},a[t.id]=c);let l=c[i.id];void 0===l&&(l={},c[i.id]=l);let h=l[o];void 0===h&&(h=d(n.isWebGL2?e.createVertexArray():s.createVertexArrayOES()),l[o]=h);return h}(y,u,c);l!==t&&(l=t,h(l.object)),b=function(e){const t=l.attributes,i=e.attributes;if(Object.keys(t).length!==Object.keys(i).length)return!0;for(const e in i){const n=t[e],r=i[e];if(n.attribute!==r)return!0;if(n.data!==r.data)return!0}return!1}(y),b&&function(e){const t={},i=e.attributes;for(const e in i){const n=i[e],r={};r.attribute=n,n.data&&(r.data=n.data),t[e]=r}l.attributes=t}(y)}else{const e=!0===c.wireframe;l.geometry===y.id&&l.program===u.id&&l.wireframe===e||(l.geometry=y.id,l.program=u.id,l.wireframe=e,b=!0)}!0===r.isInstancedMesh&&(b=!0),null!==x&&i.update(x,34963),b&&(!function(r,s,o,a){if(!1===n.isWebGL2&&(r.isInstancedMesh||a.isInstancedBufferGeometry)&&null===t.get("ANGLE_instanced_arrays"))return;f();const c=a.attributes,l=o.getAttributes(),h=s.defaultAttributeValues;for(const t in l){const n=l[t];if(n>=0){const s=c[t];if(void 0!==s){const t=s.normalized,r=s.itemSize,o=i.get(s);if(void 0===o)continue;const c=o.buffer,l=o.type,h=o.bytesPerElement;if(s.isInterleavedBufferAttribute){const i=s.data,o=i.stride,u=s.offset;i&&i.isInstancedInterleavedBuffer?(p(n,i.meshPerAttribute),void 0===a._maxInstanceCount&&(a._maxInstanceCount=i.meshPerAttribute*i.count)):m(n),e.bindBuffer(34962,c),v(n,r,l,t,o*h,u*h)}else s.isInstancedBufferAttribute?(p(n,s.meshPerAttribute),void 0===a._maxInstanceCount&&(a._maxInstanceCount=s.meshPerAttribute*s.count)):m(n),e.bindBuffer(34962,c),v(n,r,l,t,0,0)}else if("instanceMatrix"===t){const t=i.get(r.instanceMatrix);if(void 0===t)continue;const s=t.buffer,o=t.type;p(n+0,1),p(n+1,1),p(n+2,1),p(n+3,1),e.bindBuffer(34962,s),e.vertexAttribPointer(n+0,4,o,!1,64,0),e.vertexAttribPointer(n+1,4,o,!1,64,16),e.vertexAttribPointer(n+2,4,o,!1,64,32),e.vertexAttribPointer(n+3,4,o,!1,64,48)}else if(void 0!==h){const i=h[t];if(void 0!==i)switch(i.length){case 2:e.vertexAttrib2fv(n,i);break;case 3:e.vertexAttrib3fv(n,i);break;case 4:e.vertexAttrib4fv(n,i);break;default:e.vertexAttrib1fv(n,i)}}}}g()}(r,c,u,y),null!==x&&e.bindBuffer(34963,i.get(x).buffer))},reset:y,resetDefaultState:x,dispose:function(){y();for(const e in a){const t=a[e];for(const e in t){const i=t[e];for(const e in i)u(i[e].object),delete i[e];delete t[e]}delete a[e]}},releaseStatesOfGeometry:function(e){if(void 0===a[e.id])return;const t=a[e.id];for(const e in t){const i=t[e];for(const e in i)u(i[e].object),delete i[e];delete t[e]}delete a[e.id]},releaseStatesOfProgram:function(e){for(const t in a){const i=a[t];if(void 0===i[e.id])continue;const n=i[e.id];for(const e in n)u(n[e].object),delete n[e];delete i[e.id]}},initAttributes:f,enableAttribute:m,disableUnusedAttributes:g}}function Nr(e,t,i,n){const r=n.isWebGL2;let s;this.setMode=function(e){s=e},this.render=function(t,n){e.drawArrays(s,t,n),i.update(n,s)},this.renderInstances=function(n,o,a,c){if(0===c)return;let l,h;if(r)l=e,h="drawArraysInstanced";else if(l=t.get("ANGLE_instanced_arrays"),h="drawArraysInstancedANGLE",null===l)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[h](s,o,a,c),i.update(a,s,c)}}function Fr(e,t,i){let n;function r(t){if("highp"===t){if(e.getShaderPrecisionFormat(35633,36338).precision>0&&e.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(35633,36337).precision>0&&e.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const s="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&e instanceof WebGL2ComputeRenderingContext;let o=void 0!==i.precision?i.precision:"highp";const a=r(o);a!==o&&(console.warn("THREE.WebGLRenderer:",o,"not supported, using",a,"instead."),o=a);const c=!0===i.logarithmicDepthBuffer,l=e.getParameter(34930),h=e.getParameter(35660),u=e.getParameter(3379),d=e.getParameter(34076),f=e.getParameter(34921),m=e.getParameter(36347),p=e.getParameter(36348),g=e.getParameter(36349),v=h>0,y=s||!!t.get("OES_texture_float");return{isWebGL2:s,getMaxAnisotropy:function(){if(void 0!==n)return n;const i=t.get("EXT_texture_filter_anisotropic");return n=null!==i?e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,n},getMaxPrecision:r,precision:o,logarithmicDepthBuffer:c,maxTextures:l,maxVertexTextures:h,maxTextureSize:u,maxCubemapSize:d,maxAttributes:f,maxVertexUniforms:m,maxVaryings:p,maxFragmentUniforms:g,vertexTextures:v,floatFragmentTextures:y,floatVertexTextures:v&&y,maxSamples:s?e.getParameter(36183):0}}function zr(){const e=this;let t=null,i=0,n=!1,r=!1;const s=new Qi,o=new Ut,a={value:null,needsUpdate:!1};function c(){a.value!==t&&(a.value=t,a.needsUpdate=i>0),e.numPlanes=i,e.numIntersection=0}function l(t,i,n,r){let c=null!==t?t.length:0,l=null;if(0!==c){if(l=a.value,!0!==r||null===l){const e=n+4*c,r=i.matrixWorldInverse;o.getNormalMatrix(r),(null===l||l.length<e)&&(l=new Float32Array(e));for(let e=0,i=n;e!==c;++e,i+=4)s.copy(t[e]).applyMatrix4(r,o),s.normal.toArray(l,i),l[i+3]=s.constant}a.value=l,a.needsUpdate=!0}return e.numPlanes=c,e.numIntersection=0,l}this.uniform=a,this.numPlanes=0,this.numIntersection=0,this.init=function(e,r,s){const o=0!==e.length||r||0!==i||n;return n=r,t=l(e,s,0),i=e.length,o},this.beginShadows=function(){r=!0,l(null)},this.endShadows=function(){r=!1,c()},this.setState=function(e,s,o,h,u,d){if(!n||null===e||0===e.length||r&&!o)r?l(null):c();else{const n=r?0:i,o=4*n;let c=u.clippingState||null;a.value=c,c=l(e,h,o,d);for(let e=0;e!==o;++e)c[e]=t[e];u.clippingState=c,this.numIntersection=s?this.numPlanes:0,this.numPlanes+=n}}}function Ur(e){const t={};return{get:function(i){if(void 0!==t[i])return t[i];let n;switch(i){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=e.getExtension(i)}return null===n&&console.warn("THREE.WebGLRenderer: "+i+" extension not supported."),t[i]=n,n}}}function $r(e,t,i,n){const r=new WeakMap,s=new WeakMap;function o(e){const a=e.target,c=r.get(a);null!==c.index&&t.remove(c.index);for(const e in c.attributes)t.remove(c.attributes[e]);a.removeEventListener("dispose",o),r.delete(a);const l=s.get(c);l&&(t.remove(l),s.delete(c)),n.releaseStatesOfGeometry(a),!0===a.isInstancedBufferGeometry&&delete a._maxInstanceCount,i.memory.geometries--}function a(e){const i=[],n=e.index,r=e.attributes.position;let o=0;if(null!==n){const e=n.array;o=n.version;for(let t=0,n=e.length;t<n;t+=3){const n=e[t+0],r=e[t+1],s=e[t+2];i.push(n,r,r,s,s,n)}}else{const e=r.array;o=r.version;for(let t=0,n=e.length/3-1;t<n;t+=3){const e=t+0,n=t+1,r=t+2;i.push(e,n,n,r,r,e)}}const a=new(On(i)>65535?Dn:In)(i,1);a.version=o;const c=s.get(e);c&&t.remove(c),s.set(e,a)}return{get:function(e,t){let n=r.get(t);return n||(t.addEventListener("dispose",o),t.isBufferGeometry?n=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new Vn).setFromObject(e)),n=t._bufferGeometry),r.set(t,n),i.memory.geometries++,n)},update:function(e){const i=e.attributes;for(const e in i)t.update(i[e],34962);const n=e.morphAttributes;for(const e in n){const i=n[e];for(let e=0,n=i.length;e<n;e++)t.update(i[e],34962)}},getWireframeAttribute:function(e){const t=s.get(e);if(t){const i=e.index;null!==i&&t.version<i.version&&a(e)}else a(e);return s.get(e)}}}function Gr(e,t,i,n){const r=n.isWebGL2;let s,o,a;this.setMode=function(e){s=e},this.setIndex=function(e){o=e.type,a=e.bytesPerElement},this.render=function(t,n){e.drawElements(s,n,o,t*a),i.update(n,s)},this.renderInstances=function(n,c,l,h){if(0===h)return;let u,d;if(r)u=e,d="drawElementsInstanced";else if(u=t.get("ANGLE_instanced_arrays"),d="drawElementsInstancedANGLE",null===u)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");u[d](s,l,o,c*a,h),i.update(l,s,h)}}function Vr(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.frame++,t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(e,i,n){switch(n=n||1,t.calls++,i){case 4:t.triangles+=n*(e/3);break;case 1:t.lines+=n*(e/2);break;case 3:t.lines+=n*(e-1);break;case 2:t.lines+=n*e;break;case 0:t.points+=n*e;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}function Hr(e,t){return e[0]-t[0]}function jr(e,t){return Math.abs(t[1])-Math.abs(e[1])}function Wr(e){const t={},i=new Float32Array(8),n=[];for(let e=0;e<8;e++)n[e]=[e,0];return{update:function(r,s,o,a){const c=r.morphTargetInfluences,l=void 0===c?0:c.length;let h=t[s.id];if(void 0===h){h=[];for(let e=0;e<l;e++)h[e]=[e,0];t[s.id]=h}for(let e=0;e<l;e++){const t=h[e];t[0]=e,t[1]=c[e]}h.sort(jr);for(let e=0;e<8;e++)e<l&&h[e][1]?(n[e][0]=h[e][0],n[e][1]=h[e][1]):(n[e][0]=Number.MAX_SAFE_INTEGER,n[e][1]=0);n.sort(Hr);const u=o.morphTargets&&s.morphAttributes.position,d=o.morphNormals&&s.morphAttributes.normal;let f=0;for(let e=0;e<8;e++){const t=n[e],r=t[0],o=t[1];r!==Number.MAX_SAFE_INTEGER&&o?(u&&s.getAttribute("morphTarget"+e)!==u[r]&&s.setAttribute("morphTarget"+e,u[r]),d&&s.getAttribute("morphNormal"+e)!==d[r]&&s.setAttribute("morphNormal"+e,d[r]),i[e]=o,f+=o):(u&&void 0!==s.getAttribute("morphTarget"+e)&&s.deleteAttribute("morphTarget"+e),d&&void 0!==s.getAttribute("morphNormal"+e)&&s.deleteAttribute("morphNormal"+e),i[e]=0)}const m=s.morphTargetsRelative?1:1-f;a.getUniforms().setValue(e,"morphTargetBaseInfluence",m),a.getUniforms().setValue(e,"morphTargetInfluences",i)}}}function qr(e,t,i,n){let r=new WeakMap;return{update:function(e){const s=n.render.frame,o=e.geometry,a=t.get(e,o);return r.get(a)!==s&&(o.isGeometry&&a.updateFromObject(e),t.update(a),r.set(a,s)),e.isInstancedMesh&&i.update(e.instanceMatrix,34962),a},dispose:function(){r=new WeakMap}}}function Xr(e,t,i,n,r,s,o,a,c,l){e=void 0!==e?e:[],t=void 0!==t?t:Y,o=void 0!==o?o:Se,Ht.call(this,e,t,i,n,r,s,o,a,c,l),this.flipY=!1}function Yr(e,t,i,n){Ht.call(this,null),this.image={data:e||null,width:t||1,height:i||1,depth:n||1},this.magFilter=re,this.minFilter=re,this.wrapR=ie,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}function Zr(e,t,i,n){Ht.call(this,null),this.image={data:e||null,width:t||1,height:i||1,depth:n||1},this.magFilter=re,this.minFilter=re,this.wrapR=ie,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}kr.physical={uniforms:vr([kr.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new zt(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new mn(0)},transparency:{value:0}}]),vertexShader:Rr.meshphysical_vert,fragmentShader:Rr.meshphysical_frag},Xr.prototype=Object.create(Ht.prototype),Xr.prototype.constructor=Xr,Xr.prototype.isCubeTexture=!0,Object.defineProperty(Xr.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}}),Yr.prototype=Object.create(Ht.prototype),Yr.prototype.constructor=Yr,Yr.prototype.isDataTexture2DArray=!0,Zr.prototype=Object.create(Ht.prototype),Zr.prototype.constructor=Zr,Zr.prototype.isDataTexture3D=!0;const Kr=new Ht,Qr=new Yr,Jr=new Zr,es=new Xr,ts=[],is=[],ns=new Float32Array(16),rs=new Float32Array(9),ss=new Float32Array(4);function os(e,t,i){const n=e[0];if(n<=0||n>0)return e;let r=t*i,s=ts[r];if(void 0===s&&(s=new Float32Array(r),ts[r]=s),0!==t){n.toArray(s,0);for(let n=1,r=0;n!==t;++n)r+=i,e[n].toArray(s,r)}return s}function as(e,t){if(e.length!==t.length)return!1;for(let i=0,n=e.length;i<n;i++)if(e[i]!==t[i])return!1;return!0}function cs(e,t){for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}function ls(e,t){let i=is[t];void 0===i&&(i=new Int32Array(t),is[t]=i);for(let n=0;n!==t;++n)i[n]=e.allocateTextureUnit();return i}function hs(e,t){const i=this.cache;i[0]!==t&&(e.uniform1f(this.addr,t),i[0]=t)}function us(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(as(i,t))return;e.uniform2fv(this.addr,t),cs(i,t)}}function ds(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else if(void 0!==t.r)i[0]===t.r&&i[1]===t.g&&i[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),i[0]=t.r,i[1]=t.g,i[2]=t.b);else{if(as(i,t))return;e.uniform3fv(this.addr,t),cs(i,t)}}function fs(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(as(i,t))return;e.uniform4fv(this.addr,t),cs(i,t)}}function ms(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(as(i,t))return;e.uniformMatrix2fv(this.addr,!1,t),cs(i,t)}else{if(as(i,n))return;ss.set(n),e.uniformMatrix2fv(this.addr,!1,ss),cs(i,n)}}function ps(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(as(i,t))return;e.uniformMatrix3fv(this.addr,!1,t),cs(i,t)}else{if(as(i,n))return;rs.set(n),e.uniformMatrix3fv(this.addr,!1,rs),cs(i,n)}}function gs(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(as(i,t))return;e.uniformMatrix4fv(this.addr,!1,t),cs(i,t)}else{if(as(i,n))return;ns.set(n),e.uniformMatrix4fv(this.addr,!1,ns),cs(i,n)}}function vs(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.safeSetTexture2D(t||Kr,r)}function ys(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(t||Qr,r)}function xs(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(t||Jr,r)}function bs(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.safeSetTextureCube(t||es,r)}function _s(e,t){const i=this.cache;i[0]!==t&&(e.uniform1i(this.addr,t),i[0]=t)}function ws(e,t){const i=this.cache;as(i,t)||(e.uniform2iv(this.addr,t),cs(i,t))}function Ss(e,t){const i=this.cache;as(i,t)||(e.uniform3iv(this.addr,t),cs(i,t))}function As(e,t){const i=this.cache;as(i,t)||(e.uniform4iv(this.addr,t),cs(i,t))}function Ms(e,t){const i=this.cache;i[0]!==t&&(e.uniform1ui(this.addr,t),i[0]=t)}function Cs(e,t){e.uniform1fv(this.addr,t)}function Ps(e,t){e.uniform1iv(this.addr,t)}function Ts(e,t){e.uniform2iv(this.addr,t)}function Is(e,t){e.uniform3iv(this.addr,t)}function Es(e,t){e.uniform4iv(this.addr,t)}function Ds(e,t){const i=os(t,this.size,2);e.uniform2fv(this.addr,i)}function Ls(e,t){const i=os(t,this.size,3);e.uniform3fv(this.addr,i)}function Rs(e,t){const i=os(t,this.size,4);e.uniform4fv(this.addr,i)}function ks(e,t){const i=os(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,i)}function Os(e,t){const i=os(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,i)}function Bs(e,t){const i=os(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,i)}function Ns(e,t,i){const n=t.length,r=ls(i,n);e.uniform1iv(this.addr,r);for(let e=0;e!==n;++e)i.safeSetTexture2D(t[e]||Kr,r[e])}function Fs(e,t,i){const n=t.length,r=ls(i,n);e.uniform1iv(this.addr,r);for(let e=0;e!==n;++e)i.safeSetTextureCube(t[e]||es,r[e])}function zs(e,t,i){this.id=e,this.addr=i,this.cache=[],this.setValue=function(e){switch(e){case 5126:return hs;case 35664:return us;case 35665:return ds;case 35666:return fs;case 35674:return ms;case 35675:return ps;case 35676:return gs;case 5124:case 35670:return _s;case 35667:case 35671:return ws;case 35668:case 35672:return Ss;case 35669:case 35673:return As;case 5125:return Ms;case 35678:case 36198:case 36298:case 36306:case 35682:return vs;case 35679:case 36299:case 36307:return xs;case 35680:case 36300:case 36308:case 36293:return bs;case 36289:case 36303:case 36311:case 36292:return ys}}(t.type)}function Us(e,t,i){this.id=e,this.addr=i,this.cache=[],this.size=t.size,this.setValue=function(e){switch(e){case 5126:return Cs;case 35664:return Ds;case 35665:return Ls;case 35666:return Rs;case 35674:return ks;case 35675:return Os;case 35676:return Bs;case 5124:case 35670:return Ps;case 35667:case 35671:return Ts;case 35668:case 35672:return Is;case 35669:case 35673:return Es;case 35678:case 36198:case 36298:case 36306:case 35682:return Ns;case 35680:case 36300:case 36308:case 36293:return Fs}}(t.type)}function $s(e){this.id=e,this.seq=[],this.map={}}Us.prototype.updateCache=function(e){let t=this.cache;e instanceof Float32Array&&t.length!==e.length&&(this.cache=new Float32Array(e.length)),cs(t,e)},$s.prototype.setValue=function(e,t,i){const n=this.seq;for(let r=0,s=n.length;r!==s;++r){const s=n[r];s.setValue(e,t[s.id],i)}};const Gs=/([\w\d_]+)(\])?(\[|\.)?/g;function Vs(e,t){e.seq.push(t),e.map[t.id]=t}function Hs(e,t,i){const n=e.name,r=n.length;for(Gs.lastIndex=0;;){const s=Gs.exec(n),o=Gs.lastIndex;let a=s[1],c="]"===s[2],l=s[3];if(c&&(a|=0),void 0===l||"["===l&&o+2===r){Vs(i,void 0===l?new zs(a,e,t):new Us(a,e,t));break}{let e=i.map[a];void 0===e&&(e=new $s(a),Vs(i,e)),i=e}}}function js(e,t){this.seq=[],this.map={};const i=e.getProgramParameter(t,35718);for(let n=0;n<i;++n){const i=e.getActiveUniform(t,n);Hs(i,e.getUniformLocation(t,i.name),this)}}function Ws(e,t,i){const n=e.createShader(t);return e.shaderSource(n,i),e.compileShader(n),n}js.prototype.setValue=function(e,t,i,n){const r=this.map[t];void 0!==r&&r.setValue(e,i,n)},js.prototype.setOptional=function(e,t,i){const n=t[i];void 0!==n&&this.setValue(e,i,n)},js.upload=function(e,t,i,n){for(let r=0,s=t.length;r!==s;++r){const s=t[r],o=i[s.id];!1!==o.needsUpdate&&s.setValue(e,o.value,n)}},js.seqWithValue=function(e,t){const i=[];for(let n=0,r=e.length;n!==r;++n){const r=e[n];r.id in t&&i.push(r)}return i};let qs=0;function Xs(e){switch(e){case _t:return["Linear","( value )"];case wt:return["sRGB","( value )"];case At:return["RGBE","( value )"];case Ct:return["RGBM","( value, 7.0 )"];case Pt:return["RGBM","( value, 16.0 )"];case Tt:return["RGBD","( value, 256.0 )"];case St:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case Mt:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",e),["Linear","( value )"]}}function Ys(e,t,i){const n=e.getShaderParameter(t,35713),r=e.getShaderInfoLog(t).trim();if(n&&""===r)return"";return"THREE.WebGLShader: gl.getShaderInfoLog() "+i+"\n"+r+function(e){const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=e+1+": "+t[e];return t.join("\n")}(e.getShaderSource(t))}function Zs(e,t){const i=Xs(t);return"vec4 "+e+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function Ks(e,t){const i=Xs(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function Qs(e,t){let i;switch(t){case H:i="Linear";break;case j:i="Reinhard";break;case W:i="OptimizedCineon";break;case q:i="ACESFilmic";break;case X:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),i="Linear"}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function Js(e){return""!==e}function eo(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function to(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const io=/^[ \t]*#include +<([\w\d./]+)>/gm;function no(e){return e.replace(io,ro)}function ro(e,t){const i=Rr[t];if(void 0===i)throw new Error("Can not resolve #include <"+t+">");return no(i)}const so=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,oo=/#pragma unroll_loop_start[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}[\s]+?#pragma unroll_loop_end/g;function ao(e){return e.replace(oo,lo).replace(so,co)}function co(e,t,i,n){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),lo(e,t,i,n)}function lo(e,t,i,n){let r="";for(let e=parseInt(t);e<parseInt(i);e++)r+=n.replace(/\[ i \]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return r}function ho(e){let t="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function uo(e,t,i,n){const a=e.getContext(),c=i.defines;let l=i.vertexShader,h=i.fragmentShader;const u=function(e){let t="SHADOWMAP_TYPE_BASIC";return e.shadowMapType===r?t="SHADOWMAP_TYPE_PCF":e.shadowMapType===s?t="SHADOWMAP_TYPE_PCF_SOFT":e.shadowMapType===o&&(t="SHADOWMAP_TYPE_VSM"),t}(i),d=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case Y:case Z:t="ENVMAP_TYPE_CUBE";break;case J:case ee:t="ENVMAP_TYPE_CUBE_UV";break;case K:case Q:t="ENVMAP_TYPE_EQUIREC"}return t}(i),f=function(e){let t="ENVMAP_MODE_REFLECTION";if(e.envMap)switch(e.envMapMode){case Z:case Q:t="ENVMAP_MODE_REFRACTION"}return t}(i),m=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case U:t="ENVMAP_BLENDING_MULTIPLY";break;case $:t="ENVMAP_BLENDING_MIX";break;case G:t="ENVMAP_BLENDING_ADD"}return t}(i),p=e.gammaFactor>0?e.gammaFactor:1,g=i.isWebGL2?"":function(e){return[e.extensionDerivatives||e.envMapCubeUV||e.bumpMap||e.tangentSpaceNormalMap||e.clearcoatNormalMap||e.flatShading||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Js).join("\n")}(i),v=function(e){const t=[];for(const i in e){const n=e[i];!1!==n&&t.push("#define "+i+" "+n)}return t.join("\n")}(c),y=a.createProgram();let x,b;if(i.isRawShaderMaterial?(x=[v].filter(Js).join("\n"),x.length>0&&(x+="\n"),b=[g,v].filter(Js).join("\n"),b.length>0&&(b+="\n")):(x=[ho(i),"#define SHADER_NAME "+i.shaderName,v,i.instancing?"#define USE_INSTANCING":"",i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+p,"#define MAX_BONES "+i.maxBones,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+f:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+u:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING"," attribute mat4 instanceMatrix;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Js).join("\n"),b=[g,ho(i),"#define SHADER_NAME "+i.shaderName,v,i.alphaTest?"#define ALPHATEST "+i.alphaTest+(i.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+p,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+d:"",i.envMap?"#define "+f:"",i.envMap?"#define "+m:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.sheen?"#define USE_SHEEN":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+u:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(i.extensionShaderTextureLOD||i.envMap)&&i.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",i.toneMapping!==V?"#define TONE_MAPPING":"",i.toneMapping!==V?Rr.tonemapping_pars_fragment:"",i.toneMapping!==V?Qs("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",Rr.encodings_pars_fragment,i.map?Zs("mapTexelToLinear",i.mapEncoding):"",i.matcap?Zs("matcapTexelToLinear",i.matcapEncoding):"",i.envMap?Zs("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMap?Zs("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.lightMap?Zs("lightMapTexelToLinear",i.lightMapEncoding):"",Ks("linearToOutputTexel",i.outputEncoding),i.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Js).join("\n")),l=no(l),l=eo(l,i),l=to(l,i),h=no(h),h=eo(h,i),h=to(h,i),l=ao(l),h=ao(h),i.isWebGL2&&!i.isRawShaderMaterial){let e=!1;const t=/^\s*#version\s+300\s+es\s*\n/;i.isShaderMaterial&&null!==l.match(t)&&null!==h.match(t)&&(e=!0,l=l.replace(t,""),h=h.replace(t,"")),x=["#version 300 es\n","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+x,b=["#version 300 es\n","#define varying in",e?"":"out highp vec4 pc_fragColor;",e?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+b}const _=b+h,w=Ws(a,35633,x+l),S=Ws(a,35632,_);if(a.attachShader(y,w),a.attachShader(y,S),void 0!==i.index0AttributeName?a.bindAttribLocation(y,0,i.index0AttributeName):!0===i.morphTargets&&a.bindAttribLocation(y,0,"position"),a.linkProgram(y),e.debug.checkShaderErrors){const e=a.getProgramInfoLog(y).trim(),t=a.getShaderInfoLog(w).trim(),i=a.getShaderInfoLog(S).trim();let n=!0,r=!0;if(!1===a.getProgramParameter(y,35714)){n=!1;const t=Ys(a,w,"vertex"),i=Ys(a,S,"fragment");console.error("THREE.WebGLProgram: shader error: ",a.getError(),"gl.VALIDATE_STATUS",a.getProgramParameter(y,35715),"gl.getProgramInfoLog",e,t,i)}else""!==e?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",e):""!==t&&""!==i||(r=!1);r&&(this.diagnostics={runnable:n,programLog:e,vertexShader:{log:t,prefix:x},fragmentShader:{log:i,prefix:b}})}let A,M;return a.deleteShader(w),a.deleteShader(S),this.getUniforms=function(){return void 0===A&&(A=new js(a,y)),A},this.getAttributes=function(){return void 0===M&&(M=function(e,t){const i={},n=e.getProgramParameter(t,35721);for(let r=0;r<n;r++){const n=e.getActiveAttrib(t,r).name;i[n]=e.getAttribLocation(t,n)}return i}(a,y)),M},this.destroy=function(){n.releaseStatesOfProgram(this),a.deleteProgram(y),this.program=void 0},this.name=i.shaderName,this.id=qs++,this.cacheKey=t,this.usedTimes=1,this.program=y,this.vertexShader=w,this.fragmentShader=S,this}function fo(e,t,i,n){const r=[],s=i.isWebGL2,o=i.logarithmicDepthBuffer,a=i.floatVertexTextures,h=i.maxVertexUniforms,u=i.vertexTextures;let d=i.precision;const f={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},m=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen"];function p(e){let t;return e?e.isTexture?t=e.encoding:e.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),t=e.texture.encoding):t=_t,t}return{getParameters:function(n,r,m,g,v,y,x){const b=g.fog,_=n.isMeshStandardMaterial?g.environment:null,w=n.envMap||_,S=f[n.type],A=x.isSkinnedMesh?function(e){const t=e.skeleton.bones;if(a)return 1024;{const e=h,i=Math.floor((e-20)/4),n=Math.min(i,t.length);return n<t.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+t.length+" bones. This GPU supports "+n+"."),0):n}}(x):0;null!==n.precision&&(d=i.getMaxPrecision(n.precision),d!==n.precision&&console.warn("THREE.WebGLProgram.getParameters:",n.precision,"not supported, using",d,"instead."));const M=function(e,t){let i;if(t){const n=kr[t];i={name:e.name||e.type,uniforms:yr.clone(n.uniforms),vertexShader:n.vertexShader,fragmentShader:n.fragmentShader}}else i={name:e.name||e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};return i}(n,S);n.onBeforeCompile(M,e);const C=e.getRenderTarget();return{isWebGL2:s,shaderID:S,shaderName:M.name,uniforms:M.uniforms,vertexShader:M.vertexShader,fragmentShader:M.fragmentShader,defines:n.defines,isRawShaderMaterial:n.isRawShaderMaterial,isShaderMaterial:n.isShaderMaterial,precision:d,instancing:!0===x.isInstancedMesh,supportsVertexTextures:u,outputEncoding:null!==C?p(C.texture):e.outputEncoding,map:!!n.map,mapEncoding:p(n.map),matcap:!!n.matcap,matcapEncoding:p(n.matcap),envMap:!!w,envMapMode:w&&w.mapping,envMapEncoding:p(w),envMapCubeUV:!!w&&(w.mapping===J||w.mapping===ee),lightMap:!!n.lightMap,lightMapEncoding:p(n.lightMap),aoMap:!!n.aoMap,emissiveMap:!!n.emissiveMap,emissiveMapEncoding:p(n.emissiveMap),bumpMap:!!n.bumpMap,normalMap:!!n.normalMap,objectSpaceNormalMap:n.normalMapType===Lt,tangentSpaceNormalMap:n.normalMapType===Dt,clearcoatMap:!!n.clearcoatMap,clearcoatRoughnessMap:!!n.clearcoatRoughnessMap,clearcoatNormalMap:!!n.clearcoatNormalMap,displacementMap:!!n.displacementMap,roughnessMap:!!n.roughnessMap,metalnessMap:!!n.metalnessMap,specularMap:!!n.specularMap,alphaMap:!!n.alphaMap,gradientMap:!!n.gradientMap,sheen:!!n.sheen,combine:n.combine,vertexTangents:n.normalMap&&n.vertexTangents,vertexColors:n.vertexColors,vertexUvs:!!(n.map||n.bumpMap||n.normalMap||n.specularMap||n.alphaMap||n.emissiveMap||n.roughnessMap||n.metalnessMap||n.clearcoatMap||n.clearcoatRoughnessMap||n.clearcoatNormalMap||n.displacementMap),uvsVertexOnly:!(n.map||n.bumpMap||n.normalMap||n.specularMap||n.alphaMap||n.emissiveMap||n.roughnessMap||n.metalnessMap||n.clearcoatNormalMap||!n.displacementMap),fog:!!b,useFog:n.fog,fogExp2:b&&b.isFogExp2,flatShading:n.flatShading,sizeAttenuation:n.sizeAttenuation,logarithmicDepthBuffer:o,skinning:n.skinning&&A>0,maxBones:A,useVertexTexture:a,morphTargets:n.morphTargets,morphNormals:n.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:r.directional.length,numPointLights:r.point.length,numSpotLights:r.spot.length,numRectAreaLights:r.rectArea.length,numHemiLights:r.hemi.length,numDirLightShadows:r.directionalShadowMap.length,numPointLightShadows:r.pointShadowMap.length,numSpotLightShadows:r.spotShadowMap.length,numClippingPlanes:v,numClipIntersection:y,dithering:n.dithering,shadowMapEnabled:e.shadowMap.enabled&&m.length>0,shadowMapType:e.shadowMap.type,toneMapping:n.toneMapped?e.toneMapping:V,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:n.premultipliedAlpha,alphaTest:n.alphaTest,doubleSided:n.side===l,flipSided:n.side===c,depthPacking:void 0!==n.depthPacking&&n.depthPacking,index0AttributeName:n.index0AttributeName,extensionDerivatives:n.extensions&&n.extensions.derivatives,extensionFragDepth:n.extensions&&n.extensions.fragDepth,extensionDrawBuffers:n.extensions&&n.extensions.drawBuffers,extensionShaderTextureLOD:n.extensions&&n.extensions.shaderTextureLOD,rendererExtensionFragDepth:s||null!==t.get("EXT_frag_depth"),rendererExtensionDrawBuffers:s||null!==t.get("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:s||null!==t.get("EXT_shader_texture_lod"),customProgramCacheKey:n.customProgramCacheKey()}},getProgramCacheKey:function(t){const i=[];if(t.shaderID?i.push(t.shaderID):(i.push(t.fragmentShader),i.push(t.vertexShader)),void 0!==t.defines)for(const e in t.defines)i.push(e),i.push(t.defines[e]);if(void 0===t.isRawShaderMaterial){for(let e=0;e<m.length;e++)i.push(t[m[e]]);i.push(e.outputEncoding),i.push(e.gammaFactor)}return i.push(t.customProgramCacheKey),i.join()},acquireProgram:function(t,i){let s;for(let e=0,t=r.length;e<t;e++){const t=r[e];if(t.cacheKey===i){s=t,++s.usedTimes;break}}return void 0===s&&(s=new uo(e,i,t,n),r.push(s)),s},releaseProgram:function(e){if(0==--e.usedTimes){const t=r.indexOf(e);r[t]=r[r.length-1],r.pop(),e.destroy()}},programs:r}}function mo(){let e=new WeakMap;return{get:function(t){let i=e.get(t);return void 0===i&&(i={},e.set(t,i)),i},remove:function(t){e.delete(t)},update:function(t,i,n){e.get(t)[i]=n},dispose:function(){e=new WeakMap}}}function po(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function go(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function vo(){const e=[];let t=0;const i=[],n=[],r={id:-1};function s(i,n,s,o,a,c){let l=e[t];return void 0===l?(l={id:i.id,object:i,geometry:n,material:s,program:s.program||r,groupOrder:o,renderOrder:i.renderOrder,z:a,group:c},e[t]=l):(l.id=i.id,l.object=i,l.geometry=n,l.material=s,l.program=s.program||r,l.groupOrder=o,l.renderOrder=i.renderOrder,l.z=a,l.group=c),t++,l}return{opaque:i,transparent:n,init:function(){t=0,i.length=0,n.length=0},push:function(e,t,r,o,a,c){const l=s(e,t,r,o,a,c);(!0===r.transparent?n:i).push(l)},unshift:function(e,t,r,o,a,c){const l=s(e,t,r,o,a,c);(!0===r.transparent?n:i).unshift(l)},finish:function(){for(let i=t,n=e.length;i<n;i++){const t=e[i];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.program=null,t.group=null}},sort:function(e,t){i.length>1&&i.sort(e||po),n.length>1&&n.sort(t||go)}}}function yo(){let e=new WeakMap;function t(i){const n=i.target;n.removeEventListener("dispose",t),e.delete(n)}return{get:function(i,n){const r=e.get(i);let s;return void 0===r?(s=new vo,e.set(i,new WeakMap),e.get(i).set(n,s),i.addEventListener("dispose",t)):(s=r.get(n),void 0===s&&(s=new vo,r.set(n,s))),s},dispose:function(){e=new WeakMap}}}function xo(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":i={direction:new Zt,color:new mn};break;case"SpotLight":i={position:new Zt,direction:new Zt,color:new mn,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Zt,color:new mn,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Zt,skyColor:new mn,groundColor:new mn};break;case"RectAreaLight":i={color:new mn,position:new Zt,halfWidth:new Zt,halfHeight:new Zt}}return e[t.id]=i,i}}}let bo=0;function _o(e,t){return(t.castShadow?1:0)-(e.castShadow?1:0)}function wo(){const e=new xo,t=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new zt};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new zt,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=i,i}}}(),i={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let e=0;e<9;e++)i.probe.push(new Zt);const n=new Zt,r=new ri,s=new ri;return{setup:function(o,a,c){let l=0,h=0,u=0;for(let e=0;e<9;e++)i.probe[e].set(0,0,0);let d=0,f=0,m=0,p=0,g=0,v=0,y=0,x=0;const b=c.matrixWorldInverse;o.sort(_o);for(let a=0,c=o.length;a<c;a++){const c=o[a],_=c.color,w=c.intensity,S=c.distance,A=c.shadow&&c.shadow.map?c.shadow.map.texture:null;if(c.isAmbientLight)l+=_.r*w,h+=_.g*w,u+=_.b*w;else if(c.isLightProbe)for(let e=0;e<9;e++)i.probe[e].addScaledVector(c.sh.coefficients[e],w);else if(c.isDirectionalLight){const r=e.get(c);if(r.color.copy(c.color).multiplyScalar(c.intensity),r.direction.setFromMatrixPosition(c.matrixWorld),n.setFromMatrixPosition(c.target.matrixWorld),r.direction.sub(n),r.direction.transformDirection(b),c.castShadow){const e=c.shadow,n=t.get(c);n.shadowBias=e.bias,n.shadowNormalBias=e.normalBias,n.shadowRadius=e.radius,n.shadowMapSize=e.mapSize,i.directionalShadow[d]=n,i.directionalShadowMap[d]=A,i.directionalShadowMatrix[d]=c.shadow.matrix,v++}i.directional[d]=r,d++}else if(c.isSpotLight){const r=e.get(c);if(r.position.setFromMatrixPosition(c.matrixWorld),r.position.applyMatrix4(b),r.color.copy(_).multiplyScalar(w),r.distance=S,r.direction.setFromMatrixPosition(c.matrixWorld),n.setFromMatrixPosition(c.target.matrixWorld),r.direction.sub(n),r.direction.transformDirection(b),r.coneCos=Math.cos(c.angle),r.penumbraCos=Math.cos(c.angle*(1-c.penumbra)),r.decay=c.decay,c.castShadow){const e=c.shadow,n=t.get(c);n.shadowBias=e.bias,n.shadowNormalBias=e.normalBias,n.shadowRadius=e.radius,n.shadowMapSize=e.mapSize,i.spotShadow[m]=n,i.spotShadowMap[m]=A,i.spotShadowMatrix[m]=c.shadow.matrix,x++}i.spot[m]=r,m++}else if(c.isRectAreaLight){const t=e.get(c);t.color.copy(_).multiplyScalar(w),t.position.setFromMatrixPosition(c.matrixWorld),t.position.applyMatrix4(b),s.identity(),r.copy(c.matrixWorld),r.premultiply(b),s.extractRotation(r),t.halfWidth.set(.5*c.width,0,0),t.halfHeight.set(0,.5*c.height,0),t.halfWidth.applyMatrix4(s),t.halfHeight.applyMatrix4(s),i.rectArea[p]=t,p++}else if(c.isPointLight){const n=e.get(c);if(n.position.setFromMatrixPosition(c.matrixWorld),n.position.applyMatrix4(b),n.color.copy(c.color).multiplyScalar(c.intensity),n.distance=c.distance,n.decay=c.decay,c.castShadow){const e=c.shadow,n=t.get(c);n.shadowBias=e.bias,n.shadowNormalBias=e.normalBias,n.shadowRadius=e.radius,n.shadowMapSize=e.mapSize,n.shadowCameraNear=e.camera.near,n.shadowCameraFar=e.camera.far,i.pointShadow[f]=n,i.pointShadowMap[f]=A,i.pointShadowMatrix[f]=c.shadow.matrix,y++}i.point[f]=n,f++}else if(c.isHemisphereLight){const t=e.get(c);t.direction.setFromMatrixPosition(c.matrixWorld),t.direction.transformDirection(b),t.direction.normalize(),t.skyColor.copy(c.color).multiplyScalar(w),t.groundColor.copy(c.groundColor).multiplyScalar(w),i.hemi[g]=t,g++}}i.ambient[0]=l,i.ambient[1]=h,i.ambient[2]=u;const _=i.hash;_.directionalLength===d&&_.pointLength===f&&_.spotLength===m&&_.rectAreaLength===p&&_.hemiLength===g&&_.numDirectionalShadows===v&&_.numPointShadows===y&&_.numSpotShadows===x||(i.directional.length=d,i.spot.length=m,i.rectArea.length=p,i.point.length=f,i.hemi.length=g,i.directionalShadow.length=v,i.directionalShadowMap.length=v,i.pointShadow.length=y,i.pointShadowMap.length=y,i.spotShadow.length=x,i.spotShadowMap.length=x,i.directionalShadowMatrix.length=v,i.pointShadowMatrix.length=y,i.spotShadowMatrix.length=x,_.directionalLength=d,_.pointLength=f,_.spotLength=m,_.rectAreaLength=p,_.hemiLength=g,_.numDirectionalShadows=v,_.numPointShadows=y,_.numSpotShadows=x,i.version=bo++)},state:i}}function So(){const e=new wo,t=[],i=[];return{init:function(){t.length=0,i.length=0},state:{lightsArray:t,shadowsArray:i,lights:e},setupLights:function(n){e.setup(t,i,n)},pushLight:function(e){t.push(e)},pushShadow:function(e){i.push(e)}}}function Ao(){let e=new WeakMap;function t(i){const n=i.target;n.removeEventListener("dispose",t),e.delete(n)}return{get:function(i,n){let r;return!1===e.has(i)?(r=new So,e.set(i,new WeakMap),e.get(i).set(n,r),i.addEventListener("dispose",t)):!1===e.get(i).has(n)?(r=new So,e.get(i).set(n,r)):r=e.get(i).get(n),r},dispose:function(){e=new WeakMap}}}function Mo(e){bn.call(this),this.type="MeshDepthMaterial",this.depthPacking=It,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(e)}function Co(e){bn.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new Zt,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(e)}Mo.prototype=Object.create(bn.prototype),Mo.prototype.constructor=Mo,Mo.prototype.isMeshDepthMaterial=!0,Mo.prototype.copy=function(e){return bn.prototype.copy.call(this,e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},Co.prototype=Object.create(bn.prototype),Co.prototype.constructor=Co,Co.prototype.isMeshDistanceMaterial=!0,Co.prototype.copy=function(e){return bn.prototype.copy.call(this,e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this};var Po="uniform sampler2D shadow_pass;uniform vec2 resolution;uniform float radius;\n#include <packing>\nvoid main(){float mean=0.0;float squared_mean=0.0;float depth=unpackRGBAToDepth(texture2D(shadow_pass,(gl_FragCoord.xy)/resolution));for(float i=-1.0;i<1.0;i+=SAMPLE_RATE){\n#ifdef HORIZONAL_PASS\nvec2 distribution=unpackRGBATo2Half(texture2D(shadow_pass,(gl_FragCoord.xy+vec2(i,0.0)*radius)/resolution));mean+=distribution.x;squared_mean+=distribution.y*distribution.y+distribution.x*distribution.x;\n#else\nfloat depth=unpackRGBAToDepth(texture2D(shadow_pass,(gl_FragCoord.xy+vec2(0.0,i)*radius)/resolution));mean+=depth;squared_mean+=depth*depth;\n#endif\n}mean=mean*HALF_SAMPLE_RATE;squared_mean=squared_mean*HALF_SAMPLE_RATE;float std_dev=sqrt(squared_mean-mean*mean);gl_FragColor=pack2HalfToRGBA(vec2(mean,std_dev));}",To="void main(){gl_Position=vec4(position,1.0);}";function Io(e,t,i){let n=new Pr;const s=new zt,u=new zt,d=new jt,f=[],m=[],p={},g={0:c,1:a,2:l},v=new _r({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new zt},radius:{value:4}},vertexShader:To,fragmentShader:Po}),y=v.clone();y.defines.HORIZONAL_PASS=1;const x=new Vn;x.setAttribute("position",new An(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const b=new ar(x,v),_=this;function w(i,n){const r=t.update(b);v.uniforms.shadow_pass.value=i.map.texture,v.uniforms.resolution.value=i.mapSize,v.uniforms.radius.value=i.radius,e.setRenderTarget(i.mapPass),e.clear(),e.renderBufferDirect(n,null,r,v,b,null),y.uniforms.shadow_pass.value=i.mapPass.texture,y.uniforms.resolution.value=i.mapSize,y.uniforms.radius.value=i.radius,e.setRenderTarget(i.map),e.clear(),e.renderBufferDirect(n,null,r,y,b,null)}function S(e,t,i){const n=e<<0|t<<1|i<<2;let r=f[n];return void 0===r&&(r=new Mo({depthPacking:Et,morphTargets:e,skinning:t}),f[n]=r),r}function A(e,t,i){const n=e<<0|t<<1|i<<2;let r=m[n];return void 0===r&&(r=new Co({morphTargets:e,skinning:t}),m[n]=r),r}function M(t,i,n,r,s,a,c){let l=null,h=S,u=t.customDepthMaterial;if(!0===r.isPointLight&&(h=A,u=t.customDistanceMaterial),void 0===u){let e=!1;!0===n.morphTargets&&(e=i.morphAttributes&&i.morphAttributes.position&&i.morphAttributes.position.length>0);let r=!1;!0===t.isSkinnedMesh&&(!0===n.skinning?r=!0:console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",t));l=h(e,r,!0===t.isInstancedMesh)}else l=u;if(e.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length){const e=l.uuid,t=n.uuid;let i=p[e];void 0===i&&(i={},p[e]=i);let r=i[t];void 0===r&&(r=l.clone(),i[t]=r),l=r}return l.visible=n.visible,l.wireframe=n.wireframe,l.side=c===o?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:g[n.side],l.clipShadows=n.clipShadows,l.clippingPlanes=n.clippingPlanes,l.clipIntersection=n.clipIntersection,l.wireframeLinewidth=n.wireframeLinewidth,l.linewidth=n.linewidth,!0===r.isPointLight&&!0===l.isMeshDistanceMaterial&&(l.referencePosition.setFromMatrixPosition(r.matrixWorld),l.nearDistance=s,l.farDistance=a),l}function C(i,r,s,a,c){if(!1===i.visible)return;if(i.layers.test(r.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&c===o)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,i.matrixWorld);const n=t.update(i),r=i.material;if(Array.isArray(r)){const t=n.groups;for(let o=0,l=t.length;o<l;o++){const l=t[o],h=r[l.materialIndex];if(h&&h.visible){const t=M(i,n,h,a,s.near,s.far,c);e.renderBufferDirect(s,null,n,t,i,l)}}}else if(r.visible){const t=M(i,n,r,a,s.near,s.far,c);e.renderBufferDirect(s,null,n,t,i,null)}}const l=i.children;for(let e=0,t=l.length;e<t;e++)C(l[e],r,s,a,c)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=r,this.render=function(t,r,a){if(!1===_.enabled)return;if(!1===_.autoUpdate&&!1===_.needsUpdate)return;if(0===t.length)return;const c=e.getRenderTarget(),l=e.getActiveCubeFace(),f=e.getActiveMipmapLevel(),m=e.state;m.setBlending(h),m.buffers.color.setClear(1,1,1,1),m.buffers.depth.setTest(!0),m.setScissorTest(!1);for(let c=0,l=t.length;c<l;c++){const l=t[c],h=l.shadow;if(!1===h.autoUpdate&&!1===h.needsUpdate)continue;if(void 0===h){console.warn("THREE.WebGLShadowMap:",l,"has no shadow.");continue}s.copy(h.mapSize);const f=h.getFrameExtents();if(s.multiply(f),u.copy(h.mapSize),(s.x>i||s.y>i)&&(s.x>i&&(u.x=Math.floor(i/f.x),s.x=u.x*f.x,h.mapSize.x=u.x),s.y>i&&(u.y=Math.floor(i/f.y),s.y=u.y*f.y,h.mapSize.y=u.y)),null===h.map&&!h.isPointLightShadow&&this.type===o){const e={minFilter:ae,magFilter:ae,format:Ae};h.map=new Wt(s.x,s.y,e),h.map.texture.name=l.name+".shadowMap",h.mapPass=new Wt(s.x,s.y,e),h.camera.updateProjectionMatrix()}if(null===h.map){const e={minFilter:re,magFilter:re,format:Ae};h.map=new Wt(s.x,s.y,e),h.map.texture.name=l.name+".shadowMap",h.camera.updateProjectionMatrix()}e.setRenderTarget(h.map),e.clear();const p=h.getViewportCount();for(let e=0;e<p;e++){const t=h.getViewport(e);d.set(u.x*t.x,u.y*t.y,u.x*t.z,u.y*t.w),m.viewport(d),h.updateMatrices(l,e),n=h.getFrustum(),C(r,a,h.camera,l,this.type)}h.isPointLightShadow||this.type!==o||w(h,a),h.needsUpdate=!1}_.needsUpdate=!1,e.setRenderTarget(c,l,f)}}function Eo(e,r,s){const o=s.isWebGL2;const a=new function(){let t=!1;const i=new jt;let n=null;const r=new jt(0,0,0,0);return{setMask:function(i){n===i||t||(e.colorMask(i,i,i,i),n=i)},setLocked:function(e){t=e},setClear:function(t,n,s,o,a){!0===a&&(t*=o,n*=o,s*=o),i.set(t,n,s,o),!1===r.equals(i)&&(e.clearColor(t,n,s,o),r.copy(i))},reset:function(){t=!1,n=null,r.set(-1,0,0,0)}}},U=new function(){let t=!1,i=null,n=null,r=null;return{setTest:function(e){e?me(2929):pe(2929)},setMask:function(n){i===n||t||(e.depthMask(n),i=n)},setFunc:function(t){if(n!==t){if(t)switch(t){case L:e.depthFunc(512);break;case R:e.depthFunc(519);break;case k:e.depthFunc(513);break;case O:e.depthFunc(515);break;case B:e.depthFunc(514);break;case N:e.depthFunc(518);break;case F:e.depthFunc(516);break;case z:e.depthFunc(517);break;default:e.depthFunc(515)}else e.depthFunc(515);n=t}},setLocked:function(e){t=e},setClear:function(t){r!==t&&(e.clearDepth(t),r=t)},reset:function(){t=!1,i=null,n=null,r=null}}},$=new function(){let t=!1,i=null,n=null,r=null,s=null,o=null,a=null,c=null,l=null;return{setTest:function(e){t||(e?me(2960):pe(2960))},setMask:function(n){i===n||t||(e.stencilMask(n),i=n)},setFunc:function(t,i,o){n===t&&r===i&&s===o||(e.stencilFunc(t,i,o),n=t,r=i,s=o)},setOp:function(t,i,n){o===t&&a===i&&c===n||(e.stencilOp(t,i,n),o=t,a=i,c=n)},setLocked:function(e){t=e},setClear:function(t){l!==t&&(e.clearStencil(t),l=t)},reset:function(){t=!1,i=null,n=null,r=null,s=null,o=null,a=null,c=null,l=null}}};let G={},V=null,H=null,j=null,W=null,q=null,X=null,Y=null,Z=null,K=null,Q=!1,J=null,ee=null,te=null,ie=null,ne=null;const re=e.getParameter(35661);let se=!1,oe=0;const ae=e.getParameter(7938);-1!==ae.indexOf("WebGL")?(oe=parseFloat(/^WebGL\ ([0-9])/.exec(ae)[1]),se=oe>=1):-1!==ae.indexOf("OpenGL ES")&&(oe=parseFloat(/^OpenGL\ ES\ ([0-9])/.exec(ae)[1]),se=oe>=2);let ce=null,le={};const he=new jt,ue=new jt;function de(t,i,n){const r=new Uint8Array(4),s=e.createTexture();e.bindTexture(t,s),e.texParameteri(t,10241,9728),e.texParameteri(t,10240,9728);for(let t=0;t<n;t++)e.texImage2D(i+t,0,6408,1,1,0,6408,5121,r);return s}const fe={};function me(t){!0!==G[t]&&(e.enable(t),G[t]=!0)}function pe(t){!1!==G[t]&&(e.disable(t),G[t]=!1)}fe[3553]=de(3553,3553,1),fe[34067]=de(34067,34069,6),a.setClear(0,0,0,1),U.setClear(1),$.setClear(0),me(2929),U.setFunc(O),xe(!1),be(i),me(2884),ye(h);const ge={[g]:32774,[v]:32778,[y]:32779};if(o)ge[x]=32775,ge[b]=32776;else{const e=r.get("EXT_blend_minmax");null!==e&&(ge[x]=e.MIN_EXT,ge[b]=e.MAX_EXT)}const ve={[_]:0,[w]:1,[S]:768,[M]:770,[D]:776,[I]:774,[P]:772,[A]:769,[C]:771,[E]:775,[T]:773};function ye(t,i,n,r,s,o,a,c){if(t!==h){if(H||(me(3042),H=!0),t===p)s=s||i,o=o||n,a=a||r,i===W&&s===Y||(e.blendEquationSeparate(ge[i],ge[s]),W=i,Y=s),n===q&&r===X&&o===Z&&a===K||(e.blendFuncSeparate(ve[n],ve[r],ve[o],ve[a]),q=n,X=r,Z=o,K=a),j=t,Q=null;else if(t!==j||c!==Q){if(W===g&&Y===g||(e.blendEquation(32774),W=g,Y=g),c)switch(t){case u:e.blendFuncSeparate(1,771,1,771);break;case d:e.blendFunc(1,1);break;case f:e.blendFuncSeparate(0,0,769,771);break;case m:e.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case u:e.blendFuncSeparate(770,771,1,771);break;case d:e.blendFunc(770,1);break;case f:e.blendFunc(0,769);break;case m:e.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}q=null,X=null,Z=null,K=null,j=t,Q=c}}else H&&(pe(3042),H=!1)}function xe(t){J!==t&&(t?e.frontFace(2304):e.frontFace(2305),J=t)}function be(r){r!==t?(me(2884),r!==ee&&(r===i?e.cullFace(1029):r===n?e.cullFace(1028):e.cullFace(1032))):pe(2884),ee=r}function _e(t,i,n){t?(me(32823),ie===i&&ne===n||(e.polygonOffset(i,n),ie=i,ne=n)):pe(32823)}function we(t){void 0===t&&(t=33984+re-1),ce!==t&&(e.activeTexture(t),ce=t)}return{buffers:{color:a,depth:U,stencil:$},enable:me,disable:pe,useProgram:function(t){return V!==t&&(e.useProgram(t),V=t,!0)},setBlending:ye,setMaterial:function(e,t){e.side===l?pe(2884):me(2884);let i=e.side===c;t&&(i=!i),xe(i),e.blending===u&&!1===e.transparent?ye(h):ye(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),U.setFunc(e.depthFunc),U.setTest(e.depthTest),U.setMask(e.depthWrite),a.setMask(e.colorWrite);const n=e.stencilWrite;$.setTest(n),n&&($.setMask(e.stencilWriteMask),$.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),$.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),_e(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)},setFlipSided:xe,setCullFace:be,setLineWidth:function(t){t!==te&&(se&&e.lineWidth(t),te=t)},setPolygonOffset:_e,setScissorTest:function(e){e?me(3089):pe(3089)},activeTexture:we,bindTexture:function(t,i){null===ce&&we();let n=le[ce];void 0===n&&(n={type:void 0,texture:void 0},le[ce]=n),n.type===t&&n.texture===i||(e.bindTexture(t,i||fe[t]),n.type=t,n.texture=i)},unbindTexture:function(){const t=le[ce];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===he.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),he.copy(t))},viewport:function(t){!1===ue.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),ue.copy(t))},reset:function(){G={},ce=null,le={},V=null,j=null,J=null,ee=null,a.reset(),U.reset(),$.reset()}}}function Do(e,t,i,n,r,s,o){const a=r.isWebGL2,c=r.maxTextures,l=r.maxCubemapSize,h=r.maxTextureSize,u=r.maxSamples,d=new WeakMap;let f,m=!1;try{m="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function p(e,t){return m?new OffscreenCanvas(e,t):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function g(e,t,i,n){let r=1;if((e.width>n||e.height>n)&&(r=n/Math.max(e.width,e.height)),r<1||!0===t){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const n=t?Ft.floorPowerOfTwo:Math.floor,s=n(r*e.width),o=n(r*e.height);void 0===f&&(f=p(s,o));const a=i?p(s,o):f;a.width=s,a.height=o;return a.getContext("2d").drawImage(e,0,0,s,o),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+e.width+"x"+e.height+") to ("+s+"x"+o+")."),a}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+e.width+"x"+e.height+")."),e}return e}function v(e){return Ft.isPowerOfTwo(e.width)&&Ft.isPowerOfTwo(e.height)}function y(e,t){return e.generateMipmaps&&t&&e.minFilter!==re&&e.minFilter!==ae}function x(t,i,r,s){e.generateMipmap(t);n.get(i).__maxMipLevel=Math.log(Math.max(r,s))*Math.LOG2E}function b(i,n,r){if(!1===a)return n;if(null!==i){if(void 0!==e[i])return e[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let s=n;return 6403===n&&(5126===r&&(s=33326),5131===r&&(s=33325),5121===r&&(s=33321)),6407===n&&(5126===r&&(s=34837),5131===r&&(s=34843),5121===r&&(s=32849)),6408===n&&(5126===r&&(s=34836),5131===r&&(s=34842),5121===r&&(s=32856)),33325!==s&&33326!==s&&34842!==s&&34836!==s||t.get("EXT_color_buffer_float"),s}function _(e){return e===re||e===se||e===oe?9728:9729}function w(t){const i=t.target;i.removeEventListener("dispose",w),function(t){const i=n.get(t);if(void 0===i.__webglInit)return;e.deleteTexture(i.__webglTexture),n.remove(t)}(i),i.isVideoTexture&&d.delete(i),o.memory.textures--}function S(t){const i=t.target;i.removeEventListener("dispose",S),function(t){const i=n.get(t),r=n.get(t.texture);if(!t)return;void 0!==r.__webglTexture&&e.deleteTexture(r.__webglTexture);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++)e.deleteFramebuffer(i.__webglFramebuffer[t]),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer[t]);else e.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&e.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer&&e.deleteRenderbuffer(i.__webglColorRenderbuffer),i.__webglDepthRenderbuffer&&e.deleteRenderbuffer(i.__webglDepthRenderbuffer);n.remove(t.texture),n.remove(t)}(i),o.memory.textures--}let A=0;function M(e,t){const r=n.get(e);if(e.isVideoTexture&&function(e){const t=o.render.frame;d.get(e)!==t&&(d.set(e,t),e.update())}(e),e.version>0&&r.__version!==e.version){const i=e.image;if(void 0===i)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==i.complete)return void L(r,e,t);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.activeTexture(33984+t),i.bindTexture(3553,r.__webglTexture)}function C(t,r){if(6!==t.image.length)return;const o=n.get(t);if(t.version>0&&o.__version!==t.version){D(o,t),i.activeTexture(33984+r),i.bindTexture(34067,o.__webglTexture),e.pixelStorei(37440,t.flipY);const n=t&&(t.isCompressedTexture||t.image[0].isCompressedTexture),c=t.image[0]&&t.image[0].isDataTexture,h=[];for(let e=0;e<6;e++)h[e]=n||c?c?t.image[e].image:t.image[e]:g(t.image[e],!1,!0,l);const u=h[0],d=v(u)||a,f=s.convert(t.format),m=s.convert(t.type),p=b(t.internalFormat,f,m);let _;if(E(34067,t,d),n){for(let e=0;e<6;e++){_=h[e].mipmaps;for(let n=0;n<_.length;n++){const r=_[n];t.format!==Ae&&t.format!==Se?null!==f?i.compressedTexImage2D(34069+e,n,p,r.width,r.height,0,r.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(34069+e,n,p,r.width,r.height,0,f,m,r.data)}}o.__maxMipLevel=_.length-1}else{_=t.mipmaps;for(let e=0;e<6;e++)if(c){i.texImage2D(34069+e,0,p,h[e].width,h[e].height,0,f,m,h[e].data);for(let t=0;t<_.length;t++){const n=_[t].image[e].image;i.texImage2D(34069+e,t+1,p,n.width,n.height,0,f,m,n.data)}}else{i.texImage2D(34069+e,0,p,f,m,h[e]);for(let t=0;t<_.length;t++){const n=_[t];i.texImage2D(34069+e,t+1,p,f,m,n.image[e])}}o.__maxMipLevel=_.length}y(t,d)&&x(34067,t,u.width,u.height),o.__version=t.version,t.onUpdate&&t.onUpdate(t)}else i.activeTexture(33984+r),i.bindTexture(34067,o.__webglTexture)}function P(e,t){i.activeTexture(33984+t),i.bindTexture(34067,n.get(e).__webglTexture)}const T={[te]:10497,[ie]:33071,[ne]:33648},I={[re]:9728,[se]:9984,[oe]:9986,[ae]:9729,[ce]:9985,[le]:9987};function E(i,s,o){o?(e.texParameteri(i,10242,T[s.wrapS]),e.texParameteri(i,10243,T[s.wrapT]),32879!==i&&35866!==i||e.texParameteri(i,32882,T[s.wrapR]),e.texParameteri(i,10240,I[s.magFilter]),e.texParameteri(i,10241,I[s.minFilter])):(e.texParameteri(i,10242,33071),e.texParameteri(i,10243,33071),32879!==i&&35866!==i||e.texParameteri(i,32882,33071),s.wrapS===ie&&s.wrapT===ie||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),e.texParameteri(i,10240,_(s.magFilter)),e.texParameteri(i,10241,_(s.minFilter)),s.minFilter!==re&&s.minFilter!==ae&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter."));const c=t.get("EXT_texture_filter_anisotropic");if(c){if(s.type===ge&&null===t.get("OES_texture_float_linear"))return;if(s.type===ve&&null===(a||t.get("OES_texture_half_float_linear")))return;(s.anisotropy>1||n.get(s).__currentAnisotropy)&&(e.texParameterf(i,c.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,r.getMaxAnisotropy())),n.get(s).__currentAnisotropy=s.anisotropy)}}function D(t,i){void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",w),t.__webglTexture=e.createTexture(),o.memory.textures++)}function L(t,n,r){let o=3553;n.isDataTexture2DArray&&(o=35866),n.isDataTexture3D&&(o=32879),D(t,n),i.activeTexture(33984+r),i.bindTexture(o,t.__webglTexture),e.pixelStorei(37440,n.flipY),e.pixelStorei(37441,n.premultiplyAlpha),e.pixelStorei(3317,n.unpackAlignment);const c=function(e){return!a&&(e.wrapS!==ie||e.wrapT!==ie||e.minFilter!==re&&e.minFilter!==ae)}(n)&&!1===v(n.image),l=g(n.image,c,!1,h),u=v(l)||a,d=s.convert(n.format);let f,m=s.convert(n.type),p=b(n.internalFormat,d,m);E(o,n,u);const _=n.mipmaps;if(n.isDepthTexture)p=6402,a?p=n.type===ge?36012:n.type===pe?33190:n.type===_e?35056:33189:n.type===ge&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),n.format===Pe&&6402===p&&n.type!==fe&&n.type!==pe&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=fe,m=s.convert(n.type)),n.format===Te&&6402===p&&(p=34041,n.type!==_e&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=_e,m=s.convert(n.type))),i.texImage2D(3553,0,p,l.width,l.height,0,d,m,null);else if(n.isDataTexture)if(_.length>0&&u){for(let e=0,t=_.length;e<t;e++)f=_[e],i.texImage2D(3553,e,p,f.width,f.height,0,d,m,f.data);n.generateMipmaps=!1,t.__maxMipLevel=_.length-1}else i.texImage2D(3553,0,p,l.width,l.height,0,d,m,l.data),t.__maxMipLevel=0;else if(n.isCompressedTexture){for(let e=0,t=_.length;e<t;e++)f=_[e],n.format!==Ae&&n.format!==Se?null!==d?i.compressedTexImage2D(3553,e,p,f.width,f.height,0,f.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(3553,e,p,f.width,f.height,0,d,m,f.data);t.__maxMipLevel=_.length-1}else if(n.isDataTexture2DArray)i.texImage3D(35866,0,p,l.width,l.height,l.depth,0,d,m,l.data),t.__maxMipLevel=0;else if(n.isDataTexture3D)i.texImage3D(32879,0,p,l.width,l.height,l.depth,0,d,m,l.data),t.__maxMipLevel=0;else if(_.length>0&&u){for(let e=0,t=_.length;e<t;e++)f=_[e],i.texImage2D(3553,e,p,d,m,f);n.generateMipmaps=!1,t.__maxMipLevel=_.length-1}else i.texImage2D(3553,0,p,d,m,l),t.__maxMipLevel=0;y(n,u)&&x(o,n,l.width,l.height),t.__version=n.version,n.onUpdate&&n.onUpdate(n)}function R(t,r,o,a){const c=s.convert(r.texture.format),l=s.convert(r.texture.type),h=b(r.texture.internalFormat,c,l);i.texImage2D(a,0,h,r.width,r.height,0,c,l,null),e.bindFramebuffer(36160,t),e.framebufferTexture2D(36160,o,a,n.get(r.texture).__webglTexture,0),e.bindFramebuffer(36160,null)}function k(t,i,n){if(e.bindRenderbuffer(36161,t),i.depthBuffer&&!i.stencilBuffer){let r=33189;if(n){const t=i.depthTexture;t&&t.isDepthTexture&&(t.type===ge?r=36012:t.type===pe&&(r=33190));const n=B(i);e.renderbufferStorageMultisample(36161,n,r,i.width,i.height)}else e.renderbufferStorage(36161,r,i.width,i.height);e.framebufferRenderbuffer(36160,36096,36161,t)}else if(i.depthBuffer&&i.stencilBuffer){if(n){const t=B(i);e.renderbufferStorageMultisample(36161,t,35056,i.width,i.height)}else e.renderbufferStorage(36161,34041,i.width,i.height);e.framebufferRenderbuffer(36160,33306,36161,t)}else{const t=s.convert(i.texture.format),r=s.convert(i.texture.type),o=b(i.texture.internalFormat,t,r);if(n){const t=B(i);e.renderbufferStorageMultisample(36161,t,o,i.width,i.height)}else e.renderbufferStorage(36161,o,i.width,i.height)}e.bindRenderbuffer(36161,null)}function O(t){const i=n.get(t),r=!0===t.isWebGLCubeRenderTarget;if(t.depthTexture){if(r)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,i){if(i&&i.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(e.bindFramebuffer(36160,t),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),M(i.depthTexture,0);const r=n.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===Pe)e.framebufferTexture2D(36160,36096,3553,r,0);else{if(i.depthTexture.format!==Te)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(36160,33306,3553,r,0)}}(i.__webglFramebuffer,t)}else if(r){i.__webglDepthbuffer=[];for(let n=0;n<6;n++)e.bindFramebuffer(36160,i.__webglFramebuffer[n]),i.__webglDepthbuffer[n]=e.createRenderbuffer(),k(i.__webglDepthbuffer[n],t,!1)}else e.bindFramebuffer(36160,i.__webglFramebuffer),i.__webglDepthbuffer=e.createRenderbuffer(),k(i.__webglDepthbuffer,t,!1);e.bindFramebuffer(36160,null)}function B(e){return a&&e.isWebGLMultisampleRenderTarget?Math.min(u,e.samples):0}let N=!1,F=!1;this.allocateTextureUnit=function(){const e=A;return e>=c&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+c),A+=1,e},this.resetTextureUnits=function(){A=0},this.setTexture2D=M,this.setTexture2DArray=function(e,t){const r=n.get(e);e.version>0&&r.__version!==e.version?L(r,e,t):(i.activeTexture(33984+t),i.bindTexture(35866,r.__webglTexture))},this.setTexture3D=function(e,t){const r=n.get(e);e.version>0&&r.__version!==e.version?L(r,e,t):(i.activeTexture(33984+t),i.bindTexture(32879,r.__webglTexture))},this.setTextureCube=C,this.setTextureCubeDynamic=P,this.setupRenderTarget=function(t){const r=n.get(t),c=n.get(t.texture);t.addEventListener("dispose",S),c.__webglTexture=e.createTexture(),o.memory.textures++;const l=!0===t.isWebGLCubeRenderTarget,h=!0===t.isWebGLMultisampleRenderTarget,u=v(t)||a;if(!a||t.texture.format!==Se||t.texture.type!==ge&&t.texture.type!==ve||(t.texture.format=Ae,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),l){r.__webglFramebuffer=[];for(let t=0;t<6;t++)r.__webglFramebuffer[t]=e.createFramebuffer()}else if(r.__webglFramebuffer=e.createFramebuffer(),h)if(a){r.__webglMultisampledFramebuffer=e.createFramebuffer(),r.__webglColorRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,r.__webglColorRenderbuffer);const i=s.convert(t.texture.format),n=s.convert(t.texture.type),o=b(t.texture.internalFormat,i,n),a=B(t);e.renderbufferStorageMultisample(36161,a,o,t.width,t.height),e.bindFramebuffer(36160,r.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(36160,36064,36161,r.__webglColorRenderbuffer),e.bindRenderbuffer(36161,null),t.depthBuffer&&(r.__webglDepthRenderbuffer=e.createRenderbuffer(),k(r.__webglDepthRenderbuffer,t,!0)),e.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(l){i.bindTexture(34067,c.__webglTexture),E(34067,t.texture,u);for(let e=0;e<6;e++)R(r.__webglFramebuffer[e],t,36064,34069+e);y(t.texture,u)&&x(34067,t.texture,t.width,t.height),i.bindTexture(34067,null)}else i.bindTexture(3553,c.__webglTexture),E(3553,t.texture,u),R(r.__webglFramebuffer,t,36064,3553),y(t.texture,u)&&x(3553,t.texture,t.width,t.height),i.bindTexture(3553,null);t.depthBuffer&&O(t)},this.updateRenderTargetMipmap=function(e){const t=e.texture;if(y(t,v(e)||a)){const r=e.isWebGLCubeRenderTarget?34067:3553,s=n.get(t).__webglTexture;i.bindTexture(r,s),x(r,t,e.width,e.height),i.bindTexture(r,null)}},this.updateMultisampleRenderTarget=function(t){if(t.isWebGLMultisampleRenderTarget)if(a){const i=n.get(t);e.bindFramebuffer(36008,i.__webglMultisampledFramebuffer),e.bindFramebuffer(36009,i.__webglFramebuffer);const r=t.width,s=t.height;let o=16384;t.depthBuffer&&(o|=256),t.stencilBuffer&&(o|=1024),e.blitFramebuffer(0,0,r,s,0,0,r,s,o,9728),e.bindFramebuffer(36160,i.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(e,t){e&&e.isWebGLRenderTarget&&(!1===N&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),N=!0),e=e.texture),M(e,t)},this.safeSetTextureCube=function(e,t){e&&e.isWebGLCubeRenderTarget&&(!1===F&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),F=!0),e=e.texture),e&&e.isCubeTexture||Array.isArray(e.image)&&6===e.image.length?C(e,t):P(e,t)}}function Lo(e,t,i){const n=i.isWebGL2;return{convert:function(e){let i;if(e===he)return 5121;if(e===ye)return 32819;if(e===xe)return 32820;if(e===be)return 33635;if(e===ue)return 5120;if(e===de)return 5122;if(e===fe)return 5123;if(e===me)return 5124;if(e===pe)return 5125;if(e===ge)return 5126;if(e===ve)return n?5131:(i=t.get("OES_texture_half_float"),null!==i?i.HALF_FLOAT_OES:null);if(e===we)return 6406;if(e===Se)return 6407;if(e===Ae)return 6408;if(e===Me)return 6409;if(e===Ce)return 6410;if(e===Pe)return 6402;if(e===Te)return 34041;if(e===Ie)return 6403;if(e===Ee)return 36244;if(e===De)return 33319;if(e===Le)return 33320;if(e===Re)return 36248;if(e===ke)return 36249;if(e===Oe||e===Be||e===Ne||e===Fe){if(i=t.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(e===Oe)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===Be)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===Ne)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===Fe)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(e===ze||e===Ue||e===$e||e===Ge){if(i=t.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(e===ze)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===Ue)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===$e)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Ge)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Ve)return i=t.get("WEBGL_compressed_texture_etc1"),null!==i?i.COMPRESSED_RGB_ETC1_WEBGL:null;if((e===He||e===je)&&(i=t.get("WEBGL_compressed_texture_etc"),null!==i)){if(e===He)return i.COMPRESSED_RGB8_ETC2;if(e===je)return i.COMPRESSED_RGBA8_ETC2_EAC}return e===We||e===qe||e===Xe||e===Ye||e===Ze||e===Ke||e===Qe||e===Je||e===et||e===tt||e===it||e===nt||e===rt||e===st||e===at||e===ct||e===lt||e===ht||e===ut||e===dt||e===ft||e===mt||e===pt||e===gt||e===vt||e===yt||e===xt||e===bt?(i=t.get("WEBGL_compressed_texture_astc"),null!==i?e:null):e===ot?(i=t.get("EXT_texture_compression_bptc"),null!==i?e:null):e===_e?n?34042:(i=t.get("WEBGL_depth_texture"),null!==i?i.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}function Ro(e){Sr.call(this),this.cameras=e||[]}function ko(){wi.call(this),this.type="Group"}function Oo(){this._targetRay=null,this._grip=null}function Bo(e,t){const i=this;let n=null,r=1,s=null,o="local-floor",a=null;const c=[],l=new Map,h=new Sr;h.layers.enable(1),h.viewport=new jt;const u=new Sr;u.layers.enable(2),u.viewport=new jt;const d=[h,u],f=new Ro;f.layers.enable(1),f.layers.enable(2);let m=null,p=null;function g(e){const t=l.get(e.inputSource);t&&t.dispatchEvent({type:e.type})}function v(){l.forEach((function(e,t){e.disconnect(t)})),l.clear(),e.setFramebuffer(null),e.setRenderTarget(e.getRenderTarget()),A.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}function y(e){s=e,A.setContext(n),A.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}function x(e){const t=n.inputSources;for(let e=0;e<c.length;e++)l.set(t[e],c[e]);for(let t=0;t<e.removed.length;t++){const i=e.removed[t],n=l.get(i);n&&(n.dispatchEvent({type:"disconnected",data:i}),l.delete(i))}for(let t=0;t<e.added.length;t++){const i=e.added[t],n=l.get(i);n&&n.dispatchEvent({type:"connected",data:i})}}this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=c[e];return void 0===t&&(t=new Oo,c[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=c[e];return void 0===t&&(t=new Oo,c[e]=t),t.getGripSpace()},this.setFramebufferScaleFactor=function(e){r=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){o=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return s},this.getSession=function(){return n},this.setSession=function(e){if(n=e,null!==n){n.addEventListener("select",g),n.addEventListener("selectstart",g),n.addEventListener("selectend",g),n.addEventListener("squeeze",g),n.addEventListener("squeezestart",g),n.addEventListener("squeezeend",g),n.addEventListener("end",v);const e=t.getContextAttributes();!0!==e.xrCompatible&&t.makeXRCompatible();const i={antialias:e.antialias,alpha:e.alpha,depth:e.depth,stencil:e.stencil,framebufferScaleFactor:r},s=new XRWebGLLayer(n,t,i);n.updateRenderState({baseLayer:s}),n.requestReferenceSpace(o).then(y),n.addEventListener("inputsourceschange",x)}};const b=new Zt,_=new Zt;function w(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.getInverse(e.matrixWorld)}this.getCamera=function(e){f.near=u.near=h.near=e.near,f.far=u.far=h.far=e.far,m===f.near&&p===f.far||(n.updateRenderState({depthNear:f.near,depthFar:f.far}),m=f.near,p=f.far);const t=e.parent,i=f.cameras;w(f,t);for(let e=0;e<i.length;e++)w(i[e],t);e.matrixWorld.copy(f.matrixWorld);const r=e.children;for(let e=0,t=r.length;e<t;e++)r[e].updateMatrixWorld(!0);return 2===i.length?function(e,t,i){b.setFromMatrixPosition(t.matrixWorld),_.setFromMatrixPosition(i.matrixWorld);const n=b.distanceTo(_),r=t.projectionMatrix.elements,s=i.projectionMatrix.elements,o=r[14]/(r[10]-1),a=r[14]/(r[10]+1),c=(r[9]+1)/r[5],l=(r[9]-1)/r[5],h=(r[8]-1)/r[0],u=(s[8]+1)/s[0],d=o*h,f=o*u,m=n/(-h+u),p=m*-h;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(p),e.translateZ(m),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.getInverse(e.matrixWorld);const g=o+m,v=a+m,y=d-p,x=f+(n-p),w=c*a/v*g,S=l*a/v*g;e.projectionMatrix.makePerspective(y,x,w,S,g,v)}(f,h,u):f.projectionMatrix.copy(h.projectionMatrix),f};let S=null;const A=new Ir;A.setAnimationLoop((function(t,i){if(a=i.getViewerPose(s),null!==a){const t=a.views,i=n.renderState.baseLayer;e.setFramebuffer(i.framebuffer);let r=!1;t.length!==f.cameras.length&&(f.cameras.length=0,r=!0);for(let e=0;e<t.length;e++){const n=t[e],s=i.getViewport(n),o=d[e];o.matrix.fromArray(n.transform.matrix),o.projectionMatrix.fromArray(n.projectionMatrix),o.viewport.set(s.x,s.y,s.width,s.height),0===e&&f.matrix.copy(o.matrix),!0===r&&f.cameras.push(o)}}const r=n.inputSources;for(let e=0;e<c.length;e++){const t=c[e],n=r[e];t.update(n,i,s)}S&&S(t,i)})),this.setAnimationLoop=function(e){S=e},this.dispose=function(){}}function No(e){function t(t,i,n){t.opacity.value=i.opacity,i.color&&t.diffuse.value.copy(i.color),i.emissive&&t.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(t.map.value=i.map),i.alphaMap&&(t.alphaMap.value=i.alphaMap),i.specularMap&&(t.specularMap.value=i.specularMap);const r=i.envMap||n;let s,o;r&&(t.envMap.value=r,t.flipEnvMap.value=r.isCubeTexture?-1:1,t.reflectivity.value=i.reflectivity,t.refractionRatio.value=i.refractionRatio,t.maxMipLevel.value=e.get(r).__maxMipLevel),i.lightMap&&(t.lightMap.value=i.lightMap,t.lightMapIntensity.value=i.lightMapIntensity),i.aoMap&&(t.aoMap.value=i.aoMap,t.aoMapIntensity.value=i.aoMapIntensity),i.map?s=i.map:i.specularMap?s=i.specularMap:i.displacementMap?s=i.displacementMap:i.normalMap?s=i.normalMap:i.bumpMap?s=i.bumpMap:i.roughnessMap?s=i.roughnessMap:i.metalnessMap?s=i.metalnessMap:i.alphaMap?s=i.alphaMap:i.emissiveMap&&(s=i.emissiveMap),void 0!==s&&(s.isWebGLRenderTarget&&(s=s.texture),!0===s.matrixAutoUpdate&&s.updateMatrix(),t.uvTransform.value.copy(s.matrix)),i.aoMap?o=i.aoMap:i.lightMap&&(o=i.lightMap),void 0!==o&&(o.isWebGLRenderTarget&&(o=o.texture),!0===o.matrixAutoUpdate&&o.updateMatrix(),t.uv2Transform.value.copy(o.matrix))}function i(e,t,i){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===c&&(e.bumpScale.value*=-1)),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===c&&e.normalScale.value.negate()),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),(t.envMap||i)&&(e.envMapIntensity.value=t.envMapIntensity)}return{refreshFogUniforms:function(e,t){e.fogColor.value.copy(t.color),t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)},refreshMaterialUniforms:function(e,n,r,s,o){n.isMeshBasicMaterial?t(e,n):n.isMeshLambertMaterial?(t(e,n),function(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(e,n)):n.isMeshToonMaterial?(t(e,n),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap);t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===c&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===c&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshPhongMaterial?(t(e,n),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===c&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===c&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshStandardMaterial?(t(e,n,r),n.isMeshPhysicalMaterial?function(e,t,n){i(e,t,n),e.reflectivity.value=t.reflectivity,e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.sheen&&e.sheen.value.copy(t.sheen);t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap);t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap);t.clearcoatNormalMap&&(e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),e.clearcoatNormalMap.value=t.clearcoatNormalMap,t.side===c&&e.clearcoatNormalScale.value.negate());e.transparency.value=t.transparency}(e,n,r):i(e,n,r)):n.isMeshMatcapMaterial?(t(e,n),function(e,t){t.matcap&&(e.matcap.value=t.matcap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===c&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===c&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDepthMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDistanceMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(e,n)):n.isMeshNormalMaterial?(t(e,n),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===c&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===c&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity}(e,n),n.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,n)):n.isPointsMaterial?function(e,t,i,n){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*i,e.scale.value=.5*n,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);let r;t.map?r=t.map:t.alphaMap&&(r=t.alphaMap);void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),e.uvTransform.value.copy(r.matrix))}(e,n,s,o):n.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);let i;t.map?i=t.map:t.alphaMap&&(i=t.alphaMap);void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),e.uvTransform.value.copy(i.matrix))}(e,n):n.isShadowMaterial?(e.color.value.copy(n.color),e.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function Fo(e){const t=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),i=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,r=void 0===e.depth||e.depth,s=void 0===e.stencil||e.stencil,o=void 0!==e.antialias&&e.antialias,a=void 0===e.premultipliedAlpha||e.premultipliedAlpha,c=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,l=void 0!==e.powerPreference?e.powerPreference:"default",h=void 0!==e.failIfMajorPerformanceCaveat&&e.failIfMajorPerformanceCaveat;let u=null,d=null;this.domElement=t,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=_t,this.physicallyCorrectLights=!1,this.toneMapping=V,this.toneMappingExposure=1,this.maxMorphTargets=8,this.maxMorphNormals=4;const f=this;let m=!1,p=null,g=0,v=0,y=null,x=null,b=-1,_=null,w=null;const S=new jt,A=new jt;let M=null,C=t.width,P=t.height,T=1,I=null,E=null;const D=new jt(0,0,C,P),L=new jt(0,0,C,P);let R=!1;const k=new Pr,O=new zr;let B=!1,N=!1;const F=new ri,z=new Zt,U={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function $(){return null===y?T:1}let G,H,j,W,q,X,Y,Z,K,Q,J,ee,te,ie,ne,re,se,oe,ae,ce=i;function le(e,i){for(let n=0;n<e.length;n++){const r=e[n],s=t.getContext(r,i);if(null!==s)return s}return null}try{const e={alpha:n,depth:r,stencil:s,antialias:o,premultipliedAlpha:a,preserveDrawingBuffer:c,powerPreference:l,failIfMajorPerformanceCaveat:h};if(t.addEventListener("webglcontextlost",me,!1),t.addEventListener("webglcontextrestored",pe,!1),null===ce){const t=["webgl2","webgl","experimental-webgl"];if(!0===f.isWebGL1Renderer&&t.shift(),ce=le(t,e),null===ce)throw le(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===ce.getShaderPrecisionFormat&&(ce.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function ue(){G=new Ur(ce),H=new Fr(ce,G,e),!1===H.isWebGL2&&(G.get("WEBGL_depth_texture"),G.get("OES_texture_float"),G.get("OES_texture_half_float"),G.get("OES_texture_half_float_linear"),G.get("OES_standard_derivatives"),G.get("OES_element_index_uint"),G.get("OES_vertex_array_object"),G.get("ANGLE_instanced_arrays")),G.get("OES_texture_float_linear"),oe=new Lo(ce,G,H),j=new Eo(ce,G,H),j.scissor(A.copy(L).multiplyScalar(T).floor()),j.viewport(S.copy(D).multiplyScalar(T).floor()),W=new Vr(ce),q=new mo,X=new Do(ce,G,j,q,H,oe,W),Y=new Er(ce,H),ae=new Br(ce,G,Y,H),Z=new $r(ce,Y,W,ae),K=new qr(ce,Z,Y,W),ne=new Wr(ce),Q=new fo(f,G,H,ae),J=new No(q),ee=new yo,te=new Ao,ie=new Or(f,j,K,a),re=new Nr(ce,G,W,H),se=new Gr(ce,G,W,H),W.programs=Q.programs,f.capabilities=H,f.extensions=G,f.properties=q,f.renderLists=ee,f.state=j,f.info=W}ue();const de=new Bo(f,ce);this.xr=de;const fe=new Io(f,K,H.maxTextureSize);function me(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),m=!0}function pe(){console.log("THREE.WebGLRenderer: Context Restored."),m=!1,ue()}function ye(e){const t=e.target;t.removeEventListener("dispose",ye),function(e){xe(e),q.remove(e)}(t)}function xe(e){const t=q.get(e).program;e.program=void 0,void 0!==t&&Q.releaseProgram(t)}this.shadowMap=fe,this.getContext=function(){return ce},this.getContextAttributes=function(){return ce.getContextAttributes()},this.forceContextLoss=function(){const e=G.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=G.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return T},this.setPixelRatio=function(e){void 0!==e&&(T=e,this.setSize(C,P,!1))},this.getSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),e=new zt),e.set(C,P)},this.setSize=function(e,i,n){de.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(C=e,P=i,t.width=Math.floor(e*T),t.height=Math.floor(i*T),!1!==n&&(t.style.width=e+"px",t.style.height=i+"px"),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),e=new zt),e.set(C*T,P*T).floor()},this.setDrawingBufferSize=function(e,i,n){C=e,P=i,T=n,t.width=Math.floor(e*n),t.height=Math.floor(i*n),this.setViewport(0,0,e,i)},this.getCurrentViewport=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),e=new jt),e.copy(S)},this.getViewport=function(e){return e.copy(D)},this.setViewport=function(e,t,i,n){e.isVector4?D.set(e.x,e.y,e.z,e.w):D.set(e,t,i,n),j.viewport(S.copy(D).multiplyScalar(T).floor())},this.getScissor=function(e){return e.copy(L)},this.setScissor=function(e,t,i,n){e.isVector4?L.set(e.x,e.y,e.z,e.w):L.set(e,t,i,n),j.scissor(A.copy(L).multiplyScalar(T).floor())},this.getScissorTest=function(){return R},this.setScissorTest=function(e){j.setScissorTest(R=e)},this.setOpaqueSort=function(e){I=e},this.setTransparentSort=function(e){E=e},this.getClearColor=function(){return ie.getClearColor()},this.setClearColor=function(){ie.setClearColor.apply(ie,arguments)},this.getClearAlpha=function(){return ie.getClearAlpha()},this.setClearAlpha=function(){ie.setClearAlpha.apply(ie,arguments)},this.clear=function(e,t,i){let n=0;(void 0===e||e)&&(n|=16384),(void 0===t||t)&&(n|=256),(void 0===i||i)&&(n|=1024),ce.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",me,!1),t.removeEventListener("webglcontextrestored",pe,!1),ee.dispose(),te.dispose(),q.dispose(),K.dispose(),ae.dispose(),de.dispose(),_e.stop()},this.renderBufferImmediate=function(e,t){ae.initAttributes();const i=q.get(e);e.hasPositions&&!i.position&&(i.position=ce.createBuffer()),e.hasNormals&&!i.normal&&(i.normal=ce.createBuffer()),e.hasUvs&&!i.uv&&(i.uv=ce.createBuffer()),e.hasColors&&!i.color&&(i.color=ce.createBuffer());const n=t.getAttributes();e.hasPositions&&(ce.bindBuffer(34962,i.position),ce.bufferData(34962,e.positionArray,35048),ae.enableAttribute(n.position),ce.vertexAttribPointer(n.position,3,5126,!1,0,0)),e.hasNormals&&(ce.bindBuffer(34962,i.normal),ce.bufferData(34962,e.normalArray,35048),ae.enableAttribute(n.normal),ce.vertexAttribPointer(n.normal,3,5126,!1,0,0)),e.hasUvs&&(ce.bindBuffer(34962,i.uv),ce.bufferData(34962,e.uvArray,35048),ae.enableAttribute(n.uv),ce.vertexAttribPointer(n.uv,2,5126,!1,0,0)),e.hasColors&&(ce.bindBuffer(34962,i.color),ce.bufferData(34962,e.colorArray,35048),ae.enableAttribute(n.color),ce.vertexAttribPointer(n.color,3,5126,!1,0,0)),ae.disableUnusedAttributes(),ce.drawArrays(4,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,i,n,r,s){null===t&&(t=U);const o=r.isMesh&&r.matrixWorld.determinant()<0,a=Pe(e,t,n,r);j.setMaterial(n,o);let c=i.index;const l=i.attributes.position;if(null===c){if(void 0===l||0===l.count)return}else if(0===c.count)return;let h,u=1;!0===n.wireframe&&(c=Z.getWireframeAttribute(i),u=2),(n.morphTargets||n.morphNormals)&&ne.update(r,i,n,a),ae.setup(r,n,a,i,c);let d=re;null!==c&&(h=Y.get(c),d=se,d.setIndex(h));const f=null!==c?c.count:l.count,m=i.drawRange.start*u,p=i.drawRange.count*u,g=null!==s?s.start*u:0,v=null!==s?s.count*u:1/0,y=Math.max(m,g),x=Math.min(f,m+p,g+v)-1,b=Math.max(0,x-y+1);if(0!==b){if(r.isMesh)!0===n.wireframe?(j.setLineWidth(n.wireframeLinewidth*$()),d.setMode(1)):d.setMode(4);else if(r.isLine){let e=n.linewidth;void 0===e&&(e=1),j.setLineWidth(e*$()),r.isLineSegments?d.setMode(1):r.isLineLoop?d.setMode(2):d.setMode(3)}else r.isPoints?d.setMode(0):r.isSprite&&d.setMode(4);if(r.isInstancedMesh)d.renderInstances(i,y,b,r.count);else if(i.isInstancedBufferGeometry){const e=Math.min(i.instanceCount,i._maxInstanceCount);d.renderInstances(i,y,b,e)}else d.render(y,b)}},this.compile=function(e,t){d=te.get(e,t),d.init(),e.traverse((function(e){e.isLight&&(d.pushLight(e),e.castShadow&&d.pushShadow(e))})),d.setupLights(t);const i=new WeakMap;e.traverse((function(t){let n=t.material;if(n)if(Array.isArray(n))for(let r=0;r<n.length;r++){let s=n[r];!1===i.has(s)&&(Ce(s,e,t),i.set(s))}else!1===i.has(n)&&(Ce(n,e,t),i.set(n))}))};let be=null;const _e=new Ir;function we(e,t,i,n){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)i=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)d.pushLight(e),e.castShadow&&d.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||k.intersectsSprite(e)){n&&z.setFromMatrixPosition(e.matrixWorld).applyMatrix4(F);const t=K.update(e),r=e.material;r.visible&&u.push(e,t,r,i,z.z,null)}}else if(e.isImmediateRenderObject)n&&z.setFromMatrixPosition(e.matrixWorld).applyMatrix4(F),u.push(e,null,e.material,i,z.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.frame!==W.render.frame&&(e.skeleton.update(),e.skeleton.frame=W.render.frame),!e.frustumCulled||k.intersectsObject(e))){n&&z.setFromMatrixPosition(e.matrixWorld).applyMatrix4(F);const t=K.update(e),r=e.material;if(Array.isArray(r)){const n=t.groups;for(let s=0,o=n.length;s<o;s++){const o=n[s],a=r[o.materialIndex];a&&a.visible&&u.push(e,t,a,i,z.z,o)}}else r.visible&&u.push(e,t,r,i,z.z,null)}const r=e.children;for(let e=0,s=r.length;e<s;e++)we(r[e],t,i,n)}function Se(e,t,i){const n=!0===t.isScene?t.overrideMaterial:null;for(let r=0,s=e.length;r<s;r++){const s=e[r],o=s.object,a=s.geometry,c=null===n?s.material:n,l=s.group;if(i.isArrayCamera){w=i;const e=i.cameras;for(let i=0,n=e.length;i<n;i++){const n=e[i];o.layers.test(n.layers)&&(j.viewport(S.copy(n.viewport)),d.setupLights(n),Me(o,t,n,a,c,l))}}else w=null,Me(o,t,i,a,c,l)}}function Me(e,t,i,n,r,s){if(e.onBeforeRender(f,t,i,n,r,s),d=te.get(t,w||i),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){const n=Pe(i,t,r,e);j.setMaterial(r),ae.reset(),function(e,t){e.render((function(e){f.renderBufferImmediate(e,t)}))}(e,n)}else f.renderBufferDirect(i,t,n,r,e,s);e.onAfterRender(f,t,i,n,r,s),d=te.get(t,w||i)}function Ce(e,t,i){!0!==t.isScene&&(t=U);const n=q.get(e),r=d.state.lights,s=d.state.shadowsArray,o=r.state.version,a=Q.getParameters(e,r.state,s,t,O.numPlanes,O.numIntersection,i),c=Q.getProgramCacheKey(a);let l=n.program,h=!0;if(void 0===l)e.addEventListener("dispose",ye);else if(l.cacheKey!==c)xe(e);else if(n.lightsStateVersion!==o)n.lightsStateVersion=o,h=!1;else{if(void 0!==a.shaderID)return;h=!1}h&&(l=Q.acquireProgram(a,c),n.program=l,n.uniforms=a.uniforms,n.outputEncoding=a.outputEncoding,e.program=l);const u=l.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(let t=0;t<f.maxMorphTargets;t++)u["morphTarget"+t]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(let t=0;t<f.maxMorphNormals;t++)u["morphNormal"+t]>=0&&e.numSupportedMorphNormals++}const m=n.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(n.numClippingPlanes=O.numPlanes,n.numIntersection=O.numIntersection,m.clippingPlanes=O.uniform),n.environment=e.isMeshStandardMaterial?t.environment:null,n.fog=t.fog,n.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),n.lightsStateVersion=o,n.needsLights&&(m.ambientLightColor.value=r.state.ambient,m.lightProbe.value=r.state.probe,m.directionalLights.value=r.state.directional,m.directionalLightShadows.value=r.state.directionalShadow,m.spotLights.value=r.state.spot,m.spotLightShadows.value=r.state.spotShadow,m.rectAreaLights.value=r.state.rectArea,m.pointLights.value=r.state.point,m.pointLightShadows.value=r.state.pointShadow,m.hemisphereLights.value=r.state.hemi,m.directionalShadowMap.value=r.state.directionalShadowMap,m.directionalShadowMatrix.value=r.state.directionalShadowMatrix,m.spotShadowMap.value=r.state.spotShadowMap,m.spotShadowMatrix.value=r.state.spotShadowMatrix,m.pointShadowMap.value=r.state.pointShadowMap,m.pointShadowMatrix.value=r.state.pointShadowMatrix);const p=n.program.getUniforms(),g=js.seqWithValue(p.seq,m);n.uniformsList=g}function Pe(e,t,i,n){!0!==t.isScene&&(t=U),X.resetTextureUnits();const r=t.fog,s=i.isMeshStandardMaterial?t.environment:null,o=null===y?f.outputEncoding:y.texture.encoding,a=q.get(i),c=d.state.lights;if(!0===B&&(!0===N||e!==_)){const t=e===_&&i.id===b;O.setState(i.clippingPlanes,i.clipIntersection,i.clipShadows,e,a,t)}i.version===a.__version?void 0===a.program||i.fog&&a.fog!==r||a.environment!==s||a.needsLights&&a.lightsStateVersion!==c.state.version?Ce(i,t,n):void 0===a.numClippingPlanes||a.numClippingPlanes===O.numPlanes&&a.numIntersection===O.numIntersection?a.outputEncoding!==o&&Ce(i,t,n):Ce(i,t,n):(Ce(i,t,n),a.__version=i.version);let l=!1,h=!1,u=!1;const m=a.program,p=m.getUniforms(),g=a.uniforms;if(j.useProgram(m.program)&&(l=!0,h=!0,u=!0),i.id!==b&&(b=i.id,h=!0),l||_!==e){if(p.setValue(ce,"projectionMatrix",e.projectionMatrix),H.logarithmicDepthBuffer&&p.setValue(ce,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),_!==e&&(_=e,h=!0,u=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshStandardMaterial||i.envMap){const t=p.map.cameraPosition;void 0!==t&&t.setValue(ce,z.setFromMatrixPosition(e.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&p.setValue(ce,"isOrthographic",!0===e.isOrthographicCamera),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.isShadowMaterial||i.skinning)&&p.setValue(ce,"viewMatrix",e.matrixWorldInverse)}if(i.skinning){p.setOptional(ce,n,"bindMatrix"),p.setOptional(ce,n,"bindMatrixInverse");const e=n.skeleton;if(e){const t=e.bones;if(H.floatVertexTextures){if(void 0===e.boneTexture){let i=Math.sqrt(4*t.length);i=Ft.ceilPowerOfTwo(i),i=Math.max(i,4);const n=new Float32Array(i*i*4);n.set(e.boneMatrices);const r=new Ar(n,i,i,Ae,ge);e.boneMatrices=n,e.boneTexture=r,e.boneTextureSize=i}p.setValue(ce,"boneTexture",e.boneTexture,X),p.setValue(ce,"boneTextureSize",e.boneTextureSize)}else p.setOptional(ce,e,"boneMatrices")}}var v,x;return(h||a.receiveShadow!==n.receiveShadow)&&(a.receiveShadow=n.receiveShadow,p.setValue(ce,"receiveShadow",n.receiveShadow)),h&&(p.setValue(ce,"toneMappingExposure",f.toneMappingExposure),a.needsLights&&(x=u,(v=g).ambientLightColor.needsUpdate=x,v.lightProbe.needsUpdate=x,v.directionalLights.needsUpdate=x,v.directionalLightShadows.needsUpdate=x,v.pointLights.needsUpdate=x,v.pointLightShadows.needsUpdate=x,v.spotLights.needsUpdate=x,v.spotLightShadows.needsUpdate=x,v.rectAreaLights.needsUpdate=x,v.hemisphereLights.needsUpdate=x),r&&i.fog&&J.refreshFogUniforms(g,r),J.refreshMaterialUniforms(g,i,s,T,P),void 0!==g.ltc_1&&(g.ltc_1.value=Tr.LTC_1),void 0!==g.ltc_2&&(g.ltc_2.value=Tr.LTC_2),js.upload(ce,a.uniformsList,g,X)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(js.upload(ce,a.uniformsList,g,X),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&p.setValue(ce,"center",n.center),p.setValue(ce,"modelViewMatrix",n.modelViewMatrix),p.setValue(ce,"normalMatrix",n.normalMatrix),p.setValue(ce,"modelMatrix",n.matrixWorld),m}_e.setAnimationLoop((function(e){de.isPresenting||be&&be(e)})),"undefined"!=typeof window&&_e.setContext(window),this.setAnimationLoop=function(e){be=e,de.setAnimationLoop(e),null===e?_e.stop():_e.start()},this.render=function(e,t){let i,n;if(void 0!==arguments[2]&&(console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),i=arguments[2]),void 0!==arguments[3]&&(console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),n=arguments[3]),void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===m)return;ae.resetDefaultState(),b=-1,_=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),!0===de.enabled&&!0===de.isPresenting&&(t=de.getCamera(t)),!0===e.isScene&&e.onBeforeRender(f,e,t,i||y),d=te.get(e,t),d.init(),F.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),k.setFromProjectionMatrix(F),N=this.localClippingEnabled,B=O.init(this.clippingPlanes,N,t),u=ee.get(e,t),u.init(),we(e,t,0,f.sortObjects),u.finish(),!0===f.sortObjects&&u.sort(I,E),!0===B&&O.beginShadows();const r=d.state.shadowsArray;fe.render(r,e,t),d.setupLights(t),!0===B&&O.endShadows(),!0===this.info.autoReset&&this.info.reset(),void 0!==i&&this.setRenderTarget(i),ie.render(u,e,t,n);const s=u.opaque,o=u.transparent;s.length>0&&Se(s,e,t),o.length>0&&Se(o,e,t),!0===e.isScene&&e.onAfterRender(f,e,t),null!==y&&(X.updateRenderTargetMipmap(y),X.updateMultisampleRenderTarget(y)),j.buffers.depth.setTest(!0),j.buffers.depth.setMask(!0),j.buffers.color.setMask(!0),j.setPolygonOffset(!1),u=null,d=null},this.setFramebuffer=function(e){p!==e&&null===y&&ce.bindFramebuffer(36160,e),p=e},this.getActiveCubeFace=function(){return g},this.getActiveMipmapLevel=function(){return v},this.getRenderTarget=function(){return y},this.setRenderTarget=function(e,t,i){y=e,g=t,v=i,e&&void 0===q.get(e).__webglFramebuffer&&X.setupRenderTarget(e);let n=p,r=!1;if(e){const i=q.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=i[t||0],r=!0):n=e.isWebGLMultisampleRenderTarget?q.get(e).__webglMultisampledFramebuffer:i,S.copy(e.viewport),A.copy(e.scissor),M=e.scissorTest}else S.copy(D).multiplyScalar(T).floor(),A.copy(L).multiplyScalar(T).floor(),M=R;if(x!==n&&(ce.bindFramebuffer(36160,n),x=n),j.viewport(S),j.scissor(A),j.setScissorTest(M),r){const n=q.get(e.texture);ce.framebufferTexture2D(36160,36064,34069+(t||0),n.__webglTexture,i||0)}},this.readRenderTargetPixels=function(e,t,i,n,r,s,o){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let a=q.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==o&&(a=a[o]),a){let o=!1;a!==x&&(ce.bindFramebuffer(36160,a),o=!0);try{const o=e.texture,a=o.format,c=o.type;if(a!==Ae&&oe.convert(a)!==ce.getParameter(35739))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(c===he||oe.convert(c)===ce.getParameter(35738)||c===ge&&(H.isWebGL2||G.get("OES_texture_float")||G.get("WEBGL_color_buffer_float"))||c===ve&&(H.isWebGL2?G.get("EXT_color_buffer_float"):G.get("EXT_color_buffer_half_float"))))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");36053===ce.checkFramebufferStatus(36160)?t>=0&&t<=e.width-n&&i>=0&&i<=e.height-r&&ce.readPixels(t,i,n,r,oe.convert(a),oe.convert(c),s):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{o&&ce.bindFramebuffer(36160,x)}}},this.copyFramebufferToTexture=function(e,t,i){void 0===i&&(i=0);const n=Math.pow(2,-i),r=Math.floor(t.image.width*n),s=Math.floor(t.image.height*n),o=oe.convert(t.format);X.setTexture2D(t,0),ce.copyTexImage2D(3553,i,o,e.x,e.y,r,s,0),j.unbindTexture()},this.copyTextureToTexture=function(e,t,i,n){void 0===n&&(n=0);const r=t.image.width,s=t.image.height,o=oe.convert(i.format),a=oe.convert(i.type);X.setTexture2D(i,0),ce.pixelStorei(37440,i.flipY),ce.pixelStorei(37441,i.premultiplyAlpha),ce.pixelStorei(3317,i.unpackAlignment),t.isDataTexture?ce.texSubImage2D(3553,n,e.x,e.y,r,s,o,a,t.image.data):t.isCompressedTexture?ce.compressedTexSubImage2D(3553,n,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,o,t.mipmaps[0].data):ce.texSubImage2D(3553,n,e.x,e.y,o,a,t.image),0===n&&i.generateMipmaps&&ce.generateMipmap(3553),j.unbindTexture()},this.initTexture=function(e){X.setTexture2D(e,0),j.unbindTexture()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}function zo(e,t,i){this.name="",this.color=new mn(e),this.near=void 0!==t?t:1,this.far=void 0!==i?i:1e3}function Uo(e){bn.call(this),this.type="LineBasicMaterial",this.color=new mn(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.morphTargets=!1,this.setValues(e)}Ro.prototype=Object.assign(Object.create(Sr.prototype),{constructor:Ro,isArrayCamera:!0}),ko.prototype=Object.assign(Object.create(wi.prototype),{constructor:ko,isGroup:!0}),Object.assign(Oo.prototype,{constructor:Oo,getTargetRaySpace:function(){return null===this._targetRay&&(this._targetRay=new ko,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1),this._targetRay},getGripSpace:function(){return null===this._grip&&(this._grip=new ko,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1),this._grip},dispatchEvent:function(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),this},disconnect:function(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),this},update:function(e,t,i){let n=null,r=null;const s=this._targetRay,o=this._grip;return e&&(null!==s&&(n=t.getPose(e.targetRaySpace,i),null!==n&&(s.matrix.fromArray(n.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale))),null!==o&&e.gripSpace&&(r=t.getPose(e.gripSpace,i),null!==r&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale)))),null!==s&&(s.visible=null!==n),null!==o&&(o.visible=null!==r),this}}),Object.assign(Bo.prototype,Bt.prototype),Object.assign(zo.prototype,{isFog:!0,clone:function(){return new zo(this.color,this.near,this.far)},toJSON:function(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}),Uo.prototype=Object.create(bn.prototype),Uo.prototype.constructor=Uo,Uo.prototype.isLineBasicMaterial=!0,Uo.prototype.copy=function(e){return bn.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.morphTargets=e.morphTargets,this};const $o=new Zt,Go=new Zt,Vo=new ri,Ho=new Xi,jo=new Ui;function Wo(e,t,i){1===i&&console.error("THREE.Line: parameter THREE.LinePieces no longer supported. Use THREE.LineSegments instead."),wi.call(this),this.type="Line",this.geometry=void 0!==e?e:new Vn,this.material=void 0!==t?t:new Uo,this.updateMorphTargets()}Wo.prototype=Object.assign(Object.create(wi.prototype),{constructor:Wo,isLine:!0,copy:function(e){return wi.prototype.copy.call(this,e),this.material=e.material,this.geometry=e.geometry,this},computeLineDistances:function(){const e=this.geometry;if(e.isBufferGeometry)if(null===e.index){const t=e.attributes.position,i=[0];for(let e=1,n=t.count;e<n;e++)$o.fromBufferAttribute(t,e-1),Go.fromBufferAttribute(t,e),i[e]=i[e-1],i[e]+=$o.distanceTo(Go);e.setAttribute("lineDistance",new Ln(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(e.isGeometry){const t=e.vertices,i=e.lineDistances;i[0]=0;for(let e=1,n=t.length;e<n;e++)i[e]=i[e-1],i[e]+=t[e-1].distanceTo(t[e])}return this},raycast:function(e,t){const i=this.geometry,n=this.matrixWorld,r=e.params.Line.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),jo.copy(i.boundingSphere),jo.applyMatrix4(n),jo.radius+=r,!1===e.ray.intersectsSphere(jo))return;Vo.getInverse(n),Ho.copy(e.ray).applyMatrix4(Vo);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=s*s,a=new Zt,c=new Zt,l=new Zt,h=new Zt,u=this&&this.isLineSegments?2:1;if(i.isBufferGeometry){const n=i.index,r=i.attributes.position.array;if(null!==n){const i=n.array;for(let n=0,s=i.length-1;n<s;n+=u){const s=i[n],u=i[n+1];a.fromArray(r,3*s),c.fromArray(r,3*u);if(Ho.distanceSqToSegment(a,c,h,l)>o)continue;h.applyMatrix4(this.matrixWorld);const d=e.ray.origin.distanceTo(h);d<e.near||d>e.far||t.push({distance:d,point:l.clone().applyMatrix4(this.matrixWorld),index:n,face:null,faceIndex:null,object:this})}}else for(let i=0,n=r.length/3-1;i<n;i+=u){a.fromArray(r,3*i),c.fromArray(r,3*i+3);if(Ho.distanceSqToSegment(a,c,h,l)>o)continue;h.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(h);n<e.near||n>e.far||t.push({distance:n,point:l.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else if(i.isGeometry){const n=i.vertices,r=n.length;for(let i=0;i<r-1;i+=u){if(Ho.distanceSqToSegment(n[i],n[i+1],h,l)>o)continue;h.applyMatrix4(this.matrixWorld);const r=e.ray.origin.distanceTo(h);r<e.near||r>e.far||t.push({distance:r,point:l.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});const qo=new Zt,Xo=new Zt;function Yo(e,t){Wo.call(this,e,t),this.type="LineSegments"}function Zo(e){bn.call(this),this.type="PointsMaterial",this.color=new mn(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.setValues(e)}Yo.prototype=Object.assign(Object.create(Wo.prototype),{constructor:Yo,isLineSegments:!0,computeLineDistances:function(){const e=this.geometry;if(e.isBufferGeometry)if(null===e.index){const t=e.attributes.position,i=[];for(let e=0,n=t.count;e<n;e+=2)qo.fromBufferAttribute(t,e),Xo.fromBufferAttribute(t,e+1),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+qo.distanceTo(Xo);e.setAttribute("lineDistance",new Ln(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(e.isGeometry){const t=e.vertices,i=e.lineDistances;for(let e=0,n=t.length;e<n;e+=2)qo.copy(t[e]),Xo.copy(t[e+1]),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+qo.distanceTo(Xo)}return this}}),Zo.prototype=Object.create(bn.prototype),Zo.prototype.constructor=Zo,Zo.prototype.isPointsMaterial=!0,Zo.prototype.copy=function(e){return bn.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.morphTargets=e.morphTargets,this};const Ko=new ri,Qo=new Xi,Jo=new Ui,ea=new Zt;function ta(e,t){wi.call(this),this.type="Points",this.geometry=void 0!==e?e:new Vn,this.material=void 0!==t?t:new Zo,this.updateMorphTargets()}function ia(e,t,i,n,r,s,o){const a=Qo.distanceSqToPoint(e);if(a<i){const i=new Zt;Qo.closestPointToPoint(e,i),i.applyMatrix4(n);const c=r.ray.origin.distanceTo(i);if(c<r.near||c>r.far)return;s.push({distance:c,distanceToRay:Math.sqrt(a),point:i,index:t,face:null,object:o})}}function na(e,t,i,n,r,s,o,a,c){Ht.call(this,e,t,i,n,r,s,o,a,c),this.needsUpdate=!0}function ra(e,t,i,n){mr.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:n},this.fromBufferGeometry(new sa(e,t,i,n)),this.mergeVertices()}function sa(e,t,i,n){Vn.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:n},i=i||1;const r=[],s=[];function o(e,t,i,n){const r=Math.pow(2,n),s=[];for(let n=0;n<=r;n++){s[n]=[];const o=e.clone().lerp(i,n/r),a=t.clone().lerp(i,n/r),c=r-n;for(let e=0;e<=c;e++)s[n][e]=0===e&&n===r?o:o.clone().lerp(a,e/c)}for(let e=0;e<r;e++)for(let t=0;t<2*(r-e)-1;t++){const i=Math.floor(t/2);t%2==0?(a(s[e][i+1]),a(s[e+1][i]),a(s[e][i])):(a(s[e][i+1]),a(s[e+1][i+1]),a(s[e+1][i]))}}function a(e){r.push(e.x,e.y,e.z)}function c(t,i){const n=3*t;i.x=e[n+0],i.y=e[n+1],i.z=e[n+2]}function l(e,t,i,n){n<0&&1===e.x&&(s[t]=e.x-1),0===i.x&&0===i.z&&(s[t]=n/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}!function(e){const i=new Zt,n=new Zt,r=new Zt;for(let s=0;s<t.length;s+=3)c(t[s+0],i),c(t[s+1],n),c(t[s+2],r),o(i,n,r,e)}(n=n||0),function(e){const t=new Zt;for(let i=0;i<r.length;i+=3)t.x=r[i+0],t.y=r[i+1],t.z=r[i+2],t.normalize().multiplyScalar(e),r[i+0]=t.x,r[i+1]=t.y,r[i+2]=t.z}(i),function(){const e=new Zt;for(let i=0;i<r.length;i+=3){e.x=r[i+0],e.y=r[i+1],e.z=r[i+2];const n=h(e)/2/Math.PI+.5,o=(t=e,Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))/Math.PI+.5);s.push(n,1-o)}var t;(function(){const e=new Zt,t=new Zt,i=new Zt,n=new Zt,o=new zt,a=new zt,c=new zt;for(let u=0,d=0;u<r.length;u+=9,d+=6){e.set(r[u+0],r[u+1],r[u+2]),t.set(r[u+3],r[u+4],r[u+5]),i.set(r[u+6],r[u+7],r[u+8]),o.set(s[d+0],s[d+1]),a.set(s[d+2],s[d+3]),c.set(s[d+4],s[d+5]),n.copy(e).add(t).add(i).divideScalar(3);const f=h(n);l(o,d+0,e,f),l(a,d+2,t,f),l(c,d+4,i,f)}})(),function(){for(let e=0;e<s.length;e+=6){const t=s[e+0],i=s[e+2],n=s[e+4],r=Math.max(t,i,n),o=Math.min(t,i,n);r>.9&&o<.1&&(t<.2&&(s[e+0]+=1),i<.2&&(s[e+2]+=1),n<.2&&(s[e+4]+=1))}}()}(),this.setAttribute("position",new Ln(r,3)),this.setAttribute("normal",new Ln(r.slice(),3)),this.setAttribute("uv",new Ln(s,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}function oa(e,t){mr.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new aa(e,t)),this.mergeVertices()}function aa(e,t){sa.call(this,[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function ca(e,t){mr.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new la(e,t)),this.mergeVertices()}function la(e,t){sa.call(this,[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function ha(e,t){mr.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new ua(e,t)),this.mergeVertices()}function ua(e,t){const i=(1+Math.sqrt(5))/2,n=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1];sa.call(this,n,[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function da(e,t,i,n,r){mr.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:n,arc:r},this.fromBufferGeometry(new fa(e,t,i,n,r)),this.mergeVertices()}function fa(e,t,i,n,r){Vn.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:n,arc:r},e=e||1,t=t||.4,i=Math.floor(i)||8,n=Math.floor(n)||6,r=r||2*Math.PI;const s=[],o=[],a=[],c=[],l=new Zt,h=new Zt,u=new Zt;for(let s=0;s<=i;s++)for(let d=0;d<=n;d++){const f=d/n*r,m=s/i*Math.PI*2;h.x=(e+t*Math.cos(m))*Math.cos(f),h.y=(e+t*Math.cos(m))*Math.sin(f),h.z=t*Math.sin(m),o.push(h.x,h.y,h.z),l.x=e*Math.cos(f),l.y=e*Math.sin(f),u.subVectors(h,l).normalize(),a.push(u.x,u.y,u.z),c.push(d/n),c.push(s/i)}for(let e=1;e<=i;e++)for(let t=1;t<=n;t++){const i=(n+1)*e+t-1,r=(n+1)*(e-1)+t-1,o=(n+1)*(e-1)+t,a=(n+1)*e+t;s.push(i,r,a),s.push(r,o,a)}this.setIndex(s),this.setAttribute("position",new Ln(o,3)),this.setAttribute("normal",new Ln(a,3)),this.setAttribute("uv",new Ln(c,2))}function ma(e,t,i,n,r,s,o,a){mr.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:n,heightSegments:r,openEnded:s,thetaStart:o,thetaLength:a},this.fromBufferGeometry(new pa(e,t,i,n,r,s,o,a)),this.mergeVertices()}function pa(e,t,i,n,r,s,o,a){Vn.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:n,heightSegments:r,openEnded:s,thetaStart:o,thetaLength:a};const c=this;e=void 0!==e?e:1,t=void 0!==t?t:1,i=i||1,n=Math.floor(n)||8,r=Math.floor(r)||1,s=void 0!==s&&s,o=void 0!==o?o:0,a=void 0!==a?a:2*Math.PI;const l=[],h=[],u=[],d=[];let f=0;const m=[],p=i/2;let g=0;function v(i){let r,s;const m=new zt,v=new Zt;let y=0;const x=!0===i?e:t,b=!0===i?1:-1;r=f;for(let e=1;e<=n;e++)h.push(0,p*b,0),u.push(0,b,0),d.push(.5,.5),f++;s=f;for(let e=0;e<=n;e++){const t=e/n*a+o,i=Math.cos(t),r=Math.sin(t);v.x=x*r,v.y=p*b,v.z=x*i,h.push(v.x,v.y,v.z),u.push(0,b,0),m.x=.5*i+.5,m.y=.5*r*b+.5,d.push(m.x,m.y),f++}for(let e=0;e<n;e++){const t=r+e,n=s+e;!0===i?l.push(n,n+1,t):l.push(n+1,n,t),y+=3}c.addGroup(g,y,!0===i?1:2),g+=y}!function(){const s=new Zt,v=new Zt;let y=0;const x=(t-e)/i;for(let c=0;c<=r;c++){const l=[],g=c/r,y=g*(t-e)+e;for(let e=0;e<=n;e++){const t=e/n,r=t*a+o,c=Math.sin(r),m=Math.cos(r);v.x=y*c,v.y=-g*i+p,v.z=y*m,h.push(v.x,v.y,v.z),s.set(c,x,m).normalize(),u.push(s.x,s.y,s.z),d.push(t,1-g),l.push(f++)}m.push(l)}for(let e=0;e<n;e++)for(let t=0;t<r;t++){const i=m[t][e],n=m[t+1][e],r=m[t+1][e+1],s=m[t][e+1];l.push(i,n,s),l.push(n,r,s),y+=6}c.addGroup(g,y,0),g+=y}(),!1===s&&(e>0&&v(!0),t>0&&v(!1)),this.setIndex(l),this.setAttribute("position",new Ln(h,3)),this.setAttribute("normal",new Ln(u,3)),this.setAttribute("uv",new Ln(d,2))}function ga(e,t,i,n,r,s,o){ma.call(this,0,e,t,i,n,r,s,o),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:n,openEnded:r,thetaStart:s,thetaLength:o}}function va(e,t,i,n,r,s,o){pa.call(this,0,e,t,i,n,r,s,o),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:n,openEnded:r,thetaStart:s,thetaLength:o}}function ya(e,t){wi.call(this),this.type="Light",this.color=new mn(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function xa(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new zt(512,512),this.map=null,this.mapPass=null,this.matrix=new ri,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Pr,this._frameExtents=new zt(1,1),this._viewportCount=1,this._viewports=[new jt(0,0,1,1)]}function ba(){xa.call(this,new Sr(50,1,.5,500))}function _a(e,t,i,n,r,s){ya.call(this,e,t),this.type="SpotLight",this.position.copy(wi.DefaultUp),this.updateMatrix(),this.target=new wi,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==i?i:0,this.angle=void 0!==n?n:Math.PI/3,this.penumbra=void 0!==r?r:0,this.decay=void 0!==s?s:1,this.shadow=new ba}function wa(e,t,i,n,r,s){wr.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=void 0!==e?e:-1,this.right=void 0!==t?t:1,this.top=void 0!==i?i:1,this.bottom=void 0!==n?n:-1,this.near=void 0!==r?r:.1,this.far=void 0!==s?s:2e3,this.updateProjectionMatrix()}function Sa(e,t){ya.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}ta.prototype=Object.assign(Object.create(wi.prototype),{constructor:ta,isPoints:!0,copy:function(e){return wi.prototype.copy.call(this,e),this.material=e.material,this.geometry=e.geometry,this},raycast:function(e,t){const i=this.geometry,n=this.matrixWorld,r=e.params.Points.threshold;if(null===i.boundingSphere&&i.computeBoundingSphere(),Jo.copy(i.boundingSphere),Jo.applyMatrix4(n),Jo.radius+=r,!1===e.ray.intersectsSphere(Jo))return;Ko.getInverse(n),Qo.copy(e.ray).applyMatrix4(Ko);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=s*s;if(i.isBufferGeometry){const r=i.index,s=i.attributes.position.array;if(null!==r){const i=r.array;for(let r=0,a=i.length;r<a;r++){const a=i[r];ea.fromArray(s,3*a),ia(ea,a,o,n,e,t,this)}}else for(let i=0,r=s.length/3;i<r;i++)ea.fromArray(s,3*i),ia(ea,i,o,n,e,t,this)}else{const r=i.vertices;for(let i=0,s=r.length;i<s;i++)ia(r[i],i,o,n,e,t,this)}},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}),na.prototype=Object.create(Ht.prototype),na.prototype.constructor=na,na.prototype.isCanvasTexture=!0,ra.prototype=Object.create(mr.prototype),ra.prototype.constructor=ra,sa.prototype=Object.create(Vn.prototype),sa.prototype.constructor=sa,oa.prototype=Object.create(mr.prototype),oa.prototype.constructor=oa,aa.prototype=Object.create(sa.prototype),aa.prototype.constructor=aa,ca.prototype=Object.create(mr.prototype),ca.prototype.constructor=ca,la.prototype=Object.create(sa.prototype),la.prototype.constructor=la,ha.prototype=Object.create(mr.prototype),ha.prototype.constructor=ha,ua.prototype=Object.create(sa.prototype),ua.prototype.constructor=ua,da.prototype=Object.create(mr.prototype),da.prototype.constructor=da,fa.prototype=Object.create(Vn.prototype),fa.prototype.constructor=fa,ma.prototype=Object.create(mr.prototype),ma.prototype.constructor=ma,pa.prototype=Object.create(Vn.prototype),pa.prototype.constructor=pa,ga.prototype=Object.create(ma.prototype),ga.prototype.constructor=ga,va.prototype=Object.create(pa.prototype),va.prototype.constructor=va,ya.prototype=Object.assign(Object.create(wi.prototype),{constructor:ya,isLight:!0,copy:function(e){return wi.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},toJSON:function(e){const t=wi.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),Object.assign(xa.prototype,{_projScreenMatrix:new ri,_lightPositionWorld:new Zt,_lookTarget:new Zt,getViewportCount:function(){return this._viewportCount},getFrustum:function(){return this._frustum},updateMatrices:function(e){const t=this.camera,i=this.matrix,n=this._projScreenMatrix,r=this._lookTarget,s=this._lightPositionWorld;s.setFromMatrixPosition(e.matrixWorld),t.position.copy(s),r.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(r),t.updateMatrixWorld(),n.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(n),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(t.projectionMatrix),i.multiply(t.matrixWorldInverse)},getViewport:function(e){return this._viewports[e]},getFrameExtents:function(){return this._frameExtents},copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),ba.prototype=Object.assign(Object.create(xa.prototype),{constructor:ba,isSpotLightShadow:!0,updateMatrices:function(e){const t=this.camera,i=2*Ft.RAD2DEG*e.angle,n=this.mapSize.width/this.mapSize.height,r=e.distance||t.far;i===t.fov&&n===t.aspect&&r===t.far||(t.fov=i,t.aspect=n,t.far=r,t.updateProjectionMatrix()),xa.prototype.updateMatrices.call(this,e)}}),_a.prototype=Object.assign(Object.create(ya.prototype),{constructor:_a,isSpotLight:!0,copy:function(e){return ya.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),wa.prototype=Object.assign(Object.create(wr.prototype),{constructor:wa,isOrthographicCamera:!0,copy:function(e,t){return wr.prototype.copy.call(this,e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this},setViewOffset:function(e,t,i,n,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let r=i-e,s=i+e,o=n+t,a=n-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,s=r+e*this.view.width,o-=t*this.view.offsetY,a=o-t*this.view.height}this.projectionMatrix.makeOrthographic(r,s,o,a,this.near,this.far),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},toJSON:function(e){const t=wi.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}),Sa.prototype=Object.assign(Object.create(ya.prototype),{constructor:Sa,isAmbientLight:!0});const Aa=new ri,Ma=new ri;function Ca(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Sr,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Sr,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}function Pa(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}function Ta(e){if("undefined"==typeof window)return;const t=new RegExp(`${e}=([^&#=]*)`).exec(window.location.search);return t?decodeURIComponent(t[1]):void 0}function Ia(e,t){return void 0!==e?e:t}function Ea(e,t){const i=Object.assign({},e);for(const n in t){void 0===e[n]&&(i[n]=t[n])}return i}function Da(e,t){for(const i in t){const n=t[i];void 0!==n&&(e[i]=n)}return e}function La(){const e=window.location.protocol;return null===e.match(/http(s)?:/gi)?"http:":e}function Ra(){if("undefined"==typeof window)return!1;const e=window.navigator.userAgent;return/Opera|OPR/.test(e)?"Opera":/Chrome/i.test(e)?"Chrome":/Firefox/i.test(e)?"Firefox":/Mobile(\/.*)? Safari/i.test(e)?"Mobile Safari":/MSIE/i.test(e)?"Internet Explorer":!!/Safari/i.test(e)&&"Safari"}function ka(e){window.open(e,"_blank")||(window.location.href=e)}function Oa(e,t="download"){if(!e)return;const i="Safari"===Ra(),n=/CriOS\/[\d]+/.test(window.navigator.userAgent),r=document.createElement("a");function s(e){ka(n?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"))}if("undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(e,t);else if((i||n)&&FileReader)if(e instanceof Blob){var o=new FileReader;o.onloadend=function(){s(o.result)},o.readAsDataURL(e)}else s(e);else{let i=!1;e instanceof Blob&&(e=URL.createObjectURL(e),i=!0),"download"in r?(r.style.display="hidden",document.body.appendChild(r),r.href=e,r.download=t,r.target="_blank",r.click(),document.body.removeChild(r)):ka(e),i&&window.URL.revokeObjectURL(e)}}function Ba(e,t){return e<t?-1:e>t?1:0}function Na(e,t,i=Ba){let n=0,r=e.length-1;for(;n<=r;){const s=n+r>>1,o=i(t,e[s]);if(o>0)n=s+1;else{if(!(o<0))return s;r=s-1}}return-n-1}function Fa(e,t,i){const n=function(e,t){let i=e.length-1;if(e[i]<t)return-1;let n=0;for(;n<=i;){const r=n+i>>1;e[r]>=t?i=r-1:n=r+1}return i+1}(e,t),r=function(e,t){if(e[0]>t)return-1;let i=0,n=e.length-1;for(;i<=n;){const r=i+n>>1;e[r]>t?n=r-1:i=r+1}return i-1}(e,i);return-1===n||-1===r||n>r?0:r-n+1}function za(e){return e.sort().filter((function(e,t,i){return 0===t||e!==i[t-1]}))}function Ua(e){const t=28672;if(e.length>t){const i=[];for(let n=0;n<e.length;n+=t)i.push(String.fromCharCode.apply(null,e.subarray(n,n+t)));return i.join("")}return String.fromCharCode.apply(null,e)}function $a(e,t){switch(e){case"int8":return new Int8Array(t);case"int16":return new Int16Array(t);case"int32":return new Int32Array(t);case"uint8":return new Uint8Array(t);case"uint16":return new Uint16Array(t);case"uint32":return new Uint32Array(t);case"float32":return new Float32Array(t);default:throw new Error("arrayType unknown: "+e)}}function Ga(e,t){return new(t>65535?Uint32Array:Uint16Array)(e)}function Va(e){return e.buffer&&e.buffer instanceof ArrayBuffer?e.buffer:e}function Ha(e,t){return void 0===e?e=new t:Array.isArray(e)&&(e=(new t).fromArray(e)),e}function ja(e){return Ha(e,Zt)}function Wa(e){return Ha(e,ri)}function qa(e){return Ha(e,qt)}function Xa(e){return t=e,i=Float32Array,t instanceof i?t:new i(t);var t,i}function Ya(e){return Ia(e,"").toString().toLowerCase()}Object.assign(Ca.prototype,{update:function(e){const t=this._cache;if(t.focus!==e.focus||t.fov!==e.fov||t.aspect!==e.aspect*this.aspect||t.near!==e.near||t.far!==e.far||t.zoom!==e.zoom||t.eyeSep!==this.eyeSep){t.focus=e.focus,t.fov=e.fov,t.aspect=e.aspect*this.aspect,t.near=e.near,t.far=e.far,t.zoom=e.zoom,t.eyeSep=this.eyeSep;const i=e.projectionMatrix.clone(),n=t.eyeSep/2,r=n*t.near/t.focus,s=t.near*Math.tan(Ft.DEG2RAD*t.fov*.5)/t.zoom;let o,a;Ma.elements[12]=-n,Aa.elements[12]=n,o=-s*t.aspect+r,a=s*t.aspect+r,i.elements[0]=2*t.near/(a-o),i.elements[8]=(a+o)/(a-o),this.cameraL.projectionMatrix.copy(i),o=-s*t.aspect-r,a=s*t.aspect-r,i.elements[0]=2*t.near/(a-o),i.elements[8]=(a+o)/(a-o),this.cameraR.projectionMatrix.copy(i)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(Ma),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(Aa)}}),Pa.prototype.clone=function(){return new Pa(void 0===this.value.clone?this.value:this.value.clone())};class Za{constructor(e){this.name=e,this._dict={}}add(e,t){this._dict[Ya(e)]=t}get(e){return this._dict[Ya(e)]}get names(){return Object.keys(this._dict)}}function Ka(e){return.01745*e}const Qa="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),Ja=new Array(36);function ec(){let e,t=0;for(let i=0;i<36;i++)8===i||13===i||18===i||23===i?Ja[i]="-":14===i?Ja[i]="4":(t<=2&&(t=33554432+16777216*Math.random()|0),e=15&t,t>>=4,Ja[i]=Qa[19===i?3&e|8:e]);return Ja.join("")}function tc(e,t,i){return Math.max(t,Math.min(i,e))}function ic(e,t,i){return e+(t-e)*i}function nc(e,t,i,n,r,s){const o=(i-e)*s,a=(n-t)*s,c=r*r;return(2*t-2*i+o+a)*(r*c)+(-3*t+3*i-2*o-a)*c+o*r+t}function rc(e,t,i){var n;return n=function(e,t,i){return(e-t)/(i-t)}(i,e,t),(i=tc(n,0,1))*i*(3-2*i)}var sc="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function oc(e){var t={exports:{}};return e(t,t.exports),t.exports}var ac=oc((function(e,t){
/**
	 * @license
	 *
	 * chroma.js - JavaScript library for color conversions
	 * 
	 * Copyright (c) 2011-2017, Gregor Aisch
	 * All rights reserved.
	 * 
	 * Redistribution and use in source and binary forms, with or without
	 * modification, are permitted provided that the following conditions are met:
	 * 
	 * 1. Redistributions of source code must retain the above copyright notice, this
	 *    list of conditions and the following disclaimer.
	 * 
	 * 2. Redistributions in binary form must reproduce the above copyright notice,
	 *    this list of conditions and the following disclaimer in the documentation
	 *    and/or other materials provided with the distribution.
	 * 
	 * 3. The name Gregor Aisch may not be used to endorse or promote products
	 *    derived from this software without specific prior written permission.
	 * 
	 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
	 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
	 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
	 * DISCLAIMED. IN NO EVENT SHALL GREGOR AISCH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
	 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
	 * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
	 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
	 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
	 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
	 * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
	 *
	 */
(function(){var i,n,r,s,o,a,c,l,h,u,d,f,m,p,g,v,y,x,b,_,w,S,A,M,C,P,T,I,E,D,L,R,k,O,B,N,F,z,U,$,G,V,H,j,W,q,X,Y,Z,K,Q,J,ee,te,ie,ne,re,se,oe,ae,ce,le,he,ue,de,fe,me,pe,ge,ve,ye,xe,be,_e,we,Se,Ae,Me,Ce,Pe,Te=[].slice;Se=function(){var e,t,i,n,r;for(e={},n=0,t=(r="Boolean Number String Function Array Date RegExp Undefined Null".split(" ")).length;n<t;n++)i=r[n],e["[object "+i+"]"]=i.toLowerCase();return function(t){var i;return i=Object.prototype.toString.call(t),e[i]||"object"}}(),X=function(e,t,i){return null==t&&(t=0),null==i&&(i=1),e<t&&(e=t),e>i&&(e=i),e},Ae=function(e){return e.length>=3?Array.prototype.slice.call(e):e[0]},w=function(e){var t,i;for(e._clipped=!1,e._unclipped=e.slice(0),t=i=0;i<3;t=++i)t<3?((e[t]<0||e[t]>255)&&(e._clipped=!0),e[t]<0&&(e[t]=0),e[t]>255&&(e[t]=255)):3===t&&(e[t]<0&&(e[t]=0),e[t]>1&&(e[t]=1));return e._clipped||delete e._unclipped,e},s=Math.PI,ye=Math.round,A=Math.cos,I=Math.floor,ie=Math.pow,Y=Math.log,be=Math.sin,_e=Math.sqrt,p=Math.atan2,Q=Math.max,m=Math.abs,c=2*s,o=s/3,n=s/180,a=180/s,_=function(){return arguments[0]instanceof i?arguments[0]:function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,arguments,(function(){}))},_.default=_,f=[],null!==e&&null!=e.exports&&(e.exports=_),(null!==t?t:this).chroma=_,_.version="1.4.1",d={},h=[],u=!1,i=function(){function e(){var e,t,i,n,r,s,o,a,c;for(s=this,t=[],a=0,n=arguments.length;a<n;a++)null!=(e=arguments[a])&&t.push(e);if(t.length>1&&(o=t[t.length-1]),null!=d[o])s._rgb=w(d[o](Ae(t.slice(0,-1))));else{for(u||(h=h.sort((function(e,t){return t.p-e.p})),u=!0),c=0,r=h.length;c<r&&!(o=(i=h[c]).test.apply(i,t));c++);o&&(s._rgb=w(d[o].apply(d,t)))}null==s._rgb&&console.warn("unknown format: "+t),null==s._rgb&&(s._rgb=[0,0,0]),3===s._rgb.length&&s._rgb.push(1)}return e.prototype.toString=function(){return this.hex()},e}(),_._input=d,
/**
	  	ColorBrewer colors for chroma.js
	  
	  	Copyright (c) 2002 Cynthia Brewer, Mark Harrower, and The 
	  	Pennsylvania State University.
	  
	  	Licensed under the Apache License, Version 2.0 (the "License"); 
	  	you may not use this file except in compliance with the License.
	  	You may obtain a copy of the License at	
	  	http://www.apache.org/licenses/LICENSE-2.0
	  
	  	Unless required by applicable law or agreed to in writing, software distributed
	  	under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
	  	CONDITIONS OF ANY KIND, either express or implied. See the License for the
	  	specific language governing permissions and limitations under the License.
	  
	      @preserve
	   */
_.brewer=x={OrRd:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],PuBu:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],BuPu:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],Oranges:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],BuGn:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],YlGn:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],Reds:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],RdPu:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],Greens:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],YlGnBu:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],Purples:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],GnBu:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],Greys:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],YlOrRd:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],PuRd:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],Blues:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],PuBuGn:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],Viridis:["#440154","#482777","#3f4a8a","#31678e","#26838f","#1f9d8a","#6cce5a","#b6de2b","#fee825"],Spectral:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],RdYlGn:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],RdBu:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],PiYG:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"],PRGn:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"],RdYlBu:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],BrBG:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],RdGy:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],PuOr:["#7f3b08","#b35806","#e08214","#fdb863","#fee0b6","#f7f7f7","#d8daeb","#b2abd2","#8073ac","#542788","#2d004b"],Set2:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],Accent:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],Set1:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],Set3:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],Dark2:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],Paired:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],Pastel2:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],Pastel1:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]},function(){var e,t;for(e in t=[],x)t.push(x[e.toLowerCase()]=x[e])}(),_.colors=Me={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflower:"#6495ed",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",laserlemon:"#ffff54",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrod:"#fafad2",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",maroon2:"#7f0000",maroon3:"#b03060",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",purple2:"#7f007f",purple3:"#a020f0",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},V=function(){var e,t,i,n,s,o,a;return n=(t=Ae(arguments))[0],e=t[1],i=t[2],o=(n+16)/116,s=isNaN(e)?o:o+e/500,a=isNaN(i)?o:o-i/200,o=r.Yn*H(o),s=r.Xn*H(s),a=r.Zn*H(a),[Pe(3.2404542*s-1.5371385*o-.4985314*a),Pe(-.969266*s+1.8760108*o+.041556*a),i=Pe(.0556434*s-.2040259*o+1.0572252*a),t.length>3?t[3]:1]},Pe=function(e){return 255*(e<=.00304?12.92*e:1.055*ie(e,1/2.4)-.055)},H=function(e){return e>r.t1?e*e*e:r.t2*(e-r.t0)},r={Kn:18,Xn:.95047,Yn:1,Zn:1.08883,t0:.137931034,t1:.206896552,t2:.12841855,t3:.008856452},he=function(){var e,t,i,n,r,s,o;return i=(n=Ae(arguments))[0],t=n[1],e=n[2],s=(r=pe(i,t,e))[0],[116*(o=r[1])-16,500*(s-o),200*(o-r[2])]},ge=function(e){return(e/=255)<=.04045?e/12.92:ie((e+.055)/1.055,2.4)},Ce=function(e){return e>r.t3?ie(e,1/3):e/r.t2+r.t0},pe=function(){var e,t,i,n;return i=(n=Ae(arguments))[0],t=n[1],e=n[2],i=ge(i),t=ge(t),e=ge(e),[Ce((.4124564*i+.3575761*t+.1804375*e)/r.Xn),Ce((.2126729*i+.7151522*t+.072175*e)/r.Yn),Ce((.0193339*i+.119192*t+.9503041*e)/r.Zn)]},_.lab=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["lab"]),(function(){}))},d.lab=V,i.prototype.lab=function(){return he(this._rgb)},g=function(e){var t,i,n,r,s,o,a,c,l,h,u;return 2===(e=function(){var t,i,n;for(n=[],i=0,t=e.length;i<t;i++)r=e[i],n.push(_(r));return n}()).length?(l=function(){var t,i,n;for(n=[],i=0,t=e.length;i<t;i++)r=e[i],n.push(r.lab());return n}(),s=l[0],o=l[1],t=function(e){var t,i;return i=function(){var i,n;for(n=[],t=i=0;i<=2;t=++i)n.push(s[t]+e*(o[t]-s[t]));return n}(),_.lab.apply(_,i)}):3===e.length?(h=function(){var t,i,n;for(n=[],i=0,t=e.length;i<t;i++)r=e[i],n.push(r.lab());return n}(),s=h[0],o=h[1],a=h[2],t=function(e){var t,i;return i=function(){var i,n;for(n=[],t=i=0;i<=2;t=++i)n.push((1-e)*(1-e)*s[t]+2*(1-e)*e*o[t]+e*e*a[t]);return n}(),_.lab.apply(_,i)}):4===e.length?(u=function(){var t,i,n;for(n=[],i=0,t=e.length;i<t;i++)r=e[i],n.push(r.lab());return n}(),s=u[0],o=u[1],a=u[2],c=u[3],t=function(e){var t,i;return i=function(){var i,n;for(n=[],t=i=0;i<=2;t=++i)n.push((1-e)*(1-e)*(1-e)*s[t]+3*(1-e)*(1-e)*e*o[t]+3*(1-e)*e*e*a[t]+e*e*e*c[t]);return n}(),_.lab.apply(_,i)}):5===e.length&&(i=g(e.slice(0,3)),n=g(e.slice(2,5)),t=function(e){return e<.5?i(2*e):n(2*(e-.5))}),t},_.bezier=function(e){var t;return(t=g(e)).scale=function(){return _.scale(t)},t},_.cubehelix=function(e,t,i,n,r){var s,o,a;return null==e&&(e=300),null==t&&(t=-1.5),null==i&&(i=1),null==n&&(n=1),null==r&&(r=[0,1]),s=0,"array"===Se(r)?o=r[1]-r[0]:(o=0,r=[r,r]),(a=function(a){var l,h,u,d,f;return l=c*((e+120)/360+t*a),d=ie(r[0]+o*a,n),h=(0!==s?i[0]+a*s:i)*d*(1-d)/2,u=A(l),f=be(l),_(w([255*(d+h*(-.14861*u+1.78277*f)),255*(d+h*(-.29227*u-.90649*f)),255*(d+h*(1.97294*u)),1]))}).start=function(t){return null==t?e:(e=t,a)},a.rotations=function(e){return null==e?t:(t=e,a)},a.gamma=function(e){return null==e?n:(n=e,a)},a.hue=function(e){return null==e?i:("array"===Se(i=e)?0===(s=i[1]-i[0])&&(i=i[1]):s=0,a)},a.lightness=function(e){return null==e?r:("array"===Se(e)?(r=e,o=e[1]-e[0]):(r=[e,e],o=0),a)},a.scale=function(){return _.scale(a)},a.hue(i),a},_.random=function(){var e,t;for("0123456789abcdef",e="#",t=0;t<6;++t)e+="0123456789abcdef".charAt(I(16*Math.random()));return new i(e)},f=[],B=function(e,t,i,n){var r,s,o,a;for(null==i&&(i=.5),null==n&&(n="rgb"),"object"!==Se(e)&&(e=_(e)),"object"!==Se(t)&&(t=_(t)),o=0,s=f.length;o<s;o++)if(n===(r=f[o])[0]){a=r[1](e,t,i,n);break}if(null==a)throw"color mode "+n+" is not supported";return a.alpha(e.alpha()+i*(t.alpha()-e.alpha()))},_.interpolate=B,i.prototype.interpolate=function(e,t,i){return B(this,e,t,i)},_.mix=B,i.prototype.mix=i.prototype.interpolate,d.rgb=function(){var e,t,i,n;for(e in i=[],t=Ae(arguments))n=t[e],i.push(n);return i},_.rgb=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["rgb"]),(function(){}))},i.prototype.rgb=function(e){return null==e&&(e=!0),e?this._rgb.map(Math.round).slice(0,3):this._rgb.slice(0,3)},i.prototype.rgba=function(e){return null==e&&(e=!0),e?[Math.round(this._rgb[0]),Math.round(this._rgb[1]),Math.round(this._rgb[2]),this._rgb[3]]:this._rgb.slice(0)},h.push({p:3,test:function(e){var t;return t=Ae(arguments),"array"===Se(t)&&3===t.length||4===t.length&&"number"===Se(t[3])&&t[3]>=0&&t[3]<=1?"rgb":void 0}}),d.lrgb=d.rgb,z=function(e,t,n,r){var s,o;return s=e._rgb,o=t._rgb,new i(_e(ie(s[0],2)*(1-n)+ie(o[0],2)*n),_e(ie(s[1],2)*(1-n)+ie(o[1],2)*n),_e(ie(s[2],2)*(1-n)+ie(o[2],2)*n),r)},l=function(e){var t,n,r,s,o;for(t=1/e.length,o=[0,0,0,0],r=0,n=e.length;r<n;r++)s=e[r]._rgb,o[0]+=ie(s[0],2)*t,o[1]+=ie(s[1],2)*t,o[2]+=ie(s[2],2)*t,o[3]+=s[3]*t;return o[0]=_e(o[0]),o[1]=_e(o[1]),o[2]=_e(o[2]),o[3]>1&&(o[3]=1),new i(w(o))},f.push(["lrgb",z]),_.average=function(e,t){var i,n,r,o,a,c,h,u,d,f,m,g,v;if(null==t&&(t="rgb"),d=e.length,e=e.map((function(e){return _(e)})),h=e.splice(0,1)[0],"lrgb"===t)return l(e);for(u in o=[],a=0,c=0,g=h.get(t))g[u]=g[u]||0,o.push(isNaN(g[u])?0:1),"h"!==t.charAt(u)||isNaN(g[u])||(i=g[u]/180*s,a+=A(i),c+=be(i));for(n=h.alpha(),m=0,f=e.length;m<f;m++)for(u in v=(r=e[m]).get(t),n+=r.alpha(),g)isNaN(v[u])||(o[u]+=1,"h"===t.charAt(u)?(i=v[u]/180*s,a+=A(i),c+=be(i)):g[u]+=v[u]);for(u in g)if("h"===t.charAt(u)){for(i=p(c/o[u],a/o[u])/s*180;i<0;)i+=360;for(;i>=360;)i-=360;g[u]=i}else g[u]=g[u]/o[u];return _(g,t).alpha(n/d)},D=function(e){var t,i;if(e.match(/^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/))return 4!==e.length&&7!==e.length||(e=e.substr(1)),3===e.length&&(e=(e=e.split(""))[0]+e[0]+e[1]+e[1]+e[2]+e[2]),[(i=parseInt(e,16))>>16,i>>8&255,255&i,1];if(e.match(/^#?([A-Fa-f0-9]{8})$/))return 9===e.length&&(e=e.substr(1)),[(i=parseInt(e,16))>>24&255,i>>16&255,i>>8&255,ye((255&i)/255*100)/100];if(null!=d.css&&(t=d.css(e)))return t;throw"unknown color: "+e},oe=function(e,t){var i,n,r,s,o,a;return null==t&&(t="auto"),o=e[0],r=e[1],n=e[2],i=e[3],"auto"===t&&(t=i<1?"rgba":"rgb"),o=Math.round(o),r=Math.round(r),n=Math.round(n),a=(a="000000"+(o<<16|r<<8|n).toString(16)).substr(a.length-6),s=(s="0"+ye(255*i).toString(16)).substr(s.length-2),"#"+function(){switch(t.toLowerCase()){case"rgba":return a+s;case"argb":return s+a;default:return a}}()},d.hex=function(e){return D(e)},_.hex=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["hex"]),(function(){}))},i.prototype.hex=function(e){return null==e&&(e="auto"),oe(this._rgb,e)},h.push({p:4,test:function(e){if(1===arguments.length&&"string"===Se(e))return"hex"}}),k=function(){var e,t,i,n,r,s,o,a,c,l,h,u,d,f;if(r=(e=Ae(arguments))[0],h=e[1],o=e[2],0===h)c=n=t=255*o;else{for(i=[0,0,0],u=2*o-(d=o<.5?o*(1+h):o+h-o*h),(f=[0,0,0])[0]=(r/=360)+1/3,f[1]=r,f[2]=r-1/3,s=a=0;a<=2;s=++a)f[s]<0&&(f[s]+=1),f[s]>1&&(f[s]-=1),6*f[s]<1?i[s]=u+6*(d-u)*f[s]:2*f[s]<1?i[s]=d:3*f[s]<2?i[s]=u+(d-u)*(2/3-f[s])*6:i[s]=u;c=(l=[ye(255*i[0]),ye(255*i[1]),ye(255*i[2])])[0],n=l[1],t=l[2]}return e.length>3?[c,n,t,e[3]]:[c,n,t]},ce=function(e,t,i){var n,r,s,o,a;return void 0!==e&&e.length>=3&&(e=(o=e)[0],t=o[1],i=o[2]),e/=255,t/=255,i/=255,s=Math.min(e,t,i),r=((Q=Math.max(e,t,i))+s)/2,Q===s?(a=0,n=Number.NaN):a=r<.5?(Q-s)/(Q+s):(Q-s)/(2-Q-s),e===Q?n=(t-i)/(Q-s):t===Q?n=2+(i-e)/(Q-s):i===Q&&(n=4+(e-t)/(Q-s)),(n*=60)<0&&(n+=360),[n,a,r]},_.hsl=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["hsl"]),(function(){}))},d.hsl=k,i.prototype.hsl=function(){return ce(this._rgb)},O=function(){var e,t,i,n,r,s,o,a,c,l,h,u,d,f,m,p,g,v;if(r=(e=Ae(arguments))[0],p=e[1],v=e[2],v*=255,0===p)c=n=t=v;else switch(360===r&&(r=0),r>360&&(r-=360),r<0&&(r+=360),o=v*(1-p),a=v*(1-p*(i=(r/=60)-(s=I(r)))),g=v*(1-p*(1-i)),s){case 0:c=(l=[v,g,o])[0],n=l[1],t=l[2];break;case 1:c=(h=[a,v,o])[0],n=h[1],t=h[2];break;case 2:c=(u=[o,v,g])[0],n=u[1],t=u[2];break;case 3:c=(d=[o,a,v])[0],n=d[1],t=d[2];break;case 4:c=(f=[g,o,v])[0],n=f[1],t=f[2];break;case 5:c=(m=[v,o,a])[0],n=m[1],t=m[2]}return[c,n,t,e.length>3?e[3]:1]},le=function(){var e,t,i,n,r,s,o,a,c;return s=(o=Ae(arguments))[0],i=o[1],e=o[2],r=Math.min(s,i,e),t=(Q=Math.max(s,i,e))-r,c=Q/255,0===Q?(n=Number.NaN,a=0):(a=t/Q,s===Q&&(n=(i-e)/t),i===Q&&(n=2+(e-s)/t),e===Q&&(n=4+(s-i)/t),(n*=60)<0&&(n+=360)),[n,a,c]},_.hsv=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["hsv"]),(function(){}))},d.hsv=O,i.prototype.hsv=function(){return le(this._rgb)},ee=function(e){return"number"===Se(e)&&e>=0&&e<=16777215?[e>>16,e>>8&255,255&e,1]:(console.warn("unknown num color: "+e),[0,0,0,1])},fe=function(){var e;return((e=Ae(arguments))[0]<<16)+(e[1]<<8)+e[2]},_.num=function(e){return new i(e,"num")},i.prototype.num=function(e){return null==e&&(e="rgb"),fe(this._rgb,e)},d.num=ee,h.push({p:1,test:function(e){if(1===arguments.length&&"number"===Se(e)&&e>=0&&e<=16777215)return"num"}}),E=function(){var e,t,i,n,r,s,o,a,c,l,h,u,d,f,m,p,g,v,y,x;if(a=(i=Ae(arguments))[0],r=i[1],t=i[2],o=o/100*255,e=255*(r/=100),0===r)u=o=n=t;else switch(360===a&&(a=0),a>360&&(a-=360),a<0&&(a+=360),h=(l=t*(1-r))+e*(1-(s=(a/=60)-(c=I(a)))),y=l+e*s,x=l+e,c){case 0:u=(d=[x,y,l])[0],o=d[1],n=d[2];break;case 1:u=(f=[h,x,l])[0],o=f[1],n=f[2];break;case 2:u=(m=[l,x,y])[0],o=m[1],n=m[2];break;case 3:u=(p=[l,h,x])[0],o=p[1],n=p[2];break;case 4:u=(g=[y,l,x])[0],o=g[1],n=g[2];break;case 5:u=(v=[x,l,h])[0],o=v[1],n=v[2]}return[u,o,n,i.length>3?i[3]:1]},se=function(){var e,t,i,n,r,s,o,a,c;return a=(c=Ae(arguments))[0],r=c[1],t=c[2],o=Math.min(a,r,t),i=100*(n=(Q=Math.max(a,r,t))-o)/255,e=o/(255-n)*100,0===n?s=Number.NaN:(a===Q&&(s=(r-t)/n),r===Q&&(s=2+(t-a)/n),t===Q&&(s=4+(a-r)/n),(s*=60)<0&&(s+=360)),[s,i,e]},_.hcg=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["hcg"]),(function(){}))},d.hcg=E,i.prototype.hcg=function(){return se(this._rgb)},M=function(e){var t,i,n,r,s,o,a,c;if(e=e.toLowerCase(),null!=_.colors&&_.colors[e])return D(_.colors[e]);if(s=e.match(/rgb\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*\)/)){for(a=s.slice(1,4),r=o=0;o<=2;r=++o)a[r]=+a[r];a[3]=1}else if(s=e.match(/rgba\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*,\s*([01]|[01]?\.\d+)\)/))for(a=s.slice(1,5),r=c=0;c<=3;r=++c)a[r]=+a[r];else if(s=e.match(/rgb\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/)){for(a=s.slice(1,4),r=t=0;t<=2;r=++t)a[r]=ye(2.55*a[r]);a[3]=1}else if(s=e.match(/rgba\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/)){for(a=s.slice(1,5),r=i=0;i<=2;r=++i)a[r]=ye(2.55*a[r]);a[3]=+a[3]}else(s=e.match(/hsl\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/))?((n=s.slice(1,4))[1]*=.01,n[2]*=.01,(a=k(n))[3]=1):(s=e.match(/hsla\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/))&&((n=s.slice(1,4))[1]*=.01,n[2]*=.01,(a=k(n))[3]=+s[4]);return a},re=function(e){var t;return"rgb"===(t=e[3]<1?"rgba":"rgb")?t+"("+e.slice(0,3).map(ye).join(",")+")":"rgba"===t?t+"("+e.slice(0,3).map(ye).join(",")+","+e[3]+")":void 0},ve=function(e){return ye(100*e)/100},R=function(e,t){var i;return i=t<1?"hsla":"hsl",e[0]=ve(e[0]||0),e[1]=ve(100*e[1])+"%",e[2]=ve(100*e[2])+"%","hsla"===i&&(e[3]=t),i+"("+e.join(",")+")"},d.css=function(e){return M(e)},_.css=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["css"]),(function(){}))},i.prototype.css=function(e){return null==e&&(e="rgb"),"rgb"===e.slice(0,3)?re(this._rgb):"hsl"===e.slice(0,3)?R(this.hsl(),this.alpha()):void 0},d.named=function(e){return D(Me[e])},h.push({p:5,test:function(e){if(1===arguments.length&&null!=Me[e])return"named"}}),i.prototype.name=function(e){var t,i;for(i in arguments.length&&(Me[e]&&(this._rgb=D(Me[e])),this._rgb[3]=1),t=this.hex("rgb"),Me)if(t===Me[i])return i;return t},j=function(){var e,t,i,r;return i=(r=Ae(arguments))[0],e=r[1],t=r[2],[i,A(t*=n)*e,be(t)*e]},W=function(){var e,t,i,n,r,s,o,a,c;return o=(i=Ae(arguments))[0],r=i[1],s=i[2],e=(a=j(o,r,s))[0],t=a[1],n=a[2],[(c=V(e,t,n))[0],c[1],n=c[2],i.length>3?i[3]:1]},G=function(){var e,t,i,n,r,s;return r=(s=Ae(arguments))[0],e=s[1],t=s[2],i=_e(e*e+t*t),n=(p(t,e)*a+360)%360,0===ye(1e4*i)&&(n=Number.NaN),[r,i,n]},ue=function(){var e,t,i,n,r,s,o;return r=(s=Ae(arguments))[0],i=s[1],t=s[2],n=(o=he(r,i,t))[0],e=o[1],t=o[2],G(n,e,t)},_.lch=function(){var e;return e=Ae(arguments),new i(e,"lch")},_.hcl=function(){var e;return e=Ae(arguments),new i(e,"hcl")},d.lch=W,d.hcl=function(){var e,t,i,n;return t=(n=Ae(arguments))[0],e=n[1],i=n[2],W([i,e,t])},i.prototype.lch=function(){return ue(this._rgb)},i.prototype.hcl=function(){return ue(this._rgb).reverse()},ne=function(e){var t,i,n,r,s,o;return null==e&&(e="rgb"),s=(o=Ae(arguments))[0],n=o[1],t=o[2],n/=255,t/=255,[(1-(s/=255)-(r=1-Math.max(s,Math.max(n,t))))*(i=r<1?1/(1-r):0),(1-n-r)*i,(1-t-r)*i,r]},S=function(){var e,t,i,n,r,s;return i=(t=Ae(arguments))[0],r=t[1],s=t[2],n=t[3],e=t.length>4?t[4]:1,1===n?[0,0,0,e]:[i>=1?0:255*(1-i)*(1-n),r>=1?0:255*(1-r)*(1-n),s>=1?0:255*(1-s)*(1-n),e]},d.cmyk=function(){return S(Ae(arguments))},_.cmyk=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["cmyk"]),(function(){}))},i.prototype.cmyk=function(){return ne(this._rgb)},d.gl=function(){var e,t,i,n,r;for(n=function(){var e,i;for(t in i=[],e=Ae(arguments))r=e[t],i.push(r);return i}.apply(this,arguments),e=i=0;i<=2;e=++i)n[e]*=255;return n},_.gl=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["gl"]),(function(){}))},i.prototype.gl=function(){var e;return[(e=this._rgb)[0]/255,e[1]/255,e[2]/255,e[3]]},de=function(e,t,i){var n;return e=(n=Ae(arguments))[0],t=n[1],i=n[2],.2126*(e=Z(e))+.7152*(t=Z(t))+.0722*(i=Z(i))},Z=function(e){return(e/=255)<=.03928?e/12.92:ie((e+.055)/1.055,2.4)},$=function(e,t,n,r){var s,o;return s=e._rgb,o=t._rgb,new i(s[0]+n*(o[0]-s[0]),s[1]+n*(o[1]-s[1]),s[2]+n*(o[2]-s[2]),r)},f.push(["rgb",$]),i.prototype.luminance=function(e,t){var i,n,r,s;return null==t&&(t="rgb"),arguments.length?(r=this._rgb,0===e?r=[0,0,0,this._rgb[3]]:1===e?r=[255,255,255,this[3]]:(i=de(this._rgb),1e-7,n=20,s=function(i,r){var o,a;return o=(a=i.interpolate(r,.5,t)).luminance(),Math.abs(e-o)<1e-7||!n--?a:o>e?s(i,a):s(a,r)},r=i>e?s(_("black"),this).rgba():s(this,_("white")).rgba()),_(r).alpha(this.alpha())):de(this._rgb)},we=function(e){var t,i,n,r;return(r=e/100)<66?(n=255,i=-155.25485562709179-.44596950469579133*(i=r-2)+104.49216199393888*Y(i),t=r<20?0:.8274096064007395*(t=r-10)-254.76935184120902+115.67994401066147*Y(t)):(n=351.97690566805693+.114206453784165*(n=r-55)-40.25366309332127*Y(n),i=325.4494125711974+.07943456536662342*(i=r-50)-28.0852963507957*Y(i),t=255),[n,i,t]},me=function(){var e,t,i,n,r,s,o;for(n=(r=Ae(arguments))[0],e=r[2],i=1e3,t=4e4,.4;t-i>.4;)(s=we(o=.5*(t+i)))[2]/s[0]>=e/n?t=o:i=o;return ye(o)},_.temperature=_.kelvin=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["temperature"]),(function(){}))},d.temperature=d.kelvin=d.K=we,i.prototype.temperature=function(){return me(this._rgb)},i.prototype.kelvin=i.prototype.temperature,_.contrast=function(e,t){var n,r,s,o;return"string"!==(s=Se(e))&&"number"!==s||(e=new i(e)),"string"!==(o=Se(t))&&"number"!==o||(t=new i(t)),(n=e.luminance())>(r=t.luminance())?(n+.05)/(r+.05):(r+.05)/(n+.05)},_.distance=function(e,t,n){var r,s,o,a,c,l,h;for(s in null==n&&(n="lab"),"string"!==(c=Se(e))&&"number"!==c||(e=new i(e)),"string"!==(l=Se(t))&&"number"!==l||(t=new i(t)),o=e.get(n),a=t.get(n),h=0,o)h+=(r=(o[s]||0)-(a[s]||0))*r;return Math.sqrt(h)},_.deltaE=function(e,t,n,r){var o,a,c,l,h,u,d,f,g,v,y,x,b,_,w,S,M,C,P,T,I,E,D,L;for(null==n&&(n=1),null==r&&(r=1),"string"!==(w=Se(e))&&"number"!==w||(e=new i(e)),"string"!==(S=Se(t))&&"number"!==S||(t=new i(t)),o=(M=e.lab())[0],c=M[1],h=M[2],a=(C=t.lab())[0],l=C[1],u=C[2],d=_e(c*c+h*h),f=_e(l*l+u*u),T=o<16?.511:.040975*o/(1+.01765*o),P=.0638*d/(1+.0131*d)+.638,_=d<1e-6?0:180*p(h,c)/s;_<0;)_+=360;for(;_>=360;)_-=360;return I=_>=164&&_<=345?.56+m(.2*A(s*(_+168)/180)):.36+m(.4*A(s*(_+35)/180)),b=_e((g=d*d*d*d)/(g+1900)),_e((E=(o-a)/(n*T))*E+(D=(x=d-f)/(r*P))*D+((v=c-l)*v+(y=h-u)*y-x*x)/((L=P*(b*I+1-b))*L))},i.prototype.get=function(e){var t,i,n,r,s;return this,n=(r=e.split("."))[0],t=r[1],s=this[n](),t?(i=n.indexOf(t))>-1?s[i]:console.warn("unknown channel "+t+" in mode "+n):s},i.prototype.set=function(e,t){var i,n,r,s,o;if(this,r=(s=e.split("."))[0],i=s[1])if(o=this[r](),(n=r.indexOf(i))>-1)if("string"===Se(t))switch(t.charAt(0)){case"+":case"-":o[n]+=+t;break;case"*":o[n]*=+t.substr(1);break;case"/":o[n]/=+t.substr(1);break;default:o[n]=+t}else o[n]=t;else console.warn("unknown channel "+i+" in mode "+r);else o=t;return _(o,r).alpha(this.alpha())},i.prototype.clipped=function(){return this._rgb._clipped||!1},i.prototype.alpha=function(e){return arguments.length?_.rgb([this._rgb[0],this._rgb[1],this._rgb[2],e]):this._rgb[3]},i.prototype.darken=function(e){var t;return null==e&&(e=1),this,(t=this.lab())[0]-=r.Kn*e,_.lab(t).alpha(this.alpha())},i.prototype.brighten=function(e){return null==e&&(e=1),this.darken(-e)},i.prototype.darker=i.prototype.darken,i.prototype.brighter=i.prototype.brighten,i.prototype.saturate=function(e){var t;return null==e&&(e=1),this,(t=this.lch())[1]+=e*r.Kn,t[1]<0&&(t[1]=0),_.lch(t).alpha(this.alpha())},i.prototype.desaturate=function(e){return null==e&&(e=1),this.saturate(-e)},i.prototype.premultiply=function(){var e,t;return t=this.rgb(),e=this.alpha(),_(t[0]*e,t[1]*e,t[2]*e,e)},J=function(e,t){return e*t/255},C=function(e,t){return e>t?t:e},q=function(e,t){return e>t?e:t},xe=function(e,t){return 255*(1-(1-e/255)*(1-t/255))},te=function(e,t){return t<128?2*e*t/255:255*(1-2*(1-e/255)*(1-t/255))},b=function(e,t){return 255*(1-(1-t/255)/(e/255))},P=function(e,t){return 255===e||(e=t/255*255/(1-e/255))>255?255:e},(v=function(e,t,i){if(!v[i])throw"unknown blend mode "+i;return v[i](e,t)}).normal=(y=function(e){return function(t,i){var n,r;return n=_(i).rgb(),r=_(t).rgb(),_(e(n,r),"rgb")}})((T=function(e){return function(t,i){var n,r,s;for(s=[],n=r=0;r<=3;n=++r)s[n]=e(t[n],i[n]);return s}})((function(e,t){return e}))),v.multiply=y(T(J)),v.screen=y(T(xe)),v.overlay=y(T(te)),v.darken=y(T(C)),v.lighten=y(T(q)),v.dodge=y(T(P)),v.burn=y(T(b)),_.blend=v,_.analyze=function(e){var t,i,n,r;for(n={min:Number.MAX_VALUE,max:-1*Number.MAX_VALUE,sum:0,values:[],count:0},i=0,t=e.length;i<t;i++)null==(r=e[i])||isNaN(r)||(n.values.push(r),n.sum+=r,r<n.min&&(n.min=r),r>n.max&&(n.max=r),n.count+=1);return n.domain=[n.min,n.max],n.limits=function(e,t){return _.limits(n,e,t)},n},_.scale=function(e,t){var i,n,r,s,o,a,c,l,h,u,d,f,m,p,g,v,y,x,b,w,S;return h="rgb",u=_("#ccc"),p=0,o=[0,1],m=[],f=[0,0],i=!1,r=[],d=!1,l=0,c=1,s=!1,n={},g=!0,a=1,w=function(e){var t,i,n,s,o,a;if(null==e&&(e=["#fff","#000"]),null!=e&&"string"===Se(e)&&null!=_.brewer&&(e=_.brewer[e]||_.brewer[e.toLowerCase()]||e),"array"===Se(e)){for(1===e.length&&(e=[e[0],e[0]]),t=n=0,s=(e=e.slice(0)).length-1;0<=s?n<=s:n>=s;t=0<=s?++n:--n)i=e[t],"string"===Se(i)&&(e[t]=_(i));for(m.length=0,t=a=0,o=e.length-1;0<=o?a<=o:a>=o;t=0<=o?++a:--a)m.push(t/(e.length-1))}return b(),r=e},y=function(e){var t,n;if(null!=i){for(n=i.length-1,t=0;t<n&&e>=i[t];)t++;return t-1}return 0},S=function(e){return e},x=function(e,t){var s,o,d,p,v,x,b;if(null==t&&(t=!1),isNaN(e)||null===e)return u;if(b=t?e:i&&i.length>2?y(e)/(i.length-2):c!==l?(e-l)/(c-l):1,t||(b=S(b)),1!==a&&(b=ie(b,a)),b=f[0]+b*(1-f[0]-f[1]),b=Math.min(1,Math.max(0,b)),d=Math.floor(1e4*b),g&&n[d])s=n[d];else{if("array"===Se(r))for(o=p=0,x=m.length-1;0<=x?p<=x:p>=x;o=0<=x?++p:--p){if(b<=(v=m[o])){s=r[o];break}if(b>=v&&o===m.length-1){s=r[o];break}if(b>v&&b<m[o+1]){b=(b-v)/(m[o+1]-v),s=_.interpolate(r[o],r[o+1],b,h);break}}else"function"===Se(r)&&(s=r(b));g&&(n[d]=s)}return s},b=function(){return n={}},w(e),(v=function(e){var t;return t=_(x(e)),d&&t[d]?t[d]():t}).classes=function(e){var t;return null!=e?("array"===Se(e)?(i=e,o=[e[0],e[e.length-1]]):(t=_.analyze(o),i=0===e?[t.min,t.max]:_.limits(t,"e",e)),v):i},v.domain=function(e){var t,i,n,s,a,h,u;if(!arguments.length)return o;if(l=e[0],c=e[e.length-1],m=[],n=r.length,e.length===n&&l!==c)for(a=0,s=e.length;a<s;a++)i=e[a],m.push((i-l)/(c-l));else for(t=u=0,h=n-1;0<=h?u<=h:u>=h;t=0<=h?++u:--u)m.push(t/(n-1));return o=[l,c],v},v.mode=function(e){return arguments.length?(h=e,b(),v):h},v.range=function(e,t){return w(e),v},v.out=function(e){return d=e,v},v.spread=function(e){return arguments.length?(p=e,v):p},v.correctLightness=function(e){return null==e&&(e=!0),s=e,b(),S=s?function(e){var t,i,n,r,s,o,a,c,l;for(t=x(0,!0).lab()[0],i=x(1,!0).lab()[0],a=t>i,n=x(e,!0).lab()[0],r=n-(s=t+(i-t)*e),c=0,l=1,o=20;Math.abs(r)>.01&&o-- >0;)a&&(r*=-1),r<0?(c=e,e+=.5*(l-e)):(l=e,e+=.5*(c-e)),n=x(e,!0).lab()[0],r=n-s;return e}:function(e){return e},v},v.padding=function(e){return null!=e?("number"===Se(e)&&(e=[e,e]),f=e,v):f},v.colors=function(t,n){var s,a,c,l,h,u,d,f;if(arguments.length<2&&(n="hex"),h=[],0===arguments.length)h=r.slice(0);else if(1===t)h=[v(.5)];else if(t>1)a=o[0],s=o[1]-a,h=function(){u=[];for(var e=0;0<=t?e<t:e>t;0<=t?e++:e--)u.push(e);return u}.apply(this).map((function(e){return v(a+e/(t-1)*s)}));else{if(e=[],d=[],i&&i.length>2)for(c=f=1,l=i.length;1<=l?f<l:f>l;c=1<=l?++f:--f)d.push(.5*(i[c-1]+i[c]));else d=o;h=d.map((function(e){return v(e)}))}return _[n]&&(h=h.map((function(e){return e[n]()}))),h},v.cache=function(e){return null!=e?(g=e,v):g},v.gamma=function(e){return null!=e?(a=e,v):a},v.nodata=function(e){return null!=e?(u=_(e),v):u},v},null==_.scales&&(_.scales={}),_.scales.cool=function(){return _.scale([_.hsl(180,1,.9),_.hsl(250,.7,.4)])},_.scales.hot=function(){return _.scale(["#000","#f00","#ff0","#fff"],[0,.25,.75,1]).mode("rgb")},_.analyze=function(e,t,i){var n,r,s,o,a,c;if(a={min:Number.MAX_VALUE,max:-1*Number.MAX_VALUE,sum:0,values:[],count:0},null==i&&(i=function(){return!0}),n=function(e){null==e||isNaN(e)||(a.values.push(e),a.sum+=e,e<a.min&&(a.min=e),e>a.max&&(a.max=e),a.count+=1)},c=function(e,r){if(i(e,r))return null!=t&&"function"===Se(t)?n(t(e)):null!=t&&"string"===Se(t)||"number"===Se(t)?n(e[t]):n(e)},"array"===Se(e))for(o=0,s=e.length;o<s;o++)c(e[o]);else for(r in e)c(e[r],r);return a.domain=[a.min,a.max],a.limits=function(e,t){return _.limits(a,e,t)},a},_.limits=function(e,t,i){var n,r,s,o,a,c,l,h,u,d,f,p,g,v,y,x,b,w,S,A,M,C,P,T,E,D,L,R,k,O,B,N,F,z,U,$,G,V,H,j,W,q,X,Z,K,J,ee,te,ne,re,se,oe,ae,ce,le;if(null==t&&(t="equal"),null==i&&(i=7),"array"===Se(e)&&(e=_.analyze(e)),E=e.min,Q=e.max,ce=e.values.sort((function(e,t){return e-t})),1===i)return[E,Q];if(P=[],"c"===t.substr(0,1)&&(P.push(E),P.push(Q)),"e"===t.substr(0,1)){for(P.push(E),A=B=1,U=i-1;1<=U?B<=U:B>=U;A=1<=U?++B:--B)P.push(E+A/i*(Q-E));P.push(Q)}else if("l"===t.substr(0,1)){if(E<=0)throw"Logarithmic scales are only possible for values > 0";for(D=Math.LOG10E*Y(E),T=Math.LOG10E*Y(Q),P.push(E),A=le=1,$=i-1;1<=$?le<=$:le>=$;A=1<=$?++le:--le)P.push(ie(10,D+A/i*(T-D)));P.push(Q)}else if("q"===t.substr(0,1)){for(P.push(E),A=n=1,q=i-1;1<=q?n<=q:n>=q;A=1<=q?++n:--n)N=(ce.length-1)*A/i,(F=I(N))===N?P.push(ce[F]):(z=N-F,P.push(ce[F]*(1-z)+ce[F+1]*z));P.push(Q)}else if("k"===t.substr(0,1)){for(R=ce.length,v=new Array(R),w=new Array(i),re=!0,k=0,x=null,(x=[]).push(E),A=r=1,X=i-1;1<=X?r<=X:r>=X;A=1<=X?++r:--r)x.push(E+A/i*(Q-E));for(x.push(Q);re;){for(M=s=0,Z=i-1;0<=Z?s<=Z:s>=Z;M=0<=Z?++s:--s)w[M]=0;for(A=o=0,K=R-1;0<=K?o<=K:o>=K;A=0<=K?++o:--o){for(ae=ce[A],L=Number.MAX_VALUE,M=a=0,J=i-1;0<=J?a<=J:a>=J;M=0<=J?++a:--a)(S=m(x[M]-ae))<L&&(L=S,y=M);w[y]++,v[A]=y}for(O=new Array(i),M=c=0,ee=i-1;0<=ee?c<=ee:c>=ee;M=0<=ee?++c:--c)O[M]=null;for(A=l=0,te=R-1;0<=te?l<=te:l>=te;A=0<=te?++l:--l)null===O[b=v[A]]?O[b]=ce[A]:O[b]+=ce[A];for(M=h=0,ne=i-1;0<=ne?h<=ne:h>=ne;M=0<=ne?++h:--h)O[M]*=1/w[M];for(re=!1,M=u=0,G=i-1;0<=G?u<=G:u>=G;M=0<=G?++u:--u)if(O[M]!==x[A]){re=!0;break}x=O,++k>200&&(re=!1)}for(C={},M=d=0,V=i-1;0<=V?d<=V:d>=V;M=0<=V?++d:--d)C[M]=[];for(A=f=0,H=R-1;0<=H?f<=H:f>=H;A=0<=H?++f:--f)C[b=v[A]].push(ce[A]);for(se=[],M=p=0,j=i-1;0<=j?p<=j:p>=j;M=0<=j?++p:--p)se.push(C[M][0]),se.push(C[M][C[M].length-1]);for(se=se.sort((function(e,t){return e-t})),P.push(se[0]),A=g=1,W=se.length-1;g<=W;A=g+=2)oe=se[A],isNaN(oe)||-1!==P.indexOf(oe)||P.push(oe)}return P},L=function(e,t,i){var n,r,s,a;return e=(n=Ae(arguments))[0],t=n[1],i=n[2],isNaN(e)&&(e=0),(e/=360)<1/3?s=1-((r=(1-t)/3)+(a=(1+t*A(c*e)/A(o-c*e))/3)):e<2/3?r=1-((a=(1-t)/3)+(s=(1+t*A(c*(e-=1/3))/A(o-c*e))/3)):a=1-((s=(1-t)/3)+(r=(1+t*A(c*(e-=2/3))/A(o-c*e))/3)),[255*(a=X(i*a*3)),255*(s=X(i*s*3)),255*(r=X(i*r*3)),n.length>3?n[3]:1]},ae=function(){var e,t,i,n,r,s,o;return r=(s=Ae(arguments))[0],t=s[1],e=s[2],c=2*Math.PI,r/=255,t/=255,e/=255,0===(o=1-Math.min(r,t,e)/(n=(r+t+e)/3))?i=0:(i=(r-t+(r-e))/2,i/=Math.sqrt((r-t)*(r-t)+(r-e)*(t-e)),i=Math.acos(i),e>t&&(i=c-i),i/=c),[360*i,o,n]},_.hsi=function(){return function(e,t,i){i.prototype=e.prototype;var n=new i,r=e.apply(n,t);return Object(r)===r?r:n}(i,Te.call(arguments).concat(["hsi"]),(function(){}))},d.hsi=L,i.prototype.hsi=function(){return ae(this._rgb)},N=function(e,t,i,n){var r,s,o,a,c,l,h,u,d,f;return"hsl"===n?(d=e.hsl(),f=t.hsl()):"hsv"===n?(d=e.hsv(),f=t.hsv()):"hcg"===n?(d=e.hcg(),f=t.hcg()):"hsi"===n?(d=e.hsi(),f=t.hsi()):"lch"!==n&&"hcl"!==n||(n="hcl",d=e.hcl(),f=t.hcl()),"h"===n.substr(0,1)&&(s=d[0],h=d[1],a=d[2],o=f[0],u=f[1],c=f[2]),isNaN(s)||isNaN(o)?isNaN(s)?isNaN(o)?r=Number.NaN:(r=o,1!==a&&0!==a||"hsv"===n||(l=u)):(r=s,1!==c&&0!==c||"hsv"===n||(l=h)):r=s+i*(o>s&&o-s>180?o-(s+360):o<s&&s-o>180?o+360-s:o-s),null==l&&(l=h+i*(u-h)),_[n](r,l,a+i*(c-a))},U=function(e,t,i,n){var r,s;return r=e.num(),s=t.num(),_.num(r+(s-r)*i,"num")},(f=f.concat(function(){var e,t,i,n;for(n=[],t=0,e=(i=["hsv","hsl","hsi","hcl","lch","hcg"]).length;t<e;t++)K=i[t],n.push([K,N]);return n}())).push(["num",U]),F=function(e,t,n,r){var s,o;return s=e.lab(),o=t.lab(),new i(s[0]+n*(o[0]-s[0]),s[1]+n*(o[1]-s[1]),s[2]+n*(o[2]-s[2]),r)},f.push(["lab",F])}).call(sc)})),cc="sRGB";const lc={scale:"uniform",mode:"hcl",domain:[0,1],value:16777215,reverse:!1},hc=new mn;function uc(e,t,i){const n=i.value;return i.value=function(e,t){let i=n.bind(this,e,t)();return"linear"==cc?(hc.set(i),hc.convertSRGBToLinear(),hc.getHex()):i},i}class dc{constructor(e={}){this.parameters=Ea(e,lc),"string"==typeof this.parameters.value&&(this.parameters.value=hc.set(this.parameters.value).getHex()),this.parameters.structure&&(this.atomProxy=this.parameters.structure.getAtomProxy())}getScale(e={}){const t=Ea(e,this.parameters);return"rainbow"===t.scale?t.scale=["red","orange","yellow","green","blue"]:"rwb"===t.scale&&(t.scale=["red","white","blue"]),t.reverse&&(t.domain=t.domain.slice().reverse()),ac.scale(t.scale).mode(t.mode).domain(t.domain).out("num")}colorToArray(e,t=[],i=0){return t[i]=(e>>16&255)/255,t[i+1]=(e>>8&255)/255,t[i+2]=(255&e)/255,t}atomColorToArray(e,t,i){return this.colorToArray(this.atomColor?this.atomColor(e):0,t,i)}bondColor(e,t){return this.atomProxy&&this.atomColor?(this.atomProxy.index=t?e.atomIndex1:e.atomIndex2,this.atomColor(this.atomProxy)):0}bondColorToArray(e,t,i,n){return this.colorToArray(this.bondColor(e,t),i,n)}volumeColorToArray(e,t,i){return this.colorToArray(this.volumeColor?this.volumeColor(e):0,t,i)}positionColorToArray(e,t,i){return this.colorToArray(this.positionColor?this.positionColor(e):0,t,i)}}var fc,mc=oc((function(e){
/** @license
	 * JS Signals <http://millermedeiros.github.com/js-signals/>
	 * Released under the MIT license
	 * Author: Miller Medeiros
	 * Version: 1.0.0 - Build: 268 (2012/11/29 05:48 PM)
	 */
!function(t){function i(e,t,i,n,r){this._listener=t,this._isOnce=i,this.context=n,this._signal=e,this._priority=r||0}function n(e,t){if("function"!=typeof e)throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",t))}function r(){this._bindings=[],this._prevParams=null;var e=this;this.dispatch=function(){r.prototype.dispatch.apply(e,arguments)}}i.prototype={active:!0,params:null,execute:function(e){var t,i;return this.active&&this._listener&&(i=this.params?this.params.concat(e):e,t=this._listener.apply(this.context,i),this._isOnce&&this.detach()),t},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},r.prototype={VERSION:"1.0.0",memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(e,t,n,r){var s,o=this._indexOfListener(e,n);if(-1!==o){if((s=this._bindings[o]).isOnce()!==t)throw new Error("You cannot add"+(t?"":"Once")+"() then add"+(t?"Once":"")+"() the same listener without removing the relationship first.")}else s=new i(this,e,t,n,r),this._addBinding(s);return this.memorize&&this._prevParams&&s.execute(this._prevParams),s},_addBinding:function(e){var t=this._bindings.length;do{--t}while(this._bindings[t]&&e._priority<=this._bindings[t]._priority);this._bindings.splice(t+1,0,e)},_indexOfListener:function(e,t){for(var i,n=this._bindings.length;n--;)if((i=this._bindings[n])._listener===e&&i.context===t)return n;return-1},has:function(e,t){return-1!==this._indexOfListener(e,t)},add:function(e,t,i){return n(e,"add"),this._registerListener(e,!1,t,i)},addOnce:function(e,t,i){return n(e,"addOnce"),this._registerListener(e,!0,t,i)},remove:function(e,t){n(e,"remove");var i=this._indexOfListener(e,t);return-1!==i&&(this._bindings[i]._destroy(),this._bindings.splice(i,1)),e},removeAll:function(){for(var e=this._bindings.length;e--;)this._bindings[e]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(e){if(this.active){var t,i=Array.prototype.slice.call(arguments),n=this._bindings.length;if(this.memorize&&(this._prevParams=i),n){t=this._bindings.slice(),this._shouldPropagate=!0;do{n--}while(t[n]&&this._shouldPropagate&&!1!==t[n].execute(i))}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};var s=r;s.Signal=r,e.exports?e.exports=s:t.signals=s}(sc)}));!function(e){e[e.PROTEIN=1]="PROTEIN",e[e.NUCLEIC=2]="NUCLEIC",e[e.RNA=3]="RNA",e[e.DNA=4]="DNA",e[e.POLYMER=5]="POLYMER",e[e.WATER=6]="WATER",e[e.HELIX=7]="HELIX",e[e.SHEET=8]="SHEET",e[e.TURN=9]="TURN",e[e.BACKBONE=10]="BACKBONE",e[e.SIDECHAIN=11]="SIDECHAIN",e[e.ALL=12]="ALL",e[e.HETERO=13]="HETERO",e[e.ION=14]="ION",e[e.SACCHARIDE=15]="SACCHARIDE",e[e.SUGAR=15]="SUGAR",e[e.BONDED=16]="BONDED",e[e.RING=17]="RING",e[e.AROMATICRING=18]="AROMATICRING",e[e.METAL=19]="METAL",e[e.POLARH=20]="POLARH",e[e.NONE=21]="NONE"}(fc||(fc={}));const pc=["*","","ALL"],gc=["NONE"],vc=[fc.BACKBONE,fc.SIDECHAIN,fc.BONDED,fc.RING,fc.AROMATICRING,fc.METAL,fc.POLARH],yc=[fc.POLYMER,fc.WATER],xc=["ALA","GLY","SER"],bc=["CYS","SER","THR"],_c=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],wc=["PHE","TRP","TYR","HIS"],Sc=["ASN","GLN"],Ac=["ASP","GLU"],Mc=["ARG","HIS","LYS"],Cc=["ARG","ASP","GLU","HIS","LYS"],Pc=["ASN","ARG","ASP","CYS","GLY","GLN","GLU","HIS","LYS","SER","THR","TYR"],Tc=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],Ic=["HIS","PHE","PRO","TRP","TYR"],Ec=["ALA","GLY","ILE","LEU","VAL"];function Dc(e,t){if(void 0===t.atomname&&void 0===t.element&&void 0===t.altloc&&void 0===t.atomindex&&void 0===t.keyword&&void 0===t.inscode&&void 0===t.resname&&void 0===t.sstruc&&void 0===t.resno&&void 0===t.chainname&&void 0===t.model)return-1;if(void 0!==t.keyword){if(t.keyword===fc.BACKBONE&&!e.isBackbone())return!1;if(t.keyword===fc.SIDECHAIN&&!e.isSidechain())return!1;if(t.keyword===fc.BONDED&&!e.isBonded())return!1;if(t.keyword===fc.RING&&!e.isRing())return!1;if(t.keyword===fc.AROMATICRING&&!e.isAromatic())return!1;if(t.keyword===fc.HETERO&&!e.isHetero())return!1;if(t.keyword===fc.PROTEIN&&!e.isProtein())return!1;if(t.keyword===fc.NUCLEIC&&!e.isNucleic())return!1;if(t.keyword===fc.RNA&&!e.isRna())return!1;if(t.keyword===fc.DNA&&!e.isDna())return!1;if(t.keyword===fc.POLYMER&&!e.isPolymer())return!1;if(t.keyword===fc.WATER&&!e.isWater())return!1;if(t.keyword===fc.HELIX&&!e.isHelix())return!1;if(t.keyword===fc.SHEET&&!e.isSheet())return!1;if(t.keyword===fc.TURN&&!e.isTurn())return!1;if(t.keyword===fc.ION&&!e.isIon())return!1;if(t.keyword===fc.SACCHARIDE&&!e.isSaccharide())return!1;if(t.keyword===fc.METAL&&!e.isMetal())return!1;if(t.keyword===fc.POLARH&&!e.isPolarHydrogen())return!1}if(void 0!==t.atomname&&t.atomname!==e.atomname)return!1;if(void 0!==t.element&&t.element!==e.element)return!1;if(void 0!==t.altloc&&t.altloc!==e.altloc)return!1;if(void 0!==t.atomindex&&Na(t.atomindex,e.index)<0)return!1;if(void 0!==t.resname)if(Array.isArray(t.resname)){if(!t.resname.includes(e.resname))return!1}else if(t.resname!==e.resname)return!1;if(void 0!==t.sstruc&&t.sstruc!==e.sstruc)return!1;if(void 0!==t.resno)if(Array.isArray(t.resno)&&2===t.resno.length){if(t.resno[0]>e.resno||t.resno[1]<e.resno)return!1}else if(t.resno!==e.resno)return!1;return(void 0===t.inscode||t.inscode===e.inscode)&&((void 0===t.chainname||t.chainname===e.chainname)&&(void 0===t.model||t.model===e.modelIndex))}function Lc(e,t){if(void 0===t.resname&&void 0===t.resno&&void 0===t.inscode&&void 0===t.sstruc&&void 0===t.model&&void 0===t.chainname&&void 0===t.atomindex&&(void 0===t.keyword||vc.includes(t.keyword)))return-1;if(void 0!==t.keyword){if(t.keyword===fc.HETERO&&!e.isHetero())return!1;if(t.keyword===fc.PROTEIN&&!e.isProtein())return!1;if(t.keyword===fc.NUCLEIC&&!e.isNucleic())return!1;if(t.keyword===fc.RNA&&!e.isRna())return!1;if(t.keyword===fc.DNA&&!e.isDna())return!1;if(t.keyword===fc.POLYMER&&!e.isPolymer())return!1;if(t.keyword===fc.WATER&&!e.isWater())return!1;if(t.keyword===fc.HELIX&&!e.isHelix())return!1;if(t.keyword===fc.SHEET&&!e.isSheet())return!1;if(t.keyword===fc.TURN&&!e.isTurn())return!1;if(t.keyword===fc.ION&&!e.isIon())return!1;if(t.keyword===fc.SACCHARIDE&&!e.isSaccharide())return!1}if(void 0!==t.atomindex&&0===Fa(t.atomindex,e.atomOffset,e.atomEnd))return!1;if(void 0!==t.resname)if(Array.isArray(t.resname)){if(!t.resname.includes(e.resname))return!1}else if(t.resname!==e.resname)return!1;if(void 0!==t.sstruc&&t.sstruc!==e.sstruc)return!1;if(void 0!==t.resno)if(Array.isArray(t.resno)&&2===t.resno.length){if(t.resno[0]>e.resno||t.resno[1]<e.resno)return!1}else if(t.resno!==e.resno)return!1;return(void 0===t.inscode||t.inscode===e.inscode)&&((void 0===t.chainname||t.chainname===e.chainname)&&(void 0===t.model||t.model===e.modelIndex))}function Rc(e,t){if(!(void 0!==t.chainname||void 0!==t.model||void 0!==t.atomindex||void 0!==t.keyword&&yc.includes(t.keyword)&&e.entity))return-1;if(void 0!==t.keyword){if(t.keyword===fc.POLYMER&&!e.entity.isPolymer())return!1;if(t.keyword===fc.WATER&&!e.entity.isWater())return!1}return(void 0===t.atomindex||0!==Fa(t.atomindex,e.atomOffset,e.atomEnd))&&((void 0===t.chainname||t.chainname===e.chainname)&&(void 0===t.model||t.model===e.modelIndex))}function kc(e,t){return void 0===t.model&&void 0===t.atomindex?-1:(void 0===t.atomindex||0!==Fa(t.atomindex,e.atomOffset,e.atomEnd))&&(void 0===t.model||t.model===e.index)}function Oc(e,t){if(null===e)return!1;if(e.error)return!1;if(!e.rules||0===e.rules.length)return!1;const i=e.rules.length,n=!e.negate,r=!!e.negate,s=[];for(let n=0;n<i;++n){const i=e.rules[n];i.hasOwnProperty("operator")&&(s[n]=Oc(i,t))}return function(o){const a="AND"===e.operator;let c=!1;for(let l=0;l<i;++l){const i=e.rules[l];let h;if(i.hasOwnProperty("operator")){const e=s[l];if(h=!1!==e?e(o):-1,-1===h){c=!0;continue}if(!0===h){if(a)continue;return n}if(a)return r}else{if(i.keyword===fc.ALL){if(a)continue;return n}if(i.keyword===fc.NONE){if(a)continue;return r}if(h=t(o,i),-1!==h){if(!0===h){if(a)continue;return n}if(a)return r}else c=!0}}return c?-1:a?n:r}}function Bc(e,t){if(e.error)return e;if(!e.rules||0===e.rules.length)return e;const i=e.rules.length,n={operator:e.operator,rules:[]};e.hasOwnProperty("negate")&&(n.negate=e.negate);for(let r=0;r<i;++r){const i=e.rules[r];if(i.hasOwnProperty("operator")){const e=Bc(i,t);null!==e&&n.rules.push(e)}else t(i)||n.rules.push(i)}return n.rules.length>0?e:null}function Nc(e,t=!1){let i=e;return t&&(i=Bc(e,(function(e){return void 0!==e.keyword&&!vc.includes(e.keyword)||(void 0!==e.model||(void 0!==e.chainname||(void 0!==e.resname||(void 0!==e.resno||void 0!==e.sstruc))))}))),Oc(i,Dc)}function Fc(e,t=!1){let i=e;return t&&(i=Bc(e,(function(e){return!(void 0===e.keyword||!vc.includes(e.keyword))||(void 0!==e.model||(void 0!==e.chainname||(void 0!==e.atomname||(void 0!==e.element||void 0!==e.altloc))))}))),Oc(i,Lc)}function zc(e,t=!1){let i=e;return t&&(i=Bc(e,(function(e){return void 0!==e.keyword&&!yc.includes(e.keyword)||(void 0!==e.resname||(void 0!==e.resno||(void 0!==e.atomname||(void 0!==e.element||(void 0!==e.altloc||(void 0!==e.sstruc||void 0!==e.inscode))))))}))),Oc(i,Rc)}function Uc(e,t=!1){let i=e;return t&&(i=Bc(e,(function(e){return void 0!==e.keyword||(void 0!==e.chainname||(void 0!==e.resname||(void 0!==e.resno||(void 0!==e.atomname||(void 0!==e.element||(void 0!==e.altloc||(void 0!==e.sstruc||void 0!==e.inscode)))))))}))),Oc(i,kc)}class $c{constructor(e){this.signals={stringChanged:new mc.Signal},this.setString(e)}get type(){return"selection"}setString(e,t){if(void 0===e&&(e=this.string||""),e===this.string)return;try{this.selection=function(e){let t={operator:void 0,rules:[]};if(!e)return t;let i,n,r=t;const s=[];"("===(e=e.replace(/\(/g," ( ").replace(/\)/g," ) ").trim()).charAt(0)&&")"===e.substr(-1)&&(e=e.slice(1,-1).trim());const o=e.split(/\s+/),a=e=>{i={operator:e,rules:[]},void 0===r?(r=i,t=i):(r.rules.push(i),s.push(r),r=i)},c=function(e){n=r,r=s.pop(),void 0===r&&(a(e),l(n))},l=function(e){r.rules.push(e)};let h=!1;for(let e=0;e<o.length;++e){const t=o[e],i=t.toUpperCase();if("("===t){h=!1,a();continue}if(")"===t){c(),r.negate&&c();continue}if(h>0)if("NOT"===i)h=1;else if(1===h)h=2;else{if(2!==h)throw new Error("something went wrong with 'not'");h=!1,c()}if("AND"===i){if("OR"===r.operator){const e=r.rules.pop();a("AND"),l(e)}else r.operator="AND";continue}if("OR"===i){"AND"===r.operator?c("OR"):r.operator="OR";continue}if("NOT"===t.toUpperCase()){h=1,a(),r.negate=!0;continue}if(+i!=+i){const e=fc[i];if(void 0!==e){l({keyword:e});continue}}if("HYDROGEN"===i){l({operator:"OR",rules:[{element:"H"},{element:"D"}]});continue}if("SMALL"===i){l({resname:xc});continue}if("NUCLEOPHILIC"===i){l({resname:bc});continue}if("HYDROPHOBIC"===i){l({resname:_c});continue}if("AROMATIC"===i){l({resname:wc});continue}if("AMIDE"===i){l({resname:Sc});continue}if("ACIDIC"===i){l({resname:Ac});continue}if("BASIC"===i){l({resname:Mc});continue}if("CHARGED"===i){l({resname:Cc});continue}if("POLAR"===i){l({resname:Pc});continue}if("NONPOLAR"===i){l({resname:Tc});continue}if("CYCLIC"===i){l({resname:Ic});continue}if("ALIPHATIC"===i){l({resname:Ec});continue}if("SIDECHAINATTACHED"===i){l({operator:"OR",rules:[{keyword:fc.SIDECHAIN},{operator:"AND",negate:!1,rules:[{keyword:fc.PROTEIN},{operator:"OR",negate:!1,rules:[{atomname:"CA"},{atomname:"BB"}]}]},{operator:"AND",negate:!1,rules:[{resname:"PRO"},{atomname:"N"}]},{operator:"AND",negate:!1,rules:[{keyword:fc.NUCLEIC},{operator:"OR",negate:!0,rules:[{atomname:"P"},{atomname:"OP1"},{atomname:"OP2"},{atomname:"O3'"},{atomname:"O3*"},{atomname:"HO3'"},{atomname:"O5'"},{atomname:"O5*"},{atomname:"HO5'"},{atomname:"C5'"},{atomname:"C5*"},{atomname:"H5'"},{atomname:"H5''"}]}]}]});continue}if("APOLARH"===i){l({operator:"AND",negate:!1,rules:[{element:"H"},{negate:!0,operator:void 0,rules:[{keyword:fc.POLARH}]}]});continue}if("LIGAND"===i){l({operator:"AND",rules:[{operator:"OR",rules:[{operator:"AND",rules:[{keyword:fc.HETERO},{negate:!0,operator:void 0,rules:[{keyword:fc.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{keyword:fc.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{operator:"OR",rules:[{keyword:fc.WATER},{keyword:fc.ION}]}]}]});continue}if(-1!==pc.indexOf(i)){l({keyword:fc.ALL});continue}if("@"===t.charAt(0)){const e=t.substr(1).split(",").map((e=>parseInt(e)));e.sort((function(e,t){return e-t})),l({atomindex:e});continue}if("#"===t.charAt(0)){console.error("# for element selection deprecated, use _"),l({element:i.substr(1)});continue}if("_"===t.charAt(0)){l({element:i.substr(1)});continue}if("["===t[0]&&"]"===t[t.length-1]){const e=i.substr(1,t.length-2).split(","),n=e.length>1?e:e[0];l({resname:n});continue}if(t.length>=1&&t.length<=4&&"^"!==t[0]&&":"!==t[0]&&"."!==t[0]&&"%"!==t[0]&&"/"!==t[0]&&isNaN(parseInt(t))){l({resname:i});continue}const n={operator:"AND",rules:[]},s=t.split("/");if(s.length>1&&s[1]){if(isNaN(parseInt(s[1])))throw new Error("model must be an integer");n.rules.push({model:parseInt(s[1])})}const u=s[0].split("%");u.length>1&&n.rules.push({altloc:u[1]});const d=u[0].split(".");if(d.length>1&&d[1]){if(d[1].length>4)throw new Error("atomname must be one to four characters");n.rules.push({atomname:d[1].substring(0,4).toUpperCase()})}const f=d[0].split(":");f.length>1&&f[1]&&n.rules.push({chainname:f[1]});const m=f[0].split("^");if(m.length>1&&n.rules.push({inscode:m[1]}),m[0]){let e,t;"-"===m[0][0]&&(m[0]=m[0].substr(1),e=!0),m[0].includes("--")&&(m[0]=m[0].replace("--","-"),t=!0);let i=m[0].split("-");if(1===i.length){let t=parseInt(i[0]);if(isNaN(t))throw new Error("resi must be an integer");e&&(t*=-1),n.rules.push({resno:t})}else{if(2!==i.length)throw new Error("resi range must contain one '-'");{const r=i.map((e=>parseInt(e)));e&&(r[0]*=-1),t&&(r[1]*=-1),n.rules.push({resno:[r[0],r[1]]})}}}if(1===n.rules.length)l(n.rules[0]);else{if(!(n.rules.length>1))throw new Error("empty selection chunk");l(n)}}return void 0===t.operator&&1===t.rules.length&&t.rules[0].hasOwnProperty("operator")&&(t=t.rules[0]),t}(e)}catch(e){this.selection={error:e.message}}const i=this.selection;this.string=e,this.test=Nc(i),this.residueTest=Fc(i),this.chainTest=zc(i),this.modelTest=Uc(i),this.atomOnlyTest=Nc(i,!0),this.residueOnlyTest=Fc(i,!0),this.chainOnlyTest=zc(i,!0),this.modelOnlyTest=Uc(i,!0),t||this.signals.stringChanged.dispatch(this.string)}isAllSelection(){return pc.includes(this.string.toUpperCase())}isNoneSelection(){return gc.includes(this.string.toUpperCase())}}class Gc extends dc{constructor(e){super(e),this.colormakerList=[],this.selectionList=[];(e.dataList||[]).forEach((e=>{const[t,i,n={}]=e;al.hasScheme(t)?Object.assign(n,{scheme:t,structure:this.parameters.structure}):Object.assign(n,{scheme:"uniform",value:new mn(t).getHex()}),this.colormakerList.push(al.getScheme(n)),this.selectionList.push(new $c(i))}))}atomColor(e){for(let t=0,i=this.selectionList.length;t<i;++t){const i=this.selectionList[t].test;if(i&&i(e))return this.colormakerList[t].atomColor(e)}return 16777215}}const Vc={"":"",OrRd:"[S] Orange-Red",PuBu:"[S] Purple-Blue",BuPu:"[S] Blue-Purple",Oranges:"[S] Oranges",BuGn:"[S] Blue-Green",YlOrBr:"[S] Yellow-Orange-Brown",YlGn:"[S] Yellow-Green",Reds:"[S] Reds",RdPu:"[S] Red-Purple",Greens:"[S] Greens",YlGnBu:"[S] Yellow-Green-Blue",Purples:"[S] Purples",GnBu:"[S] Green-Blue",Greys:"[S] Greys",YlOrRd:"[S] Yellow-Orange-Red",PuRd:"[S] Purple-Red",Blues:"[S] Blues",PuBuGn:"[S] Purple-Blue-Green",Viridis:"[D] Viridis",Spectral:"[D] Spectral",RdYlGn:"[D] Red-Yellow-Green",RdBu:"[D] Red-Blue",PiYG:"[D] Pink-Yellowgreen",PRGn:"[D] Purplered-Green",RdYlBu:"[D] Red-Yellow-Blue",BrBG:"[D] Brown-Bluegreen",RdGy:"[D] Red-Grey",PuOr:"[D] Purple-Orange",Set1:"[Q] Set1",Set2:"[Q] Set2",Set3:"[Q] Set3",Dark2:"[Q] Dark2",Paired:"[Q] Paired",Pastel1:"[Q] Pastel1",Pastel2:"[Q] Pastel2",Accent:"[Q] Accent",rainbow:"[?] Rainbow",rwb:"[?] Red-White-Blue"},Hc={"":"",rgb:"Red Green Blue",hsv:"Hue Saturation Value",hsl:"Hue Saturation Lightness",hsi:"Hue Saturation Intensity",lab:"CIE L*a*b*",hcl:"Hue Chroma Lightness"};function jc(e){const t=e;return e.forEach((function(e){e.__deps&&Array.prototype.push.apply(t,jc(e.__deps))})),t}function Wc(e){return za(jc(e)).map((function(e){return e.toString()})).join("\n\n\n")}function qc(e){const t=e.data.__name,i=e.data.__postId;if(void 0===t)console.error("message __name undefined");else if(void 0===self.func)console.error("worker func undefined",t);else{const t=function(e,t){e=e||{},void 0!==i&&(e.__postId=i);try{self.postMessage(e,t)}catch(t){console.error("self.postMessage:",t),self.postMessage(e)}};self.func(e,t)}}function Xc(e,t){let i="'use strict';\n\n"+Wc(t);return i+="\n\n\nself.func = "+e.toString()+";",i+="\n\n\nself.onmessage = "+qc.toString()+";",new Blob([i],{type:"application/javascript"})}const Yc=Ra();let Zc=!1;try{const e=Object.defineProperty({},"passive",{get:function(){Zc=!0}});window.addEventListener("test",(e=>{}),e)}catch(e){}const Kc="undefined"!=typeof window&&void 0!==window.orientation;let Qc=!1;function Jc(e){Qc=e}let el=!1;function tl(e){el=e}const il={log:Function.prototype.bind.call(console.log,console),info:Function.prototype.bind.call(console.info,console),warn:Function.prototype.bind.call(console.warn,console),error:Function.prototype.bind.call(console.error,console),time:Function.prototype.bind.call(console.time,console),timeEnd:Function.prototype.bind.call(console.timeEnd,console)};let nl={color:"green",labelColor:8421504,labelAttachment:"bottom-center",labelSize:.7,labelZOffset:.5,labelYOffset:.1,labelBorder:!0,labelBorderColor:13882323,labelBorderWidth:.25,lineOpacity:.8,linewidth:5,opacity:.6,labelUnit:"angstrom",arcVisible:!0,planeVisible:!1};var rl;e.Debug=!!(rl=Ta("debug"))&&("string"!=typeof rl||/^1|true|t|yes|y$/i.test(rl));const sl=["ngl","js"],ol=new class{constructor(){this.activeWorkerCount=0,this._funcDict={},this._depsDict={},this._blobDict={}}add(e,t,i){this._funcDict[e]=t,this._depsDict[e]=i}get(e){return this._blobDict[e]||(this._blobDict[e]=Xc(this._funcDict[e],this._depsDict[e])),this._blobDict[e]}},al=new class{constructor(){this.schemes={},this.userSchemes={}}getScheme(e){const t=((e||{}).scheme||"").toLowerCase();let i;return i=t in this.schemes?this.schemes[t]:t in this.userSchemes?this.userSchemes[t]:dc,new i(e)}getSchemes(){const e={};return Object.keys(this.schemes).forEach((function(t){e[t]=t})),Object.keys(this.userSchemes).forEach((function(t){e[t]=t.split("|")[1]})),e}getScales(){return Vc}getModes(){return Hc}add(e,t){e=e.toLowerCase(),this.schemes[e]=t}addScheme(e,t){return function(e){return e instanceof dc}(e)||(e=this._createScheme(e)),this._addUserScheme(e,t)}_addUserScheme(e,t){t=t||"";const i=`${ec()}|${t}`.toLowerCase();return this.userSchemes[i]=e,i}removeScheme(e){e=e.toLowerCase(),delete this.userSchemes[e]}_createScheme(e){return class extends dc{constructor(t){super(t),e.call(this,t)}}}addSelectionScheme(e,t){return this._addUserScheme(class extends Gc{constructor(t){super(Object.assign({dataList:e},t))}},t)}hasScheme(e){return(e=e.toLowerCase())in this.schemes||e in this.userSchemes}},cl=new Za("datasource"),ll=new Za("representatation"),hl=new class extends Za{constructor(){super("parser")}__hasObjName(e,t){const i=this.get(e);return i&&i.prototype.__objName===t}isTrajectory(e){return this.__hasObjName(e,"frames")}isStructure(e){return this.__hasObjName(e,"structure")}isVolume(e){return this.__hasObjName(e,"volume")}isSurface(e){return this.__hasObjName(e,"surface")}isBinary(e){const t=this.get(e);return t&&t.prototype.isBinary}isXml(e){const t=this.get(e);return t&&t.prototype.isXml}isJson(e){const t=this.get(e);return t&&t.prototype.isJson}getTrajectoryExtensions(){return this.names.filter((e=>this.isTrajectory(e)))}getStructureExtensions(){return this.names.filter((e=>this.isStructure(e)))}getVolumeExtensions(){return this.names.filter((e=>this.isVolume(e)))}getSurfaceExtensions(){return this.names.filter((e=>this.isSurface(e)))}},ul=new Za("shader"),dl=new Za("decompressor"),fl=new Za("component"),ml=new Za("buffer"),pl=new Za("picker");e.ListingDatasource=void 0,e.TrajectoryDatasource=void 0;class gl{constructor(e,t={}){this.chunkSize=10485760,this.newline="\n",this.__pointer=0,this.__partialLine="",this.compressed=Ia(t.compressed,!1),this.binary=Ia(t.binary,!1),this.json=Ia(t.json,!1),this.xml=Ia(t.xml,!1),this.src=e}isBinary(){return this.binary||this.compressed}read(){return this._read().then((e=>{const t=this.compressed?dl.get(this.compressed):void 0;return this.compressed&&t?this.data=t(e):((this.binary||this.compressed)&&e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.data=e),this.data}))}_chunk(e,t){return t=Math.min(this.data.length,t),0===e&&this.data.length===t?this.data:this.isBinary()?this.data.subarray(e,t):this.data.substring(e,t)}chunk(e){const t=e+this.chunkSize;return this._chunk(e,t)}peekLines(e){const t=this.data,i=t.length,n=this.isBinary()?this.newline.charCodeAt(0):this.newline;let r,s=0;for(r=0;r<i&&(t[r]===n&&++s,s!==e);++r);const o=this._chunk(0,r+1);return this.chunkToLines(o,"",r>i).lines}chunkCount(){return Math.floor(this.data.length/this.chunkSize)+1}asText(){return this.isBinary()?Ua(this.data):this.data}chunkToLines(e,t,i){const n=this.newline;if(!this.isBinary()&&e.length===this.data.length)return{lines:e.split(n),partialLine:""};let r=[];const s=this.isBinary()?Ua(e):e,o=s.lastIndexOf(n);if(-1===o)t+=s;else{const e=t+s.substr(0,o);r=r.concat(e.split(n)),t=o===s.length-n.length?"":s.substr(o+n.length)}return i&&""!==t&&r.push(t),{lines:r,partialLine:t}}nextChunk(){const e=this.__pointer;if(!(e>this.data.length))return this.__pointer+=this.chunkSize,this.chunk(e)}nextChunkOfLines(){const e=this.nextChunk();if(void 0===e)return;const t=this.__pointer>this.data.length,i=this.chunkToLines(e,this.__partialLine,t);return this.__partialLine=i.partialLine,i.lines}eachChunk(e){const t=this.chunkSize,i=this.data.length,n=this.chunkCount();for(let r=0;r<i;r+=t){e(this.chunk(r),Math.round(r/t),n)}}eachChunkOfLines(e){this.eachChunk(((t,i,n)=>{const r=i===n+1,s=this.chunkToLines(t,this.__partialLine,r);this.__partialLine=s.partialLine,e(s.lines,i,n)}))}dispose(){delete this.src}}class vl extends gl{_read(){return new Promise(((e,t)=>{const i=this.src,n=new FileReader;n.onload=t=>{t.target&&e(t.target.result)},n.onerror=e=>t(e),this.binary||this.compressed?n.readAsArrayBuffer(i):n.readAsText(i)}))}}class yl extends gl{_read(){return new Promise(((e,t)=>{const i=this.src,n=new XMLHttpRequest;n.open("GET",i,!0),n.addEventListener("load",(()=>{if(200===n.status||304===n.status||0===n.status)try{e(n.response)}catch(e){t(e)}else t(n.statusText)}),!1),n.addEventListener("error",(e=>t("network error")),!1),this.isBinary()?n.responseType="arraybuffer":this.json?n.responseType="json":this.xml?n.responseType="document":n.responseType="text",n.send()}))}}class xl{constructor(e,t={}){this.parameters=Ea(t,{ext:"",compressed:!1,binary:hl.isBinary(t.ext||""),name:"",dir:"",path:"",protocol:""});const i={compressed:this.parameters.compressed,binary:this.parameters.binary,json:hl.isJson(this.parameters.ext),xml:hl.isXml(this.parameters.ext)};"undefined"!=typeof File&&e instanceof File||"undefined"!=typeof Blob&&e instanceof Blob?this.streamer=new vl(e,i):this.streamer=new yl(e,i)}}class bl extends xl{constructor(e,t={}){super(e,t),this.parserParams={voxelSize:t.voxelSize,firstModelOnly:t.firstModelOnly,asTrajectory:t.asTrajectory,cAlphaOnly:t.cAlphaOnly,delimiter:t.delimiter,comment:t.comment,columnNames:t.columnNames,inferBonds:t.inferBonds,name:this.parameters.name,path:this.parameters.path}}load(){return new(hl.get(this.parameters.ext))(this.streamer,this.parserParams).parse()}}class _l{constructor(e,t,i){this.name=t,this.path=i,this.signals={elementAdded:new mc.Signal,elementRemoved:new mc.Signal,nameChanged:new mc.Signal},this.type="Script",this.dir=i.substring(0,i.lastIndexOf("/")+1);try{this.fn=new Function("stage","__name","__path","__dir",e)}catch(e){il.error("Script compilation failed",e),this.fn=function(){}}}run(e){return new Promise(((t,i)=>{try{this.fn.apply(null,[e,this.name,this.path,this.dir]),t()}catch(e){il.error("Script.fn",e),i(e)}}))}}class wl extends xl{load(){return this.streamer.read().then((()=>new _l(this.streamer.asText(),this.parameters.name,this.parameters.path)))}}function Sl(e){const t=dl.names;let i,n,r="";i=e instanceof File?e.name:e instanceof Blob?"":e;const s=i.lastIndexOf("?"),o=-1!==s?i.substring(s):"";i=i.substring(0,-1===s?i.length:s);const a=i.replace(/^.*[\\/]/,"");let c=a.substring(0,a.lastIndexOf("."));const l=a.split(".");let h=l.length>1?(l.pop()||"").toLowerCase():"";const u=i.match(/^(.+):\/\/(.+)$/);u&&(r=u[1].toLowerCase(),i=u[2]||"");const d=i.substring(0,i.lastIndexOf("/")+1);if(t.includes(h)){n=h;const e=i.length-h.length-1;h=(i.substr(0,e).split(".").pop()||"").toLowerCase();const t=c.length-h.length-1;c=c.substr(0,t)}else n=!1;return{path:i,name:a,ext:h,base:c,dir:d,compressed:n,protocol:r,query:o,src:e}}function Al(e){let t=Sl(e);const i=cl.get(t.protocol);return i&&(t=Sl(i.getUrl(t.src)),!t.ext&&i.getExt&&(t.ext=i.getExt(e))),t}function Ml(e,t={}){const i=Object.assign(Al(e),t);let n;return hl.names.includes(i.ext)?n=new bl(i.src,i):sl.includes(i.ext)&&(n=new wl(i.src,i)),n?n.load():Promise.reject(new Error(`autoLoad: ext '${i.ext}' unknown`))}var Cl=oc((function(e,t){!function(){var e={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function i(t){return function(t,n){var r,s,o,a,c,l,h,u,d,f=1,m=t.length,p="";for(s=0;s<m;s++)if("string"==typeof t[s])p+=t[s];else if("object"==typeof t[s]){if((a=t[s]).keys)for(r=n[f],o=0;o<a.keys.length;o++){if(null==r)throw new Error(i('[sprintf] Cannot access property "%s" of undefined value "%s"',a.keys[o],a.keys[o-1]));r=r[a.keys[o]]}else r=a.param_no?n[a.param_no]:n[f++];if(e.not_type.test(a.type)&&e.not_primitive.test(a.type)&&r instanceof Function&&(r=r()),e.numeric_arg.test(a.type)&&"number"!=typeof r&&isNaN(r))throw new TypeError(i("[sprintf] expecting number but found %T",r));switch(e.number.test(a.type)&&(u=r>=0),a.type){case"b":r=parseInt(r,10).toString(2);break;case"c":r=String.fromCharCode(parseInt(r,10));break;case"d":case"i":r=parseInt(r,10);break;case"j":r=JSON.stringify(r,null,a.width?parseInt(a.width):0);break;case"e":r=a.precision?parseFloat(r).toExponential(a.precision):parseFloat(r).toExponential();break;case"f":r=a.precision?parseFloat(r).toFixed(a.precision):parseFloat(r);break;case"g":r=a.precision?String(Number(r.toPrecision(a.precision))):parseFloat(r);break;case"o":r=(parseInt(r,10)>>>0).toString(8);break;case"s":r=String(r),r=a.precision?r.substring(0,a.precision):r;break;case"t":r=String(!!r),r=a.precision?r.substring(0,a.precision):r;break;case"T":r=Object.prototype.toString.call(r).slice(8,-1).toLowerCase(),r=a.precision?r.substring(0,a.precision):r;break;case"u":r=parseInt(r,10)>>>0;break;case"v":r=r.valueOf(),r=a.precision?r.substring(0,a.precision):r;break;case"x":r=(parseInt(r,10)>>>0).toString(16);break;case"X":r=(parseInt(r,10)>>>0).toString(16).toUpperCase()}e.json.test(a.type)?p+=r:(!e.number.test(a.type)||u&&!a.sign?d="":(d=u?"+":"-",r=r.toString().replace(e.sign,"")),l=a.pad_char?"0"===a.pad_char?"0":a.pad_char.charAt(1):" ",h=a.width-(d+r).length,c=a.width&&h>0?l.repeat(h):"",p+=a.align?d+r+c:"0"===l?d+c+r:c+d+r)}return p}(function(t){if(r[t])return r[t];var i,n=t,s=[],o=0;for(;n;){if(null!==(i=e.text.exec(n)))s.push(i[0]);else if(null!==(i=e.modulo.exec(n)))s.push("%");else{if(null===(i=e.placeholder.exec(n)))throw new SyntaxError("[sprintf] unexpected placeholder");if(i[2]){o|=1;var a=[],c=i[2],l=[];if(null===(l=e.key.exec(c)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(a.push(l[1]);""!==(c=c.substring(l[0].length));)if(null!==(l=e.key_access.exec(c)))a.push(l[1]);else{if(null===(l=e.index_access.exec(c)))throw new SyntaxError("[sprintf] failed to parse named argument key");a.push(l[1])}i[2]=a}else o|=2;if(3===o)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");s.push({placeholder:i[0],param_no:i[1],keys:i[2],sign:i[3],pad_char:i[4],align:i[5],width:i[6],precision:i[7],type:i[8]})}n=n.substring(i[0].length)}return r[t]=s}(t),arguments)}function n(e,t){return i.apply(null,[e].concat(t||[]))}var r=Object.create(null);t.sprintf=i,t.vsprintf=n,"undefined"!=typeof window&&(window.sprintf=i,window.vsprintf=n)}()}));class Pl{getBlob(){return new Blob([this.getData()],{type:this.mimeType})}download(e,t){e=Ia(e,this.defaultName),t=Ia(t,this.defaultExt),Oa(this.getBlob(),`${e}.${t}`)}}const Tl=[];class Il{constructor(e,t={}){this._mark=0,this._marks=[],this.offset=0,this.littleEndian=!0;let i=!1;void 0===e&&(e=8192),"number"==typeof e?e=new ArrayBuffer(e):i=!0;const n=t.offset?t.offset>>>0:0;let r=e.byteLength-n,s=n;e instanceof ArrayBuffer||(e.byteLength!==e.buffer.byteLength&&(s=e.byteOffset+n),e=e.buffer),this._lastWrittenByte=i?r:0,this.buffer=e,this.length=r,this.byteLength=r,this.byteOffset=s,this._data=new DataView(this.buffer,s,r)}available(e){return void 0===e&&(e=1),this.offset+e<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(e){return void 0===e&&(e=1),this.offset+=e,this}seek(e){return this.offset=e,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const e=this._marks.pop();if(void 0===e)throw new Error("Mark stack empty");return this.seek(e),this}rewind(){return this.offset=0,this}ensureAvailable(e){if(void 0===e&&(e=1),!this.available(e)){const t=2*(this.offset+e),i=new Uint8Array(t);i.set(new Uint8Array(this.buffer)),this.buffer=i.buffer,this.length=this.byteLength=t,this._data=new DataView(this.buffer)}return this}readBoolean(){return 0!==this.readUint8()}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(e){void 0===e&&(e=1);for(var t=new Uint8Array(e),i=0;i<e;i++)t[i]=this.readByte();return t}readInt16(){var e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}readUint16(){var e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e}readInt32(){var e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}readUint32(){var e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat32(){var e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat64(){var e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}readChar(){return String.fromCharCode(this.readInt8())}readChars(e=1){Tl.length=e;for(var t=0;t<e;t++)Tl[t]=this.readChar();return Tl.join("")}writeBoolean(e=!1){return this.writeUint8(e?255:0),this}writeInt8(e){return this.ensureAvailable(1),this._data.setInt8(this.offset++,e),this._updateLastWrittenByte(),this}writeUint8(e){return this.ensureAvailable(1),this._data.setUint8(this.offset++,e),this._updateLastWrittenByte(),this}writeByte(e){return this.writeUint8(e)}writeBytes(e){this.ensureAvailable(e.length);for(var t=0;t<e.length;t++)this._data.setUint8(this.offset++,e[t]);return this._updateLastWrittenByte(),this}writeInt16(e){return this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(e){return this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(e){return this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(e){return this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(e){return this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(e){return this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(e){return this.writeUint8(e.charCodeAt(0))}writeChars(e){for(var t=0;t<e.length;t++)this.writeUint8(e.charCodeAt(t));return this}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}}class El{constructor(){this.count=0,this.signals={countChanged:new mc.Signal}}clear(){this.change(-this.count)}change(e){this.count+=e,this.signals.countChanged.dispatch(e,this.count),this.count<0&&il.warn("Counter.count below zero",this.count)}increment(){this.change(1)}decrement(){this.change(-1)}listen(e){this.change(e.count),e.signals.countChanged.add(this.change,this)}unlisten(e){const t=e.signals.countChanged;t.has(this.change,this)&&t.remove(this.change,this)}onZeroOnce(e,t){if(0===this.count)e.call(t);else{const i=()=>{0===this.count&&(this.signals.countChanged.remove(i,this),e.call(t))};this.signals.countChanged.add(i,this)}}dispose(){this.clear(),this.signals.countChanged.dispose()}}ul.add("shader/BasicLine.vert","void main(){\n#include begin_vertex\n#include project_vertex\n}"),ul.add("shader/BasicLine.frag","uniform vec3 uColor;\n#include common\n#include fog_pars_fragment\nvoid main(){\ngl_FragColor = vec4( uColor, 1.0 );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n}"),ul.add("shader/Quad.vert","varying vec2 vUv;\nvoid main() {\nvUv = uv;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}"),ul.add("shader/Quad.frag","varying vec2 vUv;\nuniform sampler2D tForeground;\nuniform float scale;\nvoid main() {\nvec4 foreground = texture2D( tForeground, vUv );\ngl_FragColor = foreground * scale;\n}");class Dl{constructor(){this.signals={updated:new mc.Signal},this.maxDuration=-1/0,this.minDuration=1/0,this.avgDuration=14,this.lastDuration=1/0,this.prevFpsTime=0,this.lastFps=1/0,this.lastFrames=1,this.frames=0,this.count=0,this.begin()}update(){this.startTime=this.end(),this.currentTime=this.startTime,this.signals.updated.dispatch()}begin(){this.startTime=window.performance.now(),this.lastFrames=this.frames}end(){const e=window.performance.now();return this.count+=1,this.frames+=1,this.lastDuration=e-this.startTime,this.minDuration=Math.min(this.minDuration,this.lastDuration),this.maxDuration=Math.max(this.maxDuration,this.lastDuration),this.avgDuration-=this.avgDuration/30,this.avgDuration+=this.lastDuration/30,e>this.prevFpsTime+1e3&&(this.lastFps=this.frames,this.prevFpsTime=e,this.frames=0),e}}ul.add("shader/chunk/fog_fragment.glsl","#ifdef USE_FOG\nfloat depth = length( vViewPosition );\n#ifdef FOG_EXP2\nfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif"),ul.add("shader/chunk/interior_fragment.glsl","if( gl_FrontFacing == false ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}"),ul.add("shader/chunk/matrix_scale.glsl","float matrixScale( in mat4 m ){\nvec4 r = m[ 0 ];\nreturn sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );\n}"),ul.add("shader/chunk/nearclip_vertex.glsl","#ifdef NEAR_CLIP\nif( vViewPosition.z < clipNear - 5.0 )\ngl_Position.z = 2.0 * gl_Position.w;\n#endif"),ul.add("shader/chunk/nearclip_fragment.glsl","#ifdef NEAR_CLIP\nif( vViewPosition.z < clipNear )\ndiscard;\n#endif"),ul.add("shader/chunk/opaque_back_fragment.glsl","#ifdef OPAQUE_BACK\n#ifdef FLIP_SIDED\nif( gl_FrontFacing == true ){\ngl_FragColor.a = 1.0;\n}\n#else\nif( gl_FrontFacing == false ){\ngl_FragColor.a = 1.0;\n}\n#endif\n#endif"),ul.add("shader/chunk/radiusclip_vertex.glsl","#ifdef RADIUS_CLIP\nif( distance( vViewPosition, vClipCenter ) > clipRadius + 5.0 )\ngl_Position.z = 2.0 * gl_Position.w;\n#endif"),ul.add("shader/chunk/radiusclip_fragment.glsl","#ifdef RADIUS_CLIP\nif( distance( vViewPosition, vClipCenter ) > clipRadius )\ndiscard;\n#endif"),ul.add("shader/chunk/unpack_color.glsl","vec3 unpackColor(float f) {\nvec3 color;\ncolor.r = floor(f / 256.0 / 256.0);\ncolor.g = floor((f - color.r * 256.0 * 256.0) / 256.0);\ncolor.b = floor(f - color.r * 256.0 * 256.0 - color.g * 256.0);\nreturn color / 255.0;\n}");const Ll=/^(?!\/\/)\s*#include\s+(\S+)/gim,Rl={};function kl(e,t={}){let i=e+"|";for(const e in t)i+=e+":"+t[e];if(!Rl[i]){const n=function(e){if(void 0===e)return"";const t=[];for(const i in e){const n=e[i];n&&t.push(`#define ${i} ${n}`)}return t.join("\n")+"\n"}(t);let r=ul.get(`shader/${e}`);if(!r)throw new Error(`empty shader, '${e}'`);r=r.replace(Ll,(function(e,t){const i=`shader/chunk/${t}.glsl`,n=ul.get(i)||Rr[t];if(!n)throw new Error(`empty chunk, '${t}'`);return n})),Rl[i]=n+r}return Rl[i]}if("undefined"!=typeof WebGLRenderingContext){const t=WebGLRenderingContext.prototype,i=t.getShaderParameter;t.getShaderParameter=function(){return!e.Debug||i.apply(this,arguments)};const n=t.getShaderInfoLog;t.getShaderInfoLog=function(){return e.Debug?n.apply(this,arguments):""};const r=t.getProgramParameter;t.getProgramParameter=function(i,n){return!e.Debug&&n===t.LINK_STATUS||r.apply(this,arguments)};const s=t.getProgramInfoLog;t.getProgramInfoLog=function(){return e.Debug?s.apply(this,arguments):""}}const Ol=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]];Ol.forEach((e=>{e.forEach((e=>{e[0]*=.0625,e[1]*=.0625}))}));class Bl{constructor(e,t,i,n){this.canvas=document.createElement("canvas"),this._viewer=i,this._factor=Ia(n.factor,2),this._antialias=Ia(n.antialias,!1),this._onProgress=n.onProgress,this._onFinish=n.onFinish,this._antialias&&(this._factor*=2),this._n=this._factor*this._factor,this._width=this._viewer.width,this._height=this._viewer.height,this._antialias?(this.canvas.width=this._width*this._factor/2,this.canvas.height=this._height*this._factor/2):(this.canvas.width=this._width*this._factor,this.canvas.height=this._height*this._factor),this._ctx=this.canvas.getContext("2d"),this._viewerSampleLevel=i.sampleLevel,this._viewer.setSampling(-1)}_renderTile(e){const t=this._viewer,i=this._width,n=this._height,r=this._factor,s=e%r*i,o=Math.floor(e/r)*n;if(t.camera.setViewOffset(i*r,n*r,s,o,i,n),t.render(),this._antialias){const e=Math.round((s+i)/2)-Math.round(s/2),r=Math.round((o+n)/2)-Math.round(o/2);this._ctx.drawImage(t.renderer.domElement,Math.round(s/2),Math.round(o/2),e,r)}else this._ctx.drawImage(t.renderer.domElement,Math.floor(s),Math.floor(o),Math.ceil(i),Math.ceil(n));"function"==typeof this._onProgress&&this._onProgress(e+1,this._n,!1)}_finalize(){this._viewer.setSampling(this._viewerSampleLevel),this._viewer.camera.view=null,"function"==typeof this._onFinish&&this._onFinish(this._n+1,this._n,!1)}render(){for(let e=0;e<=this._n;++e)e===this._n?this._finalize():this._renderTile(e)}renderAsync(){let e=0;const t=this._n,i=()=>{e===t?this._finalize():this._renderTile(e),e+=1};for(let e=0;e<=t;++e)setTimeout(i,0)}}const Nl=2*Math.PI,Fl=180/Math.PI;function zl(e,t,i=1,n=0,r){const s=r?r.length:e.length/i;let o=0,a=0;if(r)for(let c=0;c<s;++c){const s=(e[r[c]*i+n]+t)%t/t*Nl-Math.PI;o+=Math.cos(s),a+=Math.sin(s)}else for(let r=n;r<s;r+=i){const i=(e[r]+t)%t/t*Nl-Math.PI;o+=Math.cos(i),a+=Math.sin(i)}o/=s,a/=s;return(Math.atan2(a,o)+Math.PI)/Nl*t}function Ul(e,t,i,n=0){const r=e.length,s=i||new Float32Array(r);for(let i=0;i<r;i+=3)s[n+i+0]=(e[i+0]+t[i+0])/2,s[n+i+1]=(e[i+1]+t[i+1])/2,s[n+i+2]=(e[i+2]+t[i+2])/2;return s}function $l(e,t){const i=e.length,n=new Float32Array(i);for(let r=0;r<i;r+=3)n[r+0]=t[r+0]-e[r+0],n[r+1]=t[r+1]-e[r+1],n[r+2]=t[r+2]-e[r+2];return n}function Gl(e,t,i){const n=i||new Float32Array(e);for(let i=0;i<e;++i)n[i]=t;return n}function Vl(e,t,i,n,r){const s=r||new Float32Array(3*e);for(let r=0;r<e;++r){const e=3*r;s[e+0]=t,s[e+1]=i,s[e+2]=n}return s}function Hl(e){const t=new Float32Array(e);for(let i=0;i<e;++i)t[i]=i;return t}function jl(e,t,i=0,n){const r=n||new Float32Array(e*t);for(let n=0;n<e;++n){const e=i+n*t;for(let i=0;i<t;++i)r[e+i]=n}return r}function Wl(e,t){const i=e.length,n=new Float32Array(i*t);for(let r=0;r<i;++r){const i=r*t,s=e[r];for(let e=0;e<t;++e)n[i+e]=s}return n}function ql(e,t,i,n,r){for(let s=0;s<r;++s)t[n+s]=e[i+s]}function Xl(e,t,i,n){ql(e,e,t,i,n)}function Yl(e){let t=-1/0;for(let i=0,n=e.length;i<n;++i)e[i]>t&&(t=e[i]);return t}function Zl(e){let t=1/0;for(let i=0,n=e.length;i<n;++i)e[i]<t&&(t=e[i]);return t}function Kl(e,t=1,i=0){const n=e.length;let r=0;for(let s=i;s<n;s+=t)r+=e[s];return r}function Ql(e,t=1,i=0){return Kl(e,t,i)/(e.length/t)}const Jl={trim:!1,factor:1,antialias:!1,transparent:!1,onProgress:void 0};function eh(e,t={}){const{trim:i,factor:n,antialias:r,transparent:s}=Ea(t,Jl),o=e.renderer,a=e.camera,c=o.getClearAlpha(),l=o.getClearColor();function h(t=!1){let i=n;r&&(i*=2),t&&(i=1/i),e.scene.traverse((function(e){const t=e.material;t&&t.linewidth&&(t.linewidth*=i),t&&t.uniforms&&t.uniforms.size&&void 0===t.uniforms.size.__seen&&(t.uniforms.size.value*=i,t.uniforms.size.__seen=!0),t&&t.uniforms&&t.uniforms.linewidth&&void 0===t.uniforms.linewidth.__seen&&(t.uniforms.linewidth.value*=i,t.uniforms.linewidth.__seen=!0)})),e.scene.traverse((function(e){const t=e.material;t&&t.uniforms&&t.uniforms.size&&delete t.uniforms.size.__seen,t&&t.uniforms&&t.uniforms.linewidth&&delete t.uniforms.linewidth.__seen}))}function u(e){if(i){const t=l;return function(e,t,i,n,r){const s=e.height,o=e.width,a=e.getContext("2d").getImageData(0,0,o,s).data;let c,l,h,u;for(h=!1,l=0;l<s;l++){for(c=0;c<o;c++)if(u=4*(l*o+c),a[u]!==t||a[u+1]!==i||a[u+2]!==n||a[u+3]!==r){h=!0;break}if(h)break}const d=l;for(h=!1,c=0;c<o;c++){for(l=0;l<s;l++)if(u=4*(l*o+c),a[u]!==t||a[u+1]!==i||a[u+2]!==n||a[u+3]!==r){h=!0;break}if(h)break}const f=c;for(h=!1,l=s-1;l>=0;l--){for(c=o-1;c>=0;c--)if(u=4*(l*o+c),a[u]!==t||a[u+1]!==i||a[u+2]!==n||a[u+3]!==r){h=!0;break}if(h)break}const m=l;for(h=!1,c=o-1;c>=0;c--){for(l=s-1;l>=0;l--)if(u=4*(l*o+c),a[u]!==t||a[u+1]!==i||a[u+2]!==n||a[u+3]!==r){h=!0;break}if(h)break}const p=c,g=document.createElement("canvas");return g.width=p-f,g.height=m-d,g.getContext("2d").drawImage(e,f,d,g.width,g.height,0,0,g.width,g.height),g}(e,s?0:255*t.r,s?0:255*t.g,s?0:255*t.b,s?0:255)}return e}function d(e,i,n){"function"==typeof t.onProgress&&t.onProgress(e,i,n)}return new Promise((function(t,i){const l=new Bl(o,a,e,{factor:n,antialias:r,onProgress:d,onFinish:function(n,r){u(l.canvas).toBlob((function(n){o.setClearAlpha(c),h(!0),e.requestRender(),d(r,r,!0),n?t(n):i("error creating image")}),"image/png")}});o.setClearAlpha(s?0:1),h(),l.renderAsync()}))}const th=new Zt,ih=new ri,nh=new ri;const rh=new zt,sh=new ri,oh=new ri;function ah(e,t){sh.getInverse(t.projectionMatrix),oh.copy(t.projectionMatrix).transpose(),e.traverse((function(e){const t=e.material;if(!t)return;const i=t.uniforms;i&&(i.projectionMatrixInverse&&i.projectionMatrixInverse.value.copy(sh),i.projectionMatrixTranspose&&i.projectionMatrixTranspose.value.copy(oh))}))}function ch(e,t,i){const n=e.createShader(i);if(!n)return void console.log(`error creating WebGL shader ${i}`);e.shaderSource(n,t),e.compileShader(n);return e.getShaderParameter(n,e.COMPILE_STATUS)?n:(console.log(`error compiling shader ${n}: ${e.getShaderInfoLog(n)}`),e.deleteShader(n),null)}function lh(e,t){const i=e.getExtension(t);return i||console.log(`extension '${t}' not available`),i}const hh=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);function uh(e){const t=document.createElement("canvas");t.width=16,t.height=16,t.style.width="16px",t.style.height="16px";const i=t.getContext("webgl")||t.getContext("experimental-webgl");if(!i)return console.log(`error creating webgl context for ${e}`),!1;if(!(i instanceof WebGLRenderingContext))return console.log("Got unexpected type for WebGL rendering context"),!1;lh(i,"OES_texture_float"),lh(i,"OES_texture_half_float"),lh(i,"WEBGL_color_buffer_float");const n=ch(i,"\nattribute vec4 a_position;\n\nvoid main() {\n  gl_Position = a_position;\n}",i.VERTEX_SHADER),r=ch(i,"\nprecision mediump float;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, vec2(0.5, 0.5)) * u_color;\n}",i.FRAGMENT_SHADER);if(!n||!r)return!1;const s=function(e,t,i,n){const r=e.createProgram();return r?(t.forEach((t=>e.attachShader(r,t))),i&&i.forEach(((t,i)=>{e.bindAttribLocation(r,n?n[i]:i,t)})),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS)?r:(console.log(`error linking program: ${e.getProgramInfoLog(r)}`),e.deleteProgram(r),null)):void console.log("error creating WebGL program")}(i,[n,r]);if(!s)return console.log("error creating WebGL program"),!1;i.useProgram(s);const o=i.getAttribLocation(s,"a_position"),a=i.getUniformLocation(s,"u_color");if(!a)return console.log("error getting 'u_color' uniform location"),!1;const c=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,hh,i.STATIC_DRAW),i.enableVertexAttribArray(o),i.vertexAttribPointer(o,2,i.FLOAT,!1,0,0);const l=i.createTexture(),h=new Uint8Array([255,255,255,255]);i.bindTexture(i.TEXTURE_2D,l),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,1,1,0,i.RGBA,i.UNSIGNED_BYTE,h);const u=i.createTexture();i.bindTexture(i.TEXTURE_2D,u),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,1,1,0,i.RGBA,e,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);const d=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,d),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,u,0);if(i.checkFramebufferStatus(i.FRAMEBUFFER)!==i.FRAMEBUFFER_COMPLETE)return console.log(`error creating framebuffer for ${e}`),!1;i.bindTexture(i.TEXTURE_2D,l),i.uniform4fv(a,[0,10,20,1]),i.drawArrays(i.TRIANGLES,0,6),i.bindTexture(i.TEXTURE_2D,u),i.bindFramebuffer(i.FRAMEBUFFER,null),i.clearColor(1,0,0,1),i.clear(i.COLOR_BUFFER_BIT),i.uniform4fv(a,[0,.1,.05,1]),i.drawArrays(i.TRIANGLES,0,6);const f=new Uint8Array(4);if(i.readPixels(0,0,1,1,i.RGBA,i.UNSIGNED_BYTE,f),0!==f[0]||f[1]<248||f[2]<248||f[3]<254)return console.log(`not able to actually render to ${e} texture`),!1;if(e===i.FLOAT){i.bindFramebuffer(i.FRAMEBUFFER,d);const e=new Float32Array(4);i.readPixels(0,0,1,1,i.RGBA,i.FLOAT,e);const t=i.getError();if(t)return console.log(`error reading pixels as float: '${function(e,t){switch(t){case e.NO_ERROR:return"no error";case e.INVALID_ENUM:return"invalid enum";case e.INVALID_VALUE:return"invalid value";case e.INVALID_OPERATION:return"invalid operation";case e.INVALID_FRAMEBUFFER_OPERATION:return"invalid framebuffer operation";case e.OUT_OF_MEMORY:return"out of memory";case e.CONTEXT_LOST_WEBGL:return"context lost"}return"unknown error"}(i,t)}'`),!1}return!0}const dh=new Float32Array(100),fh=new Uint8Array(100),mh=[12,7,13,17,11,6,8,18,16,2,14,22,10,1,3,9,19,23,21,15,5,0,4,24,20],ph=new ri;function gh(e,t,i,n,r){const s=r.uniforms,o=[];if(s&&(s.objectId&&(s.objectId.value=Qc?this.id:this.id/255,o.push("objectId")),(s.modelViewMatrixInverse||s.modelViewMatrixInverseTranspose||s.modelViewProjectionMatrix||s.modelViewProjectionMatrixInverse)&&this.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,this.matrixWorld),s.modelViewMatrixInverse&&(s.modelViewMatrixInverse.value.getInverse(this.modelViewMatrix),o.push("modelViewMatrixInverse")),s.modelViewMatrixInverseTranspose&&(s.modelViewMatrixInverse?s.modelViewMatrixInverseTranspose.value.copy(s.modelViewMatrixInverse.value).transpose():s.modelViewMatrixInverseTranspose.value.getInverse(this.modelViewMatrix).transpose(),o.push("modelViewMatrixInverseTranspose")),s.modelViewProjectionMatrix&&(s.modelViewProjectionMatrix.value.multiplyMatrices(i.projectionMatrix,this.modelViewMatrix),o.push("modelViewProjectionMatrix")),s.modelViewProjectionMatrixInverse&&(s.modelViewProjectionMatrix?(ph.copy(s.modelViewProjectionMatrix.value),s.modelViewProjectionMatrixInverse.value.getInverse(ph)):(ph.multiplyMatrices(i.projectionMatrix,this.modelViewMatrix),s.modelViewProjectionMatrixInverse.value.getInverse(ph)),o.push("modelViewProjectionMatrixInverse")),o.length)){const t=e.properties.get(r);if(t.program){const i=e.getContext(),n=t.program;i.useProgram(n.program);const r=n.getUniforms();o.forEach((function(e){r.setValue(i,e,s[e].value)}))}}}class vh{constructor(e){if(this.boundingBox=new Ni,this.boundingBoxSize=new Zt,this.boundingBoxLength=0,this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}},this.distVector=new Zt,this.signals={ticked:new mc.Signal,rendered:new mc.Signal},"string"==typeof e){const t=document.getElementById(e);this.container=null===t?document.createElement("div"):t}else e instanceof HTMLElement?this.container=e:this.container=document.createElement("div");if(this.container===document.body)this.width=window.innerWidth||1,this.height=window.innerHeight||1;else{const e=this.container.getBoundingClientRect();this.width=e.width||1,this.height=e.height||1,this.container.style.overflow="hidden"}this.wrapper=document.createElement("div"),this.wrapper.style.position="relative",this.container.appendChild(this.wrapper),this._initParams(),this._initStats(),this._initCamera(),this._initScene(),!1!==this._initRenderer()?(this._initHelper(),this.setBackground(),this.setFog(),this.animate=this.animate.bind(this)):il.error("Viewer: could not initialize renderer")}_initParams(){this.parameters={fogColor:new mn(0),fogNear:50,fogFar:100,backgroundColor:new mn(0),cameraType:"perspective",cameraFov:40,cameraEyeSep:.3,cameraZ:-80,clipNear:0,clipFar:100,clipDist:10,clipMode:"scene",clipScale:"relative",lightColor:new mn(14540253),lightIntensity:1,ambientColor:new mn(14540253),ambientIntensity:.2,sampleLevel:0,rendererEncoding:_t}}_initCamera(){const e=new Zt(0,0,0),{width:t,height:i}=this;this.perspectiveCamera=new Sr(this.parameters.cameraFov,t/i),this.perspectiveCamera.position.z=this.parameters.cameraZ,this.perspectiveCamera.lookAt(e),this.orthographicCamera=new wa(t/-2,t/2,i/2,i/-2),this.orthographicCamera.position.z=this.parameters.cameraZ,this.orthographicCamera.lookAt(e),this.stereoCamera=new Ca,this.stereoCamera.aspect=.5,this.stereoCamera.eyeSep=this.parameters.cameraEyeSep;const n=this.parameters.cameraType;if("orthographic"===n)this.camera=this.orthographicCamera;else{if("perspective"!==n&&"stereo"!==n)throw new Error(`Unknown cameraType '${n}'`);this.camera=this.perspectiveCamera}this.camera.updateProjectionMatrix()}_initStats(){this.stats=new Dl}_initScene(){this.scene||(this.scene=new Si,this.scene.name="scene"),this.rotationGroup=new ko,this.rotationGroup.name="rotationGroup",this.scene.add(this.rotationGroup),this.translationGroup=new ko,this.translationGroup.name="translationGroup",this.rotationGroup.add(this.translationGroup),this.modelGroup=new ko,this.modelGroup.name="modelGroup",this.translationGroup.add(this.modelGroup),this.pickingGroup=new ko,this.pickingGroup.name="pickingGroup",this.translationGroup.add(this.pickingGroup),this.backgroundGroup=new ko,this.backgroundGroup.name="backgroundGroup",this.translationGroup.add(this.backgroundGroup),this.helperGroup=new ko,this.helperGroup.name="helperGroup",this.translationGroup.add(this.helperGroup),this.scene.fog=new zo(this.parameters.fogColor.getHex()),this.spotLight=new _a(this.parameters.lightColor.getHex(),this.parameters.lightIntensity),this.scene.add(this.spotLight),this.ambientLight=new Sa(this.parameters.ambientColor.getHex(),this.parameters.ambientIntensity),this.scene.add(this.ambientLight)}_initRenderer(){const t=window.devicePixelRatio,{width:i,height:n}=this;try{this.renderer=new Fo({preserveDrawingBuffer:!0,alpha:!0,antialias:!0})}catch(e){return this.wrapper.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;"><p style="padding:15px;text-align:center;">Your browser/graphics card does not seem to support <a target="_blank" href="https://en.wikipedia.org/wiki/WebGL">WebGL</a>.<br/><br/>Find out how to get it <a target="_blank" href="http://get.webgl.org/">here</a>.</p></div>',!1}this.renderer.setPixelRatio(t),this.renderer.setSize(i,n),this.renderer.autoClear=!1,this.renderer.sortObjects=!0,this.renderer.outputEncoding=this.parameters.rendererEncoding;const r=this.renderer.getContext();this.renderer.capabilities.isWebGL2?(tl(!0),Jc(this.renderer.extensions.get("EXT_color_buffer_float")),this.supportsHalfFloat=!0):(tl(this.renderer.extensions.get("EXT_frag_depth")),this.renderer.extensions.get("OES_element_index_uint"),Jc(this.renderer.extensions.get("OES_texture_float")&&this.renderer.extensions.get("WEBGL_color_buffer_float")||this.renderer.extensions.get("OES_texture_float")&&uh(r.FLOAT)),this.renderer.extensions.get("OES_texture_float"),this.supportsHalfFloat=this.renderer.extensions.get("OES_texture_half_float")&&uh(36193)),this.wrapper.appendChild(this.renderer.domElement);const s=i*t,o=n*t;e.Debug&&console.log(JSON.stringify({Browser:Yc,OES_texture_float:!!this.renderer.extensions.get("OES_texture_float"),OES_texture_half_float:!!this.renderer.extensions.get("OES_texture_half_float"),WEBGL_color_buffer_float:!!this.renderer.extensions.get("WEBGL_color_buffer_float"),"testTextureSupport Float":uh(r.FLOAT),"testTextureSupport HalfFloat":uh(36193),"this.supportsHalfFloat":this.supportsHalfFloat,SupportsReadPixelsFloat:Qc},null,2)),this.pickingTarget=new Wt(s,o,{minFilter:re,magFilter:re,stencilBuffer:!1,format:Ae,type:Qc?ge:he}),this.pickingTarget.texture.generateMipmaps=!1,this.pickingTarget.texture.encoding=this.parameters.rendererEncoding,this.renderer.setRenderTarget(this.pickingTarget),this.renderer.clear(),this.renderer.setRenderTarget(null),this.sampleTarget=new Wt(s,o,{minFilter:ae,magFilter:ae,format:Ae}),this.sampleTarget.texture.encoding=this.parameters.rendererEncoding,this.holdTarget=new Wt(s,o,{minFilter:re,magFilter:re,format:Ae,type:he}),this.holdTarget.texture.encoding=this.parameters.rendererEncoding,this.compositeUniforms={tForeground:new Pa(this.sampleTarget.texture),scale:new Pa(1)},this.compositeMaterial=new _r({uniforms:this.compositeUniforms,vertexShader:kl("Quad.vert"),fragmentShader:kl("Quad.frag"),premultipliedAlpha:!0,transparent:!0,blending:d,depthTest:!1,depthWrite:!1}),this.compositeCamera=new wa(-1,1,1,-1,0,1),this.compositeScene=new Si,this.compositeScene.name="compositeScene",this.compositeScene.add(new ar(new Dr(2,2),this.compositeMaterial))}_initHelper(){const e=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),t=new Float32Array(24),i=new Vn;i.setIndex(new An(e,1)),i.setAttribute("position",new An(t,3));const n=new _r({uniforms:{uColor:{value:new mn("skyblue")}},vertexShader:kl("BasicLine.vert"),fragmentShader:kl("BasicLine.frag")});this.boundingBoxMesh=new Yo(i,n),this.helperGroup.add(this.boundingBoxMesh)}updateHelper(){const e=this.boundingBoxMesh.geometry.attributes.position,t=e.array,{min:i,max:n}=this.boundingBox;t[0]=n.x,t[1]=n.y,t[2]=n.z,t[3]=i.x,t[4]=n.y,t[5]=n.z,t[6]=i.x,t[7]=i.y,t[8]=n.z,t[9]=n.x,t[10]=i.y,t[11]=n.z,t[12]=n.x,t[13]=n.y,t[14]=i.z,t[15]=i.x,t[16]=n.y,t[17]=i.z,t[18]=i.x,t[19]=i.y,t[20]=i.z,t[21]=n.x,t[22]=i.y,t[23]=i.z,e.needsUpdate=!0,this.boundingBox.isEmpty()||this.boundingBoxMesh.geometry.computeBoundingSphere()}get cameraDistance(){return Math.abs(this.camera.position.z)}set cameraDistance(e){this.camera.position.z=-e}add(t,i){i?i.forEach((e=>this.addBuffer(t,e))):this.addBuffer(t),t.group.name="meshGroup",t.wireframeGroup.name="wireframeGroup",t.parameters.background?(this.backgroundGroup.add(t.group),this.backgroundGroup.add(t.wireframeGroup)):(this.modelGroup.add(t.group),this.modelGroup.add(t.wireframeGroup)),t.pickable&&this.pickingGroup.add(t.pickingGroup),e.Debug&&this.updateHelper()}addBuffer(e,t){function i(n){n instanceof ko?n.children.forEach(i):(n.userData.buffer=e,n.userData.instance=t,n.onBeforeRender=gh)}const n=e.getMesh();t&&n.applyMatrix4(t.matrix),i(n),e.group.add(n);const r=e.getWireframeMesh();if(t&&(r.matrix.copy(n.matrix),r.position.copy(n.position),r.quaternion.copy(n.quaternion),r.scale.copy(n.scale)),i(r),e.wireframeGroup.add(r),e.pickable){const r=e.getPickingMesh();t&&(r.matrix.copy(n.matrix),r.position.copy(n.position),r.quaternion.copy(n.quaternion),r.scale.copy(n.scale)),i(r),e.pickingGroup.add(r)}t?this._updateBoundingBox(e.geometry,e.matrix,t.matrix):this._updateBoundingBox(e.geometry,e.matrix)}remove(t){this.translationGroup.children.forEach((function(e){e.remove(t.group),e.remove(t.wireframeGroup)})),t.pickable&&this.pickingGroup.remove(t.pickingGroup),this.updateBoundingBox(),e.Debug&&this.updateHelper()}_updateBoundingBox(e,t,i){const n=this.boundingBox;function r(e,t,i){null==e.boundingBox&&e.computeBoundingBox();const r=e.boundingBox.clone();t&&r.applyMatrix4(t),i&&r.applyMatrix4(i),r.min.equals(r.max)&&r.expandByScalar(5),n.union(r)}function s(e){if(void 0!==e.geometry){let t,i;e.userData.buffer&&(t=e.userData.buffer.matrix),e.userData.instance&&(i=e.userData.instance.matrix),r(e.geometry,t,i)}}e?r(e,t,i):(n.makeEmpty(),this.modelGroup.traverse(s),this.backgroundGroup.traverse(s)),n.getSize(this.boundingBoxSize),this.boundingBoxLength=this.boundingBoxSize.length()}updateBoundingBox(){this._updateBoundingBox(),e.Debug&&this.updateHelper()}getPickingPixels(){const{width:e,height:t}=this,i=e*t*4,n=Qc?new Float32Array(i):new Uint8Array(i);return this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,0,0,e,t,n),n}getImage(e){return new Promise((t=>{if(e){const{width:e,height:i}=this,n=e*i*4;let r=this.getPickingPixels();if(Qc){const e=new Uint8Array(n);for(let t=0;t<n;++t)e[t]=Math.round(255*r[t]);r=e}const s=document.createElement("canvas");s.width=e,s.height=i;const o=s.getContext("2d"),a=o.getImageData(0,0,e,i);a.data.set(r),o.putImageData(a,0,0),s.toBlob(t,"image/png")}else this.renderer.domElement.toBlob(t,"image/png")}))}makeImage(e={}){return eh(this,e)}setLight(e,t,i,n){const r=this.parameters;void 0!==e&&r.lightColor.set(e),void 0!==t&&(r.lightIntensity=t),void 0!==i&&r.ambientColor.set(i),void 0!==n&&(r.ambientIntensity=n),this.requestRender()}setFog(e,t,i){const n=this.parameters;void 0!==e&&n.fogColor.set(e),void 0!==t&&(n.fogNear=t),void 0!==i&&(n.fogFar=i),this.requestRender()}setBackground(e){const t=this.parameters;e&&t.backgroundColor.set(e),this.setFog(t.backgroundColor),this.renderer.setClearColor(t.backgroundColor,0),this.renderer.domElement.style.backgroundColor=t.backgroundColor.getStyle(),this.requestRender()}setSampling(e){void 0!==e&&(this.parameters.sampleLevel=e,this.sampleLevel=e),this.requestRender()}setOutputEncoding(e){this.parameters.rendererEncoding=e,this.renderer.outputEncoding=e,this.pickingTarget.texture.encoding=e,this.sampleTarget.texture.encoding=e,this.holdTarget.texture.encoding=e}setColorWorkflow(e){if("linear"!=e&&"sRGB"!=e)throw new Error(`setColorWorkflow: invalid color workflow ${e}`);cc="linear"==e?"linear":"sRGB",this.setOutputEncoding("linear"==e?wt:_t),this.requestRender()}setCamera(e,t,i){const n=this.parameters;if(e&&(n.cameraType=e),t&&(n.cameraFov=t),i&&(n.cameraEyeSep=i),"orthographic"===n.cameraType)this.camera!==this.orthographicCamera&&(this.camera=this.orthographicCamera,this.camera.position.copy(this.perspectiveCamera.position),this.camera.up.copy(this.perspectiveCamera.up),this.updateZoom());else{if("perspective"!==n.cameraType&&"stereo"!==n.cameraType)throw new Error(`Unknown cameraType '${n.cameraType}'`);this.camera!==this.perspectiveCamera&&(this.camera=this.perspectiveCamera,this.camera.position.copy(this.orthographicCamera.position),this.camera.up.copy(this.orthographicCamera.up))}this.perspectiveCamera.fov=n.cameraFov,this.stereoCamera.eyeSep=n.cameraEyeSep,this.camera.updateProjectionMatrix(),this.requestRender()}setClip(e,t,i,n,r){const s=this.parameters;void 0!==e&&(s.clipNear=e),void 0!==t&&(s.clipFar=t),void 0!==i&&(s.clipDist=i),void 0!==n&&(s.clipMode=n),void 0!==r&&(s.clipScale=r),this.requestRender()}setSize(e,t){this.width=e||1,this.height=t||1,this.perspectiveCamera.aspect=this.width/this.height,this.orthographicCamera.left=-this.width/2,this.orthographicCamera.right=this.width/2,this.orthographicCamera.top=this.height/2,this.orthographicCamera.bottom=-this.height/2,this.camera.updateProjectionMatrix();const i=window.devicePixelRatio;this.renderer.setPixelRatio(i),this.renderer.setSize(e,t);const n=this.width*i,r=this.height*i;this.pickingTarget.setSize(n,r),this.sampleTarget.setSize(n,r),this.holdTarget.setSize(n,r),this.requestRender()}handleResize(){if(this.container===document.body)this.setSize(window.innerWidth,window.innerHeight);else{const e=this.container.getBoundingClientRect();this.setSize(e.width,e.height)}}updateInfo(e){const{memory:t,render:i}=this.info;if(e)t.programs=0,t.geometries=0,t.textures=0,i.calls=0,i.vertices=0,i.points=0;else{const e=this.renderer.info,n=e.memory,r=e.render;t.geometries=n.geometries,t.textures=n.textures,i.calls+=r.calls,i.faces+=r.triangles,i.points+=r.points}}animate(){this.signals.ticked.dispatch(this.stats);if(window.performance.now()-this.stats.startTime>500&&!this.isStill&&this.sampleLevel<3&&-1!==this.sampleLevel){const t=this.sampleLevel;this.sampleLevel=3,this.renderPending=!0,this.render(),this.isStill=!0,this.sampleLevel=t,e.Debug&&il.log("rendered still frame")}this.frameRequest=window.requestAnimationFrame(this.animate)}pick(e,t){if("stereo"===this.parameters.cameraType)return{pid:0,instance:void 0,picker:void 0};e*=window.devicePixelRatio,t*=window.devicePixelRatio,e=Math.max(e-2,0),t=Math.max(t-2,0);let i,n,r=0;const s=Qc?dh:fh;this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,e,t,5,5,s);for(let e=0;e<mh.length;e++){const t=4*mh[e],o=Math.round(s[t+3]),a=this.pickingGroup.getObjectById(o);a&&(i=a.userData.instance,n=a.userData.buffer.picking,r=Qc?Math.round(255*s[t])<<16&16711680|Math.round(255*s[t+1])<<8&65280|255&Math.round(255*s[t+2]):s[t]<<16|s[t+1]<<8|s[t+2])}return{pid:r,instance:i,picker:n}}requestRender(){this.renderPending||(window.performance.now()-this.stats.startTime>22&&(this.stats.begin(),this.isStill=!1),this.renderPending=!0,window.requestAnimationFrame((()=>{this.render(),this.stats.update()})))}updateZoom(){const e=Ka(this.perspectiveCamera.fov),t=2*Math.tan(e/2)*this.cameraDistance;this.orthographicCamera.zoom=this.height/t}absoluteToRelative(e){return 50*(1-e/this.bRadius)}relativeToAbsolute(e){return this.bRadius*(1-e/50)}__updateClipping(){const e=this.parameters;this.bRadius=Math.max(10,.5*this.boundingBoxLength),isFinite(this.bRadius)||(this.bRadius=50),this.camera.getWorldPosition(this.distVector),this.cDist=this.distVector.length(),this.cDist||(this.cameraDistance=Math.abs(e.cameraZ),this.cDist=Math.abs(e.cameraZ));const t=this.scene.fog;if(t.color.set(e.fogColor),"camera"===e.clipMode)this.camera.near=e.clipNear,this.camera.far=e.clipFar,t.near=e.fogNear,t.far=e.fogFar;else if("absolute"===e.clipScale)this.camera.near=this.cDist-e.clipNear,this.camera.far=this.cDist+e.clipFar,t.near=this.cDist-e.fogNear,t.far=this.cDist+e.fogFar;else{const i=(50-e.clipNear)/50,n=-(50-e.clipFar)/50;this.camera.near=this.cDist-this.bRadius*i,this.camera.far=this.cDist+this.bRadius*n;const r=(50-e.fogNear)/50,s=-(50-e.fogFar)/50;t.near=this.cDist-this.bRadius*r,t.far=this.cDist+this.bRadius*s}"camera"!==e.clipMode&&("PerspectiveCamera"===this.camera.type?(this.camera.near=Math.max(.1,e.clipDist,this.camera.near),this.camera.far=Math.max(1,this.camera.far),t.near=Math.max(.1,t.near),t.far=Math.max(1,t.far)):"OrthographicCamera"===this.camera.type&&e.clipDist>0&&(this.camera.near=Math.max(e.clipDist,this.camera.near)))}__updateCamera(){const e=this.camera;e.updateMatrix(),e.updateMatrixWorld(!0),e.updateProjectionMatrix(),function(e,t,i,n,r){let s=new zt;i.getSize(s);const o=s.height,a=i.getPixelRatio(),c="OrthographicCamera"===t.type;rh.set(s.width,s.height),sh.getInverse(t.projectionMatrix),oh.copy(t.projectionMatrix).transpose(),e.traverse((function(e){const t=e.material;if(!t)return;const i=t.uniforms;if(i){if(t.clipNear){const e=(50-t.clipNear)/50,s=n-r*e;i.clipNear.value=s}i.canvasHeight&&(i.canvasHeight.value=o),i.resolution&&i.resolution.value.copy(rh),i.pixelRatio&&(i.pixelRatio.value=a),i.projectionMatrixInverse&&i.projectionMatrixInverse.value.copy(sh),i.projectionMatrixTranspose&&i.projectionMatrixTranspose.value.copy(oh),i.ortho&&(i.ortho.value=c)}}))}(this.scene,e,this.renderer,this.cDist,this.bRadius),function(e,t){e.traverseVisible((function(e){if(!(e instanceof ta&&e.userData.buffer.parameters.sortParticles))return;const i=e.geometry.attributes,n=i.position.count;if(0===n)return;let r,s,o,a,c,l,h,u;ih.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld),nh.multiplyMatrices(t.projectionMatrix,ih),e.userData.sortData?(r=e.userData.sortData,o=r.__zArray,s=r.__sortArray,a=r.__cmpFn):(o=new Float32Array(n),s=new Uint32Array(n),a=function(e,t){const i=o[e],n=o[t];return i>n?1:i<n?-1:0},r={__zArray:o,__sortArray:s,__cmpFn:a},e.userData.sortData=r);for(let e=0;e<n;++e)th.fromArray(i.position.array,3*e),th.applyMatrix4(nh),o[e]=-th.z,s[e]=e;!function(e,t,i=0,n){t=t||function(e,t){return e>t?1:e<t?-1:0};const r=[];let s,o,a,c=-1,l=i,h=n=(n||e.length)-1;function u(t,i){const n=e[t];e[t]=e[i],e[i]=n}for(;;)if(h-l<=25){for(let i=l+1;i<=h;++i){for(s=e[i],o=i-1;o>=l&&t(e[o],s)>0;)e[o+1]=e[o],--o;e[o+1]=s}if(-1===c)break;h=r[c--],l=r[c--]}else{for(o=l+1,a=h,u(l+h>>1,o),t(e[l],e[h])>0&&u(l,h),t(e[o],e[h])>0&&u(o,h),t(e[l],e[o])>0&&u(l,o),s=e[o];;){do{o++}while(t(e[o],s)<0);do{a--}while(t(e[a],s)>0);if(a<o)break;u(o,a)}e[l+1]=e[a],e[a]=s,h-o+1>=a-l?(r[++c]=o,r[++c]=h,h=a-1):(r[++c]=l,r[++c]=a-1,l=o)}}(s,a);for(let e in i){const t=i[e],o=t.array,a=t.itemSize;r[e]||(r[e]=new Float32Array(a*n)),u=r[e],r[e]=o;for(let e=0;e<n;++e){c=s[e];for(let t=0;t<a;++t)l=c*a+t,h=e*a+t,u[h]=o[l]}i[e].array=u,i[e].needsUpdate=!0}}))}(this.scene,e)}__setVisibility(e,t,i,n){this.modelGroup.visible=e,this.pickingGroup.visible=t,this.backgroundGroup.visible=i,this.helperGroup.visible=n}__updateLights(){this.spotLight.color.set(this.parameters.lightColor),this.spotLight.intensity=this.parameters.lightIntensity,this.distVector.copy(this.camera.position).setLength(100*this.boundingBoxLength),this.spotLight.position.copy(this.camera.position).add(this.distVector),this.ambientLight.color.set(this.parameters.ambientColor),this.ambientLight.intensity=this.parameters.ambientIntensity}__renderPickingGroup(e){this.renderer.setRenderTarget(this.pickingTarget||null),this.renderer.clear(),this.__setVisibility(!1,!0,!1,!1),this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.updateInfo()}__renderModelGroup(t,i){this.renderer.setRenderTarget(i||null),this.renderer.clear(),this.__setVisibility(!1,!1,!0,!1),this.renderer.render(this.scene,t),this.renderer.clear(!1,!0,!0),this.updateInfo(),this.__setVisibility(!0,!1,!1,e.Debug),this.renderer.render(this.scene,t),this.renderer.setRenderTarget(null),this.updateInfo()}__renderSuperSample(e,t){const i=Ol[Math.max(0,Math.min(this.sampleLevel,5))],n=1/i.length;this.compositeUniforms.tForeground.value=this.sampleTarget.texture;let r=this.sampleTarget.width;const s=this.sampleTarget.height;"stereo"===this.parameters.cameraType&&(r/=2);for(let t=0;t<i.length;++t){const o=i[t];e.setViewOffset(r,s,o[0],o[1],r,s),e.updateProjectionMatrix(),ah(this.scene,e);let a=n;a+=.03125*((t+.5)/i.length-.5),this.compositeUniforms.scale.value=a,this.__renderModelGroup(e,this.sampleTarget),this.renderer.setRenderTarget(this.holdTarget),0===t&&this.renderer.clear(),this.renderer.render(this.compositeScene,this.compositeCamera)}this.compositeUniforms.scale.value=1,this.compositeUniforms.tForeground.value=this.holdTarget.texture,e.clearViewOffset(),this.renderer.setRenderTarget(t||null),this.renderer.clear(),this.renderer.render(this.compositeScene,this.compositeCamera)}__renderStereo(e=!1,t){const i=this.stereoCamera;i.update(this.perspectiveCamera);const n=this.renderer;let r=new zt;n.getSize(r),n.setScissorTest(!0),n.setScissor(0,0,r.width/2,r.height),n.setViewport(0,0,r.width/2,r.height),ah(this.scene,i.cameraL),this.__render(e,i.cameraL),n.setScissor(r.width/2,0,r.width/2,r.height),n.setViewport(r.width/2,0,r.width/2,r.height),ah(this.scene,i.cameraR),this.__render(e,i.cameraR),n.setScissorTest(!1),n.setViewport(0,0,r.width,r.height)}__render(e=!1,t,i){e?this.lastRenderedPicking||this.__renderPickingGroup(t):this.sampleLevel>0&&"stereo"!==this.parameters.cameraType?this.__renderSuperSample(t,i):this.__renderModelGroup(t,i)}render(e=!1,t){if(this.rendering)il.warn("'tried to call 'render' from within 'render'");else{this.rendering=!0;try{this.__updateClipping(),this.__updateCamera(),this.__updateLights(),this.updateInfo(!0),"stereo"===this.parameters.cameraType?this.__renderStereo(e,t):this.__render(e,this.camera,t),this.lastRenderedPicking=e}finally{this.rendering=!1,this.renderPending=!1}this.signals.rendered.dispatch()}}clear(){il.log("scene cleared"),this.scene.remove(this.rotationGroup),this._initScene(),this.renderer.clear()}dispose(){this.renderer.dispose(),window.cancelAnimationFrame(this.frameRequest)}}function yh(e){const t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;return Math.sqrt(t*t+i*i)}class xh{constructor(e,t={}){this.domElement=e,this.signals={moved:new mc.Signal,scrolled:new mc.Signal,dragged:new mc.Signal,dropped:new mc.Signal,clicked:new mc.Signal,hovered:new mc.Signal,doubleClicked:new mc.Signal},this.position=new zt,this.prevPosition=new zt,this.down=new zt,this.canvasPosition=new zt,this.prevClickCP=new zt,this.moving=!1,this.hovering=!0,this.scrolled=!1,this.lastMoved=1/0,this.which=0,this.buttons=0,this.pressed=!1,this.altKey=!1,this.ctrlKey=!1,this.metaKey=!1,this.shiftKey=!1,this.domElement.style.touchAction="none",this.hoverTimeout=Ia(t.hoverTimeout,50),this.handleScroll=Ia(t.handleScroll,!0),this.doubleClickSpeed=Ia(t.doubleClickSpeed,500),this._listen=this._listen.bind(this),this._onMousewheel=this._onMousewheel.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMousedown=this._onMousedown.bind(this),this._onMouseup=this._onMouseup.bind(this),this._onContextmenu=this._onContextmenu.bind(this),this._onTouchstart=this._onTouchstart.bind(this),this._onTouchend=this._onTouchend.bind(this),this._onTouchmove=this._onTouchmove.bind(this),this._listen();const i={passive:!1};document.addEventListener("mousewheel",this._onMousewheel,i),document.addEventListener("wheel",this._onMousewheel,i),document.addEventListener("MozMousePixelScroll",this._onMousewheel,i),document.addEventListener("mousemove",this._onMousemove,i),document.addEventListener("mousedown",this._onMousedown,i),document.addEventListener("mouseup",this._onMouseup,i),document.addEventListener("contextmenu",this._onContextmenu,i),document.addEventListener("touchstart",this._onTouchstart,i),document.addEventListener("touchend",this._onTouchend,i),document.addEventListener("touchmove",this._onTouchmove,i)}get key(){let e=0;return this.altKey&&(e+=1),this.ctrlKey&&(e+=2),this.metaKey&&(e+=4),this.shiftKey&&(e+=8),e}setParameters(e={}){this.hoverTimeout=Ia(e.hoverTimeout,this.hoverTimeout)}_listen(){const e=window.performance.now(),t=this.canvasPosition;this.doubleClickPending&&e-this.lastClicked>this.doubleClickSpeed&&(this.doubleClickPending=!1),e-this.lastMoved>this.hoverTimeout&&(this.moving=!1),(this.scrolled||!this.moving&&!this.hovering)&&(this.scrolled=!1,-1!==this.hoverTimeout&&this.overElement&&(this.hovering=!0,this.signals.hovered.dispatch(t.x,t.y))),this.frameRequest=window.requestAnimationFrame(this._listen)}_onMousewheel(e){if(e.target!==this.domElement||!this.handleScroll)return;e.preventDefault(),this._setKeys(e);let t=0;"deltaY"in e&&"deltaMode"in e&&void 0!==e.deltaY&&void 0!==e.deltaMode?t=e.deltaMode===WheelEvent.DOM_DELTA_PIXEL?.025*-e.deltaY:e.deltaMode===WheelEvent.DOM_DELTA_LINE?-e.deltaY*(2.5/3):2.5*-e.deltaY:"deltaY"in e&&!("detail"in e)?t=.025*-e.deltaY:void 0!==e.wheelDelta?t=.025*-e.wheelDelta:void 0!==e.wheelDeltaY?t=.025*-e.wheelDeltaY:void 0!==e.detail&&(t=-e.detail/3),this.signals.scrolled.dispatch(t),setTimeout((()=>{this.scrolled=!0}),this.hoverTimeout)}_onMousemove(e){e.target===this.domElement?(e.preventDefault(),this.overElement=!0):this.overElement=!1,this._setKeys(e),this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(e.clientX,e.clientY),this._setCanvasPosition(e);const t=this.prevPosition.x-this.position.x,i=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(t,i),this.pressed&&this.signals.dragged.dispatch(t,i)}_onMousedown(e){e.target===this.domElement&&(e.preventDefault(),this._setKeys(e),this.moving=!1,this.hovering=!1,this.down.set(e.clientX,e.clientY),this.position.set(e.clientX,e.clientY),this.which=e.which,this.buttons=function(e){if("object"==typeof e){if("buttons"in e)return e.buttons;if("which"in e){const t=e.which;if(2===t)return 4;if(3===t)return 2;if(t>0)return 1<<t-1}else if("button"in e){const t=e.button;if(1===t)return 4;if(2===t)return 2;if(t>=0)return 1<<t}}return 0}(e),this.pressed=!0,this._setCanvasPosition(e))}_onMouseup(e){e.target===this.domElement&&e.preventDefault(),this._setKeys(e);const t=this.canvasPosition;this._distance()<4&&(this.lastClicked=window.performance.now(),this.doubleClickPending&&this.prevClickCP.distanceTo(t)<4&&(this.signals.doubleClicked.dispatch(t.x,t.y),this.doubleClickPending=!1),this.signals.clicked.dispatch(t.x,t.y),this.doubleClickPending=!0,this.prevClickCP.copy(t)),this.which=void 0,this.buttons=void 0,this.pressed=void 0}_onContextmenu(e){e.target===this.domElement&&e.preventDefault()}_onTouchstart(e){if(e.target===this.domElement)switch(e.preventDefault(),this.pressed=!0,e.touches.length){case 1:this.moving=!1,this.hovering=!1,this.down.set(e.touches[0].pageX,e.touches[0].pageY),this.position.set(e.touches[0].pageX,e.touches[0].pageY),this._setCanvasPosition(e.touches[0]);break;case 2:this.down.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),this.position.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),this.lastTouchDistance=yh(e)}}_onTouchend(e){e.target===this.domElement&&e.preventDefault(),this.which=void 0,this.buttons=void 0,this.pressed=void 0}_onTouchmove(e){switch(e.target===this.domElement?(e.preventDefault(),this.overElement=!0):this.overElement=!1,e.touches.length){case 1:{this._setKeys(e),this.which=1,this.buttons=1,this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(e.touches[0].pageX,e.touches[0].pageY),this._setCanvasPosition(e.touches[0]);const t=this.prevPosition.x-this.position.x,i=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(t,i),this.pressed&&this.signals.dragged.dispatch(t,i);break}case 2:{const t=yh(e),i=t-this.lastTouchDistance;if(this.lastTouchDistance=t,this.prevPosition.copy(this.position),this.position.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),Math.abs(i)>2&&this.handleScroll&&this.position.distanceTo(this.prevPosition)<2)this.which=0,this.buttons=0,this.signals.scrolled.dispatch(i/2);else{this.which=3,this.buttons=2;const e=this.prevPosition.x-this.position.x,t=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(e,t),this.pressed&&this.signals.dragged.dispatch(e,t)}}}}_distance(){return this.position.distanceTo(this.down)}_setCanvasPosition(e){const t=this.domElement.getBoundingClientRect();let i,n;"clientX"in e&&"clientY"in e?(i=e.clientX-t.left,n=e.clientY-t.top):(i=e.offsetX,n=e.offsetY),this.canvasPosition.set(i,t.height-n)}_setKeys(e){this.altKey=e.altKey,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey}dispose(){document.removeEventListener("mousewheel",this._onMousewheel),document.removeEventListener("wheel",this._onMousewheel),document.removeEventListener("MozMousePixelScroll",this._onMousewheel),document.removeEventListener("mousemove",this._onMousemove),document.removeEventListener("mousedown",this._onMousedown),document.removeEventListener("mouseup",this._onMouseup),document.removeEventListener("contextmenu",this._onContextmenu),document.removeEventListener("touchstart",this._onTouchstart),document.removeEventListener("touchend",this._onTouchend),document.removeEventListener("touchmove",this._onTouchmove),window.cancelAnimationFrame(this.frameRequest)}}const bh=new ri,_h=new ri,wh=new ri,Sh=new ri,Ah=new ri,Mh=new Zt,Ch=new qt,Ph=new qt,Th=new ri,Ih=new Zt,Eh=new Zt;class Dh{constructor(e,t={}){this.stage=e,this.rotateSpeed=Ia(t.rotateSpeed,2),this.zoomSpeed=Ia(t.zoomSpeed,1.2),this.panSpeed=Ia(t.panSpeed,1),this.viewer=e.viewer,this.mouse=e.mouseObserver,this.controls=e.viewerControls}get component(){return this.stage.transformComponent}get atom(){return this.stage.transformAtom}_setPanVector(e,t,i=0){const n=this.controls.getCanvasScaleFactor(i);Ih.set(e,t,0),Ih.multiplyScalar(this.panSpeed*n)}_getRotateXY(e,t){return[this.rotateSpeed*-e*.01,this.rotateSpeed*t*.01]}_getCameraRotation(e){return e.extractRotation(this.viewer.camera.matrixWorld),e.multiply(_h.makeRotationY(Math.PI)),e}_transformPanVector(){this.component&&(Th.extractRotation(this.component.transform),Th.premultiply(this.viewer.rotationGroup.matrix),Th.getInverse(Th),Th.multiply(this._getCameraRotation(Sh)),Ih.applyMatrix4(Th))}zoom(e){this.controls.zoom(this.zoomSpeed*e*.02)}pan(e,t){this._setPanVector(e,t),Th.getInverse(this.viewer.rotationGroup.matrix),Th.multiply(this._getCameraRotation(Sh)),Ih.applyMatrix4(Th),this.controls.translate(Ih)}panComponent(e,t){this.component&&(this._setPanVector(e,t),this._transformPanVector(),this.component.position.add(Ih),this.component.updateMatrix())}panAtom(e,t){this.atom&&this.component&&(this.atom.positionToVector3(Eh),Eh.add(this.viewer.translationGroup.position),Eh.applyMatrix4(this.viewer.rotationGroup.matrix),this._setPanVector(e,t,Eh.z),this._transformPanVector(),this.atom.positionAdd(Ih),this.component.updateRepresentations({position:!0}))}rotate(e,t){const[i,n]=this._getRotateXY(e,t);this._getCameraRotation(Sh),Mh.set(1,0,0),Mh.applyMatrix4(Sh),Ch.setFromAxisAngle(Mh,n),Mh.set(0,1,0),Mh.applyMatrix4(Sh),Ph.setFromAxisAngle(Mh,i),Ch.multiply(Ph),Sh.makeRotationFromQuaternion(Ch),this.controls.applyMatrix(Sh)}zRotate(e,t){const i=this.rotateSpeed*((-e+t)/-2)*.01;wh.makeRotationZ(i),this.controls.applyMatrix(wh)}rotateComponent(e,t){if(!this.component)return;const[i,n]=this._getRotateXY(e,t);this._getCameraRotation(Ah),Sh.extractRotation(this.component.transform),Sh.premultiply(this.viewer.rotationGroup.matrix),Sh.getInverse(Sh),Sh.premultiply(Ah),Mh.set(1,0,0),Mh.applyMatrix4(Sh),bh.makeRotationAxis(Mh,n),Mh.set(0,1,0),Mh.applyMatrix4(Sh),_h.makeRotationAxis(Mh,i),bh.multiply(_h),Ch.setFromRotationMatrix(bh),this.component.quaternion.premultiply(Ch),this.component.quaternion.normalize(),this.component.updateMatrix()}}const Lh=new Zt;class Rh{constructor(e,t){this.stage=t,this.pid=e.pid,this.picker=e.picker,this.instance=e.instance,this.stage=t,this.controls=t.viewerControls,this.mouse=t.mouseObserver}get type(){return this.picker.type}get altKey(){return this.mouse.altKey}get ctrlKey(){return this.mouse.ctrlKey}get metaKey(){return this.mouse.metaKey}get shiftKey(){return this.mouse.shiftKey}get canvasPosition(){return this.mouse.canvasPosition}get component(){return this.stage.getComponentsByObject(this.picker.data).list[0]}get object(){return this.picker.getObject(this.pid)}get position(){return this.picker.getPosition(this.pid,this.instance,this.component)}get closestBondAtom(){if("bond"!==this.type||!this.bond)return;const e=this.bond,t=this.controls,i=this.canvasPosition,n=e.atom1.positionToVector3(),r=e.atom2.positionToVector3();n.applyMatrix4(this.component.matrix),r.applyMatrix4(this.component.matrix);const s=t.getPositionOnCanvas(n),o=t.getPositionOnCanvas(r);return c=s,l=o,(a=i).distanceTo(c)<a.distanceTo(l)?e.atom1:e.atom2;var a,c,l}get closeAtom(){const e=this.canvasPosition,t=this.closestBondAtom;if(!t)return;const i=t.positionToVector3().applyMatrix4(this.component.matrix),n=this.controls.getPositionOnCanvas(i);t.positionToVector3(Lh),this.instance&&Lh.applyMatrix4(this.instance.matrix),Lh.applyMatrix4(this.component.matrix);const r=this.controls.viewer;Lh.add(r.translationGroup.position),Lh.applyMatrix4(r.rotationGroup.matrix);const s=this.controls.getCanvasScaleFactor(Lh.z),o=this.component.getMaxRepresentationRadius(t.index);return e.distanceTo(n)<=o/s?t:void 0}get arrow(){return this._objectIfType("arrow")}get atom(){return this._objectIfType("atom")}get axes(){return this._objectIfType("axes")}get bond(){return this._objectIfType("bond")}get box(){return this._objectIfType("box")}get cone(){return this._objectIfType("cone")}get clash(){return this._objectIfType("clash")}get contact(){return this._objectIfType("contact")}get cylinder(){return this._objectIfType("cylinder")}get distance(){return this._objectIfType("distance")}get ellipsoid(){return this._objectIfType("ellipsoid")}get octahedron(){return this._objectIfType("octahedron")}get point(){return this._objectIfType("point")}get mesh(){return this._objectIfType("mesh")}get slice(){return this._objectIfType("slice")}get sphere(){return this._objectIfType("sphere")}get tetrahedron(){return this._objectIfType("tetrahedron")}get torus(){return this._objectIfType("torus")}get surface(){return this._objectIfType("surface")}get unitcell(){return this._objectIfType("unitcell")}get unknown(){return this._objectIfType("unknown")}get volume(){return this._objectIfType("volume")}get wideline(){return this._objectIfType("wideline")}_objectIfType(e){return this.type===e?this.object:void 0}getLabel(){const e=this.atom||this.closeAtom;let t="nothing";return this.arrow?t=this.arrow.name:e?t=`atom: ${e.qualifiedName()} (${e.structure.name})`:this.axes?t="axes":this.bond?t=`bond: ${this.bond.atom1.qualifiedName()} - ${this.bond.atom2.qualifiedName()} (${this.bond.structure.name})`:this.box?t=this.box.name:this.cone?t=this.cone.name:this.clash?t=`clash: ${this.clash.clash.sele1} - ${this.clash.clash.sele2}`:this.contact?t=`${this.contact.type}: ${this.contact.atom1.qualifiedName()} - ${this.contact.atom2.qualifiedName()} (${this.contact.atom1.structure.name})`:this.cylinder?t=this.cylinder.name:this.distance?t=`distance: ${this.distance.atom1.qualifiedName()} - ${this.distance.atom2.qualifiedName()} (${this.distance.structure.name})`:this.ellipsoid?t=this.ellipsoid.name:this.octahedron?t=this.octahedron.name:this.point?t=this.point.name:this.mesh?t=`mesh: ${this.mesh.name||this.mesh.serial} (${this.mesh.shape.name})`:this.slice?t=`slice: ${this.slice.value.toPrecision(3)} (${this.slice.volume.name})`:this.sphere?t=this.sphere.name:this.surface?t=`surface: ${this.surface.surface.name}`:this.tetrahedron?t=this.tetrahedron.name:this.torus?t=this.torus.name:this.unitcell?t=`unitcell: ${this.unitcell.unitcell.spacegroup} (${this.unitcell.structure.name})`:this.unknown?t="unknown":this.volume?t=`volume: ${this.volume.value.toPrecision(3)} (${this.volume.volume.name})`:this.wideline&&(t=this.wideline.name),t}}class kh{constructor(e){this.stage=e,this.viewer=e.viewer}pick(e,t){const i=this.viewer.pick(e,t);if(i.picker&&"ignore"!==i.picker.type&&void 0!==i.pid){const e=i.picker.array;if(!(e&&i.pid>=e.length))return new Rh(i,this.stage);console.error("pid >= picker.array.length")}}}const Oh=new qt,Bh=new Zt,Nh=new Zt,Fh=new Zt,zh=new Zt,Uh=new ri,$h=new Zt,Gh=new ri;class Vh{constructor(e){this.stage=e,this.signals={changed:new mc.Signal},this.viewer=e.viewer}get position(){return this.viewer.translationGroup.position}get rotation(){return this.viewer.rotationGroup.quaternion}changed(){this.viewer.requestRender(),this.signals.changed.dispatch()}getPositionOnCanvas(e,t){const i=Ha(t,zt);const n=this.viewer;return Fh.copy(e).add(n.translationGroup.position).applyMatrix4(n.rotationGroup.matrix).project(n.camera),i.set((Fh.x+1)*n.width/2,(Fh.y+1)*n.height/2)}getCanvasScaleFactor(e=0){const t=this.viewer.camera;if(t instanceof wa)return 1/t.zoom;{e=Math.abs(e),e+=this.getCameraDistance();const i=Ka(t.fov);return 2*e*Math.tan(i/2)/this.viewer.height}}getOrientation(e){const t=Wa(e);t.copy(this.viewer.rotationGroup.matrix);const i=this.getCameraDistance();return t.scale(zh.set(i,i,i)),t.setPosition(this.viewer.translationGroup.position),t}orient(e){Wa(e).decompose(Bh,Oh,Nh);const t=this.viewer;t.rotationGroup.setRotationFromQuaternion(Oh),t.translationGroup.position.copy(Bh),t.cameraDistance=Nh.z,t.updateZoom(),this.changed()}translate(e){this.viewer.translationGroup.position.add(ja(e)),this.changed()}center(e){this.viewer.translationGroup.position.copy(ja(e)).negate(),this.changed()}zoom(e){this.distance(this.getCameraDistance()*(1-e))}getCameraDistance(){return this.viewer.cameraDistance}distance(e){this.viewer.cameraDistance=Math.max(Math.abs(e),.2),this.viewer.updateZoom(),this.changed()}spin(e,t){Uh.getInverse(this.viewer.rotationGroup.matrix),$h.copy(ja(e)).applyMatrix4(Uh),this.viewer.rotationGroup.rotateOnAxis($h,t),this.changed()}rotate(e){this.viewer.rotationGroup.setRotationFromQuaternion(qa(e)),this.changed()}align(e){Gh.getInverse(Wa(e)),this.viewer.rotationGroup.setRotationFromMatrix(Gh),this.changed()}applyMatrix(e){this.viewer.rotationGroup.applyMatrix4(Wa(e)),this.changed()}}class Hh{constructor(e,t,...i){this.pausedTime=-1,this.elapsedDuration=0,this.pausedDuration=0,this.ignoreGlobalToggle=!1,this._paused=!1,this._resolveList=[],this.duration=Ia(e,1e3),this.controls=t,this.startTime=window.performance.now(),this._init(...i)}get done(){return 1===this.alpha}get paused(){return this._paused}tick(e){if(!this._paused)return this.elapsedDuration=e.currentTime-this.startTime-this.pausedDuration,0===this.duration?this.alpha=1:this.alpha=rc(0,1,this.elapsedDuration/this.duration),this._tick(e),this.done&&this._resolveList.forEach((e=>e())),this.done}pause(e){e&&(this._hold=!0),-1===this.pausedTime&&(this.pausedTime=window.performance.now()),this._paused=!0}resume(e){!e&&this._hold||(this.pausedDuration+=window.performance.now()-this.pausedTime,this._paused=!1,this._hold=!1,this.pausedTime=-1)}toggle(){this._paused?this.resume():this.pause()}then(e){let t;return t=this.done?Promise.resolve():new Promise((e=>this._resolveList.push(e))),t.then(e)}}class jh extends Hh{constructor(e,t,...i){super(Ia(e,1/0),t,...i)}_init(e,t){Array.isArray(e)?this.axis=(new Zt).fromArray(e):this.axis=Ia(e,new Zt(0,1,0)),this.angle=Ia(t,.01)}_tick(e){this.axis&&this.angle&&this.controls.spin(this.axis,this.angle*e.lastDuration/16)}}class Wh extends Hh{constructor(e,t,...i){super(Ia(e,1/0),t,...i),this.angleSum=0,this.direction=1}_init(e,t,i){Array.isArray(e)?this.axis=(new Zt).fromArray(e):this.axis=Ia(e,new Zt(0,1,0)),this.angleStep=Ia(t,.01),this.angleEnd=Ia(i,.2)}_tick(e){if(!this.axis||!this.angleStep||!this.angleEnd)return;const t=rc(0,1,Math.abs(this.angleSum)/this.angleEnd),i=this.angleStep*this.direction*(1.1-t);this.controls.spin(this.axis,i*e.lastDuration/16),this.angleSum+=this.angleStep,this.angleSum>=this.angleEnd&&(this.direction*=-1,this.angleSum=-this.angleEnd)}}class qh extends Hh{_init(e,t){this.moveFrom=ja(Ia(e,new Zt)),this.moveTo=ja(Ia(t,new Zt))}_tick(){this.controls.position.lerpVectors(this.moveFrom,this.moveTo,this.alpha).negate(),this.controls.changed()}}class Xh extends Hh{_init(e,t){this.zoomFrom=e,this.zoomTo=t}_tick(){this.controls.distance(ic(this.zoomFrom,this.zoomTo,this.alpha))}}class Yh extends Hh{constructor(){super(...arguments),this._currentRotation=new qt}_init(e,t){this.rotateFrom=qa(e),this.rotateTo=qa(t),this._currentRotation=new qt}_tick(){this._currentRotation.copy(this.rotateFrom).slerp(this.rotateTo,this.alpha),this.controls.rotate(this._currentRotation)}}class Zh extends Hh{_init(e,t,i){this.valueFrom=e,this.valueTo=t,this.callback=i}_tick(){this.callback(ic(this.valueFrom,this.valueTo,this.alpha))}}class Kh extends Hh{_init(e){this.callback=e}_tick(){1===this.alpha&&this.callback()}}class Qh{constructor(e=[]){this._resolveList=[],this._list=e}get done(){return this._list.every((e=>e.done))}then(e){let t;return t=this.done?Promise.resolve():new Promise((e=>{this._resolveList.push(e),this._list.forEach((e=>{e.then((()=>{this._resolveList.forEach((e=>{e()})),this._resolveList.length=0}))}))})),t.then(e)}}class Jh{constructor(e){this.stage=e,this.animationList=[],this.finishedList=[],this.viewer=e.viewer,this.controls=e.viewerControls}get paused(){return this.animationList.every((e=>e.paused))}add(e){return 0===e.duration?e.tick(this.viewer.stats):this.animationList.push(e),e}remove(e){const t=this.animationList,i=t.indexOf(e);i>-1&&t.splice(i,1)}run(e){const t=this.finishedList,i=this.animationList,n=i.length;for(let r=0;r<n;++r){const n=i[r];n.tick(e)&&t.push(n)}const r=t.length;if(r){for(let e=0;e<r;++e)this.remove(t[e]);t.length=0}}spin(e,t,i){return this.add(new jh(i,this.controls,e,t))}rock(e,t,i,n){return this.add(new Wh(n,this.controls,e,t,i))}rotate(e,t){const i=this.viewer.rotationGroup.quaternion.clone();return this.add(new Yh(t,this.controls,i,e))}move(e,t){const i=this.controls.position.clone().negate();return this.add(new qh(t,this.controls,i,e))}zoom(e,t){const i=this.viewer.camera.position.z;return this.add(new Xh(t,this.controls,i,e))}zoomMove(e,t,i){return new Qh([this.move(e,i),this.zoom(t,i)])}orient(e,t){const i=new Zt,n=new qt,r=new Zt;return Wa(e).decompose(i,n,r),new Qh([this.move(i.negate(),t),this.rotate(n,t),this.zoom(-r.x,t)])}value(e,t,i,n){return this.add(new Zh(n,this.controls,e,t,i))}timeout(e,t){return this.add(new Kh(t,this.controls,e))}spinComponent(e,t,i,n){return this.add(new jh(n,e.controls,t,i))}rockComponent(e,t,i,n,r){return this.add(new Wh(r,e.controls,t,i,n))}moveComponent(e,t,i){const n=e.controls.position.clone().negate();return this.add(new qh(i,e.controls,n,t))}pause(){this.animationList.forEach((e=>e.pause()))}resume(){this.animationList.forEach((e=>e.resume()))}toggle(){this.paused?this.resume():this.pause()}clear(){this.animationList.length=0}dispose(){this.clear()}}class eu{constructor(e,t){if(this.fn=e,this.queue=[],this.pending=!1,this.next=this.next.bind(this),t){for(let e=0,i=t.length;e<i;++e)this.queue.push(t[e]);this.next()}}run(e){this.fn(e,this.next)}next(){const e=this.queue.shift();void 0!==e?(this.pending=!0,setTimeout((()=>this.run(e)))):this.pending=!1}push(e){this.queue.push(e),this.pending||this.next()}kill(){this.queue.length=0}length(){return this.queue.length}}class tu{constructor(e,t,i){this.type="",this.parameters={lazy:{type:"boolean"},clipNear:{type:"range",step:1,max:100,min:0,buffer:!0},clipRadius:{type:"number",precision:1,max:1e3,min:0,buffer:!0},clipCenter:{type:"vector3",precision:1,buffer:!0},flatShaded:{type:"boolean",buffer:!0},opacity:{type:"range",step:.01,max:1,min:0,buffer:!0},depthWrite:{type:"boolean",buffer:!0},side:{type:"select",buffer:!0,options:{front:"front",back:"back",double:"double"}},wireframe:{type:"boolean",buffer:!0},colorData:{type:"hidden",update:"color"},colorScheme:{type:"select",update:"color",options:{}},colorScale:{type:"select",update:"color",options:al.getScales()},colorReverse:{type:"boolean",update:"color"},colorValue:{type:"color",update:"color"},colorDomain:{type:"hidden",update:"color"},colorMode:{type:"select",update:"color",options:al.getModes()},roughness:{type:"range",step:.01,max:1,min:0,buffer:!0},metalness:{type:"range",step:.01,max:1,min:0,buffer:!0},diffuse:{type:"color",buffer:!0},diffuseInterior:{type:"boolean",buffer:!0},useInteriorColor:{type:"boolean",buffer:!0},interiorColor:{type:"color",buffer:!0},interiorDarkening:{type:"range",step:.01,max:1,min:0,buffer:!0},matrix:{type:"hidden",buffer:!0},disablePicking:{type:"boolean",rebuild:!0}},this.viewer=t,this.tasks=new El,this.queue=new eu(this.make.bind(this)),this.bufferList=[],this.parameters.colorScheme&&(this.parameters.colorScheme.options=al.getSchemes()),this.toBePrepared=!1}init(e){const t=e||{};this.clipNear=Ia(t.clipNear,0),this.clipRadius=Ia(t.clipRadius,0),this.clipCenter=Ia(t.clipCenter,new Zt),this.flatShaded=Ia(t.flatShaded,!1),this.side=Ia(t.side,"double"),this.opacity=Ia(t.opacity,1),this.depthWrite=Ia(t.depthWrite,!0),this.wireframe=Ia(t.wireframe,!1),this.setColor(t.color,t),this.colorData=Ia(t.colorData,void 0),this.colorScheme=Ia(t.colorScheme,"uniform"),this.colorScale=Ia(t.colorScale,""),this.colorReverse=Ia(t.colorReverse,!1),this.colorValue=Ia(t.colorValue,9474192),this.colorDomain=Ia(t.colorDomain,void 0),this.colorMode=Ia(t.colorMode,"hcl"),this.visible=Ia(t.visible,!0),this.quality=Ia(t.quality,void 0),this.roughness=Ia(t.roughness,.4),this.metalness=Ia(t.metalness,0),this.diffuse=Ia(t.diffuse,16777215),this.diffuseInterior=Ia(t.diffuseInterior,!1),this.useInteriorColor=Ia(t.useInteriorColor,!1),this.interiorColor=Ia(t.interiorColor,2236962),this.interiorDarkening=Ia(t.interiorDarkening,0),this.lazy=Ia(t.lazy,!1),this.lazyProps={build:!1,bufferParams:{},what:{}},this.matrix=Ia(t.matrix,new ri),this.disablePicking=Ia(t.disablePicking,!1);const i=this.parameters;!0===i.sphereDetail&&(i.sphereDetail={type:"integer",max:3,min:0,rebuild:"impostor"}),!0===i.radialSegments&&(i.radialSegments={type:"integer",max:25,min:5,rebuild:"impostor"}),!0===i.openEnded&&(i.openEnded={type:"boolean",rebuild:"impostor",buffer:!0}),!0===i.disableImpostor&&(i.disableImpostor={type:"boolean",rebuild:!0}),"low"===t.quality?(i.sphereDetail&&(this.sphereDetail=0),i.radialSegments&&(this.radialSegments=5)):"medium"===t.quality?(i.sphereDetail&&(this.sphereDetail=1),i.radialSegments&&(this.radialSegments=10)):"high"===t.quality?(i.sphereDetail&&(this.sphereDetail=2),i.radialSegments&&(this.radialSegments=20)):(i.sphereDetail&&(this.sphereDetail=Ia(t.sphereDetail,1)),i.radialSegments&&(this.radialSegments=Ia(t.radialSegments,10))),i.openEnded&&(this.openEnded=Ia(t.openEnded,!0)),i.disableImpostor&&(this.disableImpostor=Ia(t.disableImpostor,!1))}getColorParams(e){return Object.assign({data:this.colorData,scheme:this.colorScheme,scale:this.colorScale,reverse:this.colorReverse,value:this.colorValue,domain:this.colorDomain,mode:this.colorMode,colorSpace:this.colorSpace},e)}getBufferParams(e={}){return Object.assign({clipNear:this.clipNear,clipRadius:this.clipRadius,clipCenter:this.clipCenter,flatShaded:this.flatShaded,opacity:this.opacity,depthWrite:this.depthWrite,side:this.side,wireframe:this.wireframe,roughness:this.roughness,metalness:this.metalness,diffuse:this.diffuse,diffuseInterior:this.diffuseInterior,useInteriorColor:this.useInteriorColor,interiorColor:this.interiorColor,interiorDarkening:this.interiorDarkening,matrix:this.matrix,disablePicking:this.disablePicking},e)}setColor(e,t){const i=Object.keys(al.getSchemes());if("string"==typeof e&&i.includes(e.toLowerCase()))t?t.colorScheme=e:this.setParameters({colorScheme:e});else if(void 0!==e){let i=new mn(e).getHex();t?(t.colorScheme="uniform",t.colorValue=i):this.setParameters({colorScheme:"uniform",colorValue:i})}return this}prepare(e){}create(){}update(e){this.build()}build(e){if(!this.lazy||this.visible&&this.opacity){if(!this.toBePrepared)return this.tasks.increment(),void this.make();this.queue.length()>0?(this.tasks.change(1-this.queue.length()),this.queue.kill()):this.tasks.increment(),this.queue.push(e||!1)}else this.lazyProps.build=!0}make(t,i){e.Debug&&il.time("Representation.make "+this.type);const n=()=>{t?(this.update(t),this.viewer.requestRender(),this.tasks.decrement(),i&&i()):(this.clear(),this.create(),this.manualAttach||this.disposed||(e.Debug&&il.time("Representation.attach "+this.type),this.attach((()=>{e.Debug&&il.timeEnd("Representation.attach "+this.type),this.tasks.decrement(),i&&i()})))),e.Debug&&il.timeEnd("Representation.make "+this.type)};this.toBePrepared?this.prepare(n):n()}attach(e){this.setVisibility(this.visible),e()}setVisibility(e,t){if(this.visible=e,this.visible&&this.opacity){const e=this.lazyProps,t=e.bufferParams,i=e.what;if(e.build)return e.build=!1,this.build(),this;(Object.keys(t).length||Object.keys(i).length)&&(e.bufferParams={},e.what={},this.updateParameters(t,i))}return this.bufferList.forEach((function(t){t.setVisibility(e)})),t||this.viewer.requestRender(),this}setParameters(e,t={},i=!1){const n=e||{},r=this.parameters,s={};this.opacity||void 0===n.opacity||(this.lazyProps.build?(this.lazyProps.build=!1,i=!0):(Object.assign(s,this.lazyProps.bufferParams),Object.assign(t,this.lazyProps.what),this.lazyProps.bufferParams={},this.lazyProps.what={})),this.setColor(n.color,n);for(let e in n)if(void 0!==n[e]&&null!=r[e]&&(r[e].int&&(n[e]=parseInt(n[e])),r[e].float&&(n[e]=parseFloat(n[e])),n[e]!==this[e]||n[e].equals&&!n[e].equals(this[e]))){if(this[e]&&this[e].copy&&n[e].copy?this[e].copy(n[e]):this[e]&&this[e].set?this[e].set(n[e]):this[e]=n[e],r[e].buffer)if(!0===r[e].buffer)s[e]=n[e];else{s[r[e].buffer]=n[e]}r[e].update&&(t[r[e].update]=!0),!r[e].rebuild||"impostor"===r[e].rebuild&&el&&!this.disableImpostor||(i=!0)}return i?this.build():this.updateParameters(s,t),this}updateParameters(e={},t){if(this.lazy&&(!this.visible||!this.opacity)&&!1===e.hasOwnProperty("opacity"))return Object.assign(this.lazyProps.bufferParams,e),void Object.assign(this.lazyProps.what,t);this.bufferList.forEach((function(t){t.setParameters(e)})),Object.keys(t).length&&this.update(t),this.viewer.requestRender()}getParameters(){const e={lazy:this.lazy,visible:this.visible,quality:this.quality};return Object.keys(this.parameters).forEach((t=>{null!==this.parameters[t]&&(e[t]=this[t])})),e}clear(){this.bufferList.forEach((e=>{this.viewer.remove(e),e.dispose()})),this.bufferList.length=0,this.viewer.requestRender()}dispose(){this.disposed=!0,this.queue.kill(),this.tasks.dispose(),this.clear()}}class iu{constructor(t){this.pending=0,this.postCount=0,this.onmessageDict={},this.onerrorDict={},this.name=t,this.blobUrl=window.URL.createObjectURL(ol.get(t)),this.worker=new Worker(this.blobUrl),ol.activeWorkerCount+=1,this.worker.onmessage=i=>{this.pending-=1;const n=i.data.__postId;e.Debug&&il.timeEnd("Worker.postMessage "+t+" #"+n);const r=this.onmessageDict[n];r&&r.call(this.worker,i),delete this.onmessageDict[n],delete this.onerrorDict[n]},this.worker.onerror=e=>{if(this.pending-=1,e.data){const i=e.data.__postId,n=this.onerrorDict[i];n?n.call(this.worker,e):il.error("Worker.onerror",i,t,e),delete this.onmessageDict[i],delete this.onerrorDict[i]}else il.error("Worker.onerror",t,e)}}post(t={},i,n,r){this.onmessageDict[this.postCount]=n,this.onerrorDict[this.postCount]=r,t.__name=this.name,t.__postId=this.postCount,t.__debug=e.Debug,e.Debug&&il.time(`Worker.postMessage ${this.name} #${this.postCount}`);try{this.worker.postMessage(t,i)}catch(e){il.error("worker.post:",e),this.worker.postMessage(t)}return this.pending+=1,this.postCount+=1,this}terminate(){this.worker?(this.worker.terminate(),window.URL.revokeObjectURL(this.blobUrl),ol.activeWorkerCount-=1):il.log("no worker to terminate")}}class nu{constructor(e,t=2){this.pool=[],this.count=0,this.maxCount=Math.min(8,t),this.name=e}post(e={},t,i,n){const r=this.getNextWorker();return r?r.post(e,t,i,n):console.error("unable to get worker from pool"),this}terminate(){this.pool.forEach((function(e){e.terminate()}))}getNextWorker(){let e,t=1/0;for(let i=0;i<this.maxCount;++i){if(i>=this.count){e=new iu(this.name),this.pool.push(e),this.count+=1;break}const n=this.pool[i];if(0===n.pending){e=n;break}n.pending<t&&(t=n.pending,e=n)}return e}}function ru(e){const t=e.length,i=t/3;let n=0,r=0,s=0;for(let i=0;i<t;i+=3)n+=e[i+0],r+=e[i+1],s+=e[i+2];return new Zt(n/i,r/i,s/i)}function su(e,t,i){return i?e.sub(i).projectOnVector(t).add(i):e.projectOnVector(t),e}function ou(e){let t=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,o=-1/0;for(let a=0,c=e.length;a<c;a+=3){const c=e[a],l=e[a+1],h=e[a+2];c<t&&(t=c),l<i&&(i=l),h<n&&(n=h),c>r&&(r=c),l>s&&(s=l),h>o&&(o=h)}return[hu([t,i,n]),hu([r,s,o])]}function au(e,t){for(let i=0,n=t.length;i<n;i+=3){const n=t[i],r=t[i+1],s=t[i+2];t[i]=e[0]*n+e[4]*r+e[8]*s+e[12],t[i+1]=e[1]*n+e[5]*r+e[9]*s+e[13],t[i+2]=e[2]*n+e[6]*r+e[10]*s+e[14]}}function cu(e,t){for(let i=0,n=t.length;i<n;i+=3){const n=t[i],r=t[i+1],s=t[i+2];t[i]=e[0]*n+e[3]*r+e[6]*s,t[i+1]=e[1]*n+e[4]*r+e[7]*s,t[i+2]=e[2]*n+e[5]*r+e[8]*s}}function lu(e){for(let t=0,i=e.length;t<i;t+=3){const i=e[t],n=e[t+1],r=e[t+2],s=i*i+n*n+r*r;if(s>0){const o=1/Math.sqrt(s);e[t]=i*o,e[t+1]=n*o,e[t+2]=r*o}}}function hu(e){return new Float32Array(e||3)}function uu(e,t,i){const n=t[0],r=t[1],s=t[2],o=i[0],a=i[1],c=i[2];e[0]=r*c-s*a,e[1]=s*o-n*c,e[2]=n*a-r*o}function du(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function fu(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function mu(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function pu(e,t,i=0){e[0]=t[i],e[1]=t[i+1],e[2]=t[i+2]}function gu(e,t,i=0){t[i]=e[0],t[i+1]=e[1],t[i+2]=e[2]}function vu(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function yu(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function xu(e,t,i){bu(e,t,1/i)}function bu(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function _u(e,t){const i=vu(t);0==i?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):bu(e,t,1/Math.sqrt(i))}function wu(e,t,i){e[0]=t[0]-i,e[1]=t[1]-i,e[2]=t[2]-i}function Su(e,t,i){e[0]=t[0]+i,e[1]=t[1]+i,e[2]=t[2]+i}function Au(e,t){e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2])}function Mu(e,t){e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2])}function Cu(e,t){e[0]=-t[0],e[1]=-t[1],e[2]=-t[2]}function Pu(e,t){const i=e[0],n=e[1],r=e[2],s=t[0],o=t[1],a=t[2],c=n*a-r*o,l=r*s-i*a,h=i*o-n*s,u=Math.sqrt(c*c+l*l+h*h),d=i*s+n*o+r*a;return Math.atan2(u,d)}function Tu(e,t=9){const i=Math.floor(t/2),n=e.position1.length/3,r=3*(i*n),s=1/t,o=$l(e.position1,e.position2),a=new Float32Array(r),c=new Float32Array(r),l=new Zt;for(let t=0;t<n;++t){const n=3*t;l.set(o[n],o[n+1],o[n+2]);const r=e.position1[n],h=e.position1[n+1],u=e.position1[n+2];for(let e=0;e<i;++e){const t=i*n+3*e,o=s*(2*e+1),d=s*(2*e+2);a[t]=r+l.x*o,a[t+1]=h+l.y*o,a[t+2]=u+l.z*o,c[t]=r+l.x*d,c[t+1]=h+l.y*d,c[t+2]=u+l.z*d}}const h=Ul(a,c),u=function(e,t){const i=e.length/3,n=new Float32Array(i*t*3);for(let r=0;r<i;++r){const i=3*r,s=r*t*3,o=e[i+0],a=e[i+1],c=e[i+2];for(let e=0;e<t;++e){const t=s+3*e;n[t+0]=o,n[t+1]=a,n[t+2]=c}}return n}(e.color,i),d={position:h,position1:a,position2:c,color:u,color2:u};return e.radius&&(d.radius=Wl(e.radius,i)),e.picking&&e.picking.array&&(e.picking.array=Wl(e.picking.array,i),d.picking=e.picking),e.primitiveId&&(d.primitiveId=Wl(e.primitiveId,i)),d}function Iu(e,t=.1){const i=$l(e.position1,e.position2),n=[],r=[],s=[],o=e.radius?[]:void 0,a=e.picking?[]:void 0,c=e.primitiveId?[]:void 0,l=new Zt,h=e.position1.length/3;let u=0;for(let d=0;d<h;++d){const h=3*d;l.set(i[h],i[h+1],i[h+2]);const f=l.length()/t,m=Math.floor(f/2),p=1/f,g=e.position1[h],v=e.position1[h+1],y=e.position1[h+2];for(let t=0;t<m;++t){const i=3*u+3*t,f=p*(2*t+1),m=p*(2*t+2);n[i]=g+l.x*f,n[i+1]=v+l.y*f,n[i+2]=y+l.z*f,r[i]=g+l.x*m,r[i+1]=v+l.y*m,r[i+2]=y+l.z*m,e.color&&(s[i]=e.color[h],s[i+1]=e.color[h+1],s[i+2]=e.color[h+2]),o&&(o[u+t]=e.radius[d]),a&&(e.picking.array?a[u+t]=e.picking.array[d]:a[u+t]=d),c&&(c[u+t]=e.primitiveId[d])}u+=m}const d=new Float32Array(n),f=new Float32Array(r),m=Ul(d,f),p=new Float32Array(s),g={position:m,position1:d,position2:f,color:p,color2:p};return o&&(g.radius=new Float32Array(o)),a&&e.picking&&(e.picking.array=new Float32Array(a),g.picking=e.picking),c&&(g.primitiveId=new Float32Array(c)),g}function Eu(e,t=.1){const i=$l(e.position1,e.position2),n=[],r=[],s=[],o=e.radius?[]:void 0,a=e.picking?[]:void 0,c=e.primitiveId?[]:void 0,l=new Zt,h=e.position1.length/3;let u=t,d=!0,f=0,m=0,p=0;for(let g=0;g<h;++g){const h=3*g,v=e.position1[h],y=e.position1[h+1],x=e.position1[h+2];l.set(i[h],i[h+1],i[h+2]);const b=l.length();d&&(n[m]=v,n[m+1]=y,n[m+2]=x);let _=u;const w=1/b;for(;_<b;){const e=d?r:n;e[m]=v+l.x*_*w,e[m+1]=y+l.y*_*w,e[m+2]=x+l.z*_*w,d&&(f++,m=3*f),d=!d,u=t,_+=t}d&&(r[m]=e.position2[h],r[m+1]=e.position2[h+1],r[m+2]=e.position2[h+2],f++,m=3*f),u=_-b;for(let t=p;t<f;t++){if(e.color){const i=3*t;s[i]=e.color[h],s[i+1]=e.color[h+1],s[i+2]=e.color[h+2]}o&&(o[t]=e.radius[g]),a&&(e.picking.array?a[t]=e.picking.array[g]:a[t]=g),c&&(c[t]=e.primitiveId[g])}p=f}if(!d&&h>0){const t=3*f;r[t]=e.position2[3*h-3],r[t+1]=e.position2[3*h-2],r[t+1]=e.position2[3*h-1]}const g=new Float32Array(n),v=new Float32Array(r),y=Ul(g,v),x=new Float32Array(s),b={position:y,position1:g,position2:v,color:x,color2:x};return o&&(b.radius=new Float32Array(o)),a&&e.picking&&(e.picking.array=new Float32Array(a),b.picking=e.picking),c&&(b.primitiveId=new Float32Array(c)),b}nu.prototype.constructor=nu,ou.__deps=[hu],xu.__deps=[bu],_u.__deps=[bu,vu];const Du=new Zt;class Lu{static get Picker(){return pl.get(this.type)}static get Buffer(){return ml.get(this.type)}static getShapeKey(e){return this.type+e[0].toUpperCase()+e.substr(1)}static expandBoundingBox(e,t){}static valueToShape(e,t,i){const n=e._primitiveData[this.getShapeKey(t)];switch(this.fields[t]){case"v3":case"c":s=n,void 0!==(r=i).toArray?r=r.toArray():void 0!==r.x?r=[r.x,r.y,r.z]:void 0!==r.r&&(r=[r.r,r.g,r.b]),s.push.apply(s,r);break;default:n.push(i)}var r,s}static objectToShape(e,t){Object.keys(this.fields).forEach((i=>{this.valueToShape(e,i,t[i])})),this.valueToShape(e,"name",t.name),this.expandBoundingBox(e.boundingBox,t)}static valueFromShape(e,t,i){const n=e._primitiveData[this.getShapeKey(i)];switch(this.fields[i]){case"v3":return(new Zt).fromArray(n,3*t);case"c":return(new mn).fromArray(n,3*t);default:return n[t]}}static objectFromShape(e,t){let i=this.valueFromShape(e,t,"name");void 0===i&&(i=`${this.type}: ${t} (${e.name})`);const n={shape:e,name:i};return Object.keys(this.fields).forEach((i=>{n[i]=this.valueFromShape(e,t,i)})),n}static arrayFromShape(e,t){const i=e._primitiveData[this.getShapeKey(t)];return"s"===this.fields[t]?i:new Float32Array(i)}static dataFromShape(e){const t={};return this.Picker&&(t.picking=new this.Picker(e)),Object.keys(this.fields).forEach((i=>{t[i]=this.arrayFromShape(e,i)})),t}static bufferFromShape(e,t){return new this.Buffer(this.dataFromShape(e),t)}}Lu.type="",Lu.fields={};class Ru extends Lu{static positionFromShape(e,t){return this.valueFromShape(e,t,"position")}static expandBoundingBox(e,t){e.expandByPoint(Du.fromArray(t.position))}}Ru.type="sphere",Ru.fields={position:"v3",color:"c",radius:"f"};class ku extends Lu{static positionFromShape(e,t){return this.valueFromShape(e,t,"position")}static expandBoundingBox(e,t){e.expandByPoint(Du.fromArray(t.position))}}ku.type="box",ku.fields={position:"v3",color:"c",size:"f",heightAxis:"v3",depthAxis:"v3"};class Ou extends ku{}Ou.type="octahedron";class Bu extends ku{}Bu.type="tetrahedron";class Nu extends Lu{static positionFromShape(e,t){const i=this.valueFromShape(e,t,"position1"),n=this.valueFromShape(e,t,"position2");return i.add(n).multiplyScalar(.5)}static expandBoundingBox(e,t){e.expandByPoint(Du.fromArray(t.position1)),e.expandByPoint(Du.fromArray(t.position2))}static bufferFromShape(e,t={}){let i=this.dataFromShape(e);return"cylinder"===this.type&&t.dashedCylinder&&(i=Iu(i)),new this.Buffer(i,t)}}Nu.type="cylinder",Nu.fields={position1:"v3",position2:"v3",color:"c",radius:"f"};class Fu extends Nu{}Fu.type="arrow";class zu extends Nu{}zu.type="cone";class Uu extends Ru{}Uu.type="ellipsoid",Uu.fields={position:"v3",color:"c",radius:"f",majorAxis:"v3",minorAxis:"v3"};class $u extends Uu{}$u.type="torus";class Gu extends Lu{static positionFromShape(e,t){return this.valueFromShape(e,t,"position")}static expandBoundingBox(e,t){e.expandByPoint(Du.fromArray(t.position))}}Gu.type="text",Gu.fields={position:"v3",color:"c",size:"f",text:"s"};class Vu extends Lu{static positionFromShape(e,t){return this.valueFromShape(e,t,"position")}static expandBoundingBox(e,t){e.expandByPoint(Du.fromArray(t.position))}}Vu.type="point",Vu.fields={position:"v3",color:"c"};class Hu extends Lu{static positionFromShape(e,t){const i=this.valueFromShape(e,t,"position1"),n=this.valueFromShape(e,t,"position2");return i.add(n).multiplyScalar(.5)}static expandBoundingBox(e,t){e.expandByPoint(Du.fromArray(t.position1)),e.expandByPoint(Du.fromArray(t.position2))}}Hu.type="wideline",Hu.fields={position1:"v3",position2:"v3",color:"c"};class ju{constructor(e,t){this.exp=3;const i=t||function(e){const{x:t,y:i,z:n}=e,r=new Ni,s=t.length,{min:o,max:a}=r;for(let e=0;e<s;e++)o.x=Math.min(t[e],o.x),o.y=Math.min(i[e],o.y),o.z=Math.min(n[e],o.z),a.x=Math.max(t[e],a.x),a.y=Math.max(i[e],a.y),a.z=Math.max(n[e],a.z);return r}(e);this.minX=i.min.x,this.minY=i.min.y,this.minZ=i.min.z,this.boundX=1+(i.max.x-this.minX>>this.exp),this.boundY=1+(i.max.y-this.minY>>this.exp),this.boundZ=1+(i.max.z-this.minZ>>this.exp);const n=this.boundX*this.boundY*this.boundZ,r=void 0!==e.count?e.count:e.x.length,s=e.x,o=e.y,a=e.z;let c=0;const l=new Uint32Array(n),h=new Int32Array(r);for(let e=0;e<r;++e){const t=s[e]-this.minX>>this.exp,i=o[e]-this.minY>>this.exp,n=a[e]-this.minZ>>this.exp,r=(t*this.boundY+i)*this.boundZ+n;1===(l[r]+=1)&&(c+=1),h[e]=r}const u=new Uint16Array(c);for(let e=0,t=0;e<n;++e){const i=l[e];i>0&&(l[e]=t+1,u[t]=i,t+=1)}const d=new Uint32Array(c);for(let e=1;e<c;++e)d[e]+=d[e-1]+u[e-1];const f=new Uint16Array(c),m=new Int32Array(r);for(let e=0;e<r;++e){const t=l[h[e]];if(t>0){const i=t-1;m[d[i]+f[i]]=e,f[i]+=1}}this.grid=l,this.bucketCount=u,this.bucketOffset=d,this.bucketArray=m,this.xArray=s,this.yArray=o,this.zArray=a}within(e,t,i,n){const r=[];return this.eachWithin(e,t,i,n,(e=>r.push(e))),r}eachWithin(e,t,i,n,r){const s=n*n,o=Math.max(0,e-n-this.minX>>this.exp),a=Math.max(0,t-n-this.minY>>this.exp),c=Math.max(0,i-n-this.minZ>>this.exp),l=Math.min(this.boundX,1+(e+n-this.minX>>this.exp)),h=Math.min(this.boundY,1+(t+n-this.minY>>this.exp)),u=Math.min(this.boundZ,1+(i+n-this.minZ>>this.exp));for(let n=o;n<l;++n)for(let o=a;o<h;++o)for(let a=c;a<u;++a){const c=(n*this.boundY+o)*this.boundZ+a,l=this.grid[c];if(l>0){const n=l-1,o=this.bucketOffset[n],a=o+this.bucketCount[n];for(let n=o;n<a;++n){const o=this.bucketArray[n],a=this.xArray[o]-e,c=this.yArray[o]-t,l=this.zArray[o]-i,h=a*a+c*c+l*l;h<=s&&r(o,h)}}}}}class Wu{constructor(e=0){this._fields=this._defaultFields,this._init(0)}get _defaultFields(){return[]}_init(e){this.length=e,this.count=0;for(let e=0,t=this._fields.length;e<t;++e){const[t,i,n]=this._fields[e];this._initField(t,i,n)}}_initField(e,t,i){this[e]=$a(i,this.length*t)}addField(e,t,i){this._fields.push([e,t,i]),this._initField(e,t,i)}resize(e){this.length=Math.round(e||0),this.count=Math.min(this.count,this.length);for(let e=0,t=this._fields.length;e<t;++e){const t=this._fields[e][0],i=this._fields[e][1],n=this.length*i,r=new this[t].constructor(n);this[t].length>n?r.set(this[t].subarray(0,n)):r.set(this[t]),this[t]=r}}growIfFull(){if(this.count>=this.length){const e=Math.round(1.5*this.length);this.resize(Math.max(256,e))}}copyFrom(e,t,i,n){for(let r=0,s=this._fields.length;r<s;++r){const s=this._fields[r][0],o=this._fields[r][1],a=this[s],c=e[s];for(let e=0;e<n;++e){const n=o*(t+e),r=o*(i+e);for(let e=0;e<o;++e)a[n+e]=c[r+e]}}}copyWithin(e,t,i){for(let n=0,r=this._fields.length;n<r;++n){const r=this._fields[n][0],s=this._fields[n][1],o=this[r];for(let n=0;n<i;++n){const i=s*(e+n),r=s*(t+n);for(let e=0;e<s;++e)o[i+e]=o[r+e]}}}sort(e){il.time("Store.sort");const t=this,i=new this.constructor(1);!function n(r,s){if(r<s){let c=Math.floor((r+s)/2),l=r,h=s;do{for(;e(l,c)<0;)l+=1;for(;e(h,c)>0;)h-=1;l<=h&&(l===c?c=h:h===c&&(c=l),(o=l)!==(a=h)&&(i.copyFrom(t,0,o,1),t.copyWithin(o,a,1),t.copyFrom(i,a,0,1)),l+=1,h-=1)}while(l<=h);n(r,h),n(l,s)}var o,a}(0,this.count-1),il.timeEnd("Store.sort")}clear(){this.count=0}dispose(){for(let e=0,t=this._fields.length;e<t;++e){delete this[this._fields[e][0]]}}}class qu extends Wu{get _defaultFields(){return[["index1",1,"int32"],["index2",1,"int32"],["type",1,"int8"]]}addContact(e,t,i){this.growIfFull();const n=this.count;e<t?(this.index1[n]=e,this.index2[n]=t):(this.index2[n]=e,this.index1[n]=t),i&&(this.type[n]=i),this.count+=1}}function Xu(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}class Yu{constructor(e,t){this.length=e,this._words=new Uint32Array(e+32>>>5),!0===t&&this.setAll()}get(e){return 0!=(this._words[e>>>5]&1<<e)}set(e){this._words[e>>>5]|=1<<e}clear(e){this._words[e>>>5]&=~(1<<e)}flip(e){this._words[e>>>5]^=1<<e}_assignRange(e,t,i){if(t<e)return;const n=this._words,r=!0===i?4294967295:0,s=e>>>5,o=t>>>5;for(let e=s+1;e<o;++e)n[e]=r;const a=s<<5,c=o<<5;if(!0===i)if(t-e<32)for(let i=e,r=t+1;i<r;++i)n[i>>>5]|=1<<i;else{for(let t=e,i=a+32;t<i;++t)n[t>>>5]|=1<<t;for(let e=c,i=t+1;e<i;++e)n[e>>>5]|=1<<e}else if(t-e<32)for(let i=e,r=t+1;i<r;++i)n[i>>>5]&=~(1<<i);else{for(let t=e,i=a+32;t<i;++t)n[t>>>5]&=~(1<<t);for(let e=c,i=t+1;e<i;++e)n[e>>>5]&=~(1<<e)}return this}setRange(e,t){return this._assignRange(e,t,!0)}clearRange(e,t){return this._assignRange(e,t,!1)}setBits(...e){const t=this._words,i=e.length;for(let n=0;n<i;++n){const i=e[n];t[i>>>5]|=1<<i}return this}clearBits(...e){const t=this._words,i=e.length;for(let n=0;n<i;++n){const i=e[n];t[i>>>5]&=~(1<<i)}return this}setAll(){return this._assignRange(0,this.length-1,!0)}clearAll(){return this._assignRange(0,this.length-1,!1)}flipAll(){const e=this._words.length,t=this._words,i=32-this.length%32;for(let i=0;i<e-1;++i)t[i]=~t[i];return t[e-1]=~(t[e-1]<<i)>>>i,this}_isRangeValue(e,t,i){if(t<e)return;const n=this._words,r=!0===i?4294967295:0,s=e>>>5,o=t>>>5;for(let e=s+1;e<o;++e)if(n[e]!==r)return!1;if(t-e<32){for(let r=e,s=t+1;r<s;++r)if(!!(n[r>>>5]&1<<r)!==i)return!1}else{const r=o<<5;for(let t=e,r=(s<<5)+32;t<r;++t)if(!!(n[t>>>5]&1<<t)!==i)return!1;for(let e=r,s=t+1;e<s;++e)if(!!(n[e>>>5]&1<<e)!==i)return!1}return!0}isRangeSet(e,t){return this._isRangeValue(e,t,!0)}isRangeClear(e,t){return this._isRangeValue(e,t,!1)}isAllSet(){return this._isRangeValue(0,this.length-1,!0)}isAllClear(){return this._isRangeValue(0,this.length-1,!1)}isSet(...e){const t=this._words,i=e.length;for(let n=0;n<i;++n){const i=e[n];if(0==(t[i>>>5]&1<<i))return!1}return!0}isClear(...e){const t=this._words,i=e.length;for(let n=0;n<i;++n){const i=e[n];if(0!=(t[i>>>5]&1<<i))return!1}return!0}isEqualTo(e){const t=this._words,i=e._words,n=Math.min(t.length,i.length);for(let e=0;e<n;++e)if(t[e]!==i[e])return!1;return!0}getSize(){const e=this._words.length,t=this._words;let i=0;for(let n=0;n<e;++n)i+=Xu(t[n]);return i}difference(e){const t=this._words,i=e._words,n=Math.min(t.length,i.length);for(let e=0;e<n;++e)t[e]=t[e]&~i[e];for(let e=t.length;e<n;++e)t[e]=0;return this}union(e){const t=this._words,i=e._words,n=Math.min(t.length,i.length);for(let e=0;e<n;++e)t[e]|=i[e];for(let e=t.length;e<n;++e)t[e]=0;return this}intersection(e){const t=this._words,i=e._words,n=Math.min(t.length,i.length);for(let e=0;e<n;++e)t[e]&=i[e];for(let e=t.length;e<n;++e)t[e]=0;return this}intersects(e){const t=this._words,i=e._words,n=Math.min(t.length,i.length);for(let e=0;e<n;++e)if(0!=(t[e]&i[e]))return!0;return!1}getIntersectionSize(e){const t=this._words,i=e._words,n=Math.min(t.length,i.length);let r=0;for(let e=0;e<n;++e)r+=Xu(t[e]&i[e]);return r}makeIntersection(e){const t=this._words,i=e._words,n=Math.min(t.length,i.length),r=new Uint32Array(n),s=Object.create(Yu.prototype);s._words=r,s.length=Math.min(this.length,e.length);for(let e=0;e<n;++e)r[e]=t[e]&i[e];return s}forEach(e){const t=this._words.length,i=this._words;let n=0;for(let r=0;r<t;++r){let t=i[r];for(;0!==t;){const i=t&-t;e((r<<5)+Xu(i-1),n),t^=i,++n}}}toArray(){const e=this._words,t=new Array(this.getSize()),i=this._words.length;let n=0;for(let r=0;r<i;++r){let i=e[r];for(;0!==i;){const e=i&-i;t[n++]=(r<<5)+Xu(e-1),i^=e}}return t}toString(){return"{"+this.toArray().join(",")+"}"}toSeleString(){const e=this.toArray().join(",");return e?"@"+e:"NONE"}clone(){const e=Object.create(Yu.prototype);return e.length=this.length,e._words=new Uint32Array(this._words),e}}function Zu(e){const{edgeCount:t,nodeCount:i,nodeArray1:n,nodeArray2:r}=e,s=new Uint8Array(i),o=new Int32Array(i);for(let e=0;e<t;++e)s[n[e]]+=1,s[r[e]]+=1;for(let e=1;e<i;++e)o[e]+=o[e-1]+s[e-1];const a=2*t,c=new Int32Array(a);for(let e=0;e<a;++e)c[e]=-1;for(let e=0;e<t;++e){const t=n[e],i=r[e];let s=o[t];for(;-1!==c[s]&&s<a;)s+=1;c[s]=e;let l=o[i];for(;-1!==c[l]&&l<a;)l+=1;c[l]=e}return{countArray:s,offsetArray:o,indexArray:c}}function Ku(e=0,t=0){return{type:e,group:t,x:0,y:0,z:0,atomSet:[]}}function Qu(e,t){e.x+=t.x,e.y+=t.y,e.z+=t.z,e.atomSet.push(t.index)}function Ju(e,t){const i=t.atomSet.length;if(i>0){const{types:n,groups:r,centers:s,atomSets:o}=e;n.push(t.type),r.push(t.group),s.x.push(t.x/i),s.y.push(t.y/i),s.z.push(t.z/i),o.push(t.atomSet)}}const ed=0,td=["D-BETA-PEPTIDE, C-GAMMA LINKING","D-GAMMA-PEPTIDE, C-DELTA LINKING","D-PEPTIDE COOH CARBOXY TERMINUS","D-PEPTIDE NH3 AMINO TERMINUS","D-PEPTIDE LINKING","L-BETA-PEPTIDE, C-GAMMA LINKING","L-GAMMA-PEPTIDE, C-DELTA LINKING","L-PEPTIDE COOH CARBOXY TERMINUS","L-PEPTIDE NH3 AMINO TERMINUS","L-PEPTIDE LINKING","PEPTIDE LINKING","PEPTIDE-LIKE"],id=["RNA OH 3 PRIME TERMINUS","RNA OH 5 PRIME TERMINUS","RNA LINKING"],nd=["DNA OH 3 PRIME TERMINUS","DNA OH 5 PRIME TERMINUS","DNA LINKING","L-DNA LINKING","L-RNA LINKING"],rd=["D-SACCHARIDE","D-SACCHARIDE 1,4 AND 1,4 LINKING","D-SACCHARIDE 1,4 AND 1,6 LINKING","L-SACCHARIDE","L-SACCHARIDE 1,4 AND 1,4 LINKING","L-SACCHARIDE 1,4 AND 1,6 LINKING","SACCHARIDE"],sd=["NON-POLYMER"].concat(["OTHER"],rd),od=["h","g","i"],ad=["e","b"],cd=["s","t","l",""],ld={H:1,D:1,T:1,HE:2,LI:3,BE:4,B:5,C:6,N:7,O:8,F:9,NE:10,NA:11,MG:12,AL:13,SI:14,P:15,S:16,CL:17,AR:18,K:19,CA:20,SC:21,TI:22,V:23,CR:24,MN:25,FE:26,CO:27,NI:28,CU:29,ZN:30,GA:31,GE:32,AS:33,SE:34,BR:35,KR:36,RB:37,SR:38,Y:39,ZR:40,NB:41,MO:42,TC:43,RU:44,RH:45,PD:46,AG:47,CD:48,IN:49,SN:50,SB:51,TE:52,I:53,XE:54,CS:55,BA:56,LA:57,CE:58,PR:59,ND:60,PM:61,SM:62,EU:63,GD:64,TB:65,DY:66,HO:67,ER:68,TM:69,YB:70,LU:71,HF:72,TA:73,W:74,RE:75,OS:76,IR:77,PT:78,AU:79,HG:80,TL:81,PB:82,BI:83,PO:84,AT:85,RN:86,FR:87,RA:88,AC:89,TH:90,PA:91,U:92,NP:93,PU:94,AM:95,CM:96,BK:97,CF:98,ES:99,FM:100,MD:101,NO:102,LR:103,RF:104,DB:105,SG:106,BH:107,HS:108,MT:109,DS:110,RG:111,CN:112,NH:113,FL:114,MC:115,LV:116,TS:117,OG:118},hd={1:1.1,2:1.4,3:1.81,4:1.53,5:1.92,6:1.7,7:1.55,8:1.52,9:1.47,10:1.54,11:2.27,12:1.73,13:1.84,14:2.1,15:1.8,16:1.8,17:1.75,18:1.88,19:2.75,20:2.31,21:2.3,22:2.15,23:2.05,24:2.05,25:2.05,26:2.05,27:2,28:2,29:2,30:2.1,31:1.87,32:2.11,33:1.85,34:1.9,35:1.83,36:2.02,37:3.03,38:2.49,39:2.4,40:2.3,41:2.15,42:2.1,43:2.05,44:2.05,45:2,46:2.05,47:2.1,48:2.2,49:2.2,50:1.93,51:2.17,52:2.06,53:1.98,54:2.16,55:3.43,56:2.68,57:2.5,58:2.48,59:2.47,60:2.45,61:2.43,62:2.42,63:2.4,64:2.38,65:2.37,66:2.35,67:2.33,68:2.32,69:2.3,70:2.28,71:2.27,72:2.25,73:2.2,74:2.1,75:2.05,76:2,77:2,78:2.05,79:2.1,80:2.05,81:1.96,82:2.02,83:2.07,84:1.97,85:2.02,86:2.2,87:3.48,88:2.83,89:2,90:2.4,91:2,92:2.3,93:2,94:2,95:2,96:2,97:2,98:2,99:2,100:2,101:2,102:2,103:2,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:2,114:2,115:2,116:2,117:2,118:2},ud={1:.31,2:.28,3:1.28,4:.96,5:.84,6:.76,7:.71,8:.66,9:.57,10:.58,11:1.66,12:1.41,13:1.21,14:1.11,15:1.07,16:1.05,17:1.02,18:1.06,19:2.03,20:1.76,21:1.7,22:1.6,23:1.53,24:1.39,25:1.39,26:1.32,27:1.26,28:1.24,29:1.32,30:1.22,31:1.22,32:1.2,33:1.19,34:1.2,35:1.2,36:1.16,37:2.2,38:1.95,39:1.9,40:1.75,41:1.64,42:1.54,43:1.47,44:1.46,45:1.42,46:1.39,47:1.45,48:1.44,49:1.42,50:1.39,51:1.39,52:1.38,53:1.39,54:1.4,55:2.44,56:2.15,57:2.07,58:2.04,59:2.03,60:2.01,61:1.99,62:1.98,63:1.98,64:1.96,65:1.94,66:1.92,67:1.92,68:1.89,69:1.9,70:1.87,71:1.87,72:1.75,73:1.7,74:1.62,75:1.51,76:1.44,77:1.41,78:1.36,79:1.36,80:1.32,81:1.45,82:1.46,83:1.48,84:1.4,85:1.5,86:1.5,87:2.6,88:2.21,89:2.15,90:2.06,91:2,92:1.96,93:1.9,94:1.87,95:1.8,96:1.69,97:1.6,98:1.6,99:1.6,100:1.6,101:1.6,102:1.6,103:1.6,104:1.6,105:1.6,106:1.6,107:1.6,108:1.6,109:1.6,110:1.6,111:1.6,112:1.6,113:1.6,114:1.6,115:1.6,116:1.6,117:1.6,118:1.6},dd={1:[1],2:[0],3:[1],4:[2],5:[3],6:[4],7:[3],8:[2],9:[1],10:[0],11:[1],12:[2],13:[6],14:[6],15:[3,5,7],16:[2,4,6],17:[1],18:[0],19:[1],20:[2],31:[3],32:[4],33:[3,5],34:[2,4,6],35:[1],36:[0],37:[1],38:[2],49:[3],50:[4],51:[3,5],52:[2],53:[1,2,5],54:[0,2],55:[1],56:[2],81:[3],82:[4],83:[3],84:[2],85:[1],86:[0],87:[1],88:[2]},fd={1:1,2:2,3:1,4:2,5:3,6:4,7:5,8:6,9:7,10:8,11:1,12:2,13:3,14:4,15:5,16:6,17:7,18:8,19:1,20:2,21:3,22:4,23:5,24:6,25:7,26:8,27:9,28:10,29:11,30:2,31:3,32:4,33:5,34:6,35:7,36:8,37:1,38:2,39:3,40:4,41:5,42:6,43:7,44:8,45:9,46:10,47:11,48:2,49:3,50:4,51:5,52:6,53:7,54:8,55:1,56:2,57:3,58:4,59:3,60:4,61:5,62:6,63:7,64:8,65:9,66:10,67:11,68:12,69:13,70:14,71:15,72:4,73:5,74:6,75:7,76:8,77:9,78:10,79:11,80:2,81:3,82:4,83:5,84:6,85:7,86:8,87:1,88:2,89:3,90:4,91:3,92:4,93:5,94:6,95:7,96:8,97:9,98:10,99:11,100:12,101:13,102:14,103:15,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:3,114:4,115:5,116:6,117:7,118:8},md={ALA:[.17,.5,.33],ARG:[.81,1.81,1],ASN:[.42,.85,.43],ASP:[1.23,3.64,2.41],ASH:[-.07,.43,.5],CYS:[-.24,-.02,.22],GLN:[.58,.77,.19],GLU:[2.02,3.63,1.61],GLH:[-.01,.11,.12],GLY:[.01,1.15,1.14],HIS:[.17,.11,-.06],ILE:[-.31,-1.12,-.81],LEU:[-.56,-1.25,-.69],LYS:[.99,2.8,1.81],MET:[-.23,-.67,-.44],PHE:[-1.13,-1.71,-.58],PRO:[.45,.14,-.31],SER:[.13,.46,.33],THR:[.14,.25,.11],TRP:[-1.85,-2.09,-.24],TYR:[-.94,-.71,.23],VAL:[.07,-.46,-.53]},pd=[0,0,0],gd={HIS:"H",ARG:"R",LYS:"K",ILE:"I",PHE:"F",LEU:"L",TRP:"W",ALA:"A",MET:"M",PRO:"P",CYS:"C",ASN:"N",VAL:"V",GLY:"G",SER:"S",GLN:"Q",TYR:"Y",ASP:"D",GLU:"E",THR:"T",SEC:"U",PYL:"O"},vd=Object.keys(gd),yd=["A","C","T","G","U","I"],xd=["DA","DC","DT","DG","DU","DI"],bd=["A","G","I","DA","DG","DI"],_d=yd.concat(xd),wd=["SOL","WAT","HOH","H2O","W","DOD","D3O","TIP3","TIP4","SPC"],Sd=["118","119","1AL","1CU","2FK","2HP","2OF","3CO","3MT","3NI","3OF","3P8","4MO","4PU","543","6MO","ACT","AG","AL","ALF","AM","ATH","AU","AU3","AUC","AZI","BA","BCT","BEF","BF4","BO4","BR","BS3","BSY","CA","CAC","CD","CD1","CD3","CD5","CE","CHT","CL","CO","CO3","CO5","CON","CR","CS","CSB","CU","CU1","CU3","CUA","CUZ","CYN","DME","DMI","DSC","DTI","DY","E4N","EDR","EMC","ER3","EU","EU3","F","FE","FE2","FPO","GA","GD3","GEP","HAI","HG","HGC","IN","IOD","IR","IR3","IRI","IUM","K","KO4","LA","LCO","LCP","LI","LU","MAC","MG","MH2","MH3","MLI","MLT","MMC","MN","MN3","MN5","MN6","MO1","MO2","MO3","MO4","MO5","MO6","MOO","MOS","MOW","MW1","MW2","MW3","NA","NA2","NA5","NA6","NAO","NAW","NCO","NET","NH4","NI","NI1","NI2","NI3","NO2","NO3","NRU","O4M","OAA","OC1","OC2","OC3","OC4","OC5","OC6","OC7","OC8","OCL","OCM","OCN","OCO","OF1","OF2","OF3","OH","OS","OS4","OXL","PB","PBM","PD","PDV","PER","PI","PO3","PO4","PR","PT","PT4","PTN","RB","RH3","RHD","RU","SB","SCN","SE4","SEK","SM","SMO","SO3","SO4","SR","T1A","TB","TBA","TCN","TEA","TH","THE","TL","TMA","TRA","UNX","V","VN3","VO4","W","WO5","Y1","YB","YB2","YH","YT3","ZCM","ZN","ZN2","ZN3","ZNO","ZO3","OHX"],Ad=["045","0AT","0BD","0MK","0NZ","0TS","0V4","0XY","0YT","10M","147","149","14T","15L","16G","18T","18Y","1AR","1BW","1GL","1GN","1JB","1LL","1NA","1S3","26M","26Q","26R","26V","26W","26Y","27C","289","291","293","2DG","2F8","2FG","2FL","2FP","2GL","2M4","2M5","32O","34V","3CM","3DO","3DY","3FM","3LR","3MF","3MG","3SA","3ZW","46D","46M","46Z","48Z","4CQ","4GC","4NN","50A","5DI","5GF","5MM","5RP","5SA","5SP","64K","6PG","6SA","7JZ","7SA","A1Q","A2G","AAB","AAL","AAO","ABC","ABD","ABE","ABF","ABL","ACG","ACI","ACR","ACX","ADA","ADG","ADR","AF1","AFD","AFL","AFO","AFP","AFR","AGC","AGH","AGL","AHR","AIG","ALL","ALX","AMU","AOG","AOS","ARA","ARB","ARE","ARI","ASG","ASO","AXP","AXR","B0D","B16","B2G","B4G","B6D","B8D","B9D","BBK","BCD","BDG","BDP","BDR","BEM","BFP","BGC","BGL","BGP","BGS","BHG","BMA","BMX","BNG","BNX","BOG","BRI","BXF","BXP","BXX","BXY","C3X","C4X","C5X","CAP","CBI","CBK","CBS","CDR","CEG","CGF","CHO","CR1","CR6","CRA","CT3","CTO","CTR","CTT","D6G","DAF","DAG","DDA","DDB","DDL","DEL","DFR","DFX","DG0","DGC","DGD","DGM","DGS","DIG","DLF","DLG","DMU","DNO","DOM","DP5","DQQ","DQR","DR2","DR3","DR4","DRI","DSR","DT6","DVC","E4P","E5G","EAG","EBG","EBQ","EGA","EJT","EPG","ERE","ERI","F1P","F1X","F6P","FBP","FCA","FCB","FCT","FDP","FDQ","FFC","FIX","FMO","FRU","FSI","FU4","FUB","FUC","FUD","FUL","FXP","G16","G1P","G2F","G3I","G4D","G4S","G6D","G6P","G6S","GAC","GAD","GAL","GC1","GC4","GCD","GCN","GCO","GCS","GCT","GCU","GCV","GCW","GCX","GE1","GFG","GFP","GIV","GL0","GL2","GL5","GL6","GL7","GL9","GLA","GLB","GLC","GLD","GLF","GLG","GLO","GLP","GLS","GLT","GLW","GMH","GN1","GNX","GP1","GP4","GPH","GPM","GQ1","GQ2","GQ4","GS1","GS4","GSA","GSD","GTE","GTH","GTK","GTR","GTZ","GU0","GU1","GU2","GU3","GU4","GU5","GU6","GU8","GU9","GUF","GUP","GUZ","GYP","GYV","H2P","HDL","HMS","HS2","HSD","HSG","HSH","HSJ","HSQ","HSR","HSU","HSX","HSY","HSZ","IAB","IDG","IDR","IDS","IDT","IDU","IDX","IDY","IMK","IN1","IPT","ISL","KBG","KD2","KDA","KDM","KDO","KFN","KO1","KO2","KTU","L6S","LAG","LAI","LAK","LAO","LAT","LB2","LBT","LCN","LDY","LGC","LGU","LM2","LMT","LMU","LOG","LOX","LPK","LSM","LTM","LVZ","LXB","LXZ","M1F","M3M","M6P","M8C","MA1","MA2","MA3","MAB","MAG","MAL","MAN","MAT","MAV","MAW","MBG","MCU","MDA","MDM","MDP","MFA","MFB","MFU","MG5","MGA","MGL","MLB","MMA","MMN","MN0","MRP","MTT","MUG","MVP","MXY","N1L","N9S","NAA","NAG","NBG","NDG","NED","NG1","NG6","NGA","NGB","NGC","NGE","NGF","NGL","NGS","NGY","NHF","NM6","NM9","NTF","NTO","NTP","NXD","NYT","OPG","OPM","ORP","OX2","P3M","P53","P6P","PA5","PNA","PNG","PNW","PRP","PSJ","PSV","PTQ","QDK","QPS","QV4","R1P","R1X","R2B","R5P","RAA","RAE","RAF","RAM","RAO","RAT","RB5","RBL","RCD","RDP","REL","RER","RF5","RG1","RGG","RHA","RIB","RIP","RNS","RNT","ROB","ROR","RPA","RST","RUB","RUU","RZM","S6P","S7P","SA0","SCR","SDD","SF6","SF9","SG4","SG5","SG6","SG7","SGA","SGC","SGD","SGN","SGS","SHB","SHG","SI3","SIO","SOE","SOL","SSG","SUC","SUP","SUS","T6P","T6T","TAG","TCB","TDG","TGK","TGY","TH1","TIA","TM5","TM6","TM9","TMR","TMX","TOA","TOC","TRE","TYV","UCD","UDC","VG1","X0X","X1X","X2F","X4S","X5S","X6X","XBP","XDN","XDP","XIF","XIM","XLF","XLS","XMM","XUL","XXR","XYP","XYS","YO5","Z3Q","Z6J","Z9M","ZDC","ZDM"],Md=["CA","C","N","O","O1","O2","OC1","OC2","OX1","OXT","OT1","OT2","H","H1","H2","H3","HA","HN","BB"],Cd=["P","OP1","OP2","HOP2","HOP3","O2'","O3'","O4'","O5'","C1'","C2'","C3'","C4'","C5'","H1'","H2'","H2''","HO2'","H3'","H4'","H5'","H5''","HO3'","HO5'","O2*","O3*","O4*","O5*","C1*","C2*","C3*","C4*","C5*"],Pd={1:{trace:"CA",direction1:"C",direction2:["O","OC1","O1","OX1","OXT","OT1","OT2"],backboneStart:"N",backboneEnd:"C"},2:{trace:["C4'","C4*"],direction1:["C1'","C1*"],direction2:["C3'","C3*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},3:{trace:["C3'","C3*"],direction1:["C2'","C2*"],direction2:["O4'","O4*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},4:{trace:["CA","BB"],backboneStart:["CA","BB"],backboneEnd:["CA","BB"]},5:{trace:["C4'","C4*","P"],backboneStart:["C4'","C4*","P"],backboneEnd:["C4'","C4*","P"]},6:{trace:["C3'","C3*","C2'","P"],backboneStart:["C3'","C3*","C2'","P"],backboneEnd:["C3'","C3*","C2'","P"]}};Pd[ed]={};const Td={HD:"H",HS:"H",A:"C",NA:"N",NS:"N",OA:"O",OS:"O",SA:"S",G0:"C",G1:"C",G2:"C",G3:"C",CG0:"C",CG1:"C",CG2:"C",CG3:"C",W:"O"};function Id(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;default:return 8}}const Ed=new Map([[2,Ka(180)],[3,Ka(120)],[4,Ka(109.4721)],[6,Ka(90)]]);function Dd(e,t){let i=[];const n=new Zt,r=new Zt;return n.subVectors(t,e),e.eachBondedAtom((t=>{1!==t.number&&(r.subVectors(t,e),i.push(n.angleTo(r)))})),i}function Ld(e,t){const i=e.clone(),n=new Zt;n.subVectors(t,e);const r=[new Zt,new Zt];let s=0;if(e.eachBondedAtom((t=>{s>1||1!==t.number&&(i.index=t.index,r[s++].subVectors(t,e))})),1===s&&i.eachBondedAtom((t=>{s>1||1!==t.number&&t.index!==e.index&&r[s++].subVectors(t,e)})),2!==s)return;const o=r[0].cross(r[1]);return Math.abs(Math.PI/2-o.angleTo(n))}function Rd(e,t){const i=e.structure,n=i.atomCount,r=new Int8Array(n),s=new Int8Array(n),o=new Int8Array(n),a=new Int8Array(n);return i.eachAtom((e=>{const i=e.index,[n,c,l,h]=function(e,t){const i=e.bondToElementCount(1);let n=e.formalCharge||0;const r="always"===t.assignCharge||"auto"===t.assignCharge&&0===n,s="always"===t.assignH||"auto"===t.assignH&&0===i,o=e.bondCount,a=function(e){let t=0;return e.eachBond((e=>t+=e.bondOrder)),t}(e),c=function(e){const t=e.structure.getBondProxy(),i=e.number,n=8===i||7===i;if(n&&4===e.bondCount)return!1;let r=!1;return e.eachBond((i=>{if(i.bondOrder>1)r=!0;else if(n){const n=i.getOtherAtom(e);n.eachBond((e=>{if(e.bondOrder>1){const t=n.number;if((15===t||16===t)&&8===e.getOtherAtom(n).number)return;r=!0}}),t)}})),r}(e),l=a-o>0;let h=0,u=8;switch(e.number){case 1:r&&(0===o?(n=1,u=0):1===o&&(n=0,u=1));break;case 6:r&&(n=0),s&&(h=Math.max(0,4-a-Math.abs(n))),u=Id(o+h+Math.max(0,-n));break;case 7:if(r)if(s)if(c&&a<4)n=o-i==1&&a-i==2?1:0;else{let t=!1;e.eachBondedAtom((e=>{(16===e.number||e.isMetal())&&(t=!0)})),n=t?0:1}else n=a-3;s&&(h=Math.max(0,3-a+n)),u=Id(c&&!l?o+h-n:o+h+1-n);break;case 8:r&&(s||(n=a-2),1===a&&e.eachBondedAtom((t=>{t.eachBond((i=>{const r=i.getOtherAtom(t);r.index!==e.index&&8===r.number&&2===i.bondOrder&&(n=-1)}))}))),s&&(h=Math.max(0,2-a+n)),u=Id(c&&!l?o+h-n+1:o+h-n+2);break;case 16:r&&(s||(n=a<=3&&!e.bondToElementCount(8)?a-2:0)),s&&a<2&&(h=Math.max(0,2-a+n)),a<=3&&(u=Id(o+h-n+2));break;case 9:case 17:case 35:case 53:case 85:r&&(n=a-1);break;case 3:case 11:case 19:case 37:case 55:case 87:r&&(n=1-a);break;case 4:case 12:case 20:case 38:case 56:case 88:r&&(n=2-a);break;default:console.warn("Requested charge, protonation for an unhandled element",e.element)}return[n,h,h+i,u]}(e,t);r[i]=n,s[i]=c,o[i]=l,a[i]=h})),{charge:r,implicitH:s,totalH:o,idealGeometry:a}}function kd(e){if(e["@valenceModel"])return e["@valenceModel"];const t=Rd(e,{assignCharge:"auto",assignH:"auto"});return e["@valenceModel"]=t,t}function Od(e){return 15===e.number&&e.bondToElementCount(8)===e.bondCount}const Bd=["ARG","HIS","LYS"],Nd=["GLU","ASP"];function Fd(e,t){return 2===e&&1===t||1===e&&2===t}function zd(e,t){return 3===e&&3===t}function Ud(e,t){return 3===e&&1===t||1===e&&3===t}function $d(e){return"HIS"===e.resname&&7==e.number&&e.isRing()}function Gd(e,t){return 5===e&&4===t||4===e&&5===t}function Vd(e,t){return 9===e&&5===t||5===e&&9===t}const Hd=[3,11,19,37,55,12,20,38,56,13,31,49,81,21,50,82,83,51,80];function jd(e,t){return 12===e?11===t||12===t:13===e?10===t:void 0}const Wd=[17,35,53,85];const qd=[7,8,16],Xd=[6,7,15,16];const Yd=Ka(180),Zd=Ka(120);function Kd(e,t,i){return!Jd(e,t,i)&&(e.modelIndex!==t.modelIndex||e.altloc&&t.altloc&&e.altloc!==t.altloc)}const Qd={maxHydrophobicDist:4,maxHbondDist:3.5,maxHbondSulfurDist:4.1,maxHbondAccAngle:45,maxHbondDonAngle:45,maxHbondAccPlaneAngle:90,maxHbondDonPlaneAngle:30,maxPiStackingDist:5.5,maxPiStackingOffset:2,maxPiStackingAngle:30,maxCationPiDist:6,maxCationPiOffset:2,maxIonicDist:5,maxHalogenBondDist:4,maxHalogenBondAngle:30,maxMetalDist:3,refineSaltBridges:!0,masterModelIndex:-1,lineOfSightDistFactor:1};function Jd(e,t,i){return e.modelIndex===i&&t.modelIndex!==i||t.modelIndex===i&&e.modelIndex!==i}function ef(e,t,i){return!Jd(e,t,i)&&(e.modelIndex!==t.modelIndex||e.residueIndex===t.residueIndex||e.altloc&&t.altloc&&e.altloc!==t.altloc)}function tf(t){const i={types:[],groups:[],centers:{x:[],y:[],z:[]},atomSets:[]};return e.Debug&&il.time("calculateFeatures"),function(e,t){const{charge:i}=kd(e.data),n={};e.eachResidue((e=>{if(Bd.includes(e.resname)){const i=Ku(1);e.eachAtom((e=>{7===e.number&&e.isSidechain()&&Qu(i,e)})),Ju(t,i)}else vd.includes(e.resname)||e.isNucleic()||(e.eachAtom((e=>{let i=!1;const r=Ku(1);!function(e){let t=0;return 6===e.number&&3===e.bondCount&&3===e.bondToElementCount(7)&&e.eachBondedAtom((e=>{e.bondCount-e.bondToElementCount(1)==1&&++t})),2===t}(e)?function(e){let t=0;return 6===e.number&&3===e.bondCount&&2===e.bondToElementCount(7)&&1===e.bondToElementCount(6)&&e.eachBondedAtom((e=>{e.bondCount-e.bondToElementCount(1)==1&&++t})),2===t}(e)&&(r.group=9,i=!0):(r.group=8,i=!0),i&&(e.eachBondedAtom((e=>{7===e.number&&(n[e.index]=!0,Qu(r,e))})),Ju(t,r))})),e.eachAtom((e=>{const r=Ku(1);i[e.index]>0&&(n[e.index]||(Qu(r,e),Ju(t,r)))})))}))}(t,i),function(e,t){const{charge:i}=kd(e.data),n={};e.eachResidue((e=>{if(Nd.includes(e.resname)){const i=Ku(2);e.eachAtom((e=>{8===e.number&&e.isSidechain()&&Qu(i,e)})),Ju(t,i)}else if(_d.includes(e.resname)){const i=Ku(2);e.eachAtom((e=>{Od(e)&&(i.group=6,e.eachBondedAtom((e=>{8===e.number&&Qu(i,e)})),Ju(t,i))}))}else vd.includes(e.resname)||_d.includes(e.resname)||(e.eachAtom((e=>{let i=!1;const r=Ku(2);!function(e){return 16===e.number&&3===e.bondToElementCount(8)}(e)?Od(e)?(r.group=6,i=!0):function(e){return 16===e.number&&4===e.bondToElementCount(8)}(e)?(r.group=5,i=!0):function(e){let t=0;return 6===e.number&&2===e.bondToElementCount(8)&&1===e.bondToElementCount(6)&&e.eachBondedAtom((e=>{8===e.number&&e.bondCount-e.bondToElementCount(1)==1&&++t})),2===t}(e)&&(r.group=10,i=!0):(r.group=4,i=!0),i&&(e.eachBondedAtom((e=>{8===e.number&&(n[e.index]=!0,Qu(r,e))})),Ju(t,r))})),e.eachAtom((e=>{const r=Ku(2);i[e.index]<0&&(n[e.index]||(Qu(r,e),Ju(t,r)))})))}))}(t,i),function(e,t){const i=e.getAtomProxy();e.eachResidue((e=>{const n=e.getAromaticRings();if(n){const r=e.atomOffset;n.forEach((e=>{const n=Ku(3);e.forEach((e=>{i.index=e+r,Qu(n,i)})),Ju(t,n)}))}}))}(t,i),function(e,t){const{charge:i,implicitH:n,idealGeometry:r}=kd(e.data);e.eachAtom((e=>{const s=Ku(5),o=e.number;if(8===o)Qu(s,e),Ju(t,s);else if(7===o){if($d(e))Qu(s,e),Ju(t,s);else if(i[e.index]<1){const i=e.bondCount+n[e.index],o=r[e.index];(4===o&&i<4||3===o&&i<3||2===o&&i<2)&&(Qu(s,e),Ju(t,s))}}else 16===o&&("CYS"!==e.resname&&"MET"!==e.resname&&-1!==e.formalCharge||(Qu(s,e),Ju(t,s)))}))}(t,i),function(e,t){const{totalH:i}=kd(e.data);e.eachAtom((e=>{const n=Ku(4),r=e.number;($d(e)||i[e.index]>0&&(7===r||8===r||16===r))&&(Qu(n,e),Ju(t,n))}))}(t,i),function(e,t){const{totalH:i}=kd(e.data);e.eachAtom((e=>{if(6===e.number&&i[e.index]>0&&(e.bondToElementCount(7)>0||e.bondToElementCount(8)>0||function(e){if(!e.isAromatic())return!1;const t=e.residueType.getRings();if(!t)return!1;let i=!1;return t.rings.forEach((t=>{i||t.some((t=>e.index-e.residueAtomOffset===t))&&(i=t.some((t=>{const i=e.residueType.atomTypeIdList[t],n=e.atomMap.get(i).number;return 7===n||8===n})))})),i}(e))){const i=Ku(9);Qu(i,e),Ju(t,i)}}))}(t,i),function(e,t){e.eachAtom((e=>{let i=!1,n=!1;const r=vd.includes(e.resname),s=_d.includes(e.resname);if(r||s?r?8===e.number?(["ASP","GLU","SER","THR","TYR","ASN","GLN"].includes(e.resname)&&e.isSidechain()||e.isBackbone())&&(i=!0,n=!0):16===e.number&&"CYS"===e.resname?(i=!0,n=!0):7===e.number&&"HIS"===e.resname&&e.isSidechain()&&(i=!0):s&&(8===e.number&&e.isBackbone()?(i=!0,n=!0):["N3","N4","N7"].includes(e.atomname)?i=!0:["O2","O4","O6"].includes(e.atomname)&&(i=!0,n=!0)):e.isHalogen()||8===e.number||16===e.number?(i=!0,n=!0):7===e.number&&(i=!0),i){const i=Ku(11);Qu(i,e),Ju(t,i)}if(n){const i=Ku(10);Qu(i,e),Ju(t,i)}}))}(t,i),function(e,t){e.eachAtom((e=>{if(e.isTransitionMetal()||30===e.number||48===e.number){const i=Ku(12);Qu(i,e),Ju(t,i)}else if(Hd.includes(e.number)){const i=Ku(13);Qu(i,e),Ju(t,i)}}))}(t,i),function(e,t){e.eachAtom((e=>{const i=Ku(8);let n=!1;6===e.number?(n=!0,e.eachBondedAtom((e=>{const t=e.number;6!==t&&1!==t&&(n=!1)}))):9===e.number&&(n=!0),n&&(Qu(i,e),Ju(t,i))}))}(t,i),function(e,t){e.eachAtom((e=>{if(qd.includes(e.number)){let i=!1;if(e.eachBondedAtom((e=>{Xd.includes(e.number)&&(i=!0)})),i){const i=Ku(7);Qu(i,e),Ju(t,i)}}}))}(t,i),function(e,t){e.eachAtom((e=>{if(Wd.includes(e.number)&&1===e.bondToElementCount(6)){const i=Ku(6);Qu(i,e),Ju(t,i)}}))}(t,i),e.Debug&&il.timeEnd("calculateFeatures"),i}function nf(t,i=Qd){const n=function(e){const{types:t,centers:i}=e;return{features:e,spatialHash:new ju(i),contactStore:new qu,featureSet:new Yu(t.length,!1)}}(tf(t));e.Debug&&il.time("calculateContacts"),function(e,t,i={}){const n=Ia(i.maxIonicDist,Qd.maxIonicDist),r=Ia(i.maxPiStackingDist,Qd.maxPiStackingDist),s=Ia(i.maxPiStackingOffset,Qd.maxPiStackingOffset),o=Ia(i.maxPiStackingAngle,Qd.maxPiStackingAngle),a=Ia(i.maxCationPiDist,Qd.maxCationPiDist),c=Ia(i.maxCationPiOffset,Qd.maxCationPiOffset),l=Ia(i.masterModelIndex,Qd.masterModelIndex),h=Math.max(n+2,r,a),u=r*r,d=a*a,{features:f,spatialHash:m,contactStore:p,featureSet:g}=t,{types:v,centers:y,atomSets:x}=f,{x:b,y:_,z:w}=y,S=v.length,A=e.atomStore.x,M=e.atomStore.y,C=e.atomStore.z,P=e.getAtomProxy(),T=e.getAtomProxy(),I=function(e,t,i){const n=e.length,r=t.length;for(let s=0;s<n;++s){P.index=e[s];for(let e=0;e<r;++e)if(T.index=t[e],P.distanceTo(T)<=i)return!0}return!1},E=new Zt,D=new Zt,L=new Zt,R=new Zt,k=new Zt,O=new Zt,B=new Zt,N=function(e,t){E.set(A[e[0]],M[e[0]],C[e[0]]),D.set(A[e[1]],M[e[1]],C[e[1]]),L.set(A[e[2]],M[e[2]],C[e[2]]),R.subVectors(E,D),k.subVectors(E,L),t.crossVectors(R,k)},F=function(e,t,i){return E.set(b[e],_[e],w[e]),D.set(b[t],_[t],w[t]),E.sub(D).projectOnPlane(i).add(D).distanceTo(D)},z=function(e,t,i){g.setBits(e,t),p.addContact(e,t,i)};for(let e=0;e<S;++e)m.eachWithin(b[e],_[e],w[e],h,((t,i)=>{if(t<=e)return;if(P.index=x[e][0],T.index=x[t][0],ef(P,T,l))return;const r=v[e],a=v[t];if(Fd(r,a))I(x[e],x[t],n)&&z(e,t,1);else if(zd(r,a)){if(i<=u){N(x[e],O),N(x[t],B);const i=57.29578*O.angleTo(B);Math.min(F(e,t,B),F(t,e,O))<=s&&(i<=o||i>=180-o||i<=o+90&&i>=90-o)&&z(e,t,3)}}else if(Ud(r,a)&&i<=d){const[i,n]=3===r?[e,t]:[t,e];N(x[i],O),F(n,i,O)<=c&&z(i,n,2)}}))}(t,n,i),function(e,t,i={}){const n=Ia(i.maxHbondDist,Qd.maxHbondDist),r=Ia(i.maxHbondSulfurDist,Qd.maxHbondSulfurDist),s=Ka(Ia(i.maxHbondAccAngle,Qd.maxHbondAccAngle)),o=Ka(Ia(i.maxHbondDonAngle,Qd.maxHbondDonAngle)),a=Ka(Ia(i.maxHbondAccPlaneAngle,Qd.maxHbondAccPlaneAngle)),c=Ka(Ia(i.maxHbondDonPlaneAngle,Qd.maxHbondDonPlaneAngle)),l=Ia(i.masterModelIndex,Qd.masterModelIndex),h=Math.max(n,r),u=n*n,{features:d,spatialHash:f,contactStore:m,featureSet:p}=t,{types:g,centers:v,atomSets:y}=d,{x:x,y:b,z:_}=v,w=g.length,{idealGeometry:S}=kd(e.data),A=e.getAtomProxy(),M=e.getAtomProxy();for(let e=0;e<w;++e)f.eachWithin(x[e],b[e],_[e],h,((t,i)=>{if(t<=e)return;const n=g[e],r=g[t],h=Vd(n,r);if(!h&&!Gd(n,r))return;const[d,f]=5===r?[e,t]:[t,e];if(A.index=y[d][0],M.index=y[f][0],M.index===A.index)return;if(ef(A,M,l))return;if(16!==A.number&&16!==M.number&&i>u)return;if(A.connectedTo(M))return;const v=Dd(A,M),x=Ed.get(S[A.index])||Ka(120);if(v.some((e=>Math.abs(x-e)>o)))return;if(3===S[A.index]){const e=Ld(A,M);if(void 0!==e&&e>c)return}const b=Dd(M,A),_=Ed.get(S[M.index])||Ka(120);if(b.some((e=>_-e>s)))return;if(3===S[M.index]){const e=Ld(M,A);if(void 0!==e&&e>a)return}p.setBits(d,f);const w=h?8:function(e,t){return e.isWater()&&t.isWater()}(C=A,P=M)?9:function(e,t){return e.isBackbone()&&t.isBackbone()}(C,P)?10:4;var C,P;m.addContact(d,f,w)}))}(t,n,i),function(e,t,i={}){const n=Ia(i.maxMetalDist,Qd.maxMetalDist),r=Ia(i.masterModelIndex,Qd.masterModelIndex),{features:s,spatialHash:o,contactStore:a,featureSet:c}=t,{types:l,centers:h,atomSets:u}=s,{x:d,y:f,z:m}=h,p=l.length,g=e.getAtomProxy(),v=e.getAtomProxy();for(let e=0;e<p;++e)o.eachWithin(d[e],f[e],m[e],n,((t,i)=>{if(t<=e)return;if(g.index=u[e][0],v.index=u[t][0],ef(g,v,r))return;const n=g.isMetal(),s=v.isMetal();if(!n&&!s)return;const[o,h]=n?[l[e],l[t]]:[l[t],l[e]];jd(o,h)&&(c.setBits(e,t),a.addContact(e,t,7))}))}(t,n,i),function(e,t,i={}){const n=Ia(i.maxHydrophobicDist,Qd.maxHydrophobicDist),r=Ia(i.masterModelIndex,Qd.masterModelIndex),{features:s,spatialHash:o,contactStore:a,featureSet:c}=t,{types:l,centers:h,atomSets:u}=s,{x:d,y:f,z:m}=h,p=l.length,g=e.getAtomProxy(),v=e.getAtomProxy();for(let e=0;e<p;++e)o.eachWithin(d[e],f[e],m[e],n,((t,i)=>{var n,s;t<=e||(g.index=u[e][0],v.index=u[t][0],ef(g,v,r)||9===g.number&&9===v.number||g.connectedTo(v)||(n=l[e],s=l[t],8===n&&8===s&&(c.setBits(e,t),a.addContact(e,t,6))))}))}(t,n,i),function(e,t,i={}){const n=Ia(i.maxHalogenBondDist,Qd.maxHalogenBondDist),r=Ka(Ia(i.maxHalogenBondAngle,Qd.maxHalogenBondAngle)),s=Ia(i.masterModelIndex,Qd.masterModelIndex),{features:o,spatialHash:a,contactStore:c,featureSet:l}=t,{types:h,centers:u,atomSets:d}=o,{x:f,y:m,z:p}=u,g=h.length,v=e.getAtomProxy(),y=e.getAtomProxy();for(let e=0;e<g;++e)a.eachWithin(f[e],m[e],p[e],n,((t,i)=>{if(t<=e)return;if(v.index=d[e][0],y.index=d[t][0],ef(v,y,s))return;if(n=h[e],o=h[t],!(7===n&&6===o||6===n&&7===o))return;var n,o;const[a,u]=6===h[e]?[v,y]:[y,v],f=Dd(a,u);if(1!==f.length)return;if(Yd-f[0]>r)return;const m=Dd(u,a);0!==m.length&&(m.some((e=>Zd-e>r))||(l.setBits(e,t),c.addContact(e,t,5)))}))}(t,n,i);const r=function(e){const{index1:t,index2:i,count:n}=e.contactStore,r=Zu({nodeArray1:t,nodeArray2:i,edgeCount:n,nodeCount:e.featureSet.length}),s=new Yu(e.contactStore.count,!0);return Object.assign({adjacencyList:r,contactSet:s},e)}(n);return function(t,i,n={}){e.Debug&&il.time("refineLineOfSight");const r=Ia(n.lineOfSightDistFactor,Qd.lineOfSightDistFactor),s=Ia(n.masterModelIndex,Qd.masterModelIndex),o=t.spatialHash,{contactSet:a,contactStore:c,features:l}=i,{index1:h,index2:u}=c,{centers:d,atomSets:f}=l,{x:m,y:p,z:g}=d,v=t.getAtomProxy(),y=t.getAtomProxy(),x=t.getAtomProxy(),b=new Zt,_=new Zt,w=3*r,S=r*r;a.forEach((t=>{b.set(m[h[t]],p[h[t]],g[h[t]]),_.set(m[u[t]],p[u[t]],g[u[t]]);const i=(b.x+_.x)/2,n=(b.y+_.y)/2,r=(b.z+_.z)/2,c=f[h[t]],l=f[u[t]];v.index=c[0],y.index=l[0],o.eachWithin(i,n,r,w,((i,n)=>{x.index=i,1!==x.number&&x.vdw*x.vdw*S>n&&!Kd(v,x,s)&&!Kd(y,x,s)&&!c.includes(i)&&!l.includes(i)&&b.distanceToSquared(x)>1&&_.distanceToSquared(x)>1&&(a.clear(t),e.Debug&&il.log("removing",v.qualifiedName(),y.qualifiedName(),"because",x.qualifiedName()))}))})),e.Debug&&il.timeEnd("refineLineOfSight")}(t,r,i),function(e,t){const{contactSet:i,contactStore:n,features:r}=t,{type:s,index1:o,index2:a}=n,{atomSets:c}=r,l=e.getAtomProxy(),h=e.getAtomProxy(),u={},d=function(e,t,n){const[r,s]=u[n]||[1/0,-1];e<r?(-1!==s&&i.clear(s),u[n]=[e,t]):i.clear(t)};i.forEach((e=>{if(6!==s[e])return;l.index=c[o[e]][0],h.index=c[a[e]][0];const t=l.distanceTo(h);d(t,e,`${l.index}|${h.residueIndex}`),d(t,e,`${h.index}|${l.residueIndex}`)}))}(t,r),i.refineSaltBridges&&function(e,t){const{contactSet:i,contactStore:n,features:r}=t,{type:s,index1:o,index2:a}=n,{atomSets:c}=r,l={},h=function(e,t){l[e]||(l[e]=[]),l[e].push(t)};i.forEach((e=>{1===s[e]&&(c[o[e]].forEach((t=>h(t,e))),c[a[e]].forEach((t=>h(t,e))))})),i.forEach((e=>{if(!function(e){return 4===e||9===e||10===e}(s[e]))return;const t=l[c[o[e]][0]],n=l[c[a[e]][0]];if(!t||!n)return;const r=t.length;for(let s=0;s<r;++s)if(n.includes(t[s]))return void i.clear(e)}))}(0,r),function(e,t){const{contactSet:i,contactStore:n,features:r}=t,{type:s,index1:o,index2:a}=n,{atomSets:c}=r,l={},h=function(e,t){l[e]||(l[e]=[]),l[e].push(t)};i.forEach((e=>{3===s[e]&&(c[o[e]].forEach((t=>h(t,e))),c[a[e]].forEach((t=>h(t,e))))})),i.forEach((e=>{if(6!==s[e]&&2!==s[e])return;const t=l[c[o[e]][0]],n=l[c[a[e]][0]];if(!t||!n)return;const r=t.length;for(let s=0;s<r;++s)if(n.includes(t[s]))return void i.clear(e)}))}(0,r),function(e,t){const{contactSet:i,contactStore:n,features:r}=t,{type:s,index1:o,index2:a}=n,{atomSets:c}=r,l={},h=function(e,t){l[e]||(l[e]=[]),l[e].push(t)};i.forEach((e=>{1===s[e]&&(c[o[e]].forEach((t=>h(t,e))),c[a[e]].forEach((t=>h(t,e))))})),i.forEach((e=>{if(7!==s[e])return;const t=l[c[o[e]][0]],n=l[c[a[e]][0]];if(!t||!n)return;const r=t.length;for(let e=0;e<r;++e)if(n.includes(t[e]))return void i.clear(t[e])}))}(0,r),e.Debug&&il.timeEnd("calculateContacts"),r}function rf(e){switch(e){case 4:case 9:case 10:return"hydrogen bond";case 6:return"hydrophobic contact";case 5:return"halogen bond";case 1:return"ionic interaction";case 7:return"metal coordination";case 2:return"cation-pi interaction";case 3:return"pi-pi stacking";case 8:return"weak hydrogen bond";default:return"unknown contact"}}const sf={hydrogenBond:!0,hydrophobic:!0,halogenBond:!0,ionicInteraction:!0,metalCoordination:!0,cationPi:!0,piStacking:!0,weakHydrogenBond:!0,waterHydrogenBond:!0,backboneHydrogenBond:!0,radius:1,filterSele:""},of=new mn;function af(e,t,i){const n=Ea(i,sf),r=[];n.hydrogenBond&&r.push(4),n.hydrophobic&&r.push(6),n.halogenBond&&r.push(5),n.ionicInteraction&&r.push(1),n.metalCoordination&&r.push(7),n.cationPi&&r.push(2),n.piStacking&&r.push(3),n.weakHydrogenBond&&r.push(8),n.waterHydrogenBond&&r.push(9),n.backboneHydrogenBond&&r.push(10);const{features:s,contactSet:o,contactStore:a}=e,{centers:c,atomSets:l}=s,{x:h,y:u,z:d}=c,{index1:f,index2:m,type:p}=a,g=[],v=[],y=[],x=[],b=[];let _;return n.filterSele&&(_=Array.isArray(n.filterSele)?n.filterSele.map((e=>t.getAtomSet(new $c(e)))):t.getAtomSet(new $c(n.filterSele))),o.forEach((e=>{const t=p[e];if(!r.includes(t))return;if(_){const t=l[f[e]][0],i=l[m[e]][0];if(Array.isArray(_)){if(!(_[0].isSet(t)&&_[1].isSet(i)||_[1].isSet(t)&&_[0].isSet(i)))return}else if(!_.isSet(t)&&!_.isSet(i))return}const i=f[e],s=m[e];g.push(h[i],u[i],d[i]),v.push(h[s],u[s],d[s]),y.push(...function(e){switch(e){case 4:case 9:case 10:return of.setHex(2851770).toArray();case 6:return of.setHex(8421504).toArray();case 5:return of.setHex(4259775).toArray();case 1:return of.setHex(15779860).toArray();case 7:return of.setHex(9191577).toArray();case 2:return of.setHex(16744448).toArray();case 3:return of.setHex(9220966).toArray();case 8:return of.setHex(12967404).toArray();default:return of.setHex(13421772).toArray()}}(t)),x.push(n.radius),b.push(e)})),{position1:new Float32Array(g),position2:new Float32Array(v),color:new Float32Array(y),color2:new Float32Array(y),radius:new Float32Array(x),picking:new ff(b,e,t)}}class cf{constructor(e){this.array=e}get type(){return""}get data(){return{}}getIndex(e){return this.array?this.array[e]:e}getObject(e){return{}}_applyTransformations(e,t,i){return t&&e.applyMatrix4(t.matrix),i&&e.applyMatrix4(i.matrix),e}_getPosition(e){return new Zt}getPosition(e,t,i){return this._applyTransformations(this._getPosition(e),t,i)}}class lf extends cf{constructor(e){super(),this.shape=e}get primitive(){}get data(){return this.shape}get type(){return this.primitive.type}getObject(e){return this.primitive.objectFromShape(this.shape,this.getIndex(e))}_getPosition(e){return this.primitive.positionFromShape(this.shape,this.getIndex(e))}}class hf extends cf{constructor(e,t){super(e),this.structure=t}get type(){return"atom"}get data(){return this.structure}getObject(e){return this.structure.getAtomProxy(this.getIndex(e))}_getPosition(e){return(new Zt).copy(this.getObject(e))}}class uf extends cf{constructor(e){super(),this.axes=e}get type(){return"axes"}get data(){return this.axes}getObject(){return{axes:this.axes}}_getPosition(){return this.axes.center.clone()}}class df extends cf{constructor(e,t,i){super(e),this.structure=t,this.bondStore=i||t.bondStore}get type(){return"bond"}get data(){return this.structure}getObject(e){const t=this.structure.getBondProxy(this.getIndex(e));return t.bondStore=this.bondStore,t}_getPosition(e){const t=this.getObject(e);return(new Zt).copy(t.atom1).add(t.atom2).multiplyScalar(.5)}}class ff extends cf{constructor(e,t,i){super(e),this.contacts=t,this.structure=i}get type(){return"contact"}get data(){return this.contacts}getObject(e){const t=this.getIndex(e),{features:i,contactStore:n}=this.contacts,{centers:r,atomSets:s}=i,{x:o,y:a,z:c}=r,{index1:l,index2:h,type:u}=n,d=l[t],f=h[t];return{center1:new Zt(o[d],a[d],c[d]),center2:new Zt(o[f],a[f],c[f]),atom1:this.structure.getAtomProxy(s[d][0]),atom2:this.structure.getAtomProxy(s[f][0]),type:rf(u[t])}}_getPosition(e){const{center1:t,center2:i}=this.getObject(e);return(new Zt).addVectors(t,i).multiplyScalar(.5)}}class mf extends cf{constructor(e,t,i){super(e),this.validation=t,this.structure=i}get type(){return"clash"}get data(){return this.validation}getObject(e){const t=this.validation,i=this.getIndex(e);return{validation:t,index:i,clash:t.clashArray[i]}}_getAtomProxyFromSele(e){const t=new $c(e),i=this.structure.getAtomIndices(t)[0];return this.structure.getAtomProxy(i)}_getPosition(e){const t=this.getObject(e).clash,i=this._getAtomProxyFromSele(t.sele1),n=this._getAtomProxyFromSele(t.sele2);return(new Zt).copy(i).add(n).multiplyScalar(.5)}}class pf extends df{get type(){return"distance"}}class gf extends cf{get type(){return"ignore"}}class vf extends lf{constructor(e,t){super(e),this.mesh=t}get type(){return"mesh"}getObject(){const e=this.mesh;return{shape:this.shape,name:e.name,serial:e.serial}}_getPosition(){return this.__position||(this.__position=ru(this.mesh.position)),this.__position}}class yf extends cf{constructor(e,t){super(e),this.surface=t}get type(){return"surface"}get data(){return this.surface}getObject(e){return{surface:this.surface,index:this.getIndex(e)}}_getPosition(){return this.surface.center.clone()}}class xf extends cf{constructor(e,t){super(),this.unitcell=e,this.structure=t}get type(){return"unitcell"}get data(){return this.unitcell}getObject(){return{unitcell:this.unitcell,structure:this.structure}}_getPosition(){return this.unitcell.getCenter(this.structure)}}class bf extends cf{constructor(e,t){super(e),this.volume=t}get type(){return"volume"}get data(){return this.volume}getObject(e){const t=this.volume,i=this.getIndex(e);return{volume:t,index:i,value:t.data[i]}}_getPosition(e){const t=this.volume.position,i=this.getIndex(e);return new Zt(t[3*i],t[3*i+1],t[3*i+2])}}class _f extends bf{get type(){return"slice"}}function wf(){return new Uint32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0])}function Sf(){return new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1])}function Af(e,t,i,n,r){var s,o,a,c,l,h,u,d=[[0,4,4,4,2,0,0,0,2,2,0,0],[4,0,4,4,0,8,0,0,0,8,8,0],[4,4,0,4,0,0,8,0,0,0,8,8],[4,4,4,0,0,0,0,1,1,0,0,1],[2,0,0,0,0,8,8,8,2,2,0,0],[0,8,0,0,8,0,8,8,0,8,8,0],[0,0,8,0,8,8,0,8,0,0,8,8],[0,0,0,1,8,8,8,0,1,0,0,1],[2,0,0,1,2,0,0,1,0,2,0,1],[2,8,0,0,2,8,0,0,2,0,8,0],[0,8,8,0,0,8,8,0,0,8,0,8],[0,0,8,1,0,0,8,1,1,0,8,0]],f=0,m=!1,p=!1,g=!1,v=!1,y=-1,x=t*i*n,b=t,_=t*i,w=new Int32Array(12),S=[],A=[],M=[],C=[],P=wf(),T=Sf();function I(e,t,i){return e+(t-e)*i}function E(e,r,s){return _*(s=(s+u)%n)+b*(r=(r+h)%i)+(e=(e+l)%t)}function D(e,t,i,n,c,l,h){var u=3*e;if(o[u]<0){var d=(f-l)/(h-l),p=s,g=3*a;if(S[g]=i+d,S[g+1]=n,S[g+2]=c,!m){var v=3*e;A[g]=y*I(p[v],p[v+3],d),A[g+1]=y*I(p[v+1],p[v+4],d),A[g+2]=y*I(p[v+2],p[v+5],d)}r&&(C[a]=r[e+Math.round(d)]),o[u]=a,w[t]=a,a+=1}else w[t]=o[u]}function L(e,t,i,n,c,l,h){var u=3*e+1;if(o[u]<0){var d=(f-l)/(h-l),p=s,g=3*a;if(S[g]=i,S[g+1]=n+d,S[g+2]=c,!m){var v=3*e,x=v+3*b;A[g]=y*I(p[v],p[x],d),A[g+1]=y*I(p[v+1],p[x+1],d),A[g+2]=y*I(p[v+2],p[x+2],d)}r&&(C[a]=r[e+Math.round(d)*b]),o[u]=a,w[t]=a,a+=1}else w[t]=o[u]}function R(e,t,i,n,c,l,h){var u=3*e+2;if(o[u]<0){var d=(f-l)/(h-l),p=s,g=3*a;if(S[g]=i,S[g+1]=n,S[g+2]=c+d,!m){var v=3*e,x=v+3*_;A[g]=y*I(p[v],p[x],d),A[g+1]=y*I(p[v+1],p[x+1],d),A[g+2]=y*I(p[v+2],p[x+2],d)}r&&(C[a]=r[e+Math.round(d)*_]),o[u]=a,w[t]=a,a+=1}else w[t]=o[u]}function k(t){var i=3*t;0===s[i]&&(s[i]=e[(t-1+x)%x]-e[(t+1)%x],s[i+1]=e[(t-b+x)%x]-e[(t+b)%x],s[i+2]=e[(t-_+x)%x]-e[(t+_)%x])}function O(t,i,n,r,s){var o,a,l,h,u,y,x;g?(r=E(t,i,n),o=E(t+1,i,n),a=E(t,i+1,n),l=E(t,i,n+1),h=E(t+1,i+1,n),u=E(t+1,i,n+1),y=E(t,i+1,n+1),x=E(t+1,i+1,n+1)):(o=r+1,h=(a=r+b)+1,u=(l=r+_)+1,x=(y=a+_)+1);var S=0,A=e[r],C=e[o],I=e[a],O=e[h],B=e[l],N=e[u],F=e[y],z=e[x];A<f&&(S|=1),C<f&&(S|=2),I<f&&(S|=8),O<f&&(S|=4),B<f&&(S|=16),N<f&&(S|=32),F<f&&(S|=128),z<f&&(S|=64);var U=P[S];if(0===U)return 0;var $=t+1,G=i+1,V=n+1;1&U&&(m||(k(r),k(o)),D(r,0,t,i,n,A,C)),2&U&&(m||(k(o),k(h)),L(o,1,$,i,n,C,O)),4&U&&(m||(k(a),k(h)),D(a,2,t,G,n,I,O)),8&U&&(m||(k(r),k(a)),L(r,3,t,i,n,A,I)),16&U&&(m||(k(l),k(u)),D(l,4,t,i,V,B,N)),32&U&&(m||(k(u),k(x)),L(u,5,$,i,V,N,z)),64&U&&(m||(k(y),k(x)),D(y,6,t,G,V,F,z)),128&U&&(m||(k(l),k(y)),L(l,7,t,i,V,B,F)),256&U&&(m||(k(r),k(l)),R(r,8,t,i,n,A,B)),512&U&&(m||(k(o),k(u)),R(o,9,$,i,n,C,N)),1024&U&&(m||(k(h),k(x)),R(h,10,$,G,n,O,z)),2048&U&&(m||(k(a),k(y)),R(a,11,t,G,n,I,F));for(var H,j,W,q=S<<4,X=0;-1!==T[q+X];)H=T[q+X],j=T[q+X+1],W=T[q+X+2],p?(d[H][j]&s&&(M[c++]=w[H],M[c++]=w[j]),d[j][W]&s&&(M[c++]=w[j],M[c++]=w[W]),d[H][W]&s&&(M[c++]=w[H],M[c++]=w[W])):(M[c++]=w[v?H:j],M[c++]=w[v?j:H],M[c++]=w[W]),X+=3}function B(r,s,a,c,l,h){let u,d,p,v,y,x,w,S,A,M,C,P,T;if(r=void 0!==r?r:0,s=void 0!==s?s:0,a=void 0!==a?a:0,c=void 0!==c?c:t-1,l=void 0!==l?l:i-1,h=void 0!==h?h:n-1,g||(m?(r=Math.max(0,r),s=Math.max(0,s),a=Math.max(0,a),c=Math.min(t-1,c),l=Math.min(i-1,l),h=Math.min(n-1,h)):(r=Math.max(1,r),s=Math.max(1,s),a=Math.max(1,a),c=Math.min(t-2,c),l=Math.min(i-2,l),h=Math.min(n-2,h))),g)for(S=r-2,A=s-2,M=a-2,C=c+2,P=l+2,T=h+2,y=M;y<T;++y)for(v=A;v<P;++v)for(p=S;p<C;++p)d=3*E(p,v,y),o[d]=-1,o[d+1]=-1,o[d+2]=-1;else for(S=Math.max(0,r-2),A=Math.max(0,s-2),M=Math.max(0,a-2),C=Math.min(t,c+2),P=Math.min(i,l+2),T=Math.min(n,h+2),y=M;y<T;++y)for(w=_*y,v=A;v<P;++v)for(x=w+b*v,p=S;p<C;++p)u=3*(x+p),o[u]=-1,o[u+1]=-1,o[u+2]=-1;if(!g){var I,D=r,L=s,R=a,k=c,B=l,N=h;for(I=!1,y=a;y<h;++y){for(v=s;v<l;++v){for(p=r;p<c;++p)if(u=t*i*y+t*v+p,e[u]>=f){R=y,I=!0;break}if(I)break}if(I)break}for(I=!1,v=s;v<l;++v){for(y=R;y<h;++y){for(p=r;p<c;++p)if(u=t*i*y+t*v+p,e[u]>=f){L=v,I=!0;break}if(I)break}if(I)break}for(I=!1,p=r;p<c;++p){for(v=L;v<l;++v){for(y=R;y<h;++y)if(u=t*i*y+t*v+p,e[u]>=f){D=p,I=!0;break}if(I)break}if(I)break}for(I=!1,y=h;y>=a;--y){for(v=l;v>=s;--v){for(p=c;p>=r;--p)if(u=t*i*y+t*v+p,e[u]>=f){N=y,I=!0;break}if(I)break}if(I)break}for(I=!1,v=l;v>=s;--v){for(y=N;y>=a;--y){for(p=c;p>=r;--p)if(u=t*i*y+t*v+p,e[u]>=f){B=v,I=!0;break}if(I)break}if(I)break}for(I=!1,p=c;p>=r;--p){for(v=B;v>=s;--v){for(y=N;y>=a;--y)if(u=t*i*y+t*v+p,e[u]>=f){k=p,I=!0;break}if(I)break}if(I)break}m?(r=Math.max(0,D-1),s=Math.max(0,L-1),a=Math.max(0,R-1),c=Math.min(t-1,k+1),l=Math.min(i-1,B+1),h=Math.min(n-1,N+1)):(r=Math.max(1,D-1),s=Math.max(1,L-1),a=Math.max(1,R-1),c=Math.min(t-2,k+1),l=Math.min(i-2,B+1),h=Math.min(n-2,N+1))}var F=15;for(y=a;y<h;++y,F&=-5)for(w=_*y,F|=2,v=s;v<l;++v,F&=-3)for(x=w+b*v,F|=1,p=r;p<c;++p,F&=-2)u=x+p,O(p,v,y,u,F)}this.triangulate=function(e,d,b,_,w){v=(f=e)<0,p=_,g=w,(m=d||p)||(y=f>0?-1:1,s||(s=new Float32Array(3*x)));var P=3*x;if(o&&o.length===P||(o=new Int32Array(P)),a=0,c=0,void 0!==b){var T=b[0].map(Math.round),I=b[1].map(Math.round);l=t*Math.ceil(Math.abs(T[0])/t),h=i*Math.ceil(Math.abs(T[1])/i),u=n*Math.ceil(Math.abs(T[2])/n),B(T[0],T[1],T[2],I[0],I[1],I[2])}else l=h=u=0,B();return S.length=3*a,m||(A.length=3*a),M.length=c,r&&(C.length=a),{position:new Float32Array(S),normal:m?void 0:new Float32Array(A),index:Ga(M,S.length/3),atomindex:r?new Int32Array(C):void 0,contour:p}}}pl.add("arrow",class extends lf{get primitive(){return Fu}}),pl.add("box",class extends lf{get primitive(){return ku}}),pl.add("cone",class extends lf{get primitive(){return zu}}),pl.add("cylinder",class extends lf{get primitive(){return Nu}}),pl.add("ellipsoid",class extends lf{get primitive(){return Uu}}),pl.add("octahedron",class extends lf{get primitive(){return Ou}}),pl.add("sphere",class extends lf{get primitive(){return Ru}}),pl.add("tetrahedron",class extends lf{get primitive(){return Bu}}),pl.add("torus",class extends lf{get primitive(){return $u}}),pl.add("point",class extends lf{get primitive(){return Vu}}),pl.add("wideline",class extends lf{get primitive(){return Hu}}),Object.assign(Af,{__deps:[wf,Sf,Ga]});class Mf{constructor(e,t){this.cols=e,this.rows=t,this.size=this.cols*this.rows,this.data=new Float32Array(this.size)}copyTo(e){e.data.set(this.data)}}function Cf(e,t){let i=0,n=0;const r=t.rows,s=t.cols;let o=0,a=0,c=0;const l=t.data,h=e.data;for(;i<r;a+=1,o+=s,i++)for(c=a,n=0;n<s;c+=r,n++)h[c]=l[o+n]}function Pf(e,t,i){let n=0,r=0,s=0,o=0,a=0,c=0,l=0;const h=t.cols,u=t.rows,d=i.rows,f=t.data,m=i.data,p=e.data;let g=0;for(;n<u;o+=h,n++)for(c=0,r=0;r<d;l++,r++){for(a=o,g=0,s=0;s<h;a++,c++,s++)g+=f[a]*m[c];p[l]=g}}function Tf(e,t,i){const n=e.data,r=t.data,s=i.data,o=r[0],a=r[1],c=r[2],l=r[3],h=r[4],u=r[5],d=r[6],f=r[7],m=r[8],p=s[0],g=s[1],v=s[2],y=s[3],x=s[4],b=s[5],_=s[6],w=s[7],S=s[8];n[0]=o*p+a*y+c*_,n[1]=o*g+a*x+c*w,n[2]=o*v+a*b+c*S,n[3]=l*p+h*y+u*_,n[4]=l*g+h*x+u*w,n[5]=l*v+h*b+u*S,n[6]=d*p+f*y+m*_,n[7]=d*g+f*x+m*w,n[8]=d*v+f*b+m*S}function If(e){const t=e.rows,i=e.cols,n=e.data,r=new Array(i);for(let e=0;e<i;++e)r[e]=0;for(let e=0,s=0;e<t;++e)for(let e=0;e<i;++e,++s)r[e]+=n[s];for(let e=0;e<i;++e)r[e]/=t;return r}function Ef(e,t){const i=e.rows,n=e.cols,r=e.data;for(let e=0,s=0;e<i;++e)for(let e=0;e<n;++e,++s)r[s]-=t[e]}function Df(e,t,i,n){n=e[t],e[t]=e[i],e[i]=n}function Lf(e,t){return(e=Math.abs(e))>(t=Math.abs(t))?(t/=e,e*Math.sqrt(1+t*t)):t>0?(e/=t,t*Math.sqrt(1+e*e)):0}const Rf=1.192092896e-7,kf=1e-37;function Of(e,t,i,n){let r=0,s=0;const o=e.rows,a=e.cols;let c=o,l=a;c<l&&(r=1,s=c,c=l,l=s);const h=new Mf(c,c),u=new Mf(1,l),d=new Mf(l,l);if(0===r)Cf(h,e);else{for(s=0;s<a*o;s++)h.data[s]=e.data[s];for(;s<l*c;s++)h.data[s]=0}if(function(e,t,i,n,r,s,o,a){const c=2*Rf,l=kf;let h=0,u=0,d=0,f=0;const m=Math.max(s,30);let p=0,g=0,v=0,y=0,x=0,b=0,_=0,w=0,S=0,A=0,M=0,C=0,P=0,T=0,I=0,E=0,D=0,L=4660,R=0,k=0,O=0;const B=new Float64Array(o<<3);for(;h<o;h++){for(d=0,M=0;d<s;d++)w=e[h*t+d],M+=w*w;if(B[h]=M,n){for(d=0;d<o;d++)n[h*r+d]=0;n[h*r+h]=1}}for(;f<m;f++){for(x=0,h=0;h<o-1;h++)for(u=h+1;u<o;u++){for(p=h*t|0,g=u*t|0,I=B[h],E=0,D=B[u],d=2,E+=e[p]*e[g],E+=e[p+1]*e[g+1];d<s;d++)E+=e[p+d]*e[g+d];if(!(Math.abs(E)<=c*Math.sqrt(I*D))){for(E*=2,C=I-D,P=Lf(E,C),C<0?(T=.5*(P-C),_=Math.sqrt(T/P),b=E/(P*_*2)):(b=Math.sqrt((P+C)/(2*P)),_=E/(P*b*2)),I=0,D=0,d=2,S=b*e[p]+_*e[g],A=-_*e[p]+b*e[g],e[p]=S,e[g]=A,I+=S*S,D+=A*A,S=b*e[p+1]+_*e[g+1],A=-_*e[p+1]+b*e[g+1],e[p+1]=S,e[g+1]=A,I+=S*S,D+=A*A;d<s;d++)S=b*e[p+d]+_*e[g+d],A=-_*e[p+d]+b*e[g+d],e[p+d]=S,e[g+d]=A,I+=S*S,D+=A*A;if(B[h]=I,B[u]=D,x=1,n)for(v=h*r|0,y=u*r|0,d=2,S=b*n[v]+_*n[y],A=-_*n[v]+b*n[y],n[v]=S,n[y]=A,S=b*n[v+1]+_*n[y+1],A=-_*n[v+1]+b*n[y+1],n[v+1]=S,n[y+1]=A;d<o;d++)S=b*n[v+d]+_*n[y+d],A=-_*n[v+d]+b*n[y+d],n[v+d]=S,n[y+d]=A}}if(0===x)break}for(h=0;h<o;h++){for(d=0,M=0;d<s;d++)w=e[h*t+d],M+=w*w;B[h]=Math.sqrt(M)}for(h=0;h<o-1;h++){for(u=h,d=h+1;d<o;d++)B[u]<B[d]&&(u=d);if(h!==u&&(Df(B,h,u,M),n)){for(d=0;d<s;d++)Df(e,h*t+d,u*t+d,w);for(d=0;d<o;d++)Df(n,h*r+d,u*r+d,w)}}for(h=0;h<o;h++)i[h]=B[h];if(n)for(h=0;h<a;h++){for(M=h<o?B[h]:0;M<=l;){for(k=1/s,d=0;d<s;d++)L=214013*L+2531011,R=0!=(256&L>>16)?k:-k,e[h*t+d]=R;for(f=0;f<2;f++)for(u=0;u<h;u++){for(M=0,d=0;d<s;d++)M+=e[h*t+d]*e[u*t+d];for(O=0,d=0;d<s;d++)w=e[h*t+d]-M*e[u*t+d],e[h*t+d]=w,O+=Math.abs(w);for(O=O?1/O:0,d=0;d<s;d++)e[h*t+d]*=O}for(M=0,d=0;d<s;d++)w=e[h*t+d],M+=w*w;M=Math.sqrt(M)}for(_=1/M,d=0;d<s;d++)e[h*t+d]*=_}}(h.data,c,u.data,d.data,l,c,l,c),t){for(s=0;s<l;s++)t.data[s]=u.data[s];for(;s<a;s++)t.data[s]=0}0===r?(i&&Cf(i,h),n&&Cf(n,d)):(i&&Cf(i,d),n&&Cf(n,h))}function Bf(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function Nf(e,t,i,n,r,s,o,a,c,l,h,u,d,f,m,p,g){e[0]=t,e[4]=i,e[8]=n,e[12]=r,e[1]=s,e[5]=o,e[9]=a,e[13]=c,e[2]=l,e[6]=h,e[10]=u,e[14]=d,e[3]=f,e[7]=m,e[11]=p,e[15]=g}function Ff(e,t,i){const n=t[0],r=t[4],s=t[8],o=t[12],a=t[1],c=t[5],l=t[9],h=t[13],u=t[2],d=t[6],f=t[10],m=t[14],p=t[3],g=t[7],v=t[11],y=t[15],x=i[0],b=i[4],_=i[8],w=i[12],S=i[1],A=i[5],M=i[9],C=i[13],P=i[2],T=i[6],I=i[10],E=i[14],D=i[3],L=i[7],R=i[11],k=i[15];e[0]=n*x+r*S+s*P+o*D,e[4]=n*b+r*A+s*T+o*L,e[8]=n*_+r*M+s*I+o*R,e[12]=n*w+r*C+s*E+o*k,e[1]=a*x+c*S+l*P+h*D,e[5]=a*b+c*A+l*T+h*L,e[9]=a*_+c*M+l*I+h*R,e[13]=a*w+c*C+l*E+h*k,e[2]=u*x+d*S+f*P+m*D,e[6]=u*b+d*A+f*T+m*L,e[10]=u*_+d*M+f*I+m*R,e[14]=u*w+d*C+f*E+m*k,e[3]=p*x+g*S+v*P+y*D,e[7]=p*b+g*A+v*T+y*L,e[11]=p*_+g*M+v*I+y*R,e[15]=p*w+g*C+v*E+y*k}function zf(e,t,i,n){Nf(e,t,0,0,0,0,i,0,0,0,0,n,0,0,0,0,1)}function Uf(e,t,i,n){Nf(e,1,0,0,t,0,1,0,i,0,0,1,n,0,0,0,1)}function $f(e,t){const i=Math.cos(t),n=Math.sin(t);Nf(e,i,0,n,0,0,1,0,0,-n,0,i,0,0,0,0,1)}function Gf(){return new Float32Array([1,0,0,0,1,0,0,0,1])}function Vf(e,t){const i=hu([t[0],t[1],t[2]]),n=hu([t[4],t[5],t[6]]),r=hu([t[8],t[9],t[10]]),s=hu();uu(s,n,r),e[0]=s[0],e[1]=s[1],e[2]=s[2],uu(s,r,i),e[3]=s[0],e[4]=s[1],e[5]=s[2],uu(s,i,n),e[6]=s[0],e[7]=s[1],e[8]=s[2]}function Hf(e,t,i,n){i=i||1,n=n||!0;const r=e.length/3,s=t.length/3;let o;n&&(o=new Float32Array(3*r));const a=new Float32Array(3*r);let c;const l=new Array(20);for(c=0;c<20;++c)l[c]=new Uint32Array(r);for(c=0;c<r;++c)l[0][c]=0;let h,u,d;for(c=0;c<s;++c){var f=3*c,m=3*c+1,p=3*c+2;for(d=!0,h=0,u=l[0][t[f]];h<u;++h)if(t[m]===l[h+1][t[f]]){d=!1;break}for(d&&(l[0][t[f]]++,l[l[0][t[f]]][t[f]]=t[m]),d=!0,h=0,u=l[0][t[f]];h<u;++h)if(t[p]===l[h+1][t[f]]){d=!1;break}for(d&&(l[0][t[f]]++,l[l[0][t[f]]][t[f]]=t[p]),d=!0,h=0,u=l[0][t[m]];h<u;++h)if(t[f]===l[h+1][t[m]]){d=!1;break}for(d&&(l[0][t[m]]++,l[l[0][t[m]]][t[m]]=t[f]),d=!0,h=0,u=l[0][t[m]];h<u;++h)if(t[p]===l[h+1][t[m]]){d=!1;break}for(d&&(l[0][t[m]]++,l[l[0][t[m]]][t[m]]=t[p]),d=!0,h=0;h<l[0][t[p]];++h)if(t[f]===l[h+1][t[p]]){d=!1;break}for(d&&(l[0][t[p]]++,l[l[0][t[p]]][t[p]]=t[f]),d=!0,h=0,u=l[0][t[p]];h<u;++h)if(t[m]===l[h+1][t[p]]){d=!1;break}d&&(l[0][t[p]]++,l[l[0][t[p]]][t[p]]=t[m])}for(var g,v,y,x,b,_=.5,w=.75/4.5,S=0;S<i;++S){for(c=0;c<r;++c)if(g=3*c,(y=l[0][c])<3)a[g]=e[g],a[g+1]=e[g+1],a[g+2]=e[g+2];else if(3===y||4===y){for(a[g]=0,a[g+1]=0,a[g+2]=0,h=0;h<y;++h)v=3*l[h+1][c],a[g]+=e[v],a[g+1]+=e[v+1],a[g+2]+=e[v+2];a[g]+=_*e[g],a[g+1]+=_*e[g+1],a[g+2]+=_*e[g+2],b=_+y,a[g]/=b,a[g+1]/=b,a[g+2]/=b}else{for(a[g]=0,a[g+1]=0,a[g+2]=0,h=0;h<y;++h)v=3*l[h+1][c],a[g]+=e[v],a[g+1]+=e[v+1],a[g+2]+=e[v+2];a[g]+=1*e[g],a[g+1]+=1*e[g+1],a[g+2]+=1*e[g+2],x=1+y,a[g]/=x,a[g+1]/=x,a[g+2]/=x}if(e.set(a),n){jf(e,t,o);var A=3*r;for(g=0;g<A;g+=3)e[g]+=-1*w*o[g],e[g+1]+=-1*w*o[g+1],e[g+2]+=-1*w*o[g+2]}}}function jf(e,t,i){var n,r;if(void 0===i)i=new Float32Array(e.length);else for(n=0,r=i.length;n<r;n++)i[n]=0;var s=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3),c=new Float32Array(3),l=new Float32Array(3);if(t)for(n=0,r=t.length;n<r;n+=3){var h=3*t[n],u=3*t[n+1],d=3*t[n+2];pu(s,e,h),pu(o,e,u),pu(a,e,d),fu(c,a,o),fu(l,s,o),uu(c,c,l),i[h]+=c[0],i[h+1]+=c[1],i[h+2]+=c[2],i[u]+=c[0],i[u+1]+=c[1],i[u+2]+=c[2],i[d]+=c[0],i[d+1]+=c[1],i[d+2]+=c[2]}else for(n=0,r=e.length;n<r;n+=9)pu(s,e,n),pu(o,e,n+3),pu(a,e,n+6),fu(c,a,o),fu(l,s,o),uu(c,c,l),i[n]=c[0],i[n+1]=c[1],i[n+2]=c[2],i[n+3]=c[0],i[n+4]=c[1],i[n+5]=c[2],i[n+6]=c[0],i[n+7]=c[1],i[n+8]=c[2];return lu(i),i}function Wf(e){for(var t={},i=0,n=e.length;i<n;++i)t[e[i]]=!0;return t}function qf(e,t,i,n,r){var s=1/n*3;wu(e,e,r+(s+=i)),Su(t,t,r+s),bu(e,e,n),Au(e,e),xu(e,e,n),bu(t,t,n),Mu(t,t),xu(t,t,n);var o=new Float32Array(3);fu(o,t,e),bu(o,o,n),Mu(o,o),Su(o,o,1);var a=256*Math.pow(10,6),c=o[0]*o[1]*o[2]*3;a<=c&&(bu(e,e,n*=Math.pow(a/c,1/3)),Au(e,e),xu(e,e,n),bu(t,t,n),Mu(t,t),xu(t,t,n),fu(o,t,e),bu(o,o,n),Mu(o,o),Su(o,o,1));var l=new Float32Array(e);Cu(l,l);var h=Bf(),u=Bf();$f(u,Ka(90)),Ff(h,h,u);var d=Bf();zf(d,-1/n,1/n,1/n),Ff(h,h,d);var f=Bf();return Uf(f,-n*l[2],-n*l[1],-n*l[0]),Ff(h,h,f),{dim:o,tran:l,matrix:h,scaleFactor:n}}zf.__deps=[Nf],Uf.__deps=[Nf],$f.__deps=[Nf],Vf.__deps=[hu,uu],Object.assign(Hf,{__deps:[jf]}),Object.assign(jf,{__deps:[fu,uu,pu,lu]}),Object.assign(qf,{__deps:[Ka,wu,Su,xu,bu,Au,Mu,fu,Cu,Bf,Ff,Uf,zf,$f]});class Xf{constructor(e,t,i){this.name=e||"",this.path=t||"",this.info={},this.center=new Zt,this.boundingBox=new Ni,i instanceof mr||i instanceof Vn||i instanceof ko?this.fromGeometry(i):i&&(this.set(i.position,i.index,i.normal,i.color,i.atomindex,i.contour),this.boundingBox.setFromArray(i.position),this.boundingBox.getCenter(this.center))}get type(){return"Surface"}set(e,t,i,n,r,s=!1){this.position=e,this.index=t,this.normal=i,this.color=n,this.atomindex=r,this.size=e.length/3,this.contour=s}fromGeometry(t){let i,n,r,s;if(e.Debug&&il.time("GeometrySurface.fromGeometry"),t instanceof mr?(t.computeVertexNormals(!0),i=(new Vn).fromGeometry(t)):i=t instanceof Vn?t:t[0],i.boundingBox||i.computeBoundingBox(),this.boundingBox.copy(i.boundingBox),this.boundingBox.getCenter(this.center),i instanceof Vn){const e=i.attributes,t=!!e.normal&&e.normal.array;(!t||0===t[0]&&0===t[1]&&0===t[2])&&i.computeVertexNormals(),n=e.position.array,r=e.index?e.index.array:null,s=e.normal.array}this.set(n,r,s,undefined,void 0),e.Debug&&il.timeEnd("GeometrySurface.setGeometry")}getPosition(){return this.position}getColor(e){const t=e||{};t.surface=this;const i=this.size,n=new Float32Array(3*i),r=al.getScheme(t);if(r.volumeColor||"random"===t.scheme)for(let e=0;e<i;++e)r.volumeColorToArray(e,n,3*e);else if(r.positionColor){const e=new Zt,t=this.position;for(let o=0;o<i;++o){var s=3*o;e.set(t[s],t[s+1],t[s+2]),r.positionColorToArray(e,n,s)}}else if(r.atomColor&&this.atomindex){const e=t.structure.getAtomProxy(),s=this.atomindex;for(let t=0;t<i;++t)e.index=s[t],r.atomColorToArray(e,n,3*t)}else{const e=new mn(t.value);Vl(i,e.r,e.g,e.b,n)}return n}getPicking(e){return this.atomindex&&e?new hf(this.atomindex,e):new yf(Hl(this.size),this)}getNormal(){return this.normal}getSize(e,t){return Gl(this.size,e*t)}getIndex(){return this.index}getFilteredIndex(e,t){if(e&&this.atomindex){const i=new $c(e),n=t.getAtomSet(i),r=[],s=this.atomindex,o=this.index,a=o.length,c=this.contour?2:3;let l=0;for(let e=0;e<a;e+=c){let t=!0;for(let i=0;i<c;i++){const r=s[o[e+i]];if(!n.get(r)){t=!1;break}}if(t)for(let t=0;t<c;t++,l++)r[l]=o[e+t]}return Ga(r,this.position.length/3)}return this.index}getAtomindex(){return this.atomindex}dispose(){}}function Yf(e,t,i,n,r){var s=new Af(e,t,i,n,r);this.getSurface=function(e,t,i,n,r,o=!1){const a=s.triangulate(e,t,i,r,o);if(t&&!r&&(Hf(a.position,a.index,t,!0),a.normal=jf(a.position,a.index)),n&&(au(n,a.position),a.normal)){const e=Gf();Vf(e,n),cu(e,a.normal)}return a}}Object.assign(Yf,{__deps:[Hf,jf,Af,au,cu,Gf,Vf]}),ol.add("surf",(function(e,t){const i=e.data.args,n=e.data.params;if(i&&(self.volsurf=new Yf(i[0],i[1],i[2],i[3],i[4])),n){const e=self.volsurf.getSurface(n.isolevel,n.smooth,n.box,n.matrix,n.contour,n.wrap),i=[e.position.buffer,e.index.buffer];e.normal&&i.push(e.normal.buffer),e.atomindex&&i.push(e.atomindex.buffer);t({sd:e,p:n},i)}}),[Yf]);class Zf{constructor(e,t,i,n,r,s,o){this.name=e,this.path=t,this.matrix=new ri,this.normalMatrix=new Ut,this.inverseMatrix=new ri,this.center=new Zt,this.boundingBox=new Ni,this.setData(i,n,r,s,o)}get type(){return"Volume"}setData(e,t,i,n,r){this.nx=t||1,this.ny=i||1,this.nz=n||1,this.data=e||new Float32Array(1),this.setAtomindex(r),this._position=new Float32Array,delete this._min,delete this._max,delete this._mean,delete this._rms,this.worker&&this.worker.terminate()}setStats(e,t,i,n){this._min=e,this._max=t,this._mean=i,this._rms=n}setMatrix(e){this.matrix.copy(e);const t=this.boundingBox,i=this.center,n=this.nx-1,r=this.ny-1,s=this.nz-1;t.makeEmpty(),t.expandByPoint(i.set(n,r,s)),t.expandByPoint(i.set(n,r,0)),t.expandByPoint(i.set(n,0,s)),t.expandByPoint(i.set(n,0,0)),t.expandByPoint(i.set(0,r,s)),t.expandByPoint(i.set(0,0,s)),t.expandByPoint(i.set(0,r,0)),t.expandByPoint(i.set(0,0,0)),t.applyMatrix4(this.matrix),t.getCenter(this.center);const o=this.matrix.elements,a=new Zt(o[0],o[1],o[2]),c=new Zt(o[4],o[5],o[6]),l=new Zt(o[8],o[9],o[10]),h=new Zt,u=this.normalMatrix.elements;h.crossVectors(c,l),u[0]=h.x,u[1]=h.y,u[2]=h.z,h.crossVectors(l,a),u[3]=h.x,u[4]=h.y,u[5]=h.z,h.crossVectors(a,c),u[6]=h.x,u[7]=h.y,u[8]=h.z,this.inverseMatrix.getInverse(this.matrix)}setAtomindex(e){this.atomindex=e}getBox(e,t,i){return i||(i=new Ni),i.set(e,e),i.expandByScalar(t),i.applyMatrix4(this.inverseMatrix),i.min.round(),i.max.round(),i}_getBox(e,t){if(!e||!t)return;this.__box||(this.__box=new Ni);const i=this.getBox(e,t,this.__box);return[i.min.toArray(),i.max.toArray()]}_makeSurface(e,t,i){const n=this.name+"@"+t.toPrecision(2),r=new Xf(n,"",e);return r.info.isolevel=t,r.info.smooth=i,r.info.volume=this,r}getSurface(e,t,i,n,r,s=!1){e=isNaN(e)?this.getValueForSigma(2):e,t=Ia(t,0),void 0===this.volsurf&&(this.volsurf=new Yf(this.data,this.nx,this.ny,this.nz,this.atomindex));const o=this._getBox(i,n),a=this.volsurf.getSurface(e,t,o,this.matrix.elements,r,s);return this._makeSurface(a,e,t)}getSurfaceWorker(e,t,i,n,r,s,o){if(e=isNaN(e)?this.getValueForSigma(2):e,t=t||0,window.hasOwnProperty("Worker")){void 0===this.workerPool&&(this.workerPool=new nu("surf",2));const a={},c=this.workerPool.getNextWorker();0===c.postCount&&Object.assign(a,{args:[this.data,this.nx,this.ny,this.nz,this.atomindex]}),Object.assign(a,{params:{isolevel:e,smooth:t,box:this._getBox(i,n),matrix:this.matrix.elements,contour:r,wrap:s}}),c.post(a,void 0,(e=>{const t=e.data.sd,i=e.data.p;o(this._makeSurface(t,i.isolevel,i.smooth))}),(a=>{console.warn("Volume.getSurfaceWorker error - trying without worker",a);const c=this.getSurface(e,t,i,n,r,s);o(c)}))}else{const a=this.getSurface(e,t,i,n,r,s);o(a)}}getValueForSigma(e){return this.mean+Ia(e,2)*this.rms}getSigmaForValue(e){return(Ia(e,0)-this.mean)/this.rms}get position(){if(!this._position){const e=this.nz,t=this.ny,i=this.nx,n=new Float32Array(i*t*e*3);let r=0;for(let s=0;s<e;++s)for(let e=0;e<t;++e)for(let t=0;t<i;++t)n[r+0]=t,n[r+1]=e,n[r+2]=s,r+=3;au(this.matrix.elements,n),this._position=n}return this._position}getDataAtomindex(){return this.atomindex}getDataPosition(){return this.position}getDataColor(e){const t=e||{};t.volume=this,t.scale=t.scale||"Spectral",t.domain=t.domain||[this.min,this.max];const i=al.getScheme(t),n=this.position.length/3,r=new Float32Array(3*n);for(let e=0;e<n;++e)i.volumeColorToArray(e,r,3*e);return r}getDataPicking(){const e=Hl(this.position.length/3);return new bf(e,this)}getDataSize(e,t){const i=this.data,n=this.position.length/3;let r;switch(e){case"value":case"deviation":r=new Float32Array(i);break;case"abs-value":r=new Float32Array(i);for(let e=0;e<n;++e)r[e]=Math.abs(r[e]);break;case"value-min":{r=new Float32Array(i);const e=this.min;for(let t=0;t<n;++t)r[t]-=e;break}default:r=Gl(n,e)}if(1!==t)for(let e=0;e<n;++e)r[e]*=t;return r}get min(){return void 0===this._min&&(this._min=Zl(this.data)),this._min}get max(){return void 0===this._max&&(this._max=Yl(this.data)),this._max}get sum(){return void 0===this._sum&&(this._sum=Kl(this.data)),this._sum}get mean(){return void 0===this._mean&&(this._mean=Ql(this.data)),this._mean}get rms(){return void 0===this._rms&&(this._rms=function(e){const t=e.length;let i=0;for(let n=0;n<t;++n){const t=e[n];i+=t*t}return Math.sqrt(i/t)}(this.data)),this._rms}clone(){const e=new Zf(this.name,this.path,this.data,this.nx,this.ny,this.nz,this.atomindex);return e.matrix.copy(this.matrix),e.header=Object.assign({},this.header),e}dispose(){this.workerPool&&this.workerPool.terminate()}}function Kf(e){return"front"===e?a:"back"===e?c:l}ul.add("shader/Mesh.vert","#define STANDARD\nuniform float clipNear;\nuniform vec3 clipCenter;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#elif defined( NOLIGHT )\nvarying vec3 vColor;\n#else\n#include color_pars_vertex\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#endif\n#include common\nvoid main(){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#elif defined( NOLIGHT )\nvColor = color;\n#else\n#include color_vertex\n#include beginnormal_vertex\n#include defaultnormal_vertex\n#ifndef FLAT_SHADED\nvNormal = normalize( transformedNormal );\n#endif\n#endif\n#include begin_vertex\n#include project_vertex\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),ul.add("shader/Mesh.frag","#define STANDARD\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\n#elif defined( NOLIGHT )\nvarying vec3 vColor;\n#else\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#elif defined( NOLIGHT )\ngl_FragColor = vec4( vColor, opacity );\n#else\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\n#include normal_fragment_begin\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\n#include interior_fragment\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#include opaque_back_fragment\n#endif\n}");const Qf={f:1,v2:2,v3:3,c:3};function Jf(e,t){e.matrix.copy(t),e.matrix.decompose(e.position,e.quaternion,e.scale),e.matrixWorldNeedsUpdate=!0}const em={opaqueBack:!1,side:"double",opacity:1,depthWrite:!0,clipNear:0,clipRadius:0,clipCenter:new Zt,flatShaded:!1,wireframe:!1,roughness:.4,metalness:0,diffuse:16777215,diffuseInterior:!1,useInteriorColor:!1,interiorColor:14540253,interiorDarkening:0,forceTransparent:!1,matrix:new ri,disablePicking:!1,sortParticles:!1,background:!1},tm={opaqueBack:{updateShader:!0},side:{updateShader:!0,property:!0},opacity:{uniform:!0},depthWrite:{property:!0},clipNear:{updateShader:!0,property:!0},clipRadius:{updateShader:!0,uniform:!0},clipCenter:{uniform:!0},flatShaded:{updateShader:!0},background:{updateShader:!0},wireframe:{updateVisibility:!0},roughness:{uniform:!0},metalness:{uniform:!0},diffuse:{uniform:!0},diffuseInterior:{updateShader:!0},useInteriorColor:{updateShader:!0},interiorColor:{uniform:!0},interiorDarkening:{uniform:!0},matrix:{}};class im{constructor(e,t={}){this.parameterTypes=tm,this.geometry=new Vn,this.indexVersion=0,this.wireframeIndexVersion=-1,this.group=new ko,this.wireframeGroup=new ko,this.pickingGroup=new ko,this.vertexShader="",this.fragmentShader="",this.isImpostor=!1,this.isText=!1,this.isSurface=!1,this.isPoint=!1,this.isLine=!1,this.dynamic=!0,this.visible=!0,this.wireframeIndexCount=0,this.parameters=Ea(t,this.defaultParameters),this.uniforms=yr.merge([Tr.common,{fogColor:{value:new mn(0)},fogNear:{value:0},fogFar:{value:0},opacity:{value:this.parameters.opacity},clipNear:{value:0},clipRadius:{value:this.parameters.clipRadius},clipCenter:{value:this.parameters.clipCenter}},{emissive:{value:new mn(0)},roughness:{value:this.parameters.roughness},metalness:{value:this.parameters.metalness},interiorColor:{value:new mn(this.parameters.interiorColor)},interiorDarkening:{value:this.parameters.interiorDarkening}},Tr.lights]),this.uniforms.diffuse.value.set(this.parameters.diffuse),this.pickingUniforms={clipNear:{value:0},objectId:{value:0},opacity:{value:this.parameters.opacity}};const i=e.position||e.position1;this._positionDataSize=i?i.length/3:0,e.primitiveId||(e.primitiveId=Hl(this._positionDataSize)),this.addAttributes({position:{type:"v3",value:e.position},color:{type:"c",value:e.color},primitiveId:{type:"f",value:e.primitiveId}}),t.matrix&&(this.matrix=t.matrix),e.index&&this.initIndex(e.index),this.picking=e.picking,this.makeWireframeGeometry()}get defaultParameters(){return em}set matrix(e){this.setMatrix(e)}get matrix(){return this.group.matrix.clone()}get transparent(){return this.parameters.opacity<1||this.parameters.forceTransparent}get size(){return this._positionDataSize}get attributeSize(){return this.size}get pickable(){return!!this.picking&&!this.parameters.disablePicking}setMatrix(e){Jf(this.group,e),Jf(this.wireframeGroup,e),Jf(this.pickingGroup,e)}initIndex(e){this.geometry.setIndex(new An(e,1));const t=this.geometry.getIndex();t?t.setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0):il.error("Index is null")}makeMaterial(){const e=Kf(this.parameters.side),t=new _r({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!0,fog:!0,side:e});t.vertexColors=!0,t.extensions.derivatives=!0,t.extensions.fragDepth=this.isImpostor;const i=new _r({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!1,fog:!0,side:e});i.vertexColors=!0;const n=new _r({uniforms:this.pickingUniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:!1,depthWrite:this.parameters.depthWrite,lights:!1,fog:!1,side:e,blending:h});n.vertexColors=!0,n.extensions.fragDepth=this.isImpostor,t.clipNear=this.parameters.clipNear,i.clipNear=this.parameters.clipNear,n.clipNear=this.parameters.clipNear,this.material=t,this.wireframeMaterial=i,this.pickingMaterial=n,this.updateShader()}makeWireframeGeometry(){this.makeWireframeIndex();const e=this.geometry,t=this.wireframeIndex,i=new Vn;i.attributes=e.attributes,t&&(i.setIndex(new An(t,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)),i.setDrawRange(0,this.wireframeIndexCount)),this.wireframeGeometry=i}makeWireframeIndex(){const e=[];function t(t,i){if(t>i){const e=t;t=i,i=e}const n=e[t];return void 0===n?(e[t]=[i],!0):!n.includes(i)&&(n.push(i),!0)}const i=this.geometry,n=i.index;if(this.parameters.wireframe)if(n){const r=n.array;let s,o=r.length;if(i.drawRange.count!==1/0&&(o=i.drawRange.count),this.wireframeIndex&&this.wireframeIndex.length>2*o)s=this.wireframeIndex;else{s=Ga(2*o,i.attributes.position.count)}let a=0;e.length=0;for(let e=0;e<o;e+=3){const i=r[e+0],n=r[e+1],o=r[e+2];t(i,n)&&(s[a+0]=i,s[a+1]=n,a+=2),t(n,o)&&(s[a+0]=n,s[a+1]=o,a+=2),t(o,i)&&(s[a+0]=o,s[a+1]=i,a+=2)}this.wireframeIndex=s,this.wireframeIndexCount=a,this.wireframeIndexVersion=this.indexVersion}else{const e=i.attributes.position.count;let t;t=this.wireframeIndex&&this.wireframeIndex.length>2*e?this.wireframeIndex:Ga(2*e,e);for(let i=0,n=0;i<e;i+=3)t[n+0]=i,t[n+1]=i+1,t[n+2]=i+1,t[n+3]=i+2,t[n+4]=i+2,t[n+5]=i,n+=6;this.wireframeIndex=t,this.wireframeIndexCount=2*e,this.wireframeIndexVersion=this.indexVersion}else this.wireframeIndex=new Uint16Array(0),this.wireframeIndexCount=0}updateWireframeIndex(){if(this.wireframeGeometry&&this.wireframeIndex){if(this.wireframeGeometry.setDrawRange(0,1/0),this.wireframeIndexVersion<this.indexVersion&&this.makeWireframeIndex(),this.wireframeGeometry.index&&this.wireframeIndex.length>this.wireframeGeometry.index.array.length)this.wireframeGeometry.setIndex(new An(this.wireframeIndex,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0));else{const e=this.wireframeGeometry.getIndex();if(!e)return void il.error("Index is null");e.set(this.wireframeIndex),e.needsUpdate=this.wireframeIndexCount>0,e.updateRange.count=this.wireframeIndexCount}this.wireframeGeometry.setDrawRange(0,this.wireframeIndexCount)}}getRenderOrder(){let e=0;return this.isText?e=1:this.transparent&&(e=this.isSurface?3:2),e}_getMesh(e){this.material||this.makeMaterial();const t=this.geometry,i=this[e];let n;return n=this.isLine?new Yo(t,i):this.isPoint?new ta(t,i):new ar(t,i),n.frustumCulled=!1,n.renderOrder=this.getRenderOrder(),n}getMesh(){return this._getMesh("material")}getWireframeMesh(){let e;return this.material||this.makeMaterial(),this.wireframeGeometry||this.makeWireframeGeometry(),e=new Yo(this.wireframeGeometry,this.wireframeMaterial),e.frustumCulled=!1,e.renderOrder=this.getRenderOrder(),e}getPickingMesh(){return this._getMesh("pickingMaterial")}getShader(e,t){return kl(e,this.getDefines(t))}getVertexShader(e){return this.getShader(this.vertexShader,e)}getFragmentShader(e){return this.getShader(this.fragmentShader,e)}getDefines(e){const t={};return this.parameters.clipNear&&(t.NEAR_CLIP=1),this.parameters.clipRadius&&(t.RADIUS_CLIP=1),"picking"===e?t.PICKING=1:(("background"===e||this.parameters.background)&&(t.NOLIGHT=1),this.parameters.flatShaded&&(t.FLAT_SHADED=1),this.parameters.opaqueBack&&(t.OPAQUE_BACK=1),this.parameters.diffuseInterior&&(t.DIFFUSE_INTERIOR=1),this.parameters.useInteriorColor&&(t.USE_INTERIOR_COLOR=1)),t}getParameters(){return this.parameters}addUniforms(e){this.uniforms=yr.merge([this.uniforms,e]),this.pickingUniforms=yr.merge([this.pickingUniforms,e])}addAttributes(e){for(let t in e){let i;const n=e[t],r=this.attributeSize*Qf[n.type];n.value?(r!==n.value.length&&il.error("attribute value has wrong length",t),i=n.value):i=$a("float32",r),this.geometry.setAttribute(t,new An(i,Qf[n.type]).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0))}}updateRenderOrder(){const e=this.getRenderOrder();function t(t){t.renderOrder=e}this.group.children.forEach(t),this.pickingGroup&&this.pickingGroup.children.forEach(t)}updateShader(){const e=this.material,t=this.wireframeMaterial,i=this.pickingMaterial;e.vertexShader=this.getVertexShader(),e.fragmentShader=this.getFragmentShader(),e.needsUpdate=!0,t.vertexShader=this.getShader("Line.vert"),t.fragmentShader=this.getShader("Line.frag"),t.needsUpdate=!0,i.vertexShader=this.getVertexShader("picking"),i.fragmentShader=this.getFragmentShader("picking"),i.needsUpdate=!0}setParameters(e){const t=e,i=this.parameterTypes,n=this.parameters,r={},s={};let o=!1,a=!1;for(const e in t){const c=t[e];void 0!==c&&(n[e]=c,void 0!==i[e]&&(i[e].property&&(!0!==i[e].property?r[i[e].property]=c:r[e]=c),i[e].uniform&&(!0!==i[e].uniform?s[i[e].uniform]=c:s[e]=c),i[e].updateShader&&(o=!0),i[e].updateVisibility&&(a=!0),this.dynamic&&"wireframe"===e&&!0===c&&this.updateWireframeIndex(),"forceTransparent"===e&&(r.transparent=this.transparent),"matrix"===e&&(this.matrix=c)))}this.setProperties(r),this.setUniforms(s),o&&this.updateShader(),a&&this.setVisibility(this.visible)}setAttributes(e){const t=this.geometry,i=t.attributes;for(const n in e){if("picking"===n)continue;const r=e[n],s=r.length;if("index"===n){const e=t.getIndex();if(!e){il.error("Index is null");continue}t.setDrawRange(0,1/0),s>e.array.length?t.setIndex(new An(r,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)):(e.set(r),e.count=s,e.needsUpdate=s>0,e.updateRange.count=s,t.setDrawRange(0,s)),this.indexVersion++,this.parameters.wireframe&&this.updateWireframeIndex()}else{const e=i[n];s>e.array.length?t.setAttribute(n,new An(r,e.itemSize).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)):(i[n].set(r),i[n].needsUpdate=s>0,i[n].updateRange.count=s)}}}setUniforms(e){if(!e)return;const t=this.material.uniforms,i=this.wireframeMaterial.uniforms,n=this.pickingMaterial.uniforms;for(let r in e)"opacity"===r&&this.setProperties({transparent:this.transparent}),void 0!==t[r]&&(t[r].value.isVector3?t[r].value.copy(e[r]):t[r].value.set?t[r].value.set(e[r]):t[r].value=e[r]),void 0!==i[r]&&(i[r].value.isVector3?i[r].value.copy(e[r]):i[r].value.set?i[r].value.set(e[r]):i[r].value=e[r]),void 0!==n[r]&&(n[r].value.isVector3?n[r].value.copy(e[r]):n[r].value.set?n[r].value.set(e[r]):n[r].value=e[r])}setProperties(e){if(!e)return;const t=this.material,i=this.wireframeMaterial,n=this.pickingMaterial;for(const r in e){const s=r;let o=e[s];"transparent"===s?this.updateRenderOrder():"side"===s&&(o=Kf(o)),t[s]=o,i[s]=o,n[s]=o}t.needsUpdate=!0,i.needsUpdate=!0,n.needsUpdate=!0}setVisibility(e){this.visible=e,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=e,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=e,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=e))}dispose(){this.material&&this.material.dispose(),this.wireframeMaterial&&this.wireframeMaterial.dispose(),this.pickingMaterial&&this.pickingMaterial.dispose(),this.geometry.dispose(),this.wireframeGeometry&&this.wireframeGeometry.dispose()}toJSON(){var e={};for(var t in this)"group"!==t&&"wireframeGroup"!==t&&"pickingGroup"!=t&&"picking"!==t&&(e[t]=this[t]);return e}}class nm extends im{constructor(e,t={}){super(e,t),this.vertexShader="Mesh.vert",this.fragmentShader="Mesh.frag",this.addAttributes({normal:{type:"v3",value:e.normal}}),void 0===e.normal&&this.geometry.computeVertexNormals()}}class rm extends nm{constructor(){super(...arguments),this.isSurface=!0}}function sm(e){e.visible=!0}function om(e){e.visible=!1}class am{constructor(e){this.group=new ko,this.wireframeGroup=new ko,this.pickingGroup=new ko,this.frontMeshes=[],this.backMeshes=[],this.size=e.size,this.side=e.parameters.side,this.visible=e.visible,this.geometry=e.geometry,this.picking=e.picking,this.group=new ko,this.wireframeGroup=new ko,this.pickingGroup=new ko,this.matrix=e.matrix;const t=e,i=new e.constructor({position:new Float32Array(0)});t.makeMaterial(),i.makeMaterial(),i.picking=e.picking,i.geometry=e.geometry,i.wireframeGeometry=e.wireframeGeometry,i.setParameters(e.getParameters()),i.updateShader(),t.setParameters({side:"front"}),i.setParameters({side:"back",opacity:i.parameters.opacity}),this.buffer=e,this.frontBuffer=t,this.backBuffer=i}set matrix(e){im.prototype.setMatrix.call(this,e)}get matrix(){return this.group.matrix.clone()}get pickable(){return!!this.picking&&!this.parameters.disablePicking}get parameters(){return this.buffer.parameters}getParameters(){const e=Object.assign({},this.buffer.parameters);return e.side=this.side,e}getMesh(e){let t,i;return e?(i=this.backBuffer.getPickingMesh(),t=this.frontBuffer.getPickingMesh()):(i=this.backBuffer.getMesh(),t=this.frontBuffer.getMesh()),this.frontMeshes.push(t),this.backMeshes.push(i),this.setParameters({side:this.side}),(new ko).add(i,t)}getWireframeMesh(){return this.buffer.getWireframeMesh()}getPickingMesh(){return this.getMesh(!0)}setAttributes(e){this.buffer.setAttributes(e)}setParameters(e){"front"===(e=Object.assign({},e)).side?(this.frontMeshes.forEach(sm),this.backMeshes.forEach(om)):"back"===e.side?(this.frontMeshes.forEach(om),this.backMeshes.forEach(sm)):"double"===e.side&&(this.frontMeshes.forEach(sm),this.backMeshes.forEach(sm)),void 0!==e.side&&(this.side=e.side),delete e.side,void 0!==e.matrix&&(this.matrix=e.matrix),delete e.matrix,this.frontBuffer.setParameters(e),void 0!==e.wireframe&&(this.wireframe=e.wireframe,this.setVisibility(this.visible)),delete e.wireframe,this.backBuffer.setParameters(e)}setVisibility(e){this.visible=e,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=e,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=e,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=e))}dispose(){this.frontBuffer.dispose(),this.backBuffer.dispose()}toJSON(){var e={};for(var t in this)["side","size","visible","matrix","parameters"].includes(t)&&(e[t]=this[t]);return e}}ul.add("shader/Line.vert","uniform float clipNear;\nuniform vec3 clipCenter;\nvarying vec3 vViewPosition;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#include color_pars_vertex\nvoid main(){\n#include color_vertex\n#include begin_vertex\n#include project_vertex\nvViewPosition = -mvPosition.xyz;\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),ul.add("shader/Line.frag","uniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec3 vViewPosition;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\ngl_FragColor = vec4( vColor, opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n}");class cm extends im{constructor(){super(...arguments),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag"}}class lm extends tu{constructor(e,t,i){super(e,t,i),this.type="surface",this.parameters=Object.assign({isolevelType:{type:"select",options:{value:"value",sigma:"sigma"}},isolevel:{type:"number",precision:2,max:1e3,min:-1e3},negateIsolevel:{type:"boolean"},isolevelScroll:{type:"boolean"},smooth:{type:"integer",precision:1,max:10,min:0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},boxSize:{type:"integer",precision:1,max:100,min:0},colorVolume:{type:"hidden"},contour:{type:"boolean",rebuild:!0},useWorker:{type:"boolean",rebuild:!0},wrap:{type:"boolean",rebuild:!0}},this.parameters),e instanceof Zf?(this.surface=void 0,this.volume=e):(this.surface=e,this.volume=void 0),this.boxCenter=new Zt,this.__boxCenter=new Zt,this.box=new Ni,this.__box=new Ni,this._position=new Zt,this.inverseMatrix=new ri,this.setBox=function(){this._position.copy(t.translationGroup.position).negate(),this._position.applyMatrix4(this.inverseMatrix),this._position.equals(this.boxCenter)||this.setParameters({boxCenter:this._position})},this.toBePrepared=!0,this.viewer.signals.ticked.add(this.setBox,this),this.init(i)}init(e){const t=e||{};t.colorScheme=Ia(t.colorScheme,"uniform"),t.colorValue=Ia(t.colorValue,14540253),this.isolevelType=Ia(t.isolevelType,"sigma"),this.isolevel=Ia(t.isolevel,2),this.negateIsolevel=Ia(t.negateIsolevel,!1),this.isolevelScroll=Ia(t.isolevelScroll,!1),this.smooth=Ia(t.smooth,0),this.background=Ia(t.background,!1),this.opaqueBack=Ia(t.opaqueBack,!0),this.boxSize=Ia(t.boxSize,0),this.colorVolume=Ia(t.colorVolume,void 0),this.contour=Ia(t.contour,!1),this.useWorker=Ia(t.useWorker,!0),this.wrap=Ia(t.wrap,!1),super.init(t),this.inverseMatrix.getInverse(this.matrix),this.build()}attach(e){this.bufferList.forEach((e=>{this.viewer.add(e)})),this.setVisibility(this.visible),e()}prepare(e){if(this.volume){let t;if(t="sigma"===this.isolevelType?this.volume.getValueForSigma(this.isolevel):this.isolevel,this.negateIsolevel&&(t*=-1),!this.surface||this.__isolevel!==t||this.__smooth!==this.smooth||this.__contour!==this.contour||this.__wrap!==this.wrap||this.__boxSize!==this.boxSize||this.boxSize>0&&!this.__boxCenter.equals(this.boxCenter)){this.__isolevel=t,this.__smooth=this.smooth,this.__contour=this.contour,this.__wrap=this.wrap,this.__boxSize=this.boxSize,this.__boxCenter.copy(this.boxCenter),this.__box.copy(this.box);const i=t=>{this.surface=t,e()};this.useWorker?this.volume.getSurfaceWorker(t,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap,i):i(this.volume.getSurface(t,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap))}else e()}else e()}create(){const e={position:this.surface.getPosition(),color:this.surface.getColor(this.getColorParams()),index:this.surface.getIndex()};let t;if(this.contour)t=new cm(e,this.getBufferParams({wireframe:!1}));else{Object.assign(e,{normal:this.surface.getNormal(),picking:this.surface.getPicking()});const i=new rm(e,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1}));t=new am(i)}this.bufferList.push(t)}update(e){if(0===this.bufferList.length)return;const t={};(e=e||{}).position&&(t.position=this.surface.getPosition()),e.color&&(t.color=this.surface.getColor(this.getColorParams())),e.index&&(t.index=this.surface.getIndex()),e.normal&&(t.normal=this.surface.getNormal()),this.bufferList.forEach((function(e){e.setAttributes(t)}))}setParameters(e,t,i){return e&&void 0!==e.isolevelType&&this.volume&&("value"===this.isolevelType&&"sigma"===e.isolevelType?this.isolevel=this.volume.getSigmaForValue(this.isolevel):"sigma"===this.isolevelType&&"value"===e.isolevelType&&(this.isolevel=this.volume.getValueForSigma(this.isolevel)),this.isolevelType=e.isolevelType),e&&e.boxCenter&&(this.boxCenter.copy(e.boxCenter),delete e.boxCenter),e&&e.wireframe&&(e.contour||void 0===e.contour&&this.contour)&&(e.wireframe=!1),super.setParameters(e,t,i),e.matrix&&this.inverseMatrix.getInverse(e.matrix),this.volume&&this.volume.getBox(this.boxCenter,this.boxSize,this.box),e&&void 0!==e.colorVolume&&t&&(t.color=!0),this.surface&&(void 0!==e.isolevel||void 0!==e.negateIsolevel||void 0!==e.smooth||void 0!==e.wrap||void 0!==e.boxSize||this.boxSize>0&&!this.__box.equals(this.box))&&this.build({position:!0,color:!0,index:!0,normal:!this.contour}),this}getColorParams(){const e=super.getColorParams();return e.volume=this.colorVolume,e}dispose(){this.viewer.signals.ticked.remove(this.setBox,this),super.dispose()}}class hm{static zoomScroll(e,t){e.trackballControls.zoom(t)}static clipNearScroll(e,t){const i=e.getParameters();e.setParameters({clipNear:i.clipNear+t/10})}static focusScroll(e,t){const i=e.getFocus(),n=Math.sign(t)*function(e,t,i){if(e>t)return e;const n=e/t;return((2*i-t)*n+(2*t-3*i))*n*n+i}((100-i)/10,5,.2);e.setFocus(i+n)}static zoomFocusScroll(e,t){e.trackballControls.zoom(t);const i=e.viewer.camera.position.z;e.setFocus(100-Math.abs(i/8))}static isolevelScroll(e,t){const i=Math.sign(t)/10;e.eachRepresentation(((e,t)=>{if(e.repr instanceof lm){const t=e.getParameters();t.isolevelScroll&&e.setParameters({isolevel:t.isolevel+i})}}))}static panDrag(e,t,i){e.trackballControls.pan(t,i)}static rotateDrag(e,t,i){e.trackballControls.rotate(t,i)}static zRotateDrag(e,t,i){e.trackballControls.zRotate(t,i)}static zoomDrag(e,t,i){e.trackballControls.zoom((t+i)/-2)}static zoomFocusDrag(e,t,i){e.trackballControls.zoom((t+i)/-2);const n=e.viewer.camera.position.z;e.setFocus(100-Math.abs(n/8))}static panComponentDrag(e,t,i){e.trackballControls.panComponent(t,i)}static panAtomDrag(e,t,i){e.trackballControls.panAtom(t,i)}static rotateComponentDrag(e,t,i){e.trackballControls.rotateComponent(t,i)}static movePick(e,t){t&&e.animationControls.move(t.position.clone())}static tooltipPick(e,t){const i=e.tooltip;if(e.getParameters().tooltip&&t){const e=t.mouse.position;i.innerText=t.getLabel(),i.style.bottom=window.innerHeight-e.y+3+"px",i.style.left=e.x+3+"px",i.style.display="block"}else i.style.display="none"}static measurePick(e,t){if(t&&(t.atom||t.bond)){const e=t.atom||t.closestBondAtom;t.component.measurePick(e)}else e.measureClear()}}const um={default:[["scroll",hm.zoomScroll],["scroll-shift",hm.focusScroll],["scroll-ctrl",hm.isolevelScroll],["scroll-shift-ctrl",hm.zoomFocusScroll],["drag-left",hm.rotateDrag],["drag-right",hm.panDrag],["drag-ctrl-left",hm.panDrag],["drag-ctrl-right",hm.zRotateDrag],["drag-shift-left",hm.zoomDrag],["drag-middle",hm.zoomFocusDrag],["drag-ctrl-shift-right",hm.panComponentDrag],["drag-ctrl-shift-left",hm.rotateComponentDrag],["clickPick-right",hm.measurePick],["clickPick-ctrl-left",hm.measurePick],["clickPick-middle",hm.movePick],["clickPick-left",hm.movePick],["hoverPick",hm.tooltipPick]],pymol:[["drag-left",hm.rotateDrag],["drag-middle",hm.panDrag],["drag-right",hm.zoomDrag],["scroll",hm.focusScroll],["drag-shift-right",hm.focusScroll],["clickPick-ctrl+shift-middle",hm.movePick],["hoverPick",hm.tooltipPick]],coot:[["scroll",hm.isolevelScroll],["drag-left",hm.rotateDrag],["drag-middle",hm.panDrag],["drag-ctrl-left",hm.panDrag],["drag-right",hm.zoomFocusDrag],["drag-ctrl-right",hm.focusScroll],["clickPick-middle",hm.movePick],["hoverPick",hm.tooltipPick]],astexviewer:[["drag-left",hm.rotateDrag],["drag-ctrl-left",hm.panDrag],["drag-shift-left",hm.zoomDrag],["scroll",hm.focusScroll],["clickPick-middle",hm.movePick],["hoverPick",hm.tooltipPick]]};function dm(e){const t=e.split(/[-+]/);let i="";t.includes("scroll")&&(i="scroll"),t.includes("drag")&&(i="drag"),t.includes("click")&&(i="click"),t.includes("doubleClick")&&(i="doubleClick"),t.includes("hover")&&(i="hover"),t.includes("clickPick")&&(i="clickPick"),t.includes("hoverPick")&&(i="hoverPick");let n=0;t.includes("alt")&&(n+=1),t.includes("ctrl")&&(n+=2),t.includes("meta")&&(n+=4),t.includes("shift")&&(n+=8);let r=0;return t.includes("left")&&(r+=1),t.includes("right")&&(r+=2),t.includes("middle")&&(r+=4),[i,n,r]}class fm{constructor(e,t={}){this.stage=e,this.actionList=[],this.mouse=e.mouseObserver,this.disabled=t.disabled||!1,this.preset(t.preset||"default")}run(e,...t){if(this.disabled)return;const i=this.mouse.key||0,n=this.mouse.buttons||0;this.actionList.forEach((r=>{r.type===e&&r.key===i&&r.button===n&&r.callback(this.stage,...t)}))}add(e,t){const[i,n,r]=dm(e);this.actionList.push({type:i,key:n,button:r,callback:t})}remove(e,t){const i=e.includes("*"),[n,r,s]=dm(e),o=this.actionList.filter((function(e){return!((e.type===n||i&&""===n)&&(e.key===r||i&&0===r)&&(e.button===s||i&&0===s)&&(e.callback===t||void 0===t))}));this.actionList=o}preset(e){this.clear();(um[e]||[]).forEach((e=>this.add(e[0],e[1])))}clear(){this.actionList.length=0}}class mm{static autoView(e){e.autoView(1e3)}static toggleAnimations(e){e.animationControls.toggle()}static toggleRock(e){e.toggleRock()}static toggleSpin(e){e.toggleSpin()}static toggleAntialiasing(e){const t=e.getParameters();e.setParameters({sampleLevel:-1===t.sampleLevel?0:-1})}}const pm={default:[["i",mm.toggleSpin],["k",mm.toggleRock],["p",mm.toggleAnimations],["a",mm.toggleAntialiasing],["r",mm.autoView]]};class gm{constructor(e,t={}){this.stage=e,this.actionList=[],this.disabled=t.disabled||!1,this.preset(t.preset||"default")}run(e){this.disabled||this.actionList.forEach((t=>{t.key===e&&t.callback(this.stage)}))}add(e,t){this.actionList.push({key:e,callback:t})}remove(e,t){const i=this.actionList.filter((function(i){return!(i.key===e&&(i.callback===t||void 0===t))}));this.actionList=i}preset(e){this.clear();(pm[e]||[]).forEach((e=>this.add(e[0],e[1])))}clear(){this.actionList.length=0}}class vm{constructor(e){this.stage=e,this.stage=e,this.mouse=e.mouseObserver,this.controls=e.mouseControls,this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this)}_onClick(e,t){const i=this.stage.pickingControls.pick(e,t);this.stage.signals.clicked.dispatch(i),this.controls.run("clickPick",i)}_onHover(e,t){const i=this.stage.pickingControls.pick(e,t);i&&this.mouse.down.equals(this.mouse.position)&&(this.stage.transformComponent=i.component,this.stage.transformAtom=i.atom),this.stage.signals.hovered.dispatch(i),this.controls.run("hoverPick",i)}dispose(){this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)}}class ym{constructor(e){this.stage=e,this.stage=e,this.mouse=e.mouseObserver,this.controls=e.mouseControls,this.mouse.signals.moved.add(this._onMove,this),this.mouse.signals.scrolled.add(this._onScroll,this),this.mouse.signals.dragged.add(this._onDrag,this),this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this),this.mouse.signals.doubleClicked.add(this._onDblclick,this)}_onMove(){this.stage.tooltip.style.display="none"}_onScroll(e){this.controls.run("scroll",e)}_onDrag(e,t){this.controls.run("drag",e,t)}_onClick(e,t){this.controls.run("click",e,t)}_onDblclick(e,t){this.controls.run("doubleClick",e,t)}_onHover(e,t){this.controls.run("hover",e,t)}dispose(){this.mouse.signals.moved.remove(this._onMove,this),this.mouse.signals.scrolled.remove(this._onScroll,this),this.mouse.signals.dragged.remove(this._onDrag,this),this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)}}class xm{constructor(e){this.stage=e,this.viewer=e.viewer,this.animationControls=e.animationControls,this.viewer.signals.ticked.add(this._onTick,this)}_onTick(e){this.animationControls.run(e)}dispose(){this.viewer.signals.ticked.remove(this._onTick,this)}}const bm=!!Zc&&{passive:!0};class _m{constructor(e){this.stage=e,this.stage=e,this.controls=e.keyControls,this.domElement=e.viewer.renderer.domElement,this.domElement.setAttribute("tabIndex","-1"),this.domElement.style.outline="none",this._focusDomElement=this._focusDomElement.bind(this),this._onKeydown=this._onKeydown.bind(this),this._onKeyup=this._onKeyup.bind(this),this._onKeypress=this._onKeypress.bind(this),this.domElement.addEventListener("mousedown",this._focusDomElement),this.domElement.addEventListener("touchstart",this._focusDomElement,bm),this.domElement.addEventListener("keydown",this._onKeydown),this.domElement.addEventListener("keyup",this._onKeyup),this.domElement.addEventListener("keypress",this._onKeypress)}_onKeydown(){}_onKeyup(){}_onKeypress(e){let t;t="key"in KeyboardEvent.prototype?e.key:String.fromCharCode(e.which||e.keyCode),this.controls.run(t)}_focusDomElement(){this.domElement.focus()}dispose(){this.domElement.removeEventListener("mousedown",this._focusDomElement),this.domElement.removeEventListener("touchstart",this._focusDomElement,bm),this.domElement.removeEventListener("keydown",this._onKeypress),this.domElement.removeEventListener("keyup",this._onKeypress),this.domElement.removeEventListener("keypress",this._onKeypress)}}class wm{constructor(e,t,i,n={}){this.component=e,this.position=t,this.offsetX=Ia(n.offsetX,0),this.offsetY=Ia(n.offsetY,0),this.visible=Ia(n.visible,!0),this.stage=e.stage,this.viewer=e.stage.viewer,this._viewerPosition=new Zt,this._updateViewerPosition(),this._canvasPosition=new zt,this._cameraPosition=new Zt,this.element=document.createElement("div"),Object.assign(this.element.style,{display:"block",position:"absolute",pointerEvents:"none",whiteSpace:"nowrap",left:"-10000px"}),this.viewer.wrapper.appendChild(this.element),this.setContent(i),this.updateVisibility(),this.viewer.signals.rendered.add(this._update,this),this.component.signals.matrixChanged.add(this._updateViewerPosition,this)}setContent(e){const t=this.element.style.display;if("none"===t&&(this.element.style.left="-10000px",this.element.style.display="block"),e instanceof HTMLElement)this.element.appendChild(e);else{const t=document.createElement("div");t.innerText=e,Object.assign(t.style,{backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),this.element.appendChild(t)}this._clientRect=this.element.getBoundingClientRect(),"none"===t&&(this.element.style.display=t)}setVisibility(e){this.visible=e,this.updateVisibility()}getVisibility(){return this.visible&&this.component.parameters.visible}updateVisibility(){this.element.style.display=this.getVisibility()?"block":"none"}_updateViewerPosition(){this._viewerPosition.copy(this.position).applyMatrix4(this.component.matrix)}_update(){if(!this.getVisibility())return;const e=this.element.style,t=this._canvasPosition,i=this._viewerPosition,n=this._clientRect;if(this._cameraPosition.copy(i).add(this.viewer.translationGroup.position).applyMatrix4(this.viewer.rotationGroup.matrix).sub(this.viewer.camera.position),this._cameraPosition.z<0)return void(e.display="none");e.display="block";const r=this._cameraPosition.length(),s=this.viewer.scene.fog;e.opacity=(1-rc(s.near,s.far,r)).toString(),e.zIndex=Math.round(100*(s.far-r)).toString(),this.stage.viewerControls.getPositionOnCanvas(i,t),e.bottom=this.offsetX+t.y+n.height/2+"px",e.left=this.offsetY+t.x-n.width/2+"px"}dispose(){this.viewer.wrapper.removeChild(this.element),this.viewer.signals.ticked.remove(this._update,this),this.component.signals.matrixChanged.remove(this._updateViewerPosition,this)}}const Sm=new ri,Am=new Zt,Mm=new qt;class Cm{constructor(e){this.component=e,this.signals={changed:new mc.Signal},this.stage=e.stage,this.viewer=e.stage.viewer}get position(){return this.component.position}get rotation(){return this.component.quaternion}changed(){this.component.updateMatrix(),this.viewer.requestRender(),this.signals.changed.dispatch()}spin(e,t){Sm.getInverse(this.viewer.rotationGroup.matrix),Am.copy(ja(e)).applyMatrix4(Sm),Sm.extractRotation(this.component.transform),Sm.premultiply(this.viewer.rotationGroup.matrix),Sm.getInverse(Sm),Am.copy(ja(e)),Am.applyMatrix4(Sm),Sm.makeRotationAxis(Am,t),Mm.setFromRotationMatrix(Sm),this.component.quaternion.premultiply(Mm),this.changed()}}const Pm={"":"",vdw:"by vdW radius",covalent:"by covalent radius",sstruc:"by secondary structure",bfactor:"by bfactor",size:"size",data:"data",explicit:"explicit"};class Tm{constructor(e={}){this.max=10,this.type=Ia(e.type,"size"),this.scale=Ia(e.scale,1),this.size=Ia(e.size,1),this.data=Ia(e.data,{})}atomRadius(e){let t;switch(this.type){case"vdw":t=e.vdw;break;case"covalent":t=e.covalent;break;case"bfactor":t=e.bfactor||1;break;case"sstruc":const i=e.sstruc;t="h"===i||"g"===i||"i"===i||"e"===i||"b"===i?.25:Cd.includes(e.atomname)?.4:.1;break;case"data":t=Ia(this.data[e.index],1);break;case"explicit":t=e.radius,null===t&&(t=this.size);break;default:t=this.size}return Math.min(t*this.scale,this.max)}}Tm.types=Pm;const Im=new Zt(-1,-1,-1),Em=new ri;class Dm{constructor(e){const t=e.rows,i=t/3,n=new Mf(t,3),r=new Mf(3,3),s=new Mf(1,3),o=new Mf(3,3),a=new Mf(3,3),c=If(e);Ef(e,c),Cf(n,e),Pf(r,n,n),Of(r,s,o,a);const l=new Zt(c[0],c[1],c[2]),h=new Zt(o.data[0],o.data[3],o.data[6]),u=new Zt(o.data[1],o.data[4],o.data[7]),d=new Zt(o.data[2],o.data[5],o.data[8]),f=h.clone().multiplyScalar(Math.sqrt(s.data[0]/i)),m=u.clone().multiplyScalar(Math.sqrt(s.data[1]/i)),p=d.clone().multiplyScalar(Math.sqrt(s.data[2]/i));this.begA=l.clone().sub(f),this.endA=l.clone().add(f),this.begB=l.clone().sub(m),this.endB=l.clone().add(m),this.begC=l.clone().sub(p),this.endC=l.clone().add(p),this.center=l,this.vecA=f,this.vecB=m,this.vecC=p,this.normVecA=h,this.normVecB=u,this.normVecC=d}getBasisMatrix(e=new ri){const t=e;return t.makeBasis(this.normVecB,this.normVecA,this.normVecC),t.determinant()<0&&t.scale(Im),t}getRotationQuaternion(e=new qt){const t=e;return t.setFromRotationMatrix(this.getBasisMatrix(Em)),t.inverse()}getProjectedScaleForAtoms(e){let t=-1/0,i=-1/0,n=-1/0,r=-1/0,s=-1/0,o=-1/0;const a=new Zt,c=new Zt,l=this.center,h=this.normVecA,u=this.normVecB,d=this.normVecC;return e.eachAtom((function(e){su(a.copy(e),h,l);const f=c.subVectors(a,l).normalize().dot(h),m=a.distanceTo(l);f>0?m>t&&(t=m):m>i&&(i=m),su(a.copy(e),u,l);const p=c.subVectors(a,l).normalize().dot(u),g=a.distanceTo(l);p>0?g>n&&(n=g):g>r&&(r=g),su(a.copy(e),d,l);const v=c.subVectors(a,l).normalize().dot(d),y=a.distanceTo(l);v>0?y>s&&(s=y):y>o&&(o=y)})),{d1a:t,d2a:n,d3a:s,d1b:-i,d2b:-r,d3b:-o}}}class Lm{constructor(e,t,i,n){this.volume=e,this.setFilter(t,i,n)}get header(){return this.volume.header}get matrix(){return this.volume.matrix}get normalMatrix(){return this.volume.normalMatrix}get inverseMatrix(){return this.volume.inverseMatrix}get center(){return this.volume.center}get boundingBox(){return this.volume.boundingBox}get min(){return this.volume.min}get max(){return this.volume.max}get mean(){return this.volume.mean}get rms(){return this.volume.rms}_getFilterHash(e,t,i){return JSON.stringify([e,t,i])}setFilter(e,t,i){isNaN(e)&&this.header&&(e=this.header.DMEAN+2*this.header.ARMS),e=void 0===e||isNaN(e)?-1/0:e,t=Ia(t,1/0),i=Ia(i,!1);const n=this.volume.data,r=this.volume.position,s=this.volume.atomindex,o=this._getFilterHash(e,t,i);if(o!==this._filterHash){if(e===-1/0&&t===1/0)this.data=n,this.position=r,this.atomindex=s;else{const o=n.length;this._dataBuffer||(this._dataBuffer=new ArrayBuffer(4*o),this._positionBuffer=new ArrayBuffer(3*o*4),s&&(this._atomindexBuffer=new ArrayBuffer(4*o)));const a=new Float32Array(this._dataBuffer),c=new Float32Array(this._positionBuffer);let l;s&&(l=new Uint32Array(this._atomindexBuffer));let h=0;for(let u=0;u<o;++u){const o=3*u,d=n[u];if(!i&&d>=e&&d<=t||i&&(d<e||d>t)){const e=3*h;a[h]=d,c[e+0]=r[o+0],c[e+1]=r[o+1],c[e+2]=r[o+2],s&&l&&(l[h]=s[u]),h+=1}}this.data=new Float32Array(this._dataBuffer,0,h),this.position=new Float32Array(this._positionBuffer,0,3*h),s&&(this.atomindex=new Int32Array(this._atomindexBuffer,0,h))}this._filterHash=o}}}Lm.prototype.getValueForSigma=Zf.prototype.getValueForSigma,Lm.prototype.getSigmaForValue=Zf.prototype.getSigmaForValue,Lm.prototype.getDataAtomindex=Zf.prototype.getDataAtomindex,Lm.prototype.getDataPosition=Zf.prototype.getDataPosition,Lm.prototype.getDataColor=Zf.prototype.getDataColor,Lm.prototype.getDataPicking=Zf.prototype.getDataPicking,Lm.prototype.getDataSize=Zf.prototype.getDataSize;class Rm{constructor(e,t){const i=Zu({nodeArray1:e.atomIndex1,nodeArray2:e.atomIndex2,edgeCount:e.count,nodeCount:t});this.countArray=i.countArray,this.offsetArray=i.offsetArray,this.indexArray=i.indexArray}}class km extends Wu{get _defaultFields(){return[["atomIndex1",1,"int32"],["atomIndex2",1,"int32"],["bondOrder",1,"int8"]]}addBond(e,t,i){this.growIfFull();const n=this.count,r=e.index,s=t.index;r<s?(this.atomIndex1[n]=r,this.atomIndex2[n]=s):(this.atomIndex2[n]=r,this.atomIndex1[n]=s),i&&(this.bondOrder[n]=i),this.count+=1}addBondIfConnected(e,t,i){return!!e.connectedTo(t)&&(this.addBond(e,t,i),!0)}}class Om extends Wu{get _defaultFields(){return[["residueIndex",1,"uint32"],["atomTypeId",1,"uint16"],["x",1,"float32"],["y",1,"float32"],["z",1,"float32"],["serial",1,"int32"],["bfactor",1,"float32"],["altloc",1,"uint8"],["occupancy",1,"float32"]]}setAltloc(e,t){this.altloc[e]=t.charCodeAt(0)}getAltloc(e){const t=this.altloc[e];return t?String.fromCharCode(t):""}}class Bm extends Wu{get _defaultFields(){return[["chainIndex",1,"uint32"],["atomOffset",1,"uint32"],["atomCount",1,"uint32"],["residueTypeId",1,"uint16"],["resno",1,"int32"],["sstruc",1,"uint8"],["inscode",1,"uint8"]]}setSstruc(e,t){this.sstruc[e]=t.charCodeAt(0)}getSstruc(e){const t=this.sstruc[e];return t?String.fromCharCode(t):""}setInscode(e,t){this.inscode[e]=t.charCodeAt(0)}getInscode(e){const t=this.inscode[e];return t?String.fromCharCode(t):""}}class Nm extends Wu{get _defaultFields(){return[["entityIndex",1,"uint16"],["modelIndex",1,"uint16"],["residueOffset",1,"uint32"],["residueCount",1,"uint32"],["chainname",4,"uint8"],["chainid",4,"uint8"]]}setChainname(e,t){const i=4*e;this.chainname[i]=t.charCodeAt(0),this.chainname[i+1]=t.charCodeAt(1),this.chainname[i+2]=t.charCodeAt(2),this.chainname[i+3]=t.charCodeAt(3)}getChainname(e){let t="";for(let i=0;i<4;++i){const n=this.chainname[4*e+i];if(!n)break;t+=String.fromCharCode(n)}return t}setChainid(e,t){const i=4*e;this.chainid[i]=t.charCodeAt(0),this.chainid[i+1]=t.charCodeAt(1),this.chainid[i+2]=t.charCodeAt(2),this.chainid[i+3]=t.charCodeAt(3)}getChainid(e){let t="";for(let i=0;i<4;++i){const n=this.chainid[4*e+i];if(!n)break;t+=String.fromCharCode(n)}return t}}class Fm extends Wu{get _defaultFields(){return[["chainOffset",1,"uint32"],["chainCount",1,"uint32"]]}}class zm{constructor(e){this.polymer=e,this.size=e.residueCount}getCenterIterator(e=0){const t=this.getPosition().center,i=t.length/3;let n=0,r=-1;const s=[new Zt,new Zt,new Zt,new Zt];return{size:i,next:function(){const e=this.get(r);return r+=1,e},get:function(r){r=Math.min(i-1,Math.max(0,r));const o=s[n%4],a=3*r;if(o.fromArray(t,a),e){const n=Math.min(e,r,i-r-1);for(let e=1;e<=n;++e){const i=3*e,r=(n+1-e)/(n+1);o.x+=r*t[a-i+0]+r*t[a+i+0],o.y+=r*t[a-i+1]+r*t[a+i+1],o.z+=r*t[a-i+2]+r*t[a+i+2]}o.x/=n+1,o.y/=n+1,o.z/=n+1}return n+=1,o},reset:function(){n=0,r=-1}}}getColor(e){const t=this.polymer,i=t.structure,n=t.residueCount,r=t.residueIndexStart,s=new Float32Array(3*n),o=e||{};o.structure=i;const a=al.getScheme(o),c=i.getResidueProxy(),l=i.getAtomProxy();for(let e=0;e<n;++e)c.index=r+e,l.index=c.traceAtomIndex,a.atomColorToArray(l,s,3*e);return{color:s}}getPicking(){const e=this.polymer,t=e.structure,i=e.residueCount,n=e.residueIndexStart,r=new Float32Array(i),s=t.getResidueProxy();for(let e=0;e<i;++e)s.index=n+e,r[e]=s.traceAtomIndex;return{picking:new hf(r,t)}}getSize(e){const t=this.polymer,i=t.structure,n=t.residueCount,r=t.residueIndexStart,s=new Float32Array(n),o=new Tm(e),a=i.getResidueProxy(),c=i.getAtomProxy();for(let e=0;e<n;++e)a.index=r+e,c.index=a.traceAtomIndex,s[e]=o.atomRadius(c);return{size:s}}getPosition(){const e=this.polymer,t=e.structure,i=e.residueCount,n=i-3,r=new Float32Array(3*i),s=new Float32Array(3*i),o=new Float32Array(i),a=new Float32Array(i),c=new Float32Array(i),l=new Float32Array(i),h=new Float32Array(3*i),u=new Zt,d=new Zt,f=new Zt,m=new Zt,p=new Zt,g=new Zt,v=new Zt,y=new Zt,x=new Zt,b=new Zt,_=new Zt,w=new Zt(0,0,0),S="trace",A=t.getAtomProxy(),M=t.getAtomProxy(e.getAtomIndexByType(0,S)),C=t.getAtomProxy(e.getAtomIndexByType(1,S)),P=t.getAtomProxy(e.getAtomIndexByType(2,S));for(let t=0;t<n;++t){A.index=M.index,M.index=C.index,C.index=P.index,P.index=e.getAtomIndexByType(t+3,S);const i=3*t;u.subVectors(M,A),d.subVectors(C,M),f.subVectors(P,C),m.subVectors(u,d),p.subVectors(d,f),x.crossVectors(m,p).normalize(),x.toArray(s,i),t>0&&(o[t]=x.angleTo(b));const n=Math.cos(m.angleTo(p));l[t]=180/Math.PI*Math.acos(n);const y=m.length(),T=p.length();a[t]=Math.sqrt(T*y)/Math.max(2,2*(1-n)),c[t]=Math.abs(d.dot(x)),g.copy(m).multiplyScalar(a[t]/y),v.copy(p).multiplyScalar(a[t]/T),g.subVectors(M,g),v.subVectors(C,v),g.toArray(r,i+3),v.toArray(r,i+6),_.subVectors(A,w),_.toArray(h,i),b.copy(x),w.copy(g)}g.fromArray(r,3),v.fromArray(r,6),x.subVectors(g,v).normalize(),A.index=e.getAtomIndexByType(0,S),w.copy(A),y.copy(A),su(y,x,g),y.toArray(r,0),_.subVectors(w,g),_.toArray(h,0),g.fromArray(r,3*i-6),v.fromArray(r,3*i-9),x.subVectors(g,v).normalize(),A.index=e.getAtomIndexByType(i-1,S),w.copy(A),y.copy(A),su(y,x,g),y.toArray(r,3*i-3);for(let t=i-3;t<i;++t)g.fromArray(r,3*t),A.index=e.getAtomIndexByType(t,S),w.copy(A),_.subVectors(w,g),_.toArray(h,3*t);const T=new Float32Array(i),I=new Float32Array(i),E=new Float32Array(i),D=new Float32Array(i);T[1]=a[0],I[1]=l[0],E[1]=a[0];for(let e=2;e<i-2;++e)T[e]=.5*(a[e-2]+a[e-1]),I[e]=.5*(l[e-2]+l[e-1]),E[e]=.5*(c[e-2]+c[e-1]),g.fromArray(s,3*(e-2)),v.fromArray(s,3*(e-1)),D[e]=180/Math.PI*Math.acos(Math.cos(g.angleTo(v)));T[i-2]=a[i-4],I[i-2]=l[i-4],E[i-2]=c[i-4];const L=new Float32Array(3*i);ql(s,L,0,0,3),ql(s,L,0,3,3);for(let e=2;e<i-2;++e)g.fromArray(s,3*(e-2)),v.fromArray(s,3*(e-1)),x.addVectors(v,g).multiplyScalar(.5).normalize(),x.toArray(L,3*e);return ql(s,L,3*i-12,3*i-6,3),ql(s,L,3*i-12,3*i-3,3),{center:r,axis:L,bending:D,radius:T,rise:E,twist:I,resdir:h}}}class Um{constructor(e){this.polymer=e,this.helixorient=new zm(e),this.position=this.helixorient.getPosition()}getAxis(e,t,i,n,r){e=e||30,t=t||2.5,i=void 0!==i&&i;const s=this.polymer,o=s.structure,a=s.residueCount,c=s.residueIndexStart,l=this.position,h=n||{};h.structure=o;const u=al.getScheme(h),d=new Tm(r);let f=0,m=0;const p=[],g=[],v=[],y=[],x=[],b=[],_=[],w=[],S=[];let A,M,C=new Float32Array(3*a),P=new Float32Array(3*a);const T=new Zt,I=new Zt,E=o.getResidueProxy(),D=o.getResidueProxy(),L=o.getAtomProxy(),R=new Zt,k=new Zt;let O=!1;for(let n=0;n<a;++n)if(E.index=c+n,R.fromArray(l.center,3*n),n===a-1?O=!0:(D.index=c+n+1,k.fromArray(l.center,3*n+3),(i&&E.sstruc!==D.sstruc||R.distanceTo(k)>t||l.bending[n]>e)&&(O=!0)),O){if(n-f<4){f=n,O=!1;continue}L.index=E.traceAtomIndex,C=l.axis.subarray(3*f+3,3*n),P=l.center.subarray(3*f,3*n+3),A=ru(C).normalize(),M=ru(P),T.fromArray(P),su(T,A,M),I.fromArray(P,P.length-3),su(I,A,M),A.subVectors(I,T),A.toArray(p,m),M.toArray(g,m),T.toArray(v,m),I.toArray(y,m),u.atomColorToArray(L,x,m),b.push(L.index),_.push(d.atomRadius(L)),w.push(c+f),S.push(c+n+1-f),m+=3,f=n,O=!1}const B=new Float32Array(b);return{axis:new Float32Array(p),center:new Float32Array(g),begin:new Float32Array(v),end:new Float32Array(y),color:new Float32Array(x),picking:new hf(B,o),size:new Float32Array(_),residueOffset:w,residueCount:S}}}class $m{constructor(e){this.scoreFunction=e,this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.bubbleUp(this.content.length-1)}pop(){const e=this.content[0],t=this.content.pop();return t&&this.content.length>0&&(this.content[0]=t,this.sinkDown(0)),e}peek(){return this.content[0]}remove(e){const t=this.content.length;for(let i=0;i<t;i++)if(this.content[i]===e){const n=this.content.pop();return void(n&&i!==t-1&&(this.content[i]=n,this.scoreFunction(n)<this.scoreFunction(e)?this.bubbleUp(i):this.sinkDown(i)))}throw new Error("Node not found.")}size(){return this.content.length}bubbleUp(e){const t=this.content[e];for(;e>0;){const i=Math.floor((e+1)/2)-1,n=this.content[i];if(!(this.scoreFunction(t)<this.scoreFunction(n)))break;this.content[i]=t,this.content[e]=n,e=i}}sinkDown(e){const t=this.content.length,i=this.content[e],n=this.scoreFunction(i);let r=0,s=0;for(;;){const o=2*(e+1),a=o-1;let c=null;if(a<t){const e=this.content[a];r=this.scoreFunction(e),r<n&&(c=a)}if(o<t){const e=this.content[o];s=this.scoreFunction(e),s<(null===c?n:r)&&(c=o)}if(null===c)break;this.content[e]=this.content[c],this.content[c]=i,e=c}}}
/**
	 * Kdtree
	 * @class
	 * @author Alexander Rose <alexander.rose@weirdbyte.de>, 2016
	 * @author Roman Bolzern <roman.bolzern@fhnw.ch>, 2013
	 * @author I4DS http://www.fhnw.ch/i4ds, 2013
	 * @license MIT License <http://www.opensource.org/licenses/mit-license.php>
	 * @description
	 * k-d Tree for typed arrays of 3d points (e.g. for Float32Array), in-place
	 * provides fast nearest neighbour search
	 *
	 * Based on https://github.com/ubilabs/kd-tree-javascript by Ubilabs
	 *
	 * Further information (including mathematical properties)
	 * http://en.wikipedia.org/wiki/Binary_tree
	 * http://en.wikipedia.org/wiki/K-d_tree
	 *
	 * @example
	 * points: [x, y, z, x, y, z, x, y, z, ...]
	 * metric: function(a, b){
	 *    return Math.pow(a[0]-b[0], 2) + Math.pow(a[1]-b[1], 2) + Math.pow(a[2]-b[2], 2);
	 * }
	 *
	 * @param {Float32Array} points - points
	 * @param {Function} metric - metric
	 */class Gm{constructor(e,t){this.points=e,this.metric=t,this.maxDepth=0,this.currentNode=0;const i=e.length/3,n=new Uint32Array(i);for(let e=0;e<i;++e)n[e]=e;this.indices=n,this.nodes=new Int32Array(4*i),this.rootIndex=this.buildTree(0,-1,0,i)}buildTree(e,t,i,n){e>this.maxDepth&&(this.maxDepth=e);const r=n-i;if(0===r)return-1;const s=4*this.currentNode,o=this.nodes;if(this.currentNode+=1,1===r)return o[s]=i,o[s+1]=-1,o[s+2]=-1,o[s+3]=t,s;const a=this.indices,c=this.points,l=i+Math.floor(r/2),h=e%3;let u,d,f,m,p,g=i,v=n-1;for(;v>g;){for(f=g+v>>1,m=c[3*a[f]+h],d=a[f],a[f]=a[v],a[v]=d,p=g,u=g;u<v;++u)c[3*a[u]+h]<m&&(d=a[p],a[p]=a[u],a[u]=d,++p);if(d=a[v],a[v]=a[p],a[p]=d,f=p,l===f)break;l<f?v=f-1:g=f+1}return o[s]=l,o[s+1]=this.buildTree(e+1,s,i,l),o[s+2]=this.buildTree(e+1,s,l+1,n),o[s+3]=t,s}getNodeDepth(e){const t=this.nodes[e+3];return-1===t?0:this.getNodeDepth(t)+1}nearest(e,t,i){const n=new $m((e=>-e[1])),r=this.nodes,s=this.points,o=this.indices,a=c=>{let l,h;const u=this.getNodeDepth(c)%3,d=3*o[r[c]],f=[s[d+0],s[d+1],s[d+2]],m=this.metric(e,f);function p(e,i){n.push([e,i]),n.size()>t&&n.pop()}const g=r[c+1],v=r[c+2];if(-1===v&&-1===g)return void((n.size()<t||m<n.peek()[1])&&m<=i&&p(c,m));l=-1===v?g:-1===g?v:e[u]<=s[d+u]?g:v,a(l),(n.size()<t||m<n.peek()[1])&&m<=i&&p(c,m);const y=[];for(let t=0;t<3;t+=1)y[t]=t===u?e[t]:s[d+t];const x=this.metric(y,f);(n.size()<t||Math.abs(x)<n.peek()[1])&&Math.abs(x)<=i&&(h=l===g?v:g,-1!==h&&a(h))};a(this.rootIndex);const c=[];for(let e=0,i=Math.min(n.size(),t);e<i;e+=1)c.push(n.content[e]);return c}verify(e,t=0){let i=1;if(void 0===e&&(e=this.rootIndex),-1===e)throw new Error("node is null");const n=t%3,r=this.nodes,s=this.points,o=this.indices,a=r[e+1],c=r[e+2];if(-1!==a){if(s[3*o[r[a]]+n]>s[3*o[r[e]]+n])throw new Error("left child is > parent!");i+=this.verify(a,t+1)}if(-1!==c){if(s[3*o[r[c]]+n]<s[3*o[r[e]]+n])throw new Error("right child is < parent!");i+=this.verify(c,t+1)}return i}}class Vm{constructor(e,t=0){this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueMap=e.residueMap,this.atomMap=e.atomMap}get bondHash(){return this.structure.bondHash}get entity(){return this.structure.entityList[this.entityIndex]}get entityIndex(){return this.chainStore.entityIndex[this.chainIndex]}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainIndex(){return this.residueStore.chainIndex[this.residueIndex]}get residue(){return console.warn("residue - might be expensive"),this.structure.getResidueProxy(this.residueIndex)}get residueIndex(){return this.atomStore.residueIndex[this.index]}set residueIndex(e){this.atomStore.residueIndex[this.index]=e}get sstruc(){return this.residueStore.getSstruc(this.residueIndex)}get inscode(){return this.residueStore.getInscode(this.residueIndex)}get resno(){return this.residueStore.resno[this.residueIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}get chainid(){return this.chainStore.getChainid(this.chainIndex)}get residueType(){return this.residueMap.get(this.residueStore.residueTypeId[this.residueIndex])}get atomType(){return this.atomMap.get(this.atomStore.atomTypeId[this.index])}get residueAtomOffset(){return this.residueStore.atomOffset[this.residueIndex]}get resname(){return this.residueType.resname}get hetero(){return this.residueType.hetero}get atomname(){return this.atomType.atomname}get number(){return this.atomType.number}get element(){return this.atomType.element}get vdw(){return this.atomType.vdw}get covalent(){return this.atomType.covalent}get x(){return this.atomStore.x[this.index]}set x(e){this.atomStore.x[this.index]=e}get y(){return this.atomStore.y[this.index]}set y(e){this.atomStore.y[this.index]=e}get z(){return this.atomStore.z[this.index]}set z(e){this.atomStore.z[this.index]=e}get serial(){return this.atomStore.serial[this.index]}set serial(e){this.atomStore.serial[this.index]=e}get bfactor(){return this.atomStore.bfactor[this.index]}set bfactor(e){this.atomStore.bfactor[this.index]=e}get occupancy(){return this.atomStore.occupancy[this.index]}set occupancy(e){this.atomStore.occupancy[this.index]=e}get altloc(){return this.atomStore.getAltloc(this.index)}set altloc(e){this.atomStore.setAltloc(this.index,e)}get partialCharge(){return this.atomStore.partialCharge?this.atomStore.partialCharge[this.index]:null}set partialCharge(e){this.atomStore.partialCharge&&(this.atomStore.partialCharge[this.index]=e)}get radius(){return this.atomStore.radius?this.atomStore.radius[this.index]:null}set radius(e){this.atomStore.radius&&(this.atomStore.radius[this.index]=e)}get formalCharge(){return this.atomStore.formalCharge?this.atomStore.formalCharge[this.index]:null}set formalCharge(e){this.atomStore.formalCharge&&(this.atomStore.formalCharge[this.index]=e)}get aromatic(){return this.atomStore.aromatic?this.atomStore.aromatic[this.index]:this.residueType.isAromatic(this)?1:0}set aromatic(e){this.atomStore.aromatic&&(this.atomStore.aromatic[this.index]=e)}get bondCount(){return this.bondHash.countArray[this.index]}eachBond(e,t){t=t||this.structure._bp;const i=this.index,n=this.bondHash,r=n.indexArray,s=n.countArray[i],o=n.offsetArray[i];for(let i=0;i<s;++i)t.index=r[o+i],e(t)}eachBondedAtom(e,t){const i=t||this.structure._ap,n=this.index;this.eachBond((function(t){i.index=n!==t.atomIndex1?t.atomIndex1:t.atomIndex2,e(i)})),this.index=n}hasBondTo(e){let t=!1;return this.eachBondedAtom((function(i){e.index===i.index&&(t=!0)})),t}bondToElementCount(e){let t=0;const i=this.index;return this.eachBondedAtom((function(i){i.number===e&&(t+=1)})),this.index=i,t}hasBondToElement(e){return this.bondToElementCount(e)>0}isBackbone(){const e=this.residueType.backboneIndexList;return e.length>0&&e.includes(this.index-this.residueAtomOffset)}isPolymer(){if(this.structure.entityList.length>0)return this.entity.isPolymer();{const e=this.residueType.moleculeType;return 3===e||4===e||5===e}}isSidechain(){return this.isPolymer()&&!this.isBackbone()}isCg(){const e=this.residueType.backboneType;return 4===e||5===e||6===e}isTrace(){return this.index===this.residueType.traceAtomIndex+this.residueAtomOffset}isHetero(){return 1===this.residueType.hetero}isProtein(){return 3===this.residueType.moleculeType}isNucleic(){const e=this.residueType.moleculeType;return 4===e||5===e}isRna(){return 4===this.residueType.moleculeType}isDna(){return 5===this.residueType.moleculeType}isWater(){return 1===this.residueType.moleculeType}isIon(){return 2===this.residueType.moleculeType}isSaccharide(){return 6===this.residueType.moleculeType}isHelix(){return od.includes(this.sstruc)}isSheet(){return ad.includes(this.sstruc)}isTurn(){return cd.includes(this.sstruc)&&this.isProtein()}isBonded(){return 0!==this.bondHash.countArray[this.index]}isRing(){return void 0!==this.residueType.getRings().atomRings[this.index-this.residueAtomOffset]}isAromatic(){return 1===this.aromatic}isPolarHydrogen(){let e=!1;return 1!==this.number||(e=!this.hasBondToElement(6)),e}isMetal(){return this.atomType.isMetal()}isNonmetal(){return this.atomType.isNonmetal()}isMetalloid(){return this.atomType.isMetalloid()}isHalogen(){return this.atomType.isHalogen()}isDiatomicNonmetal(){return this.atomType.isDiatomicNonmetal()}isPolyatomicNonmetal(){return this.atomType.isPolyatomicNonmetal()}isAlkaliMetal(){return this.atomType.isAlkaliMetal()}isAlkalineEarthMetal(){return this.atomType.isAlkalineEarthMetal()}isNobleGas(){return this.atomType.isNobleGas()}isTransitionMetal(){return this.atomType.isTransitionMetal()}isPostTransitionMetal(){return this.atomType.isPostTransitionMetal()}isLanthanide(){return this.atomType.isLanthanide()}isActinide(){return this.atomType.isActinide()}getDefaultValence(){return this.atomType.getDefaultValence()}getValenceList(){return this.atomType.getValenceList()}getOuterShellElectronCount(){return this.atomType.getOuterShellElectronCount()}distanceTo(e){const t=this.atomStore,i=e.atomStore,n=this.index,r=e.index,s=t.x[n]-i.x[r],o=t.y[n]-i.y[r],a=t.z[n]-i.z[r],c=s*s+o*o+a*a;return Math.sqrt(c)}connectedTo(e){const t=this.atomStore,i=e.atomStore,n=this.index,r=e.index;if(t.altloc&&i.altloc){const e=t.altloc[n],s=i.altloc[r];if(0!==e&&0!==s&&32!==e&&32!==s&&e!==s)return!1}const s=t.x[n]-i.x[r],o=t.y[n]-i.y[r],a=t.z[n]-i.z[r],c=s*s+o*o+a*a;if(c<48&&this.isCg())return!0;if(isNaN(c))return!1;const l=this.covalent+e.covalent,h=l+.3,u=l-.5;return c<h*h&&c>u*u}positionFromArray(e,t=0){return this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this}positionToArray(e=[],t=0){const i=this.index,n=this.atomStore;return e[t+0]=n.x[i],e[t+1]=n.y[i],e[t+2]=n.z[i],e}positionToVector3(e){return void 0===e&&(e=new Zt),e.x=this.x,e.y=this.y,e.z=this.z,e}positionFromVector3(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}positionAdd(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}positionSub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}getResidueBonds(e=!1){const t=this.residueAtomOffset,i=this.index-this.residueAtomOffset,n=this.residueType.getBonds(),r=n.atomIndices1,s=n.atomIndices2;let o,a,c,l;for(e||(l=[]),o=r.indexOf(i);-1!==o;){if(c=s[o]+t,!l)return c;l.push(c),o=r.indexOf(i,o+1)}for(a=s.indexOf(i);-1!==a;){if(c=r[a]+t,!l)return c;l.push(c),a=s.indexOf(i,a+1)}return l}qualifiedName(e=!1){var t="";return this.resname&&!e&&(t+="["+this.resname+"]"),void 0!==this.resno&&(t+=this.resno),this.inscode&&(t+="^"+this.inscode),this.chainname&&(t+=":"+this.chainname),this.atomname&&(t+="."+this.atomname),this.altloc&&(t+="%"+this.altloc),this.structure.modelStore.count>1&&(t+="/"+this.modelIndex),t}clone(){return new Vm(this.structure,this.index)}toObject(){return{index:this.index,residueIndex:this.residueIndex,resname:this.resname,x:this.x,y:this.y,z:this.z,element:this.element,chainname:this.chainname,resno:this.resno,serial:this.serial,vdw:this.vdw,covalent:this.covalent,hetero:this.hetero,bfactor:this.bfactor,altloc:this.altloc,atomname:this.atomname,modelIndex:this.modelIndex}}}function Hm(e,t){const i=e[0]-t[0],n=e[1]-t[1],r=e[2]-t[2];return i*i+n*n+r*r}function jm(e,t){return Math.sqrt(Hm(e,t))}const Wm=new Float32Array(3);class qm{constructor(t,i=!1){e.Debug&&il.time("Kdtree build");const n=i?Hm:jm,r=new Float32Array(3*t.atomCount),s=new Uint32Array(t.atomCount);let o=0;t.eachAtom((function(e){r[o+0]=e.x,r[o+1]=e.y,r[o+2]=e.z,s[o/3]=e.index,o+=3})),this.atomIndices=s,this.points=r,this.kdtree=new Gm(r,n),e.Debug&&il.timeEnd("Kdtree build")}nearest(e,t,i){e instanceof Zt?e.toArray(Wm):e instanceof Vm&&e.positionToArray(Wm);const n=this.kdtree.nearest(Wm,t,i),r=this.kdtree.indices,s=this.kdtree.nodes,o=this.atomIndices,a=[];for(let e=0,t=n.length;e<t;++e){const t=n[e],i=t[0],c=t[1];a.push({index:o[r[s[i]]],distance:c})}return a}}const Xm={" ":"X","!":"Y","#":"Z",$:"-X","%":"-Y","&":"-Z","'":"Y+1/2","(":"1/2+X",")":"1/2+Y","*":"1/2-X","+":"1/2+Z",",":"1/2-Y","-":"1/2-Z",".":"X+1/2","/":"Z+1/2",0:"-X+1/2",1:"-Y+1/2",2:"-Z+1/2",3:"1/4+X",4:"1/4-Y",5:"1/4+Z",6:"1/4-X",7:"1/4+Y",8:"3/4-Y",9:"3/4+Z",":":"3/4+Y",";":"3/4+X","<":"3/4-X","=":"1/4-Z",">":"3/4-Z","?":"X-Y","@":"Y-X",A:"Z+1/3",B:"Z+2/3",C:"X+2/3",D:"Y+1/3",E:"-Y+2/3",F:"X-Y+1/3",G:"Y-X+2/3",H:"-X+1/3",I:"X+1/3",J:"Y+2/3",K:"-Y+1/3",L:"X-Y+2/3",M:"Y-X+1/3",N:"-X+2/3",O:"2/3+X",P:"1/3+Y",Q:"1/3+Z",R:"2/3-Y",S:"1/3+X-Y",T:"2/3+Y-X",U:"1/3-X",V:"2/3-X",W:"1/3-Y",X:"1/3-Z",Y:"2/3+Y",Z:"1/3+Y-X","[":"2/3+X-Y","]":"1/3+X","^":"2/3+Z",_:"2/3-Z","`":"5/6+Z",a:"1/6+Z",b:"5/6-Z",c:"1/6-Z",d:"Z+5/6",e:"Z+1/6",f:"Z+1/4",g:"+Y"},Ym={"P 1":" !#","P -1":" !#$%&","P 1 2 1":" !#$!&","P 1 21 1":" !#$'&","C 1 2 1":" !#$!&()#*)&","P 1 m 1":" !# %#","P 1 c 1":" !# %+","C 1 m 1":" !# %#()#(,#","C 1 c 1":" !# %+()#(,+","P 1 2/m 1":" !# %#$!&$%&","P 1 21/m 1":" !#$)&$%& ,#","C 1 2/m 1":" !# %#$!&$%&()#(,#*)&*,&","P 1 2/c 1":" !#$!-$%& %+","P 1 21/c 1":" !#$%&$)- ,+","C 1 2/c 1":" !#$!-$%& %+()#*)-*,&(,+","P 2 2 2":" !#$%#$!& %&","P 2 2 21":" !#$%+$!- %&","P 21 21 2":" !#$%#*)&(,&","P 21 21 21":" !#*%+$)-(,&","C 2 2 21":" !#$%+$!- %&()#*,+*)-(,&","C 2 2 2":" !#$%#$!& %&()#*,#*)&(,&","F 2 2 2":" !#$%#$!& %& )+$,+$)- ,-(!+*%+*!-(%-()#*,#*)&(,&","I 2 2 2":" !#$%# %&$!&.'/01/.120'2","I 21 21 21":" !#*%+$)-(,&()+$,#*!& %-","P m m 2":" !#$%# %#$!#","P m c 21":" !#$%+ %+$!#","P c c 2":" !#$%# %+$!+","P m a 2":" !#$%#(%#*!#","P c a 21":" !#$%+(%#*!+","P n c 2":" !#$%# ,+$)+","P m n 21":" !#*%+(%+$!#","P b a 2":" !#$%#(,#*)#","P n a 21":" !#$%+(,#*)+","P n n 2":" !#$%#(,+*)+","C m m 2":" !#$%# %#$!#()#*,#(,#*)#","C m c 21":" !#$%+ %+$!#()#*,+(,+*)#","C c c 2":" !#$%# %+$!+()#*,#(,+*)+","A m m 2":" !#$%# %#$!# )+$,+ ,+$)+","A b m 2":" !#$%# ,#$)# )+$,+ %+$!+","A m a 2":" !#$%#(%#*!# )+$,+(,+*)+","A b a 2":" !#$%#(,#*)# )+$,+(%+*!+","F m m 2":" !#$%# %#$!# )+$,+ ,+$)+(!+*%+(%+*!+()#*,#(,#*)#","F d d 2":" !#$%#345675 )+$,+3896:9(!+*%+;49<79()#*,#;85<:5","I m m 2":" !#$%# %#$!#()+*,+(,+*)+","I b a 2":" !#$%#(,#*)#()+*,+ %+$!+","I m a 2":" !#$%#(%#*!#()+*,+ ,+$)+","P 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#","P 2/n 2/n 2/n":" !#$%#$!& %&*,-()-(,+*)+","P 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+","P 2/b 2/a 2/n":" !#$%#$!& %&*,&()&(,#*)#","P 21/m 2/m 2/a":" !#*%#$!&(%&$%&(!& %#*!#","P 2/n 21/n 2/a":" !#*%#*)- ,-$%&(!&(,+$)+","P 2/m 2/n 21/a":" !#*%+*!- %&$%&(!-(%+$!#","P 21/c 2/c 2/a":" !#*%#$!-(%-$%&(!& %+*!+","P 21/b 21/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#","P 21/c 21/c 2/n":" !#*,#$)-(%-$%&()& ,+*!+","P 2/b 21/c 21/m":" !#$%+$)- ,&$%& !- ,+$)#","P 21/n 21/n 2/m":" !#$%#*)-(,-$%& !&(,+*)+","P 21/m 21/m 2/n":" !#$%#*'&.,&*,&.'& %#$!#","P 21/b 2/c 21/n":" !#*,+$!-(,&$%&()- %+*)#","P 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#","P 21/n 21/m 21/a":" !#0%/$'&.12$%&.!2 1#0'/","C 2/m 2/c 21/m":" !#$%+$!- %&$%& !- %+$!#()#*,+*)-(,&*,&()-(,+*)#","C 2/m 2/c 21/a":" !#$,+$)- %&$%& )- ,+$!#()#*%+*!-(,&*,&(!-(%+*)#","C 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()#*,#*)&(,&*,&()&(,#*)#","C 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+()#*,#*)-(,-*,&()&(,+*)+","C 2/m 2/m 2/a":" !#$,#$)& %&$%& )& ,#$!#()#*%#*!&(,&*,&(!&(%#*)#","C 2/c 2/c 2/a":" !#*,#$!&(,&$,-(!- ,+*!+()#$%#*)& %&*%- )-(%+$)+","F 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!# )+$,+$)- ,-$,- )- ,+$)+(!+*%+*!-(%-*%-(!-(%+*!+()#*,#*)&(,&*,&()&(,#*)#","F 2/d 2/d 2/d":" !#$%#$!& %&64=37=345675 )+$,+$)- ,-68>3:>3896:9(!+*%+*!-(%-<4>;7>;49<79()#*,#*)&(,&<8=;:=;85<:5","I 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()+*,+*)-(,-*,-()-(,+*)+","I 2/b 2/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#()+*,+$!- %-*,-()- %+$!+","I 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#()+$,#*!& %-*,- )&(%#$!+","I 21/m 21/m 21/a":" !#$,#$)& %&$%& )& ,#$!#()+*%+*!-(,-*,-(!-(%+*)+","P 4":" !#$%#% #!$#","P 41":" !#$%+% 5!$9","P 42":" !#$%#% +!$+","P 43":" !#$%+% 9!$5","I 4":" !#$%#% #!$#()+*,+,(+)*+","I 41":" !#*,+%(5)$9()+$%#, 9!*5","P -4":" !#$%#!$&% &","I -4":" !#$%#!$&% &()+*,+)*-,(-","P 4/m":" !#$%#% #!$#$%& !&!$&% &","P 42/m":" !#$%#% +!$+$%& !&!$-% -","P 4/n":" !#$%#,(#)*#*,&()&!$&% &","P 42/n":" !#$%#,(+)*+*,-()-!$&% &","I 4/m":" !#$%#% #!$#$%& !&!$&% &()+*,+,(+)*+*,-()-)*-,(-","I 41/a":" !#*,+%(5)$9$,=(!>!$&,(-()+$%#, 9!*5*%> )=)*-% &","P 4 2 2":" !#$%#% #!$#$!& %&! &%$&","P 4 21 2":" !#$%#,(#)*#*)&(,&! &%$&","P 41 2 2":" !#$%+% 5!$9$!& %-! >%$=","P 41 21 2":" !#$%+,(5)*9*)=(,>! &%$-","P 42 2 2":" !#$%#% +!$+$!& %&! -%$-","P 42 21 2":" !#$%#,(+)*+*)-(,-! &%$&","P 43 2 2":" !#$%+% 9!$5$!& %-! =%$>","P 43 21 2":" !#$%+,(9)*5*)>(,=! &%$-","I 4 2 2":" !#$%#% #!$#$!& %&! &%$&()+*,+,(+)*+*)-(,-)(-,*-","I 41 2 2":" !#*,+%(5)$9*!> ,=)(-%$&()+$%#, 9!*5$)=(%>! &,*-","P 4 m m":" !#$%#% #!$# %#$!#%$#! #","P 4 b m":" !#$%#% #!$#(,#*)#,*#)(#","P 42 c m":" !#$%#% +!$+ %+$!+%$#! #","P 42 n m":" !#$%#,(+)*+(,+*)+%$#! #","P 4 c c":" !#$%#% #!$# %+$!+%$+! +","P 4 n c":" !#$%#% #!$#(,+*)+,*+)(+","P 42 m c":" !#$%#% +!$+ %#$!#%$+! +","P 42 b c":" !#$%#% +!$+(,#*)#,*+)(+","I 4 m m":" !#$%#% #!$# %#$!#%$#! #()+*,+,(+)*+(,+*)+,*+)(+","I 4 c m":" !#$%#% #!$# %+$!+%$+! +()+*,+,(+)*+(,#*)#,*#)(#","I 41 m d":" !#*,+%(5)$9 %#*)+%*5) 9()+$%#, 9!*5(,+$!#,$9!(5","I 41 c d":" !#*,+%(5)$9 %+*)#%*9) 5()+$%#, 9!*5(,#$!+,$5!(9","P -4 2 m":" !#$%#% &!$&$!& %&%$#! #","P -4 2 c":" !#$%#% &!$&$!- %-%$+! +","P -4 21 m":" !#$%#% &!$&*)&(,&,*#)(#","P -4 21 c":" !#$%#% &!$&*)-(,-,*+)(+","P -4 m 2":" !#$%#!$&% & %#$!#! &%$&","P -4 c 2":" !#$%#% &!$& %+$!+! -%$-","P -4 b 2":" !#$%#% &!$&(,#*)#)(&,*&","P -4 n 2":" !#$%#% &!$&(,+*)+)(-,*-","I -4 m 2":" !#$%#% &!$& %#$!#! &%$&()+*,+,(-)*-(,+*)+)(-,*-","I -4 c 2":" !#$%#% &!$& %+$!+! -%$-()+*,+,(-)*-(,#*)#)(&,*&","I -4 2 m":" !#$%#% &!$&$!& %&%$#! #()+*,+,(-)*-*)-(,-,*+)(+","I -4 2 d":" !#$%#% &!$&*!>(%>,$9) 9()+*,+,(-)*-$)= ,=%*5!(5","P 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #","P 4/m 2/c 2/c":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +","P 4/n 2/b 2/m":" !#$%#% #!$#$!& %&! &%$&*,&()&)*&,(&(,#*)#,*#)(#","P 4/n 2/n 2/c":" !#$%#% #!$#$!& %&! &%$&*,-()-)*-,(-(,+*)+,*+)(+","P 4/m 21/b 2/m":" !#$%#% #!$#*)&(,&)(&,*&$%& !&!$&% &(,#*)#,*#)(#","P 4/m 21/n 2/c":" !#$%#% #!$#*)-(,-)(-,*-$%& !&!$&% &(,+*)+,*+)(+","P 4/n 21/m 2/m":" !#$%#,(#)*#*)&(,&! &%$&*,&()&!$&% & %#$!#,*#)(#","P 4/n 2/c 2/c":" !#$%#,(#)*#*)-(,-! -%$-*,&()&!$&% & %+$!+,*+)(+","P 42/m 2/m 2/c":" !#$%#% +!$+$!& %&! -%$-$%& !&!$-% - %#$!#%$+! +","P 42/m 2/c 2/m":" !#$%#% +!$+$!- %-! &%$&$%& !&!$-% - %+$!+%$#! #","P 42/n 2/b 2/c":" !#$%#,(+)*+$!- %-)(&,*&*,-()-!$&% &(,#*)#%$+! +","P 42/n 2/n 2/m":" !#$%#,(+)*+$!& %&)(-,*-*,-()-!$&% &(,+*)+%$#! #","P 42/m 21/b 2/c":" !#$%#% +!$+*)&(,&)(-,*-$%& !&!$-% -(,#*)#,*+)(+","P 42/m 21/n 2/m":" !#$%#,./'*/*'-.,-! &%$&$%& !&'*-,.-.,/*'/%$#! #","P 42/n 21/m 2/c":" !#$%#,(+)*+*)-(,-! &%$&*,-()-!$&% & %#$!#,*+)(+","P 42/n 21/c 2/m":" !#$%#,(+)*+*)&(,&! -%$-*,-()-!$&% & %+$!+,*#)(#","I 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #()+*,+,(+)*+*)-(,-)(-,*-*,-()-)*-,(-(,+*)+,*+)(+","I 4/m 2/c 2/m":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +()+*,+,(+)*+*)&(,&)(&,*&*,-()-)*-,(-(,#*)#,*#)(#","I 41/a 2/m 2/d":" !#*,+%(5)$9*!> ,=)(-%$&$,=(!>!$&,(-(,+$!#,$9!(5()+$%#, 9!*5$)=(%>! &,*-*%> )=)*-% & %#*)+%*5) 9","I 41/a 2/c 2/d":" !#*,+%(5)$9*!= ,>)(&%$-$,=(!>!$&,(-(,#$!+,$5!(9()+$%#, 9!*5$)>(%=! -,*&*%> )=)*-% & %+*)#%*9) 5","P 3":" !#%?#@$#","P 31":" !#%?A@$B","P 32":" !#%?B@$A","H 3":" !#%?#@$#CDAEFAGHAIJBKLBMNB","R 3":" !## !!# ","P -3":" !#%?#@$#$%&!@&? &","H -3":" !#%?#@$#$%&!@&? &OPQRSQTUQVWXYZX[]X]Y^W[^ZV^UR_PT_SO_","R -3":" !## !!# $%&&$%%&$","P 3 1 2":" !#%?#@$#%$&@!& ?&","P 3 2 1":" !#%?#@$#! &?%&$@&","P 31 1 2":" !#%?Q@$^%$_@!X ?&","P 31 2 1":" !#%?A@$B! &?%_$@X","P 32 1 2":" !#%?^@$Q%$X@!_ ?&","P 32 2 1":" !#%?B@$A! &?%X$@_","H 3 2":" !#%?#@$#! &?%&$@&OPQRSQTUQY]X[WXVZX]Y^W[^ZV^PO_SR_UT_","R 3 2":" !## !!# %$&$&%&%$","P 3 m 1":" !#%?#@$#%$#@!# ?#","P 3 1 m":" !#%?#@$#! #?%#$@#","P 3 c 1":" !#%?#@$#%$+@!+ ?+","P 3 1 c":" !#%?#@$#! +?%+$@+","H 3 m":" !#%?#@$#%$#@!# ?#OPQRSQTUQRUQTPQOSQ]Y^W[^ZV^WV^ZY^][^","R 3 m":" !## !!# ! # #!#! ","H 3 c":" !#%?#@$#%$+@!+ ?+OPQRSQTUQRU`TP`OS`]Y^W[^ZV^WVaZYa][a","R 3 c":" !## !!# '././'/'.","P -3 1 2/m":" !#%?#@$#%$&@!& ?&$%&!@&? &! #?%#$@#","P -3 1 2/c":" !#%?#@$#%$-@!- ?-$%&!@&? &! +?%+$@+","P -3 2/m 1":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#","P -3 2/c 1":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+","H -3 2/m":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#OPQRSQTUQY]X[WXVZXVWXYZX[]XRUQTPQOSQ]Y^W[^ZV^PO_SR_UT_UR_PT_SO_WV^ZY^][^","R -3 2/m":" !## !!# %$&$&%&%$$%&&$%%&$! # #!#! ","H -3 2/c":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+OPQRSQTUQY]b[WbVZbVWXYZX[]XRU`TP`OS`]Y^W[^ZV^POcSRcUTcUR_PT_SO_WVaZYa][a","R -3 2/c":" !## !!# 102021210$%&&$%%&$'././'/'.","P 6":" !#%?#@$#$%#!@#? #","P 61":" !#%?A@$B$%/!@d? e","P 65":" !#%?B@$A$%/!@e? d","P 62":" !#%?^@$Q$%#!@^? Q","P 64":" !#%?Q@$^$%#!@Q? ^","P 63":" !#%?#@$#$%+!@+? +","P -6":" !#%?#@$# !&%?&@$&","P 6/m":" !#%?#@$#$%#!@#? #$%&!@&? & !&%?&@$&","P 63/m":" !#%?#@$#$%+!@+? +$%&!@&? & !-%?-@$-","P 6 2 2":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&","P 61 2 2":" !#%?Q@$^$%+!@`? a! X?%&$@_%$b@!- ?c","P 65 2 2":" !#%?^@$Q$%+!@a? `! _?%&$@X%$c@!- ?b","P 62 2 2":" !#%?^@$Q$%#!@^? Q! _?%&$@X%$_@!& ?X","P 64 2 2":" !#%?Q@$^$%#!@Q? ^! X?%&$@_%$X@!& ?_","P 63 2 2":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-","P 6 m m":" !#%?#@$#$%#!@#? #%$#@!# ?#! #?%#$@#","P 6 c c":" !#%?#@$#$%#!@#? #%$+@!+ ?+! +?%+$@+","P 63 c m":" !#%?#@$#$%+!@+? +%$+@!+ ?+! #?%#$@#","P 63 m c":" !#%?#@$#$%+!@+? +%$#@!# ?#! +?%+$@+","P -6 m 2":" !#%?#@$# !&%?&@$&%$#@!# ?#%$&@!& ?&","P -6 c 2":" !#%?#@$# !-%?-@$-%$+@!+ ?+%$&@!& ?&","P -6 2 m":" !#%?#@$# !&%?&@$&! &?%&$@&! #?%#$@#","P -6 2 c":" !#%?#@$# !-%?-@$-! &?%&$@&! +?%+$@+","P 6/m 2/m 2/m":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&$%&!@&? & !&@$&%?&%$#@!# ?#! #?%#$@#","P 6/m 2/c 2/c":" !#%?#@$#$%#!@#? #! -?%-$@-%$-@!- ?-$%&!@&? & !&@$&%?&%$+@!+ ?+! +?%+$@+","P 63/m 2/c 2/m":" !#%?#@$#$%+!@+? +! -?%-$@-%$&@!& ?&$%&!@&? & !-@$-%?-%$+@!+ ?+! #?%#$@#","P 63/m 2/m 2/c":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-$%&!@&? & !-@$-%?-%$#@!# ?#! +?%+$@+","P 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ","F 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%&  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ","I 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(","P 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(","I 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- ","P 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$","P 2/n -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& *,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","F 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-($,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- *,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$","F 2/d -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& 64=37=345675=64=375345674=67=3453756 )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(68>3:>3896:9=<8=;:5;85<:4><7>;49;79<(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(<4>;7>;49<79>68>3:93896:8=<:=;85;:5<()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- <8=;:=;8f<:f><4>;79;49<78>6:>3893:96","I 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","P 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*","I 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*()+$,#*g& %-+()#$,&*!- %)+(,#$!&*%- *,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$","P 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$","P 42 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","F 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$","F 41 3 2":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46 )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<(!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86","I 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","P 43 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7;>46=:<5839398<5:6=4;>75:<983>7;=46","P 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<","I 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46","P -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ","F -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&%  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(+%*+!*-%(- +)$+,$-) -,#)(#,*&)*&,((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() +,$+)$-, -(#)*#,*&)(&,+!(+%*-!*-%(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(#,*#)*&,(&(+!*+%*-!(-%+) +,$-)$-, ","I -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","P -4 3 n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","F -4 3 c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() #,$#)$&, &(#!*#%*&!(&%+! +%$-!$-% (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(#%*#!*&%(& +!$+%$-! -%#) #,$&)$&, ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! +%$+!$-% - #)$#,$&) &,#!(#%*&!*&%(","I -4 3 d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7354<9:6>8;=357<946>:;=857394<>:6=8;()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- :;98657<=43>;9:658<=73>49:;586=7<>43","P 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","P 4/n -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/m -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/n -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","F 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#!  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*%*+!(+%(-!*-$-) -, +)$+,&,(&)*#,*#)((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%**%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*,$+) +, -)$-*&)(&,(#)*#,-%(-!*+%*+!(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$*,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$,*#)(#,(&)*&*-!(-%(+!*+%-, -)$+,$+) ","F 4/m -3 2/c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() &,$&)$#, #(#%*#!*&%(&!+!$+% -! -%$$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*,$#) #, &)$&*&!(&%(#!*#%-% -!$+%$+! (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(&%*&!*#%(# +%$+!$-% -!#)$#, &) &,$*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*%*#!(#%(&!*&$-! -% +!$+%&, &)$#,$#) ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! -%$-!$+% + #,$#)$&, &)#!*#%(&!(&%**,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$%$+! +% -!$-$&) &, #)$#,&%(&!*#%*#!(","F 41/d -3 2/m":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=4664=3:>;85<79=64>3:5;89<74=6:>385;79<,$+! #%(-)*&*&)(-% #!$+,-%(&)*+,$#!  )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<68>37=;49<:5=<8>;753496:4><:=;893756,*#!(+% &)$-*-!(&, +)$#%-, &!$+%*#)((!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<<4>;:=389675>68=379;45<:8=<7>;453:96%$#) +,(&!*-$&! -,(#)*+%&% -)$#,*+!(()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86<8=;7>3456:9><4=;:9385678>67=349;:5<%*+)(#, -!$&$-) &%(+!*#,&,(-!*#%$+) ","F 41/d -3 2/c":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46<8>;7=3496:5><8=;793456:8><7=;493:56%*#)(+, &!$-$-! &,(+)*#%&, -!$#%*+)( )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<<4=;:>385679>64=3:9;85<78=67>345;:9<%$+) #,(-!*&$&) -%(#!*+,&%(-)*#,$+! (!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<68=37>;45<:9=<4>;:5389674>6:=389;75<,*+!(#% -)$&*-)(&% +!$#,-,(&!*+%$#) ()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>8664>3:=;89<75=68>375;49<:4=<:>;853796,$#! +%(&)*-*&!(-, #)$+%-% &)$+,*#!(","I 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","I 41/a -3 2/d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<$%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*4<97358;=:6>6>:;=8357<94=8;>:694<573()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46*,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$865:;943>7<=<=73>4;9:658>43=7<5869:;","P 1 1 2":" !#$%#","P 1 1 21":" !#$%+","B 1 1 2":" !#$%#(g+*%+","A 1 2 1":" !#$!& )+$)-","C 1 21 1":" !#$)&()#*!&","I 1 2 1":" !#$!&.'/0'2","I 1 21 1":" !#$)&.'/0!-","P 1 1 m":" !# !&","P 1 1 b":" !# )&","B 1 1 m":" !# !&(!+(!-","B 1 1 b":" !# )&(!+()-","P 1 1 2/m":" !# !&$%#$%&","P 1 1 21/m":" !#$%+$%& !-","B 1 1 2/m":" !# !&$%#$%&(!+(!-*%+*%-","P 1 1 2/b":" !#$,#$%& )&","P 1 1 21/b":" !#$%&$,+ )-","B 1 1 2/b":" !#$,#$%& )&(!+*,+*%-()-","P 21 2 2":" !#$!&(%&*%#","P 2 21 2":" !# ,&$)&$%#","P 21 21 2 (a)":" !#*,#.%&$'&","P 21 2 21":" !#$!&(%-*%+","P 2 21 21":" !# %&$)-$,+","C 2 2 21a)":" !#*%+(,&$)-()#$,+ %&*!-","C 2 2 2a":" !#*,#.%&$'&()#$%# ,&*!&","F 2 2 2a":" !#*,#.%&$'& '/*%/.12$!2.!/$,/ %20'2.'#$%# 1&0!&","I 2 2 2a":" !#*,#.%&$'&()+$%+*!- ,-","P 21/m 21/m 2/n a":" !#*,#$)&(%&$%&.'& ,#*!#","P 42 21 2a":" !#*,#%.+'$+$'&.%&! -,*-","I 2 3a":" !#*,#.%&$'&!# ,- '&$%/$# !-*!/$%&.%()+$%+ ,-*!-)+(%&(!-*,#*+()&$)#*,- ,"},Zm=/^[1-9]$/;function Km(e){let t="";return e.length>0&&(t=":"+za(e).join(" OR :")),new $c(t)}class Qm{constructor(e=""){this.name=e,this.partList=[]}get type(){return"Assembly"}addPart(e,t){const i=new Jm(e,t);return this.partList.push(i),i}getAtomCount(e){return this.partList.reduce(((t,i)=>t+i.getAtomCount(e)),0)}getResidueCount(e){return this.partList.reduce(((t,i)=>t+i.getResidueCount(e)),0)}getInstanceCount(){let e=0;return this.partList.forEach((function(t){e+=t.matrixList.length})),e}isIdentity(e){if(1!==this.partList.length)return!1;const t=this.partList[0];if(1!==t.matrixList.length)return!1;if(!(new ri).equals(t.matrixList[0]))return!1;let i=[];return e.eachChain((function(e){i.push(e.chainname)})),i=za(i),t.chainList.length===i.length}getBoundingBox(e){const t=new Ni;return this.partList.forEach((function(i){const n=i.getBoundingBox(e);t.expandByPoint(n.min),t.expandByPoint(n.max)})),t}getCenter(e){return this.getBoundingBox(e).getCenter(new Zt)}getSelection(){let e=[];return this.partList.forEach((function(t){e=e.concat(t.chainList)})),Km(e)}}class Jm{constructor(e=[],t=[]){this.matrixList=e,this.chainList=t}get type(){return"AssemblyPart"}_getCount(e,t){let i=0;return e.eachChain((e=>{(0===this.chainList.length||this.chainList.includes(e.chainname))&&(i+=e[t])})),this.matrixList.length*i}getAtomCount(e){return this._getCount(e,"atomCount")}getResidueCount(e){return this._getCount(e,"residueCount")}getBoundingBox(e){const t=new Ni,i=new Ni,n=this.getSelection(),r=e.getBoundingBox(n);return this.matrixList.forEach((function(e){i.copy(r).applyMatrix4(e),t.expandByPoint(i.min),t.expandByPoint(i.max)})),t}getSelection(){return Km(this.chainList)}getView(e){const t=this.getSelection();return t?e.getView(t):e}getInstanceList(){const e=[];for(let t=0,i=this.matrixList.length;t<i;++t)e.push({id:t+1,name:t,matrix:this.matrixList[t]});return e}}class ep{constructor(e){this.structure=e,this.currentModelindex=null,this.currentChainid=null,this.currentResname=null,this.currentResno=null,this.currentInscode=void 0,this.currentHetero=null,this.previousResname="",this.previousHetero=null,this.ai=-1,this.ri=-1,this.ci=-1,this.mi=-1}addResidueType(e){const t=this.structure.atomStore,i=this.structure.residueStore,n=this.structure.residueMap,r=i.atomCount[e],s=i.atomOffset[e],o=new Array(r);for(let e=0;e<r;++e)o[e]=t.atomTypeId[s+e];i.residueTypeId[e]=n.add(this.previousResname,o,this.previousHetero)}addAtom(e,t,i,n,r,s,o,a){const c=this.structure.atomStore,l=this.structure.residueStore,h=this.structure.chainStore,u=this.structure.modelStore;let d=!1,f=!1,m=!1;this.currentModelindex!==e?(d=!0,f=!0,m=!0,this.mi+=1,this.ci+=1,this.ri+=1):this.currentChainid!==i?(f=!0,m=!0,this.ci+=1,this.ri+=1):this.currentResno===r&&this.currentResname===n&&this.currentInscode===a||(m=!0,this.ri+=1),this.ai+=1,d&&(u.growIfFull(),u.chainOffset[this.mi]=this.ci,u.chainCount[this.mi]=0,u.count+=1,h.modelIndex[this.ci]=this.mi),f&&(h.growIfFull(),h.setChainname(this.ci,t),h.setChainid(this.ci,i),h.residueOffset[this.ci]=this.ri,h.residueCount[this.ci]=0,h.count+=1,h.modelIndex[this.ci]=this.mi,u.chainCount[this.mi]+=1,l.chainIndex[this.ri]=this.ci),m&&(this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,this.ri>0&&this.addResidueType(this.ri-1),l.growIfFull(),l.resno[this.ri]=r,void 0!==o&&(l.sstruc[this.ri]=o.charCodeAt(0)),void 0!==a&&(l.inscode[this.ri]=a.charCodeAt(0)),l.atomOffset[this.ri]=this.ai,l.atomCount[this.ri]=0,l.count+=1,l.chainIndex[this.ri]=this.ci,h.residueCount[this.ci]+=1),c.count+=1,c.residueIndex[this.ai]=this.ri,l.atomCount[this.ri]+=1,this.currentModelindex=e,this.currentChainid=i,this.currentResname=n,this.currentResno=r,this.currentInscode=a,this.currentHetero=s}finalize(){this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,this.ri>-1&&this.addResidueType(this.ri)}}function tp(t,i){if(!i)return;e.Debug&&il.time("assignSecondaryStructure");const n=[];t.eachModel((function(e){e.eachChain((function(e){n.push(e.chainname)}))}));const r=n.slice().sort(),s=[];r.forEach((function(e){s.push(n.indexOf(e))}));const o=i.helices.filter((function(e){return Na(r,e[0])>=0}));o.sort((function(e,t){const i=e[0],n=t[0],o=e[1],a=t[1];if(i===n)return o===a?0:o<a?-1:1;{const e=Na(r,i),t=Na(r,n);return s[e]<s[t]?-1:1}}));const a=t.residueStore;t.eachModel((function(e){let t=0;const i=o.length;if(0===i)return;let n=o[t],r=!1,s=!1;e.eachChain((function(e){let c=!1;if(e.chainname===n[0]){const l=e.residueCount,h=e.residueOffset,u=h+l;for(let l=h;l<u;++l)if(a.resno[l]===n[1]&&a.getInscode(l)===n[2]&&(r=!0),r&&(a.sstruc[l]=n[6],a.resno[l]===n[4]&&a.getInscode(l)===n[5]&&(r=!1,t+=1,t<i?(l=h-1,n=o[t],c=e.chainname!==n[0]):s=!0)),c||s)return}}))}));const c=i.sheets.filter((function(e){return Na(r,e[0])>=0}));c.sort((function(e,t){const i=e[0],n=t[0];if(i===n)return 0;const o=Na(r,i),a=Na(r,n);return s[o]<s[a]?-1:1}));const l="e".charCodeAt(0);t.eachModel((function(e){let t=0;const i=c.length;if(0===i)return;let n=c[t],r=!1,s=!1;e.eachChain((function(e){let o=!1;if(e.chainname===n[0]){const h=e.residueCount,u=e.residueOffset,d=u+h;for(let h=u;h<d;++h)if(a.resno[h]===n[1]&&a.getInscode(h)===n[2]&&(r=!0),r&&(a.sstruc[h]=l,a.resno[h]===n[4]&&a.getInscode(h)===n[5]&&(r=!1,t+=1,t<i?(h=u-1,n=c[t],o=e.chainname!==n[0]):s=!0)),o||s)return}}))})),e.Debug&&il.timeEnd("assignSecondaryStructure")}const ip=function(){const t=function(e,t,i,n){const r=e.structure,s=e.residueIndexStart,o=r.getResidueProxy(),a=r.getResidueProxy(),c=r.getAtomProxy(),l=r.getAtomProxy();for(let r=Math.max(0,t-2);r<=t;++r)for(let t=2;t<5;++t){if(r+t>=e.residueCount)continue;o.index=s+r,a.index=s+r+t,c.index=o.traceAtomIndex,l.index=a.traceAtomIndex;const h=c.distanceTo(l);if(Math.abs(h-i[t-2])>n)return!1}return!0},i=function(e,i){return t(e,i,[5.45,5.18,6.37],2.1)},n=function(e,i){return t(e,i,[6.1,10.4,13],1.42)};return function(t){e.Debug&&il.time("calculateSecondaryStructure"),t.eachPolymer((function(e){if(e.residueCount<4)return;if(e.isCg())!function(e){const t=e.residueStore,i=e.residueIndexStart,n=new Um(e).position,r=new Zt,s=new Zt;for(let o=0,a=e.residueCount;o<a;++o){r.fromArray(n.center,3*o),s.fromArray(n.center,3*o+3);const e=r.distanceTo(s);e<2&&e>1&&n.bending[o]<20&&(t.sstruc[i+o]="h".charCodeAt(0),t.sstruc[i+o+1]="h".charCodeAt(0))}}(e);else{if(!e.isProtein())return;!function(e){const t=e.residueStore,r=e.residueIndexStart;for(let s=0,o=e.residueCount;s<o;++s){let o="c";i(e,s)?o="h":n(e,s)&&(o="e"),t.sstruc[r+s]=o.charCodeAt(0)}}(e)}let t,r=0;e.eachResidue((function(e){e.sstruc===t?r+=1:(1===r&&(e.index-=1,e.sstruc="c"),r=1,t=e.sstruc)}))})),e.Debug&&il.timeEnd("calculateSecondaryStructure")}}(),np="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function rp(e){const t=np.length;let i=e,n=0,r=np[i%t];for(;i>=t;)i=Math.floor(i/t),r+=np[i%t],n+=1;return n>=5&&il.warn("chainname overflow"),r}function sp(t,i=!1){e.Debug&&il.time("calculateChainnames");let n=!0;if(t.eachChain((function(e){e.chainname&&(n=!1)})),n){const e=t.modelStore,n=t.chainStore,r=t.residueStore,s=function(t,i,s,o){const a=n.count;for(let e=0;e<o;++e)r.chainIndex[s+e]=a;n.growIfFull(),n.modelIndex[a]=t,n.setChainname(a,i),n.setChainid(a,i),n.residueOffset[a]=s,n.residueCount[a]=o,n.count+=1,e.chainCount[t]+=1},o=t.getAtomProxy(),a=t.getAtomProxy();let c=0,l=0,h=0,u=0;const d=[];1===r.count?d.push({mIndex:0,chainname:"A",rStart:0,rCount:1}):t.eachResidueN(2,(function(e,t){let n=!1;const s=e.backboneType,f=t.backboneType,m=ed;u=e.index,e.modelIndex!==t.modelIndex||e.moleculeType!==t.moleculeType?n=!0:s!==m&&s===f&&(o.index=e.backboneEndAtomIndex,a.index=t.backboneStartAtomIndex,n=i?!o.hasBondTo(a):!o.connectedTo(a)),n||t.index!==r.count-1||(n=!0,u=t.index),n&&(d.push({mIndex:l,chainname:rp(c),rStart:h,rCount:u-h+1}),c+=1,e.modelIndex!==t.modelIndex&&(c=0,l+=1),t.index===r.count-1&&u!==t.index&&d.push({mIndex:l,chainname:rp(c),rStart:r.count-1,rCount:1}),h=t.index,u=t.index)})),n.count=0,e.chainCount.fill(0,0,e.count),e.chainOffset.fill(0,0,e.count),d.forEach((function(e){s(e.mIndex,e.chainname,e.rStart,e.rCount)}));let f=0;t.eachModel((function(t){e.chainOffset[t.index]=f,f+=e.chainCount[t.index]}))}e.Debug&&il.timeEnd("calculateChainnames")}function op(t,i="all"){"none"!==i&&(e.Debug&&il.time("calculateBonds"),lp(t,!1,i),hp(t),e.Debug&&il.timeEnd("calculateBonds"))}const ap={"HIS|CD2|CG":2,"HIS|CE1|ND1":2,"ARG|CZ|NH2":2,"PHE|CE1|CZ":2,"PHE|CD2|CE2":2,"PHE|CD1|CG":2,"TRP|CD1|CG":2,"TRP|CD2|CE2":2,"TRP|CE3|CZ3":2,"TRP|CH2|CZ2":2,"ASN|CG|OD1":2,"GLN|CD|OE1":2,"TYR|CD1|CG":2,"TYR|CD2|CE2":2,"TYR|CE1|CZ":2,"ASP|CG|OD1":2,"GLU|CD|OE1":2,"G|C8|N7":2,"G|C4|C5":2,"G|C2|N3":2,"G|C6|O6":2,"C|C4|N3":2,"C|C5|C6":2,"C|C2|O2":2,"A|C2|N3":2,"A|C6|N1":2,"A|C4|C5":2,"A|C8|N7":2,"U|C5|C6":2,"U|C2|O2":2,"U|C4|O4":2,"DG|C8|N7":2,"DG|C4|C5":2,"DG|C2|N3":2,"DG|C6|O6":2,"DC|C4|N3":2,"DC|C5|C6":2,"DC|C2|O2":2,"DA|C2|N3":2,"DA|C6|N1":2,"DA|C4|C5":2,"DA|C8|N7":2,"DT|C5|C6":2,"DT|C2|O2":2,"DT|C4|O4":2};function cp(e,t,i){return[t,i]=t<i?[t,i]:[i,t],vd.includes(e)&&"C"===t&&"O"===i||_d.includes(e)&&"OP1"===t&&"P"===i?2:ap[`${e}|${t}|${i}`]||1}function lp(t,i=!1,n="all"){e.Debug&&il.time("calculateBondsWithin");const r=t.bondStore,s=t.rungBondStore,o=t.getAtomSet(!1),a=t.getAtomProxy(),c=t.getAtomProxy(),l=t.getBondProxy(),h=i?null:function(t){e.Debug&&il.time("calculateAtomBondMap");var i=[];return t.eachBond((function(e){var t=e.atomIndex1,n=e.atomIndex2;void 0===i[t]&&(i[t]=[]),i[t][n]=e.index})),e.Debug&&il.timeEnd("calculateAtomBondMap"),i}(t);let u;i||"auto"!==n||(u=new Set,h.forEach(((e,t)=>{u.add(t),e.forEach((e=>{u.add(e)}))}))),t.eachResidue((function(e){if(!i&&h){const t=e.atomCount,i=e.atomOffset;if(t>500)return void il.warn("more than 500 atoms, skip residue for auto-bonding",e.qualifiedName());if("auto"===n&&e.hetero)for(let t=e.atomOffset;t<e.atomEnd;t++)if(u.has(t))return;const s=e.getBonds(),o=s.atomIndices1,d=s.atomIndices2,f=s.bondOrders,m=o.length;for(let t=0;t<m;++t){const n=o[t],s=d[t],u=n+i,m=s+i,p=h[u];if(void 0!==p&&void 0!==p[m]){l.index=p[m];f[e.residueType.getBondIndex(n,s)]=l.bondOrder}else a.index=u,c.index=m,r.addBond(a,c,f[t])}}const t=e.residueType.traceAtomIndex,d=e.residueType.rungEndAtomIndex;-1!==t&&-1!==d&&(a.index=e.traceAtomIndex,c.index=e.rungEndAtomIndex,s.addBond(a,c),o.set(a.index),o.set(c.index))})),t.atomSetDict.rung=o,e.Debug&&il.timeEnd("calculateBondsWithin")}function hp(t,i=!1,n=!1){e.Debug&&il.time("calculateBondsBetween");const r=t.bondStore,s=t.backboneBondStore,o=t.getAtomSet(!1),a=t.getAtomProxy(),c=t.getAtomProxy();function l(e,t){const l=e.backboneType,h=t.backboneType;if(l!==ed&&l===h){a.index=e.backboneEndAtomIndex,c.index=t.backboneStartAtomIndex;let l=!1,h=!1;n&&a.hasBondTo(c)?(l=!1,h=!0):a.connectedTo(c)&&(l=!i,h=!0),l&&r.addBond(a,c,1),h&&(a.index=e.traceAtomIndex,c.index=t.traceAtomIndex,s.addBond(a,c),o.set(a.index),o.set(c.index))}}0===s.count&&s.resize(t.residueStore.count),t.eachResidueN(2,l);const h=t.getResidueProxy(),u=t.getResidueProxy();if(t.eachChain((function(e){0!==e.residueCount&&(h.index=e.residueOffset,u.index=e.residueOffset+e.residueCount-1,l(u,h))})),t.atomSetDict.backbone=o,!i){e.Debug&&il.time("calculateBondsBetween inter");const i=t.spatialHash;t.eachResidue((function(e){e.backboneType!==ed||e.isWater()||e.eachAtom((function(e){e.isMetal()||i.eachWithin(e.x,e.y,e.z,4,(function(t){c.index=t,e.modelIndex!==c.modelIndex||e.residueIndex===c.residueIndex||c.isMetal()||r.addBondIfConnected(e,c,1)}))}))})),e.Debug&&il.timeEnd("calculateBondsBetween inter")}e.Debug&&il.timeEnd("calculateBondsBetween")}function up(t){if(!t.unitcell)return;e.Debug&&il.time("buildUnitcellAssembly");const i=t.unitcell,n=t.center.clone().applyMatrix4(i.cartToFrac),r=n.clone().floor(),s=function(e){const t=Ym[e],i={};if(void 0===t)return console.warn(`spacegroup '${e}' not found in symop library`),i;const n=[];for(let e=0,i=t.length;e<i;e+=3){const i=[];for(let n=0;n<3;++n)i.push(Xm[t[e+n]]);n.push(i)}return n.forEach((function(e){let t=0;const n=(new ri).set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1),r=n.elements;i[e.toString()]=n,e.forEach((function(e){let i=!1,n=!1;for(let s=0,o=e.length;s<o;++s){const o=e[s];if("-"===o)i=!0;else if("+"===o)i=!1;else if("/"===o)n=!0;else if("X"===o)r[0+t]=i?-1:1;else if("Y"===o)r[4+t]=i?-1:1;else if("Z"===o)r[8+t]=i?-1:1;else if(Zm.test(o)){const e=parseInt(o);n?r[12+t]/=e:r[12+t]=e}else il.warn(`getSymmetryOperations: unknown token '${o}'`)}t+=1}))})),i}(i.spacegroup),o=new Zt,a=new Zt;function c(e){const t=[];return Object.keys(s).forEach((function(c){const l=s[c].clone();o.copy(n).applyMatrix4(l).floor(),a.setFromMatrixPosition(l),a.sub(o),a.add(r),e&&a.add(e),l.setPosition(a),l.multiplyMatrices(i.fracToCart,l),l.multiply(i.cartToFrac),t.push(l)})),t}const l=new Qm("UNITCELL"),h=c(),u=[];if(t.biomolDict.NCS){u.push(new ri,...t.biomolDict.NCS.partList[0].matrixList);const e=[];h.forEach((t=>{u.forEach((i=>{e.push(t.clone().multiply(i))}))})),l.addPart(e)}else l.addPart(h);const d=new Zt,f=new Qm("SUPERCELL"),m=Array.prototype.concat.call(c(d.set(1,0,0)),c(d.set(0,1,0)),c(d.set(0,0,1)),c(d.set(-1,0,0)),c(d.set(0,-1,0)),c(d.set(0,0,-1)),c(d.set(1,1,0)),c(d.set(1,0,1)),c(d.set(0,1,1)),c(d.set(-1,-1,0)),c(d.set(-1,0,-1)),c(d.set(0,-1,-1)),c(d.set(1,-1,-1)),c(d.set(1,1,-1)),c(d.set(1,-1,1)),c(d.set(-1,1,1)),c(d.set(-1,-1,1)),c(d.set(-1,1,-1)),c(d.set(0,1,-1)),c(d.set(0,-1,1)),c(d.set(1,0,-1)),c(d.set(-1,0,1)),c(d.set(1,-1,0)),c(d.set(-1,1,0)),c(),c(d.set(1,1,1)),c(d.set(-1,-1,-1)));if(t.biomolDict.NCS){const e=[];m.forEach((function(t){u.forEach((function(i){e.push(t.clone().multiply(i))}))})),f.addPart(e)}else f.addPart(m);t.biomolDict.UNITCELL=l,t.biomolDict.SUPERCELL=f,e.Debug&&il.timeEnd("buildUnitcellAssembly")}const dp=["H","C","O","N","S","P"],fp=["NA","CL","FE"];function mp(e){let t=e.toUpperCase(),i=0,n=0;for(let e=0;e<t.length;e++)if(t.charCodeAt(e)<65){if(n>0)break;++i}else n=e+1;(i>0||n<t.length)&&(t=t.substring(i,n));const r=t.length;if(0===r)return"";if(1===r)return t;if(2===r){if(-1!==fp.indexOf(t))return t;if(-1!==dp.indexOf(t[0]))return t[0];if(t in ld)return t}return r>=3&&-1!==dp.indexOf(t[0])?t[0]:""}function pp(e){const t=e.bondHash,i=t.countArray,n=t.offsetArray,r=t.indexArray,s=e.getBondProxy();e.eachResidue((function(e){const t=e.residueType;if(void 0!==t.bonds)return;var o=e.atomOffset,a=[],c=[],l=[],h={};const u=o+e.atomCount;e.eachAtom((function(e){const t=e.index,d=n[t];for(let e=0,n=i[t];e<n;++e){s.index=r[d+e];let t=s.atomIndex1;if(t<o||t>=u)continue;let i=s.atomIndex2;if(i<o||i>=u)continue;if(t>i){const e=i;i=t,t=e}const n=t+"|"+i;void 0===h[n]&&(h[n]=!0,a.push(t-o),c.push(i-o),l.push(s.bondOrder))}})),t.bonds={atomIndices1:a,atomIndices2:c,bondOrders:l}}))}const gp=[3,11,19,37,55,87],vp=[4,12,20,38,56,88],yp=[6,15,16,34],xp=[1,7,8,9,17,35,53],bp=[2,10,18,36,54,86],_p=[13,30,31,48,49,50,80,81,82,83,84,85,112],wp=[5,14,32,33,51,52,85],Sp=[9,17,35,53,85];class Ap{constructor(e,t,i){this.structure=e,this.atomname=t,i=i||mp(t),this.element=i,this.number=ld[i]||0,this.vdw=hd[this.number]||2,this.covalent=ud[this.number]||1.6}getDefaultValence(){const e=dd[this.number];return e?e[0]:-1}getValenceList(){return dd[this.number]||[]}getOuterShellElectronCount(){return fd[this.number]||2}isMetal(){return this.isAlkaliMetal()||this.isAlkalineEarthMetal()||this.isLanthanide()||this.isActinide()||this.isTransitionMetal()||this.isPostTransitionMetal()}isNonmetal(){return this.isDiatomicNonmetal()||this.isPolyatomicNonmetal()||this.isNobleGas()}isMetalloid(){return wp.includes(this.number)}isHalogen(){return Sp.includes(this.number)}isDiatomicNonmetal(){return xp.includes(this.number)}isPolyatomicNonmetal(){return yp.includes(this.number)}isAlkaliMetal(){return gp.includes(this.number)}isAlkalineEarthMetal(){return vp.includes(this.number)}isNobleGas(){return bp.includes(this.number)}isTransitionMetal(){const e=this.number;return e>=21&&e<=29||e>=39&&e<=47||e>=72&&e<=79||e>=104&&e<=108}isPostTransitionMetal(){return _p.includes(this.number)}isLanthanide(){return this.number>=57&&this.number<=71}isActinide(){return this.number>=89&&this.number<=103}}class Mp{constructor(e){this.structure=e,this.dict={},this.list=[],this.structure=e}add(e,t){const i=function(e,t){return e+"|"+t}(e=e.toUpperCase(),t=t?t.toUpperCase():mp(e));let n=this.dict[i];if(void 0===n){const r=new Ap(this.structure,e,t);n=this.list.length,this.dict[i]=n,this.list.push(r)}return n}get(e){return this.list[e]}}class Cp{constructor(e,t,i,n,r,s){this.structure=e,this.bondReferenceAtomIndices=[],this.resname=t,this.atomTypeIdList=i,this.hetero=n?1:0,this.chemCompType=r,this.bonds=s,this.atomCount=i.length,this.moleculeType=this.getMoleculeType(),this.backboneType=this.getBackboneType(0),this.backboneEndType=this.getBackboneType(-1),this.backboneStartType=this.getBackboneType(1),this.backboneIndexList=this.getBackboneIndexList();const o=Pd[this.backboneType],a=Pd[this.backboneStartType],c=Pd[this.backboneEndType],l=this.getAtomIndexByName(o.trace);this.traceAtomIndex=Ia(l,-1);const h=this.getAtomIndexByName(o.direction1);this.direction1AtomIndex=Ia(h,-1);const u=this.getAtomIndexByName(o.direction2);this.direction2AtomIndex=Ia(u,-1);const d=this.getAtomIndexByName(a.backboneStart);this.backboneStartAtomIndex=Ia(d,-1);const f=this.getAtomIndexByName(c.backboneEnd);let m;this.backboneEndAtomIndex=Ia(f,-1),m=bd.includes(t)?this.getAtomIndexByName("N1"):this.getAtomIndexByName("N3"),this.rungEndAtomIndex=Ia(m,-1)}getBackboneIndexList(){const e=[];let t;switch(this.moleculeType){case 3:t=Md;break;case 4:case 5:t=Cd;break;default:return e}const i=this.structure.atomMap,n=this.atomTypeIdList;for(let r=0,s=this.atomCount;r<s;++r){const s=i.get(n[r]);t.includes(s.atomname)&&e.push(r)}return e}getMoleculeType(){return this.isProtein()?3:this.isRna()?4:this.isDna()?5:this.isWater()?1:this.isIon()?2:this.isSaccharide()?6:0}getBackboneType(e){return this.hasProteinBackbone(e)?1:this.hasRnaBackbone(e)?2:this.hasDnaBackbone(e)?3:this.hasCgProteinBackbone(e)?4:this.hasCgRnaBackbone(e)?5:this.hasCgDnaBackbone(e)?6:ed}isProtein(){return this.chemCompType?td.includes(this.chemCompType):this.hasAtomWithName("CA","C","N")||vd.includes(this.resname)}isCg(){const e=this.backboneType;return 4===e||5===e||6===e}isNucleic(){return this.isRna()||this.isDna()}isRna(){return this.chemCompType?id.includes(this.chemCompType):1!==this.hetero&&(this.hasAtomWithName(["P","O3'","O3*"],["C4'","C4*"],["O2'","O2*","F2'","F2*"])||yd.includes(this.resname)&&this.hasAtomWithName(["O2'","O2*","F2'","F2*"]))}isDna(){return this.chemCompType?nd.includes(this.chemCompType):1!==this.hetero&&(this.hasAtomWithName(["P","O3'","O3*"],["C3'","C3*"])&&!this.hasAtomWithName(["O2'","O2*","F2'","F2*"])||xd.includes(this.resname))}isHetero(){return 1===this.hetero}isIon(){return Sd.includes(this.resname)}isWater(){return wd.includes(this.resname)}isSaccharide(){return this.chemCompType?rd.includes(this.chemCompType):Ad.includes(this.resname)}isStandardAminoacid(){return vd.includes(this.resname)}isStandardBase(){return _d.includes(this.resname)}hasBackboneAtoms(e,t){const i=Pd[t];return-1===e?this.hasAtomWithName(i.trace,i.backboneEnd,i.direction1,i.direction2):0===e?this.hasAtomWithName(i.trace,i.direction1,i.direction2):1===e?this.hasAtomWithName(i.trace,i.backboneStart,i.direction1,i.direction2):this.hasAtomWithName(i.trace,i.backboneStart,i.backboneEnd,i.direction1,i.direction2)}hasProteinBackbone(e){return this.isProtein()&&this.hasBackboneAtoms(e,1)}hasRnaBackbone(e){return this.isRna()&&this.hasBackboneAtoms(e,2)}hasDnaBackbone(e){return this.isDna()&&this.hasBackboneAtoms(e,3)}hasCgProteinBackbone(e){return this.atomCount<7&&this.isProtein()&&this.hasBackboneAtoms(e,4)}hasCgRnaBackbone(e){return this.atomCount<11&&this.isRna()&&this.hasBackboneAtoms(e,5)}hasCgDnaBackbone(e){return this.atomCount<11&&this.isDna()&&this.hasBackboneAtoms(e,6)}hasBackbone(e){return this.hasProteinBackbone(e)||this.hasRnaBackbone(e)||this.hasDnaBackbone(e)||this.hasCgProteinBackbone(e)||this.hasCgRnaBackbone(e)||this.hasCgDnaBackbone(e)}getAtomIndexByName(e){const t=this.atomCount,i=this.structure.atomMap,n=this.atomTypeIdList;if(Array.isArray(e))for(let r=0;r<t;++r){const t=n[r];if(e.includes(i.get(t).atomname))return r}else for(let r=0;r<t;++r){const t=n[r];if(e===i.get(t).atomname)return r}}hasAtomWithName(...e){const t=e.length;for(let i=0;i<t;++i)if(void 0!==e[i]&&void 0===this.getAtomIndexByName(e[i]))return!1;return!0}getBonds(t){return void 0===this.bonds&&(this.bonds=function(t){const i=t.structure,n=i.getAtomProxy(),r=i.getAtomProxy(),s=t.atomCount,o=t.atomOffset,a=o+s-1,c=[],l=[],h=[];if(s>500)e.Debug&&il.warn("more than 500 atoms, skip residue for auto-bonding",t.qualifiedName());else if(s>50){const e=new qm(t,!0),i=t.isCg()?1.2:2.3;for(let t=o;t<a;++t){n.index=t;const s=n.covalent+i+.3,a=e.nearest(n,1/0,s*s),u=a.length;for(let e=0;e<u;++e)r.index=a[e].index,n.index<r.index&&n.connectedTo(r)&&(c.push(n.index-o),l.push(r.index-o),h.push(cp(n.resname,n.atomname,r.atomname)))}}else for(let e=o;e<a;++e){n.index=e;for(let t=e+1;t<=a;++t)r.index=t,n.connectedTo(r)&&(c.push(e-o),l.push(t-o),h.push(cp(n.resname,n.atomname,r.atomname)))}return{atomIndices1:c,atomIndices2:l,bondOrders:h}}(t)),this.bonds}getRings(){return void 0===this.rings&&this.calculateRings(),this.rings}getBondGraph(){return void 0===this.bondGraph&&this.calculateBondGraph(),this.bondGraph}getAromatic(e){return void 0===this.aromaticAtoms&&this.calculateAromatic(this.structure.getResidueProxy(e.residueIndex)),this.aromaticAtoms}getAromaticRings(e){return void 0===this.aromaticRings&&this.calculateAromatic(e),this.aromaticRings}calculateBondGraph(){const e=this.bondGraph={},t=this.getBonds(),i=t.atomIndices1.length,n=t.atomIndices1,r=t.atomIndices2;for(let t=0;t<i;++t){const i=n[t],s=r[t];(e[i]=e[i]||[]).push(s);(e[s]=e[s]||[]).push(i)}}calculateRings(){const e=function(e,t){const i={count:t,visited:new Int32Array(t),queue:new Int32Array(t),pred:new Int32Array(t),left:new Int32Array(Dp),right:new Int32Array(Dp),color:new Int32Array(t),currentColor:0,rings:[],atomRings:[],bonds:e};for(let e=0;e<t;e++)i.visited[e]=-1,i.pred[e]=-1;return i}(this.getBondGraph(),this.atomCount);for(let t=0;t<e.count;t++)e.visited[t]>=0||Ep(e,t);this.rings={atomRings:e.atomRings,rings:e.rings}}isAromatic(e){return this.aromaticAtoms=this.getAromatic(e),1===this.aromaticAtoms[e.index-e.residueAtomOffset]}calculateAromatic(e){const t=this.aromaticAtoms=new Uint8Array(this.atomCount),i=this.getRings().rings,n=i.map((t=>function(e){if(e.some((e=>!Pp.includes(e.number))))return!1;let t=0;const i=new Mf(3,e.length),n=i.data;e.forEach((e=>{n[t+0]=e.x,n[t+1]=e.y,n[t+2]=e.z,t+=3}));return new Dm(i).vecC.length()<Tp}(t.map((t=>this.structure.getAtomProxy(t+e.atomOffset)))))),r=this.aromaticRings=[];i.forEach(((e,i)=>{n[i]&&(r.push(e),e.forEach((e=>t[e]=1)))}))}assignBondReferenceAtomIndices(){const e=this.getBondGraph(),t=this.getRings(),i=t.atomRings,n=t.rings,r=this.bonds,s=r.atomIndices1,o=r.atomIndices2,a=r.bondOrders,c=this.bondReferenceAtomIndices,l=r.atomIndices1.length;c.length=0;for(let t=0;t<l;++t){if(a[t]<=1)continue;let r;const l=s[t],h=o[t],u=i[l],d=i[h];if(u&&d)for(let e=0;e<u.length;e++)if(-1!==d.indexOf(u[e])){r=n[u[e]];break}if(e[l].length>1)for(let i=0;i<e[l].length;++i){const n=e[l][i];if(n!==h&&(void 0===r||-1!==r.indexOf(n))){c[t]=n;break}}else if(e[h].length>1)for(let i=0;i<e[h].length;++i){const n=e[h][i];if(n!==l&&(void 0===r||-1!==r.indexOf(n))){c[t]=n;break}}}}getBondIndex(e,t){const i=this.bonds,n=i.atomIndices1,r=i.atomIndices2;let s=n.indexOf(e),o=r.indexOf(t);const a=o;for(;-1!==s;){for(;-1!==o;){if(s===o)return s;o=r.indexOf(t,o+1)}s=n.indexOf(e,s+1),o=a}}getBondReferenceAtomIndex(e,t){const i=this.getBondIndex(e,t);if(void 0!==i)return 0===this.bondReferenceAtomIndices.length&&this.assignBondReferenceAtomIndices(),this.bondReferenceAtomIndices[i]}}const Pp=[5,6,7,8,14,15,16,32,33,50,51,83],Tp=.05;function Ip(e,t,i){if(i<t)return;const{pred:n,color:r,left:s,right:o}=e,a=++e.currentColor;let c=t;for(let e=0;e<Dp&&(r[c]=a,c=n[c],!(c<0));e++);let l=0,h=0,u=!1,d=0;c=i;for(let e=0;e<Dp;e++){if(r[c]===a){d=c,u=!0;break}if(o[h++]=c,c=n[c],c<0)break}if(!u)return;c=t;for(let e=0;e<Dp&&(s[l++]=c,d!==c)&&(c=n[c],!(c<0));e++);const f=l+h,m=new Array(f);let p=0;for(let e=0;e<l;e++)m[p++]=s[e];for(let e=h-1;e>=0;e--)m[p++]=o[e];const g=e.rings.length;for(let t=0;t<f;++t){const i=m[t];e.atomRings[i]?e.atomRings[i].push(g):e.atomRings[i]=[g]}e.rings.push(m)}function Ep(e,t){const{bonds:i,visited:n,queue:r,pred:s}=e;n[t]=1,r[0]=t;let o=0,a=1;for(;o<a;){const t=r[o++],c=0;if(void 0===i[t])continue;const l=i[t].length;for(let o=c;o<l;o++){const c=i[t][o];n[c]>0?s[c]!==t&&s[t]!==c&&Ip(e,t,c):(n[c]=1,r[a++]=c,s[c]=t)}}}const Dp=4;class Lp{constructor(e){this.structure=e,this.dict={},this.list=[]}add(e,t,i,n="",r){const s=function(e,t,i,n=""){return e+"|"+t.join(",")+"|"+(i?1:0)+"|"+n}(e=e.toUpperCase(),t,i,n);let o=this.dict[s];if(void 0===o){const a=new Cp(this.structure,e,t,i,n,r);o=this.list.length,this.dict[s]=o,this.list.push(a)}return o}get(e){return this.list[e]}}class Rp{constructor(e,t=0){this.structure=e,this.index=t,this.bondStore=e.bondStore,this._v12=new Zt,this._v13=new Zt,this._ap1=this.structure.getAtomProxy(),this._ap2=this.structure.getAtomProxy(),this._ap3=this.structure.getAtomProxy()}get atom1(){return this.structure.getAtomProxy(this.atomIndex1)}get atom2(){return this.structure.getAtomProxy(this.atomIndex2)}get atomIndex1(){return this.bondStore.atomIndex1[this.index]}set atomIndex1(e){this.bondStore.atomIndex1[this.index]=e}get atomIndex2(){return this.bondStore.atomIndex2[this.index]}set atomIndex2(e){this.bondStore.atomIndex2[this.index]=e}get bondOrder(){return this.bondStore.bondOrder[this.index]}set bondOrder(e){this.bondStore.bondOrder[this.index]=e}getOtherAtomIndex(e){return e===this.atomIndex1?this.atomIndex2:this.atomIndex1}getOtherAtom(e){return this.structure.getAtomProxy(this.getOtherAtomIndex(e.index))}getReferenceAtomIndex(){const e=this._ap1,t=this._ap2;if(e.index=this.atomIndex1,t.index=this.atomIndex2,e.residueIndex!==t.residueIndex)return;const i=e.index-e.residueAtomOffset,n=t.index-t.residueAtomOffset,r=e.residueType.getBondReferenceAtomIndex(i,n);if(void 0!==r)return r+e.residueAtomOffset;console.warn("No reference atom found",e.index,t.index)}calculateShiftDir(e=new Zt){const t=this._ap1,i=this._ap2,n=this._ap3,r=this._v12,s=this._v13;t.index=this.atomIndex1,i.index=this.atomIndex2;const o=this.getReferenceAtomIndex();r.subVectors(t,i).normalize(),void 0!==o?(n.index=o,s.subVectors(t,n)):s.copy(t),s.normalize();let a=r.dot(s);return 1-Math.abs(a)<1e-5&&(s.set(1,0,0),a=r.dot(s),1-Math.abs(a)<1e-5&&(s.set(0,1,0),a=r.dot(s))),e.copy(s.sub(r.multiplyScalar(a))).normalize()}qualifiedName(){return this.atomIndex1+"="+this.atomIndex2}clone(){return new Rp(this.structure,this.index)}toObject(){return{atomIndex1:this.atomIndex1,atomIndex2:this.atomIndex2,bondOrder:this.bondOrder}}}class kp{constructor(e,t=0){this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueMap=e.residueMap,this.atomMap=e.atomMap}get entity(){return this.structure.entityList[this.entityIndex]}get entityIndex(){return this.chainStore.entityIndex[this.chainIndex]}get chain(){return this.structure.getChainProxy(this.chainIndex)}get chainIndex(){return this.residueStore.chainIndex[this.index]}set chainIndex(e){this.residueStore.chainIndex[this.index]=e}get atomOffset(){return this.residueStore.atomOffset[this.index]}set atomOffset(e){this.residueStore.atomOffset[this.index]=e}get atomCount(){return this.residueStore.atomCount[this.index]}set atomCount(e){this.residueStore.atomCount[this.index]=e}get atomEnd(){return this.atomOffset+this.atomCount-1}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}get chainid(){return this.chainStore.getChainid(this.chainIndex)}get resno(){return this.residueStore.resno[this.index]}set resno(e){this.residueStore.resno[this.index]=e}get sstruc(){return this.residueStore.getSstruc(this.index)}set sstruc(e){this.residueStore.setSstruc(this.index,e)}get inscode(){return this.residueStore.getInscode(this.index)}set inscode(e){this.residueStore.setInscode(this.index,e)}get residueType(){return this.residueMap.get(this.residueStore.residueTypeId[this.index])}get resname(){return this.residueType.resname}get hetero(){return this.residueType.hetero}get moleculeType(){return this.residueType.moleculeType}get backboneType(){return this.residueType.backboneType}get backboneStartType(){return this.residueType.backboneStartType}get backboneEndType(){return this.residueType.backboneEndType}get traceAtomIndex(){return this.residueType.traceAtomIndex+this.atomOffset}get direction1AtomIndex(){return this.residueType.direction1AtomIndex+this.atomOffset}get direction2AtomIndex(){return this.residueType.direction2AtomIndex+this.atomOffset}get backboneStartAtomIndex(){return this.residueType.backboneStartAtomIndex+this.atomOffset}get backboneEndAtomIndex(){return this.residueType.backboneEndAtomIndex+this.atomOffset}get rungEndAtomIndex(){return this.residueType.rungEndAtomIndex+this.atomOffset}get x(){let e=0;for(let t=this.atomOffset;t<=this.atomEnd;++t)e+=this.atomStore.x[t];return e/this.atomCount}get y(){let e=0;for(let t=this.atomOffset;t<=this.atomEnd;++t)e+=this.atomStore.y[t];return e/this.atomCount}get z(){let e=0;for(let t=this.atomOffset;t<=this.atomEnd;++t)e+=this.atomStore.z[t];return e/this.atomCount}eachAtom(e,t){const i=this.atomCount,n=this.atomOffset,r=this.structure._ap,s=n+i;if(t&&t.atomOnlyTest){const i=t.atomOnlyTest;for(let t=n;t<s;++t)r.index=t,i(r)&&e(r)}else for(let t=n;t<s;++t)r.index=t,e(r)}positionToArray(e=[],t=0){return e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}isProtein(){return 3===this.residueType.moleculeType}isNucleic(){const e=this.residueType.moleculeType;return 4===e||5===e}isRna(){return 4===this.residueType.moleculeType}isDna(){return 5===this.residueType.moleculeType}isCg(){const e=this.residueType.backboneType;return 4===e||5===e||6===e}isPolymer(){if(this.structure.entityList.length>0)return this.entity.isPolymer();{const e=this.residueType.moleculeType;return 3===e||4===e||5===e}}isHetero(){return 1===this.residueType.hetero}isWater(){return 1===this.residueType.moleculeType}isIon(){return 2===this.residueType.moleculeType}isSaccharide(){return 6===this.residueType.moleculeType}isStandardAminoacid(){return this.residueType.isStandardAminoacid()}isStandardBase(){return this.residueType.isStandardBase()}isHelix(){return od.includes(this.sstruc)}isSheet(){return ad.includes(this.sstruc)}isTurn(){return cd.includes(this.sstruc)&&this.isProtein()}getAtomType(e){return this.atomMap.get(this.atomStore.atomTypeId[e])}getResname1(){return gd[this.resname.toUpperCase()]||"X"}getBackboneType(e){switch(e){case-1:return this.residueType.backboneStartType;case 1:return this.residueType.backboneEndType;default:return this.residueType.backboneType}}getAtomIndexByName(e){let t=this.residueType.getAtomIndexByName(e);return void 0!==t&&(t+=this.atomOffset),t}hasAtomWithName(e){return this.residueType.hasAtomWithName(e)}getAtomnameList(){console.warn("getAtomnameList - might be expensive");const e=this.atomCount,t=this.atomOffset,i=new Array(e);for(let n=0;n<e;++n)i[n]=this.getAtomType(t+n).atomname;return i}connectedTo(e){const t=this.structure.getAtomProxy(this.backboneEndAtomIndex),i=this.structure.getAtomProxy(e.backboneStartAtomIndex);return!(!t||!i)&&t.connectedTo(i)}getNextConnectedResidue(){const e=this.chainStore.residueOffset[this.chainIndex],t=this.chainStore.residueCount[this.chainIndex],i=this.index+1;if(i<e+t){const e=this.structure.getResidueProxy(i);if(this.connectedTo(e))return e}else if(i===e+t){const t=this.structure.getResidueProxy(e);if(this.connectedTo(t))return t}}getPreviousConnectedResidue(e){const t=this.chainStore.residueOffset[this.chainIndex],i=this.index-1;if(i>=t){const t=Ia(e,this.structure.getResidueProxy());if(t.index=i,t.connectedTo(this))return t}else if(i===t-1){const i=this.chainStore.residueCount[this.chainIndex],n=Ia(e,this.structure.getResidueProxy());if(n.index=t+i-1,n.connectedTo(this))return n}}getBonds(){return this.residueType.getBonds(this)}getRings(){return this.residueType.getRings()}getAromaticRings(){return this.residueType.getAromaticRings(this)}qualifiedName(e=!1){let t="";return this.resname&&!e&&(t+="["+this.resname+"]"),void 0!==this.resno&&(t+=this.resno),this.inscode&&(t+="^"+this.inscode),this.chain&&(t+=":"+this.chainname),t+="/"+this.modelIndex,t}clone(){return new kp(this.structure,this.index)}toObject(){return{index:this.index,chainIndex:this.chainIndex,atomOffset:this.atomOffset,atomCount:this.atomCount,resno:this.resno,resname:this.resname,sstruc:this.sstruc}}}class Op{constructor(e,t,i){this.structure=e,this.residueIndexStart=t,this.residueIndexEnd=i,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueCount=i-t+1;const n=this.structure.getResidueProxy(this.residueIndexStart),r=this.structure.getResidueProxy(this.residueIndexEnd);this.isPrevConnected=void 0!==n.getPreviousConnectedResidue();const s=r.getNextConnectedResidue();this.isNextConnected=void 0!==s,this.isNextNextConnected=void 0!==s&&void 0!==s.getNextConnectedResidue(),this.isCyclic=r.connectedTo(n),this.__residueProxy=this.structure.getResidueProxy()}get chainIndex(){return this.residueStore.chainIndex[this.residueIndexStart]}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}isProtein(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isProtein()}isCg(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isCg()}isNucleic(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isNucleic()}getMoleculeType(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.moleculeType}getBackboneType(e){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.getBackboneType(e)}getAtomIndexByType(e,t){this.isCyclic?-1===e?e=this.residueCount-1:e===this.residueCount&&(e=0):(-1!==e||this.isPrevConnected||(e+=1),e!==this.residueCount||this.isNextNextConnected||(e-=1));const i=this.__residueProxy;let n;switch(i.index=this.residueIndexStart+e,t){case"trace":n=i.traceAtomIndex;break;case"direction1":n=i.direction1AtomIndex;break;case"direction2":n=i.direction2AtomIndex;break;default:n=i.getAtomIndexByName(t)}return n}eachAtom(e,t){this.eachResidue((function(i){i.eachAtom(e,t)}))}eachAtomN(e,t,i){const n=this.residueCount,r=new Array(e);for(let t=0;t<e;++t)r[t]=this.structure.getAtomProxy(this.getAtomIndexByType(t,i));t.apply(this,r);for(var s=e;s<n;++s){for(let t=1;t<e;++t)r[t-1].index=r[t].index;r[e-1].index=this.getAtomIndexByType(s,i),t.apply(this,r)}}eachResidue(e){const t=this.structure.getResidueProxy(),i=this.residueCount,n=this.residueIndexStart;for(let r=0;r<i;++r)t.index=n+r,e(t)}qualifiedName(){const e=this.structure.getResidueProxy(this.residueIndexStart),t=this.structure.getResidueProxy(this.residueIndexEnd);return e.qualifiedName()+" - "+t.qualifiedName()}}class Bp{constructor(e,t=0){this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore}get entity(){return this.structure.entityList[this.entityIndex]}get model(){return this.structure.getModelProxy(this.modelIndex)}get entityIndex(){return this.chainStore.entityIndex[this.index]}set entityIndex(e){this.chainStore.entityIndex[this.index]=e}get modelIndex(){return this.chainStore.modelIndex[this.index]}set modelIndex(e){this.chainStore.modelIndex[this.index]=e}get residueOffset(){return this.chainStore.residueOffset[this.index]}set residueOffset(e){this.chainStore.residueOffset[this.index]=e}get residueCount(){return this.chainStore.residueCount[this.index]}set residueCount(e){this.chainStore.residueCount[this.index]=e}get residueEnd(){return this.residueOffset+this.residueCount-1}get atomOffset(){return this.residueStore.atomOffset[this.residueOffset]}get atomEnd(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1}get atomCount(){return 0===this.residueCount?0:this.atomEnd-this.atomOffset+1}get chainname(){return this.chainStore.getChainname(this.index)}set chainname(e){this.chainStore.setChainname(this.index,e)}get chainid(){return this.chainStore.getChainid(this.index)}set chainid(e){this.chainStore.setChainid(this.index,e)}eachAtom(e,t){this.eachResidue((function(i){i.eachAtom(e,t)}),t)}eachResidue(e,t){const i=this.residueCount,n=this.residueOffset,r=this.structure._rp,s=n+i;if(t&&t.test){const i=t.residueOnlyTest;if(i)for(let t=n;t<s;++t)r.index=t,i(r)&&e(r);else for(let t=n;t<s;++t)r.index=t,e(r)}else for(let t=n;t<s;++t)r.index=t,e(r)}eachResidueN(e,t){const i=this.residueCount,n=this.residueOffset,r=n+i;if(i<e)return;const s=new Array(e);for(let t=0;t<e;++t)s[t]=this.structure.getResidueProxy(n+t);t.apply(this,s);for(let i=n+e;i<r;++i){for(let t=0;t<e;++t)s[t].index+=1;t.apply(this,s)}}eachPolymer(e,t){let i=0,n=0;const r=t?t.residueOnlyTest:void 0,s=this.model.structure,o=this.residueCount,a=this.residueOffset,c=a+o,l=this.structure.getResidueProxy(),h=this.structure.getResidueProxy(a),u=this.structure.getAtomProxy(),d=this.structure.getAtomProxy();let f=!0;for(let t=a+1;t<c;++t){l.index=h.index,h.index=t;const o=f?l.backboneEndType:l.backboneType,a=h.backboneType;f&&(i=l.index,f=!1),n=h.index,o!==ed&&o===a?(u.index=l.backboneEndAtomIndex,d.index=h.backboneStartAtomIndex,u&&d&&u.connectedTo(d)&&(!r||r(l)&&r(h))||(l.index-i>1&&e(new Op(s,i,l.index)),i=n)):(o!==ed&&l.index-i>1&&e(new Op(s,i,l.index)),i=n)}n-i>1&&this.structure.getResidueProxy(i).backboneEndType&&e(new Op(s,i,n))}qualifiedName(){return":"+this.chainname+"/"+this.modelIndex}clone(){return new Bp(this.structure,this.index)}toObject(){return{index:this.index,residueOffset:this.residueOffset,residueCount:this.residueCount,chainname:this.chainname}}}class Np{constructor(e,t=0){this.structure=e,this.index=t,this.modelStore=e.modelStore,this.chainStore=e.chainStore,this.residueStore=e.residueStore}get chainOffset(){return this.modelStore.chainOffset[this.index]}set chainOffset(e){this.modelStore.chainOffset[this.index]=e}get chainCount(){return this.modelStore.chainCount[this.index]}set chainCount(e){this.modelStore.chainCount[this.index]=e}get residueOffset(){return this.chainStore.residueOffset[this.chainOffset]}get atomOffset(){return this.residueStore.atomOffset[this.residueOffset]}get chainEnd(){return this.chainOffset+this.chainCount-1}get residueEnd(){return this.chainStore.residueOffset[this.chainEnd]+this.chainStore.residueCount[this.chainEnd]-1}get atomEnd(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1}get residueCount(){return 0===this.chainCount?0:this.residueEnd-this.residueOffset+1}get atomCount(){return 0===this.residueCount?0:this.atomEnd-this.atomOffset+1}eachAtom(e,t){this.eachChain((function(i){i.eachAtom(e,t)}),t)}eachResidue(e,t){this.eachChain((function(i){i.eachResidue(e,t)}),t)}eachPolymer(e,t){if(t&&t.chainOnlyTest){const i=t.chainOnlyTest;this.eachChain((function(n){i(n)&&n.eachPolymer(e,t)}))}else this.eachChain((function(i){i.eachPolymer(e,t)}))}eachChain(e,t){const i=this.chainCount,n=this.chainOffset,r=this.structure._cp,s=n+i;if(t&&t.test){const i=t.chainOnlyTest;if(i)for(let t=n;t<s;++t)r.index=t,i(r)&&e(r);else for(let t=n;t<s;++t)r.index=t,e(r)}else for(let t=n;t<s;++t)r.index=t,e(r)}qualifiedName(){return"/"+this.index}clone(){return new Np(this.structure,this.index)}toObject(){return{index:this.index,chainOffset:this.chainOffset,chainCount:this.chainCount}}}class Fp{constructor(e="",t=""){this.signals={refreshed:new mc.Signal},this.init(e,t)}init(e,t){this.name=e,this.path=t,this.title="",this.id="",this.data={structure:this,"@spatialLookup":void 0,"@valenceModel":void 0},this.header={},this.extraData={},this.atomSetCache={},this.atomSetDict={},this.biomolDict={},this.entityList=[],this.unitcell=void 0,this.frames=[],this.boxes=[],this.validation=void 0,this.bondStore=new km(0),this.backboneBondStore=new km(0),this.rungBondStore=new km(0),this.atomStore=new Om(0),this.residueStore=new Bm(0),this.chainStore=new Nm(0),this.modelStore=new Fm(0),this.atomMap=new Mp(this),this.residueMap=new Lp(this),this.bondHash=void 0,this.spatialHash=void 0,this.atomSet=void 0,this.bondSet=void 0,this.center=new Zt,this.boundingBox=new Ni,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy()}get type(){return"Structure"}finalizeAtoms(){this.atomSet=this.getAtomSet(),this.atomCount=this.atomStore.count,this.boundingBox=this.getBoundingBox(void 0,this.boundingBox),this.center=this.boundingBox.getCenter(new Zt),this.spatialHash=new ju(this.atomStore,this.boundingBox)}finalizeBonds(){this.bondSet=this.getBondSet(),this.bondCount=this.bondStore.count,this.bondHash=new Rm(this.bondStore,this.atomStore.count),this.atomSetCache={},this.atomSetDict.rung||(this.atomSetDict.rung=this.getAtomSet(!1));for(let e in this.atomSetDict)this.atomSetCache["__"+e]=this.atomSetDict[e].clone()}getBondProxy(e){return new Rp(this,e)}getAtomProxy(e){return new Vm(this,e)}getResidueProxy(e){return new kp(this,e)}getChainProxy(e){return new Bp(this,e)}getModelProxy(e){return new Np(this,e)}getBondSet(){const e=this.bondStore.count,t=new Yu(e),i=this.atomSet;if(i)if(i.isAllSet())t.setAll();else if(i.isAllClear())t.clearAll();else{const n=this.getBondProxy();for(let r=0;r<e;++r)n.index=r,i.isSet(n.atomIndex1,n.atomIndex2)&&t.set(n.index)}else t.setAll();return t}getBackboneBondSet(){const e=this.backboneBondStore.count,t=new Yu(e),i=this.atomSetCache.__backbone;if(i){const n=this.getBondProxy();n.bondStore=this.backboneBondStore;for(let r=0;r<e;++r)n.index=r,i.isSet(n.atomIndex1,n.atomIndex2)&&t.set(n.index)}else t.setAll();return t}getRungBondSet(){const e=this.rungBondStore.count,t=new Yu(e),i=this.atomSetCache.__rung;if(i){const n=this.getBondProxy();n.bondStore=this.rungBondStore;for(let r=0;r<e;++r)n.index=r,i.isSet(n.atomIndex1,n.atomIndex2)&&t.set(n.index)}else t.setAll();return t}getAtomSet(e){const t=this.atomStore.count;if(void 0===e)return new Yu(t,!0);if(e instanceof Yu)return e;if(!0===e)return new Yu(t,!0);if(e&&e.test){const i=e.string;if(i in this.atomSetCache)return this.atomSetCache[i];if(""===i)return new Yu(t,!0);{const n=new Yu(t);return this.eachAtom((function(e){n.set(e.index)}),e),this.atomSetCache[i]=n,n}}return!1===e?new Yu(t):new Yu(t,!0)}getAtomSetWithinSelection(e,t){const i=this.spatialHash,n=this.getAtomSet(!1),r=this.getAtomProxy();return i?(this.getAtomSet(e).forEach((function(e){r.index=e,i.within(r.x,r.y,r.z,t).forEach((function(e){n.set(e)}))})),n):n}getAtomSetWithinPoint(e,t){const i=e,n=this.getAtomSet(!1);return this.spatialHash?(this.spatialHash.within(i.x,i.y,i.z,t).forEach((function(e){n.set(e)})),n):n}getAtomSetWithinVolume(e,t,i,n,r){const s=new Lm(e,i,n,r),o=s.getDataPosition(),a=o.length,c=s.matrix.getMaxScaleOnAxis(),l=this.getAtomSet(!1);if(!this.spatialHash)return l;for(let e=0;e<a;e+=3)this.spatialHash.within(o[e],o[e+1],o[e+2],c).forEach((function(e){l.set(e)}));return l}getAtomSetWithinGroup(e){const t=this.atomStore.residueIndex,i=this.getAtomSet(!1),n=this.getResidueProxy();return this.getAtomSet(e).forEach((function(e){n.index=t[e];for(let e=n.atomOffset;e<=n.atomEnd;++e)i.set(e)})),i}getSelection(){}getStructure(){return this}eachEntity(e,t){this.entityList.forEach((function(i){void 0!==t&&i.getEntityType()!==t||e(i)}))}eachBond(e,t){const i=this.getBondProxy();let n;if(t&&t.test&&(n=this.getBondSet(),this.bondSet&&n.intersection(this.bondSet)),n)n.forEach((function(t){i.index=t,e(i)}));else{const t=this.bondStore.count;for(let n=0;n<t;++n)i.index=n,e(i)}}eachAtom(e,t){if(t&&t.test)this.eachModel((function(i){i.eachAtom(e,t)}),t);else{const t=this.atomStore.count,i=this.getAtomProxy();for(let n=0;n<t;++n)i.index=n,e(i)}}eachResidue(e,t){if(t&&t.test){const i=this.modelStore.count,n=this.getModelProxy(),r=t.modelOnlyTest;if(r)for(let s=0;s<i;++s)n.index=s,r(n)&&n.eachResidue(e,t);else for(let r=0;r<i;++r)n.index=r,n.eachResidue(e,t)}else{const t=this.residueStore.count,i=this.getResidueProxy();for(let n=0;n<t;++n)i.index=n,e(i)}}eachResidueN(e,t){const i=this.residueStore.count;if(i<e)return;const n=new Array(e);for(let t=0;t<e;++t)n[t]=this.getResidueProxy(t);t.apply(this,n);for(let r=e;r<i;++r){for(let t=0;t<e;++t)n[t].index+=1;t.apply(this,n)}}eachPolymer(e,t){if(t&&t.modelOnlyTest){const i=t.modelOnlyTest;this.eachModel((function(n){i(n)&&n.eachPolymer(e,t)}))}else this.eachModel((function(i){i.eachPolymer(e,t)}))}eachChain(e,t){if(t&&t.test)this.eachModel((function(i){i.eachChain(e,t)}));else{const t=this.chainStore.count,i=this.getChainProxy();for(let n=0;n<t;++n)i.index=n,e(i)}}eachModel(e,t){const i=this.modelStore.count,n=this.getModelProxy();if(t&&t.test){const r=t.modelOnlyTest;if(r)for(let t=0;t<i;++t)n.index=t,r(n)&&e(n);else for(let t=0;t<i;++t)n.index=t,e(n)}else for(let t=0;t<i;++t)n.index=t,e(n)}getAtomData(e){const t=Object.assign({},e);t.colorParams&&(t.colorParams.structure=this.getStructure());const i=t.what,n=Ia(t.atomSet,this.atomSet);let r,s;const o={},a=this.getAtomProxy(),c=n.getSize();i&&!i.position||(o.position=new Float32Array(3*c)),i&&!i.color||!t.colorParams||(o.color=new Float32Array(3*c),s=al.getScheme(t.colorParams)),i&&!i.picking||(o.picking=new hf(new Float32Array(c),this.getStructure())),i&&!i.radius||(o.radius=new Float32Array(c),r=new Tm(t.radiusParams)),i&&!i.index||(o.index=new Uint32Array(c));const{position:l,color:h,picking:u,radius:d,index:f}=o;return n.forEach(((e,t)=>{const i=3*t;a.index=e,l&&a.positionToArray(l,i),h&&s.atomColorToArray(a,h,i),u&&(u.array[t]=e),d&&(d[t]=r.atomRadius(a)),f&&(f[t]=e)})),o}getBondData(e){const t=Object.assign({},e);t.colorParams&&(t.colorParams.structure=this.getStructure());const i=t.what,n=Ia(t.bondSet,this.bondSet),r=Ia(t.multipleBond,"off"),s="off"!==r,o="offset"===r,a=Ia(t.bondScale,.4),c=Ia(t.bondSpacing,1);let l,h;const u={},d=this.getBondProxy();t.bondStore&&(d.bondStore=t.bondStore);const f=this.getAtomProxy(),m=this.getAtomProxy();let p;if(s){const e=d.bondStore.bondOrder;p=0,n.forEach((function(t){p+=e[t]}))}else p=n.getSize();i&&!i.position||(u.position1=new Float32Array(3*p),u.position2=new Float32Array(3*p)),i&&!i.color||!t.colorParams||(u.color=new Float32Array(3*p),u.color2=new Float32Array(3*p),h=al.getScheme(t.colorParams)),i&&!i.picking||(u.picking=new df(new Float32Array(p),this.getStructure(),t.bondStore)),(!i||i.radius||s&&i.position)&&(l=new Tm(t.radiusParams)),i&&!i.radius||(u.radius=new Float32Array(p),t.radius2&&(u.radius2=new Float32Array(p)));const{position1:g,position2:v,color:y,color2:x,picking:b,radius:_,radius2:w}=u;let S,A,M,C,P,T,I=0;const E=new Zt,D=new Zt,L=new Zt;return n.forEach((e=>{if(A=3*I,d.index=e,f.index=d.atomIndex1,m.index=d.atomIndex2,C=d.bondOrder,g)if(s&&C>1){const e=l.atomRadius(f);T=e*a/(.5*C),d.calculateShiftDir(L),o?(P=2*c*e,L.multiplyScalar(P),L.negate(),D.subVectors(m,f).multiplyScalar(Math.max(.1,P/1.88)),f.positionToArray(g,A),m.positionToArray(v,A),C>=2&&(E.addVectors(f,L).add(D).toArray(g,A+3),E.addVectors(m,L).sub(D).toArray(v,A+3),C>=3&&(E.subVectors(f,L).add(D).toArray(g,A+6),E.subVectors(m,L).sub(D).toArray(v,A+6)))):(P=(c-a)*e,L.multiplyScalar(P),2===C?(E.addVectors(f,L).toArray(g,A),E.subVectors(f,L).toArray(g,A+3),E.addVectors(m,L).toArray(v,A),E.subVectors(m,L).toArray(v,A+3)):3===C?(f.positionToArray(g,A),E.addVectors(f,L).toArray(g,A+3),E.subVectors(f,L).toArray(g,A+6),m.positionToArray(v,A),E.addVectors(m,L).toArray(v,A+3),E.subVectors(m,L).toArray(v,A+6)):(f.positionToArray(g,A),m.positionToArray(v,A)))}else f.positionToArray(g,A),m.positionToArray(v,A);if(y&&x&&(h.bondColorToArray(d,1,y,A),h.bondColorToArray(d,0,x,A),s&&C>1))for(S=1;S<C;++S)M=3*S+A,Xl(y,A,M,3),Xl(x,A,M,3);if(b&&b.array&&(b.array[I]=e,s&&C>1))for(S=1;S<C;++S)b.array[I+S]=e;if(_&&(_[I]=l.atomRadius(f),s&&C>1))for(T=_[I]*a/(o?1:.5*C),S=o?1:0;S<C;++S)_[I+S]=T;if(w&&(w[I]=l.atomRadius(m),s&&C>1))for(T=w[I]*a/(o?1:.5*C),S=o?1:0;S<C;++S)w[I+S]=T;I+=s?C:1})),u}getBackboneAtomData(e){return e=Object.assign({atomSet:this.atomSetCache.__backbone},e),this.getAtomData(e)}getBackboneBondData(e){return e=Object.assign({bondSet:this.getBackboneBondSet(),bondStore:this.backboneBondStore},e),this.getBondData(e)}getRungAtomData(e){return e=Object.assign({atomSet:this.atomSetCache.__rung},e),this.getAtomData(e)}getRungBondData(e){return e=Object.assign({bondSet:this.getRungBondSet(),bondStore:this.rungBondStore},e),this.getBondData(e)}getBoundingBox(t,i){e.Debug&&il.time("getBoundingBox"),i=i||new Ni;let n=1/0,r=1/0,s=1/0,o=-1/0,a=-1/0,c=-1/0;return this.eachAtom((e=>{const t=e.x,i=e.y,l=e.z;t<n&&(n=t),i<r&&(r=i),l<s&&(s=l),t>o&&(o=t),i>a&&(a=i),l>c&&(c=l)}),t),i.min.set(n,r,s),i.max.set(o,a,c),e.Debug&&il.timeEnd("getBoundingBox"),i}getPrincipalAxes(t){e.Debug&&il.time("getPrincipalAxes");let i=0;const n=new Mf(3,this.atomCount),r=n.data;return this.eachAtom((e=>{r[i+0]=e.x,r[i+1]=e.y,r[i+2]=e.z,i+=3}),t),e.Debug&&il.timeEnd("getPrincipalAxes"),new Dm(n)}atomCenter(e){return e?this.getBoundingBox(e).getCenter(new Zt):this.center.clone()}hasCoords(){if(void 0===this._hasCoords){const e=this.atomStore;this._hasCoords=0!==Zl(e.x)||0!==Yl(e.x)||0!==Zl(e.y)||0!==Yl(e.y)||0!==Zl(e.z)||0!==Yl(e.z)||e.count/this.modelStore.count==1}return this._hasCoords}getSequence(e){const t=[],i=this.getResidueProxy();return this.eachAtom((function(e){i.index=e.residueIndex,e.index===i.traceAtomIndex&&t.push(i.getResname1())}),e),t}getAtomIndices(e){if(e&&e.string){const t=[];return this.eachAtom((function(e){t.push(e.index)}),e),new Uint32Array(t)}{const e={what:{index:!0}};return this.getAtomData(e).index}}getChainnameCount(e){const t=new Set;return this.eachChain((function(e){e.residueCount&&t.add(e.chainname)}),e),t.size}updatePosition(e,t=!0){let i=0;this.eachAtom((function(t){t.positionFromArray(e,i),i+=3}),void 0),this._hasCoords=void 0,t&&this.refreshPosition()}refreshPosition(){this.getBoundingBox(void 0,this.boundingBox),this.boundingBox.getCenter(this.center),this.spatialHash=new ju(this.atomStore,this.boundingBox),this.signals.refreshed.dispatch(this)}dispose(){this.frames&&(this.frames.length=0),this.boxes&&(this.boxes.length=0),this.bondStore.dispose(),this.backboneBondStore.dispose(),this.rungBondStore.dispose(),this.atomStore.dispose(),this.residueStore.dispose(),this.chainStore.dispose(),this.modelStore.dispose(),delete this.bondSet,delete this.atomSet}}const zp=new Ni,Up=[Fu,ku,zu,Nu,Uu,Ou,Ru,Bu,Gu,$u,Vu,Hu],$p={aspectRatio:1.5,sphereDetail:2,radialSegments:50,disableImpostor:!1,openEnded:!1,dashedCylinder:!1,labelParams:{},pointSize:2,sizeAttenuation:!1,useTexture:!0,linewidth:2};class Gp{constructor(e="shape",t={}){this.boundingBox=new Ni,this.bufferList=[],this.meshCount=0,this._primitiveData={},this.name=e,this.parameters=Ea(t,$p),Up.forEach((e=>{Object.keys(e.fields).forEach((t=>{this._primitiveData[e.getShapeKey(t)]=[]})),this._primitiveData[e.getShapeKey("name")]=[]}))}addBuffer(e){this.bufferList.push(e);const t=e.geometry;return t.boundingBox||t.computeBoundingBox(),this.boundingBox.union(t.boundingBox),this}addMesh(e,t,i,n,r){let s;e=Xa(e),t=Xa(t),Array.isArray(i)&&(i=Ga(i,e.length)),n&&(n=Xa(n)),s=void 0===n||0==n.length?{position:e,color:t,index:i}:{position:e,color:t,index:i,normal:n};const o=new vf(this,Object.assign({serial:this.meshCount,name:r},s)),a=new nm(Object.assign({picking:o},s));return this.bufferList.push(a),zp.setFromArray(e),this.boundingBox.union(zp),this.meshCount+=1,this}addSphere(e,t,i,n){return Ru.objectToShape(this,{position:e,color:t,radius:i,name:n}),this}addEllipsoid(e,t,i,n,r,s){return Uu.objectToShape(this,{position:e,color:t,radius:i,majorAxis:n,minorAxis:r,name:s}),this}addTorus(e,t,i,n,r,s){return $u.objectToShape(this,{position:e,color:t,radius:i,majorAxis:n,minorAxis:r,name:s}),this}addCylinder(e,t,i,n,r){return Nu.objectToShape(this,{position1:e,position2:t,color:i,radius:n,name:r}),this}addCone(e,t,i,n,r){return zu.objectToShape(this,{position1:e,position2:t,color:i,radius:n,name:r}),this}addArrow(e,t,i,n,r){return Fu.objectToShape(this,{position1:e,position2:t,color:i,radius:n,name:r}),this}addBox(e,t,i,n,r,s){return ku.objectToShape(this,{position:e,color:t,size:i,heightAxis:n,depthAxis:r,name:s}),this}addOctahedron(e,t,i,n,r,s){return Ou.objectToShape(this,{position:e,color:t,size:i,heightAxis:n,depthAxis:r,name:s}),this}addTetrahedron(e,t,i,n,r,s){return Bu.objectToShape(this,{position:e,color:t,size:i,heightAxis:n,depthAxis:r,name:s}),this}addText(e,t,i,n){return Gu.objectToShape(this,{position:e,color:t,size:i,text:n}),this}addPoint(e,t,i){return Vu.objectToShape(this,{position:e,color:t,name:i}),this}addWideline(e,t,i,n,r){return this.parameters.linewidth=n,Hu.objectToShape(this,{position1:e,position2:t,color:i,name:r}),this}addLabel(e,t,i,n){return console.warn("Shape.addLabel is deprecated, use .addText instead"),this.addText(e,t,i,n)}getBufferList(){const e=[];return Up.forEach((t=>{this._primitiveData[t.getShapeKey("color")].length&&e.push(t.bufferFromShape(this,this.parameters))})),this.bufferList.concat(e)}dispose(){this.bufferList.forEach((function(e){e.dispose()})),this.bufferList.length=0,Up.forEach((e=>{Object.keys(e.fields).forEach((t=>{this._primitiveData[e.getShapeKey(t)].length=0})),this._primitiveData[e.getShapeKey("name")].length=0}))}get center(){return this._center||(this._center=this.boundingBox.getCenter(new Zt)),this._center}get type(){return"Shape"}}class Vp extends tu{constructor(e,t,i){Array.isArray(e)||(e=[e]),super(e,t,i),this.type="buffer",this.parameters=Object.assign({},this.parameters,{colorScheme:null,colorScale:null,colorValue:null,colorDomain:null,colorMode:null}),this.buffer=e,this.init(i)}init(e){super.init(e),this.build()}create(){this.bufferList.push.apply(this.bufferList,this.buffer)}attach(e){this.bufferList.forEach((e=>{this.viewer.add(e),e.setParameters(this.getBufferParams())})),this.setVisibility(this.visible),e()}}const Hp=new ri,jp=new Ut;class Wp extends nm{constructor(e,t={},i){super(function(e,t){const i=t.attributes.position.array,n=t.index?t.index.array:void 0,r=e.position.length/3,s=i.length/3,o=r*s,a=new Float32Array(3*o),c=new Float32Array(3*o),l=new Float32Array(3*o);let h;return n&&(h=Ga(r*n.length,o)),{position:a,color:l,index:h,normal:c,primitiveId:e.primitiveId||jl(r,s),picking:e.picking}}(e,i),t),this.updateNormals=!1;const n=i.attributes.position.array,r=i.attributes.normal.array,s=i.index?i.index.array:void 0;this.geoPosition=n,this.geoNormal=r,this.geoIndex=s,this.positionCount=e.position.length/3,this.geoPositionCount=n.length/3,this.transformedGeoPosition=new Float32Array(3*this.geoPositionCount),this.transformedGeoNormal=new Float32Array(3*this.geoPositionCount);const o=this.geometry.attributes;if(this.meshPosition=o.position.array,this.meshColor=o.color.array,this.meshNormal=o.normal.array,this.setAttributes(e),s){const e=this.geometry.getIndex();if(!e)return void il.error("Index is null");this.meshIndex=e.array,this.makeIndex()}}setAttributes(e={},t=!1){const i=this.geometry.attributes;let n,r,s,o,a,c,l,h,u;const d=this.updateNormals;e.position&&(n=e.position,s=this.geoPosition,l=this.meshPosition,a=this.transformedGeoPosition,i.position.needsUpdate=!0,(d||t)&&(o=this.geoNormal,u=this.meshNormal,c=this.transformedGeoNormal,i.normal.needsUpdate=!0)),e.color&&(r=e.color,h=this.meshColor,i.color.needsUpdate=!0);const f=this.positionCount,m=this.geoPositionCount;for(let e=0;e<f;++e){let i,f;const p=e*m*3,g=3*e;if(n&&a&&l&&u&&s&&o&&(a.set(s),Hp.makeTranslation(n[g],n[g+1],n[g+2]),this.applyPositionTransform(Hp,e,g),au(Hp.elements,a),l.set(a,p),d&&c?(c.set(o),jp.getNormalMatrix(Hp),cu(jp.elements,c),u.set(c,p)):t&&u.set(o,p)),r&&h)for(i=0;i<m;++i)f=p+3*i,h[f]=r[g],h[f+1]=r[g+1],h[f+2]=r[g+2]}}makeIndex(){const e=this.geoIndex,t=this.meshIndex;if(!e)return;const i=this.positionCount,n=this.geoPositionCount,r=3*(e.length/3);for(let s=0;s<i;++s){const i=s*r,o=i+r;t.set(e,i);for(let e=i;e<o;++e)t[e]+=s*n}}}const qp=new Zt,Xp=Object.assign({sphereDetail:1},em);class Yp extends Wp{constructor(e,t={}){super(e,t,new ua(1,Ia(t.sphereDetail,1))),this.setAttributes(e,!0)}get defaultParameters(){return Xp}applyPositionTransform(e,t){const i=this._radius[t];qp.set(i,i,i),e.scale(qp)}setAttributes(e={},t){e.radius&&(this._radius=e.radius),super.setAttributes(e,t)}}ul.add("shader/SphereImpostor.vert","uniform mat4 projectionMatrixInverse;\nuniform float clipNear;\nvarying float vRadius;\nvarying float vRadiusSq;\nvarying vec3 vPoint;\nvarying vec3 vPointViewPosition;\nattribute vec2 mapping;\nattribute float radius;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#endif\n#include matrix_scale\nconst mat4 D = mat4(\n1.0, 0.0, 0.0, 0.0,\n0.0, 1.0, 0.0, 0.0,\n0.0, 0.0, 1.0, 0.0,\n0.0, 0.0, 0.0, -1.0\n);\nmat4 transposeM( in mat4 inMatrix ) {\nvec4 i0 = inMatrix[0];\nvec4 i1 = inMatrix[1];\nvec4 i2 = inMatrix[2];\nvec4 i3 = inMatrix[3];\nmat4 outMatrix = mat4(\nvec4(i0.x, i1.x, i2.x, i3.x),\nvec4(i0.y, i1.y, i2.y, i3.y),\nvec4(i0.z, i1.z, i2.z, i3.z),\nvec4(i0.w, i1.w, i2.w, i3.w)\n);\nreturn outMatrix;\n}\nvoid ComputePointSizeAndPositionInClipCoordSphere(){\nvec2 xbc;\nvec2 ybc;\nmat4 T = mat4(\nradius, 0.0, 0.0, 0.0,\n0.0, radius, 0.0, 0.0,\n0.0, 0.0, radius, 0.0,\nposition.x, position.y, position.z, 1.0\n);\nmat4 R = transposeM( projectionMatrix * modelViewMatrix * T );\nfloat A = dot( R[ 3 ], D * R[ 3 ] );\nfloat B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );\nfloat C = dot( R[ 0 ], D * R[ 0 ] );\nxbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nxbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nfloat sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;\nA = dot( R[ 3 ], D * R[ 3 ] );\nB = -2.0 * dot( R[ 1 ], D * R[ 3 ] );\nC = dot( R[ 1 ], D * R[ 1 ] );\nybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nfloat sy = abs( ybc[ 0 ] - ybc[ 1 ] ) * 0.5;\ngl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );\ngl_Position.xy -= mapping * vec2( sx, sy );\ngl_Position.xy *= gl_Position.w;\n}\nvoid main(void){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\nvRadius = radius * matrixScale( modelViewMatrix );\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nmvPosition.z -= vRadius;\ngl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );\nComputePointSizeAndPositionInClipCoordSphere();\nvRadiusSq = vRadius * vRadius;\nvec4 vPoint4 = projectionMatrixInverse * gl_Position;\nvPoint = vPoint4.xyz / vPoint4.w;\nvPointViewPosition = -mvPosition.xyz / mvPosition.w;\n}"),ul.add("shader/SphereImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform mat4 projectionMatrix;\nuniform float ortho;\nvarying float vRadius;\nvarying float vRadiusSq;\nvarying vec3 vPoint;\nvarying vec3 vPointViewPosition;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool flag2 = false;\nbool interior = false;\nvec3 cameraPos;\nvec3 cameraNormal;\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nfloat calcClip( vec3 cameraPos ){\nreturn dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nbool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){\nvec3 cameraSpherePos = -vPointViewPosition;\ncameraSpherePos.z += vRadius;\nvec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );\nvec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );\nvec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );\nfloat B = dot( rayDirection, cameraSphereDir );\nfloat det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );\nif( det < 0.0 ){\ndiscard;\nreturn false;\n}\nfloat sqrtDet = sqrt( det );\nfloat posT = mix( B + sqrtDet, B + sqrtDet, ortho );\nfloat negT = mix( B - sqrtDet, sqrtDet - B, ortho );\ncameraPos = rayDirection * negT + rayOrigin;\n#ifdef NEAR_CLIP\nif( calcDepth( cameraPos ) <= 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\n}else if( calcClip( cameraPos ) > 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\nflag2 = true;\n}\n#else\nif( calcDepth( cameraPos ) <= 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\n}\n#endif\ncameraNormal = normalize( cameraPos - cameraSpherePos );\ncameraNormal *= float(!interior) * 2.0 - 1.0;\nreturn !interior;\n}\nvoid main(void){\nbool flag = Impostor( cameraPos, cameraNormal );\n#ifdef NEAR_CLIP\nif( calcClip( cameraPos ) > 0.0 )\ndiscard;\n#endif\ngl_FragDepthEXT = calcDepth( cameraPos );\nif( !flag ){\n#ifdef NEAR_CLIP\nif( flag2 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );\n}else if( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n#else\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n#endif\n}\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vNormal = cameraNormal;\nvec3 vViewPosition = -cameraPos;\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\n#include normal_fragment_begin\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");class Zp extends im{constructor(e,t,i={}){super(t,i),this.index=Ga(this.indexSize,this.attributeSize),this.makeIndex(),this.initIndex(this.index),this.addAttributes({mapping:{type:e,value:null}}),this.setAttributes({primitiveId:Hl(this.size)})}get attributeSize(){return this.size*this.mappingSize}get indexSize(){return this.size*this.mappingIndicesSize}addAttributes(e){const t={};for(const i in e){const n=e[i];t[i]={type:n.type,value:null}}super.addAttributes(t)}getAttributeIndex(e){return 3*e*this.mappingSize}setAttributes(e){e&&!e.position&&e.position1&&e.position2&&(e.position=Ul(e.position1,e.position2));const t=this.size,i=this.mappingSize,n=this.geometry.attributes;let r,s,o,a,c,l,h;for(const u in e)if("index"!==u&&"picking"!==u){s=e[u],r=n[u],o=r.itemSize,a=r.array;for(let e=0;e<t;++e){c=e*o,l=c*i;for(let e=0;e<i;++e){h=l+o*e;for(let e=0;e<o;++e)a[h+e]=s[c+e]}}r.needsUpdate=!0}}makeMapping(){const e=this.size,t=this.mapping,i=this.mappingSize,n=this.mappingItemSize,r=this.geometry.attributes.mapping.array;for(let s=0;s<e;s++)r.set(t,s*n*i)}makeIndex(){const e=this.size,t=this.mappingSize,i=this.mappingIndices,n=this.mappingIndicesSize,r=this.index;for(let s=0;s<e;s++){const e=s*n,o=s*t;r.set(i,e);for(let t=0;t<n;++t)r[e+t]+=o}}}const Kp=new Float32Array([-1,1,-1,-1,1,1,1,-1]),Qp=new Uint16Array([0,1,2,1,3,2]);class Jp extends Zp{constructor(e,t={}){super("v2",e,t)}get mapping(){return Kp}get mappingIndices(){return Qp}get mappingIndicesSize(){return 6}get mappingSize(){return 4}get mappingItemSize(){return 2}}class eg extends Jp{constructor(e,t={}){super(e,t),this.isImpostor=!0,this.vertexShader="SphereImpostor.vert",this.fragmentShader="SphereImpostor.frag",this.addUniforms({projectionMatrixInverse:{value:new ri},ortho:{value:0}}),this.addAttributes({radius:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}}Object.assign({disableImpostor:!1},Xp);const tg=class{constructor(e,t){return!el||t&&t.disableImpostor?new Yp(e,t):new eg(e,t)}};function ig(e,t,i,n){const r=i-e,s=n-t;return Math.sqrt(r*r+s*s)}ml.add("sphere",tg),ul.add("shader/Point.vert","uniform float clipNear;\nuniform float clipRadius;\nuniform vec3 clipCenter;\nuniform float size;\nuniform float canvasHeight;\nuniform float pixelRatio;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\nvarying vec3 vViewPosition;\n#endif\n#include common\nvoid main(){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\n#include begin_vertex\n#include project_vertex\n#ifdef USE_SIZEATTENUATION\ngl_PointSize = size * pixelRatio * ( ( canvasHeight / 2.0 ) / -mvPosition.z );\n#else\ngl_PointSize = size * pixelRatio;\n#endif\n#ifndef PICKING\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n#include radiusclip_vertex\n}"),ul.add("shader/Point.frag","uniform vec3 diffuse;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\nvarying vec3 vViewPosition;\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\n#ifdef USE_MAP\nif( texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).a < 0.5 )\ndiscard;\n#endif\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 outgoingLight = vec3( 0.0 );\nvec4 diffuseColor = vec4( diffuse, 1.0 );\n#ifdef USE_MAP\ndiffuseColor *= texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );\n#endif\n#include color_fragment\n#include alphatest_fragment\noutgoingLight = diffuseColor.rgb;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");const ng=Object.assign({pointSize:1,sizeAttenuation:!0,sortParticles:!1,alphaTest:.5,useTexture:!1,forceTransparent:!1,edgeBleach:0},em),rg=Object.assign({pointSize:{uniform:"size"},sizeAttenuation:{updateShader:!0},sortParticles:{},alphaTest:{updateShader:!0},useTexture:{updateShader:!0},forceTransparent:{},edgeBleach:{uniform:!0}},tm);class sg extends im{constructor(e,t={}){super(e,t),this.parameterTypes=rg,this.vertexShader="Point.vert",this.fragmentShader="Point.frag",this.isPoint=!0,this.addUniforms({size:{value:this.parameters.pointSize},canvasHeight:{value:1},pixelRatio:{value:1},map:{value:null}})}get defaultParameters(){return ng}makeMaterial(){super.makeMaterial(),this.makeTexture();const e=this.material,t=this.wireframeMaterial,i=this.pickingMaterial;e.uniforms.map.value=this.tex,e.needsUpdate=!0,t.uniforms.map.value=this.tex,t.needsUpdate=!0,i.uniforms.map.value=this.tex,i.needsUpdate=!0}makeTexture(){this.tex&&this.tex.dispose(),this.tex=function(e){const t=e||{},i=Ia(t.width,256),n=Ia(t.height,256),r=[i/2,n/2],s=Math.min(i/2,n/2),o=Ia(t.delta,1/(s+1))*s;let a=0,c=0;const l=new Uint8Array(i*n*4);for(let e=0,t=l.length;e<t;e+=4){const t=1-rc(s-o,s,ig(a,c,r[0],r[1]));l[e]=255*t,l[e+1]=255*t,l[e+2]=255*t,l[e+3]=255*t,++a===i&&(a=0,c++)}const h=new Ar(l,i,n);return h.needsUpdate=!0,h}({delta:this.parameters.edgeBleach})}getDefines(e){const t=super.getDefines(e);return this.parameters.sizeAttenuation&&(t.USE_SIZEATTENUATION=1),this.parameters.useTexture&&(t.USE_MAP=1),this.parameters.alphaTest>0&&this.parameters.alphaTest<=1&&(t.ALPHATEST=this.parameters.alphaTest.toPrecision(2)),t}setUniforms(e){e&&void 0!==e.edgeBleach&&(this.makeTexture(),e.map=this.tex),super.setUniforms(e)}dispose(){super.dispose(),this.tex&&this.tex.dispose()}}ml.add("point",sg);class og extends tu{constructor(e,t,i){super(e,t,i),this.type="dot",this.parameters=Object.assign({thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdOut:{type:"boolean",rebuild:!0},dotType:{type:"select",rebuild:!0,options:{"":"",sphere:"sphere",point:"point"}},radiusType:{type:"select",options:{"":"",value:"value","abs-value":"abs-value","value-min":"value-min",deviation:"deviation",size:"size"}},radius:{type:"number",precision:3,max:10,min:.001,property:"size"},scale:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,disableImpostor:!0,pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{colorScheme:{type:"select",update:"color",options:{"":"",value:"value",uniform:"uniform",random:"random"}}}),e instanceof Zf?(this.surface=void 0,this.volume=new Lm(e)):(this.surface=e,this.volume=void 0),this.init(i)}init(e){var t=e||{};t.colorScheme=Ia(t.colorScheme,"uniform"),t.colorValue=Ia(t.colorValue,14540253),this.thresholdType=Ia(t.thresholdType,"sigma"),this.thresholdMin=Ia(t.thresholdMin,2),this.thresholdMax=Ia(t.thresholdMax,1/0),this.thresholdOut=Ia(t.thresholdOut,!1),this.dotType=Ia(t.dotType,"point"),this.radius=Ia(t.radius,.1),this.scale=Ia(t.scale,1),this.pointSize=Ia(t.pointSize,1),this.sizeAttenuation=Ia(t.sizeAttenuation,!0),this.sortParticles=Ia(t.sortParticles,!1),this.useTexture=Ia(t.useTexture,!1),this.alphaTest=Ia(t.alphaTest,.5),this.forceTransparent=Ia(t.forceTransparent,!1),this.edgeBleach=Ia(t.edgeBleach,0),super.init(t),this.build()}attach(e){this.bufferList.forEach((e=>{this.viewer.add(e)})),this.setVisibility(this.visible),e()}create(){var e={};if(this.volume){var t,i,n=this.volume;"sigma"===this.thresholdType?(t=n.getValueForSigma(this.thresholdMin),i=n.getValueForSigma(this.thresholdMax)):(t=this.thresholdMin,i=this.thresholdMax),n.setFilter(t,i,this.thresholdOut),Object.assign(e,{position:n.getDataPosition(),color:n.getDataColor(this.getColorParams())}),"sphere"===this.dotType&&Object.assign(e,{radius:n.getDataSize(this.radius,this.scale),picking:n.getDataPicking()})}else{var r=this.surface;Object.assign(e,{position:r.getPosition(),color:r.getColor(this.getColorParams())}),"sphere"===this.dotType&&Object.assign(e,{radius:r.getSize(this.radius,this.scale),picking:r.getPicking()})}"sphere"===this.dotType?this.dotBuffer=new tg(e,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!1})):this.dotBuffer=new sg(e,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach})),this.bufferList.push(this.dotBuffer)}update(e={}){if(0===this.bufferList.length)return;const t={};e.color&&(this.volume?Object.assign(t,{color:this.volume.getDataColor(this.getColorParams())}):Object.assign(t,{color:this.surface.getColor(this.getColorParams())})),"sphere"===this.dotType&&(e.radius||e.scale)&&(this.volume?Object.assign(t,{radius:this.volume.getDataSize(this.radius,this.scale)}):Object.assign(t,{radius:this.surface.getSize(this.radius,this.scale)})),this.dotBuffer.setAttributes(t)}setParameters(e,t={},i){return e&&void 0!==e.thresholdType&&this.volume instanceof Zf&&("value"===this.thresholdType&&"sigma"===e.thresholdType?(this.thresholdMin=this.volume.getSigmaForValue(this.thresholdMin),this.thresholdMax=this.volume.getSigmaForValue(this.thresholdMax)):"sigma"===this.thresholdType&&"value"===e.thresholdType&&(this.thresholdMin=this.volume.getValueForSigma(this.thresholdMin),this.thresholdMax=this.volume.getValueForSigma(this.thresholdMax)),this.thresholdType=e.thresholdType),e&&void 0!==e.radiusType&&("radius"===e.radiusType?this.radius=.1:this.radius=parseFloat(e.radiusType),t.radius=!0,"sphere"!==this.dotType||el&&!this.disableImpostor||(i=!0)),e&&void 0!==e.radius&&(t.radius=!0,"sphere"!==this.dotType||el&&!this.disableImpostor||(i=!0)),e&&void 0!==e.scale&&(t.scale=!0,"sphere"!==this.dotType||el&&!this.disableImpostor||(i=!0)),super.setParameters(e,t,i),this}}ul.add("shader/Image.vert","uniform float clipRadius;\nuniform vec3 clipCenter;\nvarying vec2 vUv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nvoid main() {\n#include begin_vertex\n#include project_vertex\nvUv = uv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n}"),ul.add("shader/Image.frag","uniform sampler2D map;\nuniform float opacity;\nuniform vec2 mapSize;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec2 vUv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform sampler2D pickingMap;\nuniform float objectId;\n#else\n#include fog_pars_fragment\n#endif\n#if defined( CUBIC_INTERPOLATION )\n#if defined( CATMULROM_FILTER ) || defined( MITCHELL_FILTER )\n#if defined( CATMULROM_FILTER )\nconst float B = 0.0;\nconst float C = 0.5;\n#elif defined( MITCHELL_FILTER )\nconst float B = 0.333;\nconst float C = 0.333;\n#endif\nfloat filter( float x ){\nfloat f = x;\nif( f < 0.0 ){\nf = -f;\n}\nif( f < 1.0 ){\nreturn ( ( 12.0 - 9.0 * B - 6.0 * C ) * ( f * f * f ) +\n( -18.0 + 12.0 * B + 6.0 *C ) * ( f * f ) +\n( 6.0 - 2.0 * B ) ) / 6.0;\n}else if( f >= 1.0 && f < 2.0 ){\nreturn ( ( -B - 6.0 * C ) * ( f * f * f )\n+ ( 6.0 * B + 30.0 * C ) * ( f *f ) +\n( - ( 12.0 * B ) - 48.0 * C ) * f +\n8.0 * B + 24.0 * C ) / 6.0;\n}else{\nreturn 0.0;\n}\n}\n#elif defined( BSPLINE_FILTER )\nfloat filter( float x ){\nfloat f = x;\nif( f < 0.0 ){\nf = -f;\n}\nif( f >= 0.0 && f <= 1.0 ){\nreturn ( 2.0 / 3.0 ) + ( 0.5 ) * ( f * f * f ) - ( f * f );\n}else if( f > 1.0 && f <= 2.0 ){\nreturn 1.0 / 6.0 * pow( ( 2.0 - f ), 3.0 );\n}\nreturn 1.0;\n}\n#else\nfloat filter( float x ){\nreturn 1.0;\n}\n#endif\nvec4 biCubic( sampler2D tex, vec2 texCoord ){\nvec2 texelSize = 1.0 / mapSize;\ntexCoord -= texelSize / 2.0;\nvec4 nSum = vec4( 0.0 );\nfloat nDenom = 0.0;\nvec2 cell = fract( texCoord * mapSize );\nfor( float m = -1.0; m <= 2.0; ++m ){\nfor( float n = -1.0; n <= 2.0; ++n ){\nvec4 vecData = texture2D(\ntex, texCoord + texelSize * vec2( m, n )\n);\nfloat c = filter( m - cell.x ) * filter( -n + cell.y );\nnSum += vecData * c;\nnDenom += c;\n}\n}\nreturn nSum / nDenom;\n}\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( CUBIC_INTERPOLATION )\ngl_FragColor = biCubic( map, vUv );\n#else\ngl_FragColor = texture2D( map, vUv );\n#endif\n#if defined( PICKING )\nif( gl_FragColor.a < 0.3 )\ndiscard;\ngl_FragColor = vec4( texture2D( pickingMap, vUv ).xyz, objectId );\n#else\nif( gl_FragColor.a < 0.01 )\ndiscard;\ngl_FragColor.a *= opacity;\n#include fog_fragment\n#endif\n}");const ag=new Uint16Array([0,1,2,1,3,2]),cg=new Float32Array([0,1,0,0,1,1,1,0]),lg=Object.assign({filter:"nearest",forceTransparent:!0},em),hg=Object.assign({filter:{updateShader:!0,uniform:!0}},tm);class ug extends im{constructor(e,t){super({position:e.position,index:ag,picking:e.picking},t),this.parameterTypes=hg,this.alwaysTransparent=!0,this.hasWireframe=!1,this.vertexShader="Image.vert",this.fragmentShader="Image.frag";const{imageData:i,width:n,height:r}=e,s=new Ar(i,n,r);s.flipY=!0,this.tex=s;const o=i.length,a=new Uint8Array(o);for(let e=0;e<o;e+=4){const t=e/4;a[e]=t>>16&255,a[e+1]=t>>8&255,a[e+2]=255&t}const c=new Ar(a,n,r);c.flipY=!0,c.minFilter=re,c.magFilter=re,this.pickingTex=c,this.addUniforms({map:{value:s},pickingMap:{value:c},mapSize:{value:new zt(n,r)}}),this.geometry.setAttribute("uv",new An(cg,2))}get defaultParameters(){return lg}getDefines(e){const t=super.getDefines(e),i=this.parameters.filter;return i.startsWith("cubic")&&(t.CUBIC_INTERPOLATION=1,i.endsWith("bspline")?t.BSPLINE_FILTER=1:i.endsWith("catmulrom")?t.CATMULROM_FILTER=1:i.endsWith("mitchell")&&(t.MITCHELL_FILTER=1)),t}updateTexture(){const e=this.tex,t=this.parameters.filter;t.startsWith("cubic")?(e.minFilter=re,e.magFilter=re):"linear"===t?(e.minFilter=ae,e.magFilter=ae):(e.minFilter=re,e.magFilter=re),e.needsUpdate=!0,this.pickingTex.needsUpdate=!0}makeMaterial(){super.makeMaterial(),this.updateTexture();const e=this.material;e.uniforms.map.value=this.tex,e.blending=u,e.needsUpdate=!0;const t=this.wireframeMaterial;t.uniforms.map.value=this.tex,t.blending=u,t.needsUpdate=!0;const i=this.pickingMaterial;i.uniforms.map.value=this.tex,i.uniforms.pickingMap.value=this.pickingTex,i.blending=u,i.needsUpdate=!0}setUniforms(e){e&&void 0!==e.filter&&(this.updateTexture(),e.map=this.tex),super.setUniforms(e)}}class dg{constructor(e,t){const i=t||{};this.dimension=Ia(i.dimension,"x"),this.positionType=Ia(i.positionType,"percent"),this.position=Ia(i.position,30),this.thresholdType=Ia(i.thresholdType,"sigma"),this.thresholdMin=Ia(i.thresholdMin,-1/0),this.thresholdMax=Ia(i.thresholdMax,1/0),this.normalize=Ia(i.normalize,!1),this.volume=e}getPositionFromCoordinate(e){const t=this.dimension,i=this.volume,n=i.matrix,r=(new Zt).setFromMatrixPosition(n)[t],s=(new Zt).setFromMatrixScale(n)[t];let o;return o="x"===t?i.nx:"y"===t?i.ny:i.nz,Math.round(((e-r)/(o/100)+1)/s)}getData(e){e=e||{};const t=this.volume,i=t.data,n=t.matrix;let r;function s(e){return Math.round(e/100*(r-1))}function o(e,i,n,r){return 3*(n*t.ny*t.nx+i*t.nx+e)+r}r="coordinate"===this.positionType?this.getPositionFromCoordinate(this.position):this.position;const a=new Float32Array(12),c=new Zt;let l,h,u,d,f,m=0,p=0,g=0,v=t.nx,y=t.ny,x=t.nz;function b(e,t,i,r){c.set(e,t,i).applyMatrix4(n).toArray(a,r)}"x"===this.dimension?(u=s(t.nx),d=t.ny-1,f=t.nz-1,l=t.nz,h=t.ny,m=u,v=m+1,b(u,0,0,0),b(u,d,0,3),b(u,0,f,6),b(u,d,f,9)):"y"===this.dimension?(u=t.nx-1,d=s(t.ny),f=t.nz-1,l=t.nz,h=t.nx,p=d,y=p+1,b(0,d,0,0),b(u,d,0,3),b(0,d,f,6),b(u,d,f,9)):"z"===this.dimension&&(u=t.nx-1,d=t.ny-1,f=s(t.nz),l=t.nx,h=t.ny,g=f,x=g+1,b(0,0,f,0),b(0,d,f,3),b(u,0,f,6),b(u,d,f,9));let _=0,w=0;const S=new Uint8Array(l*h*4),A=new Float32Array(l*h);let M,C;"sigma"===this.thresholdType?(M=t.getValueForSigma(this.thresholdMin),C=t.getValueForSigma(this.thresholdMax)):(M=this.thresholdMin,C=this.thresholdMax);const P=Object.assign({},e.colorParams,{volume:t});this.normalize&&(P.domain=[0,1]);const T=al.getScheme(P),I=new Float32Array(3),E=T.getScale();let D,L=0,R=0;if(this.normalize){L=1/0,D=-1/0;for(let e=p;e<y;++e)for(let t=m;t<v;++t)for(let n=g;n<x;++n){const r=i[o(t,e,n,0)/3];r<L&&(L=r),r>D&&(D=r)}R=D-L}for(let e=p;e<y;++e)for(let t=m;t<v;++t)for(let n=g;n<x;++n){const r=o(t,e,n,0)/3;let s=i[r];this.normalize&&(s=(s-L)/R),T.colorToArray(E(s),I),S[_]=Math.round(255*I[0]),S[_+1]=Math.round(255*I[1]),S[_+2]=Math.round(255*I[2]),S[_+3]=s>M&&s<C?255:0,A[w]=r,++w,_+=4}const k=new _f(A,t);return{position:a,imageData:S,width:l,height:h,picking:k}}}class fg extends tu{constructor(e,t,i){super(e,t,i),this.type="slice",this.parameters=Object.assign({filter:{type:"select",buffer:!0,options:{nearest:"nearest",linear:"linear","cubic-bspline":"cubic-bspline","cubic-catmulrom":"cubic-catmulrom","cubic-mitchell":"cubic-mitchell"}},positionType:{type:"select",rebuild:!0,options:{percent:"percent",coordinate:"coordinate"}},position:{type:"range",step:.1,max:100,min:1,rebuild:!0},dimension:{type:"select",rebuild:!0,options:{x:"x",y:"y",z:"z"}},thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},normalize:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null,linewidth:null,colorScheme:null,roughness:null,metalness:null,diffuse:null}),this.volume=e,this.init(i)}init(e){const t=this.volume,i=e||{};i.colorDomain=Ia(i.colorDomain,[t.min,t.max]),i.colorScheme=Ia(i.colorScheme,"value"),i.colorScale=Ia(i.colorScale,"Spectral"),this.colorScheme="value",this.dimension=Ia(i.dimension,"x"),this.filter=Ia(i.filter,"cubic-bspline"),this.positionType=Ia(i.positionType,"percent"),this.position=Ia(i.position,30),this.thresholdType=Ia(i.thresholdType,"sigma"),this.thresholdMin=Ia(i.thresholdMin,-1/0),this.thresholdMax=Ia(i.thresholdMax,1/0),this.normalize=Ia(i.normalize,!1),super.init(i),this.build()}attach(e){this.bufferList.forEach((e=>{this.viewer.add(e)})),this.setVisibility(this.visible),e()}create(){const e=new dg(this.volume,{positionType:this.positionType,position:this.position,dimension:this.dimension,thresholdType:this.thresholdType,thresholdMin:this.thresholdMin,thresholdMax:this.thresholdMax,normalize:this.normalize}),t=new ug(e.getData({colorParams:this.getColorParams()}),this.getBufferParams({filter:this.filter}));this.bufferList.push(t)}}function mg(e){il.error(`makeRepresentation: representation type ${e} unknown`)}const pg={name:"some element",status:""};class gg{constructor(e,t={}){this.stage=e,this.signals={statusChanged:new mc.Signal,nameChanged:new mc.Signal,disposed:new mc.Signal},this.parameters=Ea(t,this.defaultParameters),this.uuid=ec()}get defaultParameters(){return pg}get name(){return this.parameters.name}setStatus(e){return this.parameters.status=e,this.signals.statusChanged.dispatch(e),this}setName(e){return this.parameters.name=e,this.signals.nameChanged.dispatch(e),this}dispose(){this.signals.disposed.dispatch()}}const vg=Object.assign({visible:!0},pg);class yg extends gg{constructor(e,t,i={},n){super(e,Object.assign({name:t.type},i)),this.parent=n,this.signals=Object.assign({visibilityChanged:new mc.Signal,parametersChanged:new mc.Signal},this.signals),this.setRepresentation(t)}get defaultParameters(){return vg}get visible(){return this.parameters.visible}get type(){return"representation"}getType(){return this.repr.type}setRepresentation(e){this._disposeRepresentation(),this.repr=e,this.stage.tasks.listen(this.repr.tasks),this.updateVisibility()}_disposeRepresentation(){this.repr&&(this.stage.tasks.unlisten(this.repr.tasks),this.repr.dispose())}dispose(){this.parent&&this.parent.hasRepresentation(this)?this.parent.removeRepresentation(this):(this._disposeRepresentation(),this.signals.disposed.dispatch())}setVisibility(e){return this.parameters.visible=e,this.updateVisibility(),this.signals.visibilityChanged.dispatch(this.parameters.visible),this}getVisibility(){return this.parent?this.parent.parameters.visible&&this.parameters.visible:this.parameters.visible}toggleVisibility(){return this.setVisibility(!this.parameters.visible)}updateVisibility(){this.repr.setVisibility(this.getVisibility())}update(e){return this.repr.update(e),this}build(e){return this.repr.build(e),this}setSelection(e){const t=this.repr;return t.setSelection&&t.setSelection(e),this}setParameters(e){return this.repr.setParameters(e),this.signals.parametersChanged.dispatch(this.repr.getParameters()),this}getParameters(){return this.repr.getParameters()}setColor(e){return this.repr.setColor(e),this}}const xg=new ri,bg=new Zt,_g={name:"",status:"",visible:!0};class wg{constructor(e,t,i={}){this.stage=e,this.object=t,this.signals={representationAdded:new mc.Signal,representationRemoved:new mc.Signal,visibilityChanged:new mc.Signal,matrixChanged:new mc.Signal,statusChanged:new mc.Signal,nameChanged:new mc.Signal,disposed:new mc.Signal},this.reprList=[],this.annotationList=[],this.matrix=new ri,this.position=new Zt,this.quaternion=new qt,this.scale=new Zt(1,1,1),this.transform=new ri,this.parameters=Ea(i,this.defaultParameters),this.uuid=ec(),this.viewer=e.viewer,this.controls=new Cm(this)}get defaultParameters(){return _g}get name(){return this.parameters.name}get status(){return this.parameters.status}get visible(){return this.parameters.visible}setPosition(e){return Array.isArray(e)?this.position.fromArray(e):this.position.copy(e),this.updateMatrix(),this}setRotation(e){if(Array.isArray(e))if(3===e.length){const t=(new ai).fromArray(e);this.quaternion.setFromEuler(t)}else this.quaternion.fromArray(e);else e instanceof ai?this.quaternion.setFromEuler(e):this.quaternion.copy(e);return this.updateMatrix(),this}setScale(e){return this.scale.set(e,e,e),this.updateMatrix(),this}setTransform(e){return this.transform.copy(e),this.updateMatrix(),this}updateMatrix(){const e=this.getCenterUntransformed(bg);this.matrix.makeTranslation(-e.x,-e.y,-e.z),xg.makeRotationFromQuaternion(this.quaternion),this.matrix.premultiply(xg),xg.makeScale(this.scale.x,this.scale.y,this.scale.z),this.matrix.premultiply(xg);const t=this.position;xg.makeTranslation(t.x+e.x,t.y+e.y,t.z+e.z),this.matrix.premultiply(xg),this.matrix.premultiply(this.transform),this.updateRepresentationMatrices(),this.stage.viewer.updateBoundingBox(),this.signals.matrixChanged.dispatch(this.matrix)}updateRepresentationMatrices(){this.reprList.forEach((e=>{e.setParameters({matrix:this.matrix})}))}addAnnotation(e,t,i){const n=new wm(this,e,t,i);return this.annotationList.push(n),n}eachAnnotation(e){this.annotationList.slice().forEach(e)}removeAnnotation(e){const t=this.annotationList.indexOf(e);-1!==t&&(this.annotationList.splice(t,1),e.dispose())}removeAllAnnotations(){this.eachAnnotation((e=>e.dispose())),this.annotationList.length=0}_addRepresentation(t,i,n,r=!1){const s=n||{},o=this.stage.getParameters();s.matrix=this.matrix.clone(),s.quality=s.quality||o.quality,s.disableImpostor=Ia(s.disableImpostor,!o.impostor),s.useWorker=Ia(s.useWorker,o.workerDefault),s.visible=Ia(s.visible,!0);const a=Object.assign({},s,{visible:this.parameters.visible&&s.visible}),c=function(t,i,n,r){var s;if(e.Debug&&il.time("makeRepresentation "+t),i instanceof Fp){if(!(s=ll.get(t)))return void mg(t)}else if(i instanceof Xf)if("surface"===t)s=lm;else{if("dot"!==t)return void mg(t);s=og}else if(i instanceof Zf)if("surface"===t)s=lm;else if("dot"===t)s=og;else{if("slice"!==t)return void mg(t);s=fg}else if(i instanceof Gp)s=Vp,i=i.getBufferList();else{if("buffer"!==t)return void il.error("makeRepresentation: object "+i+" unknown");s=Vp}const o=new s(i,n,r);return e.Debug&&il.timeEnd("makeRepresentation "+t),o}(t,i,this.viewer,a),l=new yg(this.stage,c,s,this);return r||(this.reprList.push(l),this.signals.representationAdded.dispatch(l)),l}addBufferRepresentation(e,t){return this._addRepresentation.call(this,"buffer",e,t)}hasRepresentation(e){return-1!==this.reprList.indexOf(e)}eachRepresentation(e){this.reprList.slice().forEach(e)}removeRepresentation(e){const t=this.reprList.indexOf(e);-1!==t&&(this.reprList.splice(t,1),e.dispose(),this.signals.representationRemoved.dispatch(e))}updateRepresentations(e){this.reprList.forEach((t=>t.update(e))),this.stage.viewer.requestRender()}removeAllRepresentations(){this.eachRepresentation((e=>e.dispose()))}dispose(){this.removeAllAnnotations(),this.removeAllRepresentations(),this.reprList.length=0,this.signals.disposed.dispatch()}setVisibility(e){return this.parameters.visible=e,this.eachRepresentation((e=>e.updateVisibility())),this.eachAnnotation((e=>e.updateVisibility())),this.signals.visibilityChanged.dispatch(e),this}setStatus(e){return this.parameters.status=e,this.signals.statusChanged.dispatch(e),this}setName(e){return this.parameters.name=e,this.signals.nameChanged.dispatch(e),this}getBox(...e){return this.getBoxUntransformed(...e).clone().applyMatrix4(this.matrix)}getCenter(...e){return this.getCenterUntransformed(...e).clone().applyMatrix4(this.matrix)}getZoom(...e){return this.stage.getZoomForBox(this.getBox(...e))}getBoxUntransformed(...e){return new Ni}getCenterUntransformed(...e){return this.getBoxUntransformed().getCenter(new Zt)}autoView(e){this.stage.animationControls.zoomMove(this.getCenter(),this.getZoom(),Ia(e,0))}}class Sg{constructor(e=[]){this.list=e;const t=e.length;for(let i=0;i<t;++i){e[i].signals.disposed.add(this._remove,this)}}_remove(e){const t=this.list.indexOf(e);-1!==t&&this.list.splice(t,1)}get first(){return this.list.length>0?this.list[0]:void 0}forEach(e){return this.list.forEach(e),this}dispose(){return this.forEach((e=>e.dispose()))}}class Ag extends Sg{setParameters(e){return this.forEach((t=>t.setParameters(e)))}setVisibility(e){return this.forEach((t=>t.setVisibility(e)))}setSelection(e){return this.forEach((t=>t.setSelection(e)))}setColor(e){return this.forEach((t=>t.setColor(e)))}update(e){return this.forEach((t=>t.update(e)))}build(e){return this.forEach((t=>t.build(e)))}dispose(e){return this.forEach((e=>e.dispose()))}}const Mg=Object.assign({defaultStep:1,defaultTimeout:50,defaultInterpolateType:"",defaultInterpolateStep:5,defaultMode:"loop",defaultDirection:"forward",initialFrame:0},pg);class Cg extends gg{constructor(e,t,i={}){super(e,Object.assign({name:t.name},i)),this.trajectory=t,this.signals=Object.assign(this.signals,{frameChanged:new mc.Signal,playerChanged:new mc.Signal,countChanged:new mc.Signal,parametersChanged:new mc.Signal}),t.signals.frameChanged.add((e=>{this.signals.frameChanged.dispatch(e)})),t.signals.playerChanged.add((e=>{this.signals.playerChanged.dispatch(e)})),t.signals.countChanged.add((e=>{this.signals.countChanged.dispatch(e)})),void 0!==i.initialFrame&&this.setFrame(i.initialFrame)}get defaultParameters(){return Mg}get type(){return"trajectory"}setFrame(e){this.trajectory.setFrame(e)}setParameters(e={}){this.trajectory.setParameters(e),this.signals.parametersChanged.dispatch(e)}dispose(){this.trajectory.dispose(),super.dispose()}}class Pg{constructor(e,t){this.name=e,this.path=t,this.coordinates=[],this.boxes=[],this.times=[],this.timeOffset=0,this.deltaTime=1}get type(){return"Frames"}}class Tg{constructor(e,t){let i,n;if(this.A=new Mf(3,3),this.W=new Mf(1,3),this.U=new Mf(3,3),this.V=new Mf(3,3),this.VH=new Mf(3,3),this.R=new Mf(3,3),this.tmp=new Mf(3,3),this.c=new Mf(3,3),e instanceof Fp)i=e.atomCount;else{if(!(e instanceof Float32Array))return;i=e.length/3}if(t instanceof Fp)n=t.atomCount;else{if(!(t instanceof Float32Array))return;n=t.length/3}const r=Math.min(i,n),s=new Mf(3,r),o=new Mf(3,r);this.coords1t=new Mf(r,3),this.coords2t=new Mf(r,3),this.transformationMatrix=new ri,this.c.data.set([1,0,0,0,1,0,0,0,-1]),this.prepCoords(e,s,r,!1),this.prepCoords(t,o,r,!1),this._superpose(s,o)}_superpose(t,i){this.mean1=If(t),this.mean2=If(i),Ef(t,this.mean1),Ef(i,this.mean2),Cf(this.coords1t,t),Cf(this.coords2t,i),Pf(this.A,this.coords2t,this.coords1t),Of(this.A,this.W,this.U,this.V),function(e,t){const i=e.data,n=t.data,r=i[4],s=i[8],o=i[5],a=i[7],c=i[0],l=c*r,h=c*o,u=i[3],d=i[1],f=u*d,m=i[2],p=u*m,g=i[6],v=g*d,y=g*m,x=1/(l*s-h*a-f*s+p*a+v*o-y*r);n[0]=(r*s-o*a)*x,n[1]=-(d*s-m*a)*x,n[2]=-(-d*o+m*r)*x,n[3]=-(u*s-o*g)*x,n[4]=(c*s-y)*x,n[5]=-(h-p)*x,n[6]=-(-u*a+r*g)*x,n[7]=-(c*a-v)*x,n[8]=(l-f)*x}(this.V,this.VH),Tf(this.R,this.U,this.VH),function(e){const t=e.data;return t[0]*t[4]*t[8]-t[0]*t[5]*t[7]-t[3]*t[1]*t[8]+t[3]*t[2]*t[7]+t[6]*t[1]*t[5]-t[6]*t[2]*t[4]}(this.R)<0&&(e.Debug&&il.log("R not a right handed system"),Tf(this.tmp,this.c,this.VH),Tf(this.R,this.U,this.tmp));const n=new Mf(4,4),r=new Mf(4,4),s=new Mf(4,4),o=new Mf(4,4),a=new Mf(4,4),c=new Mf(4,4),l=this.R.data,h=this.mean1,u=this.mean2;o.data.set([1,0,0,-h[0],0,1,0,-h[1],0,0,1,-h[2],0,0,0,1]),a.data.set([l[0],l[1],l[2],0,l[3],l[4],l[5],0,l[6],l[7],l[8],0,0,0,0,1]),c.data.set([1,0,0,u[0],0,1,0,u[1],0,0,1,u[2],0,0,0,1]),Cf(r,o),Pf(n,a,r),Cf(s,n),Pf(r,c,s),Cf(n,r),this.transformationMatrix.elements=n.data}prepCoords(e,t,i,n){let r=0;const s=t.data;let o=3,a=3*i;if(n&&(a=4*i,o=4),e instanceof Fp)e.eachAtom((function(e){r<a&&(s[r+0]=e.x,s[r+1]=e.y,s[r+2]=e.z,n&&(s[r+3]=1),r+=o)}));else if(e instanceof Float32Array)for(;r<a;r+=o)r<a&&(s[r]=e[r],s[r+1]=e[r+1],s[r+2]=e[r+2],n&&(s[r+3]=1));else il.warn("prepCoords: input type unknown")}transform(e){let t;if(e instanceof Fp)t=e.atomCount;else{if(!(e instanceof Float32Array))return;t=e.length/3}const i=new Mf(4,t),n=new Mf(t,4);this.prepCoords(e,i,t,!0);const r=this.transformationMatrix,s=r.determinant();if(!s)return s;const o=new Mf(4,4);o.data=r.elements,function(e,t,i){let n=0,r=0,s=0,o=0,a=0,c=0,l=0,h=0;const u=t.cols,d=t.rows,f=i.cols,m=t.data,p=i.data,g=e.data;let v=0;for(;n<d;o+=u,n++)for(l=0,r=0;r<f;h++,l++,r++){for(c=l,a=o,v=0,s=0;s<u;a++,c+=f,s++)v+=m[a]*p[c];g[h]=v}}(n,i,o);let a=0;const c=n.data;if(e instanceof Fp){e.eachAtom((function(e){e.x=c[a],e.y=c[a+1],e.z=c[a+2],a+=4}));const t=new ri;t.getInverse(r);const i=e.biomolDict;for(let e in i)if(i.hasOwnProperty(e)){i[e].partList.forEach((function(e){e.matrixList.forEach((function(e){e.premultiply(r),e.multiply(t)}))}))}}else if(e instanceof Float32Array){const i=4*t;for(;a<i;a+=4)e[a]=c[a],e[a+1]=c[a+1],e[a+2]=c[a+2]}else il.warn("transform: input type unknown");return this.transformationMatrix}}const Ig={step:1,timeout:50,start:0,end:0,interpolateType:"",interpolateStep:5,mode:"loop",direction:"forward"};class Eg{constructor(e,t={}){this.signals={startedRunning:new mc.Signal,haltedRunning:new mc.Signal},this._run=!1,this._previousTime=0,this._currentTime=0,this._currentStep=1,e.signals.playerChanged.add((e=>{e!==this&&this.pause()}),this);const i=Ia(e.frameCount,1);this.traj=e,this.parameters=Ea(t,Ig),this.parameters.end=Math.min(Ia(t.end,i-1),i-1),this.parameters.step=Ia(t.step,Math.ceil((i+1)/100)),this._currentFrame=this.parameters.start,this._direction="bounce"===this.parameters.direction?"forward":this.parameters.direction,e.signals.countChanged.add((e=>{this.parameters.end=Math.min(Ia(this.parameters.end,e-1),e-1)}),this),this._animate=this._animate.bind(this)}get isRunning(){return this._run}setParameters(e={}){Da(this.parameters,e),void 0!==e.direction&&"bounce"!==this.parameters.direction&&(this._direction=this.parameters.direction)}_animate(){if(!this._run)return;this._currentTime=window.performance.now();const e=this._currentTime-this._previousTime,t=this.parameters.interpolateType?this.parameters.interpolateStep:1,i=this.parameters.timeout/t,n=this.traj;if(n&&n.frameCount&&!n.inProgress&&e>=i)if(this.parameters.interpolateType)if(this._currentStep>this.parameters.interpolateStep&&(this._currentStep=1),1===this._currentStep&&(this._currentFrame=this._nextInterpolated()),n.hasFrame(this._currentFrame)){this._currentStep+=1;const e=this._currentStep/(this.parameters.interpolateStep+1),[t,i,r,s]=this._currentFrame;n.setFrameInterpolated(t,i,r,s,e,this.parameters.interpolateType),this._previousTime=this._currentTime}else n.loadFrame(this._currentFrame);else{const e=this._next();n.hasFrame(e)?(n.setFrame(e),this._previousTime=this._currentTime):n.loadFrame(e)}window.requestAnimationFrame(this._animate)}_next(){const e=this.parameters;let t;return t="forward"===this._direction?this.traj.currentFrame+e.step:this.traj.currentFrame-e.step,(t>e.end||t<e.start)&&("bounce"===e.direction&&("forward"===this._direction?this._direction="backward":this._direction="forward"),"once"===e.mode?(this.pause(),t="forward"===e.direction?e.end:"backward"===e.direction||"forward"===this._direction?e.start:e.end):"forward"===this._direction?(t=e.start,e.interpolateType&&(t=Math.min(e.end,t+e.step))):(t=e.end,e.interpolateType&&(t=Math.max(e.start,t-e.step)))),t}_nextInterpolated(){const e=this.parameters,t=this._next();let i,n,r;return"forward"===this._direction?(i=Math.max(e.start,t-e.step),n=Math.max(e.start,t-2*e.step),r=Math.max(e.start,t-3*e.step)):(i=Math.min(e.end,t+e.step),n=Math.min(e.end,t+2*e.step),r=Math.min(e.end,t+3*e.step)),[t,i,n,r]}toggle(){this._run?this.pause():this.play()}play(){if(!this._run){this.traj.player!==this&&this.traj.setPlayer(this),this._currentStep=1;const e=this.parameters,t=this.traj.currentFrame;let i=Math.ceil(t/e.step)*e.step;"forward"===e.direction&&t>=e.end?i=e.start:"backward"===e.direction&&t<=e.start&&(i=e.end),this.traj.setFrame(i),this._run=!0,this._animate(),this.signals.startedRunning.dispatch()}}pause(){this._run=!1,this.signals.haltedRunning.dispatch()}stop(){this.pause(),this.traj.setFrame(this.parameters.start)}}class Dg{constructor(e,t,i={}){this.signals={countChanged:new mc.Signal,frameChanged:new mc.Signal,playerChanged:new mc.Signal},this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this._frameCount=0,this._currentFrame=-1,this._disposed=!1,this.deltaTime=Ia(i.deltaTime,0),this.timeOffset=Ia(i.timeOffset,0),this.centerPbc=Ia(i.centerPbc,!1),this.removePbc=Ia(i.removePbc,!1),this.removePeriodicity=Ia(i.removePeriodicity,!1),this.superpose=Ia(i.superpose,!1),this.name=e.replace(/^.*[\\/]/,""),this.trajPath=e,this.selection=new $c(Ia(i.sele,"backbone and not hydrogen")),this.selection.signals.stringChanged.add((()=>{this.selectionIndices=this.structure.getAtomIndices(this.selection),this._resetCache(),this._saveInitialCoords(),this.setFrame(this._currentFrame)}))}get frameCount(){return this._frameCount}get currentFrame(){return this._currentFrame}_init(e){this.setStructure(e),this._loadFrameCount(),this.setPlayer(new Eg(this))}_loadFrameCount(){}setStructure(e){this.structure=e,this.atomCount=e.atomCount,this.backboneIndices=this._getIndices(new $c("backbone and not hydrogen")),this._makeAtomIndices(),this._saveStructureCoords(),this.selectionIndices=this._getIndices(this.selection),this._resetCache(),this._saveInitialCoords(),this.setFrame(this._currentFrame)}_saveInitialCoords(){this.structure.hasCoords()?(this.initialCoords=new Float32Array(this.structureCoords),this._makeSuperposeCoords()):this.frameCache[0]?(this.initialCoords=new Float32Array(this.frameCache[0]),this._makeSuperposeCoords()):this.loadFrame(0,(()=>this._saveInitialCoords()))}_saveStructureCoords(){this.structureCoords=this.structure.getAtomData({what:{position:!0}}).position}setSelection(e){return this.selection.setString(e),this}_getIndices(e){let t=0;const i=e.test,n=[];return i&&this.structure.eachAtom((e=>{i(e)&&n.push(t),t+=1})),n}_makeSuperposeCoords(){const e=3*this.selectionIndices.length;this.coords1=new Float32Array(e),this.coords2=new Float32Array(e);const t=this.initialCoords,i=this.coords2;for(let n=0;n<e;n+=3){const e=3*this.selectionIndices[n/3];i[n+0]=t[e+0],i[n+1]=t[e+1],i[n+2]=t[e+2]}}_makeAtomIndices(){il.error("Trajectory._makeAtomIndices not implemented")}_resetCache(){this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this.initialCoords=new Float32Array(0)}setParameters(e={}){let t=!1;void 0!==e.centerPbc&&e.centerPbc!==this.centerPbc&&(this.centerPbc=e.centerPbc,t=!0),void 0!==e.removePeriodicity&&e.removePeriodicity!==this.removePeriodicity&&(this.removePeriodicity=e.removePeriodicity,t=!0),void 0!==e.removePbc&&e.removePbc!==this.removePbc&&(this.removePbc=e.removePbc,t=!0),void 0!==e.superpose&&e.superpose!==this.superpose&&(this.superpose=e.superpose,t=!0),this.deltaTime=Ia(e.deltaTime,this.deltaTime),this.timeOffset=Ia(e.timeOffset,this.timeOffset),t&&(this._resetCache(),this.setFrame(this._currentFrame))}hasFrame(e){return Array.isArray(e)?e.every((e=>!!this.frameCache[e])):!!this.frameCache[e]}setFrame(e,t){return void 0===e||(this.inProgress=!0,-1===e||this.frameCache[e]?(this._updateStructure(e),t&&t()):this.loadFrame(e,(()=>{this._updateStructure(e),t&&t()}))),this}_interpolate(e,t,i,n,r,s){const o=this.frameCache;let a;a="spline"===s?function(e,t,i,n,r){const s=e.length,o=new Float32Array(s);for(let a=0;a<s;a+=3){const s=a+1,c=a+2;o[a]=nc(n[a],i[a],t[a],e[a],r,1),o[s]=nc(n[s],i[s],t[s],e[s],r,1),o[c]=nc(n[c],i[c],t[c],e[c],r,1)}return o}(o[e],o[t],o[i],o[n],r):function(e,t,i){const n=e.length,r=new Float32Array(n);for(let s=0;s<n;s+=3){const n=s+1,o=s+2;r[s]=ic(t[s],e[s],i),r[n]=ic(t[n],e[n],i),r[o]=ic(t[o],e[o],i)}return r}(o[e],o[t],r),this.structure.updatePosition(a),this._currentFrame=e,this.signals.frameChanged.dispatch(e)}setFrameInterpolated(e,t,i,n,r,s,o){if(void 0===e)return this;const a=this.frameCache,c=[];return a[n]||c.push(n),a[i]||c.push(i),a[t]||c.push(t),a[e]||c.push(e),c.length?this.loadFrame(c,(()=>{this._interpolate(e,t,i,n,r,s),o&&o()})):(this._interpolate(e,t,i,n,r,s),o&&o()),this}loadFrame(e,t){Array.isArray(e)?e.forEach((e=>{this.loadQueue[e]||this.frameCache[e]||(this.loadQueue[e]=!0,this._loadFrame(e,(()=>{delete this.loadQueue[e]})))})):this.loadQueue[e]||this.frameCache[e]||(this.loadQueue[e]=!0,this._loadFrame(e,(()=>{delete this.loadQueue[e],t&&t()})))}_loadFrame(e,t){il.error("Trajectory._loadFrame not implemented",e,t)}_updateStructure(e){this._disposed?console.error("updateStructure: traj disposed"):(-1===e?this.structureCoords&&this.structure.updatePosition(this.structureCoords):this.structure.updatePosition(this.frameCache[e]),this.structure.trajectory={name:this.trajPath,frame:e},this._currentFrame=e,this.inProgress=!1,this.signals.frameChanged.dispatch(e))}_doSuperpose(e){const t=3*this.selectionIndices.length,i=this.coords1,n=this.coords2;for(let n=0;n<t;n+=3){const t=3*this.selectionIndices[n/3];i[n+0]=e[t+0],i[n+1]=e[t+1],i[n+2]=e[t+2]}new Tg(i,n).transform(e)}_process(e,t,i,n){if(this._setFrameCount(n),t){if(this.backboneIndices.length>0&&this.centerPbc){const e=[t[0],t[4],t[8]],n=function(e,t,i){return[zl(t,i[0],3,0,e),zl(t,i[1],3,1,e),zl(t,i[2],3,2,e)]}(this.backboneIndices,i,e);!function(e,t,i){if(0===i[0]||0===i[8]||0===i[4])return;const n=e.length,r=i[0],s=i[1],o=i[2],a=-t[0]+r+r/2,c=-t[1]+s+s/2,l=-t[2]+o+o/2;for(let t=0;t<n;t+=3)e[t+0]=(e[t+0]+a)%r,e[t+1]=(e[t+1]+c)%s,e[t+2]=(e[t+2]+l)%o}(i,n,e)}if(this.removePeriodicity){const e=function(e){return[Ql(e,3,0),Ql(e,3,1),Ql(e,3,2)]}(i);!function(e,t,i){if(0===t[0]||0===t[8]||0===t[4])return;const n=e.length;for(let r=3;r<n;r+=3)for(let n=0;n<3;++n){const s=(e[r+n]-i[n])/t[3*n+n];Math.abs(s)>.5&&(e[r+n]-=t[3*n+n]*Math.round(s))}}(i,t,e)}this.removePbc&&function(e,t){if(0===t[0]||0===t[8]||0===t[4])return;const i=e.length;for(let n=3;n<i;n+=3)for(let i=0;i<3;++i){const r=e[n+i]-e[n-3+i];if(Math.abs(r)>.9*t[3*i+i])if(r>0)for(let r=0;r<3;++r)e[n+r]-=t[3*i+r];else for(let r=0;r<3;++r)e[n+r]+=t[3*i+r]}}(i,t)}this.selectionIndices.length>0&&this.coords1&&this.superpose&&this._doSuperpose(i),this.frameCache[e]=i,this.boxCache[e]=t,this.frameCacheSize+=1}_setFrameCount(e){e!==this._frameCount&&(this._frameCount=e,this.signals.countChanged.dispatch(e))}dispose(){this._resetCache(),this._disposed=!0,this.player&&this.player.stop()}setPlayer(e){this.player=e,this.signals.playerChanged.dispatch(e)}getFrameTime(e){return this.timeOffset+e*this.deltaTime}}class Lg extends Dg{constructor(e,t,i){const n=i||{};n.timeOffset=Ia(n.timeOffset,e.timeOffset),n.deltaTime=Ia(n.deltaTime,e.deltaTime),super("",t,n),this.name=e.name,this.path=e.path,this.frames=e.coordinates,this.boxes=e.boxes,this._init(t)}get type(){return"frames"}_makeAtomIndices(){"StructureView"===this.structure.type?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0}_loadFrame(e,t){let i;const n=this.frames[e];if(this.atomIndices){const e=this.atomIndices,t=e.length;i=new Float32Array(3*t);for(let r=0;r<t;++r){const t=3*r,s=3*e[r];i[t+0]=n[s+0],i[t+1]=n[s+1],i[t+2]=n[s+2]}}else i=new Float32Array(n);const r=this.boxes[e],s=this.frames.length;this._process(e,r,i,s),"function"==typeof t&&t()}_loadFrameCount(){this.frames&&this._setFrameCount(this.frames.length)}}class Rg extends Dg{constructor(e,t,i){super("",t,i),this._init(t)}get type(){return"structure"}_makeAtomIndices(){this.structure.atomSet&&this.structure.atomSet.getSize()<this.structure.atomStore.count?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0}_loadFrame(e,t){let i;const n=this.structure,r=n.frames[e];if(this.atomIndices){const e=this.atomIndices,t=e.length;i=new Float32Array(3*t);for(let n=0;n<t;++n){const t=3*n,s=3*e[n];i[t+0]=r[s+0],i[t+1]=r[s+1],i[t+2]=r[s+2]}}else i=new Float32Array(r);const s=n.boxes[e],o=n.frames.length;this._process(e,s,i,o),"function"==typeof t&&t()}_loadFrameCount(){this._setFrameCount(this.structure.frames.length)}}class kg extends Dg{constructor(e,t,i){super(e,t,i),this._init(t)}get type(){return"remote"}_makeAtomIndices(){const e=[];if("StructureView"===this.structure.type){const t=this.structure.getAtomIndices(),i=t.length;let n=t[0],r=t[0];for(let s=1;s<i;++s){const i=t[s];r+1<i&&(e.push([n,r+1]),n=i),r=i}e.push([n,r+1])}else e.push([0,this.atomCount]);this.atomIndices=e}_loadFrame(t,i){const n=new XMLHttpRequest,r=e.TrajectoryDatasource.getFrameUrl(this.trajPath,t),s=e.TrajectoryDatasource.getFrameParams(this.trajPath,this.atomIndices);n.open("POST",r,!0),n.responseType="arraybuffer",n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.addEventListener("load",(()=>{const e=n.response;if(!e)return void il.error(`empty arrayBuffer for '${r}'`);const s=new Int32Array(e,0,1)[0],o=new Float32Array(e,8,9),a=new Float32Array(e,44);this._process(t,o,a,s),"function"==typeof i&&i()}),!1),n.send(s)}_loadFrameCount(){const t=new XMLHttpRequest,i=e.TrajectoryDatasource.getCountUrl(this.trajPath);t.open("GET",i,!0),t.addEventListener("load",(()=>{this._setFrameCount(parseInt(t.response))}),!1),t.send()}}class Og extends Dg{constructor(e,t,i){super("",t,i),this.requestCallback=e,this._init(t)}get type(){return"callback"}_makeAtomIndices(){const e=[];if("StructureView"===this.structure.type){const t=this.structure.getAtomIndices(),i=t.length;let n=t[0],r=t[0];for(let s=1;s<i;++s){const i=t[s];r+1<i&&(e.push([n,r+1]),n=i),r=i}e.push([n,r+1])}else e.push([0,this.atomCount]);this.atomIndices=e}_loadFrame(e,t){this.requestCallback(((e,i,n,r)=>{this._process(e,i,n,r),"function"==typeof t&&t()}),e,this.atomIndices)}_loadFrameCount(){this.requestCallback((e=>this._setFrameCount(e)))}}Fp.prototype.getView=function(e){return new Bg(this,e)};class Bg extends Fp{constructor(e,t){super(),this.structure=e,this.selection=t,this.center=new Zt,this.boundingBox=new Ni,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy(),this.selection&&this.selection.signals.stringChanged.add(this.refresh,this),this.structure.signals.refreshed.add(this.refresh,this),this.refresh()}init(){}get type(){return"StructureView"}get name(){return this.structure.name}get path(){return this.structure.path}get title(){return this.structure.title}get id(){return this.structure.id}get data(){return this.structure.data}get atomSetDict(){return this.structure.atomSetDict}get biomolDict(){return this.structure.biomolDict}get entityList(){return this.structure.entityList}get unitcell(){return this.structure.unitcell}get frames(){return this.structure.frames}get boxes(){return this.structure.boxes}get validation(){return this.structure.validation}get bondStore(){return this.structure.bondStore}get backboneBondStore(){return this.structure.backboneBondStore}get rungBondStore(){return this.structure.rungBondStore}get atomStore(){return this.structure.atomStore}get residueStore(){return this.structure.residueStore}get chainStore(){return this.structure.chainStore}get modelStore(){return this.structure.modelStore}get atomMap(){return this.structure.atomMap}get residueMap(){return this.structure.residueMap}get bondHash(){return this.structure.bondHash}get spatialHash(){return this.structure.spatialHash}get _hasCoords(){return this.structure._hasCoords}set _hasCoords(e){this.structure._hasCoords=e}refresh(){e.Debug&&il.time("StructureView.refresh"),this.atomSetCache={};const t=this.structure;if(this.selection.isAllSelection()&&t!==this&&t.atomSet&&t.bondSet){this.atomSet=t.atomSet.clone(),this.bondSet=t.bondSet.clone();for(let e in this.atomSetDict){const t=this.atomSetDict[e];this.atomSetCache["__"+e]=t.clone()}this.atomCount=t.atomCount,this.bondCount=t.bondCount,this.boundingBox.copy(t.boundingBox),this.center.copy(t.center)}else if(this.selection.isNoneSelection()&&t!==this&&t.atomSet&&t.bondSet){this.atomSet=new Yu(t.atomCount),this.bondSet=new Yu(t.bondCount);for(let e in this.atomSetDict)this.atomSetCache["__"+e]=new Yu(t.atomCount);this.atomCount=0,this.bondCount=0,this.boundingBox.makeEmpty(),this.center.set(0,0,0)}else{this.atomSet=this.getAtomSet(this.selection,!0),t.atomSet&&(this.atomSet=this.atomSet.intersection(t.atomSet)),this.bondSet=this.getBondSet();for(let e in this.atomSetDict){const t=this.atomSetDict[e];this.atomSetCache["__"+e]=t.makeIntersection(this.atomSet)}this.atomCount=this.atomSet.getSize(),this.bondCount=this.bondSet.getSize(),this.boundingBox=this.getBoundingBox(),this.center=this.boundingBox.getCenter(new Zt)}e.Debug&&il.timeEnd("StructureView.refresh"),this.signals.refreshed.dispatch()}setSelection(e){this.selection=e,this.refresh()}getSelection(e){const t=[];e&&e.string&&t.push(e.string);const i=this.structure.getSelection();i&&i.string&&t.push(i.string),this.selection&&this.selection.string&&t.push(this.selection.string);let n="";return t.length>0&&(n=`( ${t.join(" ) AND ( ")} )`),new $c(n)}getStructure(){return this.structure.getStructure()}eachBond(e,t){this.structure.eachBond(e,this.getSelection(t))}eachAtom(e,t){const i=this.getAtomProxy(),n=this.getAtomSet(t),r=this.atomStore.count;if(n.getSize()<r)n.forEach((function(t){i.index=t,e(i)}));else for(let t=0;t<r;++t)i.index=t,e(i)}eachResidue(e,t){this.structure.eachResidue(e,this.getSelection(t))}eachResidueN(e,t){console.error("StructureView.eachResidueN() not implemented")}eachChain(e,t){this.structure.eachChain(e,this.getSelection(t))}eachModel(e,t){this.structure.eachModel(e,this.getSelection(t))}getAtomSet(e,t=!1){let i=this.structure.getAtomSet(e);return!t&&this.atomSet&&(i=i.makeIntersection(this.atomSet)),i}getAtomIndices(e){return this.structure.getAtomIndices(this.getSelection(e))}refreshPosition(){return this.structure.refreshPosition()}dispose(){this.selection&&this.selection.signals.stringChanged.remove(this.refresh,this),this.structure.signals.refreshed.remove(this.refresh,this),this.structure=new Fp,delete this.atomSet,delete this.bondSet}}const Ng=[[4,0,-2,-1,-2,0,-2,-1,-1,-1,-1,-2,-1,-1,-1,1,0,0,-3,-2],[0,9,-3,-4,-2,-3,-3,-1,-3,-1,-1,-3,-3,-3,-3,-1,-1,-1,-2,-2],[-2,-3,6,2,-3,-1,-1,-3,-1,-4,-3,1,-1,0,-2,0,-1,-3,-4,-3],[-1,-4,2,5,-3,-2,0,-3,1,-3,-2,0,-1,2,0,0,-1,-2,-3,-2],[-2,-2,-3,-3,6,-3,-1,0,-3,0,0,-3,-4,-3,-3,-2,-2,-1,1,3],[0,-3,-1,-2,-3,6,-2,-4,-2,-4,-3,0,-2,-2,-2,0,-2,-3,-2,-3],[-2,-3,-1,0,-1,-2,8,-3,-1,-3,-2,1,-2,0,0,-1,-2,-3,-2,2],[-1,-1,-3,-3,0,-4,-3,4,-3,2,1,-3,-3,-3,-3,-2,-1,3,-3,-1],[-1,-3,-1,1,-3,-2,-1,-3,5,-2,-1,0,-1,1,2,0,-1,-2,-3,-2],[-1,-1,-4,-3,0,-4,-3,2,-2,4,2,-3,-3,-2,-2,-2,-1,1,-2,-1],[-1,-1,-3,-2,0,-3,-2,1,-1,2,5,-2,-2,0,-1,-1,-1,1,-1,-1],[-2,-3,1,0,-3,0,1,-3,0,-3,-2,6,-2,0,0,1,0,-3,-4,-2],[-1,-3,-1,-1,-4,-2,-2,-3,-1,-3,-2,-2,7,-1,-2,-1,-1,-2,-4,-3],[-1,-3,0,2,-3,-2,0,-3,1,-2,0,0,-1,5,1,0,-1,-2,-2,-1],[-1,-3,-2,0,-3,-2,0,-3,2,-2,-1,0,-2,1,5,-1,-1,-3,-3,-2],[1,-1,0,0,-2,0,-1,-2,0,-2,-1,1,-1,0,-1,4,1,-2,-3,-2],[0,-1,-1,-1,-2,-2,-2,-1,-1,-1,-1,0,-1,-1,-1,1,5,0,-2,-2],[0,-1,-3,-2,-1,-3,-3,3,-2,1,1,-3,-2,-2,-3,-2,0,4,-3,-1],[-3,-2,-4,-3,1,-2,-2,-3,-3,-2,-1,-4,-4,-2,-3,-3,-2,-3,11,2],[-2,-2,-3,-2,3,-3,2,-1,-2,-1,-1,-2,-3,-1,-2,-2,-2,-1,2,7]];function Fg(e,t){let i,n=0;const r={};return t.forEach((function(t){i=0;const s={};t.forEach((function(t){s[e[i++]]=t})),r[e[n++]]=s})),r}const zg={blosum62:Fg("ARNDCQEGHILKMFPSTWYVBZ?",[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1]]),blosum62x:Fg("ACDEFGHIKLMNPQRSTVWY",Ng)};class Ug{constructor(e,t,i=-10,n=-1,r="blosum62"){this.seq1=e,this.seq2=t,this.gapPenalty=i,this.gapExtensionPenalty=n,r&&(this.substMatrix=zg[r])}initMatrices(){this.n=this.seq1.length,this.m=this.seq2.length,this.score=void 0,this.ali="",this.S=[],this.V=[],this.H=[];for(let e=0;e<=this.n;++e){this.S[e]=[],this.V[e]=[],this.H[e]=[];for(let t=0;t<=this.m;++t)this.S[e][t]=0,this.V[e][t]=0,this.H[e][t]=0}for(let e=0;e<=this.n;++e)this.S[e][0]=this.gap(0),this.H[e][0]=-1/0;for(let e=0;e<=this.m;++e)this.S[0][e]=this.gap(0),this.V[0][e]=-1/0;this.S[0][0]=0}gap(e){return this.gapPenalty+e*this.gapExtensionPenalty}makeScoreFn(){const e=this.seq1,t=this.seq2,i=this.substMatrix;return i?function(n,r){const s=e[n],o=t[r];try{return i[s][o]}catch(e){return-4}}:(il.warn("Alignment: no subst matrix"),function(i,n){return e[i]===t[n]?5:-3})}calc(){e.Debug&&il.time("Alignment.calc"),this.initMatrices();const t=this.gap(0),i=this.makeScoreFn(),n=this.gapExtensionPenalty,r=this.V,s=this.H,o=this.S,a=this.n,c=this.m;let l,h,u,d,f;for(let e=1;e<=a;++e){h=o[e-1],l=r[e-1],u=r[e],d=s[e],f=o[e];for(let r=1;r<=c;++r)u[r]=Math.max(h[r]+t,l[r]+n),d[r]=Math.max(f[r-1]+t,d[r-1]+n),f[r]=Math.max(h[r-1]+i(e-1,r-1),u[r],d[r])}e.Debug&&il.timeEnd("Alignment.calc"),e.Debug&&il.log(this.S,this.V,this.H)}trace(){e.Debug&&il.time("Alignment.trace"),this.ali1="",this.ali2="";const t=this.makeScoreFn();let i,n=this.n,r=this.m;for(this.S[n][r]>=this.V[n][r]?(i="S",this.score=this.S[n][r]):this.V[n][r]>=this.H[n][r]?(i="V",this.score=this.V[n][r]):(i="H",this.score=this.H[n][r]),e.Debug&&il.log("Alignment: SCORE",this.score),e.Debug&&il.log("Alignment: S, V, H",this.S[n][r],this.V[n][r],this.H[n][r]);n>0&&r>0;)"S"===i?this.S[n][r]===this.S[n-1][r-1]+t(n-1,r-1)?(this.ali1=this.seq1[n-1]+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--n,--r,i="S"):this.S[n][r]===this.V[n][r]?i="V":this.S[n][r]===this.H[n][r]?i="H":(--n,--r):"V"===i?this.V[n][r]===this.V[n-1][r]+this.gapExtensionPenalty?(this.ali1=this.seq1[n-1]+this.ali1,this.ali2="-"+this.ali2,--n,i="V"):this.V[n][r]===this.S[n-1][r]+this.gap(0)?(this.ali1=this.seq1[n-1]+this.ali1,this.ali2="-"+this.ali2,--n,i="S"):--n:"H"===i?this.H[n][r]===this.H[n][r-1]+this.gapExtensionPenalty?(this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r,i="H"):this.H[n][r]===this.S[n][r-1]+this.gap(0)?(this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r,i="S"):--r:il.error("Alignment: no matrix");for(;n>0;)this.ali1=this.seq1[n-1]+this.ali1,this.ali2="-"+this.ali2,--n;for(;r>0;)this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r;e.Debug&&il.timeEnd("Alignment.trace"),e.Debug&&il.log([this.ali1,this.ali2])}}function $g(e,t,i=!1,n="",r=""){let s,o,a,c,l;if(i){let i=e,h=t;n&&r&&(i=e.getView(new $c(n)),h=t.getView(new $c(r)));const u=i.getSequence(),d=h.getSequence(),f=new Ug(u.join(""),d.join(""));let m,p;f.calc(),f.trace(),s=0,o=0,a=f.ali1.length;const g=[],v=[];for(let e=0;e<a;++e){const t=f.ali1[e],i=f.ali2[e];m=0,p=0,"-"===t?v[o]=!1:(v[o]=!0,m=1),"-"===i?g[s]=!1:(g[s]=!0,p=1),s+=m,o+=p}const y=[],x=[],b=i.getAtomProxy(),_=h.getAtomProxy();s=0,i.eachResidue((function(e){void 0!==e.traceAtomIndex&&e.traceAtomIndex===e.getAtomIndexByName("CA")&&(g[s]&&(b.index=e.getAtomIndexByName("CA"),y.push(b.x,b.y,b.z)),s+=1)})),s=0,h.eachResidue((function(e){void 0!==e.traceAtomIndex&&e.traceAtomIndex===e.getAtomIndexByName("CA")&&(v[s]&&(_.index=e.getAtomIndexByName("CA"),x.push(_.x,_.y,_.z)),s+=1)})),c=new Float32Array(y),l=new Float32Array(x)}else{c=e.getView(new $c(`${n} and .CA`)),l=t.getView(new $c(`${r} and .CA`))}const h=new Tg(c,l).transform(e);return e.refreshPosition(),h}const Gg=Object.assign({sele:"",defaultAssembly:""},_g);class Vg extends wg{constructor(e,t,i={}){super(e,t,Object.assign({name:t.name},i)),this.structure=t,this.trajList=[],this.signals=Object.assign(this.signals,{trajectoryAdded:new mc.Signal,trajectoryRemoved:new mc.Signal,defaultAssemblyChanged:new mc.Signal}),this.initSelection(this.parameters.sele),this.pickBuffer=function(e){let t=0,i=0;const n=[];return{has:function(e){return-1!==n.indexOf(e)},get:function(e){return n[e]},push:function(r){n[t]=r,t=(e+t+1)%e,++i},get count(){return i},get data(){return n.slice(0,Math.min(i,e))},clear:function(){i=0,t=0,n.length=0}}}(4),this.pickDict=function(){const e={};return{has:function(t){return void 0!==e[JSON.stringify(t)]},add:function(t,i){e[JSON.stringify(t)]=i},del:function(t){delete e[JSON.stringify(t)]},get values(){return Object.keys(e).map((t=>e[t]))}}}(),this.spacefillRepresentation=this.addRepresentation("spacefill",{sele:"none",opacity:nl.opacity,color:nl.color,disablePicking:!0,radiusType:"data"},!0),this.distanceRepresentation=this.addRepresentation("distance",nl,!0),this.angleRepresentation=this.addRepresentation("angle",nl,!0),this.dihedralRepresentation=this.addRepresentation("dihedral",nl,!0),this.measureRepresentations=new Ag([this.spacefillRepresentation,this.distanceRepresentation,this.angleRepresentation,this.dihedralRepresentation]),this.setDefaultAssembly(this.parameters.defaultAssembly),this.structure.signals.refreshed.add((()=>{this.updateRepresentations({position:!0})}))}get defaultParameters(){return Gg}get type(){return"structure"}initSelection(e){this.selection=new $c(e),this.structureView=new Bg(this.structure,this.selection),this.selection.signals.stringChanged.add((()=>{this.structureView.setSelection(this.selection),this.rebuildRepresentations(),this.rebuildTrajectories()}))}setSelection(e){return this.parameters.sele=e,this.selection.setString(e),this}setDefaultAssembly(e){if(void 0===this.structure.biomolDict[e]&&(e=""),this.parameters.defaultAssembly!==e){const t={defaultAssembly:e};this.reprList.forEach((e=>e.setParameters(t))),this.measureRepresentations.setParameters(t),this.parameters.defaultAssembly=e,this.signals.defaultAssemblyChanged.dispatch(e)}return this}rebuildRepresentations(){this.reprList.forEach((e=>{e.build()})),this.measureRepresentations.build()}rebuildTrajectories(){this.trajList.forEach((e=>{e.trajectory.setStructure(this.structureView)}))}updateRepresentations(e){super.updateRepresentations(e),this.measureRepresentations.update(e)}updateRepresentationMatrices(){super.updateRepresentationMatrices(),this.measureRepresentations.setParameters({matrix:this.matrix})}addRepresentation(e,t={},i=!1){t.defaultAssembly=this.parameters.defaultAssembly;const n=this._addRepresentation(e,this.structureView,t,i);return i||n.signals.parametersChanged.add((()=>this.measureUpdate())),n}addTrajectory(e="",t={}){const i=function(e,t,i){let n;return n=e&&e instanceof Pg?new Lg(e,t,i):!e&&t.frames?new Rg(e,t,i):e&&"function"==typeof e?new Og(e,t,i):new kg(e,t,i),n}(e,this.structureView,t),n=new Cg(this.stage,i,t);return this.trajList.push(n),this.signals.trajectoryAdded.dispatch(n),n}removeTrajectory(e){const t=this.trajList.indexOf(e);-1!==t&&this.trajList.splice(t,1),e.dispose(),this.signals.trajectoryRemoved.dispatch(e)}dispose(){this.trajList.slice().forEach((e=>e.dispose())),this.trajList.length=0,this.structure.dispose(),this.measureRepresentations.dispose(),super.dispose()}autoView(e,t){"number"==typeof e&&(t=e,e=""),this.stage.animationControls.zoomMove(this.getCenter(e),this.getZoom(e),Ia(t,0))}getBoxUntransformed(e){let t;return t=e?this.structureView.getBoundingBox(new $c(e)):this.structureView.boundingBox,t}getCenterUntransformed(e){return e&&"string"==typeof e?this.structure.atomCenter(new $c(e)):this.structure.center}superpose(e,t,i,n){return $g(this.structureView,e.structureView,t,i,n),this.updateRepresentations({position:!0}),this}getMaxRepresentationRadius(e){let t=0;const i=this.structure.getAtomProxy(e);return this.eachRepresentation((e=>{if(e.getVisibility()){const n=e.repr;t=Math.max(n.getAtomRadius(i),t)}})),t}measurePick(e){const t=this.pickBuffer.count;if(this.lastPick===e.index&&t>=1){if(t>1){const e=this.pickBuffer.data,i=this.pickBuffer.data.sort();this.pickDict.has(i)?this.pickDict.del(i):this.pickDict.add(i,e),2===t?this.distanceRepresentation.setParameters({atomPair:this.pickDict.values.filter((e=>2===e.length))}):3===t?this.angleRepresentation.setParameters({atomTriple:this.pickDict.values.filter((e=>3===e.length))}):4===t&&this.dihedralRepresentation.setParameters({atomQuad:this.pickDict.values.filter((e=>4===e.length))})}this.pickBuffer.clear(),this.lastPick=void 0}else this.pickBuffer.has(e.index)||this.pickBuffer.push(e.index),this.lastPick=e.index;this.measureUpdate()}measureClear(){this.pickBuffer.clear(),this.lastPick=void 0,this.spacefillRepresentation.setSelection("none")}measureBuild(){const e=this.measureData();this.distanceRepresentation.setParameters({atomPair:e.distance}),this.angleRepresentation.setParameters({atomTriple:e.angle}),this.dihedralRepresentation.setParameters({atomQuad:e.dihedral})}measureUpdate(){const e=this.pickBuffer.data,t={};e.forEach((e=>{const i=Math.max(.1,this.getMaxRepresentationRadius(e));t[e]=i*(2.3-rc(.1,2,i))})),this.spacefillRepresentation.setSelection(e.length?"@"+e.join(","):"none"),e.length&&this.spacefillRepresentation.setParameters({radiusData:t})}measureData(){const e=this.pickDict.values;return{distance:e.filter((e=>2===e.length)),angle:e.filter((e=>3===e.length)),dihedral:e.filter((e=>4===e.length))}}removeAllMeasurements(e){const t=this.pickDict,i=t.values,n=function(e){i.filter((t=>t.length===e)).forEach((e=>t.del(e.slice().sort())))};(!e||1&e)&&n(2),(!e||2&e)&&n(3),(!e||4&e)&&n(4),this.measureBuild()}removeMeasurement(e){this.pickDict.del(e.slice().sort()),this.measureBuild()}addMeasurement(e){if(e.length<2||e.length>4)return;const t=e.slice().sort();this.pickDict.has(t)||this.pickDict.add(t,e),this.measureBuild()}}fl.add("structure",Vg),fl.add("structureview",Vg);class Hg extends wg{constructor(e,t,i={}){super(e,t,Object.assign({name:t.name},i)),this.surface=t}get type(){return"surface"}addRepresentation(e,t={}){return this._addRepresentation(e,this.surface,t)}getBoxUntransformed(){return this.surface.boundingBox}getCenterUntransformed(){return this.surface.center}dispose(){this.surface.dispose(),super.dispose()}}fl.add("surface",Hg);class jg extends wg{constructor(e,t,i={}){super(e,t,Object.assign({name:t.name},i)),this.volume=t}get type(){return"volume"}addRepresentation(e,t={}){return this._addRepresentation(e,this.volume,t)}getBoxUntransformed(){return this.volume.boundingBox}getCenterUntransformed(){return this.volume.center}dispose(){this.volume.dispose(),super.dispose()}}fl.add("volume",jg);class Wg extends Sg{addRepresentation(e,t){return this.forEach((i=>i.addRepresentation(e,t)))}autoView(e){return this.forEach((t=>t.autoView(e)))}}function qg(e,t){return e instanceof RegExp?null!==t.name.match(e):t.name===e}const Xg=new Zt,Yg={impostor:!0,quality:"medium",workerDefault:!0,sampleLevel:0,backgroundColor:"black",rotateSpeed:2,zoomSpeed:1.2,panSpeed:1,clipNear:0,clipFar:100,clipDist:10,clipMode:"scene",clipScale:"relative",fogNear:50,fogFar:100,cameraFov:40,cameraEyeSep:.3,cameraType:"perspective",lightColor:14540253,lightIntensity:1,ambientColor:14540253,ambientIntensity:.2,hoverTimeout:0,tooltip:!0,mousePreset:"default"};class Zg extends wg{constructor(e,t,i={}){super(e,t,Object.assign({name:t.name},i)),this.shape=t}get type(){return"shape"}addRepresentation(e,t={}){return this._addRepresentation(e,this.shape,t)}getBoxUntransformed(){return this.shape.boundingBox}getCenterUntransformed(){return this.shape.center}dispose(){this.shape.dispose(),super.dispose()}}function Kg(e,t,i,n){var r,s=arguments.length,o=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(s<3?r(o):s>3?r(t,i,o):r(t,i))||o);return s>3&&o&&Object.defineProperty(t,i,o),o}fl.add("shape",Zg);class Qg extends dc{constructor(e){super(e),e.scale||(this.parameters.scale="rainbow",this.parameters.reverse=Ia(e.reverse,!0)),this.scalePerModel={},e.structure.eachModel((e=>{this.parameters.domain=[e.atomOffset,e.atomEnd],this.scalePerModel[e.index]=this.getScale()}))}atomColor(e){return this.scalePerModel[e.modelIndex](e.index)}}Kg([uc],Qg.prototype,"atomColor",null),al.add("atomindex",Qg);class Jg extends dc{constructor(e){if(super(e),e.scale||(this.parameters.scale="OrRd"),!e.domain){let t,i=1/0,n=-1/0;e.sele&&(t=new $c(e.sele)),e.structure.eachAtom((function(e){const t=e.bfactor;i=Math.min(i,t),n=Math.max(n,t)}),t),this.parameters.domain=[i,n]}this.bfactorScale=this.getScale()}atomColor(e){return this.bfactorScale(e.bfactor)}}Kg([uc],Jg.prototype,"atomColor",null),al.add("bfactor",Jg);class ev extends dc{constructor(e){super(e),this.chainidDictPerModel={},this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel((e=>{let t=0;const i={};e.eachChain((function(e){void 0===i[e.chainid]&&(i[e.chainid]=t,t+=1)})),this.parameters.domain=[0,t-1],this.chainidDictPerModel[e.index]=i,this.scalePerModel[e.index]=this.getScale()}))}atomColor(e){const t=this.chainidDictPerModel[e.modelIndex];return this.scalePerModel[e.modelIndex](t[e.chainid])}}Kg([uc],ev.prototype,"atomColor",null),al.add("chainid",ev);class tv extends dc{constructor(e){super(e),this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel((e=>{this.parameters.domain=[e.chainOffset,e.chainEnd],this.scalePerModel[e.index]=this.getScale()}))}atomColor(e){return this.scalePerModel[e.modelIndex](e.chainIndex)}}Kg([uc],tv.prototype,"atomColor",null),al.add("chainindex",tv);class iv extends dc{constructor(e){super(e),this.chainnameDictPerModel={},this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel((e=>{let t=0;const i={};e.eachChain((function(e){void 0===i[e.chainname]&&(i[e.chainname]=t,t+=1)})),this.parameters.domain=[0,t-1],this.chainnameDictPerModel[e.index]=i,this.scalePerModel[e.index]=this.getScale()}))}atomColor(e){const t=this.chainnameDictPerModel[e.modelIndex];return this.scalePerModel[e.modelIndex](t[e.chainname])}}Kg([uc],iv.prototype,"atomColor",null),al.add("chainname",iv);class nv extends dc{constructor(e){super(e),this.rsrzDict={},this.rsccDict={},e.scale||(this.parameters.scale="RdYlBu"),this.rsrzScale=this.getScale({domain:[2,0]}),this.rsccScale=this.getScale({domain:[.678,1]});const t=e.structure.validation;t&&(this.rsrzDict=t.rsrzDict,this.rsccDict=t.rsccDict)}atomColor(e){let t=e.resno+"";e.inscode&&(t+="^"+e.inscode),e.chainname&&(t+=":"+e.chainname),t+="/"+e.modelIndex;const i=this.rsrzDict[t];if(void 0!==i)return this.rsrzScale(i);const n=this.rsccDict[t];return void 0!==n?this.rsccScale(n):9474192}}Kg([uc],nv.prototype,"atomColor",null),al.add("densityfit",nv);const rv={ARG:{CD:.1,CZ:.5,NE:-.1},ASN:{CG:.55,OD1:-.55},ASP:{CB:-.16,CG:.36,OD1:-.6,OD2:-.6},CYS:{CB:.19,SG:-.19},GLN:{CD:.55,OE1:-.55},GLU:{CD:.36,CG:-.16,OE1:-.6,OE2:-.6},HIS:{CB:.1,CD2:.2,CE1:.45,CG:.15,ND1:.05,NE2:.05},LYS:{CE:.25,NZ:.75},MET:{CE:.06,CG:.06,SD:-.12},PTR:{C:.55,CA:.1,CZ:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SEP:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SER:{CB:.25,OG:-.25},THR:{CB:.25,OG1:-.25},TPO:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,OG1:-1.1,O1P:-.85,O2P:-.85,O3P:-.85,P:1.4},TRP:{CD1:.06,CD2:.1,CE2:-.04,CE3:-.03,CG:-.03,NE1:-.06},TYR:{CZ:.25,OH:-.25},backbone:{C:.55,O:-.55,N:-.35,CA:.1}};class sv extends dc{constructor(e){super(e),this.delta=new Zt,this.hCharges=[],e.scale||(this.parameters.scale="rwb"),e.domain||(this.parameters.domain=[-50,50]),this.scale=this.getScale(),this.charges=new Float32Array(e.structure.atomCount);const t=[];e.structure.eachAtom((e=>{var i;if(this.charges[e.index]=(null!==(i=e).partialCharge?i.partialCharge:i.isProtein()&&(rv[i.resname]&&rv[i.resname][i.atomname]||rv.backbone[i.atomname])||0)*e.occupancy,"N"===e.atomname){if(e.bondCount>=3)return;if(e.bondToElementCount(1))return;const i=function(e,t=new Zt){let i=!1,n=!1,r=!1;return t.set(2*e.x,2*e.y,2*e.z),e.eachBondedAtom((function(e){if(!i)return"H"===e.atomname?(t.set(e.x,e.y,e.z),void(i=!0)):void(n||"CA"!==e.atomname?r||"C"!==e.atomname||(r=!0,t.sub(e)):(t.sub(e),n=!0))})),i?t:n&&r?(t.normalize(),t.multiplyScalar(1.04),t.add(e),t):void 0}(e);void 0!==i&&(t.push(i),this.hCharges.push(.25*e.occupancy))}}));const i=e.structure.getBoundingBox();i.expandByScalar(1.04),this.hStore=function(e){const t=e.length,i=new Float32Array(t),n=new Float32Array(t),r=new Float32Array(t);for(let t=0;t<e.length;t++){const s=e[t];i[t]=s.x,n[t]=s.y,r[t]=s.z}return{x:i,y:n,z:r,count:t}}(t),this.hHash=new ju(this.hStore,i),this.hash=new ju(e.structure.atomStore,i)}positionColor(e){const t=this.charges,i=this.hCharges;let n=0;return this.hash.eachWithin(e.x,e.y,e.z,12,((e,i)=>{const r=t[e];0!==r&&(n+=r/i)})),this.hHash.eachWithin(e.x,e.y,e.z,12,((e,t)=>{const r=i[e];0!==r&&(n+=r/t)})),this.scale(332*n)}}Kg([uc],sv.prototype,"positionColor",null),al.add("electrostatic",sv);const ov={H:16777215,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:9699476,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998,DS:16777215,RG:16777215,CN:16777215,UUT:16777215,FL:16777215,UUP:16777215,LV:16777215,UUH:16777215,D:16777152,T:16777120};class av extends dc{constructor(e){e.value=Ia(e.value,ov.C),super(e)}atomColor(e){const t=e.element;return"C"===t?this.parameters.value:ov[t]||16777215}}Kg([uc],av.prototype,"atomColor",null),al.add("element",av);class cv extends dc{constructor(e){super(e),e.scale||(this.parameters.scale="Spectral"),e.domain||(this.parameters.domain=[0,e.structure.entityList.length-1]),this.entityindexScale=this.getScale()}atomColor(e){return this.entityindexScale(e.entityIndex)}}Kg([uc],cv.prototype,"atomColor",null),al.add("entityindex",cv);class lv extends dc{atomColor(e){const t=e.entity;switch(t?t.entityType:void 0){case 1:return 8374655;case 2:return 16629894;case 3:return 12496596;case 4:return 3697840;default:return 16777113}}}Kg([uc],lv.prototype,"atomColor",null),al.add("entitytype",lv);class hv extends dc{constructor(e){super(e),this.geoAtomDict={},this.geoDict={};const t=e.structure.validation;t&&(this.geoAtomDict=t.geoAtomDict,this.geoDict=t.geoDict)}atomColor(e){let t,i=e.resno+"";e.inscode&&(i+="^"+e.inscode),e.chainname&&(i+=":"+e.chainname),i+="/"+e.modelIndex;const n=this.geoAtomDict[i];if(void 0!==n){const i=n[e.atomname]||0;r=i,t=16843009*((r=(858993459&(r-=r>>1&1431655765))+(r>>2&858993459))+(r>>4)&252645135)>>24}else t=this.geoDict[i]||0;var r;return 0===t?2188972:1===t?16703627:2===t?16018755:t>=3?10813478:9474192}}Kg([uc],hv.prototype,"atomColor",null),al.add("geoquality",hv);class uv extends dc{constructor(e){super(e),this.resHF={},e.scale||(this.parameters.scale="RdYlGn");for(const e in md)this.resHF[e]=md[e][0];if(this.defaultResidueHydrophobicity=pd[0],!e.domain){let e=1/0,t=-1/0;for(const i in this.resHF){const n=this.resHF[i];e=Math.min(e,n),t=Math.max(t,n)}this.parameters.domain=[e,0,t]}this.hfScale=this.getScale()}atomColor(e){return this.hfScale(this.resHF[e.resname]||this.defaultResidueHydrophobicity)}}Kg([uc],uv.prototype,"atomColor",null),al.add("hydrophobicity",uv);class dv extends dc{constructor(e){super(e),e.scale||(this.parameters.scale="rainbow"),e.domain||(this.parameters.domain=[0,e.structure.modelStore.count]),this.modelindexScale=this.getScale()}atomColor(e){return this.modelindexScale(e.modelIndex)}}Kg([uc],dv.prototype,"atomColor",null),al.add("modelindex",dv);class fv extends dc{atomColor(e){switch(e.residueType.moleculeType){case 1:return 3697840;case 2:return 15729279;case 3:return 12496596;case 4:return 16629894;case 5:return 12540695;case 6:return 8374655;default:return 16777113}}}Kg([uc],fv.prototype,"atomColor",null),al.add("moleculetype",fv);class mv extends dc{constructor(e){super(e),e.scale||(this.parameters.scale="PuBu"),e.domain||(this.parameters.domain=[0,1]),this.occupancyScale=this.getScale()}atomColor(e){return this.occupancyScale(e.occupancy)}}Kg([uc],mv.prototype,"atomColor",null),al.add("occupancy",mv);class pv extends dc{constructor(e){super(e),e.scale||(this.parameters.scale="rwb"),e.domain||(this.parameters.domain=[-1,1]),this.partialchargeScale=this.getScale()}atomColor(e){return this.partialchargeScale(e.partialCharge||0)}}function gv(){return 16777215*Math.random()}Kg([uc],pv.prototype,"atomColor",null),al.add("partialcharge",pv);class vv extends dc{atomColor(){return gv()}volumeColor(){return gv()}positionColor(){return gv()}}Kg([uc],vv.prototype,"atomColor",null),Kg([uc],vv.prototype,"volumeColor",null),Kg([uc],vv.prototype,"positionColor",null),al.add("random",vv);class yv extends dc{constructor(e){super(e),this.rciDict={},e.scale||(this.parameters.scale="RdYlBu"),this.rciScale=this.getScale({domain:[.6,0]});const t=e.structure.validation;t&&(this.rciDict=t.rciDict)}atomColor(e){let t=`[${e.resname}]${e.resno}`;e.chainname&&(t+=":"+e.chainname);const i=this.rciDict[t];return void 0!==i?this.rciScale(i):9474192}}Kg([uc],yv.prototype,"atomColor",null),al.add("randomcoilindex",yv);class xv extends dc{constructor(e){super(e),this.scalePerChain={},e.scale||(this.parameters.scale="rainbow",this.parameters.reverse=Ia(e.reverse,!0)),e.structure.eachChain((e=>{this.parameters.domain=[e.residueOffset,e.residueEnd],this.scalePerChain[e.index]=this.getScale()}))}atomColor(e){return this.scalePerChain[e.chainIndex](e.residueIndex)}}Kg([uc],xv.prototype,"atomColor",null),al.add("residueindex",xv);const bv={ALA:9240460,ARG:124,ASN:16743536,ASP:10485826,CYS:16777072,GLN:16731212,GLU:6684672,GLY:16777215,HIS:7368959,ILE:19456,LEU:4546117,LYS:4671416,MET:12099650,PHE:5459026,PRO:5395026,SER:16740418,THR:12078080,TRP:5195264,TYR:9203788,VAL:16747775,ASX:16711935,GLX:16711935,ASH:16711935,GLH:16711935,A:14423100,G:3329330,I:10145074,X:8190976,C:16766720,T:4286945,U:4251856,D:35723,DA:14423100,DG:3329330,DI:10145074,DX:8190976,DC:16766720,DT:4286945,DU:4251856,DD:35723};class _v extends dc{atomColor(e){return bv[e.resname]||16711935}}Kg([uc],_v.prototype,"atomColor",null),al.add("resname",_v);const wv=16711808,Sv=10485888,Av=6291584,Mv=16762880,Cv=6324479,Pv=16777215,Tv=11403518,Iv=16580962,Ev=10921722;class Dv extends dc{constructor(e){super(e),this.residueProxy=e.structure.getResidueProxy()}atomColor(e){const t=e.sstruc,i=this.residueProxy;return"h"===t?wv:"g"===t?Sv:"i"===t?Av:"e"===t||"b"===t?Mv:"t"===t?Cv:(i.index=e.residueIndex,i.isDna()?Tv:i.isRna()?Iv:i.isSaccharide()?Ev:i.isProtein()||"s"===t||"l"===t?Pv:8421504)}}Kg([uc],Dv.prototype,"atomColor",null),al.add("sstruc",Dv);class Lv extends dc{constructor(e){var t,i;super(e),e.scale||(this.parameters.scale="rwb"),this.atomData=null===(t=this.parameters.data)||void 0===t?void 0:t.atomData,this.bondData=null===(i=this.parameters.data)||void 0===i?void 0:i.bondData,this.scale=this.getScale(this.parameters)}atomColor(e){var t;const i=null===(t=this.atomData)||void 0===t?void 0:t[e.index];return void 0!==i?this.scale(i):this.parameters.value}bondColor(e,t){var i;const n=null===(i=this.bondData)||void 0===i?void 0:i[e.index];return void 0!==n?this.scale(n):this.atomProxy?(this.atomProxy.index=t?e.atomIndex1:e.atomIndex2,this.atomColor(this.atomProxy)):this.parameters.value}}Kg([uc],Lv.prototype,"atomColor",null),Kg([uc],Lv.prototype,"bondColor",null),al.add("structuredata",Lv);class Rv extends dc{atomColor(){return this.parameters.value}bondColor(){return this.parameters.value}valueColor(){return this.parameters.value}volumeColor(){return this.parameters.value}}Kg([uc],Rv.prototype,"atomColor",null),Kg([uc],Rv.prototype,"bondColor",null),Kg([uc],Rv.prototype,"valueColor",null),Kg([uc],Rv.prototype,"volumeColor",null),al.add("uniform",Rv);class kv extends dc{constructor(e){super(e),this.valueScale=this.getScale()}volumeColor(e){return this.valueScale(this.parameters.volume.data[e])}}Kg([uc],kv.prototype,"volumeColor",null),al.add("value",kv);class Ov extends dc{constructor(e){super(e),this.vec=new Zt,this.valueScale=this.getScale()}positionColor(e){const t=this.parameters.volume;if(!t||!t.inverseMatrix)return this.parameters.value;const i=this.vec,n=t.data,r=t.nx,s=t.ny,o=r*s;i.copy(e),i.applyMatrix4(t.inverseMatrix);const a=Math.floor(i.x),c=Math.floor(i.y),l=Math.floor(i.z),h=(l*s+c)*r+a,u=h+1,d=h+r,f=h+o,m=d+1,p=f+1,g=d+o,v=g+1,y=n[h],x=n[u],b=n[d],_=n[f],w=n[m],S=n[p],A=n[g],M=n[v],C=i.x-a,P=i.y-c,T=i.z-l,I=ic(y,x,C),E=ic(_,S,C),D=ic(b,w,C),L=ic(A,M,C),R=ic(I,D,P),k=ic(E,L,P),O=ic(R,k,T);return this.valueScale(O)}}Kg([uc],Ov.prototype,"positionColor",null),al.add("volume",Ov);class Bv extends tu{constructor(e,t,i){const n=i||{};if(super(e,t,n),this.type="structure",this.parameters=Object.assign({radiusType:{type:"select",options:Tm.types},radiusData:{type:"hidden"},radiusSize:{type:"number",precision:3,max:10,min:.001},radiusScale:{type:"number",precision:3,max:10,min:.001},assembly:null,defaultAssembly:{type:"hidden"}},this.parameters),this.selection=new $c(n.sele),this.dataList=[],this.structure=e,this.structureView=this.structure.getView(this.selection),e.biomolDict){const t={default:"default","":e.unitcell?"AU":"FULL"};Object.keys(e.biomolDict).forEach((function(e){t[e]=e})),this.parameters.assembly={type:"select",options:t,rebuild:!0}}else this.parameters.assembly=null}get defaultScale(){return{vdw:1,covalent:1,bfactor:.01,sstruc:1}}init(e){const t=e||{};t.colorScheme=Ia(t.colorScheme,"element"),this.setRadius(t.radius,t),this.radiusType=Ia(t.radiusType,"vdw"),this.radiusData=Ia(t.radiusData,{}),this.radiusSize=Ia(t.radiusSize,1),this.radiusScale=Ia(t.radiusScale,1),this.assembly=Ia(t.assembly,"default"),this.defaultAssembly=Ia(t.defaultAssembly,""),"auto"===t.quality&&(t.quality=this.getQuality()),super.init(t),this.selection.signals.stringChanged.add((()=>{this.build()})),this.build()}setRadius(e,t){const i=Object.keys(Pm);return"string"==typeof e&&i.includes(e.toLowerCase())?t.radiusType=e:void 0!==e&&(t.radiusType="size",t.radiusSize=e),this}getAssembly(){const e="default"===this.assembly?this.defaultAssembly:this.assembly;return this.structure.biomolDict[e]}getQuality(){let e;const t=this.structureView,i=this.getAssembly();e=i?i.getAtomCount(t):t.atomCount,Kc&&(e*=4);return t.atomStore.count/t.residueStore.count<2&&(e*=10),e<15e3?"high":e<8e4?"medium":"low"}create(){if(0===this.structureView.atomCount)return;if(!this.structureView.hasCoords())return void(this.needsBuild=!0);this.needsBuild=!1;const e=this.getAssembly();if(e)e.partList.forEach(((e,t)=>{const i=e.getView(this.structureView);if(0===i.atomCount)return;const n=this.createData(i,t);n&&(n.sview=i,n.instanceList=e.getInstanceList(),this.dataList.push(n))}));else{const e=this.createData(this.structureView,0);e&&(e.sview=this.structureView,this.dataList.push(e))}}update(e){!this.lazy||this.visible?this.needsBuild?this.build():this.dataList.forEach((t=>{t.bufferList.length>0&&this.updateData(e,t)}),this):Object.assign(this.lazyProps.what,e)}updateData(e,t){this.build()}getColorParams(){return Object.assign(Object.assign({},super.getColorParams()),{structure:this.structure})}getRadiusParams(e){return{type:this.radiusType,scale:this.radiusScale,size:this.radiusSize,data:this.radiusData}}getAtomParams(e,t){return Object.assign({what:e,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},t)}getBondParams(e,t){return Object.assign({what:e,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},t)}getAtomRadius(e){if(this.structureView.atomSet.isSet(e.index)){return new Tm(this.getRadiusParams()).atomRadius(e)}return 0}setSelection(e,t){return this.selection.setString(e,t),this}setParameters(e,t={},i=!1){const n=e||{};return this.setRadius(n.radius,n),void 0===n.radiusType&&void 0===n.radiusData&&void 0===n.radiusSize&&void 0===n.radiusScale||(t.radius=!0,el&&!this.disableImpostor||(i=!0)),void 0!==n.defaultAssembly&&n.defaultAssembly!==this.defaultAssembly&&("default"===this.assembly&&void 0===n.assembly||"default"===n.assembly)&&(i=!0),super.setParameters(n,t,i),this}getParameters(){return Object.assign(super.getParameters(),{sele:this.selection?this.selection.string:void 0,defaultAssembly:this.defaultAssembly})}attach(e){const t=this.viewer,i=this.bufferList;this.dataList.forEach((function(e){e.bufferList.forEach((function(n){i.push(n),t.add(n,e.instanceList)}))})),this.setVisibility(this.visible),e()}clear(){this.dataList.length=0,super.clear()}dispose(){this.structureView.dispose(),super.dispose()}}class Nv extends Bv{constructor(e,t,i){super(e,t,i),this.n=0,this.parameters=Object.assign({labelVisible:{type:"boolean"},labelSize:{type:"number",precision:3,max:10,min:.001},labelColor:{type:"color"},labelFontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:"fontFamily"},labelFontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:"fontStyle"},labelFontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:"fontWeight"},labelsdf:{type:"boolean",buffer:"sdf"},labelXOffset:{type:"number",precision:1,max:20,min:-20,buffer:"xOffset"},labelYOffset:{type:"number",precision:1,max:20,min:-20,buffer:"yOffset"},labelZOffset:{type:"number",precision:1,max:20,min:-20,buffer:"zOffset"},labelAttachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},labelBorder:{type:"boolean",buffer:"showBorder"},labelBorderColor:{type:"color",buffer:"borderColor"},labelBorderWidth:{type:"number",precision:2,max:.3,min:0,buffer:"borderWidth"},labelBackground:{type:"boolean",rebuild:!0},labelBackgroundColor:{type:"color",buffer:"backgroundColor"},labelBackgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},labelBackgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:"backgroundOpacity"},labelFixedSize:{type:"boolean",buffer:"fixedSize"},lineOpacity:{type:"range",min:0,max:1,step:.01},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters,{flatShaded:null})}init(e){const t=e||{};this.labelVisible=Ia(t.labelVisible,!0),this.labelSize=Ia(t.labelSize,2),this.labelColor=Ia(t.labelColor,16777215),this.labelFontFamily=Ia(t.labelFontFamily,"sans-serif"),this.labelFontStyle=Ia(t.labelFontstyle,"normal"),this.labelFontWeight=Ia(t.labelFontWeight,"bold"),this.labelsdf=Ia(t.labelsdf,"Chrome"===Yc),this.labelXOffset=Ia(t.labelXOffset,0),this.labelYOffset=Ia(t.labelYOffset,0),this.labelZOffset=Ia(t.labelZOffset,.5),this.labelAttachment=Ia(t.labelAttachment,"bottom-left"),this.labelBorder=Ia(t.labelBorder,!1),this.labelBorderColor=Ia(t.labelBorderColor,"lightgrey"),this.labelBorderWidth=Ia(t.labelBorderWidth,.15),this.labelBackground=Ia(t.labelBackground,!1),this.labelBackgroundColor=Ia(t.labelBackgroundColor,"lightgrey"),this.labelBackgroundMargin=Ia(t.labelBackgroundMargin,.5),this.labelBackgroundOpacity=Ia(t.labelBackgroundOpacity,1),this.labelFixedSize=Ia(t.labelFixedSize,!1),this.lineOpacity=Ia(t.lineOpacity,1),this.linewidth=Ia(t.linewidth,2),super.init(t)}update(e){e.position?this.build():super.update(e)}updateData(e,t){const i={};if(e&&!e.labelSize||Object.assign(i,{size:Gl(this.n,this.labelSize)}),!e||e.labelColor){const e=new mn(this.labelColor);Object.assign(i,{color:Vl(this.n,e.r,e.g,e.b)})}this.textBuffer.setAttributes(i)}setParameters(e,t={},i=!1){return e&&e.labelSize&&(t.labelSize=!0),e&&(e.labelColor||0===e.labelColor)&&(t.labelColor=!0,i=!0),super.setParameters(e,t,i),e&&void 0!==e.opacity&&this.textBuffer.setParameters({opacity:1}),e&&void 0!==e.labelVisible&&this.setVisibility(this.visible),this}setVisibility(e,t){return super.setVisibility(e,!0),this.textBuffer&&this.textBuffer.setVisibility(this.labelVisible&&this.visible),t||this.viewer.requestRender(),this}getLabelBufferParams(e={}){return super.getBufferParams(Object.assign({fontFamily:this.labelFontFamily,fontStyle:this.labelFontStyle,fontWeight:this.labelFontWeight,sdf:this.labelsdf,xOffset:this.labelXOffset,yOffset:this.labelYOffset,zOffset:this.labelZOffset,attachment:this.labelAttachment,showBorder:this.labelBorder,borderColor:this.labelBorderColor,borderWidth:this.labelBorderWidth,showBackground:this.labelBackground,backgroundColor:this.labelBackgroundColor,backgroundMargin:this.labelBackgroundMargin,backgroundOpacity:this.labelBackgroundOpacity,fixedSize:this.labelFixedSize,disablePicking:!0,visible:this.labelVisible},e,{opacity:1}))}getAtomRadius(){return 0}}function Fv(e,t){const i=e.getAtomProxy(),n=new $c,r=t.length;if(0===r)return new Float32Array(0);const s=t[0].length,o=e.getAtomSet(),a=new Float32Array(r*s*3);let c=0;return t.forEach((function(t){let r=!1;for(let l=0;l<s;l++){const s=t[l];if("number"==typeof s&&Number.isInteger(s)){if(!o.get(s)){r=!0;break}i.index=s}else{n.setString(s);const t=e.getAtomIndices(n);if(!t.length){r=!0;break}i.index=t[0]}let h=c+3*l;a[h++]=i.x,a[h++]=i.y,a[h++]=i.z}r||(c+=3*s)})),a.subarray(0,c)}function zv(e,t,i,n,r){const s=Math.cos(r),o=Math.sin(r);e[0]=t[0]+i[0]*s+n[0]*o,e[1]=t[1]+i[1]*s+n[1]*o,e[2]=t[2]+i[2]*s+n[2]*o}function Uv(e,t,i,n,r,s,o){for(let a=0;a<t;a++){for(let r=0;r<i;r++)n[r]=e[r*t+a];$v(n,r,s,o,i);for(let n=0;n<i;n++)e[n*t+a]=r[n]}for(let a=0;a<i;a++){for(let i=0;i<t;i++)n[i]=e[a*t+i];$v(n,r,s,o,t);for(let i=0;i<t;i++)e[a*t+i]=Math.sqrt(r[i])}}function $v(e,t,i,n,r){i[0]=0,n[0]=Number.MIN_SAFE_INTEGER,n[1]=Number.MAX_SAFE_INTEGER;for(let t=1,s=0;t<r;t++){let r=(e[t]+t*t-(e[i[s]]+i[s]*i[s]))/(2*t-2*i[s]);for(;r<=n[s];)s--,r=(e[t]+t*t-(e[i[s]]+i[s]*i[s]))/(2*t-2*i[s]);s++,i[s]=t,n[s]=r,n[s+1]=Number.MAX_SAFE_INTEGER}for(let s=0,o=0;s<r;s++){for(;n[o+1]<s;)o++;t[s]=(s-i[o])*(s-i[o])+e[i[o]]}}ul.add("shader/SDFFont.vert","uniform float clipNear;\nuniform float clipRadius;\nuniform vec3 clipCenter;\nuniform float xOffset;\nuniform float yOffset;\nuniform float zOffset;\nuniform bool ortho;\nuniform float canvasHeight;\nuniform float pixelRatio;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\nvarying vec2 texCoord;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#endif\nattribute vec2 mapping;\nattribute vec2 inputTexCoord;\nattribute float inputSize;\n#include matrix_scale\n#include common\nvoid main(void){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\ntexCoord = inputTexCoord;\nfloat scale = matrixScale( modelViewMatrix );\nfloat _xOffset = xOffset * scale;\nfloat _yOffset = yOffset * scale;\nfloat _zOffset = zOffset * scale;\nif( texCoord.x == 10.0 ){\n_zOffset -= 0.001;\n}\nvec4 cameraPos = modelViewMatrix * vec4( position, 1.0 );\n#ifdef FIXED_SIZE\nif ( ortho ) {\nscale /= pixelRatio * (( canvasHeight / 2.0 ) / -cameraPosition.z) * 0.1;\n} else {\nscale /= pixelRatio * (( canvasHeight / 2.0 ) / -cameraPos.z) * 0.1;\n}\n#endif\nvec4 cameraCornerPos = vec4( cameraPos.xyz, 1.0 );\ncameraCornerPos.xy += mapping * inputSize * 0.01 * scale;\ncameraCornerPos.x += _xOffset;\ncameraCornerPos.y += _yOffset;\nif( ortho ){\ncameraCornerPos.xyz += normalize( -cameraPosition ) * _zOffset;\n} else {\ncameraCornerPos.xyz += normalize( -cameraCornerPos.xyz ) * _zOffset;\n}\ngl_Position = projectionMatrix * cameraCornerPos;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvViewPosition = -cameraCornerPos.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n#include radiusclip_vertex\n}"),ul.add("shader/SDFFont.frag","uniform sampler2D fontTexture;\nuniform float opacity;\nuniform bool showBorder;\nuniform vec3 borderColor;\nuniform float borderWidth;\nuniform vec3 backgroundColor;\nuniform float backgroundOpacity;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec3 vViewPosition;\nvarying vec2 texCoord;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\nconst vec3 vColor = vec3( 0.0 );\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#endif\nconst float gamma = 2.2 * 1.4142 / 128.0;\nconst float padding = 0.75;\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\nif( texCoord.x > 1.0 ){\ngl_FragColor = vec4( backgroundColor, backgroundOpacity );\n}else{\nfloat sdf = texture2D( fontTexture, texCoord ).a;\nif( showBorder ) sdf += borderWidth;\nfloat a = smoothstep(padding - gamma, padding + gamma, sdf);\nif( a < 0.2 ) discard;\na *= opacity;\nvec3 outgoingLight = vColor;\nif( showBorder && sdf < ( padding + borderWidth ) ){\noutgoingLight = borderColor;\n}\ngl_FragColor = vec4( outgoingLight, a );\n}\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");const Gv={};const Vv={font:"sans-serif",size:36,style:"normal",variant:"normal",weight:"normal",outline:3,width:1024,height:1024};class Hv{constructor(e={}){this.gamma=1,this.mapped={},this.scratchW=0,this.scratchH=0,this.currentX=0,this.currentY=0,this.cutoff=.25,this.parameters=Ea(e,Vv);const t=this.parameters;this.radius=t.size/8,this.padding=t.size/3;const i=this.lineHeight=t.size+2*t.outline+Math.round(t.size/4),n=this.maxWidth=t.width/4,r=this.canvas=document.createElement("canvas");r.width=n,r.height=i;const s=this.context=this.canvas.getContext("2d");s.font=`${t.style} ${t.variant} ${t.weight} ${t.size}px ${t.font}`,s.fillStyle="black",s.textAlign="left",s.textBaseline="bottom",s.lineJoin="round",this.gridOuter=new Float64Array(i*n),this.gridInner=new Float64Array(i*n),this.f=new Float64Array(Math.max(i,n)),this.d=new Float64Array(Math.max(i,n)),this.z=new Float64Array(Math.max(i,n)+1),this.v=new Int16Array(Math.max(i,n)),this.data=new Uint8Array(t.width*t.height*4),this.canvas2=document.createElement("canvas"),this.canvas2.width=t.width,this.canvas2.height=t.height,this.context2=this.canvas2.getContext("2d"),this.placeholder=this.map(String.fromCharCode(65533));for(let e=32;e<=126;++e)this.map(String.fromCharCode(e));this.map(String.fromCharCode(176)),this.map(String.fromCharCode(8491)),this.texture=new na(this.canvas2),this.texture.flipY=!1,this.texture.needsUpdate=!0}map(e){const t=this.parameters;return void 0===this.mapped[e]&&(this.draw(e),this.currentX+this.scratchW>t.width&&(this.currentX=0,this.currentY+=this.scratchH),this.currentY+this.scratchH>t.height&&console.warn("canvas to small"),this.mapped[e]={x:this.currentX,y:this.currentY,w:this.scratchW,h:this.scratchH},this.context2.drawImage(this.canvas,0,0,this.scratchW,this.scratchH,this.currentX,this.currentY,this.scratchW,this.scratchH),this.currentX+=this.scratchW),this.mapped[e]}get(e){return this.mapped[e]||this.placeholder}draw(e){const t=this.parameters,i=this.lineHeight,n=t.outline,r=this.context,s=this.maxWidth,o=n,a=i-t.outline,c=r.measureText(e),l=Math.min(s,Math.ceil(c.width+2*o+1)),h=l*i;r.clearRect(0,0,l,i),r.fillText(e,o,a);const u=r.getImageData(0,0,l,i),d=u.data;for(let e=0;e<h;e++){const t=u.data[4*e+3]/255;this.gridOuter[e]=1===t?0:0===t?Number.MAX_SAFE_INTEGER:Math.pow(Math.max(0,.5-t),2),this.gridInner[e]=1===t?Number.MAX_SAFE_INTEGER:0===t?0:Math.pow(Math.max(0,t-.5),2)}Uv(this.gridOuter,l,i,this.f,this.d,this.v,this.z),Uv(this.gridInner,l,i,this.f,this.d,this.v,this.z);for(let e=0;e<h;e++){const t=this.gridOuter[e]-this.gridInner[e];d[4*e+3]=Math.max(0,Math.min(255,Math.round(255-255*(t/this.radius+this.cutoff))))}r.putImageData(u,0,0),this.scratchW=l,this.scratchH=i}}const jv=Object.assign({fontFamily:"sans-serif",fontStyle:"normal",fontWeight:"bold",fontSize:36,xOffset:0,yOffset:0,zOffset:.5,attachment:"bottom-left",showBorder:!1,borderColor:"lightgrey",borderWidth:.15,showBackground:!1,backgroundColor:"lightgrey",backgroundMargin:.5,backgroundOpacity:1,forceTransparent:!0,fixedSize:!1},em),Wv=Object.assign({fontFamily:{uniform:!0},fontStyle:{uniform:!0},fontWeight:{uniform:!0},fontSize:{uniform:!0},xOffset:{uniform:!0},yOffset:{uniform:!0},zOffset:{uniform:!0},showBorder:{uniform:!0},borderColor:{uniform:!0},borderWidth:{uniform:!0},backgroundColor:{uniform:!0},backgroundOpacity:{uniform:!0},fixedSize:{updateShader:!0}},tm);function qv(e,t){const i=e.position.length/3;let n=0;for(let t=0;t<i;++t)n+=e.text[t].length;return t.showBackground&&(n+=i),n}class Xv extends Jp{constructor(e,t={}){super({position:new Float32Array(3*qv(e,t)),color:new Float32Array(3*qv(e,t)),picking:new gf},t),this.parameterTypes=Wv,this.alwaysTransparent=!0,this.hasWireframe=!1,this.isText=!0,this.vertexShader="SDFFont.vert",this.fragmentShader="SDFFont.frag",this.text=e.text,this.positionCount=e.position.length/3,this.addUniforms({fontTexture:{value:null},xOffset:{value:this.parameters.xOffset},yOffset:{value:this.parameters.yOffset},zOffset:{value:this.parameters.zOffset},ortho:{value:!1},showBorder:{value:this.parameters.showBorder},borderColor:{value:new mn(this.parameters.borderColor)},borderWidth:{value:this.parameters.borderWidth},backgroundColor:{value:new mn(this.parameters.backgroundColor)},backgroundOpacity:{value:this.parameters.backgroundOpacity},canvasHeight:{value:1},pixelRatio:{value:1}}),this.addAttributes({inputTexCoord:{type:"v2",value:null},inputSize:{type:"f",value:null}}),this.setAttributes(e),this.makeTexture(),this.makeMapping()}get defaultParameters(){return jv}makeMaterial(){super.makeMaterial();const e=this.texture,t=this.material;t.transparent=!0,t.extensions.derivatives=!0,t.lights=!1,t.uniforms.fontTexture.value=e,t.needsUpdate=!0;const i=this.wireframeMaterial;i.transparent=!0,i.extensions.derivatives=!0,i.lights=!1,i.uniforms.fontTexture.value=e,i.needsUpdate=!0;const n=this.pickingMaterial;n.extensions.derivatives=!0,n.lights=!1,n.uniforms.fontTexture.value=e,n.needsUpdate=!0}setAttributes(e={}){let t,i,n,r,s,o;const a=this.text,c=this.geometry.attributes;e.position&&(t=e.position,r=c.position.array,c.position.needsUpdate=!0),e.size&&(i=e.size,s=c.inputSize.array,c.inputSize.needsUpdate=!0),e.color&&(n=e.color,o=c.color.array,c.color.needsUpdate=!0);const l=this.positionCount;let h,u,d,f,m,p=0;for(let e=0;e<l;++e)for(u=3*e,d=a[e],m=d.length,this.parameters.showBackground&&(m+=1),f=0;f<m;++f,++p)for(let a=0;a<4;a++)h=4*p*3+3*a,t&&(r[h]=t[u],r[h+1]=t[u+1],r[h+2]=t[u+2]),i&&(s[4*p+a]=i[e]),n&&(o[h]=n[u],o[h+1]=n[u+1],o[h+2]=n[u+2])}makeTexture(){this.textAtlas=function(e){const t=JSON.stringify(e);return void 0===Gv[t]&&(Gv[t]=new Hv(e)),Gv[t]}({font:this.parameters.fontFamily,style:this.parameters.fontStyle,weight:this.parameters.fontWeight,size:this.parameters.fontSize}),this.texture=this.textAtlas.texture}makeMapping(){const e=this.textAtlas,t=this.text,i=this.parameters.attachment,n=e.lineHeight*this.parameters.backgroundMargin*.1-10,r=this.geometry.attributes,s=r.inputTexCoord.array,o=r.mapping.array,a=this.positionCount;let c,l,h,u,d,f,m,p,g=0;for(let r=0;r<a;++r){for(h=t[r],u=0,f=h.length,d=0;d<f;++d)c=e.get(h[d]),u+=c.w-2*e.parameters.outline;for(p=i.startsWith("top")?e.lineHeight/1.25:i.startsWith("middle")?e.lineHeight/2.5:0,m=i.endsWith("right")?u:i.endsWith("center")?u/2:0,m+=e.parameters.outline,p+=e.parameters.outline,this.parameters.showBackground&&(l=2*g*4,o[l+0]=-e.lineHeight/6-m-n,o[l+1]=e.lineHeight-p+n,o[l+2]=-e.lineHeight/6-m-n,o[l+3]=0-p-n,o[l+4]=u+e.lineHeight/6-m+2*e.parameters.outline+n,o[l+5]=e.lineHeight-p+n,o[l+6]=u+e.lineHeight/6-m+2*e.parameters.outline+n,o[l+7]=0-p-n,s[l+0]=10,s[l+2]=10,s[l+4]=10,s[l+6]=10,g+=1),u=0,d=0;d<f;++d,++g){c=e.get(h[d]),l=2*g*4,o[l+0]=u-m,o[l+1]=c.h-p,o[l+2]=u-m,o[l+3]=0-p,o[l+4]=u+c.w-m,o[l+5]=c.h-p,o[l+6]=u+c.w-m,o[l+7]=0-p;const t=e.parameters.width,i=e.parameters.height,n=[c.x/t,c.y/i,c.x/t,(c.y+c.h)/i,(c.x+c.w)/t,c.y/i,(c.x+c.w)/t,(c.y+c.h)/i];s.set(n,l),u+=c.w-2*e.parameters.outline}}r.inputTexCoord.needsUpdate=!0,r.mapping.needsUpdate=!0}getDefines(e){const t=super.getDefines(e);return this.parameters.fixedSize&&(t.FIXED_SIZE=1),t}setUniforms(e){!e||void 0===e.fontFamily&&void 0===e.fontStyle&&void 0===e.fontWeight&&void 0===e.fontSize||(this.makeTexture(),this.makeMapping(),this.texture.needsUpdate=!0,e.fontTexture=this.texture),super.setUniforms(e)}}ml.add("text",Xv),ul.add("shader/WideLine.vert","\nuniform float clipNear;\nuniform vec3 clipCenter;\nuniform float linewidth;\nuniform vec2 resolution;\nuniform mat4 projectionMatrixInverse;\nattribute vec2 mapping;\nattribute vec3 position1;\nattribute vec3 position2;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor;\nvarying vec3 vColor2;\nvarying float flag;\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nvoid trimSegment( const in vec4 start, inout vec4 end ) {\nfloat a = projectionMatrix[ 2 ][ 2 ]; float b = projectionMatrix[ 3 ][ 2 ]; float nearEstimate = - 0.5 * b / a;\nfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\nend.xyz = mix( start.xyz, end.xyz, alpha );\n}\nvoid main() {\nfloat aspect = resolution.x / resolution.y;\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nflag = mapping.y;\nvColor = color;\nvColor2 = color2;\n#endif\nvec4 start = modelViewMatrix * vec4( position1, 1.0 );\nvec4 end = modelViewMatrix * vec4( position2, 1.0 );\nbool perspective = ( projectionMatrix[ 2 ][ 3 ] == -1.0 ); if ( perspective ) {\nif ( start.z < 0.0 && end.z >= 0.0 ) {\ntrimSegment( start, end );\n} else if ( end.z < 0.0 && start.z >= 0.0 ) {\ntrimSegment( end, start );\n}\n}\nvec4 clipStart = projectionMatrix * start;\nvec4 clipEnd = projectionMatrix * end;\nvec2 ndcStart = clipStart.xy / clipStart.w;\nvec2 ndcEnd = clipEnd.xy / clipEnd.w;\nvec2 dir = ndcEnd - ndcStart;\ndir.x *= aspect;\ndir = normalize( dir );\nvec2 offset = vec2( dir.y, - dir.x );\ndir.x /= aspect;\noffset.x /= aspect;\nif ( mapping.x < 0.0 ) offset *= - 1.0;\noffset *= linewidth;\noffset /= resolution.y;\nvec4 clip = ( mapping.y < 0.5 ) ? clipStart : clipEnd;\noffset *= clip.w;\nclip.xy += offset;\ngl_Position = clip;\n#ifndef PICKING\nvViewPosition = ( projectionMatrixInverse * clip ).xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),ul.add("shader/WideLine.frag","uniform vec3 diffuse;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include fog_pars_fragment\nvarying vec3 vViewPosition;\nvarying vec3 vColor;\nvarying vec3 vColor2;\nvarying float flag;\n#endif\nvoid main() {\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 outgoingLight = vec3( 0.0 );\nvec4 diffuseColor = vec4( diffuse, 1.0 );\nif ( flag < 0.0 ) {\ndiffuseColor.rgb *= vColor;\n} else {\ndiffuseColor.rgb *= vColor2;\n}\n#include alphatest_fragment\noutgoingLight = diffuseColor.rgb;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");const Yv=Object.assign({linewidth:2},em),Zv=Object.assign({linewidth:{uniform:!0}},tm);class Kv extends Jp{constructor(e,t={}){super(e,t),this.parameterTypes=Zv,this.vertexShader="WideLine.vert",this.fragmentShader="WideLine.frag",!e.color2&&e.color&&(e.color2=e.color),this.addUniforms({linewidth:{value:this.parameters.linewidth},resolution:{value:new zt},projectionMatrixInverse:{value:new ri}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return Yv}setParameters(e){super.setParameters(e)}}ml.add("wideline",Kv);class Qv extends Nv{constructor(e,t,i){super(e,t,i),this.type="angle",this.parameters=Object.assign({atomTriple:{type:"hidden",rebuild:!0},vectorVisible:{type:"boolean",default:!0},arcVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(i)}init(e){const t=e||{};t.side=Ia(t.side,"double"),t.opacity=Ia(t.opacity,.5),this.atomTriple=Ia(t.atomTriple,[]),this.arcVisible=Ia(t.arcVisible,!0),this.sectorVisible=Ia(t.sectorVisible,!0),this.vectorVisible=Ia(t.vectorVisible,!0),super.init(t)}createData(e){if(!e.atomCount||!this.atomTriple.length)return;const t=function(e,t){return function(e){const t=[],i=e.length/9;for(let n=0;n<i;n++){let i=!0;for(let t=n;t<n+3;t+=3)e[t]===e[t+3]&&e[t+1]===e[t+4]&&e[t+2]===e[t+5]&&(i=!1);i&&t.push(n)}const n=new Float32Array(9*t.length);let r=0;return t.forEach((function(t){ql(e,n,9*t,9*r,9),r++})),n}(Fv(e,t))}(e,this.atomTriple),i=function(e,t={}){const i=Ia(t.angleStep,Math.PI/90),n=e.length/9,r=new Float32Array(n),s=new Float32Array(3*n),o=new Array(n),a=new Float32Array(6*n),c=new Float32Array(6*n),l=new Array(n),h=new Array(n),u=new Array(n);let d=0;const f=hu(),m=hu(),p=hu(),g=hu(),v=hu(),y=hu(),x=hu(),b=hu(),_=hu();for(var w=0;w<n;w++){let t=9*w;pu(f,e,t),pu(m,e,t+3),pu(p,e,t+6);let n=6*w;gu(f,a,n),gu(m,c,n),gu(m,a,n+3),gu(p,c,n+3),fu(g,f,m),fu(v,p,m),_u(g,g),_u(v,v),uu(y,g,v);const S=yu(y),A=du(g,v),M=r[w]=Math.atan2(S,A);o[w]=(Fl*M).toFixed(1)+String.fromCharCode(176),0===yu(y)&&(y[0]=1,y[1]=0,y[2]=0),uu(x,y,g),_u(x,x),zv(b,m,g,x,M/2),gu(b,s,3*w);const C=Math.ceil(M/i),P=new Float32Array(9*C);u[w]=P;const T=new Float32Array(3*C),I=new Float32Array(3*C);l[w]=T,h[w]=I,mu(_,m,g);const E=function(e,t){const i=9*t,n=3*t;gu(m,P,i),gu(_,P,i+3),gu(_,T,n),zv(_,m,g,x,e),gu(_,P,i+6),gu(_,I,n)};let D=0;for(let e=i;e<M;e+=i)E(e,D),D++;E(M,D),d+=C}const S=3*d,A=9*d,M=new Float32Array(S),C=new Float32Array(S),P=new Float32Array(A);let T=0,I=0;for(let e=0;e<n;e++){const t=l[e],i=h[e];ql(t,M,0,I,t.length),ql(i,C,0,I,i.length),I+=t.length;const n=u[e];ql(n,P,0,T,n.length),T+=n.length}return{labelPosition:s,labelText:o,vectorPosition1:a,vectorPosition2:c,arcPosition1:M,arcPosition2:C,sectorPosition:P}}(t),n=this.n=i.labelPosition.length/3,r=new mn(this.labelColor);this.textBuffer=new Xv({position:i.labelPosition,size:Gl(n,this.labelSize),color:Vl(n,r.r,r.g,r.b),text:i.labelText},this.getLabelBufferParams());const s=new mn(this.colorValue);return this.vectorBuffer=new Kv(Eu({position1:i.vectorPosition1,position2:i.vectorPosition2,color:Vl(2*n,s.r,s.g,s.b),color2:Vl(2*n,s.r,s.g,s.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.vectorVisible,opacity:this.lineOpacity})),this.arcLength=i.arcPosition1.length/3,this.arcBuffer=new Kv(Eu({position1:i.arcPosition1,position2:i.arcPosition2,color:Vl(this.arcLength,s.r,s.g,s.b),color2:Vl(this.arcLength,s.r,s.g,s.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.arcVisible,opacity:this.lineOpacity})),this.sectorLength=i.sectorPosition.length/3,this.sectorBuffer=new nm({position:i.sectorPosition,color:Vl(this.sectorLength,s.r,s.g,s.b)},this.getBufferParams({visible:this.sectorVisible})),{bufferList:[this.textBuffer,this.vectorBuffer,this.arcBuffer,this.sectorBuffer]}}updateData(e,t){super.updateData(e,t);const i={},n={},r={};if(e.color){const e=new mn(this.colorValue);Object.assign(i,{color:Vl(2*this.n,e.r,e.g,e.b),color2:Vl(2*this.n,e.r,e.g,e.b)}),Object.assign(n,{color:Vl(this.arcLength,e.r,e.g,e.b),color2:Vl(this.arcLength,e.r,e.g,e.b)}),Object.assign(r,{color:Vl(this.sectorLength,e.r,e.g,e.b)})}this.vectorBuffer.setAttributes(i),this.arcBuffer.setAttributes(n),this.sectorBuffer.setAttributes(r)}setParameters(e){return super.setParameters(e,{},!1),!e||void 0===e.vectorVisible&&void 0===e.arcVisible&&void 0===e.sectorVisible||this.setVisibility(this.visible),e&&e.lineOpacity&&(this.vectorBuffer.setParameters({opacity:e.lineOpacity}),this.arcBuffer.setParameters({opacity:e.lineOpacity})),e&&void 0!==e.opacity&&(this.vectorBuffer.setParameters({opacity:this.lineOpacity}),this.arcBuffer.setParameters({opacity:this.lineOpacity})),e&&e.linewidth&&(this.vectorBuffer.setParameters({linewidth:e.linewidth}),this.arcBuffer.setParameters({linewidth:e.linewidth})),this}setVisibility(e,t){return super.setVisibility(e,!0),this.vectorBuffer&&this.vectorBuffer.setVisibility(this.vectorVisible&&this.visible),this.arcBuffer&&this.arcBuffer.setVisibility(this.arcVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),t||this.viewer.requestRender(),this}}ll.add("angle",Qv);const Jv=new Zt,ey=new Zt,ty=new Zt,iy=new Zt(0,1,0),ny=Object.assign({radialSegments:1,openEnded:!0},em);function ry(e={}){const t=Ia(e.radialSegments,10),i=Ia(e.openEnded,!0),n=(new ri).makeRotationX(Math.PI/2),r=new pa(1,1,1,t,1,i);return r.applyMatrix4(n),r}class sy extends Wp{constructor(e,t={}){super(function(e,t={}){const i=ry(t),n=e.position1.length,r=i.attributes.position.array.length/3,s=n/3,o=new Float32Array(2*s*r);return jl(s,r,0,o),jl(s,r,s*r,o),{position:new Float32Array(2*n),color:new Float32Array(2*n),primitiveId:o,picking:e.picking}}(e,t),t,ry(t)),this.updateNormals=!0;const i=e.position1.length,n=e.radius.length;this.__center=new Float32Array(i),this._position=new Float32Array(2*i),this._color=new Float32Array(2*i),this._from=new Float32Array(2*i),this._to=new Float32Array(2*i),this._radius=new Float32Array(2*n),this.setAttributes(e,!0)}get defaultParameters(){return ny}applyPositionTransform(e,t,i){ey.fromArray(this._from,i),ty.fromArray(this._to,i),e.lookAt(ey,ty,iy);const n=this._radius[t];Jv.set(n,n,ey.distanceTo(ty)),e.scale(Jv)}setAttributes(e={},t){const i={};e.position1&&e.position2&&(Ul(e.position1,e.position2,this.__center),Ul(e.position1,this.__center,this._position),Ul(this.__center,e.position2,this._position,e.position1.length),this._from.set(e.position1),this._from.set(this.__center,e.position1.length),this._to.set(this.__center),this._to.set(e.position2,this.__center.length),i.position=this._position),e.color&&e.color2&&(this._color.set(e.color),this._color.set(e.color2,e.color.length),i.color=this._color),e.radius&&(this._radius.set(e.radius),this._radius.set(e.radius,e.radius.length),i.radius=this._radius),super.setAttributes(i,t)}}ul.add("shader/CylinderImpostor.vert","\nattribute vec3 mapping;\nattribute vec3 position1;\nattribute vec3 position2;\nattribute float radius;\nvarying vec3 axis;varying vec4 base_radius;varying vec4 end_b;varying vec3 U;varying vec3 V;\nvarying vec4 w;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#endif\nuniform mat4 modelViewMatrixInverse;\nuniform float ortho;\n#include matrix_scale\nvoid main(){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nvColor1 = color;\nvColor2 = color2;\n#endif\nbase_radius.w = radius * matrixScale( modelViewMatrix );\nvec3 center = position;\nvec3 dir = normalize( position2 - position1 );\nfloat ext = length( position2 - position1 ) / 2.0;\nvec3 cam_dir;\nif( ortho == 0.0 ){\ncam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;\n}else{\ncam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;\n}\ncam_dir = normalize( cam_dir );\nvec3 ldir;\nfloat b = dot( cam_dir, dir );\nend_b.w = b;\nif( b < 0.0 )\nldir = -ext * dir;\nelse\nldir = ext * dir;\nvec3 left = radius * normalize( cross( cam_dir, ldir ) );\nvec3 up = radius * normalize( cross( left, ldir ) );\naxis = normalize( normalMatrix * ldir );\nU = normalize( normalMatrix * up );\nV = normalize( normalMatrix * left );\nvec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );\nbase_radius.xyz = base4.xyz / base4.w;\nvec4 end4 = modelViewMatrix * vec4( center + ldir, 1.0 );\nend_b.xyz = end4.xyz / end4.w;\nw = modelViewMatrix * vec4(\ncenter + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0\n);\ngl_Position = projectionMatrix * w;\ngl_Position.z = 0.99;\n}"),ul.add("shader/CylinderImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform mat4 projectionMatrix;\nuniform float ortho;\nvarying vec3 axis;\nvarying vec4 base_radius;\nvarying vec4 end_b;\nvarying vec3 U;\nvarying vec3 V;\nvarying vec4 w;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#include common\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool interior = false;\nfloat distSq3( vec3 v3a, vec3 v3b ){\nreturn (\n( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +\n( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +\n( v3a.z - v3b.z ) * ( v3a.z - v3b.z )\n);\n}\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nfloat calcClip( vec3 cameraPos ){\nreturn dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nvoid main(){\nvec3 ray_target = w.xyz / w.w;\nvec3 base = base_radius.xyz; float vRadius = base_radius.w; vec3 end = end_b.xyz; float b = end_b.w;\nvec3 ray_origin = vec3(0.0); vec3 ortho_ray_direction = vec3(0.0, 0.0, 1.0); vec3 persp_ray_direction = normalize(ray_origin - ray_target);\nvec3 ray_direction = mix(persp_ray_direction, ortho_ray_direction, ortho);\n\nmat3 basis = mat3( U, V, axis );\nvec3 diff = ray_target - 0.5 * (base + end);\n\nvec3 P = diff * basis;\nfloat dz = dot( axis, ray_direction );\nfloat radius2 = vRadius*vRadius;\nvec3 D = vec3(dot(U, ray_direction),\ndot(V, ray_direction),\ndz);\nfloat a0 = P.x*P.x + P.y*P.y - radius2;\nfloat a1 = P.x*D.x + P.y*D.y;\nfloat a2 = D.x*D.x + D.y*D.y;\nfloat d = a1*a1 - a0*a2;\nif (d < 0.0) {\ndiscard;\n}\nfloat dist = (-a1 + sqrt(d)) / a2;\nvec3 surface_point = ray_target + dist * ray_direction;\nvec3 base_to_surface = surface_point - base;\nvec3 _normal = normalize( base_to_surface - axis * dot(base_to_surface, axis) );\nfloat base_cap_test = dot( base_to_surface, axis );\nfloat end_cap_test = dot((surface_point - end), axis);\n#ifndef CAP\nvec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\nvec3 tmp_point2 = new_point2 - base;\n#endif\nif (base_cap_test < 0.0) {\nfloat dNV;\nfloat near;\nvec3 front_point;\nif ( ortho == 1.0 ) {\nfront_point = ray_target;\n} else {\ndNV = dot(-axis, ray_direction);\nnear = dot(-axis, (base)) / dNV;\nfront_point = ray_direction * near + ray_origin;\n}\nif (dot(front_point - base, front_point-base) > radius2) {\ndiscard;\n}\n#ifdef CAP\nsurface_point = front_point;\n_normal = axis;\n#else\nsurface_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\ndNV = dot(-axis, ray_direction);\nnear = dot(axis, end) / dNV;\nnew_point2 = ray_direction * near + ray_origin;\nif (dot(new_point2 - end, new_point2-base) < radius2) {\ndiscard;\n}\ninterior = true;\n#endif\n}\nif( end_cap_test > 0.0 )\n{\nfloat dNV;\nfloat near;\nvec3 end_point;\nif ( ortho == 1.0 ) {\nend_point = ray_target;\n} else {\ndNV = dot(axis, ray_direction);\nif (dNV < 0.0) {\ndiscard;\n}\nnear = dot(axis, end) / dNV;\nend_point = ray_direction * near + ray_origin;\n}\n\nif( dot(end_point - end, end_point-base) > radius2 ) {\ndiscard;\n}\n#ifdef CAP\nsurface_point = end_point;\n_normal = axis;\n#else\nsurface_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\ndNV = dot(-axis, ray_direction);\nnear = dot(-axis, (base)) / dNV;\nnew_point2 = ray_direction * near + ray_origin;\nif (dot(new_point2 - base, new_point2-base) < radius2) {\ndiscard;\n}\ninterior = true;\n#endif\n}\ngl_FragDepthEXT = calcDepth( surface_point );\n\n#ifdef NEAR_CLIP\nif( calcClip( surface_point ) > 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nsurface_point = ray_target + dist * ray_direction;\nif( calcClip( surface_point ) > 0.0 ) {\ndiscard;\n}\ninterior = true;\ngl_FragDepthEXT = calcDepth( surface_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );\n}\n}else if( gl_FragDepthEXT <= 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nsurface_point = ray_target + dist * ray_direction;\ninterior = true;\ngl_FragDepthEXT = calcDepth( surface_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n}\n#else\nif( gl_FragDepthEXT <= 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nsurface_point = ray_target + dist * ray_direction;\ninterior = true;\ngl_FragDepthEXT = calcDepth( surface_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n}\n#endif\nif (gl_FragDepthEXT < 0.0) {\ndiscard;\n}\nif (gl_FragDepthEXT > 1.0) {\ndiscard;\n}\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vViewPosition = -surface_point;\nvec3 vNormal = _normal;\nvec3 vColor;\nif( distSq3( surface_point, end ) < distSq3( surface_point, base ) ){\nif( b < 0.0 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\n}else{\nif( b > 0.0 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\n}\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\nvec3 normal = normalize( vNormal );\nvec3 geometryNormal = normal;\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");const oy=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),ay=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]);class cy extends Zp{constructor(e,t={}){super("v3",e,t)}get mapping(){return oy}get mappingIndices(){return ay}get mappingIndicesSize(){return 12}get mappingSize(){return 6}get mappingItemSize(){return 3}}const ly=Object.assign({openEnded:!1},em),hy=Object.assign({openEnded:{updateShader:!0}},tm);class uy extends cy{constructor(e,t={}){super(e,t),this.parameterTypes=hy,this.isImpostor=!0,this.vertexShader="CylinderImpostor.vert",this.fragmentShader="CylinderImpostor.frag",this.addUniforms({modelViewMatrixInverse:{value:new ri},ortho:{value:0}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return ly}getDefines(e){const t=cy.prototype.getDefines.call(this,e);return this.parameters.openEnded||(t.CAP=1),t}}Object.assign({disableImpostor:!1},ny,ly);const dy=class{constructor(e,t={}){return!e.color2&&e.color&&(e.color2=e.color),!el||t&&t.disableImpostor?new sy(e,t):new uy(e,t)}};ml.add("cylinder",dy);class fy extends Bv{constructor(e,t,i){super(e,t,i),this.type="axes",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0,showAxes:{type:"boolean",rebuild:!0},showBox:{type:"boolean",rebuild:!0}},this.parameters,{assembly:null}),this.init(i)}init(e){const t=e||{};t.radiusSize=Ia(t.radiusSize,.5),t.colorValue=Ia(t.colorValue,"lightgreen"),t.useInteriorColor=Ia(t.useInteriorColor,!0),this.showAxes=Ia(t.showAxes,!0),this.showBox=Ia(t.showBox,!1),super.init(t)}getPrincipalAxes(){let e;const t=this.getAssembly();return t&&(e=t.partList[0].getSelection()),this.structureView.getPrincipalAxes(e)}getAxesData(e){const t=this.getPrincipalAxes(),i=new mn(this.colorValue);let n=0,r=0;this.showAxes&&(n+=6,r+=3),this.showBox&&(n+=8,r+=12);const s=new Float32Array(3*n),o=Vl(n,i.r,i.g,i.b),a=Gl(n,this.radiusSize),c=new Float32Array(3*r),l=new Float32Array(3*r),h=Vl(r,i.r,i.g,i.b),u=Gl(r,this.radiusSize);let d=0;if(this.showAxes){const e=function(e,t){e.toArray(s,2*d),t.toArray(s,2*d+3),e.toArray(c,d),t.toArray(l,d),d+=3};e(t.begA,t.endA),e(t.begB,t.endB),e(t.begC,t.endC)}if(this.showBox){const i=new Zt,{d1a:n,d2a:r,d3a:o,d1b:a,d2b:h,d3b:u}=t.getProjectedScaleForAtoms(e);let f=2*d;const m=function(e,n,r){i.copy(t.center).addScaledVector(t.normVecA,e).addScaledVector(t.normVecB,n).addScaledVector(t.normVecC,r),i.toArray(s,f),f+=3};m(n,r,o),m(n,r,u),m(n,h,u),m(n,h,o),m(a,h,u),m(a,h,o),m(a,r,o),m(a,r,u);let p=d;const g=function(e,t){i.fromArray(s,2*d+3*e).toArray(c,p),i.fromArray(s,2*d+3*t).toArray(l,p),p+=3};g(0,1),g(0,3),g(0,6),g(1,2),g(1,7),g(2,3),g(2,4),g(3,5),g(4,5),g(4,7),g(5,6),g(6,7)}const f=new uf(t);return{vertex:{position:s,color:o,radius:a,picking:f},edge:{position1:c,position2:l,color:h,color2:h,radius:u,picking:f}}}create(){const e=this.getAxesData(this.structureView);this.sphereBuffer=new tg(e.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new dy(e.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})}createData(e){}updateData(e,t){const i=this.getAxesData(t.sview),n={},r={};e&&!e.position||(Object.assign(n,{position:i.vertex.position}),Object.assign(r,{position1:i.edge.position1,position2:i.edge.position2})),e&&!e.color||(Object.assign(n,{color:i.vertex.color}),Object.assign(r,{color:i.edge.color,color2:i.edge.color})),e&&!e.radius||(Object.assign(n,{radius:i.vertex.radius}),Object.assign(r,{radius:i.edge.radius})),this.sphereBuffer.setAttributes(n),this.cylinderBuffer.setAttributes(r)}}ll.add("axes",fy);class my extends Bv{constructor(e,t,i){super(e,t,i),this.type="ball+stick",this.parameters=Object.assign({sphereDetail:!0,radialSegments:!0,openEnded:!0,disableImpostor:!0,aspectRatio:{type:"number",precision:1,max:10,min:1},lineOnly:{type:"boolean",rebuild:!0},cylinderOnly:{type:"boolean",rebuild:!0},multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondScale:{type:"number",precision:2,max:1,min:.01},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters),this.init(i)}init(e){var t=e||{};t.radiusType=Ia(t.radiusType,"size"),t.radiusSize=Ia(t.radiusSize,.15),t.useInteriorColor=Ia(t.useInteriorColor,!0),this.aspectRatio=Ia(t.aspectRatio,2),this.lineOnly=Ia(t.lineOnly,!1),this.cylinderOnly=Ia(t.cylinderOnly,!1),this.multipleBond=Ia(t.multipleBond,"off"),this.bondSpacing=Ia(t.bondSpacing,1),this.bondScale=Ia(t.bondScale,.4),this.linewidth=Ia(t.linewidth,2),super.init(t)}getAtomRadius(e){return this.aspectRatio*super.getAtomRadius(e)}getAtomParams(e,t){var i=super.getAtomParams(e,t);return i.radiusParams.scale*=this.aspectRatio,i}getAtomData(e,t,i){return e.getAtomData(this.getAtomParams(t,i))}getBondParams(e,t){return t=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,bondScale:this.bondScale},t),super.getBondParams(e,t)}getBondData(e,t,i){return e.getBondData(this.getBondParams(t,i))}createData(e){const t=[];if(this.lineOnly)this.lineBuffer=new Kv(this.getBondData(e,{position:!0,color:!0,picking:!0}),this.getBufferParams({linewidth:this.linewidth})),t.push(this.lineBuffer);else{const i=new dy(this.getBondData(e),this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}));if(t.push(i),!this.cylinderOnly){const i=new tg(this.getAtomData(e),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));t.push(i)}}return{bufferList:t}}updateData(e,t){"off"!==this.multipleBond&&e&&e.radius&&(e.position=!0);const i=this.getBondData(t.sview,e);if(this.lineOnly){const n={};e&&!e.position||Object.assign(n,{position1:i.position1,position2:i.position2}),e&&!e.color||Object.assign(n,{color:i.color,color2:i.color2}),t.bufferList[0].setAttributes(n)}else{var n={};if(e&&!e.position||Object.assign(n,{position1:i.position1,position2:i.position2}),e&&!e.color||Object.assign(n,{color:i.color,color2:i.color2}),e&&!e.radius||Object.assign(n,{radius:i.radius}),t.bufferList[0].setAttributes(n),!this.cylinderOnly){var r=this.getAtomData(t.sview,e),s={};e&&!e.position||Object.assign(s,{position:r.position}),e&&!e.color||Object.assign(s,{color:r.color}),e&&!e.radius||Object.assign(s,{radius:r.radius}),t.bufferList[1].setAttributes(s)}}}setParameters(e={}){let t=!1;const i={};return(e.aspectRatio||e.bondSpacing||e.bondScale)&&(Object.assign(i,{radius:!0}),el&&!this.disableImpostor||(t=!0)),super.setParameters(e,i,t),this}}ll.add("ball+stick",my);class py extends my{constructor(e,t,i){super(e,t,i),this.type="backbone",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null}),this.init(i)}init(e){var t=e||{};t.aspectRatio=Ia(t.aspectRatio,1),t.radiusSize=Ia(t.radiusSize,.25),super.init(t)}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}getAtomData(e,t,i){return e.getBackboneAtomData(this.getAtomParams(t,i))}getBondData(e,t,i){return e.getBackboneBondData(this.getBondParams(t,i))}}ll.add("backbone",py);class gy extends my{constructor(e,t,i){super(e,t,i),this.type="base",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null})}init(e){let t=e||{};t.aspectRatio=Ia(t.aspectRatio,1),t.radiusSize=Ia(t.radiusSize,.3),super.init(t)}getAtomData(e,t,i){return e.getRungAtomData(this.getAtomParams(t,i))}getBondData(e,t,i){let n=this.getBondParams(t,i);return Object.assign(n.colorParams,{rung:!0}),e.getRungBondData(n)}}ll.add("base",gy);class vy{constructor(e,t){this.m=e,this.tension=t,this.dt=1/this.m,this.delta=1e-4,this.vec1=new Zt,this.vec2=new Zt,this.vDir=new Zt,this.vTan=new Zt,this.vNorm=new Zt,this.vBin=new Zt,this.m2=Math.ceil(this.m/2)}interpolateToArr(e,t,i,n,r,s,o){s[o+0]=nc(e.x,t.x,i.x,n.x,r,this.tension),s[o+1]=nc(e.y,t.y,i.y,n.y,r,this.tension),s[o+2]=nc(e.z,t.z,i.z,n.z,r,this.tension)}interpolateToVec(e,t,i,n,r,s){s.x=nc(e.x,t.x,i.x,n.x,r,this.tension),s.y=nc(e.y,t.y,i.y,n.y,r,this.tension),s.z=nc(e.z,t.z,i.z,n.z,r,this.tension)}interpolatePosition(e,t,i,n,r,s){for(var o=0;o<this.m;++o){var a=s+3*o,c=this.dt*o;this.interpolateToArr(e,t,i,n,c,r,a)}}interpolateTangent(e,t,i,n,r,s){for(var o=0;o<this.m;++o){var a=this.dt*o,c=a-this.delta,l=a+this.delta,h=s+3*o;c<0&&(c=0),l>1&&(l=1),this.interpolateToVec(e,t,i,n,c,this.vec1),this.interpolateToVec(e,t,i,n,l,this.vec2),this.vec2.sub(this.vec1).normalize(),this.vec2.toArray(r,h)}}vectorSubdivide(e,t,i,n,r){let s,o=t.next(),a=t.next(),c=t.next();const l=t.size,h=l-1;let u=n||0;for(let n=0;n<h;++n)s=o,o=a,a=c,c=t.next(),e.apply(this,[s,o,a,c,i,u]),u+=3*this.m;r&&(s=t.get(l-2),o=t.get(l-1),a=t.get(0),c=t.get(1),e.apply(this,[s,o,a,c,i,u]),u+=3*this.m)}getPosition(e,t,i,n){e.reset(),this.vectorSubdivide(this.interpolatePosition,e,t,i,n);var r=e.size-1,s=r*this.m*3;n&&(s+=3*this.m);var o=e.get(n?0:r);t[s]=o.x,t[s+1]=o.y,t[s+2]=o.z}getTangent(e,t,i,n){e.reset(),this.vectorSubdivide(this.interpolateTangent,e,t,i,n);let r=(e.size-1)*this.m*3;n&&(r+=3*this.m),ql(t,t,r-3,r,3)}interpolateNormalDir(e,t,i,n,r,s,o,a,c,l,h,u,d){for(let f=0;f<this.m;++f){let m=u+3*f;d&&(m+=3*this.m2);const p=this.dt*f;this.interpolateToVec(e,t,i,n,p,this.vec1),this.interpolateToVec(r,s,o,a,p,this.vec2),this.vDir.subVectors(this.vec2,this.vec1).normalize(),this.vTan.fromArray(c,m),this.vBin.crossVectors(this.vDir,this.vTan).normalize(),this.vBin.toArray(h,m),this.vNorm.crossVectors(this.vTan,this.vBin).normalize(),this.vNorm.toArray(l,m)}}interpolateNormal(e,t,i,n,r){for(var s=0;s<this.m;++s){var o=r+3*s;e.copy(this.vNorm),this.vTan.fromArray(t,o),this.vBin.crossVectors(e,this.vTan).normalize(),this.vBin.toArray(n,o),this.vNorm.crossVectors(this.vTan,this.vBin).normalize(),this.vNorm.toArray(i,o)}}getNormal(e,t,i,n,r,s){this.vNorm.set(0,0,1);const o=e-1;let a=r||0;for(var c=0;c<o;++c)this.interpolateNormal(this.vDir,t,i,n,a),a+=3*this.m;s&&(this.interpolateNormal(this.vDir,t,i,n,a),a+=3*this.m),this.vBin.toArray(n,a),this.vNorm.toArray(i,a)}getNormalDir(e,t,i,n,r,s,o,a){e.reset(),t.reset();const c=new Zt,l=new Zt,h=new Zt,u=new Zt,d=new Zt,f=(new Zt).copy(e.next()),m=(new Zt).copy(e.next()),p=(new Zt).copy(e.next()),g=new Zt,v=(new Zt).copy(t.next()),y=(new Zt).copy(t.next()),x=(new Zt).copy(t.next());this.vNorm.set(0,0,1);let b=e.size,_=b-1,w=s||0;for(var S=0;S<_;++S)d.copy(f),f.copy(m),m.copy(p),p.copy(e.next()),g.copy(v),v.copy(y),y.copy(x),x.copy(t.next()),0===S?(c.subVectors(g,d),l.subVectors(v,f),c.dot(l)<0&&(l.multiplyScalar(-1),v.addVectors(f,l)),h.subVectors(y,m),l.dot(h)<0&&(h.multiplyScalar(-1),y.addVectors(m,h))):h.copy(u),u.subVectors(x,p),h.dot(u)<0&&(u.multiplyScalar(-1),x.addVectors(p,u)),this.interpolateNormalDir(d,f,m,p,g,v,y,x,i,n,r,w,a),w+=3*this.m;if(o&&(d.copy(e.get(b-2)),f.copy(e.get(b-1)),m.copy(e.get(0)),p.copy(e.get(1)),g.copy(t.get(b-2)),v.copy(t.get(b-1)),y.copy(t.get(0)),x.copy(t.get(1)),h.copy(u),u.subVectors(x,p),h.dot(u)<0&&(u.multiplyScalar(-1),x.addVectors(p,u)),this.interpolateNormalDir(d,f,m,p,g,v,y,x,i,n,r,w,a),w+=3*this.m),a){this.vBin.fromArray(r,3*this.m2),this.vNorm.fromArray(n,3*this.m2);for(var A=0;A<this.m2;++A)this.vBin.toArray(r,3*A),this.vNorm.toArray(n,3*A)}else this.vBin.toArray(r,w),this.vNorm.toArray(n,w)}interpolateColor(e,t,i,n,r){var s,o;for(s=0;s<this.m2;++s)o=r+3*s,i.apply(this,[e,n,o]);for(s=this.m2;s<this.m;++s)o=r+3*s,i.apply(this,[t,n,o])}getColor(e,t,i,n,r){let s;e.reset(),e.next();let o=e.next();for(var a=e.size,c=a-1,l=n||0,h=0;h<c;++h)s=o,o=e.next(),this.interpolateColor(s,o,t,i,l),l+=3*this.m;r&&(s=e.get(a-1),o=e.get(0),this.interpolateColor(s,o,t,i,l),l+=3*this.m),i[l]=i[l-3],i[l+1]=i[l-2],i[l+2]=i[l-1]}interpolatePicking(e,t,i,n,r){var s;for(s=0;s<this.m2;++s)n[r+s]=i.apply(this,[e]);for(s=this.m2;s<this.m;++s)n[r+s]=i.apply(this,[t])}getPicking(e,t,i,n,r){let s;e.reset(),e.next();let o=e.next();const a=e.size,c=a-1;let l=n||0;for(var h=0;h<c;++h)s=o,o=e.next(),this.interpolatePicking(s,o,t,i,l),l+=this.m;r&&(s=e.get(a-1),o=e.get(0),this.interpolatePicking(s,o,t,i,l),l+=this.m),i[l]=i[l-1]}interpolateSize(e,t,i,n,r){const s=i.apply(this,[e]),o=i.apply(this,[t]);for(let e=0;e<this.m;++e){let t=e/this.m;n[r+e]=(1-t)*s+t*o}}getSize(e,t,i,n,r){let s;e.reset(),e.next();let o=e.next();const a=e.size,c=a-1;let l=n||0;for(var h=0;h<c;++h)s=o,o=e.next(),this.interpolateSize(s,o,t,i,l),l+=this.m;r&&(s=e.get(a-1),o=e.get(0),this.interpolateSize(s,o,t,i,l),l+=this.m),i[l]=i[l-1]}}class yy{constructor(e,t){this.polymer=e,this.size=e.residueCount;var i=t||{};this.directional=i.directional||!1,this.positionIterator=i.positionIterator||!1,this.subdiv=i.subdiv||1,this.smoothSheet=i.smoothSheet||!1,i.tension?this.tension=i.tension:this.tension=this.polymer.isNucleic()?.5:.9,this.interpolator=new vy(this.subdiv,this.tension)}getAtomIterator(e,t){const i=this.polymer,n=i.structure,r=i.residueCount;let s=0,o=-1;const a=[n.getAtomProxy(),n.getAtomProxy(),n.getAtomProxy(),n.getAtomProxy()],c=[new Zt,new Zt,new Zt,new Zt];var l=n.getAtomProxy(),h=n.getAtomProxy();function u(n){var o=a[s%4];if(o.index=i.getAtomIndexByType(n,e),t&&n>0&&n<r&&"e"===o.sstruc){var u=c[s%4];return l.index=i.getAtomIndexByType(n+1,e),h.index=i.getAtomIndexByType(n-1,e),u.addVectors(l,h).add(o).add(o).multiplyScalar(.25),s+=1,u}return s+=1,o}return{size:r,next:function(){var e=u(o);return o+=1,e},get:u,reset:function(){s=0,o=-1}}}getSubdividedColor(e){var t=this.subdiv,i=this.polymer,n=(i.residueCount-1)*t*3+3;i.isCyclic&&(n+=3*t);var r=new Float32Array(n),s=this.getAtomIterator("trace"),o=e||{};o.structure=i.structure;var a=al.getScheme(o);return this.interpolator.getColor(s,(function(e,t,i){a.atomColorToArray(e,t,i)}),r,0,i.isCyclic),{color:r}}getSubdividedPicking(){var e=this.subdiv,t=this.polymer,i=(t.residueCount-1)*e+1;t.isCyclic&&(i+=e);var n=t.structure,r=this.getAtomIterator("trace"),s=new Float32Array(i);return this.interpolator.getPicking(r,(function(e){return e.index}),s,0,t.isCyclic),{picking:new hf(s,n)}}getSubdividedPosition(){return{position:this.getPosition()}}getSubdividedOrientation(){const e=this.getTangent(),t=this.getNormals(e);return{tangent:e,normal:t.normal,binormal:t.binormal}}getSubdividedSize(e){var t=this.subdiv,i=this.polymer,n=(i.residueCount-1)*t+1;i.isCyclic&&(n+=t);var r=new Float32Array(n),s=this.getAtomIterator("trace"),o=new Tm(e);return this.interpolator.getSize(s,(function(e){return o.atomRadius(e)}),r,0,i.isCyclic),{size:r}}getPosition(){const e=this.subdiv,t=this.polymer;let i=(t.residueCount-1)*e*3+3;t.isCyclic&&(i+=3*e);const n=new Float32Array(i),r=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getPosition(r,n,0,t.isCyclic),n}getTangent(){const e=this.subdiv,t=this.polymer;let i=(this.size-1)*e*3+3;t.isCyclic&&(i+=3*e);const n=new Float32Array(i),r=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getTangent(r,n,0,t.isCyclic),n}getNormals(e){const t=this.subdiv,i=this.polymer,n=i.isProtein(),r=this.size;let s=(r-1)*t*3+3;i.isCyclic&&(s+=3*t);const o=new Float32Array(s),a=new Float32Array(s);if(this.directional&&!this.polymer.isCg()){const t=this.getAtomIterator("direction1"),r=this.getAtomIterator("direction2");this.interpolator.getNormalDir(t,r,e,o,a,0,i.isCyclic,n)}else this.interpolator.getNormal(r,e,o,a,0,i.isCyclic);return{normal:o,binormal:a}}}const xy=new Zt,by=new Zt,_y=Object.assign({radialSegments:4,capped:!1,aspectRatio:1},em);class wy extends nm{constructor(e,t={}){super(function(e,t={}){const i=Ia(t.radialSegments,4),n=Ia(t.capped,!1),r=n?i:0,s=n?i-2:0,o=e.position.length/3,a=o*i*3+2*r*3,c=2*(o-1)*i*3+2*s*3;return{position:new Float32Array(a),color:new Float32Array(a),index:Ga(c,a/3),normal:new Float32Array(a),picking:e.picking}}(e,t),t),this.capVertices=this.parameters.capped?this.parameters.radialSegments:0,this.capTriangles=this.parameters.capped?this.parameters.radialSegments-2:0,this.size2=e.position.length/3,e.primitiveId=Hl(this.size2),this.setAttributes(e),this.makeIndex()}get defaultParameters(){return _y}setAttributes(e={}){const t=this.parameters.aspectRatio,i=this.size2,n=i-1,r=this.parameters.radialSegments,s=this.geometry.attributes;let o,a,c,l,h,u,d,f,m,p,g,v,y;e.position&&(o=e.position,a=e.normal,c=e.binormal,l=e.tangent,u=e.size,f=s.position.array,p=s.normal.array,s.position.needsUpdate=!0,s.normal.needsUpdate=!0),e.color&&(h=e.color,m=s.color.array,s.color.needsUpdate=!0),e.primitiveId&&(d=e.primitiveId,g=s.primitiveId.array,s.primitiveId.needsUpdate=!0);let x=0,b=0,_=0,w=0,S=0,A=0,M=0,C=0,P=0,T=0;const I=[],E=[],D=[],L=[],R=[],k=[];if(o)for(let e=0;e<r;++e){const i=e/r*2*Math.PI;I[e]=t*Math.cos(i),E[e]=Math.sin(i),D[e]=t*Math.cos(i-.01),L[e]=Math.sin(i-.01),R[e]=t*Math.cos(i+.01),k[e]=Math.sin(i+.01)}for(let e=0;e<i;++e){v=3*e,y=v*r,o&&l&&a&&c&&u&&(xy.set(l[v],l[v+1],l[v+2]),b=a[v],_=a[v+1],w=a[v+2],S=c[v],A=c[v+1],M=c[v+2],C=o[v],P=o[v+1],T=o[v+2],x=u[e]);for(let t=0;t<r;++t){const i=y+3*t;if(o){const e=-x*I[t],n=x*E[t],r=-x*D[t],s=x*L[t],o=-x*R[t],a=x*k[t];f[i]=C+e*b+n*S,f[i+1]=P+e*_+n*A,f[i+2]=T+e*w+n*M,by.set(o*b+a*S-(r*b+s*S),o*_+a*A-(r*_+s*A),o*w+a*M-(r*w+s*M)).cross(xy),p[i]=by.x,p[i+1]=by.y,p[i+2]=by.z}h&&(m[i]=h[v],m[i+1]=h[v+1],m[i+2]=h[v+2]),d&&(g[e*r+t]=d[e])}}v=0,y=3*i*r;for(let e=0;e<r;++e){const t=v+3*e,n=y+3*e;o&&l&&(f[n]=f[t],f[n+1]=f[t+1],f[n+2]=f[t+2],p[n]=l[v],p[n+1]=l[v+1],p[n+2]=l[v+2]),h&&(m[n]=m[t],m[n+1]=m[t+1],m[n+2]=m[t+2]),d&&(g[i*r+e]=g[0+e])}v=3*(i-1)*r,y=3*(i+1)*r;for(let e=0;e<r;++e){const t=v+3*e,s=y+3*e;o&&l&&(f[s]=f[t],f[s+1]=f[t+1],f[s+2]=f[t+2],p[s]=l[3*n],p[s+1]=l[3*n+1],p[s+2]=l[3*n+2]),h&&(m[s]=m[t],m[s+1]=m[t+1],m[s+2]=m[t+2]),d&&(g[(i+1)*r+e]=g[(i-1)*r+e])}}makeIndex(){const e=this.geometry.getIndex();if(!e)return void il.error("Index is null");const t=e.array,i=this.size2,n=i-1,r=this.capTriangles,s=this.parameters.radialSegments,o=this.parameters.radialSegments+1;let a,c;for(let e=0;e<n;++e){const i=e*s*3*2,n=e*s,r=(e+1)*s;for(let e=0;e<s;++e)c=i+3*e*2,t[c]=n+e,t[c+1]=n+(e+1)%s,t[c+2]=r+e,t[c+3]=r+e,t[c+4]=n+(e+1)%s,t[c+5]=r+(e+1)%s}const l=[0];for(let e=1;e<o/2;++e)l.push(e),s-e!==e&&l.push(s-e);c=n*s*3*2,a=i*s;for(let e=0;e<l.length-2;++e)e%2==0?(t[c+3*e+0]=a+l[e+0],t[c+3*e+1]=a+l[e+1],t[c+3*e+2]=a+l[e+2]):(t[c+3*e+0]=a+l[e+2],t[c+3*e+1]=a+l[e+1],t[c+3*e+2]=a+l[e+0]);c=n*s*3*2+3*r,a=i*s+s;for(let e=0;e<l.length-2;++e)e%2==0?(t[c+3*e+0]=a+l[e+0],t[c+3*e+1]=a+l[e+1],t[c+3*e+2]=a+l[e+2]):(t[c+3*e+0]=a+l[e+2],t[c+3*e+1]=a+l[e+1],t[c+3*e+2]=a+l[e+0])}}class Sy extends Bv{constructor(e,t,i){super(e,t,i),this.type="cartoon",this.parameters=Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1,rebuild:!0},subdiv:{type:"integer",max:50,min:1,rebuild:!0},radialSegments:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},capped:{type:"boolean",rebuild:!0},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters),this.init(i)}init(e){var t=e||{};t.colorScheme=Ia(t.colorScheme,"chainname"),t.colorScale=Ia(t.colorScale,"RdYlBu"),t.radiusType=Ia(t.radiusType,"sstruc"),t.radiusScale=Ia(t.radiusScale,.7),t.useInteriorColor=Ia(t.useInteriorColor,!0),this.aspectRatio=Ia(t.aspectRatio,5),this.tension=Ia(t.tension,NaN),this.capped=Ia(t.capped,!0),this.smoothSheet=Ia(t.smoothSheet,!1),"low"===t.quality?(this.subdiv=3,this.radialSegments=6):"medium"===t.quality?this.subdiv=6:"high"===t.quality?this.subdiv=12:this.subdiv=Ia(t.subdiv,6),super.init(t)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:1!==this.aspectRatio,smoothSheet:this.smoothSheet},e)}getSpline(e){return new yy(e,this.getSplineParams())}getAspectRatio(e){return e.isCg()?1:this.aspectRatio}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}createData(e){let t=[],i=[];return this.structure.eachPolymer((e=>{if(e.residueCount<4)return;i.push(e);const n=this.getSpline(e),r=this.getAspectRatio(e),s=n.getSubdividedPosition(),o=n.getSubdividedOrientation(),a=n.getSubdividedColor(this.getColorParams()),c=n.getSubdividedPicking(),l=n.getSubdividedSize(this.getRadiusParams());t.push(new wy(Object.assign({},s,o,a,c,l),this.getBufferParams({radialSegments:this.radialSegments,aspectRatio:r,capped:this.capped})))}),e.getSelection()),{bufferList:t,polymerList:i}}updateData(t,i){e.Debug&&il.time(this.type+" repr update"),t=t||{};for(var n=0,r=i.polymerList.length;n<r;++n){var s={},o=i.polymerList[n],a=this.getSpline(o),c=this.getAspectRatio(o);if(Object.assign(i.bufferList[n],{aspectRatio:c}),t.position||t.radius){var l=a.getSubdividedPosition(),h=a.getSubdividedOrientation(),u=a.getSubdividedSize(this.getRadiusParams(c));s.position=l.position,s.normal=h.normal,s.binormal=h.binormal,s.tangent=h.tangent,s.size=u.size}if(t.color){var d=a.getSubdividedColor(this.getColorParams());s.color=d.color}if(t.picking){var f=a.getSubdividedPicking();s.picking=f.picking}i.bufferList[n].setAttributes(s)}e.Debug&&il.timeEnd(this.type+" repr update")}setParameters(e){var t={};return e&&e.aspectRatio&&(t.radius=!0),e&&e.tension&&(t.position=!0),super.setParameters(e,t,!1),this}}ll.add("cartoon",Sy);class Ay extends Bv{constructor(e,t,i){super(e,t,i),this.type="contact",this.parameters=Object.assign({hydrogenBond:{type:"boolean",rebuild:!0},weakHydrogenBond:{type:"boolean",rebuild:!0},waterHydrogenBond:{type:"boolean",rebuild:!0},backboneHydrogenBond:{type:"boolean",rebuild:!0},hydrophobic:{type:"boolean",rebuild:!0},halogenBond:{type:"boolean",rebuild:!0},ionicInteraction:{type:"boolean",rebuild:!0},metalCoordination:{type:"boolean",rebuild:!0},cationPi:{type:"boolean",rebuild:!0},piStacking:{type:"boolean",rebuild:!0},filterSele:{type:"text",rebuild:!0},labelVisible:{type:"boolean",rebuild:!0},labelFixedSize:{type:"boolean",buffer:"fixedSize"},labelSize:{type:"number",precision:3,max:10,min:.001,rebuild:!0},labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},maxHydrophobicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondSulfurDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondAccAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondDonAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondAccPlaneAngle:{type:"integer",max:90,min:0,rebuild:!0},maxHbondDonPlaneAngle:{type:"integer",max:90,min:0,rebuild:!0},maxPiStackingDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingAngle:{type:"integer",max:180,min:0,rebuild:!0},maxCationPiDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxCationPiOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxIonicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondAngle:{type:"integer",max:180,min:0,rebuild:!0},maxMetalDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},refineSaltBridges:{type:"boolean",rebuild:!0},masterModelIndex:{type:"integer",max:1e3,min:-1,rebuild:!0},lineOfSightDistFactor:{type:"number",precision:1,max:10,min:0,rebuild:!0},radialSegments:!0,disableImpostor:!0},this.parameters),this.init(i)}init(e){var t=e||{};t.radiusSize=Ia(t.radiusSize,.05),t.useInteriorColor=Ia(t.useInteriorColor,!0),this.hydrogenBond=Ia(t.hydrogenBond,!0),this.weakHydrogenBond=Ia(t.weakHydrogenBond,!1),this.waterHydrogenBond=Ia(t.waterHydrogenBond,!1),this.backboneHydrogenBond=Ia(t.backboneHydrogenBond,!1),this.hydrophobic=Ia(t.hydrophobic,!1),this.halogenBond=Ia(t.halogenBond,!0),this.ionicInteraction=Ia(t.ionicInteraction,!0),this.metalCoordination=Ia(t.metalCoordination,!0),this.cationPi=Ia(t.cationPi,!0),this.piStacking=Ia(t.piStacking,!0),this.filterSele=Ia(t.filterSele,""),this.labelVisible=Ia(t.labelVisible,!1),this.labelFixedSize=Ia(t.labelFixedSize,!1),this.labelSize=Ia(t.labelSize,2),this.labelUnit=Ia(t.labelUnit,""),this.maxHydrophobicDist=Ia(t.maxHydrophobicDist,4),this.maxHbondDist=Ia(t.maxHbondDist,3.5),this.maxHbondSulfurDist=Ia(t.maxHbondSulfurDist,4.1),this.maxHbondAccAngle=Ia(t.maxHbondAccAngle,45),this.maxHbondDonAngle=Ia(t.maxHbondDonAngle,45),this.maxHbondAccPlaneAngle=Ia(t.maxHbondAccPlaneAngle,90),this.maxHbondDonPlaneAngle=Ia(t.maxHbondDonPlaneAngle,30),this.maxPiStackingDist=Ia(t.maxPiStackingDist,5.5),this.maxPiStackingOffset=Ia(t.maxPiStackingOffset,2),this.maxPiStackingAngle=Ia(t.maxPiStackingAngle,30),this.maxCationPiDist=Ia(t.maxCationPiDist,6),this.maxCationPiOffset=Ia(t.maxCationPiOffset,2),this.maxIonicDist=Ia(t.maxIonicDist,5),this.maxHalogenBondDist=Ia(t.maxHalogenBondDist,3.5),this.maxHalogenBondAngle=Ia(t.maxHalogenBondAngle,30),this.maxMetalDist=Ia(t.maxMetalDist,3),this.refineSaltBridges=Ia(t.refineSaltBridges,!0),this.masterModelIndex=Ia(t.masterModelIndex,-1),this.lineOfSightDistFactor=Ia(t.lineOfSightDistFactor,1),super.init(t)}getAtomRadius(){return 0}getContactData(e){const t={maxHydrophobicDist:this.maxHydrophobicDist,maxHbondDist:this.maxHbondDist,maxHbondSulfurDist:this.maxHbondSulfurDist,maxHbondAccAngle:this.maxHbondAccAngle,maxHbondDonAngle:this.maxHbondDonAngle,maxHbondAccPlaneAngle:this.maxHbondAccPlaneAngle,maxHbondDonPlaneAngle:this.maxHbondDonPlaneAngle,maxPiStackingDist:this.maxPiStackingDist,maxPiStackingOffset:this.maxPiStackingOffset,maxPiStackingAngle:this.maxPiStackingAngle,maxCationPiDist:this.maxCationPiDist,maxCationPiOffset:this.maxCationPiOffset,maxIonicDist:this.maxIonicDist,maxHalogenBondDist:this.maxHalogenBondDist,maxHalogenBondAngle:this.maxHalogenBondAngle,maxMetalDist:this.maxMetalDist,refineSaltBridges:this.refineSaltBridges,masterModelIndex:this.masterModelIndex,lineOfSightDistFactor:this.lineOfSightDistFactor},i={hydrogenBond:this.hydrogenBond,weakHydrogenBond:this.weakHydrogenBond,waterHydrogenBond:this.waterHydrogenBond,backboneHydrogenBond:this.backboneHydrogenBond,hydrophobic:this.hydrophobic,halogenBond:this.halogenBond,ionicInteraction:this.ionicInteraction,metalCoordination:this.metalCoordination,cationPi:this.cationPi,piStacking:this.piStacking,radius:this.radiusSize*this.radiusScale,filterSele:this.filterSele};return af(nf(e,t),e,i)}createData(e){const t=this.getContactData(e),i=[new dy(Tu(t),this.getBufferParams({sphereDetail:1,dullInterior:!0,disableImpostor:this.disableImpostor}))];if(this.labelVisible){const e={size:this.labelSize,unit:this.labelUnit};i.push(new Xv(function(e,t){const i=Ul(e.position1,e.position2),n=[],r=$l(e.position1,e.position2),s=r.length/3;for(let e=0;e<s;e++){const i=3*e,s=Math.sqrt(Math.pow(r[i],2)+Math.pow(r[i+1],2)+Math.pow(r[i+2],2));switch(t.unit){case"angstrom":n[e]=s.toFixed(2)+" "+String.fromCharCode(8491);break;case"nm":n[e]=(s/10).toFixed(2)+" nm";break;default:n[e]=s.toFixed(2)}}return{position:i,size:Gl(i.length/3,t.size),color:e.color,text:n}}(t,e),this.getBufferParams({fixedSize:this.labelFixedSize})))}return{bufferList:i}}}ll.add("contact",Ay);class My extends Nv{constructor(e,t,i){super(e,t,i),this.type="dihedral",this.parameters=Object.assign({atomQuad:{type:"hidden",rebuild:!0},extendLine:{type:"boolean",rebuild:!0,default:!0},lineVisible:{type:"boolean",default:!0},planeVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(i)}init(e){const t=e||{};t.side=Ia(t.side,"double"),t.opacity=Ia(t.opacity,.5),this.atomQuad=Ia(t.atomQuad,[]),this.extendLine=Ia(t.extendLine,!0),this.lineVisible=Ia(t.lineVisible,!0),this.planeVisible=Ia(t.planeVisible,!0),this.sectorVisible=Ia(t.sectorVisible,!0),super.init(t)}createData(e){if(!e.atomCount||!this.atomQuad.length)return;const t=function(e,t={}){const i=Ia(t.angleStep,Math.PI/90),n=e.length,r=e.length/12,s=new Float32Array(r),o=new Float32Array(3*r),a=new Array(r),c=new Array(r),l=new Array(r),h=new Array(r),u=new Array(r);let d=0,f=0,m=0;const p=hu(),g=hu(),v=hu(),y=hu(),x=hu(),b=hu(),_=hu(),w=hu(),S=hu(),A=hu(),M=hu(),C=hu(),P=hu(),T=hu(),I=hu();let E=0;for(var D=0;D<n;D+=12){if(pu(p,e,D),pu(g,e,D+3),pu(v,e,D+6),pu(y,e,D+9),fu(x,p,g),fu(b,v,g),0===yu(b))continue;fu(_,y,v),bu(w,b,.5),mu(S,g,w),_u(x,x),_u(b,b),_u(_,_),fu(w,p,S);const n=du(w,b)>0;fu(w,y,S);const r=du(w,b)<0;if(bu(w,b,du(b,x)),fu(A,x,w),bu(w,b,du(b,_)),fu(M,_,w),0===yu(A)||0===yu(M))continue;_u(A,A),_u(M,M);const L=s[E]=Pu(A,M);a[E]=(Fl*L).toFixed(1)+String.fromCharCode(176),uu(T,A,b),_u(T,T),du(T,M)<0&&Cu(T,T),zv(w,S,A,T,L/2),gu(w,o,3*E);const R=Math.ceil(L/i),k=R+(t.extendLine?4:2),O=t.extendLine?36:0,B=new Float32Array(3*k),N=new Float32Array(3*k),F=new Float32Array(9*R),z=new Float32Array(O);c[E]=B,l[E]=N,h[E]=F,u[E]=z,t.extendLine&&(n?(fu(w,p,v),_u(w,w),bu(C,w,1/du(A,w)),mu(C,C,v)):(bu(C,x,1/du(A,x)),mu(C,C,g)),r?(fu(w,y,g),_u(w,w),bu(P,w,1/du(M,w)),mu(P,P,g)):(bu(P,_,1/du(M,_)),mu(P,P,v))),mu(I,S,A);let U=0;t.extendLine?(gu(p,B,U),gu(C,N,U),U+=3,gu(C,B,U),gu(I,N,U),U+=3,gu(C,z,0),gu(I,z,3),gu(n?v:g,z,6),gu(n?v:g,z,9),gu(I,z,12),gu(S,z,15)):(gu(S,B,U),gu(I,N,U),U+=3);const $=function(e,t){const i=9*t;gu(S,F,i),gu(I,F,i+3),gu(I,B,U),zv(I,S,A,T,e),gu(I,F,i+6),gu(I,N,U),U+=3};let G=0;for(let e=i;e<L;e+=i)$(e,G++);$(L,G++),t.extendLine?(gu(I,B,3*(k-2)),gu(P,N,3*(k-2)),gu(P,B,3*(k-1)),gu(y,N,3*(k-1)),gu(P,z,18),gu(I,z,21),gu(r?g:v,z,24),gu(r?g:v,z,27),gu(I,z,30),gu(S,z,33)):(gu(I,B,U),gu(S,N,U),U+=3),d+=3*k,f+=9*R,m+=O,E+=1}const L=E,R=new Float32Array(d),k=new Float32Array(d),O=new Float32Array(f),B=new Float32Array(m);let N=0,F=0,z=0;for(let e=0;e<L;e++){const t=c[e],i=l[e],n=h[e],r=u[e];ql(t,R,0,N,t.length),ql(i,k,0,N,i.length),ql(n,O,0,F,n.length),ql(r,B,0,z,r.length),N+=t.length,F+=n.length,z+=r.length}return{labelPosition:o.subarray(0,3*L),labelText:a.slice(0,L),linePosition1:R,linePosition2:k,planePosition:B,sectorPosition:O}}(Fv(e,this.atomQuad),{extendLine:this.extendLine}),i=this.n=t.labelText.length,n=new mn(this.labelColor);this.textBuffer=new Xv({position:t.labelPosition,size:Gl(i,this.labelSize),color:Vl(i,n.r,n.g,n.b),text:t.labelText},this.getLabelBufferParams());const r=new mn(this.colorValue);this.lineLength=t.linePosition1.length/3;const s=Vl(this.lineLength,r.r,r.g,r.b);return this.lineBuffer=new Kv(Eu({position1:t.linePosition1,position2:t.linePosition2,color:s,color2:s}),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),this.planeLength=t.planePosition.length/3,this.planeBuffer=new nm({position:t.planePosition,color:Vl(this.planeLength,r.r,r.g,r.b)},this.getBufferParams({visible:this.planeVisible})),this.sectorLength=t.sectorPosition.length/3,this.sectorBuffer=new nm({position:t.sectorPosition,color:Vl(this.sectorLength,r.r,r.g,r.b)},this.getBufferParams({visible:this.sectorVisible})),{bufferList:[this.textBuffer,this.lineBuffer,this.planeBuffer,this.sectorBuffer]}}updateData(e,t){super.updateData(e,t);const i={},n={},r={};if(e.color){const e=new mn(this.colorValue);Object.assign(i,{color:Vl(this.lineLength,e.r,e.g,e.b),color2:Vl(this.lineLength,e.r,e.g,e.b)}),Object.assign(n,{color:Vl(this.planeLength,e.r,e.g,e.b)}),Object.assign(r,{color:Vl(this.sectorLength,e.r,e.g,e.b)})}this.lineBuffer.setAttributes(i),this.planeBuffer.setAttributes(n),this.sectorBuffer.setAttributes(r)}setParameters(e){return super.setParameters(e,{},!1),!e||void 0===e.lineVisible&&void 0===e.sectorVisible&&void 0===e.planeVisible||this.setVisibility(this.visible),e&&e.lineOpacity&&this.lineBuffer.setParameters({opacity:e.lineOpacity}),e&&void 0!==e.opacity&&this.lineBuffer.setParameters({opacity:this.lineOpacity}),e&&e.linewidth&&this.lineBuffer.setParameters({linewidth:e.linewidth}),this}setVisibility(e,t){return super.setVisibility(e,!0),this.lineBuffer&&this.lineBuffer.setVisibility(this.lineVisible&&this.visible),this.planeBuffer&&this.planeBuffer.setVisibility(this.planeVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),t||this.viewer.requestRender(),this}}ll.add("dihedral",My);function Cy(e,t){function i(e,t){return t in e}const n=Object.assign({},e);for(const e in n)i(n,e)&&i(t,e)&&(n[e]=Ia(t[e],n[e]));return n}function Py(e,t){const i=new mn(e),n=new Float32Array(3*t);return Vl(t,i.r,i.g,i.b,n),n}class Ty extends Bv{constructor(e,t,i){super(e,t,i),this.type="dihedral-histogram",this.parameters=Object.assign({histogramsData:{type:"hidden",rebuild:!0},histogramBinBorderVisible:{type:"boolean",default:!0},scaleBinToSectorArea:{type:"boolean",rebuild:!0,default:!1}},this.parameters),this.init(i)}init(e){const t=e||{},i=Cy({histogramBinBorderColor:"grey",adjacentBondArrowColor:"black",distantBondArrowColor:"magenta",frontHistogramColor:"green",backHistogramColor:"blue",opaqueMiddleDiscColor:"white"},t);Object.assign(this,i);const n=Cy({histogramsData:[],histogramOpacity:1,opaqueMiddleDiscVisible:!0,opaqueMiddleDiscOpacity:1,histogramBinBorderVisible:!0,histogramBinBorderWidth:1,histogramBinBorderOpacity:.5,bondArrowVisible:!0,bondArrowWidth:2,bondArrowOpacity:1,scaleBinToSectorArea:!1},t);Object.assign(this,n),this.histogramsData.forEach((e=>{const t=Cy(i,e);Object.assign(e,t)})),t.side=Ia(t.side,"double"),t.opacity=Ia(t.opacity,.5),t.radiusType=Ia(t.radiusType,"size"),t.radiusSize=Ia(t.radiusSize,.15),super.init(t)}getHistogramBinBorderBufferParameters(){return this.getBufferParams({linewidth:this.histogramBinBorderWidth,visible:this.histogramBinBorderVisible,opacity:this.histogramBinBorderOpacity})}getBondArrowsBufferParameters(){return this.getBufferParams({linewidth:this.bondArrowWidth,visible:this.bondArrowVisible,opacity:this.bondArrowOpacity})}getOpaqueMiddleDiscBufferParameters(){return this.getBufferParams({visible:this.opaqueMiddleDiscVisible,opacity:this.opaqueMiddleDiscOpacity})}getHistogramBufferParameters(){return this.getBufferParams({visible:!0,opacity:this.histogramOpacity,side:"double"})}createData(e){if(!e.atomCount||!this.histogramsData.length)return;this.histogramsData.forEach((t=>t.atomPositions=Fv(e,[t.atomQuad])));const t=this.scaleBinToSectorArea?function(e){return Math.sqrt(e)}:function(e){return e};function i(e){const t=e.map((e=>e.length)),i=new Float32Array(Kl(t));let n=0;for(let t=0;t<e.length;t++)i.set(e[t],n),n+=e[t].length;return i}function n(e,t){return new Kv({position1:i(e.map((e=>e.startPoints))),position2:i(e.map((e=>e.endPoints))),color:i(e.map((e=>e.startColors))),color2:i(e.map((e=>e.endColors)))},t)}function r(e,t){return new nm({position:i(e.map((e=>e.triangles))),color:i(e.map((e=>e.triangleColors)))},t)}this.histogramsData.forEach((e=>e.histogram360Scaled=e.histogram360.map(t)));const s=[];for(let e=0;e<this.histogramsData.length;e++){let t,i=this.histogramsData[e];i.histogram360.length>=3&&(t=Iy(i)),void 0!==t&&s.push(t)}return this.frontHistogramBinBordersBuffer=n(s.map((e=>e.frontHistogramBinBorders)),this.getHistogramBinBorderBufferParameters()),this.backHistogramBinBordersBuffer=n(s.map((e=>e.backHistogramBinBorders)),this.getHistogramBinBorderBufferParameters()),this.adjacentBondArrowsBuffer=n(s.map((e=>e.adjacentBondArrows)),this.getBondArrowsBufferParameters()),this.distantBondArrowsBuffer=n(s.map((e=>e.distantBondArrows)),this.getBondArrowsBufferParameters()),this.opaqueMiddleDiscBuffer=r(s.map((e=>e.opaqueMiddleDisc)),this.getOpaqueMiddleDiscBufferParameters()),this.frontHistogramBuffer=r(s.map((e=>e.frontHistogram)),this.getHistogramBufferParameters()),this.backHistogramBuffer=r(s.map((e=>e.backHistogram)),this.getHistogramBufferParameters()),{bufferList:[].concat(this.frontHistogramBinBordersBuffer,this.backHistogramBinBordersBuffer,this.adjacentBondArrowsBuffer,this.distantBondArrowsBuffer,this.opaqueMiddleDiscBuffer,this.frontHistogramBuffer,this.backHistogramBuffer)}}setParameters(e){return super.setParameters(e,{},!1),e&&void 0!==e.histogramBinBorderVisible&&this.setVisibility(this.visible),this}setVisibility(e,t){return super.setVisibility(e,!0),this.frontHistogramBinBordersBuffer&&this.frontHistogramBinBordersBuffer.setVisibility(this.histogramBinBorderVisible),this.backHistogramBinBordersBuffer&&this.backHistogramBinBordersBuffer.setVisibility(this.histogramBinBorderVisible),t||this.viewer.requestRender(),this}}function Iy(e){const t=e.atomPositions,i=e.histogram360Scaled,n=i.length<=180?360:2*i.length,r={triangles:new Float32Array(3*n*3),triangleColors:Py(e.opaqueMiddleDiscColor,3*n)},s={triangles:new Float32Array(3*i.length*3),triangleColors:Py(e.frontHistogramColor,3*i.length)},o={triangles:new Float32Array(3*i.length*3),triangleColors:Py(e.backHistogramColor,3*i.length)},a={startPoints:new Float32Array(3*i.length),endPoints:new Float32Array(3*i.length),startColors:Py(e.histogramBinBorderColor,i.length),endColors:Py(e.histogramBinBorderColor,i.length)},c={startPoints:new Float32Array(3*i.length),endPoints:new Float32Array(3*i.length),startColors:Py(e.histogramBinBorderColor,i.length),endColors:Py(e.histogramBinBorderColor,i.length)},l={startPoints:new Float32Array(6),endPoints:new Float32Array(6),startColors:Py(e.adjacentBondArrowColor,i.length),endColors:Py(e.adjacentBondArrowColor,i.length)},h={startPoints:new Float32Array(6),endPoints:new Float32Array(6),startColors:Py(e.distantBondArrowColor,i.length),endColors:Py(e.distantBondArrowColor,i.length)},u=hu(),d=hu(),f=hu(),m=hu(),p=hu(),g=hu(),v=hu(),y=hu(),x=hu(),b=hu(),_=hu(),w=hu(),S=hu(),A=hu(),M=hu(),C=hu(),P=[u,d,f,m];for(let e=0;e<P.length;e++)pu(P[e],t,3*e);if(fu(p,u,d),fu(g,f,d),fu(y,m,f),0===yu(g))return;if(bu(M,g,.5),mu(x,d,M),_u(p,p),_u(g,g),_u(y,y),Cu(v,g),bu(M,v,du(v,p)),fu(b,p,M),bu(M,g,du(g,y)),fu(_,y,M),0===yu(b)||0===yu(_))return;_u(b,b),_u(_,_);const T=Math.acos(du(b,_));uu(w,v,b),uu(S,g,_),_u(w,w),_u(S,S);let I=T;du(w,_)<0&&(I=-T),mu(A,x,b);const E=Math.max.apply(null,i),D=2*Math.PI/i.length;function L(e,t,n,r,s){const o=3*t*3;gu(x,e,o);const a=Number(i[t])/E;bu(M,n,a),bu(C,r,a),zv(A,x,M,C,t*s),gu(A,e,o+3),zv(A,x,M,C,(t+1)*s),gu(A,e,o+6)}function R(e,t,n,r,s){ql(x,l.startPoints,0,3*n,x.length),zv(M,x,r,s,0+0*D),ql(M,l.endPoints,0,3*n,x.length),ql(x,h.startPoints,0,3*n,x.length),zv(M,x,r,s,I),ql(M,h.endPoints,0,3*n,x.length);for(let e=0;e<i.length;e++)ql(x,t.startPoints,0,3*e,x.length),zv(M,x,r,s,0+D*e),ql(M,t.endPoints,0,3*e,M.length);for(let t=0;t<i.length;t++)L(e.triangles,t,r,s,D)}const k=2*Math.PI/n;for(let e=0;e<n;e++){const t=3*e*3;gu(x,r.triangles,t),zv(A,x,b,w,e*k),gu(A,r.triangles,t+3),zv(A,x,b,w,(e+1)*k),gu(A,r.triangles,t+6)}return bu(M,g,-.01),mu(x,x,M),R(s,a,0,b,w),bu(M,g,.02),mu(x,x,M),R(o,c,1,_,S),{opaqueMiddleDisc:r,frontHistogram:s,backHistogram:o,frontHistogramBinBorders:a,backHistogramBinBorders:c,adjacentBondArrows:l,distantBondArrows:h}}ll.add("dihedral-histogram",Ty);class Ey extends Nv{constructor(e,t,i){super(e,t,i),this.type="distance",this.parameters=Object.assign({radialSegments:!0,openEnded:!0,disableImpostor:!0,labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},useCylinder:{type:"boolean",rebuild:!0},atomPair:{type:"hidden",rebuild:!0}},this.parameters),this.init(i)}init(e){const t=e||{};t.linewidth=Ia(t.linewidth,5),t.radiusType=Ia(t.radiusType,"size"),t.radiusSize=Ia(t.radiusSize,.2),this.labelUnit=Ia(t.labelUnit,""),this.useCylinder=Ia(t.useCylinder,!1),this.atomPair=Ia(t.atomPair,[]),super.init(t)}getDistanceData(e,t){let i=t.length;const n=new Array(i);let r=new Float32Array(3*i);const s=new $c,o=new $c,a=new km,c=e.getAtomProxy(),l=e.getAtomProxy();let h=0;const u=e.getAtomSet();t.forEach(((t,i)=>{let d=t[0],f=t[1];if("number"==typeof d&&Number.isInteger(d)&&"number"==typeof f&&Number.isInteger(f)){if(!u.get(d)||!u.get(f))return void(h+=1);c.index=d,l.index=f}else{s.setString(d),o.setString(f);var m=e.getAtomIndices(s),p=e.getAtomIndices(o);if(!m.length||!p.length)return void(h+=1);c.index=m[0],l.index=p[0]}a.addBond(c,l,1),i-=h;var g=c.distanceTo(l);switch(this.labelUnit){case"angstrom":n[i]=g.toFixed(2)+" "+String.fromCharCode(8491);break;case"nm":n[i]=(g/10).toFixed(2)+" nm";break;default:n[i]=g.toFixed(2)}var v=3*i;r[v+0]=(c.x+l.x)/2,r[v+1]=(c.y+l.y)/2,r[v+2]=(c.z+l.z)/2})),h>0&&(i-=h,r=r.subarray(0,3*i));var d=new Yu(a.count,!0);return{text:n,position:r,bondSet:d,bondStore:a}}getBondData(e,t,i){const n=e.getBondData(this.getBondParams(t,i));return n.picking&&(n.picking=new pf(n.picking.array,n.picking.structure,i.bondStore)),n}createData(e){if(!e.atomCount||!this.atomPair.length)return;const t=this.atomPair.length,i=new mn(this.labelColor),n=this.getDistanceData(e,this.atomPair);this.textBuffer=new Xv({position:n.position,size:Gl(t,this.labelSize),color:Vl(t,i.r,i.g,i.b),text:n.text},this.getLabelBufferParams());const r={bondSet:n.bondSet,bondStore:n.bondStore},s=this.getBondData(e,{position:!0,color:!0,picking:!0,radius:this.useCylinder},r);return this.useCylinder?this.distanceBuffer=new dy(s,this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})):this.distanceBuffer=new Kv(Iu(s),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),{bondSet:n.bondSet,bondStore:n.bondStore,position:n.position,bufferList:[this.textBuffer,this.distanceBuffer]}}updateData(e,t){super.updateData(e,t);const i={bondSet:t.bondSet,bondStore:t.bondStore},n=this.getBondData(t.sview,e,i),r={};e&&!e.color||Object.assign(r,{color:n.color,color2:n.color2}),e&&!e.radius||Object.assign(r,{radius:n.radius}),this.distanceBuffer.setAttributes(r)}setParameters(e){return super.setParameters(e,{},!1),this.useCylinder||(e&&e.lineOpacity&&this.distanceBuffer.setParameters({opacity:e.lineOpacity}),e&&void 0!==e.opacity&&this.distanceBuffer.setParameters({opacity:this.lineOpacity}),e&&e.linewidth&&this.distanceBuffer.setParameters({linewidth:e.linewidth})),this}}function Dy(e){return 2*(e.position.length/3)*3}ll.add("distance",Ey);const Ly=Object.assign({scale:1,color:"grey"},em);class Ry extends im{constructor(e,t={}){super({position:new Float32Array(Dy(e)),color:new Float32Array(Dy(e))},t),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag";const i=new mn(this.parameters.color),n=this.geometry.attributes;Vl(Dy(e)/3,i.r,i.g,i.b,n.color.array),this.setAttributes(e)}get defaultParameters(){return Ly}setAttributes(e={}){const t=this.geometry.attributes;let i,n,r;e.position&&e.vector&&(i=e.position,n=e.vector,r=t.position.array,t.position.needsUpdate=!0);const s=this.size/2,o=this.parameters.scale;if(i&&n)for(let e=0;e<s;e++){const t=2*e*3,s=3*e;r[t+0]=i[s+0],r[t+1]=i[s+1],r[t+2]=i[s+2],r[t+3]=i[s+0]+n[s+0]*o,r[t+4]=i[s+1]+n[s+1]*o,r[t+5]=i[s+2]+n[s+2]*o}}}class ky extends Bv{constructor(e,t,i){super(e,t,i),this.type="helixorient",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(i)}init(e){const t=e||{};t.colorScheme=Ia(t.colorScheme,"sstruc"),t.radiusType=Ia(t.radiusType,"size"),t.radiusSize=Ia(t.radiusSize,.15),t.radiusScale=Ia(t.radiusScale,1),t.useInteriorColor=Ia(t.useInteriorColor,!0),super.init(t)}createData(e){const t=[],i=[];return this.structure.eachPolymer((e=>{if(e.residueCount<4)return;i.push(e);const n=new zm(e),r=n.getPosition(),s=n.getColor(this.getColorParams()),o=n.getSize(this.getRadiusParams()),a=n.getPicking();t.push(new tg({position:r.center,color:s.color,radius:o.size,picking:a.picking},this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),new Ry({position:r.center,vector:r.axis},this.getBufferParams({color:"skyblue",scale:1})),new Ry({position:r.center,vector:r.resdir},this.getBufferParams({color:"lightgreen",scale:1})))}),e.getSelection()),{bufferList:t,polymerList:i}}updateData(t,i){e.Debug&&il.time(this.type+" repr update"),t=t||{};for(let e=0,n=i.polymerList.length;e<n;++e){const n=3*e,r={},s=i.polymerList[e],o=new zm(s);if(t.position){const e=o.getPosition();Object.assign(r,{position:e.center}),i.bufferList[n+1].setAttributes({position:e.center,vector:e.axis}),i.bufferList[n+2].setAttributes({position:e.center,vector:e.resdir})}i.bufferList[n].setAttributes(r)}e.Debug&&il.timeEnd(this.type+" repr update")}}ll.add("helixorient",ky);class Oy extends my{constructor(e,t,i){super(e,t,i),this.type="licorice",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}init(e){var t=e||{};t.aspectRatio=1,super.init(t)}}ll.add("licorice",Oy),ul.add("shader/HyperballStickImpostor.vert","\nattribute vec3 mapping;\nattribute float radius;\nattribute float radius2;\nattribute vec3 position1;\nattribute vec3 position2;\nvarying mat4 matrix_near;\nvarying vec4 prime1;\nvarying vec4 prime2;\nvarying float vRadius;\nvarying float vRadius2;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#endif\nuniform float shrink;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewProjectionMatrixInverse;\nvoid main(){\nvRadius = radius;\nvRadius2 = radius2;\nvec4 spaceposition;\nvec3 position_atom1;\nvec3 position_atom2;\nvec4 vertex_position;\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nvColor1 = color;\nvColor2 = color2;\n#endif\nfloat radius1 = radius;\nposition_atom1 = position1;\nposition_atom2 = position2;\nfloat distance = distance( position_atom1, position_atom2 );\nspaceposition.z = mapping.z * distance;\nif (radius1 > radius2) {\nspaceposition.y = mapping.y * 1.5 * radius1;\nspaceposition.x = mapping.x * 1.5 * radius1;\n} else {\nspaceposition.y = mapping.y * 1.5 * radius2;\nspaceposition.x = mapping.x * 1.5 * radius2;\n}\nspaceposition.w = 1.0;\nvec4 e3 = vec4( 1.0 );\nvec3 e1, e1_temp, e2, e2_temp;\ne3.xyz = normalize(position_atom1-position_atom2);\nif (e3.z == 0.0) { e3.z = 0.0000000000001;}\nif ( (position_atom1.x - position_atom2.x) == 0.0) { position_atom1.x += 0.001;}\nif ( (position_atom1.y - position_atom2.y) == 0.0) { position_atom1.y += 0.001;}\nif ( (position_atom1.z - position_atom2.z) == 0.0) { position_atom1.z += 0.001;}\nvec4 focus = vec4( 1.0 );\nfocus.x = ( position_atom1.x*position_atom1.x - position_atom2.x*position_atom2.x +\n( radius2*radius2 - radius1*radius1 )*e3.x*e3.x/shrink )/(2.0*(position_atom1.x - position_atom2.x));\nfocus.y = ( position_atom1.y*position_atom1.y - position_atom2.y*position_atom2.y +\n( radius2*radius2 - radius1*radius1 )*e3.y*e3.y/shrink )/(2.0*(position_atom1.y - position_atom2.y));\nfocus.z = ( position_atom1.z*position_atom1.z - position_atom2.z*position_atom2.z +\n( radius2*radius2 - radius1*radius1 )*e3.z*e3.z/shrink )/(2.0*(position_atom1.z - position_atom2.z));\ne1.x = 1.0;\ne1.y = 1.0;\ne1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;\ne1_temp = e1 - focus.xyz;\ne1 = normalize(e1_temp);\ne2_temp = e1.yzx * e3.zxy - e1.zxy * e3.yzx;\ne2 = normalize(e2_temp);\nmat3 R= mat3( e1.xyz, e2.xyz, e3.xyz );\nvertex_position.xyz = R * spaceposition.xyz;\nvertex_position.w = 1.0;\nvertex_position.x += (position_atom1.x+position_atom2.x) / 2.0;\nvertex_position.y += (position_atom1.y+position_atom2.y) / 2.0;\nvertex_position.z += (position_atom1.z+position_atom2.z) / 2.0;\ngl_Position = modelViewProjectionMatrix * vertex_position;\nvec4 i_near, i_far;\nvec4 near = gl_Position;\nnear.z = 0.0 ;\nnear = modelViewProjectionMatrixInverse * near;\ni_near = near;\nvec4 far = gl_Position;\nfar.z = far.w ;\ni_far = modelViewProjectionMatrixInverse * far;\nprime1 = vec4( position_atom1 - (position_atom1 - focus.xyz)*shrink, 1.0 );\nprime2 = vec4( position_atom2 - (position_atom2 - focus.xyz)*shrink, 1.0 );\nfloat Rsquare = (radius1*radius1/shrink) - (\n(position_atom1.x - focus.x)*(position_atom1.x - focus.x) +\n(position_atom1.y - focus.y)*(position_atom1.y - focus.y) +\n(position_atom1.z - focus.z)*(position_atom1.z - focus.z)\n);\nfocus.w = Rsquare;\nmatrix_near = mat4( i_near, i_far, focus, e3 );\ngl_Position.z = 1.0;\n}"),ul.add("shader/HyperballStickImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 interiorColor;\nuniform float interiorDarkening;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform float shrink;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrixInverseTranspose;\nuniform mat4 projectionMatrix;\nvarying mat4 matrix_near;\nvarying vec4 prime1;\nvarying vec4 prime2;\nvarying float vRadius;\nvarying float vRadius2;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#include common\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars_begin\n#include lights_physical_pars_fragment\n#endif\nbool interior = false;\nfloat calcClip( vec4 cameraPos ){\nreturn dot( cameraPos, vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nfloat calcClip( vec3 cameraPos ){\nreturn calcClip( vec4( cameraPos, 1.0 ) );\n}\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nstruct Ray {\nvec3 origin ;\nvec3 direction ;\n};\nbool cutoff_plane (vec3 M, vec3 cutoff, vec3 x3){\nfloat a = x3.x;\nfloat b = x3.y;\nfloat c = x3.z;\nfloat d = -x3.x*cutoff.x-x3.y*cutoff.y-x3.z*cutoff.z;\nfloat l = a*M.x+b*M.y+c*M.z+d;\nif (l<0.0) {return true;}\nelse{return false;}\n}\nvec3 isect_surf(Ray r, mat4 matrix_coef){\nvec4 direction = vec4(r.direction, 0.0);\nvec4 origin = vec4(r.origin, 1.0);\nfloat a = dot(direction,(matrix_coef*direction));\nfloat b = dot(origin,(matrix_coef*direction));\nfloat c = dot(origin,(matrix_coef*origin));\nfloat delta =b*b-a*c;\ngl_FragColor.a = 1.0;\nif (delta<0.0){\ndiscard;\n}\nfloat t1 =(-b-sqrt(delta))/a;\nreturn r.origin+t1*r.direction;\n}\nvec3 isect_surf2(Ray r, mat4 matrix_coef){\nvec4 direction = vec4(r.direction, 0.0);\nvec4 origin = vec4(r.origin, 1.0);\nfloat a = dot(direction,(matrix_coef*direction));\nfloat b = dot(origin,(matrix_coef*direction));\nfloat c = dot(origin,(matrix_coef*origin));\nfloat delta =b*b-a*c;\ngl_FragColor.a = 1.0;\nif (delta<0.0){\ndiscard;\n}\nfloat t2 =(-b+sqrt(delta))/a;\nreturn r.origin+t2*r.direction;\n}\nRay primary_ray(vec4 near1, vec4 far1){\nvec3 near=near1.xyz/near1.w;\nvec3 far=far1.xyz/far1.w;\nreturn Ray(near,far-near);\n}\nfloat update_z_buffer(vec3 M, mat4 ModelViewP){\nfloat depth1;\nvec4 Ms=(ModelViewP*vec4(M,1.0));\nreturn depth1=(1.0+Ms.z/Ms.w)/2.0;\n}\nvoid main(){\nfloat radius = max( vRadius, vRadius2 );\nvec4 i_near, i_far, focus;\nvec3 e3, e1, e1_temp, e2;\ni_near = vec4(matrix_near[0][0],matrix_near[0][1],matrix_near[0][2],matrix_near[0][3]);\ni_far = vec4(matrix_near[1][0],matrix_near[1][1],matrix_near[1][2],matrix_near[1][3]);\nfocus = vec4(matrix_near[2][0],matrix_near[2][1],matrix_near[2][2],matrix_near[2][3]);\ne3 = vec3(matrix_near[3][0],matrix_near[3][1],matrix_near[3][2]);\ne1.x = 1.0;\ne1.y = 1.0;\ne1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;\ne1_temp = e1 - focus.xyz;\ne1 = normalize(e1_temp);\ne2 = normalize(cross(e1,e3));\nvec4 equation = focus;\nfloat shrinkfactor = shrink;\nfloat t1 = -1.0/(1.0-shrinkfactor);\nfloat t2 = 1.0/(shrinkfactor);\nvec4 colonne1, colonne2, colonne3, colonne4;\nmat4 mat;\nvec3 equation1 = vec3(t2,t2,t1);\nfloat A1 = - e1.x*equation.x - e1.y*equation.y - e1.z*equation.z;\nfloat A2 = - e2.x*equation.x - e2.y*equation.y - e2.z*equation.z;\nfloat A3 = - e3.x*equation.x - e3.y*equation.y - e3.z*equation.z;\nfloat A11 = equation1.x*e1.x*e1.x + equation1.y*e2.x*e2.x + equation1.z*e3.x*e3.x;\nfloat A21 = equation1.x*e1.x*e1.y + equation1.y*e2.x*e2.y + equation1.z*e3.x*e3.y;\nfloat A31 = equation1.x*e1.x*e1.z + equation1.y*e2.x*e2.z + equation1.z*e3.x*e3.z;\nfloat A41 = equation1.x*e1.x*A1 + equation1.y*e2.x*A2 + equation1.z*e3.x*A3;\nfloat A22 = equation1.x*e1.y*e1.y + equation1.y*e2.y*e2.y + equation1.z*e3.y*e3.y;\nfloat A32 = equation1.x*e1.y*e1.z + equation1.y*e2.y*e2.z + equation1.z*e3.y*e3.z;\nfloat A42 = equation1.x*e1.y*A1 + equation1.y*e2.y*A2 + equation1.z*e3.y*A3;\nfloat A33 = equation1.x*e1.z*e1.z + equation1.y*e2.z*e2.z + equation1.z*e3.z*e3.z;\nfloat A43 = equation1.x*e1.z*A1 + equation1.y*e2.z*A2 + equation1.z*e3.z*A3;\nfloat A44 = equation1.x*A1*A1 + equation1.y*A2*A2 + equation1.z*A3*A3 - equation.w;\ncolonne1 = vec4(A11,A21,A31,A41);\ncolonne2 = vec4(A21,A22,A32,A42);\ncolonne3 = vec4(A31,A32,A33,A43);\ncolonne4 = vec4(A41,A42,A43,A44);\nmat = mat4(colonne1,colonne2,colonne3,colonne4);\nRay ray = primary_ray(i_near,i_far) ;\nvec3 M;\nM = isect_surf(ray, mat);\nif (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }\nvec4 M1 = vec4(M,1.0);\nvec4 M2 = mat*M1;\nvec3 _normal = ( modelViewMatrixInverseTranspose * M2 ).xyz;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\n#ifdef NEAR_CLIP\nif( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 ){\nM = isect_surf2(ray, mat);\nif( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 )\ndiscard;\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / radius ) );\n}\n}else if( gl_FragDepthEXT <= 0.0 ){\nM = isect_surf2(ray, mat);\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix);\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );\n}\n}\n#else\nif( gl_FragDepthEXT <= 0.0 ){\nM = isect_surf2(ray, mat);\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );\n}\n}\n#endif\nif (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\nfloat distance_ratio = ((M.x-prime2.x)*e3.x + (M.y-prime2.y)*e3.y +(M.z-prime2.z)*e3.z) /\ndistance(prime2.xyz,prime1.xyz);\n#ifdef PICKING\nif( opacity < 0.3 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vViewPosition = -( modelViewMatrix * vec4( M, 1.0 ) ).xyz;\nvec3 vNormal = _normal;\nvec3 vColor;\nif( distance_ratio>0.5 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\nvec3 normal = normalize( vNormal );\nvec3 geometryNormal = normal;\n#include lights_physical_fragment\n#include lights_fragment_begin\n#include lights_fragment_end\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\nif( interior ){\n#ifdef USE_INTERIOR_COLOR\noutgoingLight.xyz = interiorColor;\n#else\n#ifdef DIFFUSE_INTERIOR\noutgoingLight.xyz = vColor;\n#endif\n#endif\noutgoingLight.xyz *= 1.0 - interiorDarkening;\n}\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");const By=new Float32Array([-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,-1,1,1]),Ny=new Uint16Array([0,1,2,0,2,3,1,5,6,1,6,2,4,6,5,4,7,6,0,7,4,0,3,7,0,5,1,0,4,5,3,2,6,3,6,7]);class Fy extends Zp{constructor(e,t={}){super("v3",e,t)}get mapping(){return By}get mappingIndices(){return Ny}get mappingIndicesSize(){return 36}get mappingSize(){return 8}get mappingItemSize(){return 3}}const zy=Object.assign({shrink:.14},em),Uy=Object.assign({shrink:{uniform:!0}},tm);class $y extends Fy{constructor(e,t={}){super(e,t),this.parameterTypes=Uy,this.isImpostor=!0,this.vertexShader="HyperballStickImpostor.vert",this.fragmentShader="HyperballStickImpostor.frag",this.addUniforms({modelViewProjectionMatrix:{value:new ri},modelViewProjectionMatrixInverse:{value:new ri},modelViewMatrixInverseTranspose:{value:new ri},shrink:{value:this.parameters.shrink}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null},radius2:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return zy}}Object.assign({disableImpostor:!1},ny,zy);const Gy=class{constructor(e,t={}){return!el||t&&t.disableImpostor?(e.radius=function(e,t){const i=e.length,n=new Float32Array(i);for(let r=0;r<i;r++)n[r]=Math.min(e[r],t[r]);return n}(e.radius,e.radius2),new sy(e,t)):new $y(e,t)}};class Vy extends Oy{constructor(e,t,i){super(e,t,i),this.type="hyperball",this.parameters=Object.assign({shrink:{type:"number",precision:3,max:1,min:.001,buffer:!0}},this.parameters,{multipleBond:null,bondSpacing:null})}init(e){var t=e||{};t.radiusScale=Ia(t.radiusScale,.2),t.radiusType=Ia(t.radiusType,"vdw"),t.useInteriorColor=Ia(t.useInteriorColor,!0),this.shrink=Ia(t.shrink,.12),super.init(t)}getBondParams(e,t){return e&&!e.radius||(t=Object.assign({radius2:!0},t)),super.getBondParams(e,t)}createData(e){var t=new tg(e.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));return this.__center=new Float32Array(3*e.bondCount),{bufferList:[t,new Gy(e.getBondData(this.getBondParams()),this.getBufferParams({shrink:this.shrink,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))]}}updateData(e,t){var i=t.sview.getAtomData(this.getAtomParams()),n=t.sview.getBondData(this.getBondParams()),r={},s={};if(!e||e.position){Object.assign(r,{position:i.position});var o=n.position1,a=n.position2;Object.assign(s,{position:Ul(o,a,this.__center),position1:o,position2:a})}e&&!e.color||(Object.assign(r,{color:i.color}),Object.assign(s,{color:n.color,color2:n.color2})),e&&!e.radius||(Object.assign(r,{radius:i.radius}),Object.assign(s,{radius:n.radius,radius2:n.radius2})),t.bufferList[0].setAttributes(r),t.bufferList[1].setAttributes(s)}}ll.add("hyperball",Vy);class Hy{constructor(e,t={},i=""){this.type=e,this.text=t,this.format=i,this.errorLogged=!1}atomLabel(e){let t;switch(this.type){case"atomname":t=e.atomname;break;case"atomindex":t=`${e.index}`;break;case"occupancy":t=e.occupancy.toFixed(2);break;case"bfactor":t=e.bfactor.toFixed(2);break;case"serial":t=`${e.serial}`;break;case"element":t=e.element;break;case"atom":t=`${e.atomname}|${e.index}`;break;case"resname":t=e.resname;break;case"resno":t=`${e.resno}`;break;case"res":t=`${gd[e.resname.toUpperCase()]||e.resname}${e.resno}`;break;case"residue":const i=gd[e.resname.toUpperCase()];t=i&&!e.inscode?`${i}${e.resno}`:`[${e.resname}]${e.resno}${e.inscode}`;break;case"text":t=this.text[e.index];break;case"format":try{t=Cl.sprintf(this.format,e)}catch(e){this.errorLogged||(this.errorLogged=!0,console.log(e.message))}break;default:t=e.qualifiedName()}return void 0===t?"":t}}Hy.types={"":"",atomname:"atom name",atomindex:"atom index",occupancy:"occupancy",bfactor:"b-factor",serial:"serial",element:"element",atom:"atom name + index",resname:"residue name",resno:"residue no",res:"one letter code + no",residue:"[residue name] + no + inscode",text:"text",format:"format",qualified:"qualified name"};class jy extends Bv{constructor(e,t,i){super(e,t,i),this.type="label",this.parameters=Object.assign({labelType:{type:"select",options:Hy.types,rebuild:!0},labelText:{type:"hidden",rebuild:!0},labelFormat:{type:"text",rebuild:!0},labelGrouping:{type:"select",options:{atom:"atom",residue:"residue"},rebuild:!0},fontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:!0},fontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:!0},fontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:!0},xOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},yOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},zOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},attachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},showBorder:{type:"boolean",buffer:!0},borderColor:{type:"color",buffer:!0},borderWidth:{type:"number",precision:2,max:.3,min:0,buffer:!0},showBackground:{type:"boolean",rebuild:!0},backgroundColor:{type:"color",buffer:!0},backgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},backgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:!0},fixedSize:{type:"boolean",buffer:!0}},this.parameters,{side:null,flatShaded:null,wireframe:null,linewidth:null,roughness:null,metalness:null,diffuse:null}),this.init(i)}init(e){const t=e||{};this.labelType=Ia(t.labelType,"res"),this.labelText=Ia(t.labelText,{}),this.labelFormat=Ia(t.labelFormat,""),this.labelGrouping=Ia(t.labelGrouping,"atom"),this.fontFamily=Ia(t.fontFamily,"sans-serif"),this.fontStyle=Ia(t.fontStyle,"normal"),this.fontWeight=Ia(t.fontWeight,"bold"),this.xOffset=Ia(t.xOffset,0),this.yOffset=Ia(t.yOffset,0),this.zOffset=Ia(t.zOffset,.5),this.attachment=Ia(t.attachment,"bottom-left"),this.showBorder=Ia(t.showBorder,!1),this.borderColor=Ia(t.borderColor,"lightgrey"),this.borderWidth=Ia(t.borderWidth,.15),this.showBackground=Ia(t.showBackground,!1),this.backgroundColor=Ia(t.backgroundColor,"lightgrey"),this.backgroundMargin=Ia(t.backgroundMargin,.5),this.backgroundOpacity=Ia(t.backgroundOpacity,1),this.fixedSize=Ia(t.fixedSize,!1),super.init(t)}getTextData(e,t){const i=this.getAtomParams(t),n=new Hy(this.labelType,this.labelText,this.labelFormat);let r,s,o,a,c,l,h;if("atom"===this.labelGrouping){const c=e.getAtomData(i);r=c.position,s=c.radius,o=c.color,t&&!t.text||(a=[],e.eachAtom((e=>a.push(n.atomLabel(e)))))}else if("residue"===this.labelGrouping){t&&!t.position||(c=[]),t&&!t.color||(h=[]),t&&!t.radius||(l=[]),t&&!t.text||(a=[]),i.colorParams&&(i.colorParams.structure=e.getStructure());const u=al.getScheme(i.colorParams),d=new Tm(i.radiusParams),f=e.getAtomProxy();let m=0;e.eachResidue((e=>{const i=3*m;e.isProtein()||e.isNucleic()?(f.index=e.traceAtomIndex,t&&!t.position||f.positionToArray(c,i)):(f.index=e.atomOffset,t&&!t.position||e.positionToArray(c,i)),t&&!t.color||u.atomColorToArray(f,h,i),t&&!t.radius||(l[m]=d.atomRadius(f)),t&&!t.text||a.push(n.atomLabel(f)),++m})),t&&!t.position||(r=new Float32Array(c)),t&&!t.color||(o=new Float32Array(h)),t&&!t.radius||(s=new Float32Array(l))}return{position:r,size:s,color:o,text:a}}createData(e){return{bufferList:[new Xv(this.getTextData(e,{position:!0,color:!0,radius:!0,text:!0}),this.getBufferParams({fontFamily:this.fontFamily,fontStyle:this.fontStyle,fontWeight:this.fontWeight,xOffset:this.xOffset,yOffset:this.yOffset,zOffset:this.zOffset,attachment:this.attachment,showBorder:this.showBorder,borderColor:this.borderColor,borderWidth:this.borderWidth,showBackground:this.showBackground,backgroundColor:this.backgroundColor,backgroundMargin:this.backgroundMargin,backgroundOpacity:this.backgroundOpacity,fixedSize:this.fixedSize}))]}}updateData(e,t){t.bufferList[0].setAttributes(this.getTextData(t.sview,e))}getAtomRadius(){return 0}}function Wy(e){const t=e.getAtomSet(),i=e.getBondSet(),n=e.getBondProxy();return i.forEach((function(e){n.index=e,t.clear(n.atomIndex1),t.clear(n.atomIndex2)})),t}ll.add("label",jy);class qy extends Bv{constructor(e,t,i){super(e,t,i),this.type="line",this.parameters=Object.assign({multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0},lines:{type:"boolean",rebuild:!0},crosses:{type:"select",rebuild:!0,options:{off:"off",lone:"lone",all:"all"}},crossSize:{type:"number",precision:2,max:2,min:.1}},this.parameters,{flatShaded:null,side:null,wireframe:null,roughness:null,metalness:null}),this.init(i)}init(e){var t=e||{};this.multipleBond=Ia(t.multipleBond,"off"),this.bondSpacing=Ia(t.bondSpacing,1),this.linewidth=Ia(t.linewidth,2),this.lines=Ia(t.lines,!0),this.crosses=Ia(t.crosses,"lone"),this.crossSize=Ia(t.crossSize,.4),super.init(t)}getAtomRadius(e){return.1}getBondParams(e,t){return t=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,radiusParams:{type:"size",size:.1,scale:1}},t),super.getBondParams(e,t)}_crossData(e,t){if(e&&!e.position&&!e.color)return;const i={};"lone"===this.crosses&&Object.assign(i,{atomSet:Wy(t)});const n=t.getAtomData(this.getAtomParams(e,i)),r={},s=n.position,o=n.color,a=n.picking,c=(s||o).length,l=3*c;let h=new Float32Array(0),u=new Float32Array(0),d=new Float32Array(0),f=new Float32Array(0),m=0,p=new Float32Array(0);e&&!e.position||(h=r.position1=new Float32Array(l),u=r.position2=new Float32Array(l),m=this.crossSize/2),e&&!e.color||(d=r.color=new Float32Array(l),f=r.color2=new Float32Array(l)),e&&!e.picking||(p=new Float32Array(3*n.picking.array.length));for(let t=0;t<c;t++){const i=3*t,n=3*i;if(!e||e.position){const e=s[i],t=s[i+1],r=s[i+2];h[n]=e-m,h[n+1]=t,h[n+2]=r,u[n]=e+m,u[n+1]=t,u[n+2]=r,h[n+3]=e,h[n+4]=t-m,h[n+5]=r,u[n+3]=e,u[n+4]=t+m,u[n+5]=r,h[n+6]=e,h[n+7]=t,h[n+8]=r-m,u[n+6]=e,u[n+7]=t,u[n+8]=r+m}if(!e||e.color){const e=n+9;for(let t=n;t<e;t+=3)d[t]=f[t]=o[i],d[t+1]=f[t+1]=o[i+1],d[t+2]=f[t+2]=o[i+2]}e&&!e.picking||(p[i]=p[i+1]=p[i+2]=a.array[t])}return e&&!e.picking||(r.picking=new hf(p,a.structure)),r}createData(e){const t={position:!0,color:!0,picking:!0},i=[];if(this.lines){const n=e.getBondData(this.getBondParams(t)),r=new Kv(n,this.getBufferParams({linewidth:this.linewidth}));i.push(r)}if("off"!==this.crosses){const n=new Kv(this._crossData(t,e),this.getBufferParams({linewidth:this.linewidth}));i.push(n)}return{bufferList:i}}updateData(e,t){let i=0;if(this.lines){const n=t.sview.getBondData(this.getBondParams(e)),r={};e&&!e.position||Object.assign(r,{position1:n.position1,position2:n.position2}),e&&!e.color||Object.assign(r,{color:n.color,color2:n.color2}),t.bufferList[i++].setAttributes(r)}if("off"!==this.crosses){const n=this._crossData(e,t.sview),r={};e&&!e.position||Object.assign(r,{position1:n.position1,position2:n.position2}),e&&!e.color||Object.assign(r,{color:n.color,color2:n.color2}),t.bufferList[i++].setAttributes(r)}}setParameters(e){var t={};return e&&(e.bondSpacing||e.crossSize)&&Object.assign(t,{position:!0}),super.setParameters(e,t,!1),this}}function Xy(e,t,i,n,r){const s=new(n=n||Int32Array)(e*t*i*(r=r||1));function o(e,n,s){return((e*t+n)*i+s)*r}return{data:s,index:o,set:function(e,t,i,...n){const a=o(e,t,i);for(let e=0;e<r;++e)s[a+e]=n[e]},toArray:function(e,t,i,n=[],a=0){const c=o(e,t,i);for(let e=0;e<r;++e)n[a+e]=s[c+e]},fromArray:function(e,t,i,n,a=0){const c=o(e,t,i);for(let e=0;e<r;++e)s[c+e]=n[a+e]},copy:function(e){s.set(e.data)}}}function Yy(e,t,i){var n=Wf(t),r=ou(e);0===e.length&&(r[0].set([0,0,0]),r[1].set([0,0,0]));var s,o,a,c,l,h,u,d,f,m,p,g,v,y,x,b=r[0],_=r[1];function w(e,t,i,r,w){s=t||1.4,o=i||2,g=w||!0;var S=0;for(var A in n)S=Math.max(S,A);var M=qf(b,_,S,o,e?s:0);c=M.dim[0],l=M.dim[1],h=M.dim[2],u=M.matrix,d=M.tran,o=M.scaleFactor,f={},m={},P(e),p=s*o,a=r||s/o,v=new Uint8Array(c*l*h),e&&(y=new Float64Array(c*l*h)),g&&(x=new Int32Array(c*l*h))}var S=1,A=2,M=4,C=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])];function P(e){var t,i,r,a,c,l,h,u,d,p;for(var g in n)if(t=parseFloat(g),!f[g]){for(l=(h=e?(t+s)*o+.5:t*o+.5)*h,u=Math.floor(h)+1,d=new Int32Array(u*u),p=0,i=0;i<u;++i)for(r=0;r<u;++r)(a=i*i+r*r)>l?d[p]=-1:(c=Math.sqrt(l-a),d[p]=Math.floor(c)),++p;m[g]=u,f[g]=d}}function T(i){var n,r,s,a,u,p,y,b,_,w,A,M,C,P,T,I,E,D,L=3*i,R=i;n=Math.floor(.5+o*(e[L]+d[0])),r=Math.floor(.5+o*(e[L+1]+d[1])),s=Math.floor(.5+o*(e[L+2]+d[2]));var k,O=t[R],B=f[O],N=0,F=l*h,z=m[O];for(w=0;w<z;++w)for(A=0;A<z;++A){if(-1!==(k=B[N]))for(I=-1;I<2;++I)for(E=-1;E<2;++E)for(D=-1;D<2;++D)if(0!==I&&0!==E&&0!==D)for(y=I*w,_=D*A,M=0;M<=k;++M)if(P=r+(b=M*E),T=s+_,!((C=n+y)<0||P<0||T<0||C>=c||P>=l||T>=h)){var U=C*F+P*h+T;if(g)if(v[U]&S){if(v[U]&S){var $=x[U];$!==L&&y*y+b*b+_*_<(a=n+y-Math.floor(.5+o*(e[$]+d[0])))*a+(u=r+b-Math.floor(.5+o*(e[$+1]+d[1])))*u+(p=s+_-Math.floor(.5+o*(e[$+2]+d[2])))*p&&(x[U]=i)}}else v[U]|=S,x[U]=i;else v[U]|=S}N++}}function I(t){var i,n;for(console.time("EDTSurface fillvoxels"),i=0,n=v.length;i<n;++i)v[i]=0,t&&(y[i]=-1),g&&(x[i]=-1);for(i=0,n=e.length/3;i<n;++i)T(i);for(i=0,n=v.length;i<n;++i)v[i]&S&&(v[i]|=A);console.timeEnd("EDTSurface fillvoxels")}function E(i){var n,r,s,a,u,p,y,b,_,w,S,M,C,P,T,I,E,D,L,R=3*i,k=i,O=0;n=Math.floor(.5+o*(e[R]+d[0])),r=Math.floor(.5+o*(e[R+1]+d[1])),s=Math.floor(.5+o*(e[R+2]+d[2]));var B=t[k],N=l*h;for(C=0,L=m[B];C<L;++C)for(P=0;P<L;++P){if(-1!==f[B][O])for(I=-1;I<2;++I)for(E=-1;E<2;++E)for(D=-1;D<2;++D)if(0!==I&&0!==E&&0!==D)for(y=I*C,_=D*P,T=0;T<=f[B][O];++T)if(S=r+(b=T*E),M=s+_,!((w=n+y)<0||S<0||M<0||w>=c||S>=l||M>=h)){var F=w*N+S*h+M;if(v[F]&A){if(g){var z=x[F];y*y+b*b+_*_<(a=Math.floor(.5+o*(e[z]+d[0])))*a+(u=Math.floor(.5+o*(e[z+1]+d[1])))*u+(p=Math.floor(.5+o*(e[z+2]+d[2])))*p&&(x[F]=i)}}else v[F]|=A,g&&(x[F]=i)}O++}}function D(){var e,t,i,n;console.time("EDTSurface fastdistancemap");var r,s=Xy(c,l,h,Uint16Array,3),o=l*h,u=p*p,d=0;for(e=0;e<c;++e)for(t=0;t<l;++t)for(i=0;i<h;++i)v[r=e*o+t*h+i]&=~A,v[r]&S&&v[r]&M&&(s.set(e,t,i,e,t,i),y[r]=0,v[r]|=A,d+=1);var f=new Int32Array(3*d),m=0,b=new Int32Array(3*d),_=0;for(e=0;e<c;++e)for(t=0;t<l;++t)for(i=0;i<h;++i)v[r=e*o+t*h+i]&M&&(f[m]=e,f[m+1]=t,f[m+2]=i,m+=3,v[r]&=~M);do{for(_=L(f,s,m,b),m=0,e=0,n=_;e<n;e+=3)r=o*b[e]+h*b[e+1]+b[e+2],v[r]&=~M,y[r]<=1.0404*u&&(f[m]=b[e],f[m+1]=b[e+1],f[m+2]=b[e+2],m+=3)}while(m>0);var w,C=a*a,P=new Uint16Array(3);for(e=0;e<c;++e)for(t=0;t<l;++t)for(i=0;i<h;++i)v[r=e*o+t*h+i]&=~M,v[r]&S&&(v[r]&A&&!(v[r]&A&&y[r]>=C)||(v[r]|=M,g&&v[r]&A&&(s.toArray(e,t,i,P),w=P[0]*o+P[1]*h+P[2],x[r]=x[w])));console.timeEnd("EDTSurface fastdistancemap")}function L(e,t,i,n){var r,s,o,a,u,d,f,m,p,g,x,b,_=new Uint16Array(3),w=0;if(0===i)return w;var P=-1,T=-1,I=-1,E=l*h;for(f=0,p=i;f<p;f+=3)for(r=e[f],s=e[f+1],o=e[f+2],t.toArray(r,s,o,_),m=0;m<6;++m)P=r+(b=C[m])[0],T=s+b[1],I=o+b[2],P<c&&P>-1&&T<l&&T>-1&&I<h&&I>-1&&(v[x=P*E+h*T+I]&S&&!(v[x]&A)?(t.fromArray(P,T,I,_),g=(a=P-_[0])*a+(u=T-_[1])*u+(d=I-_[2])*d,y[x]=g,v[x]|=A,v[x]|=M,n[w]=P,n[w+1]=T,n[w+2]=I,w+=3):v[x]&S&&v[x]&A&&(g=(a=P-_[0])*a+(u=T-_[1])*u+(d=I-_[2])*d)<y[x]&&(t.fromArray(P,T,I,_),y[x]=g,v[x]&M||(v[x]|=M,n[w]=P,n[w+1]=T,n[w+2]=I,w+=3)));for(f=0,p=i;f<p;f+=3)for(r=e[f],s=e[f+1],o=e[f+2],t.toArray(r,s,o,_),m=6;m<18;m++)P=r+(b=C[m])[0],T=s+b[1],I=o+b[2],P<c&&P>-1&&T<l&&T>-1&&I<h&&I>-1&&(v[x=P*E+h*T+I]&S&&!(v[x]&A)?(t.fromArray(P,T,I,_),g=(a=P-_[0])*a+(u=T-_[1])*u+(d=I-_[2])*d,y[x]=g,v[x]|=A,v[x]|=M,n[w]=P,n[w+1]=T,n[w+2]=I,w+=3):v[x]&S&&v[x]&A&&(g=(a=P-_[0])*a+(u=T-_[1])*u+(d=I-_[2])*d)<y[x]&&(t.fromArray(P,T,I,_),y[x]=g,v[x]&M||(v[x]|=M,n[w]=P,n[w+1]=T,n[w+2]=I,w+=3)));for(f=0,p=i;f<p;f+=3)for(r=e[f],s=e[f+1],o=e[f+2],t.toArray(r,s,o,_),m=18;m<26;m++)P=r+(b=C[m])[0],T=s+b[1],I=o+b[2],P<c&&P>-1&&T<l&&T>-1&&I<h&&I>-1&&(v[x=P*E+h*T+I]&S&&!(v[x]&A)?(t.fromArray(P,T,I,_),g=(a=P-_[0])*a+(u=T-_[1])*u+(d=I-_[2])*d,y[x]=g,v[x]|=A,v[x]|=M,n[w]=P,n[w+1]=T,n[w+2]=I,w+=3):v[x]&S&&v[x]&A&&(g=(a=P-_[0])*a+(u=T-_[1])*u+(d=I-_[2])*d)<y[x]&&(t.fromArray(P,T,I,_),y[x]=g,v[x]&M||(v[x]|=M,n[w]=P,n[w+1]=T,n[w+2]=I,w+=3)));return w}this.getVolume=function(t,n,r,s,o){console.time("EDTSurface.getVolume");var a="vws"!==t;w(a,n,r,s,o),I(a),function(){var e,t,i,n=l*h;for(e=0;e<c;++e)for(t=0;t<h;++t)for(i=0;i<l;++i){var r=e*n+i*h+t;if(v[r]&S)for(var s=0;s<26;){var o=e+C[s][0],a=t+C[s][2],u=i+C[s][1];if(o>-1&&o<c&&u>-1&&u<l&&a>-1&&a<h&&!(v[o*n+u*h+a]&S)){v[r]|=M;break}s++}}}(),"ms"!==t&&"ses"!==t||D(),"ses"===t&&(P(!1),function(){var t,i;for(t=0,i=v.length;t<i;++t)v[t]&=~A;for(t=0,i=e.length/3;t<i;++t)E(t)}()),function(e){var t,i=v.length;if("vws"===e)for(t=0;t<i;++t)v[t]&=~M,v[t]=v[t]&A?1:0;else if("ms"===e)for(t=0;t<i;++t)v[t]&=~A,v[t]&M&&(v[t]|=A),v[t]&=~M,v[t]=v[t]&A?1:0;else if("ses"===e)for(t=0;t<i;++t)v[t]&M&&v[t]&A?v[t]&=~M:v[t]&M&&!(v[t]&A)&&(v[t]|=A),v[t]=v[t]&A?1:0;else if("sas"===e)for(t=0;t<i;++t)v[t]&=~M,v[t]=v[t]&A?1:0}(t);for(var u=0,d=x.length;u<d;++u)x[u]=i[x[u]];return console.timeEnd("EDTSurface.getVolume"),{data:v,nx:h,ny:l,nz:c,atomindex:x}},this.getSurface=function(e,t,i,n,r,s,o){var a=this.getVolume(e,t,i,n,r);return new Yf(a.data,a.nx,a.ny,a.nz,a.atomindex).getSurface(1,s,void 0,u,o)}}function Zy(e,t,i,n,r,s,o){o=Math.max(.1,o);var a=e.length,c=r[0],l=r[1],h=r[2],u=s[0],d=s[1],f=s[2];function m(e,t){return Math.floor((e-t)/o)}for(var p,g,v,y=m(u,c)+1,x=m(d,l)+1,b=m(f,h)+1,_=y*x*b,w=x*b,S=[],A=0;A<a;A++){var M=(p=e[A],g=t[A],v=i[A],(m(p,c)*x+m(g,l))*b+m(v,h));void 0===S[M]?S[M]=[A]:S[M].push(A)}var C=new Uint32Array(_),P=new Uint16Array(_),T=new Uint32Array(a),I=0,E=0;for(A=0;A<_;A++){var D=C[A]=I,L=S[A];if(void 0!==L)for(var R=0;R<L.length;R++)T[I]=L[R],I++;var k=I-D;P[A]=k,k>E&&(E=k)}return{neighbourListLength:27*E+1,withinRadii:function(r,s,o,a,u){for(var d=0,f=m(r,c),p=m(s,l),g=m(o,h),v=Math.max(0,f-1),_=Math.max(0,p-1),S=Math.max(0,g-1),A=Math.min(y,f+2),M=Math.min(x,p+2),I=Math.min(b,g+2),E=v;E<A;++E)for(var D=E*w,L=_;L<M;++L)for(var R=L*b,k=S;k<I;++k)for(var O=D+R+k,B=C[O],N=B+P[O],F=B;F<N;F++){var z=T[F],U=e[z]-r,$=t[z]-s,G=i[z]-o,V=n[z]+a;U*U+$*$+G*G<=V*V&&(u[d++]=T[F])}u[d]=-1}}}function Ky(e,t,i){const n=t.length,r=new Float32Array(n),s=new Float32Array(n),o=new Float32Array(n);for(let t=0;t<n;t++){const i=3*t;r[t]=e[i],s[t]=e[i+1],o[t]=e[i+2]}let a=ou(e);0===e.length&&(a[0].set([0,0,0]),a[1].set([0,0,0]));const c=a[0],l=a[1];let h,u,d,f,m,p,g,v,y,x,b,_,w,S,A,M,C,P,T=-1;const I=new Float32Array([0,0,0]),E=new Float32Array([0,0,0]),D=new Float32Array([0,0,0]),L=new Float32Array([0,0,0]);let R;function k(e,i,a,I){f=Ia(e,1.4),m=Ia(i,2),p=Ia(a,!0),g=Ia(I,30),h=new Float32Array(n),u=new Float32Array(n);for(let e=0;e<h.length;++e){var E=t[e]+f;h[e]=E,u[e]=E*E}d=0;for(let e=0;e<h.length;++e)h[e]>d&&(d=h[e]);!function(){const e=qf(c,l,d,m,0);m=e.scaleFactor,v=e.dim,y=e.matrix,R=Math.max(5,2+Math.floor(f*m)),x=Gl(v[0]*v[1]*v[2],-1001),b=new Int32Array(x.length),_=new Float32Array(v[0]),w=new Float32Array(v[1]),S=new Float32Array(v[2]),O(_,c[0],1/m),O(w,c[1],1/m),O(S,c[2],1/m)}(),function(){var e=0,t=2*Math.PI/g;M=new Float32Array(g),A=new Float32Array(g);for(var i=0;i<g;i++)M[i]=Math.cos(e),A[i]=Math.sin(e),e+=t}(),C=Zy(r,s,o,h,c,l,2.01*d),P=new Int32Array(C.neighbourListLength),T=-1}function O(e,t,i){for(let n=0;n<e.length;n++)e[n]=t+i*n}function B(e,t,i,n,r){let s;if(-1!==T){if(s=T,s!==n&&s!==r&&N(s,e,t,i))return s;T=-1}var o=0;for(s=P[o];s>=0;){if(s!==n&&s!==r&&N(s,e,t,i))return T=s,s;s=P[++o]}return T=-1,-1}function N(t,i,n,r){var s=3*t,o=u[t],a=e[s]-i,c=e[s+1]-n,l=e[s+2]-r;return a*a+c*c+l*l<o}function F(){for(var e=0;e<n;e++){var t=r[e],i=s[e],a=o[e],l=h[e],d=u[e];C.withinRadii(t,i,a,l,P);for(var f=Math.ceil(l*m),g=Math.floor(m*(t-c[0])),y=Math.floor(m*(i-c[1])),A=Math.floor(m*(a-c[2])),M=Math.max(0,g-f),T=Math.max(0,y-f),I=Math.max(0,A-f),E=Math.min(v[0],g+f+2),D=Math.min(v[1],y+f+2),L=Math.min(v[2],A+f+2),R=M;R<E;R++)for(var k=_[R]-t,O=v[1]*v[2]*R,N=T;N<D;N++)for(var F=w[N]-i,z=k*k+F*F,U=O+v[2]*N,$=I;$<L;$++){var G=S[$]-a,V=z+G*G;if(V<d){var H=$+U;x[H]<0&&(x[H]=-x[H]);var j=Math.sqrt(V),W=l/j,q=k*W,X=F*W,Y=G*W;if(-1===B(q+=t,X+=i,Y+=a,e,-1)){var Z=l-j;Z<x[H]&&(x[H]=Z,p&&(b[H]=e))}}}}}function z(e,t){var i=h[e],n=h[t],a=I[0]=r[t]-r[e],l=I[1]=s[t]-s[e],u=I[2]=o[t]-o[e],d=a*a+l*l+u*u,f=Math.sqrt(d),y=i*((i*i+f*f-n*n)/(2*i*f));_u(I,I),function(e,t){e[0]=e[1]=e[2]=1,0!==t[0]?e[0]=(t[1]+t[2])/-t[0]:0!==t[1]?e[1]=(t[0]+t[2])/-t[1]:0!==t[2]&&(e[2]=(t[0]+t[1])/-t[2])}(D,I),_u(D,D),uu(L,I,D),_u(L,L);var C=Math.sqrt(i*i-y*y);bu(D,D,C),bu(L,L,C),bu(I,I,y),E[0]=I[0]+r[e],E[1]=I[1]+s[e],E[2]=I[2]+o[e],T=-1;for(var P=R,k=0;k<g;k++){var O=M[k],N=A[k],F=E[0]+O*D[0]+N*L[0],z=E[1]+O*D[1]+N*L[1],U=E[2]+O*D[2]+N*L[2];if(-1===B(F,z,U,e,t))for(var $=Math.floor(m*(F-c[0])),G=Math.floor(m*(z-c[1])),V=Math.floor(m*(U-c[2])),H=Math.max(0,$-P),j=Math.max(0,G-P),W=Math.max(0,V-P),q=Math.min(v[0],$+P+2),X=Math.min(v[1],G+P+2),Y=Math.min(v[2],V+P+2),Z=H;Z<q;Z++){a=F-_[Z];for(var K=v[1]*v[2]*Z,Q=j;Q<X;Q++)for(var J=a*a+(l=z-w[Q])*l,ee=K+v[2]*Q,te=W;te<Y;te++){d=J+(u=U-S[te])*u;var ie=te+ee,ne=x[ie];if(ne>0&&d<ne*ne&&(x[ie]=Math.sqrt(d),p)){const i=a*I[0]+l*I[1]+u*I[2];b[ie]=i<0?t:e}}}}}function U(e,t,a){console.time("AVSurface.getVolume"),console.time("AVSurface.init"),k(e,t,a),console.timeEnd("AVSurface.init"),console.time("AVSurface.projectPoints"),F(),console.timeEnd("AVSurface.projectPoints"),console.time("AVSurface.projectTorii"),function(){for(var e=0;e<n;e++){C.withinRadii(r[e],s[e],o[e],h[e],P);for(var t=0,i=P[t];i>=0;)e<i&&z(e,i),i=P[++t]}}(),console.timeEnd("AVSurface.projectTorii"),function(){for(var e=0;e<x.length;e++)x[e]<0&&(x[e]=0)}(),function(){for(var e=0;e<b.length;e++)b[e]=i[b[e]]}(),console.timeEnd("AVSurface.getVolume")}this.getSurface=function(e,t,i,n,r,s,o){return U(t,i,r),new Yf(x,v[2],v[1],v[0],b).getSurface(t,!1,void 0,y,o)}}ll.add("line",qy),Object.assign(Yy,{__deps:[qf,Wf,Yf,ou,Xy]}),Object.assign(Ky,{__deps:[qf,Yf,Gl,ou,bu,uu,_u,Zy,Ia]}),ol.add("molsurf",(function(e,t){const i=e.data.args,n=e.data.params;if(i&&n){const e=new("av"===n.type?Ky:Yy)(i.coordList,i.radiusList,i.indexList).getSurface(n.type,n.probeRadius,n.scaleFactor,n.cutoff,!0,n.smooth,n.contour),r=[e.position.buffer,e.index.buffer];e.normal&&r.push(e.normal.buffer),e.atomindex&&r.push(e.atomindex.buffer);t({sd:e,p:n},r)}}),[Yy,Ky]);class Qy{constructor(e){this.structure=e}_getAtomData(e){return this.structure.getAtomData({what:{position:!0,radius:!0,index:!0},radiusParams:Ia(e.radiusParams,{type:"vdw",scale:1})})}_makeSurface(e,t){var i=new Xf(t.name,"",e);return i.info.type=t.type,i.info.probeRadius=t.probeRadius,i.info.scaleFactor=t.scaleFactor,i.info.smooth=t.smooth,i.info.cutoff=t.cutoff,i}getSurface(e){const t=e||{},i=this._getAtomData(e),n=i.position,r=i.radius,s=i.index,o=new("av"===t.type?Ky:Yy)(n,r,s).getSurface(t.type,t.probeRadius,t.scaleFactor,t.cutoff,!0,t.smooth,t.contour);return this._makeSurface(o,t)}getSurfaceWorker(e,t){const i=Object.assign({},e);if(window.hasOwnProperty("Worker")){void 0===this.worker&&(this.worker=new iu("molsurf"));const n=this._getAtomData(e),r=n.position,s=n.radius,o=n.index,a={args:{coordList:r,radiusList:s,indexList:o},params:i},c=[r.buffer,s.buffer,o.buffer];this.worker.post(a,c,(e=>{t(this._makeSurface(e.data.sd,i))}),(e=>{console.warn("MolecularSurface.getSurfaceWorker error - trying without worker",e),this.worker.terminate(),this.worker=void 0;const n=this.getSurface(i);t(n)}))}else{const e=this.getSurface(i);t(e)}}dispose(){this.worker&&this.worker.terminate()}}class Jy extends Bv{constructor(e,t,i){super(e,t,i),this.type="surface",this.parameters=Object.assign({surfaceType:{type:"select",rebuild:!0,options:{vws:"vws",sas:"sas",ms:"ms",ses:"ses",av:"av"}},probeRadius:{type:"number",precision:1,max:20,min:0,rebuild:!0},smooth:{type:"integer",precision:1,max:10,min:0,rebuild:!0},scaleFactor:{type:"number",precision:1,max:5,min:0,rebuild:!0},cutoff:{type:"number",precision:2,max:50,min:0,rebuild:!0},contour:{type:"boolean",rebuild:!0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},filterSele:{type:"text",rebuild:!0},colorVolume:{type:"hidden"},useWorker:{type:"boolean",rebuild:!0}},this.parameters,{radius:null,scale:null}),this.__infoList=[],this.structure.signals.refreshed.add((()=>{this.__forceNewMolsurf=!0})),this.toBePrepared=!0,this.init(i)}init(e){const t=e||{};t.colorScheme=Ia(t.colorScheme,"uniform"),t.colorValue=Ia(t.colorValue,14540253),t.disablePicking=Ia(t.disablePicking,!0),this.surfaceType=Ia(t.surfaceType,"ms"),this.probeRadius=Ia(t.probeRadius,1.4),this.smooth=Ia(t.smooth,2),this.scaleFactor=Ia(t.scaleFactor,2),this.cutoff=Ia(t.cutoff,0),this.contour=Ia(t.contour,!1),this.background=Ia(t.background,!1),this.opaqueBack=Ia(t.opaqueBack,!0),this.filterSele=Ia(t.filterSele,""),this.colorVolume=Ia(t.colorVolume,void 0),this.useWorker=Ia(t.useWorker,!0),super.init(e)}prepareData(e,t,i){let n=this.__infoList[t];if(n||(n={},this.__infoList[t]=n),n.molsurf&&n.sele===e.selection.string)i(t);else{if(this.filterSele){const n=e.structure.getView(new $c(this.filterSele)),r=n.boundingBox.getSize(new Zt),s=Math.max(r.x,r.y,r.z),o=e.getAtomSetWithinPoint(n.center,s/2+6);if(0===(e=e.getView(new $c(e.getAtomSetWithinSelection(o,3).toSeleString()))).atomCount)return void i(t)}n.sele=e.selection.string,n.molsurf=new Qy(e);const r=this.getSurfaceParams(),s=e=>{n.surface=e,i(t)};this.useWorker?n.molsurf.getSurfaceWorker(r,s):s(n.molsurf.getSurface(r))}}prepare(e){if((this.__forceNewMolsurf||this.__sele!==this.selection.string||this.__surfaceParams!==JSON.stringify(this.getSurfaceParams()))&&(this.__infoList.forEach((e=>{e&&e.molsurf&&e.molsurf.dispose()})),this.__infoList.length=0),0===this.structureView.atomCount)return void e();const t=()=>{this.__sele=this.selection.string,this.__surfaceParams=JSON.stringify(this.getSurfaceParams()),this.__forceNewMolsurf=!1,e()},i="default"===this.assembly?this.defaultAssembly:this.assembly,n=this.structure.biomolDict[i];n?n.partList.forEach(((e,i)=>{const r=e.getView(this.structureView);this.prepareData(r,i,(e=>{e===n.partList.length-1&&t()}))})):this.prepareData(this.structureView,0,t)}createData(e,t){const i=this.__infoList[t],n=i.surface;if(!n)return;const r={position:n.getPosition(),color:n.getColor(this.getColorParams()),index:n.getFilteredIndex(this.filterSele,e)},s=[];if(n.contour){const e=new cm(r,this.getBufferParams({wireframe:!1}));s.push(e)}else{Object.assign(r,{normal:n.getNormal(),picking:n.getPicking(e.getStructure())});const t=new rm(r,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1}));if("double"==this.getBufferParams().side){const e=new am(t);s.push(e)}else s.push(t)}return{bufferList:s,info:i}}updateData(e,t){const i={};if(e.position||e.radius)return this.__forceNewMolsurf=!0,void this.build();e.color&&(i.color=t.info.surface.getColor(this.getColorParams())),e.index&&(i.index=t.info.surface.getFilteredIndex(this.filterSele,t.sview)),t.bufferList[0].setAttributes(i)}setParameters(e,t={},i){return e&&e.filterSele&&(t.index=!0),e&&void 0!==e.colorVolume&&(t.color=!0),e&&e.wireframe&&(e.contour||void 0===e.contour&&this.contour)&&(e.wireframe=!1),super.setParameters(e,t,i),this}getSurfaceParams(e={}){return Object.assign({type:this.surfaceType,probeRadius:this.probeRadius,scaleFactor:this.scaleFactor,smooth:this.smooth&&!this.contour,cutoff:this.cutoff,contour:this.contour,useWorker:this.useWorker,radiusParams:this.getRadiusParams()},e)}getColorParams(){const e=super.getColorParams();return e.volume=this.colorVolume,e}getAtomRadius(){return 0}clear(){super.clear()}dispose(){this.__infoList.forEach((e=>{e&&e.molsurf&&e.molsurf.dispose()})),this.__infoList.length=0,super.dispose()}}ll.add("surface",Jy);class ex extends Bv{constructor(e,t,i){super(e,t,i),this.type="point",this.parameters=Object.assign({pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{flatShaded:null,wireframe:null,linewidth:null,side:null,roughness:null,metalness:null}),this.init(i)}init(e){var t=e||{};this.pointSize=Ia(t.pointSize,1),this.sizeAttenuation=Ia(t.sizeAttenuation,!0),this.sortParticles=Ia(t.sortParticles,!1),this.useTexture=Ia(t.useTexture,!1),this.alphaTest=Ia(t.alphaTest,.5),this.forceTransparent=Ia(t.forceTransparent,!1),this.edgeBleach=Ia(t.edgeBleach,0),super.init(t)}createData(e){var t=e.getAtomData(this.getAtomParams({position:!0,color:!0,picking:!0}));return{bufferList:[new sg(t,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach}))]}}updateData(e,t){var i=t.sview.getAtomData(this.getAtomParams(e)),n={};e&&!e.position||Object.assign(n,{position:i.position}),e&&!e.color||Object.assign(n,{color:i.color}),t.bufferList[0].setAttributes(n)}getAtomRadius(){return.1}}ll.add("point",ex),ul.add("shader/Ribbon.vert","#define STANDARD\nuniform float clipNear;\nuniform vec3 clipCenter;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nattribute vec3 dir;\nattribute float size;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#endif\n#include common\nvoid main(void){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#include beginnormal_vertex\n#include defaultnormal_vertex\n#ifndef FLAT_SHADED\nvNormal = normalize( transformedNormal );\n#endif\n#endif\n#include begin_vertex\ntransformed += normalize( dir ) * size;\n#include project_vertex\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}");const tx=new Uint16Array([0,1,2,1,3,2]);function ix(e){return 3*(4*(e.position.length/3-1))}class nx extends nm{constructor(e,t={}){super({position:new Float32Array(ix(e)),color:new Float32Array(ix(e)),index:Ga(ix(e),ix(e)/3),normal:new Float32Array(ix(e)),picking:e.picking},t),this.vertexShader="Ribbon.vert";const i=e.position.length/3-1,n=4*i,r=3*n;this.addAttributes({dir:{type:"v3",value:new Float32Array(r)}}),this.addAttributes({size:{type:"f",value:new Float32Array(n)}}),e.primitiveId=Hl(i),this.setAttributes(e),this.makeIndex()}setAttributes(e={}){const t=this.size/4,i=this.geometry.attributes;let n,r,s,o,a,c,l,h,u,d,f,m,p,g,v,y,x,b,_;e.position&&(n=e.position,l=i.position.array,i.position.needsUpdate=!0),e.normal&&(r=e.normal,h=i.normal.array,i.normal.needsUpdate=!0),e.size&&(s=e.size,u=i.size.array,i.size.needsUpdate=!0),e.dir&&(o=e.dir,d=i.dir.array,i.dir.needsUpdate=!0),e.color&&(a=e.color,f=i.color.array,i.color.needsUpdate=!0),e.primitiveId&&(c=e.primitiveId,m=i.primitiveId.array,i.primitiveId.needsUpdate=!0);let w=s?s[0]:null;for(p=0;p<t;++p){for(b=3*p,v=3*p*4,x=4*p,n&&(l[v]=l[v+3]=n[b],l[v+1]=l[v+4]=n[b+1],l[v+2]=l[v+5]=n[b+2],l[v+6]=l[v+9]=n[b+3],l[v+7]=l[v+10]=n[b+4],l[v+8]=l[v+11]=n[b+5]),r&&(h[v]=h[v+3]=-r[b],h[v+1]=h[v+4]=-r[b+1],h[v+2]=h[v+5]=-r[b+2],h[v+6]=h[v+9]=-r[b+3],h[v+7]=h[v+10]=-r[b+4],h[v+8]=h[v+11]=-r[b+5]),g=0;g<4;++g)y=v+3*g,a&&(f[y]=a[b],f[y+1]=a[b+1],f[y+2]=a[b+2]),c&&(m[x+g]=c[p]);s&&(_=s[p],w!==s[p]?(u[x]=w,u[x+1]=w,u[x+2]=_,u[x+3]=_):(u[x]=_,u[x+1]=_,u[x+2]=_,u[x+3]=_),w=_),o&&(d[v]=o[b],d[v+1]=o[b+1],d[v+2]=o[b+2],d[v+3]=-o[b],d[v+4]=-o[b+1],d[v+5]=-o[b+2],d[v+6]=o[b+3],d[v+7]=o[b+4],d[v+8]=o[b+5],d[v+9]=-o[b+3],d[v+10]=-o[b+4],d[v+11]=-o[b+5])}}makeIndex(){const e=this.geometry.getIndex();if(!e)return void il.error("Index is null");const t=e.array,i=t.length/4/3;for(let e=0;e<i;++e){const i=6*e,n=4*e;t.set(tx,i);for(let e=0;e<6;++e)t[i+e]+=n}}}class rx extends Bv{constructor(e,t,i){super(e,t,i),this.type="ribbon",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{side:null,wireframe:null,linewidth:null}),this.init(i)}init(e){var t=e||{};t.colorScheme=Ia(t.colorScheme,"chainname"),t.colorScale=Ia(t.colorScale,"RdYlBu"),t.radiusType=Ia(t.radiusType,"sstruc"),t.radiusScale=Ia(t.radiusScale,4),"low"===t.quality?this.subdiv=3:"medium"===t.quality?this.subdiv=6:"high"===t.quality?this.subdiv=12:this.subdiv=Ia(t.subdiv,6),this.tension=Ia(t.tension,NaN),this.smoothSheet=Ia(t.smoothSheet,!1),super.init(t)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!0,smoothSheet:this.smoothSheet},e)}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}createData(e){var t=[],i=[];return this.structure.eachPolymer((e=>{if(!(e.residueCount<4)){i.push(e);var n=new yy(e,this.getSplineParams()),r=n.getSubdividedPosition(),s=n.getSubdividedOrientation(),o=n.getSubdividedColor(this.getColorParams()),a=n.getSubdividedPicking(),c=n.getSubdividedSize(this.getRadiusParams());t.push(new nx({position:r.position,normal:s.binormal,dir:s.normal,color:o.color,size:c.size,picking:a.picking},this.getBufferParams()))}}),e.getSelection()),{bufferList:t,polymerList:i}}updateData(e,t){e=e||{};var i=0,n=t.polymerList.length;for(i=0;i<n;++i){var r={},s=new yy(t.polymerList[i],this.getSplineParams());if(e.position){var o=s.getSubdividedPosition(),a=s.getSubdividedOrientation();Object.assign(r,{position:o.position,normal:a.binormal,dir:a.normal})}if(e.radius||e.scale){var c=s.getSubdividedSize(this.getRadiusParams());Object.assign(r,{size:c.size})}if(e.color){var l=s.getSubdividedColor(this.getColorParams());Object.assign(r,{color:l.color})}t.bufferList[i].setAttributes(r)}}setParameters(e){var t={};return e&&e.tension&&Object.assign(t,{position:!0}),super.setParameters(e,t,!1),this}}ll.add("ribbon",rx);class sx extends Bv{constructor(e,t,i){super(e,t,i),this.type="rocket",this.parameters=Object.assign({localAngle:{type:"integer",max:180,min:0,rebuild:!0},centerDist:{type:"number",precision:1,max:10,min:0,rebuild:!0},ssBorder:{type:"boolean",rebuild:!0},radialSegments:!0,openEnded:!0,disableImpostor:!0},this.parameters),this.init(i)}init(e){let t=e||{};t.colorScheme=Ia(t.colorScheme,"sstruc"),t.radiusSize=Ia(t.radiusSize,1.5),t.radiusScale=Ia(t.radiusScale,1),t.openEnded=Ia(t.openEnded,!1),t.useInteriorColor=Ia(t.useInteriorColor,!0),this.localAngle=Ia(t.localAngle,30),this.centerDist=Ia(t.centerDist,2.5),this.ssBorder=Ia(t.ssBorder,!1),super.init(t)}createData(e){let t=0;const i=[],n=[];this.structure.eachPolymer((e=>{if(e.residueCount<4||e.isNucleic())return;const r=new Um(e),s=r.getAxis(this.localAngle,this.centerDist,this.ssBorder,this.getColorParams(),this.getRadiusParams());t+=s.size.length,i.push(s),n.push(r)}),e.getSelection());const r={begin:new Float32Array(3*t),end:new Float32Array(3*t),size:new Float32Array(t),color:new Float32Array(3*t),picking:{}};let s=new Float32Array(t),o=0;i.forEach((function(e){r.begin.set(e.begin,3*o),r.end.set(e.end,3*o),r.size.set(e.size,o),r.color.set(e.color,3*o),s.set(e.picking.array,o),o+=e.size.length})),t&&(r.picking=new hf(s,e.getStructure()));return{bufferList:[new dy({position1:r.begin,position2:r.end,color:r.color,color2:r.color,radius:r.size,picking:r.picking},this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))],axisList:i,helixbundleList:n,axisData:r}}updateData(e,t){if((e=e||{}).position)this.build();else{var i={};if(e.color||e.radius){var n=0;t.helixbundleList.forEach((i=>{var r=i.getAxis(this.localAngle,this.centerDist,this.ssBorder,this.getColorParams(),this.getRadiusParams());e.color&&t.axisData.color.set(r.color,3*n),(e.radius||e.scale)&&t.axisData.size.set(r.size,n),n+=r.size.length})),e.color&&Object.assign(i,{color:t.axisData.color,color2:t.axisData.color}),(e.radius||e.scale)&&Object.assign(i,{radius:t.axisData.size})}t.bufferList[0].setAttributes(i)}}}ll.add("rocket",sx);class ox extends Sy{constructor(e,t,i){super(e,t,i),this.type="rope",this.parameters=Object.assign({smooth:{type:"integer",max:15,min:0,rebuild:!0}},this.parameters,{aspectRatio:null,smoothSheet:null})}init(e){var t=e||{};t.aspectRatio=1,t.tension=Ia(t.tension,.5),t.radiusScale=Ia(t.radiusScale,5),t.smoothSheet=!1,this.smooth=Ia(t.smooth,2),super.init(t)}getSpline(e){var t=new zm(e);return new yy(e,this.getSplineParams({directional:!1,positionIterator:t.getCenterIterator(this.smooth)}))}}ll.add("rope",ox);class ax extends Bv{constructor(e,t,i){super(e,t,i),this.type="spacefill",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(i)}init(e){var t=e||{};t.useInteriorColor=Ia(t.useInteriorColor,!0),super.init(t)}createData(e){return{bufferList:[new tg(e.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,dullInterior:!0,disableImpostor:this.disableImpostor}))]}}updateData(e,t){var i=t.sview.getAtomData(this.getAtomParams(e)),n={};e&&!e.position||Object.assign(n,{position:i.position}),e&&!e.color||Object.assign(n,{color:i.color}),e&&!e.radius||Object.assign(n,{radius:i.radius}),t.bufferList[0].setAttributes(n)}}function cx(e){return 3*(e.position.length/3-1)*2}ll.add("spacefill",ax);class lx extends im{constructor(e,t={}){super({position:new Float32Array(cx(e)),color:new Float32Array(cx(e))},t),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag",this.setAttributes(e)}setAttributes(e){let t,i,n,r;const s=this.geometry.attributes;if(e.position&&(t=e.position,n=s.position.array,s.position.needsUpdate=!0),e.color&&(i=e.color,r=s.color.array,s.color.needsUpdate=!0),!t&&!i)return void il.warn("TraceBuffer.prototype.setAttributes no data");let o,a;const c=this.size-1;for(let e=0;e<c;++e)o=3*e,a=3*e*2,t&&(n[a]=t[o],n[a+1]=t[o+1],n[a+2]=t[o+2],n[a+3]=t[o+3],n[a+4]=t[o+4],n[a+5]=t[o+5]),i&&(r[a]=i[o],r[a+1]=i[o+1],r[a+2]=i[o+2],r[a+3]=i[o+3],r[a+4]=i[o+4],r[a+5]=i[o+5])}}class hx extends Bv{constructor(e,t,i){super(e,t,i),this.type="trace",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null}),this.init(i)}init(e){var t=e||{};t.colorScheme=Ia(t.colorScheme,"chainname"),t.colorScale=Ia(t.colorScale,"RdYlBu"),"low"===t.quality?this.subdiv=3:"medium"===t.quality?this.subdiv=6:"high"===t.quality?this.subdiv=12:this.subdiv=Ia(t.subdiv,6),this.tension=Ia(t.tension,NaN),this.smoothSheet=Ia(t.smoothSheet,!1),super.init(t)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!1,smoothSheet:this.smoothSheet},e)}getAtomRadius(e){return e.isTrace()?.1:0}createData(e){var t=[],i=[];return this.structure.eachPolymer((e=>{if(!(e.residueCount<4)){i.push(e);var n=new yy(e,this.getSplineParams()),r=n.getSubdividedPosition(),s=n.getSubdividedColor(this.getColorParams());t.push(new lx(Object.assign({},r,s),this.getBufferParams()))}}),e.getSelection()),{bufferList:t,polymerList:i}}updateData(e,t){e=e||{};var i=0,n=t.polymerList.length;for(i=0;i<n;++i){var r={},s=new yy(t.polymerList[i],this.getSplineParams());if(e.position){var o=s.getSubdividedPosition();Object.assign(r,{position:o.position})}if(e.color){var a=s.getSubdividedColor(this.getColorParams());Object.assign(r,{color:a.color})}t.bufferList[i].setAttributes(r)}}setParameters(e){var t={};return e&&e.tension&&Object.assign(t,{position:!0}),super.setParameters(e,t,!1),this}}ll.add("trace",hx);class ux extends Sy{constructor(e,t,i){super(e,t,i),this.type="tube",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}init(e){var t=e||{};t.aspectRatio=1,t.radiusScale=Ia(t.radiusScale,2),"low"===t.quality&&(this.radialSegments=5),super.init(t)}getSplineParams(){return super.getSplineParams({directional:!1})}}ll.add("tube",ux);class dx extends Bv{constructor(e,t,i){super(e,t,i),this.type="unitcell",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0},this.parameters,{assembly:null}),this.init(i)}init(e){const t=e||{};let i=.5;this.structure.unitcell&&(i=Math.cbrt(this.structure.unitcell.volume)/200),t.radiusSize=Ia(t.radiusSize,i),t.colorValue=Ia(t.colorValue,"orange"),t.useInteriorColor=Ia(t.useInteriorColor,!0),super.init(t)}getUnitcellData(e){return e.unitcell.getData(e)}create(){const e=this.structureView.getStructure();if(!e.unitcell)return;const t=this.getUnitcellData(e);this.sphereBuffer=new tg(t.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new dy(t.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})}createData(e){}updateData(e,t){const i=t.sview.getStructure();if(!i.unitcell)return;const n=this.getUnitcellData(i),r={},s={};e&&!e.position||(Object.assign(r,{position:n.vertex.position}),Object.assign(s,{position1:n.edge.position1,position2:n.edge.position2})),e&&!e.color||(Object.assign(r,{color:n.vertex.color}),Object.assign(s,{color:n.edge.color,color2:n.edge.color2})),e&&!e.radius||(Object.assign(r,{radius:n.vertex.radius}),Object.assign(s,{radius:n.edge.radius})),this.sphereBuffer.setAttributes(r),this.cylinderBuffer.setAttributes(s)}}ll.add("unitcell",dx);class fx extends Bv{constructor(e,t,i){super(e,t,i),this.type="validation",this.parameters=Object.assign({},this.parameters,{radiusType:null,radiusSize:null,radiusScale:null}),this.init(i)}init(e){const t=e||{};t.colorValue=Ia(t.colorValue,"#f0027f"),t.useInteriorColor=Ia(t.useInteriorColor,!0),super.init(t)}createData(e){if(!e.validation)return;const t=e.validation.getClashData({structure:e,color:this.colorValue});return{bufferList:[new dy(t,this.getBufferParams({openEnded:!1}))]}}}ll.add("validation",fx);const mx=new Zt,px=new Zt,gx=new Zt,vx=new Zt(0,1,0);const yx=Object.assign({radialSegments:60,openEnded:!1},em);class xx extends Wp{constructor(e,t={}){super({position:new Float32Array(e.position1.length),color:e.color,picking:e.picking},t,function(e={}){const t=new va(1,1,Ia(e.radialSegments,60),1,Ia(e.openEnded,!1));return t.applyMatrix4((new ri).makeRotationX(-Math.PI/2)),t}(t)),this.updateNormals=!0,this._position=new Float32Array(e.position1.length),this.setAttributes(e,!0)}get defaultParameters(){return yx}applyPositionTransform(e,t,i){px.fromArray(this._position1,i),gx.fromArray(this._position2,i),e.lookAt(px,gx,vx);const n=this._radius[t];mx.set(n,n,px.distanceTo(gx)),e.scale(mx)}setAttributes(e={},t){e.position1&&e.position2&&(Ul(e.position1,e.position2,this._position),this._position1=e.position1,this._position2=e.position2,e.position=this._position),e.radius&&(this._radius=e.radius),super.setAttributes(e,t)}}ml.add("cone",xx);class bx{constructor(e=[]){this.geometryList=e}computeBoundingBox(){this.boundingBox?this.boundingBox.empty():this.boundingBox=new Ni,this.geometryList.forEach((e=>{e.boundingBox||e.computeBoundingBox(),this.boundingBox.union(e.boundingBox)}))}}const _x=Object.assign({aspectRatio:1.5,radialSegments:50,openEnded:!1,disableImpostor:!1},em);class wx{constructor(e,t={}){this.group=new ko,this.wireframeGroup=new ko,this.pickingGroup=new ko,this.visible=!0,this.parameters=Ea(t,this.defaultParameters),this.splitPosition=new Float32Array(e.position1.length),this.cylinderRadius=new Float32Array(e.radius.length);const i=this.makeAttributes(e),n={radialSegments:this.parameters.radialSegments,openEnded:this.parameters.openEnded,disableImpostor:this.parameters.disableImpostor};this.cylinderBuffer=new dy(i.cylinder,n),this.coneBuffer=new xx(i.cone,n),this.geometry=new bx([this.cylinderBuffer.geometry,this.coneBuffer.geometry]),this.matrix=Ia(t.matrix,new ri),this.picking=e.picking}get defaultParameters(){return _x}set matrix(e){im.prototype.setMatrix.call(this,e)}get matrix(){return this.group.matrix.clone()}get pickable(){return!!this.picking}makeAttributes(e={}){const t=this.splitPosition,i=this.cylinderRadius,n=this.parameters.aspectRatio;let r,s;const o={},a={};if(e.radius){for(r=0,s=i.length;r<s;++r)i[r]=e.radius[r]/n;o.radius=i,a.radius=e.radius}if(e.position1&&e.position2){const c=new Zt,l=new Zt,h=new Zt,u=new Zt;for(r=0,s=t.length;r<s;r+=3){c.fromArray(e.position1,r),l.fromArray(e.position2,r),h.subVectors(c,l);const s=h.length(),o=i[r/3]*n*2,a=Math.min(s,o);h.setLength(a),u.copy(l).add(h),u.toArray(t,r)}o.position1=e.position1,o.position2=t,a.position1=t,a.position2=e.position2}return e.color&&(o.color=e.color,o.color2=e.color,a.color=e.color),{cylinder:o,cone:a}}getMesh(){return(new ko).add(this.cylinderBuffer.getMesh(),this.coneBuffer.getMesh())}getWireframeMesh(){return(new ko).add(this.cylinderBuffer.getWireframeMesh(),this.coneBuffer.getWireframeMesh())}getPickingMesh(){return(new ko).add(this.cylinderBuffer.getPickingMesh(),this.coneBuffer.getPickingMesh())}setAttributes(e={}){const t=this.makeAttributes(e);this.cylinderBuffer.setAttributes(t.cylinder),this.coneBuffer.setAttributes(t.cone)}setParameters(e={}){(e=Object.assign({},e))&&void 0!==e.matrix&&(this.matrix=e.matrix),delete e.matrix,e&&void 0!==e.wireframe&&(this.parameters.wireframe=e.wireframe,this.setVisibility(this.visible)),this.cylinderBuffer.setParameters(e),this.coneBuffer.setParameters(e)}setVisibility(e){im.prototype.setVisibility.call(this,e)}dispose(){this.cylinderBuffer.dispose(),this.coneBuffer.dispose()}}ml.add("arrow",wx);const Sx=new Zt,Ax=new Zt,Mx=new Zt,Cx=new Zt(0,0,0);class Px extends Wp{constructor(e,t={}){super(e,t,new pr(1,1,1)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,t,i){Ax.fromArray(this._heightAxis,i),Mx.fromArray(this._depthAxis,i),e.lookAt(Cx,Ax,Mx),Sx.set(this._size[t],Mx.length(),Ax.length()),e.scale(Sx)}setAttributes(e={},t){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,t)}}ml.add("box",Px);const Tx=new Zt,Ix=new Zt,Ex=new Zt,Dx=new Zt(0,0,0),Lx=Object.assign({sphereDetail:2},em);class Rx extends Wp{constructor(e,t={}){super(e,t,new ua(1,Ia(t.sphereDetail,2))),this.updateNormals=!0,this.setAttributes(e,!0)}get defaultParameters(){return Lx}applyPositionTransform(e,t,i){Ix.fromArray(this._majorAxis,i),Ex.fromArray(this._minorAxis,i),e.lookAt(Dx,Ix,Ex),Tx.set(this._radius[t],Ex.length(),Ix.length()),e.scale(Tx)}setAttributes(e={},t){e.radius&&(this._radius=e.radius),e.majorAxis&&(this._majorAxis=e.majorAxis),e.minorAxis&&(this._minorAxis=e.minorAxis),super.setAttributes(e,t)}}ml.add("ellipsoid",Rx);const kx=new Zt,Ox=new Zt,Bx=new Zt,Nx=new Zt(0,0,0);class Fx extends Wp{constructor(e,t={}){super(e,t,new la(1,0)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,t,i){Ox.fromArray(this._heightAxis,i),Bx.fromArray(this._depthAxis,i),e.lookAt(Nx,Ox,Bx),kx.set(this._size[t],Bx.length(),Ox.length()),e.scale(kx)}setAttributes(e={},t){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,t)}}ml.add("octahedron",Fx);const zx=new Zt,Ux=new Zt,$x=new Zt,Gx=new Zt(0,0,0);class Vx extends Wp{constructor(e,t={}){super(e,t,new aa(1,0)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,t,i){Ux.fromArray(this._heightAxis,i),$x.fromArray(this._depthAxis,i),e.lookAt(Gx,Ux,$x),zx.set(this._size[t],$x.length(),Ux.length()),e.scale(zx)}setAttributes(e={},t){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,t)}}ml.add("tetrahedron",Vx);const Hx=new Zt,jx=new Zt,Wx=new Zt,qx=new Zt(0,0,0),Xx=Object.assign({radiusRatio:.2,radialSegments:16,tubularSegments:32},em);class Yx extends Wp{constructor(e,t={}){super(e,t,new fa(1,Ia(t.radiusRatio,.2),Ia(t.radialSegments,16),Ia(t.tubularSegments,32))),this.updateNormals=!0,this.setAttributes(e,!0)}get defaultParameters(){return Xx}applyPositionTransform(e,t,i){jx.fromArray(this._majorAxis,i),Wx.fromArray(this._minorAxis,i),e.lookAt(qx,jx,Wx);const n=this._radius[t];Hx.set(n,n,n),e.scale(Hx)}setAttributes(e={},t){e.radius&&(this._radius=e.radius),e.majorAxis&&(this._majorAxis=e.majorAxis),e.minorAxis&&(this._minorAxis=e.minorAxis),super.setAttributes(e,t)}}ml.add("torus",Yx);class Zx{constructor(e,t){var i=t||{};this.streamer=e,this.name=Ia(i.name,""),this.path=Ia(i.path,"")}get type(){return""}get __objName(){return""}get isBinary(){return!1}get isJson(){return!1}get isXml(){return!1}parse(){return this.streamer.read().then((()=>(this._beforeParse(),this._parse(),this._afterParse(),this[this.__objName])))}_parse(){}_beforeParse(){}_afterParse(){e.Debug&&il.log(this[this.__objName])}}class Kx extends Zx{constructor(e,t){var i=t||{};super(e,i),this.firstModelOnly=Ia(i.firstModelOnly,!1),this.asTrajectory=Ia(i.asTrajectory,!1),this.cAlphaOnly=Ia(i.cAlphaOnly,!1),this.structure=new Fp(this.name,this.path),this.structureBuilder=new ep(this.structure)}get type(){return"structure"}get __objName(){return"structure"}}class Qx{constructor(e,t,i="",n,r=[]){this.structure=e,this.index=t,this.description=i,this.entityType=function(e){switch(e=e.toLowerCase()){case"polymer":return 1;case"non-polymer":return 2;case"macrolide":return 3;case"water":return 4;default:return 0}}(n||""),this.chainIndexList=r,r.forEach((function(i){e.chainStore.entityIndex[i]=t}))}get type(){return function(e){switch(e){case 1:return"polymer";case 2:return"non-polymer";case 3:return"macrolide";case 4:return"water";default:return}}(this.entityType)}getEntityType(){return this.entityType}isPolymer(){return 1===this.entityType}isNonPolymer(){return 2===this.entityType}isMacrolide(){return 3===this.entityType}isWater(){return 4===this.entityType}eachChain(e){const t=this.structure.getChainProxy();this.chainIndexList.forEach((function(i){t.index=i,e(t)}))}}const Jx={a:1,b:1,c:1,alpha:90,beta:90,gamma:90,spacegroup:"P 1"};class eb{constructor(e=Jx){this.cartToFrac=new ri,this.fracToCart=new ri,this.a=e.a,this.b=e.b,this.c=e.c,this.alpha=e.alpha,this.beta=e.beta,this.gamma=e.gamma,this.spacegroup=e.spacegroup;const t=Ka(this.alpha),i=Ka(this.beta),n=Ka(this.gamma),r=Math.cos(t),s=Math.cos(i),o=Math.cos(n),a=Math.sin(i),c=Math.sin(n);if(this.volume=this.a*this.b*this.c*Math.sqrt(1-r*r-s*s-o*o+2*r*s*o),void 0===e.cartToFrac){const e=this.a*this.b*c/this.volume,t=(s*o-r)/(a*c);this.fracToCart.set(this.a,0,0,0,this.b*o,this.b*c,0,0,this.c*s,-this.c*a*t,1/e,0,0,0,0,1).transpose(),this.cartToFrac.getInverse(this.fracToCart)}else this.cartToFrac.copy(e.cartToFrac),this.fracToCart.getInverse(this.cartToFrac)}getPosition(e){const t=new Float32Array(24);if(e.unitcell){const i=e.unitcell,n=e.center.clone().applyMatrix4(i.cartToFrac).floor(),r=new Zt;let s=0;const o=function(e,o,a){r.set(e,o,a).add(n).applyMatrix4(i.fracToCart).toArray(t,s),s+=3};o(0,0,0),o(1,0,0),o(0,1,0),o(0,0,1),o(1,1,0),o(1,0,1),o(0,1,1),o(1,1,1)}return t}getCenter(e){return function(e,t=new Zt){const i=e.length;for(let n=0;n<i;n+=3)t.x+=e[n],t.y+=e[n+1],t.z+=e[n+2];return t.divideScalar(i/3),t}(this.getPosition(e))}getData(e,t={}){const i=Ia(t.colorValue,"orange"),n=Ia(t.radius,Math.cbrt(this.volume)/200),r=new mn(i),s=new Zt,o=this.getPosition(e),a=Vl(8,r.r,r.g,r.b),c=Gl(8,n),l=new Float32Array(36),h=new Float32Array(36),u=Vl(12,r.r,r.g,r.b),d=Gl(12,n);let f=0;function m(e,t){s.fromArray(o,3*e).toArray(l,f),s.fromArray(o,3*t).toArray(h,f),f+=3}m(0,1),m(0,2),m(0,3),m(1,4),m(1,5),m(2,6),m(3,5),m(4,7),m(5,7),m(2,4),m(7,6),m(3,6);const p=new xf(this,e);return{vertex:{position:o,color:a,radius:c,picking:p},edge:{position1:l,position2:h,color:u,color2:u,radius:d,picking:p}}}}const tb={1:"h",2:"h",3:"i",4:"h",5:"g",6:"h",7:"h",8:"h",9:"h",10:"h",0:"h"},ib=["DAL","DAR","DSG","DAS","DCY","DGL","DGN","DHI","DIL","DLE","DLY","MED","DPN","DPR","DSN","DTH","DTR","DTY","DVA","DNE"],nb=["MOL_ID","MOLECULE","CHAIN","FRAGMENT","SYNONYM","EC","ENGINEERED","MUTATION","OTHER_DETAILS"],rb=/\s+/;function sb(e,t,i){let n=`${e}`;return t&&(n+=`:${t}`),i&&(n+=`^${i}`),n}class ob extends Kx{constructor(e,t){const i=t||{};super(e,i),this.hex=Ia(i.hex,!1),this.inferBonds=Ia(i.inferBonds,"all")}get type(){return"pdb"}_parse(){e.Debug&&il.time("PdbParser._parse "+this.name);let t=!1;const i=this.streamer.peekLines(1)[0],n=i.substr(62,4),r=i.substr(72,4);n===r&&r.trim()&&(t=!0);const s="pqr"===this.type,o="pdbqt"===this.type,a=this.structure,c=this.structureBuilder,l=this.hex;let h=10,u=10;const d=this.firstModelOnly,f=this.asTrajectory,m=this.cAlphaOnly,p=a.frames,g=a.boxes;let v,y,x=!1;const b=a.biomolDict;let _,w,S,A,M,C,P,T,I,E,D,L,R,k,O,B,N,F,z,U,$,G,V={};const H={},j={},W=[];let q,X;const Y={},Z={},K={};let Q,J,ee,te,ie,ne,re;const se={};let oe;const ae={helices:[],sheets:[]},ce=ae.helices,le=ae.sheets,he=a.atomMap,ue=a.atomStore;ue.resize(Math.round(this.streamer.data.length/80)),(s||o)&&ue.addField("partialCharge",1,"float32"),s&&ue.addField("radius",1,"float32");const de=a.getAtomProxy(),fe=a.getAtomProxy();let me=0,pe=0,ge=!0;this.streamer.eachChunkOfLines((function(e){!function(e,i,n){for(let r=e;r<i;++r)if(A=n[r],M=A.substr(0,6),"ATOM  "===M||"HETATM"===M){if(ge&&(f?(x?(v=new Float32Array(3*ue.count),p.push(v)):v=[],y=0):d||(V={}),Q=1,J=Q.toString(),ee=!0,ge=!1),d&&pe>0)continue;let e,i,n,r,a,g=0;if(s){if(r=A.split(rb),g=10===r.length?1:0,L=r[2],m&&"CA"!==L)continue;e=parseFloat(r[6-g]),i=parseFloat(r[7-g]),n=parseFloat(r[8-g])}else{if(L=A.substr(12,4).trim(),m&&"CA"!==L)continue;e=parseFloat(A.substr(30,8)),i=parseFloat(A.substr(38,8)),n=parseFloat(A.substr(46,8))}if(f){const t=3*y;if(v[t+0]=e,v[t+1]=i,v[t+2]=n,y+=1,x)continue}s?(C=parseInt(r[1]),a="",R="H"===A[0],P=g?"":r[4],T=parseInt(r[5-g]),D="",I=r[3],O="",E=1):(C=parseInt(A.substr(6,5),h),l&&99999===C&&(h=16),R="H"===A[0],P=A[21].trim(),T=parseInt(A.substr(22,4),u),l&&9999===T&&(u=16),D=A[26].trim(),I=A.substr(17,4).trim()||"MOL",k=parseFloat(A.substr(60,6)),O=A[16].trim(),E=parseFloat(A.substr(54,6)),t||(o?(a=A.substr(76,3).trim(),a in Td&&(a=Td[a])):(a=A.substr(76,2).trim(),P||(P=A.substr(72,4).trim())),B=parseInt((A.substr(79,1)+A.substr(78,1)).trim()))),ue.growIfFull(),ue.atomTypeId[me]=he.add(L,a),ue.x[me]=e,ue.y[me]=i,ue.z[me]=n,ue.serial[me]=C,ue.altloc[me]=O.charCodeAt(0),ue.occupancy[me]=isNaN(E)?0:E,s?(ue.partialCharge[me]=parseFloat(r[9-g]),ue.radius[me]=parseFloat(r[10-g])):(ue.bfactor[me]=isNaN(k)?0:k,o&&(ue.partialCharge[me]=parseFloat(A.substr(70,6))),isFinite(B)&&(ue.formalCharge||ue.addField("formalCharge",1,"int8"),ue.formalCharge[me]=B));const b=sb(T,P,D);!R||Z[b]||ib.includes(I)?ee||te===P||(Q+=1,J=Q.toString()):te===P&&ne===I&&(wd.includes(I)||ie===T&&re===D)||(Q+=1,J=Q.toString(),ie=T,ne=I,re=D),c.addAtom(pe,P,J,I,T,R,void 0,D),V[C]=me,me+=1,ee=!1,te=P}else if("CONECT"===M){const e=V[parseInt(A.substr(6,5))],t=[11,16,21,26],i={};if(void 0===e)continue;for(let n=0;n<4;++n){let r=parseInt(A.substr(t[n],5));if(!Number.isNaN(r)&&(r=V[r],void 0!==r))if(e<r?(de.index=e,fe.index=r):(de.index=r,fe.index=e),void 0!==i[r])a.bondStore.bondOrder[i[r]]+=1;else{const e=de.index+"|"+fe.index;void 0===j[e]&&(j[e]=!0,i[r]=a.bondStore.count,a.bondStore.addBond(de,fe,1))}}}else if("HELIX "===M){N=A[19].trim(),F=parseInt(A.substr(21,4)),z=A[25].trim(),U=A[31].trim(),$=parseInt(A.substr(33,4)),G=A[37].trim();let e=parseInt(A.substr(39,1));e=(tb[e]||tb[0]).charCodeAt(0),ce.push([N,F,z,U,$,G,e])}else if("SHEET "===M)N=A[21].trim(),F=parseInt(A.substr(22,4)),z=A[26].trim(),U=A[32].trim(),$=parseInt(A.substr(33,4)),G=A[37].trim(),le.push([N,F,z,U,$,G]);else if("HETNAM"===M)Y[A.substr(11,3)]=A.substr(15).trim();else if("SEQRES"===M){const e=A[11].trim();e!==oe&&(se[e]=[],oe=e),se[e].push(...A.substr(19).trim().split(rb))}else if("MODRES"===M){const e=A.substr(12,3).trim(),t=A[16].trim(),i=A[22].trim(),n=parseInt(A.substr(18,4).trim()),r=sb(n,t,i);Z[r]={resname:e,chainname:t,inscode:i,resno:n}}else if("COMPND"===M){const e=A.substr(10,70).trim(),t=e.indexOf(":"),i=e.substring(0,t);let n;nb.includes(i)?(X=i,n=e.substring(t+2)):n=e,n=n.replace(/;$/,""),"MOL_ID"===X?(q={chainList:[],name:""},W.push(q)):"MOLECULE"===X?(q.name&&(q.name+=" "),q.name+=n):"CHAIN"===X&&Array.prototype.push.apply(q.chainList,n.split(/\s*,\s*/))}else if(A.startsWith("TER")){const e=a.getChainProxy(a.chainStore.count-1);K[e.chainname]=e.index,Q+=1,J=Q.toString(),ee=!0}else if("REMARK"===M&&"350"===A.substr(7,3)){if("BIOMOLECULE:"===A.substr(11,12)){let e=A.substr(23).trim();/^(0|[1-9][0-9]*)$/.test(e)&&(e="BU"+e),_=new Qm(e),b[e]=_}else if("BIOMT"===A.substr(13,5)){const e=A.split(/\s+/),t=parseInt(A[18])-1;0===t&&(S=new ri,w.matrixList.push(S));const i=S.elements;i[0+t]=parseFloat(e[4]),i[4+t]=parseFloat(e[5]),i[8+t]=parseFloat(e[6]),i[12+t]=parseFloat(e[7])}else if("APPLY THE FOLLOWING TO CHAINS:"===A.substr(11,30)||"                   AND CHAINS:"===A.substr(11,30)){"APPLY"===A.substr(11,5)&&(w=_.addPart());const e=A.substr(41,30).split(",");for(let t=0,i=e.length;t<i;++t){const i=e[t].trim();i&&w.chainList.push(i)}}}else if("HEADER"===M)a.id=A.substr(62,4);else if("TITLE "===M)a.title+=(a.title?" ":"")+A.substr(10,70).trim();else if("MODEL "===M)ge=!0;else if("ENDMDL"===M||"END"===A.trim()){if(ge)continue;f&&!x&&(p.push(new Float32Array(v)),x=!0),pe+=1,ge=!0}else if("MTRIX"===A.substr(0,5)){if("1"===A[59])continue;if(!_||"NCS"!==_.name){const e="NCS";_=new Qm(e),b[e]=_,w=_.addPart()}const e=A.split(/\s+/),t=parseInt(A[5])-1;0===t&&(S=new ri,w.matrixList.push(S));const i=S.elements;i[0+t]=parseFloat(e[2]),i[4+t]=parseFloat(e[3]),i[8+t]=parseFloat(e[4]),i[12+t]=parseFloat(e[5])}else if("ORIGX"===A.substr(0,5)){H.origx||(H.origx=new ri);const e=A.split(/\s+/),t=parseInt(A[5])-1,i=H.origx.elements;i[0+t]=parseFloat(e[1]),i[4+t]=parseFloat(e[2]),i[8+t]=parseFloat(e[3]),i[12+t]=parseFloat(e[4])}else if("SCALE"===A.substr(0,5)){H.scale||(H.scale=new ri);const e=A.split(/\s+/),t=parseInt(A[5])-1,i=H.scale.elements;i[0+t]=parseFloat(e[1]),i[4+t]=parseFloat(e[2]),i[8+t]=parseFloat(e[3]),i[12+t]=parseFloat(e[4])}else if("CRYST1"===M){const e=parseFloat(A.substr(6,9)),t=parseFloat(A.substr(15,9)),i=parseFloat(A.substr(24,9)),n=parseFloat(A.substr(33,7)),r=parseFloat(A.substr(40,7)),s=parseFloat(A.substr(47,7)),o=A.substr(55,11).trim(),a=new Float32Array(9);a[0]=e,a[4]=t,a[8]=i,g.push(a),0===pe&&(H.a=e,H.b=t,H.c=i,H.alpha=n,H.beta=r,H.gamma=s,H.spacegroup=o)}}(0,e.length,e)})),c.finalize();const ve=W.length;if(ve){a.eachChain((function(e){e.entityIndex=ve})),W.forEach((function(e,t){const i=e.chainList.map((function(e){return K[e]}));a.entityList.push(new Qx(a,t,e.name,"polymer",i))}));let e=W.length;const t=a.getResidueProxy(),i={};a.eachChain((function(e){e.entityIndex===ve&&(t.index=e.residueOffset,i[t.resname]||(i[t.resname]=[]),i[t.resname].push(e.index))})),Object.keys(i).forEach((function(t){const n=i[t];let r="non-polymer",s=Y[t]||t;wd.includes(t)&&(s="water",r="water"),a.entityList.push(new Qx(a,e,s,r,n)),e+=1}))}void 0!==H.a?a.unitcell=new eb(H):a.unitcell=void 0,(ce.length||le.length)&&tp(a,ae),a.finalizeAtoms(),t||sp(a),op(a,this.inferBonds),a.finalizeBonds(),ce.length||le.length||ip(a),up(a),e.Debug&&il.timeEnd("PdbParser._parse "+this.name)}}hl.add("pdb",ob),hl.add("pdb1",ob),hl.add("ent",ob);const ab=/\s+/,cb=/'((?:(?!'\s).)*)'|"((?:(?!"\s).)*)"|(\S+)/g,lb=/"/g,hb=/^['"]+|['"]+$/g,ub=/^\D{1,2}/;function db(e){return!e||e[0]!==e[e.length-1]||"'"!==e[0]&&'"'!==e[0]?e:e.substring(1,e.length-1)}function fb(e,t){Array.isArray(e[t])||Object.keys(e).forEach((function(t){e[t]=[e[t]]}))}function mb(e){return"?"!==e}function pb(e,t){return mb(e)?e:t}function gb(e){switch(e.toLowerCase()){case"?":case"sing":return 1;case"doub":return 2;case"trip":return 3;case"quad":return 4}return 0}class vb extends Kx{get type(){return"cif"}_parse(){il.time("CifParser._parse "+this.name);var t,i,n,r,s,o,a,c,l,h,u,d,f,m,p,g,v,y,x,b,_,w,S=this.structure,A=this.structureBuilder,M=this.firstModelOnly,C=this.asTrajectory,P=this.cAlphaOnly,T=S.frames,I={},E={},D={},L=!1,R=null,k=!1,O=!1,B=!1,N=[],F=null,z=null,U=null,$=null,G=[],V=S.atomMap,H=S.atomStore;H.resize(this.streamer.data.length/100);var j,W=0,q=0;if(this.streamer.eachChunkOfLines((function(X){!function(X,Y,Z){for(var K=X;K<Y;++K)if(n=Z[K],((r=n.trim())||L||O)&&"#"!==r[0])if("data_"===r.substring(0,5))I.data=r.substring(5).trim();else if(";"===r[0])L?(O?(F===N.length&&(F=0),N[F].push(R),F+=1):!1===U?I[z]=R:I[z][U]=R,L=!1,R=null):(L=!0,R=r.substring(1));else if("loop_"===r)O=!0,B=!0,N.length=0,G.length=0,F=0;else if("_"===r[0]){var Q,J,ee;if(O&&!B&&(O=!1),O)J=(Q=r.split("."))[0].substring(1),ee=Q[1],1===Q.length?(ee=!1,I[J]||(I[J]=[]),N.push(I[J])):(I[J]||(I[J]={}),I[J][ee]?e.Debug&&il.warn(J,ee,"already exists"):(I[J][ee]=[],N.push(I[J][ee]),G.push(ee))),z=J,U=ee,$=!0;else{var te=r.match(cb),ie=te[0],ne=te[1];J=(Q=ie.split("."))[0].substring(1),ee=Q[1],1===Q.length?(ee=!1,I[J]=ne):(I[J]||(I[J]={}),I[J][ee]?e.Debug&&il.warn(J,ee,"already exists"):I[J][ee]=ne),ne||(k=!0),z=J,U=ee}}else if(L)R+=n;else if(O){if(!r)continue;if("atom_site"===z){const n=r.split(ab);$&&(s=G.indexOf("auth_asym_id"),o=G.indexOf("auth_seq_id"),a=G.indexOf("label_seq_id"),c=G.indexOf("label_atom_id"),l=G.indexOf("label_comp_id"),h=G.indexOf("label_asym_id"),u=G.indexOf("label_entity_id"),d=G.indexOf("label_alt_id"),y=G.indexOf("Cartn_x"),x=G.indexOf("Cartn_y"),b=G.indexOf("Cartn_z"),m=G.indexOf("id"),p=G.indexOf("type_symbol"),f=G.indexOf("group_PDB"),_=G.indexOf("B_iso_or_equiv"),g=G.indexOf("pdbx_PDB_model_num"),v=G.indexOf("pdbx_PDB_ins_code"),w=G.indexOf("occupancy"),$=!1,j=parseInt(n[g]),C&&(t=[],i=0));const I=parseInt(n[g]);if(j!==I&&(C&&(0===q&&T.push(new Float32Array(t)),t=new Float32Array(3*H.count),T.push(t),i=0),q+=1),j=I,M&&q>0)continue;const L=n[c].replace(lb,"");if(P&&"CA"!==L)continue;const R=parseFloat(n[y]),k=parseFloat(n[x]),O=parseFloat(n[b]);if(C){const e=3*i;if(t[e+0]=R,t[e+1]=k,t[e+2]=O,i+=1,q>0)continue}const B=n[l],N=parseInt(n[-1!==o?o:a]);let F=n[v];F="?"===F?"":F;const z=n[s],U=n[h],X="H"===n[f][0],Y=n[p],Z=parseFloat(n[_]),K=parseFloat(n[w]);let Q=n[d];if(Q="."===Q?"":Q,H.growIfFull(),H.atomTypeId[W]=V.add(L,Y),H.x[W]=R,H.y[W]=k,H.z[W]=O,H.serial[W]=parseInt(n[m]),H.bfactor[W]=isNaN(Z)?0:Z,H.occupancy[W]=isNaN(K)?0:K,H.altloc[W]=Q.charCodeAt(0),A.addAtom(q,z,U,B,N,X,void 0,F),e.Debug){const t=E[U];void 0!==t&&t!==z&&e.Debug&&il.warn(t,z)}E[U]=z;const J=n[u];D[J]||(D[J]=new Set),D[J].add(S.chainStore.count-1),W+=1}else{const e=r.match(cb),t=e.length;F===N.length&&(F=0);for(let i=0;i<t;++i)N[F+i].push(e[i]);F+=t}B=!1}else if("'"===r[0]&&"'"===r[r.length-1]){const e=r.substring(1,r.length-1);!1===U?I[z]=e:I[z][U]=e}else k?!1===U?I[z]=r:I[z][U]=r:e.Debug&&il.log("CifParser._parse: unknown state",r);else L=!1,O=!1,k=!1,N.length=0,F=null,z=null,U=null,$=null,G.length=0}(0,X.length,X)})),I.chem_comp&&I.chem_comp_atom&&!I.struct)!function(e,t,i){const n=t.atomStore,r=t.atomMap;let s,o;const a=e.chem_comp,c=e.chem_comp_atom,l=e.chem_comp_bond;a&&(a.name&&(t.title=a.name.trim().replace(hb,"")),a.id&&(t.id=a.id.trim().replace(hb,"")));var h={};if(c){var u,d,f,m;for(fb(c,"comp_id"),o=c.comp_id.length,s=0;s<o;++s)n.growIfFull(),u=c.atom_id[s].replace(lb,""),d=c.type_symbol[s],h[u]=s,n.atomTypeId[s]=r.add(u,d),n.x[s]=c.model_Cartn_x[s],n.y[s]=c.model_Cartn_y[s],n.z[s]=c.model_Cartn_z[s],n.serial[s]=s,f=c.pdbx_component_comp_id[s],m=c.pdbx_residue_numbering?c.pdbx_residue_numbering[s]:1,i.addAtom(0,"","",f,m,!0);for(s=0;s<o;++s){var p=s+o;n.growIfFull(),u=c.atom_id[s].replace(lb,""),d=c.type_symbol[s],n.atomTypeId[p]=r.add(u,d),n.x[p]=c.pdbx_model_Cartn_x_ideal[s],n.y[p]=c.pdbx_model_Cartn_y_ideal[s],n.z[p]=c.pdbx_model_Cartn_z_ideal[s],n.serial[p]=p,f=c.pdbx_component_comp_id[s],m=c.pdbx_residue_numbering?c.pdbx_residue_numbering[s]:1,i.addAtom(1,"","",f,m,!0)}}if(c&&l){var g,v,y;fb(l,"comp_id"),o=l.comp_id.length;var x=c.comp_id.length,b=t.getAtomProxy(),_=t.getAtomProxy();for(s=0;s<o;++s)g=l.atom_id_1[s].replace(lb,""),v=l.atom_id_2[s].replace(lb,""),y=gb(l.value_order[s]),b.index=h[g],_.index=h[v],t.bondStore.growIfFull(),t.bondStore.addBond(b,_,y),b.index+=x,_.index+=x,t.bondStore.growIfFull(),t.bondStore.addBond(b,_,y)}}(I,S,A),A.finalize(),S.finalizeAtoms(),S.finalizeBonds(),pp(S);else if(I.atom_site_type_symbol&&I.atom_site_label&&I.atom_site_fract_x)!function(e,t,i){var n,r=t.atomStore,s=t.atomMap;e.data&&(t.id=e.data,t.name=e.data),t.unitcell=new eb({a:parseFloat(e.cell_length_a),b:parseFloat(e.cell_length_b),c:parseFloat(e.cell_length_c),alpha:parseFloat(e.cell_angle_alpha),beta:parseFloat(e.cell_angle_beta),gamma:parseFloat(e.cell_angle_gamma),spacegroup:db(e["symmetry_space_group_name_H-M"])});const o=new Zt,a=new Zt,c=e.atom_site_type_symbol.length,l={};for(let h=0;h<c;++h){r.growIfFull();const c=e.atom_site_label[h],u=e.atom_site_type_symbol[h];let d=l[u];if(!d){const e=u.match(ub);l[u]=d=null!==(n=null==e?void 0:e[0])&&void 0!==n?n:u}r.atomTypeId[h]=s.add(c,d),o.set(e.atom_site_fract_x[h],e.atom_site_fract_y[h],e.atom_site_fract_z[h]),o.applyMatrix4(t.unitcell.fracToCart),a.add(o),r.x[h]=o.x,r.y[h]=o.y,r.z[h]=o.z,e.atom_site_occupancy&&(r.occupancy[h]=parseFloat(e.atom_site_occupancy[h])),r.serial[h]=h,i.addAtom(0,"","","HET",1,!0)}a.divideScalar(c),t.center=a,up(t);const h=new Zt,u=new Zt,d=t.biomolDict.SUPERCELL.partList[0].matrixList;let f=c;function m(e){return s.get(r.atomTypeId[e]).covalent}const p=new ri;for(let e=0;e<c;++e){const t=m(e);o.set(r.x[e],r.y[e],r.z[e]),d.forEach((function(n){if(!p.equals(n)){h.copy(o),h.applyMatrix4(n);for(let n=0;n<c;++n){u.set(r.x[n],r.y[n],r.z[n]);const s=h.distanceToSquared(u),o=m(n)+t,a=o+.3,c=o-.5;if(s<a*a&&s>c*c)return r.growIfFull(),r.atomTypeId[f]=r.atomTypeId[e],r.x[f]=h.x,r.y[f]=h.y,r.z[f]=h.z,r.occupancy[f]=r.occupancy[e],r.serial[f]=f,r.altloc[f]="A".charCodeAt(0),i.addAtom(0,"","","HET",1,!0),void(f+=1)}}}))}}(I,S,A),A.finalize(),S.finalizeAtoms(),op(S),S.finalizeBonds();else{var X=function(e,t,i){var n,r,s,o,a=[],c=[],l=e.struct_conf;if(null==l?void 0:l.pdbx_PDB_helix_class)for(fb(l,"id"),n=0,r=l.beg_auth_seq_id.length;n<r;++n){var h=parseInt(l.pdbx_PDB_helix_class[n]);Number.isNaN(h)||(s=l.pdbx_beg_PDB_ins_code[n],o=l.pdbx_end_PDB_ins_code[n],a.push([i[l.beg_label_asym_id[n]],parseInt(l.beg_auth_seq_id[n]),pb(s,""),i[l.end_label_asym_id[n]],parseInt(l.end_auth_seq_id[n]),pb(o,""),(tb[h]||tb[0]).charCodeAt(0)]))}var u=e.struct_sheet_range;if(u)for(fb(u,"id"),n=0,r=u.beg_auth_seq_id.length;n<r;++n)s=u.pdbx_beg_PDB_ins_code[n],o=u.pdbx_end_PDB_ins_code[n],c.push([i[u.beg_label_asym_id[n]],parseInt(u.beg_auth_seq_id[n]),pb(s,""),i[u.end_label_asym_id[n]],parseInt(u.end_auth_seq_id[n]),pb(o,"")]);return!(!l&&!u)&&{helices:a,sheets:c}}(I,0,E);if(function(e,t,i){var n={},r=t.biomolDict;if(e.pdbx_struct_oper_list){var s=e.pdbx_struct_oper_list;fb(s,"id"),s.id.forEach((function(e,t){var i=new ri,r=i.elements;r[0]=parseFloat(s["matrix[1][1]"][t]),r[1]=parseFloat(s["matrix[1][2]"][t]),r[2]=parseFloat(s["matrix[1][3]"][t]),r[4]=parseFloat(s["matrix[2][1]"][t]),r[5]=parseFloat(s["matrix[2][2]"][t]),r[6]=parseFloat(s["matrix[2][3]"][t]),r[8]=parseFloat(s["matrix[3][1]"][t]),r[9]=parseFloat(s["matrix[3][2]"][t]),r[10]=parseFloat(s["matrix[3][3]"][t]),r[3]=parseFloat(s["vector[1]"][t]),r[7]=parseFloat(s["vector[2]"][t]),r[11]=parseFloat(s["vector[3]"][t]),i.transpose(),n[e]=i}))}if(e.pdbx_struct_assembly_gen){var o=e.pdbx_struct_assembly_gen;fb(o,"assembly_id");var a=function(e){var t={};return e.replace(/[()']/g,"").split(",").forEach((function(e){if(e.includes("-"))for(var i=e.split("-"),r=parseInt(i[0]),s=parseInt(i[1]);r<=s;++r)t[r]=n[r];else t[e]=n[e]})),t};o.assembly_id.forEach((function(e,t){var n={},s=o.oper_expression[t].replace(/['"]\(|['"]/g,"");if(s.includes(")(")||s.indexOf("(")>0){s=s.split("(");var c=a(s[0]),l=a(s[1]);Object.keys(c).forEach((function(e){Object.keys(l).forEach((function(t){var i=new ri;i.multiplyMatrices(c[e],l[t]),n[e+"x"+t]=i}))}))}else n=a(s);var h=[];for(var u in n)h.push(n[u]);var d=e;/^(0|[1-9][0-9]*)$/.test(d)&&(d="BU"+d);for(var f=o.asym_id_list[t].split(","),m=0,p=f.length;m<p;++m)f[m]=i[f[m]];void 0===r[d]&&(r[d]=new Qm(d)),r[d].addPart(h,f)}))}if(e.struct_ncs_oper){var c=e.struct_ncs_oper;fb(c,"id");var l="NCS";r[l]=new Qm(l);var h=r[l].addPart();c.id.forEach((function(e,t){if("given"!==c.code[t]){var i=new ri,n=i.elements;n[0]=parseFloat(c["matrix[1][1]"][t]),n[1]=parseFloat(c["matrix[1][2]"][t]),n[2]=parseFloat(c["matrix[1][3]"][t]),n[4]=parseFloat(c["matrix[2][1]"][t]),n[5]=parseFloat(c["matrix[2][2]"][t]),n[6]=parseFloat(c["matrix[2][3]"][t]),n[8]=parseFloat(c["matrix[3][1]"][t]),n[9]=parseFloat(c["matrix[3][2]"][t]),n[10]=parseFloat(c["matrix[3][3]"][t]),n[3]=parseFloat(c["vector[1]"][t]),n[7]=parseFloat(c["vector[2]"][t]),n[11]=parseFloat(c["vector[3]"][t]),i.transpose(),h.matrixList.push(i)}})),0===h.matrixList.length&&delete r[l]}const u={};if(e.cell){const i=e.cell,n=parseFloat(i.length_a),r=parseFloat(i.length_b),s=parseFloat(i.length_c),o=new Float32Array(9);o[0]=n,o[4]=r,o[8]=s,t.boxes.push(o),u.a=n,u.b=r,u.c=s,u.alpha=parseFloat(i.angle_alpha),u.beta=parseFloat(i.angle_beta),u.gamma=parseFloat(i.angle_gamma)}e.symmetry&&(u.spacegroup=db(e.symmetry["space_group_name_H-M"]));var d=new ri;if(e.database_PDB_matrix){var f=e.database_PDB_matrix,m=d.elements;m[0]=parseFloat(f["origx[1][1]"]),m[1]=parseFloat(f["origx[1][2]"]),m[2]=parseFloat(f["origx[1][3]"]),m[4]=parseFloat(f["origx[2][1]"]),m[5]=parseFloat(f["origx[2][2]"]),m[6]=parseFloat(f["origx[2][3]"]),m[8]=parseFloat(f["origx[3][1]"]),m[9]=parseFloat(f["origx[3][2]"]),m[10]=parseFloat(f["origx[3][3]"]),m[3]=parseFloat(f["origx_vector[1]"]),m[7]=parseFloat(f["origx_vector[2]"]),m[11]=parseFloat(f["origx_vector[3]"]),d.transpose(),u.origx=d}var p=new ri;if(e.atom_sites){var g=e.atom_sites,v=p.elements;v[0]=parseFloat(g["fract_transf_matrix[1][1]"]),v[1]=parseFloat(g["fract_transf_matrix[1][2]"]),v[2]=parseFloat(g["fract_transf_matrix[1][3]"]),v[4]=parseFloat(g["fract_transf_matrix[2][1]"]),v[5]=parseFloat(g["fract_transf_matrix[2][2]"]),v[6]=parseFloat(g["fract_transf_matrix[2][3]"]),v[8]=parseFloat(g["fract_transf_matrix[3][1]"]),v[9]=parseFloat(g["fract_transf_matrix[3][2]"]),v[10]=parseFloat(g["fract_transf_matrix[3][3]"]),v[3]=parseFloat(g["fract_transf_vector[1]"]),v[7]=parseFloat(g["fract_transf_vector[2]"]),v[11]=parseFloat(g["fract_transf_vector[3]"]),p.transpose(),u.scale=p}void 0!==u.a?t.unitcell=new eb(u):t.unitcell=void 0}(I,S,E),function(t,i,n){var r=t.struct_conn;if(r){fb(r,"id");for(var s=/"/g,o=i.getAtomProxy(),a=i.getAtomProxy(),c={},l=0,h=r.id.length;l<h;++l){var u=r.conn_type_id[l];if("hydrog"!==u&&"mismat"!==u&&"saltbr"!==u&&"1_555"===r.ptnr1_symmetry[l]&&"1_555"===r.ptnr2_symmetry[l]){var d=r.pdbx_ptnr1_PDB_ins_code[l],f=r.pdbx_ptnr1_label_alt_id[l],m=r.ptnr1_auth_seq_id[l]+(mb(d)?"^"+d:"")+":"+n[r.ptnr1_label_asym_id[l]]+"."+r.ptnr1_label_atom_id[l].replace(s,"")+(mb(f)?"%"+f:""),p=c[m];if(!p){var g=new $c(m);if(g.selection.error){e.Debug&&il.warn("invalid selection for connection",m);continue}p=i.getAtomIndices(g),c[m]=p}var v=r.pdbx_ptnr2_PDB_ins_code[l],y=r.pdbx_ptnr2_label_alt_id[l],x=r.ptnr2_auth_seq_id[l]+(mb(v)?"^"+v:"")+":"+n[r.ptnr2_label_asym_id[l]]+"."+r.ptnr2_label_atom_id[l].replace(s,"")+(mb(y)?"%"+y:""),b=c[x];if(!b){var _=new $c(x);if(_.selection.error){e.Debug&&il.warn("invalid selection for connection",x);continue}b=i.getAtomIndices(_),c[x]=b}var w=p.length,S=b.length;if(w>S){var A=w;w=S,S=A;var M=p;p=b,b=M}if(0!==w&&0!==S)for(var C=0;C<S;++C)o.index=p[C%w],a.index=b[C],o&&a?i.bondStore.addBond(o,a,gb(r.pdbx_value_order[l])):il.log("atoms for connection not found");else e.Debug&&il.warn("no atoms found for",m,x)}}}}(I,S,E),function(e,t,i){if(e.entity){fb(e.entity,"id");for(var n=e.entity,r=n.id.length,s=0;s<r;++s){var o=n.pdbx_description[s],a=n.type[s],c=Array.from(i[n.id[s]]);t.entityList[s]=new Qx(t,s,o,a,c)}}}(I,S,D),I.struct&&I.struct.title&&(S.title=I.struct.title.trim().replace(hb,"")),I.entry&&I.entry.id&&(S.id=I.entry.id.trim().replace(hb,"")),I.pdbx_audit_revision_history){if(I.pdbx_audit_revision_history.revision_date){fb(I.pdbx_audit_revision_history,"revision_date");const e=I.pdbx_audit_revision_history.revision_date.filter(mb);e.length&&(S.header.releaseDate=e[0])}if(I.pdbx_database_status.recvd_initial_deposition_date){fb(I.pdbx_database_status,"recvd_initial_deposition_date");const e=I.pdbx_database_status.recvd_initial_deposition_date.filter(mb);e.length&&(S.header.depositionDate=e[0])}}else if(I.database_PDB_rev){if(I.database_PDB_rev.date){fb(I.database_PDB_rev,"date");const e=I.database_PDB_rev.date.filter(mb);e.length&&(S.header.releaseDate=e[0])}if(I.database_PDB_rev.date_original){fb(I.database_PDB_rev,"date_original");const e=I.database_PDB_rev.date_original.filter(mb);e.length&&(S.header.depositionDate=e[0])}}I.reflns&&I.reflns.d_resolution_high?mb(I.reflns.d_resolution_high)&&(S.header.resolution=parseFloat(I.reflns.d_resolution_high)):I.refine&&I.refine.ls_d_res_high&&mb(I.refine.ls_d_res_high)&&(S.header.resolution=parseFloat(I.refine.ls_d_res_high)),I.refine&&I.refine.ls_R_factor_R_free&&mb(I.refine.ls_R_factor_R_free)&&(S.header.rFree=parseFloat(I.refine.ls_R_factor_R_free)),I.refine&&I.refine.ls_R_factor_R_work&&mb(I.refine.ls_R_factor_R_work)&&(S.header.rWork=parseFloat(I.refine.ls_R_factor_R_work)),I.exptl&&I.exptl.method&&(fb(I.exptl,"method"),S.header.experimentalMethods=I.exptl.method.map((function(e){return e.replace(hb,"")}))),A.finalize(),S.finalizeAtoms(),op(S),S.finalizeBonds(),X?tp(S,X):ip(S),up(S),S.extraData.cif=I}e.Debug&&il.timeEnd("CifParser._parse "+this.name)}}hl.add("cif",vb),hl.add("mcif",vb),hl.add("mmcif",vb);hl.add("gro",class extends Kx{get type(){return"gro"}_parse(){e.Debug&&il.time("GroParser._parse "+this.name);var t,i,n=this.structure,r=this.structureBuilder,s=this.firstModelOnly,o=this.asTrajectory,a=this.cAlphaOnly,c=n.frames,l=n.boxes,h=this.streamer.peekLines(3);n.title=h[0].trim();var u,d,f,m,p=5+(h[2].length-h[2].lastIndexOf(".")-1),g=20+p,v=20+2*p,y=parseInt(h[1]),x=y+3,b=n.atomMap,_=n.atomStore;_.resize(y);var w=0,S=0,A=0;this.streamer.eachChunkOfLines((function(e){!function(e,n,h){for(var M=e;M<n;++M){var C=++A-1,P=h[M];if(P)if(C%x==0)o&&(t=new Float32Array(3*y),c.push(t),i=0);else if(C%x==1);else if(C%x==x-1){var T=P.trim().split(/\s+/),I=new Float32Array(9);if(I[0]=10*parseFloat(T[0]),I[4]=10*parseFloat(T[1]),I[8]=10*parseFloat(T[2]),l.push(I),s)return!0;S+=1}else{if(u=P.substr(10,5).trim(),a&&"CA"!==u)continue;var E=10*parseFloat(P.substr(20,p)),D=10*parseFloat(P.substr(g,p)),L=10*parseFloat(P.substr(v,p));if(o){var R=3*i;if(t[R+0]=E,t[R+1]=D,t[R+2]=L,i+=1,C>x)continue}d=P.substr(5,5).trim(),f=parseInt(P.substr(0,5)),m=parseInt(P.substr(15,5)),_.growIfFull(),_.atomTypeId[w]=b.add(u),_.x[w]=E,_.y[w]=D,_.z[w]=L,_.serial[w]=m,r.addAtom(S,"","",d,f,!1,"l"),w+=1}}}(0,e.length,e)})),r.finalize(),n.finalizeAtoms(),sp(n),op(n),n.finalizeBonds(),ip(n),e.Debug&&il.timeEnd("GroParser._parse "+this.name)}});var yb=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"].concat(["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"]);function xb(e,t,i){return t?new e(t.buffer,t.byteOffset,t.byteLength/(i||1)):void 0}function bb(e){return xb(DataView,e)}function _b(e){return xb(Int8Array,e)}function wb(e){return xb(Int32Array,e,4)}function Sb(e,t){var i=e.length/2;t||(t=new Int16Array(i));for(var n=0,r=0;n<i;++n,r+=2)t[n]=e[r]<<8^e[r+1]<<0;return t}function Ab(e,t){var i=e.length/4;t||(t=new Int32Array(i));for(var n=0,r=0;n<i;++n,r+=4)t[n]=e[r]<<24^e[r+1]<<16^e[r+2]<<8^e[r+3]<<0;return t}function Mb(e,t,i){var n=e.length,r=1/t;i||(i=new Float32Array(n));for(var s=0;s<n;++s)i[s]=e[s]*r;return i}function Cb(e,t){var i,n;if(!t){var r=0;for(i=0,n=e.length;i<n;i+=2)r+=e[i+1];t=new e.constructor(r)}var s=0;for(i=0,n=e.length;i<n;i+=2)for(var o=e[i],a=e[i+1],c=0;c<a;++c)t[s]=o,++s;return t}function Pb(e,t){var i=e.length;t||(t=new e.constructor(i)),i&&(t[0]=e[0]);for(var n=1;n<i;++n)t[n]=e[n]+t[n-1];return t}function Tb(e,t){var i,n,r=e instanceof Int8Array?127:32767,s=-r-1,o=e.length;if(!t){var a=0;for(i=0;i<o;++i)e[i]<r&&e[i]>s&&++a;t=new Int32Array(a)}for(i=0,n=0;i<o;){for(var c=0;e[i]===r||e[i]===s;)c+=e[i],++i;c+=e[i],++i,t[n]=c,++n}return t}function Ib(e,t,i){return Mb(Tb(e,wb(i)),t,i)}function Eb(e,t,i){var n=Tb(e,wb(i));return function(e,t,i){return Mb(Pb(e,wb(i)),t,i)}(n,t,xb(Float32Array,n,4))}function Db(e){var t=0,i=new DataView(e.buffer);function n(e){for(var t={},i=0;i<e;i++){t[a()]=a()}return t}function r(i){var n=e.subarray(t,t+i);return t+=i,n}function s(i){var n=e.subarray(t,t+i);t+=i;var r=65535;if(i>r){for(var s=[],o=0;o<n.length;o+=r)s.push(String.fromCharCode.apply(null,n.subarray(o,o+r)));return s.join("")}return String.fromCharCode.apply(null,n)}function o(e){for(var t=new Array(e),i=0;i<e;i++)t[i]=a();return t}function a(){var a,c,l=e[t];if(0==(128&l))return t++,l;if(128==(240&l))return t++,n(c=15&l);if(144==(240&l))return t++,o(c=15&l);if(160==(224&l))return t++,s(c=31&l);if(224==(224&l))return a=i.getInt8(t),t++,a;switch(l){case 192:return t++,null;case 194:return t++,!1;case 195:return t++,!0;case 196:return c=i.getUint8(t+1),t+=2,r(c);case 197:return c=i.getUint16(t+1),t+=3,r(c);case 198:return c=i.getUint32(t+1),t+=5,r(c);case 202:return a=i.getFloat32(t+1),t+=5,a;case 203:return a=i.getFloat64(t+1),t+=9,a;case 204:return a=e[t+1],t+=2,a;case 205:return a=i.getUint16(t+1),t+=3,a;case 206:return a=i.getUint32(t+1),t+=5,a;case 208:return a=i.getInt8(t+1),t+=2,a;case 209:return a=i.getInt16(t+1),t+=3,a;case 210:return a=i.getInt32(t+1),t+=5,a;case 217:return c=i.getUint8(t+1),t+=2,s(c);case 218:return c=i.getUint16(t+1),t+=3,s(c);case 219:return c=i.getUint32(t+1),t+=5,s(c);case 220:return c=i.getUint16(t+1),t+=3,o(c);case 221:return c=i.getUint32(t+1),t+=5,o(c);case 222:return c=i.getUint16(t+1),t+=3,n(c);case 223:return c=i.getUint32(t+1),t+=5,n(c)}throw new Error("Unknown type 0x"+l.toString(16))}return a()}function Lb(e,t,i,n){switch(e){case 1:return function(e,t){var i=e.length;t||(t=new Float32Array(i/4));for(var n=bb(t),r=bb(e),s=0,o=0,a=i/4;s<a;++s,o+=4)n.setFloat32(o,r.getFloat32(o),!0);return t}(t);case 2:return _b(t);case 3:return Sb(t);case 4:return Ab(t);case 5:return xb(Uint8Array,t);case 6:return Cb(Ab(t),new Uint8Array(i));case 7:return Cb(Ab(t));case 8:return Pb(Cb(Ab(t)),r);case 9:return function(e,t,i){return Mb(Cb(e,wb(i)),t,i)}(Ab(t),Ab(n)[0]);case 10:return Eb(Sb(t),Ab(n)[0]);case 11:return Mb(Sb(t),Ab(n)[0]);case 12:return Ib(Sb(t),Ab(n)[0]);case 13:return Ib(_b(t),Ab(n)[0]);case 14:return Tb(Sb(t));case 15:return Tb(_b(t))}var r}function Rb(e,t){var i=(t=t||{}).ignoreFields,n={};return yb.forEach((function(t){var r,s,o,a,c,l=!!i&&-1!==i.indexOf(t),h=e[t];l||void 0===h||(h instanceof Uint8Array?n[t]=Lb.apply(null,(s=bb(r=h),o=s.getInt32(0),a=s.getInt32(4),c=r.subarray(8,12),[o,r=r.subarray(12),a,c])):n[t]=h)})),n}const kb={0:"i".charCodeAt(0),1:"s".charCodeAt(0),2:"h".charCodeAt(0),3:"e".charCodeAt(0),4:"g".charCodeAt(0),5:"b".charCodeAt(0),6:"t".charCodeAt(0),7:"l".charCodeAt(0),"-1":"".charCodeAt(0)};hl.add("mmtf",class extends Kx{get type(){return"mmtf"}get isBinary(){return!0}_parse(){let t,i,n,r,s;e.Debug&&il.time("MmtfParser._parse "+this.name);const o=this.structure,a=Rb(Db(this.streamer.data));let c,l,h,u,d,f;if(["depositionDate","releaseDate","resolution","rFree","rWork","experimentalMethods"].forEach((function(e){void 0!==a[e]&&(o.header[e]=a[e])})),o.id=a.structureId,o.title=a.title,o.atomStore.addField("formalCharge",1,"int8"),this.firstModelOnly||this.asTrajectory){for(d=1,u=a.chainsPerModel[0],h=0,t=0,i=u;t<i;++t)h+=a.groupsPerChain[t];for(l=0,t=0,i=h;t<i;++t)s=a.groupList[a.groupTypeList[t]],l+=s.atomNameList.length;c=a.numBonds,f=[u]}else c=a.numBonds,l=a.numAtoms,h=a.numGroups,u=a.numChains,d=a.numModels,f=a.chainsPerModel;if(c+=h,this.asTrajectory)for(t=0,i=a.numModels;t<i;++t){const e=new Float32Array(3*l),i=l*t;for(n=0;n<l;++n){const t=3*n,r=n+i;e[t]=a.xCoordList[r],e[t+1]=a.yCoordList[r],e[t+2]=a.zCoordList[r]}o.frames.push(e)}const m=new Uint32Array(c),p=new Uint32Array(c),g=new Uint8Array(c),v=new Uint32Array(l),y=new Int8Array(l),x=new Uint32Array(h),b=new Uint32Array(h),_=new Uint16Array(h),w=new Uint16Array(u),S=new Uint32Array(u),A=new Uint32Array(u),M=new Uint32Array(d),C=new Uint32Array(d);let P=0;for(t=0,i=d;t<i;++t){const e=f[t];for(M[t]=P,C[t]=e,n=0;n<e;++n)w[n+P]=t;P+=e}const T=a.groupsPerChain;let I=0;for(t=0,i=u;t<i;++t){const e=T[t];for(S[t]=I,A[t]=e,n=0;n<e;++n)x[n+I]=t;I+=e}let E=0,D=0;for(t=0,i=h;t<i;++t){s=a.groupList[a.groupTypeList[t]];const e=s.atomNameList.length,i=s.formalChargeList,o=s.bondAtomList,c=s.bondOrderList;for(n=0,r=c.length;n<r;++n)m[D]=E+o[2*n],p[D]=E+o[2*n+1],g[D]=c[n],D+=1;for(b[t]=E,_[t]=e,n=0;n<e;++n)v[E]=t,y[E]=i[n],E+=1}const L=a.bondAtomList;if(L)for(a.bondOrderList&&g.set(a.bondOrderList,D),t=0,i=L.length;t<i;t+=2){const e=L[t],i=L[t+1];e<l&&i<l&&(m[D]=e,p[D]=i,D+=1)}o.bondStore.length=g.length,o.bondStore.count=D,o.bondStore.atomIndex1=m,o.bondStore.atomIndex2=p,o.bondStore.bondOrder=g,o.atomStore.length=l,o.atomStore.count=l,o.atomStore.residueIndex=v,o.atomStore.atomTypeId=new Uint16Array(l),o.atomStore.x=a.xCoordList.subarray(0,l),o.atomStore.y=a.yCoordList.subarray(0,l),o.atomStore.z=a.zCoordList.subarray(0,l),o.atomStore.serial=a.atomIdList.subarray(0,l),o.atomStore.bfactor=a.bFactorList.subarray(0,l),o.atomStore.altloc=a.altLocList.subarray(0,l),o.atomStore.occupancy=a.occupancyList.subarray(0,l),o.atomStore.formalCharge=y,o.residueStore.length=h,o.residueStore.count=h,o.residueStore.chainIndex=x,o.residueStore.residueTypeId=a.groupTypeList,o.residueStore.atomOffset=b,o.residueStore.atomCount=_,o.residueStore.resno=a.groupIdList.subarray(0,h),o.residueStore.sstruc=a.secStructList.subarray(0,h),o.residueStore.inscode=a.insCodeList.subarray(0,h),o.chainStore.length=u,o.chainStore.count=u,o.chainStore.entityIndex=new Uint16Array(u),o.chainStore.modelIndex=w,o.chainStore.residueOffset=S,o.chainStore.residueCount=A,o.chainStore.chainname=a.chainNameList.subarray(0,4*u),o.chainStore.chainid=a.chainIdList.subarray(0,4*u),o.modelStore.length=d,o.modelStore.count=d,o.modelStore.chainOffset=M,o.modelStore.chainCount=C;let R={};for(t=0,i=a.groupList.length;t<i;++t){const e=a.groupList[t],i=[];for(n=0,r=e.atomNameList.length;n<r;++n){const t=e.elementList[n].toUpperCase(),r=e.atomNameList[n];i.push(o.atomMap.add(r,t))}const s=e.chemCompType.toUpperCase(),c=sd.includes(s),l=e.bondOrderList.length,h=new Array(l),u=new Array(l);for(n=0;n<l;++n)h[n]=e.bondAtomList[2*n],u[n]=e.bondAtomList[2*n+1];const d={atomIndices1:h,atomIndices2:u,bondOrders:e.bondOrderList};R[t]=o.residueMap.add(e.groupName,i,c,s,d)}for(t=0,i=h;t<i;++t)o.residueStore.residueTypeId[t]=R[o.residueStore.residueTypeId[t]];for(t=0,i=o.atomStore.count;t<i;++t){const e=o.atomStore.residueIndex[t],i=o.residueMap.list[o.residueStore.residueTypeId[e]],n=o.residueStore.atomOffset[e];o.atomStore.atomTypeId[t]=i.atomTypeIdList[t-n]}if(a.secStructList){const e=a.secStructList.length;for(t=0,i=o.residueStore.count;t<i;++t){const i=kb[o.residueStore.sstruc[t%e]];void 0!==i&&(o.residueStore.sstruc[t]=i)}}if(a.entityList&&a.entityList.forEach((function(e,t){o.entityList[t]=new Qx(o,t,e.description,e.type,e.chainIndexList)})),a.bioAssemblyList&&a.bioAssemblyList.forEach((function(e,t){const i=t+1,n=new Qm(""+i);o.biomolDict["BU"+i]=n;let r={};e.transformList.forEach((function(e){const t=(new ri).fromArray(e.matrix).transpose(),i=e.chainIndexList.map((function(e){let t="";for(let i=0;i<4;++i){const n=a.chainNameList[4*e+i];if(!n)break;t+=String.fromCharCode(n)}return t})),s=r[i.toString()];s?s.matrixList.push(t):r[i.toString()]=n.addPart([t],i)}))})),a.ncsOperatorList){const e="NCS",t=new Qm(e),i=t.addPart();a.ncsOperatorList.forEach((function(e){const t=(new ri).fromArray(e).transpose();i.matrixList.push(t)})),i.matrixList.length>0&&(o.biomolDict[e]=t)}const k=a.unitCell;k&&Array.isArray(k)&&k[0]?o.unitcell=new eb({a:k[0],b:k[1],c:k[2],alpha:k[3],beta:k[4],gamma:k[5],spacegroup:a.spaceGroup}):o.unitcell=void 0,hp(o,!0),lp(o,!0),o.finalizeAtoms(),o.finalizeBonds(),up(o),e.Debug&&il.timeEnd("MmtfParser._parse "+this.name)}});const Ob=/\s+/,Bb={1:1,2:2,3:3,am:1,ar:1,du:1,un:1,nc:0};hl.add("mol2",class extends Kx{get type(){return"mol2"}_parse(){e.Debug&&il.time("Mol2Parser._parse "+this.name);const t=this.structure,i=this.structureBuilder,n=this.firstModelOnly,r=this.asTrajectory,s=t.frames;let o,a,c=!1;const l=t.atomMap,h=t.atomStore;h.resize(Math.round(this.streamer.data.length/60)),h.addField("partialCharge",1,"float32");let u=0,d=0,f=0,m=-1,p=0,g=0;const v=t.getAtomProxy(),y=t.getAtomProxy();this.streamer.eachChunkOfLines((function(e){!function(e,x,b){for(let _=e;_<x;++_){const e=b[_].trim();if(""!==e&&"#"!==e[0])if("@"===e[0])"@<TRIPOS>MOLECULE"===e?(g=1,d=0,++m):"@<TRIPOS>ATOM"===e?(g=2,f=h.count,r&&(a=0,o=new Float32Array(3*p),s.push(o),m>0&&(c=!0))):g="@<TRIPOS>BOND"===e?3:0;else if(1===g){if(0===d)t.title=e,t.id=e;else if(1===d){const t=e.split(Ob);p=parseInt(t[0])}++d}else if(2===g){const t=e.split(Ob);if(n&&m>0)continue;const s=parseFloat(t[2]),d=parseFloat(t[3]),f=parseFloat(t[4]);if(r){const e=3*a;if(o[e+0]=s,o[e+1]=d,o[e+2]=f,a+=1,c)continue}const p=t[0],g=t[1],v=t[5].split(".")[0],y=t[6]?parseInt(t[6]):1,x=t[7]?t[7]:"",b=t[8]?parseFloat(t[8]):0;h.growIfFull(),h.atomTypeId[u]=l.add(g,v),h.x[u]=s,h.y[u]=d,h.z[u]=f,h.serial[u]=p,h.partialCharge[u]=b,i.addAtom(m,"","",x,y,!0),u+=1}else if(3===g){if(n&&m>0)continue;if(r&&m>0)continue;const i=e.split(Ob);v.index=parseInt(i[1])-1+f,y.index=parseInt(i[2])-1+f;const s=Bb[i[3]];t.bondStore.addBond(v,y,s)}}}(0,e.length,e)})),i.finalize(),t.finalizeAtoms(),sp(t),lp(t,!0),hp(t,!0),t.finalizeBonds(),pp(t),ip(t),e.Debug&&il.timeEnd("Mol2Parser._parse "+this.name)}});hl.add("pdbqt",class extends ob{get type(){return"pdbqt"}});hl.add("pqr",class extends ob{get type(){return"pqr"}});const Nb=/> +<(.+)>/;class Fb extends Kx{get type(){return"sdf"}_parse(){e.Debug&&il.time("SdfParser._parse "+this.name);const t=this.structure,i=this.structureBuilder,n=this.firstModelOnly,r=this.asTrajectory,s=this.streamer.peekLines(2);t.id=s[0].trim(),t.title=s[1].trim();const o=t.frames;let a,c,l=!1;const h=t.atomMap,u=t.atomStore;u.resize(Math.round(this.streamer.data.length/50)),u.addField("formalCharge",1,"int8");const d=t.getAtomProxy(),f=t.getAtomProxy();let m=0,p=0,g=0,v=0;const y=[];let x,b,_,w,S,A,M,C,P,T,I,E,D,L,R=!1,k={};t.extraData.sdf=y;let O=!1,B=!1,N=!1,F=[],z=[];const U=new Map;this.streamer.eachChunkOfLines((function(e){!function(e,s,$){for(let G=e;G<s;++G){const e=$[G];if(O&&e&&(F=e.substring(7).split(" "),z.length&&(F=[...z,...F],z=[]),"-"===F[F.length-1]))F.pop(),z=F;else{if("$$$$"===e.substr(0,4))p=-1,++g,v=u.count,y.push(k),k={},R=!1,O=!1;else if(3===p)O=e.indexOf(" V3000")>-1,O?U.clear():(b=parseInt(e.substr(0,3)),_=parseInt(e.substr(3,3)),w=4,S=w+b,A=S,M=A+_,r&&(c=0,a=new Float32Array(3*b),o.push(a),g>0&&(l=!0)));else if(O&&"COUNTS"===F[0])b=parseInt(F[1]),r&&(c=0,a=new Float32Array(3*b),o.push(a),g>0&&(l=!0));else if(O&&2==F.length)"ATOM"===F[1]?"BEGIN"===F[0]?B=!0:"END"===F[0]&&(B=!1):"BOND"===F[1]&&("BEGIN"===F[0]?N=!0:"END"===F[0]&&(N=!1));else if(B||!O&&p>=w&&p<S){if(n&&g>0)continue;let t=0;if(O){if(C=parseFloat(F[2]),P=parseFloat(F[3]),T=parseFloat(F[4]),E=F[1],D=parseInt(F[0]),U.set(D,m),I=E+D,F.length>6){let e=F.slice(6).find((e=>0===e.indexOf("CHG=")));e&&(t=parseInt(e.substring(4)))}}else C=parseFloat(e.substr(0,10)),P=parseFloat(e.substr(10,10)),T=parseFloat(e.substr(20,10)),E=e.substr(31,3).trim(),I=E+(m-v+1);if(r){const e=3*c;if(a[e+0]=C,a[e+1]=P,a[e+2]=T,c+=1,l)continue}u.growIfFull(),u.atomTypeId[m]=h.add(I,E),u.x[m]=C,u.y[m]=P,u.z[m]=T,u.serial[m]=O?D:m,u.formalCharge[m]=t,i.addAtom(g,"","","HET",1,!0),m+=1}else if(N||!O&&p>=A&&p<M){if(n&&g>0)continue;if(r&&g>0)continue;O?(d.index=U.get(parseInt(F[2])),f.index=U.get(parseInt(F[3])),L=parseInt(F[1])):(d.index=parseInt(e.substr(0,3))-1+v,f.index=parseInt(e.substr(3,3))-1+v,L=parseInt(e.substr(6,3))),t.bondStore.addBond(d,f,L)}else if("M  CHG"===e.substr(0,6)){const t=parseInt(e.substr(6,3));for(let i=0,n=10;i<t;++i,n+=8){const t=parseInt(e.substr(n,3))-1+v,i=parseInt(e.substr(n+4,3));u.formalCharge[t]=i}}else">"===e.charAt(0)&&(x=e.match(Nb))?(R=x[1],k[R]=[]):!1!==R&&e&&k[R].push(e);++p}}}(0,e.length,e)})),i.finalize(),t.finalizeAtoms(),t.finalizeBonds(),pp(t),e.Debug&&il.timeEnd("SdfParser._parse "+this.name)}_postProcess(){pp(this.structure)}}hl.add("sdf",Fb),hl.add("sd",Fb),hl.add("mol",Fb);function zb(e,t,i){return parseInt(e.substr(t,i).trim())}class Ub extends Kx{get type(){return"prmtop"}_parse(){e.Debug&&il.time("PrmtopParser._parse "+this.name);const t=this.structure,i=this.structureBuilder,n=t.atomMap,r=t.atomStore;r.addField("partialCharge",1,"float32"),r.addField("radius",1,"float32");const s=[],o={},a=["NATOM","NTYPES","NBONH","MBONA","NTHETH","MTHETA","NPHIH","MPHIA","NHPARM","NPARM","NNB","NRES","NBONA","NTHETA","NPHIA","NUMBND","NUMANG","NPTRA","NATYP","NPHB","IFPERT","NBPER","NGPER","NDPER","MBPER","MGPER","MDPER","IFBOX","NMXRS","IFCAP","NUMEXTRA","NCOPY"];let c,l,h,u,d;a.forEach((e=>{o[e]=0}));let f,m,p,g,v,y=new Uint8Array(0);this.streamer.eachChunkOfLines((function(e){!function(e,t,i){for(let n=e;n<t;++n){const e=i[n],t=e.trim();if(t)if(e.startsWith("%FORMAT"));else if(e.startsWith("%FLAG")){const t=e.substr(5).trim();g=0,"TITLE"===t?p=0:"POINTERS"===t?p=1:"ATOM_NAME"===t?p=2:"CHARGE"===t?p=3:"MASS"===t?p=4:"RESIDUE_LABEL"===t?p=5:"RESIDUE_POINTER"===t?p=6:"BONDS_INC_HYDROGEN"===t?(v=0,p=7):"BONDS_WITHOUT_HYDROGEN"===t?(v=o.NBONH,p=8):p="RADII"===t?9:void 0}else if(0===p)s.push(t);else if(1===p){const t=Math.min(g+10,32);for(let i=0;g<t;++i,++g)o[a[g]]=parseInt(e.substr(8*i,8).trim());c=new Array(o.NATOM),l=new Float32Array(o.NATOM),h=new Float32Array(o.NATOM),r.resize(o.NATOM);const i=o.NBONH+o.MBONA;u=new Uint32Array(i),d=new Uint32Array(i),y=new Uint8Array(i),f=new Array(o.NRES),m=new Uint32Array(o.NRES)}else if(2===p){const t=Math.min(g+20,o.NATOM);for(let i=0;g<t;++i,++g)c[g]=e.substr(4*i,4).trim()}else if(3===p){const t=Math.min(g+5,o.NATOM);for(let i=0;g<t;++i,++g)l[g]=parseFloat(e.substr(16*i,16))/18.2223}else if(4===p);else if(5===p){const t=Math.min(g+20,o.NRES);for(let i=0;g<t;++i,++g)f[g]=e.substr(4*i,4).trim()}else if(6===p){const t=Math.min(g+10,o.NRES);for(let i=0;g<t;++i,++g)m[g]=zb(e,8*i,8)}else if(7===p){const t=Math.min(g+10,3*o.NBONH);for(let i=0;g<t;++i,++g){const t=g%3;0===t&&(u[v]=zb(e,8*i,8)/3),1===t&&(d[v]=zb(e,8*i,8)/3,y[v]=1,++v)}}else if(8===p){const t=Math.min(g+10,3*o.MBONA);for(let i=0;g<t;++i,++g){const t=g%3;0===t&&(u[v]=zb(e,8*i,8)/3),1===t&&(d[v]=zb(e,8*i,8)/3,y[v]=1,++v)}}else if(9===p){const t=Math.min(g+5,o.NATOM);for(let i=0;g<t;++i,++g)h[g]=parseFloat(e.substr(16*i,16))}}}(0,e.length,e)})),t.title=s.join(" ");const x=o.NATOM;let b=0,_=f[0],w=1;for(let e=0;e<x;++e)e+1===m[b+1]&&(++b,_=f[b],w=b+1),r.atomTypeId[e]=n.add(c[e]),r.serial[e]=e+1,i.addAtom(0,"","",_,w,!1);r.partialCharge.set(l),r.radius.set(h),t.bondStore.length=y.length,t.bondStore.count=y.length,t.bondStore.atomIndex1=u,t.bondStore.atomIndex2=d,t.bondStore.bondOrder=y,i.finalize(),t.finalizeAtoms(),t.finalizeBonds(),lp(t,!0),hp(t,!0,!0),sp(t,!0),pp(t),e.Debug&&il.timeEnd("PrmtopParser._parse "+this.name)}}hl.add("prmtop",Ub),hl.add("parm7",Ub);const $b=/\s+/,Gb=/(^\*|REMARK)*/;hl.add("psf",class extends Kx{get type(){return"psf"}_parse(){e.Debug&&il.time("PsfParser._parse "+this.name);const t=this.structure,i=this.structureBuilder,n=t.atomMap,r=t.atomStore;r.addField("partialCharge",1,"float32");const s=[];let o,a,c,l,h,u,d=0,f=0,m=0;this.streamer.eachChunkOfLines((function(e){!function(e,t,p){for(let g=e;g<t;++g){const e=p[g].trim();if(e)if(2===o){const t=e.split($b),s=parseInt(t[0]),o=t[1],l=parseInt(t[2]),h=t[3],u=t[4],m=parseFloat(t[6]);o!==c&&(a=rp(f),++f),r.growIfFull(),r.atomTypeId[d]=n.add(u),r.serial[d]=s,r.partialCharge[d]=m,i.addAtom(0,a,a,h,l,!1),d+=1,c=o}else if(3===o){const t=e.split($b);for(let e=0,i=t.length;e<i;e+=2)l[m]=parseInt(t[e])-1,h[m]=parseInt(t[e+1])-1,u[m]=1,m+=1}else if(1===o)s.push(e.replace(Gb,"").trim());else if(4===o);else if(5===o);else if(6===o);else if(e.includes("!NATOM")){o=2;const t=parseInt(e.split($b)[0]);r.resize(t)}else if(e.includes("!NBOND")){o=3;const t=parseInt(e.split($b)[0]);l=new Uint32Array(t),h=new Uint32Array(t),u=new Uint8Array(t)}else e.includes("!NTITLE")?o=1:e.includes("!NTHETA")?o=4:e.includes("!NPHI")?o=5:e.includes("!NIMPHI")&&(o=6);else o=void 0}}(0,e.length,e)})),t.title=s.join(" "),t.bondStore.length=u.length,t.bondStore.count=m,t.bondStore.atomIndex1=l,t.bondStore.atomIndex2=h,t.bondStore.bondOrder=u,i.finalize(),t.finalizeAtoms(),t.finalizeBonds(),lp(t,!0),hp(t,!0,!0),pp(t),e.Debug&&il.timeEnd("PsfParser._parse "+this.name)}});const Vb=/\[ (.+) \]/,Hb=/\s+/;hl.add("top",class extends Kx{get type(){return"top"}_parse(){e.Debug&&il.time("TopParser._parse "+this.name);const t=this.structure,i=this.structureBuilder,n=t.atomMap,r=t.bondStore,s=t.atomStore;s.addField("partialCharge",1,"float32");const o=[],a={};let c,l;this.streamer.eachChunkOfLines((function(e){!function(e,i,n){for(let r=e;r<i;++r){const e=n[r];let i=e.trim();if(!i||"*"===i[0]||";"===i[0])continue;if(i.startsWith("#include"))throw new Error("TopParser: #include statements not allowed");const s=e.match(Vb);if(null!==s){const e=s[1];"moleculetype"===e?(l=2,c={atoms:[],bonds:[]}):l="atoms"===e?3:"bonds"===e?4:"system"===e?0:"molecules"===e?1:void 0;continue}const h=i.indexOf(";");if(-1!==h&&(i=i.substring(0,h).trim()),2===l){const e=i.split(Hb)[0];a[e]=c}else if(3===l){const e=i.split(Hb);c.atoms.push([parseInt(e[2]),e[3],e[4],parseFloat(e[6])])}else if(4===l){const e=i.split(Hb);c.bonds.push([parseInt(e[0]),parseInt(e[1])])}else if(0===l)t.title=i;else if(1===l){const e=i.split(Hb);o.push([e[0],parseInt(e[1])])}}}(0,e.length,e)}));let h=0,u=0;o.forEach((function(e){const[t,i]=e,n=a[t];h+=i*n.atoms.length,u+=i*n.bonds.length})),s.resize(h),r.resize(u);let d,f=0,m=0,p=0,g=0,v=0,y=0;o.forEach((function(e){const[t,o]=e,c=a[t],l=rp(g);for(let e=0;e<o;++e){d=-1;const e=wd.includes(t)?l:rp(p);c.atoms.forEach((function(t){const[r,o,a,c]=t;r!==d&&++m,s.atomTypeId[f]=n.add(a),s.serial[f]=f+1,s.partialCharge[f]=c,i.addAtom(0,l,e,o,m+1,!1),++f,d=r})),c.bonds.forEach((function(e){r.atomIndex1[v]=y+e[0]-1,r.atomIndex2[v]=y+e[1]-1,++v})),++p,y+=c.atoms.length}++g})),r.count=u,i.finalize(),t.finalizeAtoms(),t.finalizeBonds(),lp(t,!0),hp(t,!0,!0),pp(t),e.Debug&&il.timeEnd("TopParser._parse "+this.name)}});class jb extends Zx{constructor(e,t){super(e,t),this.frames=new Pg(this.name,this.path)}get type(){return"trajectory"}get __objName(){return"frames"}}function Wb(e,t){if(e)throw new TypeError("Not a valid NetCDF v3.x file: "+t)}function qb(e){e.offset%4!=0&&e.skip(4-e.offset%4)}function Xb(e){const t=e.readUint32(),i=e.readChars(t);return qb(e),i}hl.add("dcd",class extends jb{get type(){return"dcd"}get isBinary(){return!0}_parse(){e.Debug&&il.time("DcdParser._parse "+this.name);const t=Va(this.streamer.data),i=new DataView(t),n=this.frames,r=n.coordinates,s=n.boxes,o={};let a=0;const c=new Int32Array(t,0,23),l=c[0]!==i.getInt32(0);if(84!==c[0]){const e=t.byteLength;for(let t=0;t<e;t+=4)i.setFloat32(t,i.getFloat32(t),!0)}84!==c[0]&&il.error("dcd bad format, header block start");"CORD"!==String.fromCharCode(i.getUint8(4),i.getUint8(5),i.getUint8(6),i.getUint8(7))&&il.error("dcd bad format, format string");let h=!1,u=!1,d=!1;0!==c[22]&&(h=!0,0!==c[12]&&(u=!0),1===c[13]&&(d=!0)),o.NSET=c[2],o.ISTART=c[3],o.NSAVC=c[4],o.NAMNF=c[10],o.DELTA=h?i.getFloat32(44,l):i.getFloat64(44,l),84!==c[22]&&il.error("dcd bad format, header block end"),a=a+84+8;const f=i.getInt32(a,l),m=a+1;if((f-4)%80!=0&&il.error("dcd bad format, title block start"),o.TITLE=Ua(new Uint8Array(t,m,f)),i.getInt32(m+f+4-1,l)!==f&&il.error("dcd bad format, title block end"),a=a+f+8,4!==i.getInt32(a,l)&&il.error("dcd bad format, natom block start"),o.NATOM=i.getInt32(a+4,l),4!==i.getInt32(a+8,l)&&il.error("dcd bad format, natom block end"),a=a+4+8,o.NAMNF>0)return void il.error("dcd format with fixed atoms unsupported, aborting");const p=o.NATOM,g=4*p;for(let e=0,n=o.NSET;e<n;++e){if(u){a+=4;const e=new Float32Array(9);e[0]=i.getFloat64(a,l),e[4]=i.getFloat64(a+16,l),e[8]=i.getFloat64(a+40,l),s.push(e),a+=48,a+=4}const n=new Float32Array(3*p);for(let r=0;r<3;++r){i.getInt32(a,l)!==g&&il.error("dcd bad format, coord block start",e,r),a+=4;const s=new Float32Array(t,a,p);for(let e=0;e<p;++e)n[3*e+r]=s[e];a+=g,i.getInt32(a,l)!==g&&il.error("dcd bad format, coord block end",e,r),a+=4}if(r.push(n),d){a+=4+i.getInt32(a,l)+4}}o.DELTA&&(n.deltaTime=20.45482949774598*o.DELTA),o.ISTART>=1&&(n.timeOffset=(o.ISTART-1)*n.deltaTime),e.Debug&&il.timeEnd("DcdParser._parse "+this.name)}});const Yb={BYTE:1,CHAR:2,SHORT:3,INT:4,FLOAT:5,DOUBLE:6};function Zb(e){switch(Number(e)){case Yb.BYTE:return"byte";case Yb.CHAR:return"char";case Yb.SHORT:return"short";case Yb.INT:return"int";case Yb.FLOAT:return"float";case Yb.DOUBLE:return"double";default:return"undefined"}}function Kb(e){switch(Number(e)){case Yb.BYTE:case Yb.CHAR:return 1;case Yb.SHORT:return 2;case Yb.INT:case Yb.FLOAT:return 4;case Yb.DOUBLE:return 8;default:return-1}}function Qb(e){switch(String(e)){case"byte":return Yb.BYTE;case"char":return Yb.CHAR;case"short":return Yb.SHORT;case"int":return Yb.INT;case"float":return Yb.FLOAT;case"double":return Yb.DOUBLE;default:return-1}}function Jb(e,t){if(1!==e){const i=new Array(e);for(let n=0;n<e;n++)i[n]=t();return i}return t()}function e_(e,t,i){switch(t){case Yb.BYTE:return e.readBytes(i);case Yb.CHAR:return function(e){if(0===e.charCodeAt(e.length-1))return e.substring(0,e.length-1);return e}(e.readChars(i));case Yb.SHORT:return Jb(i,e.readInt16.bind(e));case Yb.INT:return Jb(i,e.readInt32.bind(e));case Yb.FLOAT:return Jb(i,e.readFloat32.bind(e));case Yb.DOUBLE:return Jb(i,e.readFloat64.bind(e));default:return void Wb(!0,"non valid type "+t)}}const t_=0,i_=10,n_=11,r_=12;function s_(e,t){const i={recordDimension:{length:e.readUint32()}};i.version=t;const n=function(e){let t,i,n;const r=e.readUint32();if(r===t_)return Wb(e.readUint32()!==t_,"wrong empty tag for list of dimensions"),[];{Wb(r!==i_,"wrong tag for list of dimensions");const s=e.readUint32();t=new Array(s);for(let r=0;r<s;r++){const s=Xb(e),o=e.readUint32();0===o&&(i=r,n=s),t[r]={name:s,size:o}}return{dimensions:t,recordId:i,recordName:n}}}(e);i.recordDimension.id=n.recordId,i.recordDimension.name=n.recordName,i.dimensions=n.dimensions,i.globalAttributes=o_(e);const r=function(e,t,i){const n=e.readUint32();let r,s=0;if(n===t_)return Wb(e.readUint32()!==t_,"wrong empty tag for list of variables"),[];{Wb(n!==n_,"wrong tag for list of variables");const o=e.readUint32();r=new Array(o);for(let n=0;n<o;n++){const o=Xb(e),a=e.readUint32(),c=new Array(a);for(let t=0;t<a;t++)c[t]=e.readUint32();const l=o_(e),h=e.readUint32();Wb(h<1&&h>6,"non valid type "+h);const u=e.readUint32();let d=e.readUint32();2===i&&(Wb(d>0,"offsets larger than 4GB not supported"),d=e.readUint32()),c[0]===t&&(s+=u),r[n]={name:o,dimensions:c,attributes:l,type:Zb(h),size:u,offset:d,record:c[0]===t}}}return{variables:r,recordStep:s}}(e,n.recordId,t);return i.variables=r.variables,i.recordDimension.recordStep=r.recordStep,i}function o_(e){let t;const i=e.readUint32();if(i===t_)return Wb(e.readUint32()!==t_,"wrong empty tag for list of attributes"),[];{Wb(i!==r_,"wrong tag for list of attributes");const n=e.readUint32();t=new Array(n);for(let i=0;i<n;i++){const n=Xb(e),r=e.readUint32();Wb(r<1||r>6,"non valid type "+r);const s=e.readUint32(),o=e_(e,r,s);qb(e),t[i]={name:n,type:Zb(r),value:o}}}return t}class a_{constructor(e){const t=new Il(e);t.setBigEndian(),Wb("CDF"!==t.readChars(3),"should start with CDF");const i=t.readByte();Wb(i>2,"unknown version"),this.header=s_(t,i),this.buffer=t}get version(){return 1===this.header.version?"classic format":"64-bit offset format"}get recordDimension(){return this.header.recordDimension}get dimensions(){return this.header.dimensions}get globalAttributes(){return this.header.globalAttributes}get variables(){return this.header.variables}hasDataVariable(e){return-1!==this.header.variables.findIndex((function(t){return t.name===e}))}getDataVariable(e){let t;return t="string"==typeof e?this.header.variables.find((function(t){return t.name===e})):e,Wb(void 0===t,"variable not found"),this.buffer.seek(t.offset),t.record?function(e,t,i){const n=Qb(t.type),r=t.size?t.size/Kb(n):1,s=i.length,o=new Array(s),a=i.recordStep;for(let t=0;t<s;t++){const i=e.offset;o[t]=e_(e,n,r),e.seek(i+a)}return o}(this.buffer,t,this.header.recordDimension):function(e,t){const i=Qb(t.type),n=t.size/Kb(i),r=new Array(n);for(let t=0;t<n;t++)r[t]=e_(e,i,1);return r}(this.buffer,t)}}class c_ extends jb{get type(){return"nctraj"}get isBinary(){return!0}_parse(){e.Debug&&il.time("NctrajParser._parse "+this.name);const t=new a_(this.streamer.data),i=this.frames,n=i.coordinates,r=i.boxes,s=i.times;t.getDataVariable("coordinates").forEach((function(e){n.push(new Float32Array(e))})),t.hasDataVariable("cell_lengths")&&t.getDataVariable("cell_lengths").forEach((function(e){r.push(new Float32Array(e))})),t.hasDataVariable("time")&&t.getDataVariable("time").forEach((function(e){s.push(e)})),s.length>=1&&(i.timeOffset=s[0]),s.length>=2&&(i.deltaTime=s[1]-s[0]),e.Debug&&il.timeEnd("NctrajParser._parse "+this.name)}}hl.add("nctraj",c_),hl.add("ncdf",c_),hl.add("nc",c_);hl.add("trr",class extends jb{get type(){return"trr"}get isBinary(){return!0}_parse(){e.Debug&&il.time("TrrParser._parse "+this.name);const t=Va(this.streamer.data),i=new DataView(t),n=this.frames,r=n.coordinates,s=n.boxes,o=n.times;let a=0;for(;;){a+=8;const e=i.getInt32(a);a+=4,a+=e;const n=i.getInt32(a+8),c=i.getInt32(a+12),l=i.getInt32(a+16),h=i.getInt32(a+28),u=i.getInt32(a+32),d=i.getInt32(a+36),f=i.getInt32(a+40);a+=52;const m=n/9,p=3*f;if(8===m?o.push(i.getFloat64(a)):o.push(i.getFloat32(a)),a+=2*m,n){const e=new Float32Array(9);if(8===m)for(let t=0;t<9;++t)e[t]=10*i.getFloat64(a),a+=8;else for(let t=0;t<9;++t)e[t]=10*i.getFloat32(a),a+=4;s.push(e)}if(a+=c,a+=l,h){let e;if(8===m){e=new Float32Array(p);for(let t=0;t<p;++t)e[t]=10*i.getFloat64(a),a+=8}else{const i=new Uint32Array(t,a,p);for(let e=0;e<p;++e){const t=i[e];i[e]=(255&t)<<24|(65280&t)<<8|t>>8&65280|t>>24&255}e=new Float32Array(t,a,p);for(let t=0;t<p;++t)e[t]*=10,a+=4}r.push(e)}if(a+=u,a+=d,a>=t.byteLength)break}o.length>=1&&(n.timeOffset=o[0]),o.length>=2&&(n.deltaTime=o[1]-o[0]),e.Debug&&il.timeEnd("TrrParser._parse "+this.name)}});const l_=new Uint32Array([0,0,0,0,0,0,0,0,0,8,10,12,16,20,25,32,40,50,64,80,101,128,161,203,256,322,406,512,645,812,1024,1290,1625,2048,2580,3250,4096,5060,6501,8192,10321,13003,16384,20642,26007,32768,41285,52015,65536,82570,104031,131072,165140,208063,262144,330280,416127,524287,660561,832255,1048576,1321122,1664510,2097152,2642245,3329021,4194304,5284491,6658042,8388607,10568983,13316085,16777216]);function h_(e){let t=1,i=0;for(;e>=t&&i<32;)i++,t<<=1;return i}const u_=new Uint8Array(32);function d_(e,t){let i=1,n=0;u_[0]=1;for(let n=0;n<e;n++){let e,r=0;for(e=0;e<i;e++)r+=u_[e]*t[n],u_[e]=255&r,r>>=8;for(;0!==r;)u_[e++]=255&r,r>>=8;i=e}let r=1;for(i--;u_[i]>=r;)n++,r*=2;return n+8*i}function f_(e,t,i,n){const r=(1<<i)-1;let s=n[1],o=n[2],a=e[0],c=0;for(;i>=8;)o=o<<8|t[a++],c|=o>>s<<i-8,i-=8;return i>0&&(s<i&&(s+=8,o=o<<8|t[a++]),s-=i,c|=o>>s&(1<<i)-1),c&=r,e[0]=a,e[1]=s,e[2]=o,c}const m_=new Int32Array(32);function p_(e,t,i,n,r,s,o){let a=0;for(m_[1]=0,m_[2]=0,m_[3]=0;n>8;)m_[a++]=f_(e,t,8,o),n-=8;n>0&&(m_[a++]=f_(e,t,n,o));for(let e=i-1;e>0;e--){let t=0;for(let i=a-1;i>=0;i--){t=t<<8|m_[i];const n=t/r[e]|0;m_[i]=n,t-=n*r[e]}s[e]=t}s[0]=m_[0]|m_[1]<<8|m_[2]<<16|m_[3]<<24}hl.add("xtc",class extends jb{get type(){return"xtc"}get isBinary(){return!0}_parse(){e.Debug&&il.time("XtcParser._parse "+this.name);const t=Va(this.streamer.data),i=new DataView(t),n=this.frames,r=n.coordinates,s=n.boxes,o=n.times,a=new Int32Array(6),c=new Int32Array(3),l=new Int32Array(3),h=new Uint32Array(3),u=new Float32Array(3),d=new Float32Array(3);let f=0;const m=new Int32Array(3),p=new Uint32Array(m.buffer);for(;;){let e;const n=i.getInt32(f+4);f+=12;const g=3*n;o.push(i.getFloat32(f)),f+=4;const v=new Float32Array(9);for(let e=0;e<9;++e)v[e]=10*i.getFloat32(f),f+=4;if(s.push(v),n<=9){e=new Float32Array(n);for(let t=0;t<n;++t)e[t]=i.getFloat32(f),f+=4}else{m[0]=m[1]=m[2]=0,c[0]=c[1]=c[2]=0,h[0]=h[1]=h[2]=0,l[0]=l[1]=l[2]=0,u[0]=u[1]=u[2]=0,d[0]=d[1]=d[2]=0,e=new Float32Array(g);let n=0;const r=i.getInt32(f);f+=4;const s=i.getFloat32(f);let o;f+=4,a[0]=i.getInt32(f),a[1]=i.getInt32(f+4),a[2]=i.getInt32(f+8),a[3]=i.getInt32(f+12),a[4]=i.getInt32(f+16),a[5]=i.getInt32(f+20),c[0]=a[3]-a[0]+1,c[1]=a[4]-a[1]+1,c[2]=a[5]-a[2]+1,f+=24,(c[0]|c[1]|c[2])>16777215?(l[0]=h_(c[0]),l[1]=h_(c[1]),l[2]=h_(c[2]),o=0):o=d_(3,c);let v=i.getInt32(f);f+=4;let y=v-1;y=9>y?9:y;let x=l_[y]/2|0,b=l_[v]/2|0;h[0]=h[1]=h[2]=l_[v];let _=4*Math.ceil(i.getInt32(f)/4);f+=4;const w=1/s;let S=0,A=0;const M=new Uint8Array(t,f);for(u[0]=u[1]=u[2]=0;A<r;){0===o?(u[0]=f_(m,M,l[0],p),u[1]=f_(m,M,l[1],p),u[2]=f_(m,M,l[2],p)):p_(m,M,3,o,c,u,p),A++,u[0]+=a[0],u[1]+=a[1],u[2]+=a[2],d[0]=u[0],d[1]=u[1],d[2]=u[2];let t=0;if(1===f_(m,M,1,p)&&(S=f_(m,M,5,p),t=S%3,S-=t,t--),S>0){u[0]=u[1]=u[2]=0;for(let t=0;t<S;t+=3){if(p_(m,M,3,v,h,u,p),A++,u[0]+=d[0]-b,u[1]+=d[1]-b,u[2]+=d[2]-b,0===t){let t=u[0];u[0]=d[0],d[0]=t,t=u[1],u[1]=d[1],d[1]=t,t=u[2],u[2]=d[2],d[2]=t,e[n++]=d[0]*w,e[n++]=d[1]*w,e[n++]=d[2]*w}else d[0]=u[0],d[1]=u[1],d[2]=u[2];e[n++]=u[0]*w,e[n++]=u[1]*w,e[n++]=u[2]*w}}else e[n++]=u[0]*w,e[n++]=u[1]*w,e[n++]=u[2]*w;if(v+=t,t<0?(b=x,x=v>9?l_[v-1]/2|0:0):t>0&&(x=b,b=l_[v]/2|0),h[0]=h[1]=h[2]=l_[v],0===h[0]||0===h[1]||0===h[2])return void console.error("(xdrfile error) Undefined error.")}f+=_}for(let t=0;t<g;t++)e[t]*=10;if(r.push(e),f>=t.byteLength)break}o.length>=1&&(n.timeOffset=o[0]),o.length>=2&&(n.deltaTime=o[1]-o[0]),e.Debug&&il.timeEnd("XtcParser._parse "+this.name)}});class g_ extends Zx{constructor(e,t){const i=t||{};super(e,i),this.volume=new Zf(this.name,this.path),this.voxelSize=Ia(i.voxelSize,1)}get type(){return"volume"}get __objName(){return"volume"}_afterParse(){this.volume.setMatrix(this.getMatrix()),super._afterParse()}getMatrix(){return new ri}}const v_=/\s+/,y_=/-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?/g,x_=.529177210859;class b_ extends g_{get type(){return"cube"}_parse(){e.Debug&&il.time("CubeParser._parse "+this.name);const t=this.volume,i=this.streamer.peekLines(6),n={},r=x_*this.voxelSize;function s(e,t){var n=i[e].trim().split(v_)[t];return parseFloat(n)}n.atomCount=Math.abs(s(2,0)),n.originX=s(2,1)*x_,n.originY=s(2,2)*x_,n.originZ=s(2,3)*x_,n.NVX=s(3,0),n.NVY=s(4,0),n.NVZ=s(5,0),n.basisX=new Zt(s(3,1),s(3,2),s(3,3)).multiplyScalar(r),n.basisY=new Zt(s(4,1),s(4,2),s(4,3)).multiplyScalar(r),n.basisZ=new Zt(s(5,1),s(5,2),s(5,3)).multiplyScalar(r);const o=new Float32Array(n.NVX*n.NVY*n.NVZ);let a=0,c=0;const l=s(2,0)>0?0:1;this.streamer.eachChunkOfLines((function(e){!function(e,t,i){for(let r=e;r<t;++r){const e=i[r].trim();if(""!==e&&c>=n.atomCount+6+l){const t=e.match(y_);for(let e=0,i=t.length;e<i;++e)o[a]=parseFloat(t[e]),++a}++c}}(0,e.length,e)})),t.header=n,t.setData(o,n.NVZ,n.NVY,n.NVX),e.Debug&&il.timeEnd("CubeParser._parse "+this.name)}getMatrix(){const e=this.volume.header,t=new ri;return t.multiply((new ri).makeTranslation(e.originX,e.originY,e.originZ)),t.multiply((new ri).makeBasis(e.basisZ,e.basisY,e.basisX)),t}}hl.add("cub",b_),hl.add("cube",b_);class __ extends g_{get type(){return"dsn6"}get isBinary(){return!0}_parse(){e.Debug&&il.time("Dsn6Parser._parse "+this.name);const t=this.volume,i={};let n,r;const s=Va(this.streamer.data),o=new Int16Array(s),a=new Uint8Array(s),c=String.fromCharCode.apply(null,a.subarray(0,512));if(c.startsWith(":-)"))i.xStart=parseInt(c.substr(10,5)),i.yStart=parseInt(c.substr(15,5)),i.zStart=parseInt(c.substr(20,5)),i.xExtent=parseInt(c.substr(32,5)),i.yExtent=parseInt(c.substr(38,5)),i.zExtent=parseInt(c.substr(42,5)),i.xRate=parseInt(c.substr(52,5)),i.yRate=parseInt(c.substr(58,5)),i.zRate=parseInt(c.substr(62,5)),i.xlen=parseFloat(c.substr(73,10))*this.voxelSize,i.ylen=parseFloat(c.substr(83,10))*this.voxelSize,i.zlen=parseFloat(c.substr(93,10))*this.voxelSize,i.alpha=parseFloat(c.substr(103,10)),i.beta=parseFloat(c.substr(113,10)),i.gamma=parseFloat(c.substr(123,10)),n=parseFloat(c.substr(138,12))/100,r=parseInt(c.substr(155,8)),i.sigma=100*parseFloat(c.substr(170,12));else{if(100!==o[18])for(let e=0,t=o.length;e<t;++e){const t=o[e];o[e]=(255&t)<<8|t>>8&255}i.xStart=o[0],i.yStart=o[1],i.zStart=o[2],i.xExtent=o[3],i.yExtent=o[4],i.zExtent=o[5],i.xRate=o[6],i.yRate=o[7],i.zRate=o[8];const e=1/o[17],t=e*this.voxelSize;i.xlen=o[9]*t,i.ylen=o[10]*t,i.zlen=o[11]*t,i.alpha=o[12]*e,i.beta=o[13]*e,i.gamma=o[14]*e,n=o[15]/100,r=o[16],i.gamma=o[14]*e}t.header=i,e.Debug&&il.log(i,n,r);const l=new Float32Array(i.xExtent*i.yExtent*i.zExtent);let h=512;const u=Math.ceil(i.xExtent/8),d=Math.ceil(i.yExtent/8),f=Math.ceil(i.zExtent/8);for(var m=0;m<f;++m)for(var p=0;p<d;++p)for(var g=0;g<u;++g)for(var v=0;v<8;++v)for(var y=8*m+v,x=0;x<8;++x)for(var b=8*p+x,_=0;_<8;++_){var w=8*g+_;if(!(w<i.xExtent&&b<i.yExtent&&y<i.zExtent)){h+=8-_;break}l[(w*i.yExtent+b)*i.zExtent+y]=(a[h]-r)/n,++h}t.setData(l,i.zExtent,i.yExtent,i.xExtent),i.sigma&&t.setStats(void 0,void 0,void 0,i.sigma),e.Debug&&il.timeEnd("Dsn6Parser._parse "+this.name)}getMatrix(){const e=this.volume.header,t=[e.xlen,0,0],i=[e.ylen*Math.cos(Math.PI/180*e.gamma),e.ylen*Math.sin(Math.PI/180*e.gamma),0],n=[e.zlen*Math.cos(Math.PI/180*e.beta),e.zlen*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];n[2]=Math.sqrt(e.zlen*e.zlen*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-n[1]*n[1]);const r=[[],t,i,n],s=[0,e.xRate,e.yRate,e.zRate],o=[0,1,2,3],a=new ri;return a.set(r[o[1]][0]/s[o[1]],r[o[2]][0]/s[o[2]],r[o[3]][0]/s[o[3]],0,r[o[1]][1]/s[o[1]],r[o[2]][1]/s[o[2]],r[o[3]][1]/s[o[3]],0,r[o[1]][2]/s[o[1]],r[o[2]][2]/s[o[2]],r[o[3]][2]/s[o[3]],0,0,0,0,1),a.multiply((new ri).makeRotationY(Ka(90))),a.multiply((new ri).makeTranslation(-e.zStart,e.yStart,e.xStart)),a.multiply((new ri).makeScale(-1,1,1)),a}}hl.add("dsn6",__),hl.add("brix",__);const w_=/\s+/;class S_ extends g_{get type(){return"dx"}_parse(){e.Debug&&il.time("DxParser._parse "+this.name);const t=this.volume,i=this.streamer.peekLines(30),n=this.parseHeaderLines(i),r=this.volume.header,s=n.dataLineStart,o=r.nx*r.ny*r.nz,a=new Float32Array(o);let c=0,l=0;this.streamer.eachChunkOfLines((function(e){!function(e,t,i){for(let n=e;n<t;++n){if(c<o&&l>s){const e=i[n].trim();if(""!==e){const t=e.split(w_);for(let e=0,i=t.length;e<i;++e)a[c]=parseFloat(t[e]),++c}}++l}}(0,e.length,e)})),t.setData(a,r.nz,r.ny,r.nx),e.Debug&&il.timeEnd("DxParser._parse "+this.name)}parseHeaderLines(e){const t={},i=e.length;let n=0,r=0,s=0;for(let o=0;o<i;++o){let i;const a=e[o];if(a.startsWith("object 1"))i=a.split(w_),t.nx=parseInt(i[5]),t.ny=parseInt(i[6]),t.nz=parseInt(i[7]);else if(a.startsWith("origin"))i=a.split(w_),t.xmin=parseFloat(i[1]),t.ymin=parseFloat(i[2]),t.zmin=parseFloat(i[3]);else if(a.startsWith("delta"))i=a.split(w_),0===s?t.hx=parseFloat(i[1])*this.voxelSize:1===s?t.hy=parseFloat(i[2])*this.voxelSize:2===s&&(t.hz=parseFloat(i[3])*this.voxelSize),s+=1;else if(a.startsWith("object 3")){n=o,r+=a.length+1;break}r+=a.length+1}return this.volume.header=t,{dataLineStart:n,headerByteCount:r}}getMatrix(){const e=this.volume.header,t=new ri;return t.multiply((new ri).makeRotationY(Ka(90))),t.multiply((new ri).makeTranslation(-e.zmin,e.ymin,e.xmin)),t.multiply((new ri).makeScale(-e.hz,e.hy,e.hx)),t}}hl.add("dx",S_);hl.add("dxbin",class extends S_{get type(){return"dxbin"}get isBinary(){return!0}_parse(){e.Debug&&il.time("DxbinParser._parse "+this.name);const t=Va(this.streamer.data),i=function(e,t=10485760,i="\n"){let n="",r=[];for(let s=0;s<e.length;s+=t){const o=Ua(e.subarray(s,s+t)),a=o.lastIndexOf(i);if(-1===a)n+=o;else{const e=n+o.substr(0,a);r=r.concat(e.split(i)),n=a===o.length-i.length?"":o.substr(a+i.length)}}return""!==n&&r.push(n),r}(new Uint8Array(t,0,1e3)),n=this.parseHeaderLines(i),r=this.volume.header,s=n.headerByteCount,o=r.nx*r.ny*r.nz,a=new DataView(t),c=new Float32Array(o);for(let e=0;e<o;++e)c[e]=a.getFloat64(8*e+s,!0);this.volume.setData(c,r.nz,r.ny,r.nx),e.Debug&&il.timeEnd("DxbinParser._parse "+this.name)}});class A_ extends g_{get type(){return"mrc"}get isBinary(){return!0}_parse(){e.Debug&&il.time("MrcParser._parse "+this.name);const t=this.volume,i={},n=Va(this.streamer.data),r=new Int32Array(n,0,56),s=new Float32Array(n,0,56),o=new DataView(n);if(i.MAP=String.fromCharCode(o.getUint8(208),o.getUint8(209),o.getUint8(210),o.getUint8(211)),i.MACHST=[o.getUint8(212),o.getUint8(213)],17===i.MACHST[0]&&17===i.MACHST[1]){const e=n.byteLength;for(let t=0;t<e;t+=4)o.setFloat32(t,o.getFloat32(t),!0)}let a;if(i.NX=r[0],i.NY=r[1],i.NZ=r[2],i.MODE=r[3],i.NXSTART=r[4],i.NYSTART=r[5],i.NZSTART=r[6],i.MX=r[7],i.MY=r[8],i.MZ=r[9],i.xlen=s[10]*this.voxelSize,i.ylen=s[11]*this.voxelSize,i.zlen=s[12]*this.voxelSize,i.alpha=s[13],i.beta=s[14],i.gamma=s[15],i.MAPC=r[16],i.MAPR=r[17],i.MAPS=r[18],i.DMIN=s[19],i.DMAX=s[20],i.DMEAN=s[21],i.ISPG=r[22],i.NSYMBT=r[23],i.LSKFLG=r[24],i.originX=s[49],i.originY=s[50],i.originZ=s[51],i.ARMS=s[54],t.header=i,2===i.MODE)a=new Float32Array(n,1024+i.NSYMBT,i.NX*i.NY*i.NZ);else if(0===i.MODE){if(a=new Float32Array(new Int8Array(n,1024+i.NSYMBT,i.NX*i.NY*i.NZ)),-128===r[39]&&127===r[40]){const e=(i.DMAX-i.DMIN)/255,t=.5*(i.DMIN+i.DMAX+e);for(let i=0,n=a.length;i<n;++i)a[i]=e*a[i]+t}}else il.error("MrcParser unknown mode",i.MODE);t.setData(a,i.NX,i.NY,i.NZ),0!==i.ARMS&&t.setStats(i.DMIN,i.DMAX,i.DMEAN,i.ARMS),e.Debug&&il.timeEnd("MrcParser._parse "+this.name)}getMatrix(){const e=this.volume.header,t=[e.xlen,0,0],i=[e.ylen*Math.cos(Math.PI/180*e.gamma),e.ylen*Math.sin(Math.PI/180*e.gamma),0],n=[e.zlen*Math.cos(Math.PI/180*e.beta),e.zlen*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];n[2]=Math.sqrt(e.zlen*e.zlen*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-n[1]*n[1]);const r=[[],t,i,n],s=[0,e.MX,e.MY,e.MZ],o=[0,e.MAPC,e.MAPR,e.MAPS],a=new ri;return a.set(r[o[1]][0]/s[o[1]],r[o[2]][0]/s[o[2]],r[o[3]][0]/s[o[3]],0,r[o[1]][1]/s[o[1]],r[o[2]][1]/s[o[2]],r[o[3]][1]/s[o[3]],0,r[o[1]][2]/s[o[1]],r[o[2]][2]/s[o[2]],r[o[3]][2]/s[o[3]],0,0,0,0,1),a.setPosition(new Zt(e.originX,e.originY,e.originZ)),a.multiply((new ri).makeTranslation(e.NXSTART,e.NYSTART,e.NZSTART)),a}}hl.add("mrc",A_),hl.add("ccp4",A_),hl.add("map",A_);const M_=/\s+/;function C_(e){return e.trim().split(M_).map(parseFloat)}class P_ extends g_{get type(){return"xplor"}_parse(){e.Debug&&il.time("XplorParser._parse "+this.name);const t=this.volume,i=this.streamer.peekLines(8),n={};let r;r=i[2].startsWith("REMARKS")?parseInt(i[1].substring(0,8))+2:5;const s=r+3,o=C_(i[r]);n.NA=o[0],n.AMIN=o[1],n.AMAX=o[2],n.NB=o[3],n.BMIN=o[4],n.BMAX=o[5],n.NC=o[6],n.CMIN=o[7],n.CMAX=o[8];const a=C_(i[r+1]);n.a=a[0]*this.voxelSize,n.b=a[1]*this.voxelSize,n.c=a[2]*this.voxelSize,n.alpha=a[3],n.beta=a[4],n.gamma=a[5];const c=n.AMAX-n.AMIN+1,l=n.BMAX-n.BMIN+1,h=n.CMAX-n.CMIN+1,u=c*l*h,d=new Float32Array(u),f=Math.ceil(1+c*l/6);let m=0,p=0;this.streamer.eachChunkOfLines((function(e){!function(e,t,i){for(let r=e;r<t;++r){const e=i[r];if(p>=s&&(p-s)%f!=0&&m<u)for(let t=0,i=6;t<i;++t){const i=parseFloat(e.substr(12*t,12));if(isNaN(i))break;d[m++]=i}else if(m===u){const t=e.trim();if(t&&"-9999"!==t){const t=C_(e);n.RAVE=t[0],n.RSIGMA=t[1]}}++p}}(0,e.length,e)})),t.header=n,t.setData(d,c,l,h),0!==n.RAVE&&1!==n.RSIGMA&&t.setStats(void 0,void 0,n.RAVE,n.RSIGMA),e.Debug&&il.timeEnd("XplorParser._parse "+this.name)}getMatrix(){const e=this.volume.header,t=[e.a,0,0],i=[e.b*Math.cos(Math.PI/180*e.gamma),e.b*Math.sin(Math.PI/180*e.gamma),0],n=[e.c*Math.cos(Math.PI/180*e.beta),e.c*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];n[2]=Math.sqrt(e.c*e.c*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-n[1]*n[1]);const r=[[],t,i,n],s=[0,e.NA,e.NB,e.NC],o=[0,1,2,3],a=new ri;return a.set(r[o[1]][0]/s[o[1]],r[o[2]][0]/s[o[2]],r[o[3]][0]/s[o[3]],0,r[o[1]][1]/s[o[1]],r[o[2]][1]/s[o[2]],r[o[3]][1]/s[o[3]],0,r[o[1]][2]/s[o[1]],r[o[2]][2]/s[o[2]],r[o[3]][2]/s[o[3]],0,0,0,0,1),a.multiply((new ri).makeTranslation(e.AMIN,e.BMIN,e.CMIN)),a}}function T_(e,t,i){let n,r,s;e/=360,t/=100,i/=100;const o=Math.floor(6*e),a=6*e-o,c=i*(1-t),l=i*(1-a*t),h=i*(1-(1-a)*t);switch(o%6){case 0:n=i,r=h,s=c;break;case 1:n=l,r=i,s=c;break;case 2:n=c,r=i,s=h;break;case 3:n=c,r=l,s=i;break;case 4:n=h,r=c,s=i;break;case 5:n=i,r=c,s=l}return[n,r,s]}hl.add("xplor",P_),hl.add("cns",P_);const I_={red:T_(0,100,100),orange:T_(20,100,100),gold:T_(40,100,100),yellow:T_(60,100,100),lime:T_(80,100,100),green:T_(120,80,100),sea:T_(150,100,100),cyan:T_(180,100,85),sky:T_(210,75,95),blue:T_(240,70,100),purple:T_(275,75,100),magenta:T_(300,95,100),hotpink:T_(335,100,100),pink:T_(350,55,100),peach:T_(25,75,100),lilac:T_(275,55,100),pinktint:T_(340,30,100),peachtint:T_(25,50,100),yellowtint:T_(60,50,100),greentint:T_(135,40,100),bluetint:T_(220,40,100),lilactint:T_(275,35,100),white:T_(0,0,100),gray:T_(0,0,50),brown:T_(20,45,75),deadwhite:[1,1,1],deadblack:[0,0,0],invisible:[0,0,0]},E_=/[\s,]+/,D_=/[^{}\s]*{[^{}]+}|[^{}\s]+/g,L_=/^{+|}+$/g,R_=/^['"]+|['"]+$/g,k_=/\s*=\s*/g;function O_(e){let t,i,n,r=[];const s=(e=e.replace(k_,"=")).match(D_);for(let e=1;e<s.length;++e){const o=s[e];if("{"===o[0])t=o.substring(1,o.length-1);else{const e=o.split("=");2===e.length&&("color"===e[0]?i=I_[e[1]]:"width"===e[0]?n=parseInt(e[1]):"master"===e[0]&&r.push(e[1].replace(L_,"")))}}return{listName:t,listColor:i,listMasters:r,listWidth:n}}function B_(e){const t=(e=e.trim()).indexOf("{"),i=e.indexOf("}"),n=e.substr(i+1).split(E_),r=e.substr(t+1,i-1),s=[parseFloat(n[n.length-3]),parseFloat(n[n.length-2]),parseFloat(n[n.length-1])];let o,a,c,l=!1,h=!1;for(let e=4;e<=n.length;e++){const t=n[n.length-e];t in I_&&(o=I_[n[n.length-e]]),t.startsWith("width")&&(a=parseInt(t.substring(5))),t.startsWith("r=")&&(c=parseFloat(t.split("=")[1])),t.startsWith("P")&&(l=!0),t.startsWith("X")&&(h=!0)}return{label:r,position:s,color:o,radius:c,width:a,isLineBreak:l,isTriangleBreak:h}}function N_(e){const t=e.indexOf("{"),i=e.indexOf("}");return e.substring(-1!==t?t+1:0,-1!==i?i:void 0).trim()}function F_(e){const t=e.indexOf("}");return-1===t?void 0:e.substr(t+1).trim()}function z_(e){let t="",i=[],n={};const r=(e=e.replace(k_,"=")).match(D_);for(let e=1;e<r.length;++e){const s=r[e];if("{"===s[0])t=s.substring(1,s.length-1);else{const e=s.split("=");2===e.length?"master"===e[0]?i.push(e[1].replace(L_,"")):n[e[0]]=e[1].replace(L_,""):n[e[0]]=!0}}return{groupName:t,groupFlags:n,groupMasters:i}}hl.add("kin",class extends Zx{get type(){return"kin"}get __objName(){return"kinemage"}_parse(){e.Debug&&il.time(`KinParser._parse ${this.name}`);const t={kinemage:void 0,onewidth:void 0,"1viewid":void 0,pdbfile:void 0,texts:[],text:"",captions:[],caption:"",groupDict:{},subgroupDict:{},masterDict:{},pointmasterDict:{},dotLists:[],vectorLists:[],ballLists:[],ribbonLists:[]};let i,n;this.kinemage=t;let r,s,o,a,c,l,h,u,d,f,m,p,g,v,y,x,b,_,w,S,A,M,C=!1,P="",T=!1,I="",E=null,D=null,L=!1,R="",k=!1,O="",B=!1,N=!1;if(this.streamer.eachChunkOfLines((function(e){!function(e,F,z){for(let $=e;$<F;++$){const e=z[$];if("@"===e[0]&&(C=!1,T=!1,L=!1,k=!1,B=!1,N=!1),e)if(e.startsWith("@dotlist")){let{listColor:c,listName:l,listMasters:h}=O_(e);C=!0,P="",s=[],o=[],a=[],r=c,i&&(h=h.concat(i)),n&&(h=h.concat(n)),t.dotLists.push({name:l,masterArray:h,labelArray:s,positionArray:o,colorArray:a})}else if(e.startsWith("@vectorlist")){let{listMasters:r,listName:s,listWidth:o,listColor:a}=O_(e);r&&r.forEach((function(e){t.masterDict[e]||(t.masterDict[e]={indent:!1,visible:!1})})),T=!0,I="",E=null,D=null,h=[],u=[],d=[],f=[],m=[],p=[],c=a,l=[],o&&l.push(o),i&&(r=r.concat(i)),n&&(r=r.concat(n)),t.vectorLists.push({name:s,masterArray:r,label1Array:h,label2Array:u,position1Array:d,position2Array:f,color1Array:m,color2Array:p,width:l})}else if(e.startsWith("@balllist")){let{listName:r,listColor:s,listMasters:o}=O_(e);o&&o.forEach((function(e){t.masterDict[e]||(t.masterDict[e]={indent:!1,visible:!1})})),L=!0,R="",y=[],g=[],x=[],b=[],v=s,i&&(o=o.concat(i)),n&&(o=o.concat(n)),t.ballLists.push({name:r,masterArray:o,labelArray:y,radiusArray:g,positionArray:x,colorArray:b})}else if(e.startsWith("@ribbonlist")||e.startsWith("@trianglelist")){let{listMasters:r,listName:s,listColor:o}=O_(e);r&&r.forEach((function(e){t.masterDict[e]||(t.masterDict[e]={indent:!1,visible:!1})})),k=!0,O="",w=[],S=[],A=[],M=[],_=o,i&&(r=r.concat(i)),n&&(r=r.concat(n)),t.ribbonLists.push({name:s,masterArray:r,labelArray:w,positionArray:S,breakArray:A,colorArray:M})}else if(e.startsWith("@text"))B=!0,t.texts.push(e.substr(5));else if(e.startsWith("@caption"))N=!0,t.captions.push(e.substr(8));else if(C){let{label:t,color:i,position:n}=B_(e);'"'===t?t=P:P=t,void 0===i&&(i=r),s.push(t),o.push(...n),a.push(...i)}else if(T){let t=e.replace(/(?!^){/g,"\n{").split(/\n/);for(var U=0;U<t.length;U++){let e=t[U],{label:i,color:n,width:r,position:s,isLineBreak:o}=B_(e);'"'===i?i=I:I=i,void 0===n&&(n=c),o||null!==E&&(r&&l.push(r),h.push(I),d.push(...E),m.push(...D),u.push(i),f.push(...s),p.push(...n)),I=i,E=s,D=n}}else if(L){let{label:t,radius:i,color:n,position:r}=B_(e);'"'===t?t=R:R=t,void 0===i&&(i=1),void 0===n&&(n=v),y.push(t),g.push(i),x.push(...r),b.push(...n)}else if(k){let{label:t,color:i,position:n,isTriangleBreak:r}=B_(e);'"'===t?t=O:O=t,void 0===i&&(i=_),w.push(t),S.push(...n),A.push(r),M.push(...i)}else if(B)t.texts.push(e);else if(N)t.captions.push(e);else if(e.startsWith("@kinemage"))t.kinemage=parseInt(e.substr(9).trim());else if(e.startsWith("@onewidth"))t.onewidth=!0;else if(e.startsWith("@1viewid"))t["1viewid"]=N_(e);else if(e.startsWith("@pdbfile"))t.pdbfile=N_(e);else if(e.startsWith("@group")){let{groupName:n,groupFlags:r,groupMasters:s}=z_(e);t.groupDict[n]||(t.groupDict[n]={dominant:!1,animate:!1},i=s),i&&i.forEach((function(e){t.masterDict[e]||(t.masterDict[e]={indent:!1,visible:!1})}));for(let e in r)t.groupDict[n][e]=r[e]}else if(e.startsWith("@subgroup")){const{groupName:i,groupFlags:r,groupMasters:s}=z_(e);t.subgroupDict[i]||(t.subgroupDict[i]={dominant:!1,animate:!1},n=s),n&&n.forEach((function(e){t.masterDict[e]||(t.masterDict[e]={indent:!1,visible:!1})}));for(let e in r)t.subgroupDict[i][e]=r[e]}else if(e.startsWith("@master")){const i=N_(e),n=F_(e);t.masterDict[i]||(t.masterDict[i]={indent:!1,visible:!1}),"on"===n?t.masterDict[i].visible=!0:"off"===n?t.masterDict[i].visible=!1:"indent"===n&&(t.masterDict[i].indent=!0)}else if(e.startsWith("@pointmaster")){const{groupName:i,groupFlags:n}=z_(e);t.pointmasterDict[i]={id:Object.keys(n)[0].replace(R_,"")}}else console.log(e);else C=!1,T=!1,L=!1,k=!1}}(0,e.length,e)})),t.text=t.texts.join("\n").trim(),t.caption=t.captions.join("\n").trim(),t.ribbonLists){let e=[];t.ribbonLists.forEach((function(t){e.push(function(e){let{labelArray:t,positionArray:i,colorArray:n,breakArray:r}=e,s=[],o=[],a=[],c=[];for(let e=0;e<r.length/3;e++){let l=3*e,h=9*e;r[l+1]||r[l+2]||(s.push(t[l]),s.push(t[l+1]),s.push(t[l+2]),c.push(r[l]),c.push(r[l+1]),c.push(r[l+2]),o.push(i[h]),o.push(i[h+1]),o.push(i[h+2]),o.push(i[h+3]),o.push(i[h+4]),o.push(i[h+5]),o.push(i[h+6]),o.push(i[h+7]),o.push(i[h+8]),a.push(n[h]),a.push(n[h+1]),a.push(n[h+2]),a.push(n[h+3]),a.push(n[h+4]),a.push(n[h+5]),a.push(n[h+6]),a.push(n[h+7]),a.push(n[h+8]))}return{name:e.name,masterArray:e.masterArray,labelArray:s,positionArray:o,breakArray:c,colorArray:a}}(function(e){let{labelArray:t,positionArray:i,colorArray:n,breakArray:r}=e,s=[];for(let e=0;e<3*(t.length-2);++e)s[e]=t[e-2*Math.floor(e/3)];let o=[];for(let e=0;e<3*(r.length-2);++e)o[e]=r[e-2*Math.floor(e/3)];let a=[];for(let e=0;e<9*(i.length/3-2);++e)a[e]=i[e-6*Math.floor(e/9)];let c=[];for(let e=0;e<9*(n.length/3-2);++e)c[e]=n[e-6*Math.floor(e/9)];let l=[];for(let e=0;e<a.length/3;++e)l.push(new Zt(a[3*e],a[3*e]+1,a[3*e]+2));return{name:e.name,masterArray:e.masterArray,labelArray:s,positionArray:a,breakArray:o,colorArray:c}}(t)))})),t.ribbonLists=e}e.Debug&&il.timeEnd(`KinParser._parse ${this.name}`)}});class U_ extends Zx{constructor(e,t){super(e,t),this.loader=this.getLoader(),this.surface=new Xf(this.name,this.path)}get type(){return"surface"}get __objName(){return"surface"}_parse(){var e=this.loader.parse(this.streamer.asText());this.surface.fromGeometry(e)}}const $_=function(){this.regexp={vertex_pattern:/^v\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,normal_pattern:/^vn\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,uv_pattern:/^vt\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}};$_.prototype={constructor:$_,setPath:function(e){this.path=e},_createParserState:function(){var e={objects:[],object:{},vertices:[],normals:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);this.object={name:e||"",geometry:{vertices:[],normals:[]},fromDeclaration:!1!==t},this.objects.push(this.object)},parseVertexIndex:function(e,t){var i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)},parseNormalIndex:function(e,t){var i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)},addVertex:function(e,t,i){var n=this.vertices,r=this.object.geometry.vertices;r.push(n[e+0]),r.push(n[e+1]),r.push(n[e+2]),r.push(n[t+0]),r.push(n[t+1]),r.push(n[t+2]),r.push(n[i+0]),r.push(n[i+1]),r.push(n[i+2])},addVertexLine:function(e){var t=this.vertices,i=this.object.geometry.vertices;i.push(t[e+0]),i.push(t[e+1]),i.push(t[e+2])},addNormal:function(e,t,i){var n=this.normals,r=this.object.geometry.normals;r.push(n[e+0]),r.push(n[e+1]),r.push(n[e+2]),r.push(n[t+0]),r.push(n[t+1]),r.push(n[t+2]),r.push(n[i+0]),r.push(n[i+1]),r.push(n[i+2])},addFace:function(e,t,i,n,r,s,o,a){var c,l=this.vertices.length,h=this.parseVertexIndex(e,l),u=this.parseVertexIndex(t,l),d=this.parseVertexIndex(i,l);if(void 0===n?this.addVertex(h,u,d):(c=this.parseVertexIndex(n,l),this.addVertex(h,u,c),this.addVertex(u,d,c)),void 0!==r){var f=this.normals.length;h=this.parseNormalIndex(r,f),u=r===s?h:this.parseNormalIndex(s,f),d=r===o?h:this.parseNormalIndex(o,f),void 0===n?this.addNormal(h,u,d):(c=this.parseNormalIndex(a,f),this.addNormal(h,u,c),this.addNormal(u,d,c))}},addLineGeometry:function(e){this.object.geometry.type="Line";for(var t=this.vertices.length,i=0,n=e.length;i<n;i++)this.addVertexLine(this.parseVertexIndex(e[i],t))}};return e.startObject("",!1),e},parse:function(e){var t,i,n=this._createParserState();-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n")),-1!==e.indexOf("\\\n")&&(e=e.replace(/\\\n/g,""));var r=e.split("\n"),s="",o="",a="",c=[],l="function"==typeof"".trimLeft;for(t=0,i=r.length;t<i;t++)if(s=r[t],0!==(s=l?s.trimLeft():s.trim()).length&&"#"!==(o=s.charAt(0)))if("v"===o){if(" "===(a=s.charAt(1))&&null!==(c=this.regexp.vertex_pattern.exec(s)))n.vertices.push(parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]));else if("n"===a&&null!==(c=this.regexp.normal_pattern.exec(s)))n.normals.push(parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]));else if("t"!==a||null===this.regexp.uv_pattern.exec(s))throw new Error("Unexpected vertex/normal/uv line: '"+s+"'")}else if("f"===o)if(null!==(c=this.regexp.face_vertex_uv_normal.exec(s)))n.addFace(c[1],c[4],c[7],c[10],c[3],c[6],c[9],c[12]);else if(null!==this.regexp.face_vertex_uv.exec(s));else if(null!==(c=this.regexp.face_vertex_normal.exec(s)))n.addFace(c[1],c[3],c[5],c[7],c[2],c[4],c[6],c[8]);else{if(null===(c=this.regexp.face_vertex.exec(s)))throw new Error("Unexpected face line: '"+s+"'");n.addFace(c[1],c[2],c[3],c[4])}else if("l"===o){var h=s.substring(1).trim().split(" "),u=[],d=[];if(-1===s.indexOf("/"))u=h;else for(var f=0,m=h.length;f<m;f++){var p=h[f].split("/");""!==p[0]&&u.push(p[0]),""!==p[1]&&d.push(p[1])}n.addLineGeometry(u,d)}else if(null!==(c=this.regexp.object_pattern.exec(s))){var g=c[0].substr(1).trim();n.startObject(g)}else if(this.regexp.material_use_pattern.test(s));else if(this.regexp.material_library_pattern.test(s));else if(null===this.regexp.smoothing_pattern.exec(s)){if("\0"===s)continue;throw new Error("Unexpected line: '"+s+"'")}var v=[];for(t=0,i=n.objects.length;t<i;t++){var y=n.objects[t].geometry;if(0!==y.vertices.length){var x=new Vn;x.setAttribute("position",new An(new Float32Array(y.vertices),3)),y.normals.length>0?x.setAttribute("normal",new An(new Float32Array(y.normals),3)):x.computeVertexNormals(),v.push(x)}}return v}};hl.add("obj",class extends U_{get type(){return"obj"}getLoader(){return new $_}});const G_=function(){this.propertyNameMapping={}};G_.prototype={constructor:G_,setPropertyNameMapping:function(e){this.propertyNameMapping=e},bin2str:function(e){for(var t=new Uint8Array(e),i="",n=0;n<e.byteLength;n++)i+=String.fromCharCode(t[n]);return i},isASCII:function(e){return"ascii"===this.parseHeader(this.bin2str(e)).format},parse:function(e){return e instanceof ArrayBuffer?this.isASCII(e)?this.parseASCII(this.bin2str(e)):this.parseBinary(e):this.parseASCII(e)},parseHeader:function(e){var t="",i=0,n=/ply([\s\S]*)end_header\s/.exec(e);null!==n&&(t=n[1],i=n[0].length);var r,s,o,a,c,l,h={comments:[],elements:[],headerLength:i},u=t.split("\n");for(var d=0;d<u.length;d++){var f=u[d];if(""!==(f=f.trim()))switch(s=(o=f.split(/\s+/)).shift(),f=o.join(" "),s){case"format":h.format=o[0],h.version=o[1];break;case"comment":h.comments.push(f);break;case"element":void 0!==r&&h.elements.push(r),(r={}).name=o[0],r.count=parseInt(o[1]),r.properties=[];break;case"property":r.properties.push((a=o,c=this.propertyNameMapping,l=void 0,"list"===(l={type:a[0]}).type?(l.name=a[3],l.countType=a[1],l.itemType=a[2]):l.name=a[1],l.name in c&&(l.name=c[l.name]),l));break;default:console.log("unhandled",s,o)}}return void 0!==r&&h.elements.push(r),h},parseASCIINumber:function(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}},parseASCIIElement:function(e,t){for(var i=t.split(/\s+/),n={},r=0;r<e.length;r++)if("list"===e[r].type){for(var s=[],o=this.parseASCIINumber(i.shift(),e[r].countType),a=0;a<o;a++)s.push(this.parseASCIINumber(i.shift(),e[r].itemType));n[e[r].name]=s}else n[e[r].name]=this.parseASCIINumber(i.shift(),e[r].type);return n},parseASCII:function(e){var t,i=new mr,n=this.parseHeader(e),r="";null!==(t=/end_header\s([\s\S]*)$/.exec(e))&&(r=t[1]);var s=r.split("\n"),o=0,a=0;i.useColor=!1;for(var c=0;c<s.length;c++){var l=s[c];if(""!==(l=l.trim())){a>=n.elements[o].count&&(o++,a=0);var h=this.parseASCIIElement(n.elements[o].properties,l);this.handleElement(i,n.elements[o].name,h),a++}}return this.postProcess(i)},postProcess:function(e){if(e.useColor){for(var t=0;t<e.faces.length;t++)e.faces[t].vertexColors=[e.colors[e.faces[t].a],e.colors[e.faces[t].b],e.colors[e.faces[t].c]];e.elementsNeedUpdate=!0}return e.computeBoundingSphere(),e},handleElement:function(e,t,i){if("vertex"===t){if(e.vertices.push(new Zt(i.x,i.y,i.z)),"red"in i&&"green"in i&&"blue"in i){e.useColor=!0;var n=new mn;n.setRGB(i.red/255,i.green/255,i.blue/255),e.colors.push(n)}}else if("face"===t){var r=i.vertex_indices;3===r.length?e.faces.push(new yn(r[0],r[1],r[2])):4===r.length&&e.faces.push(new yn(r[0],r[1],r[3]),new yn(r[1],r[2],r[3]))}},binaryRead:function(e,t,i,n){switch(i){case"int8":case"char":return[e.getInt8(t),1];case"uint8":case"uchar":return[e.getUint8(t),1];case"int16":case"short":return[e.getInt16(t,n),2];case"uint16":case"ushort":return[e.getUint16(t,n),2];case"int32":case"int":return[e.getInt32(t,n),4];case"uint32":case"uint":return[e.getUint32(t,n),4];case"float32":case"float":return[e.getFloat32(t,n),4];case"float64":case"double":return[e.getFloat64(t,n),8]}},binaryReadElement:function(e,t,i,n){for(var r,s={},o=0,a=0;a<i.length;a++)if("list"===i[a].type){var c=[],l=(r=this.binaryRead(e,t+o,i[a].countType,n))[0];o+=r[1];for(var h=0;h<l;h++)r=this.binaryRead(e,t+o,i[a].itemType,n),c.push(r[0]),o+=r[1];s[i[a].name]=c}else r=this.binaryRead(e,t+o,i[a].type,n),s[i[a].name]=r[0],o+=r[1];return[s,o]},parseBinary:function(e){for(var t,i=new mr,n=this.parseHeader(this.bin2str(e)),r="binary_little_endian"===n.format,s=new DataView(e,n.headerLength),o=0,a=0;a<n.elements.length;a++)for(var c=0;c<n.elements[a].count;c++){o+=(t=this.binaryReadElement(s,o,n.elements[a].properties,r))[1];var l=t[0];this.handleElement(i,n.elements[a].name,l)}return this.postProcess(i)}};hl.add("ply",class extends U_{get type(){return"ply"}getLoader(){return new G_}});hl.add("csv",class extends Zx{constructor(e,t){const i=t||{};super(e,i),this.delimiter=Ia(i.delimiter,","),this.comment=Ia(i.comment,"#"),this.columnNames=Ia(i.columnNames,!1),this.table={name:this.name,path:this.path,columnNames:[],data:[]}}get type(){return"csv"}get __objName(){return"table"}_parse(){const e=this.table.data,t=new RegExp("\\s*"+this.delimiter+"\\s*");let i=0;this.streamer.eachChunkOfLines((n=>{const r=n.length;for(let s=0;s<r;++s){const r=n[s].trim();if(r.startsWith(this.comment))continue;const o=r.split(t);0===i?this.table.columnNames=o:r&&e.push(o),++i}}))}});hl.add("json",class extends Zx{constructor(e,t){const i=t||{};super(e,i),this.string=Ia(i.string,!1),this.json={name:this.name,path:this.path,data:{}}}get type(){return"json"}get __objName(){return"json"}get isJson(){return!0}_parse(){this.streamer.isBinary()||this.string?this.json.data=JSON.parse(this.streamer.asText()):this.json.data=this.streamer.data}});hl.add("msgpack",class extends Zx{constructor(e,t){super(e,t||{}),this.msgpack={name:this.name,path:this.path,data:void 0}}get type(){return"msgpack"}get __objName(){return"msgpack"}get isBinary(){return!0}_parse(){e.Debug&&il.time("MsgpackParser._parse "+this.name),this.msgpack.data=Db(this.streamer.data),e.Debug&&il.timeEnd("MsgpackParser._parse "+this.name)}});hl.add("netcdf",class extends Zx{constructor(e,t){super(e,t||{}),this.netcdf={name:this.name,path:this.path,data:void 0}}get type(){return"netcdf"}get __objName(){return"netcdf"}get isBinary(){return!0}_parse(){e.Debug&&il.time("NetcdfParser._parse "+this.name),this.netcdf.data=new a_(this.streamer.data),e.Debug&&il.timeEnd("NetcdfParser._parse "+this.name)}});class V_ extends Zx{constructor(e,t){super(e,t),this.text={name:this.name,path:this.path,data:""}}get type(){return"text"}get __objName(){return"text"}_parse(){this.text.data=this.streamer.asText()}}hl.add("txt",V_),hl.add("text",V_);const H_=/^['"]|['"]$/g,j_=/^<([\w-:.]+)\s*/,W_=/^([^<]*)/,q_=/([\w:-]+)\s*=\s*("[^"]*"|'[^']*'|\w+)\s*/;function X_(e){return e=e.trim().replace(/<!--[\s\S]*?-->/g,""),{declaration:t(),root:i()};function t(){if(!r(/^<\?xml\s*/))return;const e={attributes:{}};for(;!s()&&!o("?>");){const t=n();if(!t)return e;e.attributes[t.name]=t.value}return r(/\?>\s*/),e}function i(){const e=r(j_);if(!e)return;const t={name:e[1],attributes:{},children:[]};for(;!(s()||o(">")||o("?>")||o("/>"));){const e=n();if(!e)return t;t.attributes[e.name]=e.value}if(r(/^\s*\/>\s*/))return t;let a;for(r(/\??>\s*/),t.content=function(){const e=r(W_);return e?e[1]:""}();a=i();)t.children.push(a);return r(/^<\/[\w-:.]+>\s*/),t}function n(){const e=r(q_);var t;if(e)return{name:e[1],value:(t=e[2],t.replace(H_,""))}}function r(t){const i=e.match(t);if(i)return e=e.slice(i[0].length),i}function s(){return 0===e.length}function o(t){return 0===e.indexOf(t)}}class Y_ extends Zx{constructor(e,t){const i=t||{};super(e,i),this.useDomParser=Ia(i.useDomParser,!1),this.xml={name:this.name,path:this.path,data:{}}}get type(){return"xml"}get __objName(){return"xml"}get isXml(){return!0}__xmlParser(e){return X_(e)}__domParser(e){return(new window.DOMParser).parseFromString(e,"text/xml")}_parse(){e.Debug&&il.time("XmlParser._parse "+this.name),this.useDomParser?this.streamer.data instanceof Document?this.xml.data=this.streamer.data:this.xml.data=this.__domParser(this.streamer.asText()):this.xml.data=this.__xmlParser(this.streamer.asText()),e.Debug&&il.timeEnd("XmlParser._parse "+this.name)}}function Z_(e,t){const i=e.getNamedItem(t);return null!==i?i.value:""}function K_(e,t,i=!1){const n=Z_(e,"icode").trim(),r=Z_(e,"chain").trim(),s=Z_(e,"altcode");let o=Z_(e,"resnum");return n&&(o+="^"+n),r&&(o+=":"+r),t&&(o+="."+t),i&&s.trim()&&(o+="%"+s),o+="/"+(parseInt(Z_(e,"model"))-1),o}function Q_(e){const t=Z_(e,"chain").trim();let i=`[${Z_(e,"rescode")}]${Z_(e,"resnum")}`;return t&&(i+=`:${t}`),i}function J_(e,t,i){void 0===e[t]?e[t]=i:e[t]|=i}function ew(e,t){return null!==e&&e.value===t}function tw(e,t,i){let n=0;const r=t.getElementsByTagName("clash");for(let t=0,i=r.length;t<i;++t)if(e[Z_(r[t].attributes,"cid")]){n+=1;break}t.getElementsByTagName("angle-outlier").length>0&&(n+=1);t.getElementsByTagName("bond-outlier").length>0&&(n+=1);return t.getElementsByTagName("plane-outlier").length>0&&(n+=1),ew(i.getNamedItem("rota"),"OUTLIER")&&(n+=1),ew(i.getNamedItem("rama"),"OUTLIER")&&(n+=1),ew(i.getNamedItem("RNApucker"),"outlier")&&(n+=1),n}hl.add("xml",Y_);class iw{constructor(e,t){this.name=e,this.path=t,this.rsrzDict={},this.rsccDict={},this.rciDict={},this.clashDict={},this.clashArray=[],this.geoDict={},this.geoAtomDict={},this.atomDict={},this.clashSele="NONE"}get type(){return"validation"}fromXml(t){e.Debug&&il.time("Validation.fromXml");const i=this.rsrzDict,n=this.rsccDict,r=this.rciDict,s=this.clashDict,o=this.clashArray,a=this.geoDict,c=this.geoAtomDict,l=this.atomDict,h=t.getElementsByTagName("Entry");if(1===h.length){const e=h[0].getElementsByTagName("chemical_shift_list");if(1===e.length){const t=e[0].getElementsByTagName("random_coil_index");for(let e=0,i=t.length;e<i;++e){const i=t[e].attributes;r[Q_(i)]=parseFloat(Z_(i,"value"))}}}const u=t.getElementsByTagName("ModelledSubgroup"),d={},f=[];e.Debug&&il.time("Validation.fromXml#clashDict");for(let e=0,r=u.length;e<r;++e){const r=u[e],a=r.attributes,c=K_(a);null!==a.getNamedItem("rsrz")&&(i[c]=parseFloat(Z_(a,"rsrz"))),null!==a.getNamedItem("rscc")&&(n[c]=parseFloat(Z_(a,"rscc")));const h=t.createAttribute("sele");h.value=c,a.setNamedItem(h);const m=r.getElementsByTagName("clash");for(let e=0,t=m.length;e<t;++e){const t=m[e].attributes,i=Z_(t,"atom");if("H"!==mp(i)){const e=Z_(t,"cid"),n=K_(a,i,!0);if(l[n]=!0,void 0===d[e])d[e]={sele1:n,res1:c};else{const t=d[e];t.res1!==c&&(t.sele2=n,t.res2=c,f.push(t.res1,c),s[e]=t,o.push(t))}}}}e.Debug&&il.timeEnd("Validation.fromXml#clashDict");for(let e=0,t=u.length;e<t;++e){const t=u[e],i=t.attributes,n=Z_(i,"sele");if("."!==Z_(i,"seq")){const e=tw(s,t,i);e>0&&(a[n]=e)}else{const e=t.getElementsByTagName("clash"),i=t.getElementsByTagName("mog-bond-outlier"),r=t.getElementsByTagName("mog-angle-outlier");if(i.length>0||r.length>0||e.length>0){const t={};c[n]=t;for(let i=0,n=e.length;i<n;++i){const n=e[i].attributes;s[Z_(n,"cid")]&&J_(t,Z_(n,"atom"),1)}for(let e=0,n=i.length;e<n;++e){Z_(i[e].attributes,"atoms").split(",").forEach((function(e){J_(t,e,2)}))}for(let e=0,i=r.length;e<i;++e){Z_(r[e].attributes,"atoms").split(",").forEach((function(e){J_(t,e,4)}))}}}}this.clashSele=f.length?f.join(" OR "):"NONE",e.Debug&&il.timeEnd("Validation.fromXml")}getClashData(t){e.Debug&&il.time("Validation.getClashData");const i=t||{},n=i.structure,r=n.atomSet,s=new mn(Ia(i.color,"#f0027f")),o=n.getAtomProxy(),a=n.getAtomProxy(),c=new Zt,l=new Zt,h=new Zt,u=this.clashArray,d=u.length,f=new Float32Array(3*d),m=new Float32Array(3*d),p=Vl(d,s.r,s.g,s.b),g=new Float32Array(d),v=new Float32Array(d);e.Debug&&il.time("Validation.getClashData#atomDict");const y=this.atomDict;n.eachAtom((function(e){const t=function(e){const t=e.inscode,i=e.chainname,n=e.atomname,r=e.altloc;let s=e.resno+"";return t&&(s+="^"+t),i&&(s+=":"+i),n&&(s+="."+n),r&&(s+="%"+r),s+="/"+e.modelIndex,s}(e);!0===y[t]&&(y[t]=e.index)})),e.Debug&&il.timeEnd("Validation.getClashData#atomDict");let x=0;return u.forEach((function(e,t){if(o.index=y[e.sele1],a.index=y[e.sele2],void 0===o.index||void 0===a.index||!r.isSet(o.index,a.index))return;c.subVectors(a,o).setLength(o.vdw),l.copy(o).add(c),c.subVectors(o,a).setLength(a.vdw),h.copy(a).add(c);const i=o.distanceTo(a)/2,n=Math.sqrt(o.vdw*o.vdw-i*i),s=Math.sqrt(a.vdw*a.vdw-i*i);l.toArray(f,3*x),h.toArray(m,3*x),g[x]=(n+s)/2,v[x]=t,++x})),e.Debug&&il.timeEnd("Validation.getClashData"),{position1:f.subarray(0,3*x),position2:m.subarray(0,3*x),color:p.subarray(0,3*x),color2:p.subarray(0,3*x),radius:g.subarray(0,x),picking:new mf(v.subarray(0,x),this,n)}}}function nw(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)}function rw(e,t,i,n,r){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+n),r);else for(var s=0;s<n;s++)e[r+s]=t[i+s]}function sw(e,t,i,n){for(var r=65535&e|0,s=e>>>16&65535|0,o=0;0!==i;){i-=o=i>2e3?2e3:i;do{s=s+(r=r+t[n++]|0)|0}while(--o);r%=65521,s%=65521}return r|s<<16|0}hl.add("validation",class extends Y_{constructor(e,t){super(e,t||{}),this.useDomParser=!0,this.validation=new iw(this.name,this.path)}get __objName(){return"validation"}get isXml(){return!0}_parse(){super._parse(),e.Debug&&il.time("ValidationParser._parse "+this.name),this.validation.fromXml(this.xml.data),e.Debug&&il.timeEnd("ValidationParser._parse "+this.name)}});var ow=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();function aw(e,t,i,n){var r=ow,s=n+i;e^=-1;for(var o=n;o<s;o++)e=e>>>8^r[255&(e^t[o])];return-1^e}var cw=30,lw=12;function hw(e,t){var i,n,r,s,o,a,c,l,h,u,d,f,m,p,g,v,y,x,b,_,w,S,A,M,C;i=e.state,n=e.next_in,M=e.input,r=n+(e.avail_in-5),s=e.next_out,C=e.output,o=s-(t-e.avail_out),a=s+(e.avail_out-257),c=i.dmax,l=i.wsize,h=i.whave,u=i.wnext,d=i.window,f=i.hold,m=i.bits,p=i.lencode,g=i.distcode,v=(1<<i.lenbits)-1,y=(1<<i.distbits)-1;e:do{m<15&&(f+=M[n++]<<m,m+=8,f+=M[n++]<<m,m+=8),x=p[f&v];t:for(;;){if(f>>>=b=x>>>24,m-=b,0===(b=x>>>16&255))C[s++]=65535&x;else{if(!(16&b)){if(0==(64&b)){x=p[(65535&x)+(f&(1<<b)-1)];continue t}if(32&b){i.mode=lw;break e}e.msg="invalid literal/length code",i.mode=cw;break e}_=65535&x,(b&=15)&&(m<b&&(f+=M[n++]<<m,m+=8),_+=f&(1<<b)-1,f>>>=b,m-=b),m<15&&(f+=M[n++]<<m,m+=8,f+=M[n++]<<m,m+=8),x=g[f&y];i:for(;;){if(f>>>=b=x>>>24,m-=b,!(16&(b=x>>>16&255))){if(0==(64&b)){x=g[(65535&x)+(f&(1<<b)-1)];continue i}e.msg="invalid distance code",i.mode=cw;break e}if(w=65535&x,m<(b&=15)&&(f+=M[n++]<<m,(m+=8)<b&&(f+=M[n++]<<m,m+=8)),(w+=f&(1<<b)-1)>c){e.msg="invalid distance too far back",i.mode=cw;break e}if(f>>>=b,m-=b,w>(b=s-o)){if((b=w-b)>h&&i.sane){e.msg="invalid distance too far back",i.mode=cw;break e}if(S=0,A=d,0===u){if(S+=l-b,b<_){_-=b;do{C[s++]=d[S++]}while(--b);S=s-w,A=C}}else if(u<b){if(S+=l+u-b,(b-=u)<_){_-=b;do{C[s++]=d[S++]}while(--b);if(S=0,u<_){_-=b=u;do{C[s++]=d[S++]}while(--b);S=s-w,A=C}}}else if(S+=u-b,b<_){_-=b;do{C[s++]=d[S++]}while(--b);S=s-w,A=C}for(;_>2;)C[s++]=A[S++],C[s++]=A[S++],C[s++]=A[S++],_-=3;_&&(C[s++]=A[S++],_>1&&(C[s++]=A[S++]))}else{S=s-w;do{C[s++]=C[S++],C[s++]=C[S++],C[s++]=C[S++],_-=3}while(_>2);_&&(C[s++]=C[S++],_>1&&(C[s++]=C[S++]))}break}}break}}while(n<r&&s<a);n-=_=m>>3,f&=(1<<(m-=_<<3))-1,e.next_in=n,e.next_out=s,e.avail_in=n<r?r-n+5:5-(n-r),e.avail_out=s<a?a-s+257:257-(s-a),i.hold=f,i.bits=m}var uw=15,dw=852,fw=592,mw=0,pw=1,gw=2,vw=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],yw=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],xw=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],bw=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function _w(e,t,i,n,r,s,o,a){var c,l,h,u,d,f,m,p,g,v=a.bits,y=0,x=0,b=0,_=0,w=0,S=0,A=0,M=0,C=0,P=0,T=null,I=0,E=new Uint16Array(uw+1),D=new Uint16Array(uw+1),L=null,R=0;for(y=0;y<=uw;y++)E[y]=0;for(x=0;x<n;x++)E[t[i+x]]++;for(w=v,_=uw;_>=1&&0===E[_];_--);if(w>_&&(w=_),0===_)return r[s++]=20971520,r[s++]=20971520,a.bits=1,0;for(b=1;b<_&&0===E[b];b++);for(w<b&&(w=b),M=1,y=1;y<=uw;y++)if(M<<=1,(M-=E[y])<0)return-1;if(M>0&&(e===mw||1!==_))return-1;for(D[1]=0,y=1;y<uw;y++)D[y+1]=D[y]+E[y];for(x=0;x<n;x++)0!==t[i+x]&&(o[D[t[i+x]]++]=x);if(e===mw?(T=L=o,f=19):e===pw?(T=vw,I-=257,L=yw,R-=257,f=256):(T=xw,L=bw,f=-1),P=0,x=0,y=b,d=s,S=w,A=0,h=-1,u=(C=1<<w)-1,e===pw&&C>dw||e===gw&&C>fw)return 1;for(;;){m=y-A,o[x]<f?(p=0,g=o[x]):o[x]>f?(p=L[R+o[x]],g=T[I+o[x]]):(p=96,g=0),c=1<<y-A,b=l=1<<S;do{r[d+(P>>A)+(l-=c)]=m<<24|p<<16|g|0}while(0!==l);for(c=1<<y-1;P&c;)c>>=1;if(0!==c?(P&=c-1,P+=c):P=0,x++,0==--E[y]){if(y===_)break;y=t[i+o[x]]}if(y>w&&(P&u)!==h){for(0===A&&(A=w),d+=b,M=1<<(S=y-A);S+A<_&&!((M-=E[S+A])<=0);)S++,M<<=1;if(C+=1<<S,e===pw&&C>dw||e===gw&&C>fw)return 1;r[h=P&u]=w<<24|S<<16|d-s|0}}return 0!==P&&(r[d+P]=y-A<<24|64<<16|0),a.bits=w,0}var ww=1,Sw=2,Aw=0,Mw=-2,Cw=1,Pw=12,Tw=30,Iw=852,Ew=592;function Dw(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function Lw(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function Rw(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,function(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=Cw,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(Iw),t.distcode=t.distdyn=new Int32Array(Ew),t.sane=1,t.back=-1,Aw):Mw}(e)):Mw}function kw(e,t){var i,n;return e?(n=new Lw,e.state=n,n.window=null,i=function(e,t){var i,n;return e&&e.state?(n=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Mw:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,Rw(e))):Mw}(e,t),i!==Aw&&(e.state=null),i):Mw}var Ow,Bw,Nw=!0;function Fw(e){if(Nw){var t;for(Ow=new Int32Array(512),Bw=new Int32Array(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(_w(ww,e.lens,0,288,Ow,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;_w(Sw,e.lens,0,32,Bw,0,e.work,{bits:5}),Nw=!1}e.lencode=Ow,e.lenbits=9,e.distcode=Bw,e.distbits=5}function zw(e,t,i,n){var r,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),n>=s.wsize?(rw(s.window,t,i-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((r=s.wsize-s.wnext)>n&&(r=n),rw(s.window,t,i-n,r,s.wnext),(n-=r)?(rw(s.window,t,i-n,n,0),s.wnext=n,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0}function Uw(e,t){var i,n,r,s,o,a,c,l,h,u,d,f,m,p,g,v,y,x,b,_,w,S,A,M,C=0,P=new Uint8Array(4),T=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return Mw;(i=e.state).mode===Pw&&(i.mode=13),o=e.next_out,r=e.output,c=e.avail_out,s=e.next_in,n=e.input,a=e.avail_in,l=i.hold,h=i.bits,u=a,d=c,S=Aw;e:for(;;)switch(i.mode){case Cw:if(0===i.wrap){i.mode=13;break}for(;h<16;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(2&i.wrap&&35615===l){i.check=0,P[0]=255&l,P[1]=l>>>8&255,i.check=aw(i.check,P,2,0),l=0,h=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",i.mode=Tw;break}if(8!=(15&l)){e.msg="unknown compression method",i.mode=Tw;break}if(h-=4,w=8+(15&(l>>>=4)),0===i.wbits)i.wbits=w;else if(w>i.wbits){e.msg="invalid window size",i.mode=Tw;break}i.dmax=1<<w,e.adler=i.check=1,i.mode=512&l?10:Pw,l=0,h=0;break;case 2:for(;h<16;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(i.flags=l,8!=(255&i.flags)){e.msg="unknown compression method",i.mode=Tw;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=Tw;break}i.head&&(i.head.text=l>>8&1),512&i.flags&&(P[0]=255&l,P[1]=l>>>8&255,i.check=aw(i.check,P,2,0)),l=0,h=0,i.mode=3;case 3:for(;h<32;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}i.head&&(i.head.time=l),512&i.flags&&(P[0]=255&l,P[1]=l>>>8&255,P[2]=l>>>16&255,P[3]=l>>>24&255,i.check=aw(i.check,P,4,0)),l=0,h=0,i.mode=4;case 4:for(;h<16;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}i.head&&(i.head.xflags=255&l,i.head.os=l>>8),512&i.flags&&(P[0]=255&l,P[1]=l>>>8&255,i.check=aw(i.check,P,2,0)),l=0,h=0,i.mode=5;case 5:if(1024&i.flags){for(;h<16;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}i.length=l,i.head&&(i.head.extra_len=l),512&i.flags&&(P[0]=255&l,P[1]=l>>>8&255,i.check=aw(i.check,P,2,0)),l=0,h=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&((f=i.length)>a&&(f=a),f&&(i.head&&(w=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),rw(i.head.extra,n,s,f,w)),512&i.flags&&(i.check=aw(i.check,n,f,s)),a-=f,s+=f,i.length-=f),i.length))break e;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===a)break e;f=0;do{w=n[s+f++],i.head&&w&&i.length<65536&&(i.head.name+=String.fromCharCode(w))}while(w&&f<a);if(512&i.flags&&(i.check=aw(i.check,n,f,s)),a-=f,s+=f,w)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===a)break e;f=0;do{w=n[s+f++],i.head&&w&&i.length<65536&&(i.head.comment+=String.fromCharCode(w))}while(w&&f<a);if(512&i.flags&&(i.check=aw(i.check,n,f,s)),a-=f,s+=f,w)break e}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;h<16;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(l!==(65535&i.check)){e.msg="header crc mismatch",i.mode=Tw;break}l=0,h=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=Pw;break;case 10:for(;h<32;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}e.adler=i.check=Dw(l),l=0,h=0,i.mode=11;case 11:if(0===i.havedict)return e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,i.hold=l,i.bits=h,2;e.adler=i.check=1,i.mode=Pw;case Pw:if(5===t||6===t)break e;case 13:if(i.last){l>>>=7&h,h-=7&h,i.mode=27;break}for(;h<3;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}switch(i.last=1&l,h-=1,3&(l>>>=1)){case 0:i.mode=14;break;case 1:if(Fw(i),i.mode=20,6===t){l>>>=2,h-=2;break e}break;case 2:i.mode=17;break;case 3:e.msg="invalid block type",i.mode=Tw}l>>>=2,h-=2;break;case 14:for(l>>>=7&h,h-=7&h;h<32;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",i.mode=Tw;break}if(i.length=65535&l,l=0,h=0,i.mode=15,6===t)break e;case 15:i.mode=16;case 16:if(f=i.length){if(f>a&&(f=a),f>c&&(f=c),0===f)break e;rw(r,n,s,f,o),a-=f,s+=f,c-=f,o+=f,i.length-=f;break}i.mode=Pw;break;case 17:for(;h<14;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(i.nlen=257+(31&l),l>>>=5,h-=5,i.ndist=1+(31&l),l>>>=5,h-=5,i.ncode=4+(15&l),l>>>=4,h-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=Tw;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;h<3;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}i.lens[T[i.have++]]=7&l,l>>>=3,h-=3}for(;i.have<19;)i.lens[T[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,A={bits:i.lenbits},S=_w(0,i.lens,0,19,i.lencode,0,i.work,A),i.lenbits=A.bits,S){e.msg="invalid code lengths set",i.mode=Tw;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;v=(C=i.lencode[l&(1<<i.lenbits)-1])>>>16&255,y=65535&C,!((g=C>>>24)<=h);){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(y<16)l>>>=g,h-=g,i.lens[i.have++]=y;else{if(16===y){for(M=g+2;h<M;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(l>>>=g,h-=g,0===i.have){e.msg="invalid bit length repeat",i.mode=Tw;break}w=i.lens[i.have-1],f=3+(3&l),l>>>=2,h-=2}else if(17===y){for(M=g+3;h<M;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}h-=g,w=0,f=3+(7&(l>>>=g)),l>>>=3,h-=3}else{for(M=g+7;h<M;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}h-=g,w=0,f=11+(127&(l>>>=g)),l>>>=7,h-=7}if(i.have+f>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=Tw;break}for(;f--;)i.lens[i.have++]=w}}if(i.mode===Tw)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=Tw;break}if(i.lenbits=9,A={bits:i.lenbits},S=_w(ww,i.lens,0,i.nlen,i.lencode,0,i.work,A),i.lenbits=A.bits,S){e.msg="invalid literal/lengths set",i.mode=Tw;break}if(i.distbits=6,i.distcode=i.distdyn,A={bits:i.distbits},S=_w(Sw,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,A),i.distbits=A.bits,S){e.msg="invalid distances set",i.mode=Tw;break}if(i.mode=20,6===t)break e;case 20:i.mode=21;case 21:if(a>=6&&c>=258){e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,i.hold=l,i.bits=h,hw(e,d),o=e.next_out,r=e.output,c=e.avail_out,s=e.next_in,n=e.input,a=e.avail_in,l=i.hold,h=i.bits,i.mode===Pw&&(i.back=-1);break}for(i.back=0;v=(C=i.lencode[l&(1<<i.lenbits)-1])>>>16&255,y=65535&C,!((g=C>>>24)<=h);){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(v&&0==(240&v)){for(x=g,b=v,_=y;v=(C=i.lencode[_+((l&(1<<x+b)-1)>>x)])>>>16&255,y=65535&C,!(x+(g=C>>>24)<=h);){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}l>>>=x,h-=x,i.back+=x}if(l>>>=g,h-=g,i.back+=g,i.length=y,0===v){i.mode=26;break}if(32&v){i.back=-1,i.mode=Pw;break}if(64&v){e.msg="invalid literal/length code",i.mode=Tw;break}i.extra=15&v,i.mode=22;case 22:if(i.extra){for(M=i.extra;h<M;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}i.length+=l&(1<<i.extra)-1,l>>>=i.extra,h-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;v=(C=i.distcode[l&(1<<i.distbits)-1])>>>16&255,y=65535&C,!((g=C>>>24)<=h);){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(0==(240&v)){for(x=g,b=v,_=y;v=(C=i.distcode[_+((l&(1<<x+b)-1)>>x)])>>>16&255,y=65535&C,!(x+(g=C>>>24)<=h);){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}l>>>=x,h-=x,i.back+=x}if(l>>>=g,h-=g,i.back+=g,64&v){e.msg="invalid distance code",i.mode=Tw;break}i.offset=y,i.extra=15&v,i.mode=24;case 24:if(i.extra){for(M=i.extra;h<M;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}i.offset+=l&(1<<i.extra)-1,l>>>=i.extra,h-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=Tw;break}i.mode=25;case 25:if(0===c)break e;if(f=d-c,i.offset>f){if((f=i.offset-f)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=Tw;break}f>i.wnext?(f-=i.wnext,m=i.wsize-f):m=i.wnext-f,f>i.length&&(f=i.length),p=i.window}else p=r,m=o-i.offset,f=i.length;f>c&&(f=c),c-=f,i.length-=f;do{r[o++]=p[m++]}while(--f);0===i.length&&(i.mode=21);break;case 26:if(0===c)break e;r[o++]=i.length,c--,i.mode=21;break;case 27:if(i.wrap){for(;h<32;){if(0===a)break e;a--,l|=n[s++]<<h,h+=8}if(d-=c,e.total_out+=d,i.total+=d,d&&(e.adler=i.check=i.flags?aw(i.check,r,d,o-d):sw(i.check,r,d,o-d)),d=c,(i.flags?l:Dw(l))!==i.check){e.msg="incorrect data check",i.mode=Tw;break}l=0,h=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;h<32;){if(0===a)break e;a--,l+=n[s++]<<h,h+=8}if(l!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=Tw;break}l=0,h=0}i.mode=29;case 29:S=1;break e;case Tw:S=-3;break e;case 31:return-4;default:return Mw}return e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,i.hold=l,i.bits=h,(i.wsize||d!==e.avail_out&&i.mode<Tw&&(i.mode<27||4!==t))&&zw(e,e.output,e.next_out,d-e.avail_out),u-=e.avail_in,d-=e.avail_out,e.total_in+=u,e.total_out+=d,i.total+=d,i.wrap&&d&&(e.adler=i.check=i.flags?aw(i.check,r,d,e.next_out-d):sw(i.check,r,d,e.next_out-d)),e.data_type=i.bits+(i.last?64:0)+(i.mode===Pw?128:0)+(20===i.mode||15===i.mode?256:0),(0===u&&0===d||4===t)&&S===Aw&&(S=-5),S}function $w(e,t){var i,n=t.length;return e&&e.state?0!==(i=e.state).wrap&&11!==i.mode?Mw:11===i.mode&&sw(1,t,n,0)!==i.check?-3:zw(e,t,n,n)?(i.mode=31,-4):(i.havedict=1,Aw):Mw}var Gw=!0,Vw=!0;try{String.fromCharCode.apply(null,[0])}catch(e){Gw=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){Vw=!1}for(var Hw=new Uint8Array(256),jw=0;jw<256;jw++)Hw[jw]=jw>=252?6:jw>=248?5:jw>=240?4:jw>=224?3:jw>=192?2:1;function Ww(e){var t,i,n,r,s,o=e.length,a=0;for(r=0;r<o;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(n=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),a+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(a),s=0,r=0;s<a;r++)55296==(64512&(i=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(n=e.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),i<128?t[s++]=i:i<2048?(t[s++]=192|i>>>6,t[s++]=128|63&i):i<65536?(t[s++]=224|i>>>12,t[s++]=128|i>>>6&63,t[s++]=128|63&i):(t[s++]=240|i>>>18,t[s++]=128|i>>>12&63,t[s++]=128|i>>>6&63,t[s++]=128|63&i);return t}function qw(e,t){var i,n,r,s,o=t||e.length,a=new Array(2*o);for(n=0,i=0;i<o;)if((r=e[i++])<128)a[n++]=r;else if((s=Hw[r])>4)a[n++]=65533,i+=s-1;else{for(r&=2===s?31:3===s?15:7;s>1&&i<o;)r=r<<6|63&e[i++],s--;s>1?a[n++]=65533:r<65536?a[n++]=r:(r-=65536,a[n++]=55296|r>>10&1023,a[n++]=56320|1023&r)}return function(e,t){if(t<65537&&(e.subarray&&Vw||!e.subarray&&Gw))return String.fromCharCode.apply(null,nw(e,t));for(var i="",n=0;n<t;n++)i+=String.fromCharCode(e[n]);return i}(a,n)}function Xw(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+Hw[e[i]]>t?i:t}Hw[254]=Hw[254]=1;var Yw=0,Zw={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};function Kw(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function Qw(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var Jw=Object.prototype.toString;function eS(e){if(!(this instanceof eS))return new eS(e);this.options=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var n in i)i.hasOwnProperty(n)&&(e[n]=i[n])}}return e}({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Kw,this.strm.avail_out=0;var i,n,r,s=kw(this.strm,t.windowBits);if(s!==Yw)throw new Error(Zw[s]);this.header=new Qw,i=this.strm,n=this.header,i&&i.state&&(0==(2&(r=i.state).wrap)||(r.head=n,n.done=!1))}eS.prototype.push=function(e,t){var i,n,r,s,o,a,c=this.strm,l=this.options.chunkSize,h=this.options.dictionary,u=!1;if(this.ended)return!1;n=t===~~t?t:!0===t?4:0,"string"==typeof e?c.input=function(e){for(var t=new Uint8Array(e.length),i=0,n=t.length;i<n;i++)t[i]=e.charCodeAt(i);return t}(e):"[object ArrayBuffer]"===Jw.call(e)?c.input=new Uint8Array(e):c.input=e,c.next_in=0,c.avail_in=c.input.length;do{if(0===c.avail_out&&(c.output=new Uint8Array(l),c.next_out=0,c.avail_out=l),2===(i=Uw(c,0))&&h&&(a="string"==typeof h?Ww(h):"[object ArrayBuffer]"===Jw.call(h)?new Uint8Array(h):h,i=$w(this.strm,a)),-5===i&&!0===u&&(i=Yw,u=!1),1!==i&&i!==Yw)return this.onEnd(i),this.ended=!0,!1;c.next_out&&(0!==c.avail_out&&1!==i&&(0!==c.avail_in||4!==n&&2!==n)||("string"===this.options.to?(r=Xw(c.output,c.next_out),s=c.next_out-r,o=qw(c.output,r),c.next_out=s,c.avail_out=l-s,s&&rw(c.output,c.output,r,s,0),this.onData(o)):this.onData(nw(c.output,c.next_out)))),0===c.avail_in&&0===c.avail_out&&(u=!0)}while((c.avail_in>0||0===c.avail_out)&&1!==i);return 1===i&&(n=4),4===n?(i=function(e){if(!e||!e.state)return Mw;var t=e.state;return t.window&&(t.window=null),e.state=null,Aw}(this.strm),this.onEnd(i),this.ended=!0,i===Yw):2!==n||(this.onEnd(Yw),c.avail_out=0,!0)},eS.prototype.onData=function(e){this.chunks.push(e)},eS.prototype.onEnd=function(e){e===Yw&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=function(e){var t,i,n,r,s,o;for(n=0,t=0,i=e.length;t<i;t++)n+=e[t].length;for(o=new Uint8Array(n),r=0,t=0,i=e.length;t<i;t++)s=e[t],o.set(s,r),r+=s.length;return o}(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},dl.add("gz",(function(e){let t;e instanceof ArrayBuffer&&(e=new Uint8Array(e));try{t=function(e,t){var i=new eS(t);if(i.push(e,!0),i.err)throw i.msg;return i.result}(e)}catch(i){t=e}return t}));class tS{}const iS="//mmtf.rcsb.org/v1.0/",nS=iS+"full/",rS=iS+"reduced/";cl.add("rcsb",new class extends tS{getUrl(e){const t=Sl(e),i=t.name.substr(0,4);let n;return!["pdb","cif"].includes(t.ext)||!1!==t.compressed&&"gz"!==t.compressed?"mmtf"===t.ext?n=t.base.endsWith(".bb")?rS+i:nS+i:t.ext?(il.warn("unsupported ext",t.ext),n=nS+i):n=nS+i:n="//files.rcsb.org/download/"+t.path,La()+n}getExt(e){const t=Sl(e).ext;return t||"mmtf"}});const sS="//pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/",oS="/SDF?record_type=3d";cl.add("pubchem",new class extends tS{getUrl(e){const t=Sl(e),i=t.name;let n;return t.ext&&"sdf"!==t.ext?(il.warn("unsupported ext",t.ext),n=sS+i+oS):n=sS+i+oS,La()+n}getExt(e){const t=Sl(e).ext;return t||"sdf"}});class aS extends tS{getUrl(e){return e}getExt(e){return Sl(e).ext}}cl.add("ftp",new aS),cl.add("http",new aS),cl.add("https",new aS);const cS="//alphafold.ebi.ac.uk/files/AF-",lS="-F1-model_v2.pdb";cl.add("alphafold",new class extends tS{getUrl(e){const t=Sl(e),i=t.name;let n;return t.ext&&"pdb"!==t.ext?(il.warn("unsupported AF ext",t.ext),n=cS+i+lS):n=cS+i+lS,La()+n}getExt(e){const t=Sl(e).ext;return t||"pdb"}});const hS=/^((http|https|ftp):)*\/\//;function uS(e,t){return{type:"integer",max:e,min:t}}function dS(e,t,i){return{type:"number",precision:e,max:t,min:i}}function fS(e,t,i){return{type:"range",step:e,max:t,min:i}}function mS(...e){return{type:"select",options:e.reduce(((e,t)=>Object.assign(Object.assign({},e),{[t]:t})),{})}}const pS={backgroundColor:{type:"color"},quality:mS("auto","low","medium","high"),sampleLevel:fS(1,5,-1),impostor:{type:"boolean"},workerDefault:{type:"boolean"},rotateSpeed:dS(1,10,0),zoomSpeed:dS(1,10,0),panSpeed:dS(1,10,0),clipNear:fS(1,100,0),clipFar:fS(1,100,0),clipDist:uS(200,0),clipMode:mS("scene","camera"),clipScale:mS("relative","absolute"),fogNear:fS(1,100,0),fogFar:fS(1,100,0),cameraType:mS("perspective","orthographic","stereo"),cameraEyeSep:dS(3,1,.01),cameraFov:fS(1,120,15),lightColor:{type:"color"},lightIntensity:dS(2,10,0),ambientColor:{type:"color"},ambientIntensity:dS(2,10,0),hoverTimeout:uS(1e4,-1),tooltip:{type:"boolean"},mousePreset:mS(...Object.keys(um))};e.AngleRepresentation=Qv,e.ArrowBuffer=wx,e.Assembly=Qm,e.AxesRepresentation=fy,e.BackboneRepresentation=py,e.BallAndStickRepresentation=my,e.BaseRepresentation=gy,e.Box3=Ni,e.BoxBuffer=Px,e.BufferRepresentation=Vp,e.CartoonRepresentation=Sy,e.Collection=Sg,e.Color=mn,e.Colormaker=dc,e.ColormakerRegistry=al,e.Component=wg,e.ComponentCollection=Wg,e.ConeBuffer=xx,e.ContactRepresentation=Ay,e.Counter=El,e.CylinderBuffer=dy,e.DatasourceRegistry=cl,e.DecompressorRegistry=dl,e.DihedralHistogramRepresentation=Ty,e.DihedralRepresentation=My,e.DistanceRepresentation=Ey,e.EllipsoidBuffer=Rx,e.Euler=ai,e.Frames=Pg,e.HelixorientRepresentation=ky,e.HyperballRepresentation=Vy,e.Kdtree=qm,e.KeyActions=mm,e.LabelRepresentation=jy,e.LeftMouseButton=1,e.LicoriceRepresentation=Oy,e.LineRepresentation=qy,e.Matrix3=Ut,e.Matrix4=ri,e.MdsrvDatasource=class extends tS{constructor(e=""){super(),this.baseUrl=e}getListing(e=""){let t=`${this.baseUrl}dir/${e}`;return"/"!==t[t.length-1]&&(t+="/"),Ml(t,{ext:"json"}).then((t=>({path:e,data:t.data})))}getUrl(e){const t=Sl(e);return`${this.baseUrl}file/${t.path}${t.query}`}getCountUrl(e){const t=Sl(e);return`${this.baseUrl}traj/numframes/${t.path}${t.query}`}getFrameUrl(e,t){const i=Sl(e);return`${this.baseUrl}traj/frame/${t}/${i.path}${i.query}`}getFrameParams(e,t){return`atomIndices=${t.join(";")}`}getPathUrl(e,t){const i=Sl(e);return`${this.baseUrl}traj/path/${t}/${i.path}${i.query}`}getExt(e){return Sl(e).ext}},e.MeasurementDefaultParams=nl,e.MeshBuffer=nm,e.MiddleMouseButton=2,e.MolecularSurface=Qy,e.MolecularSurfaceRepresentation=Jy,e.MouseActions=hm,e.OctahedronBuffer=Fx,e.ParserRegistry=hl,e.PdbWriter=class extends Pl{constructor(e,t){super(),this.mimeType="text/plain",this.defaultName="structure",this.defaultExt="pdb";const i=Object.assign({},t);this.renumberSerial=Ia(i.renumberSerial,!0),this.remarks=function(e){return Array.isArray(e)?e:[e]}(Ia(i.remarks,[])),this.structure=e,this._records=[]}_writeRecords(){this._records.length=0,this._writeTitle(),this._writeRemarks(),this._writeAtoms()}_writeTitle(){this._records.push(Cl.sprintf("TITLE %-74s",this.structure.name))}_writeRemarks(){this.remarks.forEach((e=>{this._records.push(Cl.sprintf("REMARK %-73s",e))})),this.structure.trajectory&&(this._records.push(Cl.sprintf("REMARK %-73s","Trajectory '"+this.structure.trajectory.name+"'")),this._records.push(Cl.sprintf("REMARK %-73s",`Frame ${this.structure.trajectory.frame}`)))}_writeAtoms(){let e=1,t=1,i=" ",n=" ";const r=this.structure.modelStore.count>1;this.structure.eachModel((s=>{r&&this._records.push(Cl.sprintf("MODEL     %4d%-66s",t++,"")),s.eachAtom((t=>{const r=t.hetero?"HETATM%5d %-4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s%1s%1s":"ATOM  %5d %-4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s%1s%1s",s=this.renumberSerial?e:t.serial;let o=t.atomname;(1===o.length||o.length<4&&1===t.element.length&&o[0]===t.element)&&(o=" "+o),t.formalCharge?(i=Math.abs(t.formalCharge).toPrecision(1),n=t.formalCharge>0?"+":"-"):(i=" ",n=" "),this._records.push(Cl.sprintf(r,s,o,t.resname,Ia(t.chainname," "),t.resno,t.x,t.y,t.z,Ia(t.occupancy,1),Ia(t.bfactor,0),"",Ia(t.element,""),i,n)),e+=1}),this.structure.getSelection()),r&&this._records.push(Cl.sprintf("%-80s","ENDMDL"))})),this._records.push(Cl.sprintf("%-80s","END"))}getString(){return console.warn("PdbWriter.getString() is deprecated, use .getData instead"),this.getData()}getData(){return this._writeRecords(),this._records.join("\n")}},e.PickingProxy=Rh,e.Plane=Qi,e.PointBuffer=sg,e.PointRepresentation=ex,e.Quaternion=qt,e.Queue=eu,e.RepresentationCollection=Ag,e.RepresentationElement=yg,e.RepresentationRegistry=ll,e.RibbonRepresentation=rx,e.RightMouseButton=3,e.RocketRepresentation=sx,e.RopeRepresentation=ox,e.ScriptExtensions=sl,e.SdfWriter=class extends Pl{constructor(e){super(),this.mimeType="text/plain",this.defaultName="structure",this.defaultExt="sdf",this.structure=e,this._records=[]}get idString(){return this.structure.id}get titleString(){return"  "+this.structure.title}get countsString(){return Cl.sprintf("%3i%3i  0  0  0  0  0  0  0  0999 V2000",this.structure.atomCount,this.structure.bondCount)}get chargeLines(){const e=[];this.structure.eachAtom((t=>{null!=t.formalCharge&&0!==t.formalCharge&&e.push([t.index,t.formalCharge])}));const t=[];for(let i=0;i<e.length;i+=8){const n=Math.min(8,e.length-i);let r=Cl.sprintf("M  CHG%3i",n);for(let t=i;t<i+n;t++)r+=Cl.sprintf(" %3i %3i",e[t][0]+1,e[t][1]);t.push(r)}return t}formatAtom(e){let t=0;null!=e.formalCharge&&0!==e.formalCharge&&(t=4-e.formalCharge);const i=Cl.sprintf("%10.4f%10.4f%10.4f %-3s 0%3i  0  0  0",e.x,e.y,e.z,e.element,t);if(48!==i.length)throw new Error("Incompatible atom for sdf format");return i}formatBond(e){return Cl.sprintf("%3i%3i%3i  0  0  0",e.atomIndex1+1,e.atomIndex2+1,e.bondOrder)}_writeRecords(){this._records.length=0,this._writeHeader(),this._writeCTab(),this._writeFooter()}_writeHeader(){this._records.push(this.idString,this.titleString,"")}_writeCTab(){this._records.push(this.countsString),this.structure.eachAtom((e=>{this._records.push(this.formatAtom(e))})),this.structure.eachBond((e=>{this._records.push(this.formatBond(e))})),this.chargeLines.forEach((e=>{this._records.push(e)})),this._records.push("M  END")}_writeFooter(){this._records.push("$$$$")}getData(){return this._writeRecords(),this._records.join("\n")}},e.Selection=$c,e.Shape=Gp,e.ShapeComponent=Zg,e.Signal=mc.Signal,e.SpacefillRepresentation=ax,e.SpatialHash=ju,e.SphereBuffer=tg,e.Stage=class{constructor(e,t={}){this.signals={parametersChanged:new mc.Signal,fullscreenChanged:new mc.Signal,componentAdded:new mc.Signal,componentRemoved:new mc.Signal,clicked:new mc.Signal,hovered:new mc.Signal},this.tasks=new El,this.compList=[],this.defaultFileParams={},this.logList=[],this.viewer=new vh(e),this.viewer.renderer&&(this.tooltip=document.createElement("div"),Object.assign(this.tooltip.style,{display:"none",position:"fixed",zIndex:"1000000",pointerEvents:"none",backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),this.viewer.container.appendChild(this.tooltip),this.mouseObserver=new xh(this.viewer.renderer.domElement),this.viewerControls=new Vh(this),this.trackballControls=new Dh(this),this.pickingControls=new kh(this),this.animationControls=new Jh(this),this.mouseControls=new fm(this),this.keyControls=new gm(this),this.pickingBehavior=new vm(this),this.mouseBehavior=new ym(this),this.animationBehavior=new xm(this),this.keyBehavior=new _m(this),this.spinAnimation=this.animationControls.spin([0,1,0],.005),this.spinAnimation.pause(!0),this.rockAnimation=this.animationControls.rock([0,1,0],.005),this.rockAnimation.pause(!0),this.parameters=Ea(t,Yg),this.setParameters(this.parameters),this.viewer.animate())}setParameters(e={}){Da(this.parameters,e);const t=e,i=this.parameters,n=this.viewer,r=this.trackballControls;return void 0!==t.quality&&this.setQuality(i.quality),void 0!==t.impostor&&this.setImpostor(i.impostor),void 0!==t.rotateSpeed&&(r.rotateSpeed=i.rotateSpeed),void 0!==t.zoomSpeed&&(r.zoomSpeed=i.zoomSpeed),void 0!==t.panSpeed&&(r.panSpeed=i.panSpeed),void 0!==t.mousePreset&&this.mouseControls.preset(i.mousePreset),this.mouseObserver.setParameters({hoverTimeout:i.hoverTimeout}),n.setClip(i.clipNear,i.clipFar,i.clipDist,i.clipMode,i.clipScale),n.setFog(void 0,i.fogNear,i.fogFar),n.setCamera(i.cameraType,i.cameraFov,i.cameraEyeSep),n.setSampling(i.sampleLevel),n.setBackground(i.backgroundColor),n.setLight(i.lightColor,i.lightIntensity,i.ambientColor,i.ambientIntensity),this.signals.parametersChanged.dispatch(this.getParameters()),this}log(e){console.log("STAGE LOG",e),this.logList.push(e)}getParameters(){return Object.assign({},this.parameters)}defaultFileRepresentation(t){if(t instanceof Vg){let i,n,r;t.setSelection("/0");const s=t.structure;if(s.biomolDict.BU1){const e=s.biomolDict.BU1;i=e.getAtomCount(s),n=e.getResidueCount(s),r=e.getInstanceCount(),t.setDefaultAssembly("BU1")}else i=s.getModelProxy(0).atomCount,n=s.getModelProxy(0).residueCount,r=1;let o=i;Kc&&(o*=4);const a=s.atomStore.count/s.residueStore.count<2;a&&(o*=10);let c="chainname",l="RdYlBu",h=!1;if(1===s.getChainnameCount(new $c("polymer and /0"))&&(c="residueindex",l="Spectral",h=!0),e.Debug&&console.log(o,i,r,a),n/r<4)t.addRepresentation("ball+stick",{colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"});else if(r>5&&o>15e3||o>7e5){let e=Math.min(2,Math.max(.1,6e3/(o/r)));a&&(e=Math.min(e,.5)),t.addRepresentation("surface",{colorScheme:c,colorScale:l,colorReverse:h,sele:"polymer",surfaceType:"av",probeRadius:1.4,scaleFactor:e,useWorker:!1})}else o>25e4?t.addRepresentation("backbone",{colorScheme:c,colorScale:l,colorReverse:h,lineOnly:!0}):o>1e5?t.addRepresentation("backbone",{colorScheme:c,colorScale:l,colorReverse:h,quality:"low",disableImpostor:!0,radiusScale:2}):o>8e4?t.addRepresentation("backbone",{colorScheme:c,colorScale:l,colorReverse:h,radiusScale:2}):(t.addRepresentation("cartoon",{colorScheme:c,colorScale:l,colorReverse:h,radiusScale:.7,aspectRatio:5,quality:"auto"}),o<5e4&&t.addRepresentation("base",{colorScheme:c,colorScale:l,colorReverse:h,quality:"auto"}),t.addRepresentation("ball+stick",{sele:"ligand",colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"}));t.structure.frames.length&&t.addTrajectory()}else(t instanceof Hg||t instanceof jg)&&t.addRepresentation("surface");this.tasks.onZeroOnce(this.autoView,this)}loadFile(e,t={}){const i=Object.assign({},this.defaultFileParams,t),n=Sl(e).name;this.tasks.increment(),this.log(`loading file '${n}'`);const r=Ia(i.ext,Sl(e).ext);let s;return s=hl.isTrajectory(r)?Promise.reject(new Error(`loadFile: ext '${r}' is a trajectory and must be loaded into a structure component`)):Ml(e,i),s.then((e=>{this.log(`loaded '${n}'`);const t=this.addComponentFromObject(e,i);return i.defaultRepresentation&&this.defaultFileRepresentation(t),this.tasks.decrement(),t}),(e=>{this.tasks.decrement();const t=`error loading file: '${e}'`;throw this.log(t),t}))}loadScript(e){const t=Sl(e).name;return this.log(`loading script '${t}'`),Ml(e).then((e=>{this.tasks.increment(),this.log(`running script '${t}'`),e.run(this).then((()=>{this.tasks.decrement(),this.log(`finished script '${t}'`)})),this.log(`called script '${t}'`)}),(e=>{this.tasks.decrement();const i=`errored script '${t}' "${e}"`;throw this.log(i),i}))}addComponent(e){e?(this.compList.push(e),this.signals.componentAdded.dispatch(e)):il.warn("Stage.addComponent: no component given")}addComponentFromObject(e,t={}){const i=fl.get(e.type);if(i){const n=new i(this,e,t);return this.addComponent(n),n}il.warn("no component for object type",e.type)}removeComponent(e){const t=this.compList.indexOf(e);-1!==t&&(this.compList.splice(t,1),e.dispose(),this.signals.componentRemoved.dispatch(e))}removeAllComponents(){this.compList.slice().forEach((e=>this.removeComponent(e)))}handleResize(){this.viewer.handleResize()}setSize(e,t){const i=this.viewer.container;i!==document.body&&(void 0!==e&&(i.style.width=e),void 0!==t&&(i.style.height=t),this.handleResize())}toggleFullscreen(e){if(!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled))return void il.log("fullscreen mode (currently) not possible");const t=this;function i(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function n(){if(!i()&&t.lastFullscreenElement){const e=t.lastFullscreenElement;e.style.width=e.dataset.normalWidth||"",e.style.height=e.dataset.normalHeight||"",document.removeEventListener("fullscreenchange",n),document.removeEventListener("mozfullscreenchange",n),document.removeEventListener("webkitfullscreenchange",n),document.removeEventListener("MSFullscreenChange",n),t.handleResize(),t.signals.fullscreenChanged.dispatch(!1)}}e=e||this.viewer.container,this.lastFullscreenElement=e,i()?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():(e.dataset.normalWidth=e.style.width||"",e.dataset.normalHeight=e.style.height||"",e.style.width=window.screen.width+"px",e.style.height=window.screen.height+"px",e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),document.addEventListener("fullscreenchange",n),document.addEventListener("mozfullscreenchange",n),document.addEventListener("webkitfullscreenchange",n),document.addEventListener("MSFullscreenChange",n),this.handleResize(),this.signals.fullscreenChanged.dispatch(!0),setTimeout((function(){t.handleResize()}),100))}setSpin(e){e?(this.spinAnimation.resume(!0),this.rockAnimation.pause(!0)):this.spinAnimation.pause(!0)}setRock(e){e?(this.rockAnimation.resume(!0),this.spinAnimation.pause(!0)):this.rockAnimation.pause(!0)}toggleSpin(){this.setSpin(this.spinAnimation.paused)}toggleRock(){this.setRock(this.rockAnimation.paused)}getFocus(){const e=this.parameters;if("scene"!==e.clipMode)return 0;let t=e.clipNear;return"absolute"===e.clipScale&&(t=this.viewer.absoluteToRelative(t)),2*t}setFocus(e){if("scene"!==this.parameters.clipMode)return;let t,i,n,r;"relative"===this.parameters.clipScale?(t=tc(e/2,0,49.9),i=100-t,n=50,r=function(e){return tc(e,0,100)}(2*i-50)):(t=this.viewer.relativeToAbsolute(e/2),i=t,n=0,r=2*i),this.setParameters({clipNear:t,clipFar:i,fogNear:n,fogFar:r})}getZoomForBox(e){const t=e.getSize(Xg),i=Math.max(t.x,t.y,t.z),n=Math.min(t.x,t.y,t.z);let r=i+Math.sqrt(n);const s=Ka(this.viewer.perspectiveCamera.fov),o=this.viewer.width,a=this.viewer.height,c=a<o?1:o/a;return r=Math.abs(.5*r/c/Math.sin(s/2)),r+=this.parameters.clipDist,-r}getBox(){return this.viewer.boundingBox}getZoom(){return this.getZoomForBox(this.getBox())}getCenter(e){return this.getBox().getCenter(e||new Zt)}autoView(e){this.animationControls.zoomMove(this.getCenter(),this.getZoom(),Ia(e,0))}makeImage(e={}){return new Promise(((t,i)=>{this.tasks.onZeroOnce((()=>{this.tasks.increment(),this.viewer.makeImage(e).then((e=>{this.tasks.decrement(),t(e)})).catch((e=>{this.tasks.decrement(),i(e)}))}))}))}setImpostor(e){this.parameters.impostor=e;const t=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation((function(i){if(!t.includes(i.getType()))return;const n=i.getParameters();n.disableImpostor=!e,i.build(n)}))}setQuality(e){this.parameters.quality=e;const t=["tube","cartoon","ribbon","trace","rope"],i=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation((function(n){const r=n.getParameters();if(!t.includes(n.getType())){if(!i.includes(n.getType()))return;if(!r.disableImpostor)return void(n.repr.quality=e)}r.quality=e,n.build(r)}))}eachComponent(e,t){this.compList.slice().forEach((i=>{void 0!==t&&t!==i.type||e(i)}))}eachRepresentation(e,t){this.eachComponent((i=>{i.reprList.slice().forEach((n=>{void 0!==t&&t!==n.getType()||e(n,i)}))}))}getComponentsByName(e){const t=[];return this.eachComponent((i=>{(void 0===e||qg(e,i))&&t.push(i)})),new Wg(t)}getComponentsByObject(e){const t=[];return this.eachComponent((i=>{i.object===e&&t.push(i)})),new Wg(t)}getRepresentationsByName(e){const t=[];return this.eachRepresentation(((i,n)=>{(void 0===e||qg(e,i))&&t.push(i)})),new Ag(t)}measureClear(){this.eachComponent((e=>e.measureClear()),"structure")}measureUpdate(){this.eachComponent((e=>e.measureUpdate()),"structure")}dispose(){this.tasks.dispose(),this.viewer.dispose(),this.mouseObserver.dispose()}},e.StaticDatasource=class extends tS{constructor(e=""){super(),this.baseUrl=e}getUrl(e){const t=Sl(e);let i=this.baseUrl+t.path;return hS.test(this.baseUrl)||(i=function(e){const t=window.location,i=t.pathname,n=i.substring(0,i.lastIndexOf("/")+1);return t.origin+n+e}(i)),i}getExt(e){return Sl(e).ext}},e.StlWriter=class extends Pl{constructor(e){super(),this.mimeType="application/vnd.ms-pki.stl",this.defaultName="surface",this.defaultExt="stl",this.surface=e}getData(){const e=this.surface.index.length/3,t=new Il(2*e+3*e*4*4+80+4);t.skip(80),t.writeUint32(e);const i=new Zt,n=new Zt,r=new Zt,s=new Zt;for(let o=0;o<e;o++){const e=[this.surface.index[3*o],this.surface.index[3*o+1],this.surface.index[3*o+2]];n.fromArray(this.surface.normal,3*e[0]),r.fromArray(this.surface.normal,3*e[1]),s.fromArray(this.surface.normal,3*e[2]),i.addVectors(n,r).add(s).normalize(),t.writeFloat32(i.x),t.writeFloat32(i.y),t.writeFloat32(i.z);for(let n=0;n<3;n++)i.fromArray(this.surface.position,3*e[n]),t.writeFloat32(i.x),t.writeFloat32(i.y),t.writeFloat32(i.z);t.writeUint16(0)}return new DataView(t.buffer)}},e.Structure=Fp,e.StructureComponent=Vg,e.StructureComponentDefaultParameters=Gg,e.StructureRepresentation=Bv,e.Superposition=Tg,e.SurfaceComponent=Hg,e.TetrahedronBuffer=Vx,e.TextBuffer=Xv,e.TorusBuffer=Yx,e.TraceRepresentation=hx,e.TrajectoryPlayer=Eg,e.TubeRepresentation=ux,e.UIStageParameters=pS,e.UnitcellRepresentation=dx,e.ValidationRepresentation=fx,e.Vector2=zt,e.Vector3=Zt,e.Version="2.2.2",e.Viewer=vh,e.Volume=Zf,e.VolumeComponent=jg,e.WidelineBuffer=Kv,e.autoLoad=Ml,e.concatStructures=function(t,...i){e.Debug&&il.time("concatStructures");const n=new Fp(t,""),r=new ep(n),s=n.atomStore,o=n.atomMap;s.addField("formalCharge",1,"int8"),s.addField("partialCharge",1,"float32");const a={};let c=0,l=0,h=0;i.forEach((e=>{e.eachAtom((e=>{s.growIfFull(),s.atomTypeId[c]=o.add(e.atomname,e.element),s.x[c]=e.x,s.y[c]=e.y,s.z[c]=e.z,s.serial[c]=e.serial,s.formalCharge[c]=e.formalCharge,s.partialCharge[c]=e.partialCharge,s.altloc[c]=e.altloc,s.occupancy[c]=e.occupancy,s.bfactor[c]=e.bfactor,r.addAtom(e.modelIndex+h,e.chainname,e.chainid,e.resname,e.resno,1===e.hetero,e.sstruc,e.inscode),a[e.index+l]=c,c+=1})),l+=e.atomStore.count,h+=e.modelStore.count}));const u=n.bondStore,d=n.getAtomProxy(),f=n.getAtomProxy();return l=0,i.forEach((e=>{e.eachBond((e=>{d.index=a[e.atomIndex1+l],f.index=a[e.atomIndex2+l],u.addBond(d,f,e.bondOrder)})),l+=e.atomStore.count})),r.finalize(),hp(n,!0),lp(n,!0),n.finalizeAtoms(),n.finalizeBonds(),pp(n),e.Debug&&il.timeEnd("concatStructures"),n},e.download=Oa,e.flatten=function e(t,i){i=Ia(i,[]);for(let n=0;n<t.length;n++)Array.isArray(t[n])?e(t[n],i):i.push(t[n]);return i},e.getDataInfo=Al,e.getFileInfo=Sl,e.getQuery=Ta,e.guessElement=mp,e.setDebug=function(t){e.Debug=t},e.setListingDatasource=function(t){e.ListingDatasource=t},e.setMeasurementDefaultParams=function(e={}){Object.assign(nl,e)},e.setTrajectoryDatasource=function(t){e.TrajectoryDatasource=t},e.superpose=$g,e.throttle=function(e,t,i){let n,r,s,o=null,a=0;function c(){a=!1===i.leading?0:Date.now(),o=null,s=e.apply(n,r),o||(n=r=null)}return i||(i={}),function(){var l=Date.now();a||!1!==i.leading||(a=l);var h=t-(l-a);return n=this,r=arguments,h<=0||h>t?(o&&(clearTimeout(o),o=null),a=l,s=e.apply(n,r),o||(n=r=null)):o||!1===i.trailing||(o=setTimeout(c,h)),s}},e.uniqueArray=za,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=ngl.js.map
